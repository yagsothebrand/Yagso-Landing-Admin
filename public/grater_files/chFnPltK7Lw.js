;/*FB_PKG_DELIM*/

__d("ArmadilloSignatures",["WASignalKeys","WASignalOther","WASignalSignatures","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n,r=(n=o("WASignalOther")).ensureSize(o("XPlatReactCrypto").getRandomValues(new Uint8Array(64)),64);return o("WASignalSignatures").makeSignature(o("WASignalKeys").makeKeyPairFromArrayBuffers(n.toBuffer(n.makeBytes(32)),n.toBuffer(e)),t,r)}function s(e,t,n){return o("WASignalSignatures").verifyMsgSignalVariant(o("WASignalSignatures").convertPublicKeyToSerializedPubKey(t),n,e)}l.armadilloSign=e,l.validateArmadilloSignature=s}),98);
__d("ArrayBuffer",["UInt8Array"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.map(function(e){return new Uint8Array(e)});return o("UInt8Array").concatBytes(t).buffer}l.mergeBuffers=e}),98);
__d("CreateEncryptionKeyPair",["CryptoLogger","Promise","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("X25519").__setRef("CreateEncryptionKeyPair");function u(){return s.load().then(function(t){var r=t.generateKeys(t.KeyPurpose.Encryption);return(e||(e=n("Promise"))).resolve([r.sk.buffer,r.pk.buffer])}).catch(function(e){var t=o("CryptoLogger").CryptoLogger("create_encryption_key_pair");throw o("CryptoLogger").captureError(t,e).mustfix("failed to generate an encryption key pair"),e})}l.default=u}),98);
__d("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="30303731999218226"}),null);
__d("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery.graphql",["EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={defaultValue:null,kind:"LocalArgument",name:"request_uuid"},t={defaultValue:null,kind:"LocalArgument",name:"virtual_device_id"},r={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},o={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},a={alias:null,args:null,concreteType:"FetchVirtualDeviceInfoMinosEpochSerializablePayload",kind:"LinkedField",name:"minos_epoch",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"self_epoch_signature",storageKey:null}],storageKey:null},i=[{alias:null,args:[{fields:[{kind:"Variable",name:"request_uuid",variableName:"request_uuid"},{kind:"Variable",name:"virtual_device_id",variableName:"virtual_device_id"}],kind:"ObjectValue",name:"request"}],concreteType:"FetchVirtualDeviceInfoResponseWrapper",kind:"LinkedField",name:"fetch_virtual_device_info_for_device_addition_v2",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ok",storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoError",kind:"LinkedField",name:"error",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"code",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoResponse",kind:"LinkedField",name:"data",plural:!1,selections:[{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoEncryptedSecretValues",kind:"LinkedField",name:"encrypted_secret_values",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_anon_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_root_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_storage_private_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mailbox_root_key_blob",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_oblivious_validation_token_blob",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_ocmf_client_state",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_orf_client_state_v2",storageKey:null}],storageKey:null},r,{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_epoch_id",storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoSyncEpochsPayload",kind:"LinkedField",name:"sync_epochs",plural:!0,selections:[r,{alias:null,args:null,kind:"ScalarField",name:"encrypted_epoch_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},o,{alias:null,args:null,kind:"ScalarField",name:"epoch_auth_public_key",storageKey:null},{alias:null,args:null,concreteType:"FetchVirtualDeviceInfoEpochDataSerializablePayload",kind:"LinkedField",name:"epoch_data_v2",plural:!1,selections:[o,{alias:null,args:null,kind:"ScalarField",name:"epoch_root_key",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"is_active_epoch",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_epoch_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"prev_epoch_id",storageKey:null},a],storageKey:null},a],storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:[e,t],kind:"Fragment",metadata:null,name:"EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery",selections:i,type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[t,e],kind:"Operation",name:"EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery",selections:i},params:{id:n("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery_facebookRelayOperation"),metadata:{},name:"EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("EBGetLSVirtualDevices",["ReQL"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(e.tables.encrypted_backups_virtual_devices))}l.getLSVirtualDevices=e}),98);
__d("LSCreateAuthKeyPair.nop",["CryptoLogger","Promise","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("X25519").__setRef("LSCreateAuthKeyPair.nop"),u=function(r,a){return s.load().then(function(t){var r=t.generateKeys(t.KeyPurpose.Encryption),o=r.pk,a=r.sk;return(e||(e=n("Promise"))).resolve([a.buffer,o.buffer])}).catch(function(e){throw o("CryptoLogger").captureError(o("CryptoLogger").CryptoLogger("create_auth_key_pair"),e).mustfix("failed to generate an auth key pair"),e})};u.__nop_name__="LSCreateAuthKeyPair",l.default=u}),98);
__d("LSCreateDebugToken.nop",["ArrayBuffer","Base64Utils","CryptoLogger","I64","LSCreateDerivedKeys.nop","LSCryptoUtils","LSVec","Promise","RetUtil","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("LSCryptoUtils").strToBuf("debug_token_type_"),c=o("LSCryptoUtils").strToBuf("debug_token_rkid"),d=o("LSCryptoUtils").strToBuf("debug_token_anon"),m=(s||(s=o("I64"))).of_string("32"),p=s.of_string("12");function _(e){return Array.from(e.keys()).reduce(function(t,n){var r=e.get(n);return r!=null&&(t[n]=r),t},{})}function f(e){return new Int32Array([new DataView(new Int32Array([e]).buffer).getInt32(0)]).buffer}function g(e,t){var n=t.length,r=o("ArrayBuffer").mergeBuffers([e,f(n)]);return o("ArrayBuffer").mergeBuffers([r,o("LSCryptoUtils").strToBuf(t)])}function h(e,t){var n=t.keys().sort();return n.reduce(function(e,n){var r=t.get(n);return r!=null?g(g(e,n),r):e},g(u,e))}function y(e,t,n,o,a){return r("LSCreateDerivedKeys.nop")(e,t,n,void 0,o,r("LSVec").ofArray([a])).then(function(e){var t=e[0];if(t!=null){var n=r("LSVec").toArray(t);return n.length===1?n[0]:void 0}})}function C(t,a,i,l,u){return(s||(s=o("I64"))).equal((s||(s=o("I64"))).zero,u)?y(t,a,d,l,m).then(function(e){return y(t,a,i,r("nullthrows")(e),(s||(s=o("I64"))).of_int32(i.byteLength))}):(e||(e=n("Promise"))).resolve(i)}function b(e,t,n,o,a,i,l){return y(e,t,n,o,a).then(function(n){return C(e,t,r("nullthrows")(n),i,l)})}var v=function(a,i,l,u,d,f,g){try{return(e||(e=n("Promise"))).all([y(a,i,h(u,g),l,m).then(function(e){return b(a,i,d,r("nullthrows")(e),p,l,f)}),b(a,i,c,l,p,l,f)]).then(function(e){var t=e[0],n=e[1];return o("RetUtil").getNullableRetResult(o("LSCryptoUtils").strToBuf(JSON.stringify({ctx:(s||(s=o("I64"))).equal((s||(s=o("I64"))).zero,f)?"anon":"auth",rkid:o("Base64Utils").fromArrayBuffer(r("nullthrows")(n)),scopes:_(g),type:u,val:o("Base64Utils").fromArrayBuffer(r("nullthrows")(t))})))})}catch(t){return o("CryptoLogger").CryptoLogger("create_debug_token").warn("getExn Error"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult())}};v.__nop_name__="LSCreateDebugToken",l.default=v}),98);
__d("LSCreateEncryptionKeyPair.nop",["CreateEncryptionKeyPair"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n){return r("CreateEncryptionKeyPair")()};e.__nop_name__="LSCreateEncryptionKeyPair",l.default=e}),98);
__d("LSCreateSignatureKeyPair.nop",["CryptoLogger","Promise","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("X25519").__setRef("LSCreateSignatureKeyPair.nop"),u=function(r,a){return s.load().then(function(t){var r=t.generateKeys(t.KeyPurpose.Signing);return(e||(e=n("Promise"))).resolve([r.sk.buffer,r.pk.buffer])}).catch(function(e){var t=o("CryptoLogger").CryptoLogger("create_signature_key_pair");throw o("CryptoLogger").captureError(t,e).mustfix("Failed to create signing key pair keys"),e})};u.__nop_name__="LSCreateSignatureKeyPair",l.default=u}),98);
__d("LSCreateSignatureWithArmadilloKey.nop",["ArmadilloSignatures","EBDeps","LSResult"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,a){return o("EBDeps").getDeps().getMAWIdentityKeys().then(function(e){var t=e.identityPrivateKey;return o("ArmadilloSignatures").armadilloSign(t,new Uint8Array(a))}).then(function(e){return r("LSResult")(e.buffer)})};e.__nop_name__="LSCreateSignatureWithArmadilloKey",l.default=e}),98);
__d("LSCreateSignature_v2.nop",["CryptoLogger","LSResult","Promise","UInt8Array","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("X25519").__setRef("LSCreateSignature_v2.nop");function u(e){return r("LSResult")(e)}function c(e,t){return o("UInt8Array").concatBytes([t,e].map(function(e){return new Uint8Array(e)}))}var d=function(r,a,i,l,d){var t=o("CryptoLogger").CryptoLogger("create_signature_v2");return l.byteLength!==1?(t.mustfix("Bad aad for signing, should be 1 byte"),(e||(e=n("Promise"))).resolve(u(void 0))):s.load().then(function(r){var o=r.secretKeyFromBytes(new Uint8Array(i),r.KeyPurpose.Signing);return o!=null?r.sign(o,c(d,l)).then(function(t){return(e||(e=n("Promise"))).resolve(u(t.buffer))}):(t.mustfix("No Signature Private key"),(e||(e=n("Promise"))).resolve(u(void 0)))})};d.__nop_name__="LSCreateSignature_v2",l.default=d}),98);
__d("LSGetArmadilloPublicKey.nop",["CryptoLogger","EBDeps","Promise","RetUtil"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(r,a){return o("EBDeps").getDeps().getMAWIdentityKeys().then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t.identityPublicKey.buffer))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("get_armadillo_keys");return r.catching(t).mustfix("Failed to get identity keys."),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult())})};s.__nop_name__="LSGetArmadilloPublicKey",l.default=s}),98);
__d("LSHandleWrongRecoveryCode",["LSAppendDataTraceAddon","LSIsMobileClient","LSLogMebClientEvent.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure] Beginning execution."),e[0]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[0],"dasm_handle_wrong_recovery_code_sproc_start"):t.resolve()},function(r){return e[0]!==void 0&&e[1]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[0],"dasm_handle_wrong_recovery_code_error_message",e[1]):t.resolve()},function(o){return t.sequence([function(r){return e[0]!==void 0?t.storedProcedure(n("LSAppendDataTraceAddon"),e[0],t.i64.cast([0,1415]),t.i64.cast([0,2]),e[1],void 0):t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[7]=t[0],t})},function(e){return r[7]?r[8]=!0:r[8]=!1,r[8]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[10]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[10]].join("")),r[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[10],r[9],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,3])})},function(o){return e[2]?t.resolve(0):e[1]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure] ","",e[1]].join("")),r[7]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure",e[1],r[7],t.i64.cast([0,3]))):t.resolve()},function(r){return e[0]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[0],"dasm_handle_wrong_recovery_code_sproc_end"):t.resolve()},function(e){return r[1]=t.i64.of_float(Date.now()),r[2]=t.i64.random(),r[4]="Finishing execution. Execution time: ",r[5]=t.i64.to_string(t.i64.sub(r[1],r[0])),r[6]=" ms",r[3]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure] ",r[3],r[4],r[3],r[5],r[3],r[6]].join("")),t.i64.eq(t.i64.mod_(r[2],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[7]=",",r[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure",[r[4],r[7],r[5],r[7],r[6]].join(""),r[8],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsHandleWrongRecoveryCodeStoredProcedure",e.__tables__=["secure_encrypted_backups_recovery_code_status"],a.exports=e}),null);
__d("LSIsValidEpochAnonIdFlow",[],(function(t,n,r,o,a,i){"use strict";var e=11;function l(t){if(t.byteLength>e)return!1;for(var n=new Int8Array(t),r=0,o=0;o<n.length;o++)r|=+(n[o]<48),r|=+(n[o]>57);return r===0}i.call=l}),66);
__d("LSIsValidEpochAnonId.nop",["LSIsValidEpochAnonIdFlow","LSResult","Promise"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(a,i,l){return(e||(e=n("Promise"))).resolve(r("LSResult")(o("LSIsValidEpochAnonIdFlow").call(l)))};s.__nop_name__="LSIsValidEpochAnonId",l.default=s}),98);
__d("ObliviousConsistentMappingFunction",["FBLogger","UInt8Array","nullthrows","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("ristretto255").__setRef("ObliviousConsistentMappingFunction");function s(e){return e.some(function(e){return e!==0})}function u(e){for(;;){var t=e.getRandom();if(s(t))return t}return new Uint8Array(0)}var c=r("nullthrows")(o("UInt8Array").fromHexString("edd3f55c1a631258d69cf7a2def9de1400000000000000000000000000000010"));function d(e){return"ClientState has length "+String(e)+", expected "+String(32)}function m(e){return"ClientState is greater or equal to max: "+e.toString()}var p="ClientState is zero.";function _(e){var t=e.length;if(t!==32)throw r("FBLogger")("wmi_eb").mustfixThrow(d(t));var n=e.reduce(function(e,t){return e?!0:t>0},!1);if(!n)throw r("FBLogger")("wmi_eb").mustfixThrow(p);for(var o=!1,a=31;a>=0;--a)if(!o){var i=e[a],l=c[a];if(i>l)throw r("FBLogger")("wmi_eb").mustfixThrow("ClientState is greater or equal to max: "+e.toString());i<l&&(o=!0)}if(!o)throw r("FBLogger")("wmi_eb").mustfixThrow("ClientState is greater or equal to max: "+e.toString())}function f(t){return _(t),e.load().then(function(e){var n=u(e.scalar),r=e.scalar.mul(t,n),o=e.scalar.invert(n);return{evolveToken:o,newClientState:r}})}l.checkNonZero=s,l.maxState=c,l.buildInputLengthErrorMsg=d,l.buildInputValueErrorMsg=m,l.getInputZeroErrorMsg=p,l.clientEvolve=f}),98);
__d("LSOcmfClientEvolve_v2.nop",["CryptoLogger","ObliviousConsistentMappingFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r){return o("ObliviousConsistentMappingFunction").clientEvolve(new Uint8Array(r)).then(function(e){return[e.newClientState.buffer,e.evolveToken.buffer]}).catch(function(e){throw o("CryptoLogger").captureError(o("CryptoLogger").CryptoLogger("ocmf_client_evolve_v2"),e).mustfix("Failed to evolve client."),e})};e.__nop_name__="LSOcmfClientEvolve_v2",l.default=e}),98);
__d("LSPublicEncryptionCreateDecryptedData.nop",["PublicEncryptionCreateDecryptedData"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,o,a,i,l,s,u){return r("PublicEncryptionCreateDecryptedData")(o,a,i,l,s,u)};e.__nop_name__="LSPublicEncryptionCreateDecryptedData",l.default=e}),98);
__d("LSSymmetricEncryptionCreateDecryptedString.nop",["Base64Utils","CryptoLogger","LSResult","LSSymmetricEncryptionCreateDecryptedData.nop","XPlatReactTextDecoder"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return r("LSResult")(e)}var s=function(n,a,i,l,s){var t=o("CryptoLogger").CryptoLogger("symmetric_encryption_create_decrypted_string"),u=o("Base64Utils").toArrayBuffer(s);return r("LSSymmetricEncryptionCreateDecryptedData.nop")(n,a,i,l,u).then(function(e){var t=e[0];return t}).then(function(t){return t==null?e():e(new(o("XPlatReactTextDecoder")).TextDecoder().decode(t))}).catch(function(n){return o("CryptoLogger").captureError(t,n).mustfix("symmetric string decryption failed"),e()})};s.__nop_name__="LSSymmetricEncryptionCreateDecryptedString",l.default=s}),98);
__d("LSAddDeviceWithVirtualDeviceAndDecryptionKey",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Decode.nop","LSBase64Encode.nop","LSCreateAuthKeyPair.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignatureWithArmadilloKey.nop","LSCreateSignature_v2.nop","LSDeleteBackupOnClient","LSGetArmadilloPublicKey.nop","LSGetBlobFromString.nop","LSHandleWrongRecoveryCode","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIsValidEpochAnonId.nop","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSPublicEncryptionCreateDecryptedData.nop","LSQplAnnotateInt.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop","LSSymmetricEncryptionCreateDecryptedString.nop","justknobx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(a){return t.sequence([function(r){return o[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Beginning execution."),e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_sproc_start"):t.resolve()},function(a){return t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))}).next().then(function(a,i){var l=a.done,s=a.value;return l?t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_delete_client_state_start"):t.resolve()},function(e){return t.db.table(168).fetch().next().then(function(e,r){var o=e.done,a=e.value;return o?0:(r=a.item,t.storedProcedure(n("LSDeleteBackupOnClient"),r.backupId,void 0,!1,void 0,"null",!0))})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_delete_client_state_end"):t.resolve()},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_decrypt_virtual_device_secrets_start"):t.resolve()},function(r){return o[8]=e[3].get("encrypted_ocmf_client_state"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),o[8]).then(function(e){var t;return t=e,o[9]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[9]).then(function(e){var t;return t=e,o[10]=t[0],t})},function(r){return t.blobs.neq(o[10],void 0)?t.resolve(o[11]=o[10]):t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),o[8]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return o[11]=o[41]}])},function(r){return o[12]=e[3].get("encrypted_oblivious_validation_token_blob"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),o[12]).then(function(e){var t;return t=e,o[13]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[13]).then(function(e){var t;return t=e,o[14]=t[0],t})},function(r){return t.blobs.neq(o[14],void 0)?t.resolve(o[15]=o[14]):t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),o[12]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return o[15]=o[41]}])},function(r){return o[16]=e[3].get("encrypted_epoch_anon_id"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),o[16]).then(function(e){var t;return t=e,o[17]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[17]).then(function(e){var t;return t=e,o[18]=t[0],t})},function(r){return t.blobs.neq(o[18],void 0)?t.resolve(o[19]=o[18]):t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),o[16]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return o[19]=o[41]}])},function(e){return t.blobs.neq(o[19],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSIsValidEpochAnonId.nop"),o[19]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return o[20]=o[40]}]):t.resolve(o[20]=!1)},function(r){return o[20]?o[21]=o[19]:o[21]=void 0,o[22]=e[3].get("encrypted_epoch_root_key"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),o[22]).then(function(e){var t;return t=e,o[23]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[23]).then(function(e){var t;return t=e,o[24]=t[0],t})},function(r){return t.blobs.neq(o[24],void 0)?t.resolve(o[25]=o[24]):t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),o[22]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return o[25]=o[41]}])},function(r){return o[26]=e[3].get("encrypted_mailbox_root_key_blob"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),o[26]).then(function(e){var t;return t=e,o[27]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[27]).then(function(e){var t;return t=e,o[28]=t[0],t})},function(r){return t.blobs.neq(o[28],void 0)?t.resolve(o[29]=o[28]):t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),o[26]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return o[29]=o[41]}])},function(r){return o[30]=e[3].get("encrypted_epoch_storage_private_key"),o[30]!==void 0?t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),o[30]).then(function(e){var t;return t=e,o[40]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(r){return t.blobs.neq(o[41],void 0)?t.resolve(o[42]=o[41]):t.sequence([function(r){return t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),e[9],t.blob("c2VjcmV0X3ZhbHVlc19tZXRhZGF0YQ=="),o[30]).then(function(e){var t;return t=e,o[43]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[43]).then(function(e){var t;return t=e,o[44]=t[0],t})},function(e){return o[42]=o[44]}])},function(e){return o[31]=o[42]}]):t.resolve(o[31]=void 0)},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_decrypt_virtual_device_secrets_end"):t.resolve()},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_generate_keys_start"):t.resolve()},function(e){return t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,o[32]=t[0],o[33]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,o[34]=t[0],o[35]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[32],t.blob("MA=="),o[35]).then(function(e){var t;return t=e,o[36]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateAuthKeyPair.nop")).then(function(e){var t;return t=e,o[37]=t[0],o[38]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[32],t.blob("MQ=="),o[38]).then(function(e){var t;return t=e,o[39]=t[0],t})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_generate_keys_end"):t.resolve()},function(a){return t.blobs.neq(o[11],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),o[11]).then(function(e){var t;return t=e,o[40]=t[0],o[41]=t[1],t})},function(e){var r;return t.blobs.neq(void 0,void 0)?t.sequence([function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),void 0).then(function(e){var t;return t=e,o[46]=t[0],o[47]=t[1],t})},function(e){var t;return t=[o[40],o[41],o[46],o[47]],o[42]=t[0],o[43]=t[1],o[44]=t[2],o[45]=t[3],t}]):t.resolve((r=[o[40],o[41],void 0,void 0],o[42]=r[0],o[43]=r[1],o[44]=r[2],o[45]=r[3],r))},function(a){return t.blobs.neq(o[21],void 0)?t.blobs.neq(o[25],void 0)?t.blobs.neq(o[15],void 0)?t.blobs.neq(o[29],void 0)?t.sequence([function(r){return e[12]!==void 0?(o[61]=e[12].get("epoch_head"),o[46]=o[61]):o[46]=void 0,o[47]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,o[48]=t[0],t})},function(e){return o[48]&&(o[61]=(o[47].push(t.i64.cast([0,0])),o[47])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,o[49]=t[0],t})},function(e){return o[49]&&(o[61]=(o[47].push(t.i64.cast([0,2])),o[47])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,o[50]=t[0],t})},function(e){return o[50]&&(o[61]=(o[47].push(t.i64.cast([0,3])),o[47])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,o[51]=t[0],t})},function(e){return o[51]&&(o[61]=(o[47].push(t.i64.cast([0,4])),o[47])),o[52]="",o[53]=t.i64.of_int32(o[47].length),t.i64.gt(o[53],t.i64.cast([0,0]))?t.loopAsync(o[53],function(e){return o[61]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[47],o[61]).then(function(e){var t;return t=e,o[62]=t[0],o[63]=t[1],t})},function(e){return o[52]=[o[52],"_",t.i64.to_string(o[62])].join("")}])}):t.resolve()},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),["supported_versions_",o[52],"revision_version_",t.i64.to_string(t.i64.cast([0,1]))].join("")).then(function(e){var t;return t=e,o[54]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[32],t.blob("Mg=="),o[54]).then(function(e){var t;return t=e,o[55]=t[0],t})},function(e){return t.blobs.neq(o[55],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[55]).then(function(e){var t;return t=e,o[61]=t[0],t})},function(e){return o[56]=o[61]}]):t.resolve(o[56]=void 0)},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_cleanup_state_start"):t.resolve()},function(e){return t.forEach(t.db.table(168).fetch(),function(e){return e.delete()})},function(e){return t.forEach(t.db.table(169).fetch(),function(e){return e.delete()})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_cleanup_state_end"):t.resolve()},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_optimisitc_client_state_start"):t.resolve()},function(n){return t.forEach(t.filter(t.db.table(168).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.backupId,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(168).add({backupId:e[1],devicePublicKeyBlob:o[33],devicePrivateKeyBlob:o[32],epochStoragePublicKeyBlob:o[35],epochStoragePrivateKeyBlob:o[34],epochAuthPublicKeyBlob:o[38],epochAuthPrivateKeyBlob:o[37],mailboxRootKeyBlob:o[29],ocmfClientStateBlob:o[42],obliviousValidationTokenBlob:o[15],encryptionVersion:t.i64.cast([0,0]),revisionVersion:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),backupTenancy:e[7]})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_optimisitc_client_state_end"):t.resolve()},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_epoch_data_start"):t.resolve()},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_populate_epochs_table_start"):t.resolve()},function(n){return t.forEach(t.filter(t.db.table(169).fetch([[[e[2]]]]),function(n){return t.i64.eq(n.epochId,e[2])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,80]))}),function(e){return e.delete()})},function(n){return t.db.table(169).add({epochId:e[2],authorityLevel:t.i64.cast([0,80]),backupId:e[1],epochAnonIdBlob:o[21],epochRootKeyBlob:o[25],epochStatus:t.i64.cast([0,1]),epochHead:o[46]})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_populate_epochs_table_end"):t.resolve()},function(r){return o[57]=e[5].keys(),o[58]=t.i64.of_int32(o[57].length),e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateInt.nop"),t.i64.cast([0,1021646192]),e[8],"num_epochs",o[58]):t.resolve()},function(a){return t.i64.eq(o[58],t.i64.cast([0,1]))?t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_epoch_derivation_skipped"):t.resolve()},function(r){return o[61]=e[5].has(t.i64.to_string(e[2])),o[61]?t.resolve(0):((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] sync_epochs does not contain base epoch"),o[63]="sync_epochs does not contain base epoch",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[63]].join("")),o[62]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[63],o[62],t.i64.cast([0,3])))}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_epoch_derivation_start"):t.resolve()},function(e){return(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Triggering epoch derivation."),o[61]=r("justknobx")._("1310"),t.resolve()},function(r){return o[61]===!1&&(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] Epoch rotation is disabled for the user but received more than one epoch."),t.blobs.neq(o[31],void 0)?t.sequence([function(e){return o[65]="Starting epoch derivation at base epoch of anon id (base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[21]).then(function(e){var t;return t=e,o[62]=t[0],t})},function(e){return o[66]=o[62]==null?"":o[62],o[63]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[63],o[65],o[63],o[66]].join("")),t.resolve()},function(r){return o[64]=e[5].get(t.i64.to_string(e[2])),o[64]!==void 0?t.sequence([function(n){return o[67]=o[64].get("minos_epoch"),o[67]!==void 0?(o[79]=o[67].get("epoch_head"),o[68]=o[79]):o[68]=void 0,o[69]=o[64].get("is_active_epoch"),o[69]?o[70]=t.i64.cast([0,1]):o[70]=t.i64.cast([0,2]),t.forEach(t.db.table(169).fetch([[[e[2]]]]),function(e){var n=e.update,r=e.item;return n({authorityLevel:t.i64.cast([0,80]),epochStatus:o[70],epochHead:o[68]})})},function(r){return o[71]=new t.Map,o[71].set("epoch_id",e[2]),o[71].set("authority_level",t.i64.cast([0,80])),o[71].set("backup_id",e[1]),o[71].set("epoch_anon_id_blob",o[21]),o[71].set("epoch_root_key_blob",o[25]),o[71].set("epoch_status",t.i64.cast([0,1])),o[71].set("epoch_head",o[46]),o[72]=o[71],o[73]=e[5].keys(),o[74]=t.i64.of_int32(o[73].length),t.i64.gt(o[74],t.i64.cast([0,0]))?t.loopAsync(o[74],function(r){return o[79]=r,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[73],o[79]).then(function(e){var t;return t=e,o[80]=t[0],o[81]=t[1],t})},function(r){return o[82]=o[72].get("epoch_id"),o[83]=o[72].get("backup_id"),o[84]=o[72].get("epoch_anon_id_blob"),o[85]=o[72].get("epoch_root_key_blob"),o[86]=o[72].get("epoch_status"),o[87]=o[72].get("authority_level"),o[88]=o[72].get("epoch_head"),o[89]=e[5].get(t.i64.to_string(o[82])),o[89]!==void 0?t.sequence([function(r){return o[98]=o[89].get("next_epoch_id"),t.i64.neq(o[98],void 0)?t.sequence([function(r){return o[106]=e[5].get(t.i64.to_string(o[98])),o[106]!==void 0?t.sequence([function(e){return o[114]=o[106].get("backup_id"),o[115]=o[106].get("is_active_epoch"),o[115]?o[116]=t.i64.cast([0,1]):o[116]=t.i64.cast([0,2]),o[117]=o[106].get("epoch_anon_id"),o[118]=o[106].get("minos_epoch"),o[118]!==void 0?(o[137]=o[118].get("epoch_head"),o[119]=o[137]):o[119]=void 0,o[120]=t.createArray(),o[137]=(o[120].push(t.i64.cast([0,32])),o[120]),o[137]=(o[120].push(t.i64.cast([0,32])),o[120]),o[121]="_",t.nativeOperation(n("LSGetBlobFromString.nop"),["epoch_chaining",o[121],t.blobs.to_string(o[84]),o[121],t.i64.to_string(o[82])].join("")).then(function(e){var t;return t=e,o[122]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),o[122],void 0,o[85],o[120]).then(function(e){var t;return t=e,o[123]=t[0],t})},function(e){return o[123]?o[124]=!1:o[124]=!0,o[124]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] Failed to generate epoch_chaining_key and epoch_distribution_pre_shared_key."),o[138]="Failed to generate epoch_chaining_key and epoch_distribution_pre_shared_key.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[138]].join("")),o[137]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[138],o[137],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[139]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[140]=t[0],t})},function(e){var t;return t=[o[139],o[140]],o[125]=t[0],o[126]=t[1],t}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[123],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[137]=t[0],o[138]=t[1],t})},function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[123],t.i64.cast([0,1])).then(function(e){var t;return t=e,o[139]=t[0],o[140]=t[1],t})},function(e){var t;return t=[o[137],o[139]],o[125]=t[0],o[126]=t[1],t}])},function(r){return o[127]=o[106].get("encrypted_epoch_key"),t.blobs.neq(o[127],void 0)?t.sequence([function(r){return o[137]=o[106].get("epoch_auth_public_key"),o[138]=o[106].get("epoch_anon_id"),t.nativeOperation(n("LSPublicEncryptionCreateDecryptedData.nop"),e[6],o[31],o[137],o[126],t.blobs.of_string(["epoch_","_",t.blobs.to_string(o[138])].join("")),o[127]).then(function(e){var t;return t=e,o[139]=t[0],t})},function(e){return t.blobs.neq(o[139],void 0)?t.resolve(o[140]=o[139]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] Couldn't decrypt epoch key. Returning null entropy"),o[142]="Couldn't decrypt epoch key. Returning null entropy",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[142]].join("")),o[141]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[142],o[141],t.i64.cast([0,3]))},function(e){return o[140]=void 0}])},function(e){return o[128]=o[140]}]):t.sequence([function(e){return o[140]="encrypted_epoch_key is null. Can't generate epoch entropy. epoch_anon_id(base64) = ",o[137]=o[106].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Encode.nop"),o[137]).then(function(e){var t;return t=e,o[138]=t[0],t})},function(e){return o[141]=o[138]==null?"":o[138],o[139]="",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[139],o[140],o[139],o[141]].join("")),o[142]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[o[140],",",o[141]].join(""),o[142],t.i64.cast([0,3]))},function(e){return o[128]=void 0}])},function(e){return t.blobs.neq(o[128],void 0)?t.sequence([function(e){return o[137]=t.createArray(),o[142]=(o[137].push(t.i64.cast([0,32])),o[137]),t.nativeOperation(n("LSGetBlobFromString.nop"),"epoch_root_key").then(function(e){var t;return t=e,o[138]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),o[138],o[125],o[128],o[137]).then(function(e){var t;return t=e,o[139]=t[0],t})},function(e){return o[139]?o[140]=!1:o[140]=!0,o[140]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] Unable to generate epoch root key."),o[143]="Unable to generate epoch root key.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[143]].join("")),o[142]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[143],o[142],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[144]=t[0],t})},function(e){return o[141]=o[144]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[139],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[142]=t[0],o[143]=t[1],t})},function(e){return o[141]=o[142]}])},function(e){return o[129]=o[141]}]):t.sequence([function(e){return o[140]="epoch entropy is null. Can't generate epoch root key. epoch_anon_id(base64) = ",o[137]=o[106].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Encode.nop"),o[137]).then(function(e){var t;return t=e,o[138]=t[0],t})},function(e){return o[141]=o[138]==null?"":o[138],o[139]="",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[139],o[140],o[139],o[141]].join("")),o[142]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[o[140],",",o[141]].join(""),o[142],t.i64.cast([0,3]))},function(e){return o[129]=void 0}])},function(e){return t.blobs.neq(o[129],void 0)?t.sequence([function(e){return t.filter(t.db.table(169).fetch([[[o[98]]]]),function(e){return t.i64.eq(e.epochId,o[98])&&t.i64.gt(e.authorityLevel,t.i64.cast([0,80]))}).next().then(function(e){var n=e.done,r=e.value;return n?t.db.table(169).put({epochId:o[98],backupId:o[114],epochAnonIdBlob:o[117],epochRootKeyBlob:o[129],epochStatus:o[116],authorityLevel:t.i64.cast([0,80]),epochHead:o[119]}):0})},function(e){var n;return n=[o[98],o[114],o[117],o[129],o[116],o[119],t.i64.cast([0,80])],o[130]=n[0],o[131]=n[1],o[132]=n[2],o[133]=n[3],o[134]=n[4],o[135]=n[5],o[136]=n[6],n}]):t.sequence([function(e){return o[140]="Epoch root key is null. Can't write the epoch to the table. epoch_anon_id(base64) = ",o[137]=o[106].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Encode.nop"),o[137]).then(function(e){var t;return t=e,o[138]=t[0],t})},function(e){return o[141]=o[138]==null?"":o[138],o[139]="",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[139],o[140],o[139],o[141]].join("")),o[142]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[o[140],",",o[141]].join(""),o[142],t.i64.cast([0,3]))},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[130]=t[0],o[131]=t[1],o[132]=t[2],o[133]=t[3],o[134]=t[4],o[135]=t[5],o[136]=t[6],t}])},function(e){var t;return t=[o[130],o[131],o[132],o[133],o[134],o[135],o[136]],o[107]=t[0],o[108]=t[1],o[109]=t[2],o[110]=t[3],o[111]=t[4],o[112]=t[5],o[113]=t[6],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected error! New epoch is null even though we have a new_epoch_id value"),o[115]="Unexpected error! New epoch is null even though we have a new_epoch_id value",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ","",o[115]].join("")),o[114]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",o[115],o[114],t.i64.cast([0,3]))},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[107]=t[0],o[108]=t[1],o[109]=t[2],o[110]=t[3],o[111]=t[4],o[112]=t[5],o[113]=t[6],t}])},function(e){var t;return t=[o[107],o[108],o[109],o[110],o[111],o[112],o[113]],o[99]=t[0],o[100]=t[1],o[101]=t[2],o[102]=t[3],o[103]=t[4],o[104]=t[5],o[105]=t[6],t}]):t.sequence([function(e){return o[108]="New epoch is null. This is expected if epoch_id is the root or last epoch. epoch_anon_id(base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[106]=t[0],t})},function(e){return o[109]=o[106]==null?"":o[106],o[110]=" , is_forward = ",o[111]="1",o[107]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[107],o[108],o[107],o[109],o[107],o[110],o[107],o[111]].join("")),t.resolve()},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[99]=t[0],o[100]=t[1],o[101]=t[2],o[102]=t[3],o[103]=t[4],o[104]=t[5],o[105]=t[6],t}])},function(e){var t;return t=[o[99],o[100],o[101],o[102],o[103],o[104],o[105]],o[90]=t[0],o[91]=t[1],o[92]=t[2],o[93]=t[3],o[94]=t[4],o[95]=t[5],o[96]=t[6],t}]):t.sequence([function(e){return o[100]="Unexpected error! server epoch is null even though we have epoch_id. epoch_anon_id(base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[98]=t[0],t})},function(e){return o[101]=o[98]==null?"":o[98],o[99]="",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[99],o[100],o[99],o[101]].join("")),o[102]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[o[100],",",o[101]].join(""),o[102],t.i64.cast([0,3]))},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[90]=t[0],o[91]=t[1],o[92]=t[2],o[93]=t[3],o[94]=t[4],o[95]=t[5],o[96]=t[6],t}])},function(e){return o[97]=new t.Map,o[97].set("epoch_id",o[90]),o[97].set("backup_id",o[91]),o[97].set("epoch_anon_id_blob",o[92]),o[97].set("epoch_root_key_blob",o[93]),o[97].set("epoch_status",o[94]),o[97].set("epoch_head",o[95]),o[97].set("authority_level",o[96]),o[72]=o[97]}])}):t.resolve()},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,o[79]=t[0],t})},function(e){return o[79]?o[80]=!0:o[80]=!1,o[80]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),o[82]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",o[82]].join("")),o[81]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",o[82],o[81],t.i64.cast([0,3]))):t.resolve()}])},function(r){return o[75]=new t.Map,o[75].set("epoch_id",e[2]),o[75].set("authority_level",t.i64.cast([0,80])),o[75].set("backup_id",e[1]),o[75].set("epoch_anon_id_blob",o[21]),o[75].set("epoch_root_key_blob",o[25]),o[75].set("epoch_status",t.i64.cast([0,1])),o[75].set("epoch_head",o[46]),o[76]=o[75],o[77]=e[5].keys(),o[78]=t.i64.of_int32(o[77].length),t.i64.gt(o[78],t.i64.cast([0,0]))?t.loopAsync(o[78],function(r){return o[79]=r,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[77],o[79]).then(function(e){var t;return t=e,o[80]=t[0],o[81]=t[1],t})},function(r){return o[82]=o[76].get("epoch_id"),o[83]=o[76].get("backup_id"),o[84]=o[76].get("epoch_anon_id_blob"),o[85]=o[76].get("epoch_root_key_blob"),o[86]=o[76].get("epoch_status"),o[87]=o[76].get("authority_level"),o[88]=o[76].get("epoch_head"),o[89]=e[5].get(t.i64.to_string(o[82])),o[89]!==void 0?t.sequence([function(r){return o[98]=o[89].get("prev_epoch_id"),t.i64.neq(o[98],void 0)?t.sequence([function(r){return o[106]=e[5].get(t.i64.to_string(o[98])),o[106]!==void 0?t.sequence([function(e){return o[114]=o[106].get("backup_id"),o[115]=o[106].get("is_active_epoch"),o[115]?o[116]=t.i64.cast([0,1]):o[116]=t.i64.cast([0,2]),o[117]=o[89].get("epoch_data_v2"),o[117]!==void 0?t.sequence([function(e){return o[125]=t.createArray(),o[144]=(o[125].push(t.i64.cast([0,32])),o[125]),t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[126]=t[0],t})},function(e){return o[126]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_data_storage","_",o[126]].join("")),void 0,o[85],o[125]).then(function(e){var t;return t=e,o[144]=t[0],t})},function(e){return o[144]?o[145]=!1:o[145]=!0,o[145]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),o[148]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[148]].join("")),o[147]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[148],o[147],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[149]=t[0],t})},function(e){return o[146]=o[149]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[144],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[147]=t[0],o[148]=t[1],t})},function(e){return o[146]=o[147]}])},function(e){return o[127]=o[146]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),o[145]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[145]].join("")),o[144]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[145],o[144],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[146]=t[0],t})},function(e){return o[127]=o[146]}])},function(e){return o[128]=o[117].get("epoch_anon_id"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),o[127],t.blob("ZXBvY2hfZGF0YV9tZXRhZGF0YQ=="),o[128]).then(function(e){var t;return t=e,o[129]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[129]).then(function(e){var t;return t=e,o[130]=t[0],t})},function(e){return t.blobs.neq(o[130],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSIsValidEpochAnonId.nop"),o[130]).then(function(e){var t;return t=e,o[144]=t[0],t})},function(e){return o[131]=o[144]}]):t.resolve(o[131]=!1)},function(e){return o[131]?o[132]=o[130]:o[132]=void 0,o[133]=o[117].get("epoch_root_key"),t.nativeOperation(n("LSSymmetricEncryptionCreateDecryptedString.nop"),o[127],t.blob("ZXBvY2hfZGF0YV9tZXRhZGF0YQ=="),o[133]).then(function(e){var t;return t=e,o[134]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Decode.nop"),o[134]).then(function(e){var t;return t=e,o[135]=t[0],t})},function(e){return t.blobs.neq(o[132],void 0)?t.sequence([function(e){return t.blobs.neq(o[135],void 0)?t.resolve((o[145]=new t.Map,o[145].set("epoch_anon_id",o[132]),o[145].set("epoch_root_key",o[135]),o[144]=o[145])):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBEpochDerivationUtils] Error while decrypting epoch_root_key. Returning null"),o[146]="Error while decrypting epoch_root_key. Returning null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ","",o[146]].join("")),o[145]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",o[146],o[145],t.i64.cast([0,3]))},function(e){return o[144]=void 0}])},function(e){return o[136]=o[144]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBEpochDerivationUtils] Error while decrypting epoch_anon_id. Returning null"),o[145]="Error while decrypting epoch_anon_id. Returning null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ","",o[145]].join("")),o[144]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",o[145],o[144],t.i64.cast([0,3]))},function(e){return o[136]=void 0}])},function(e){return o[136]!==void 0?t.sequence([function(e){return o[144]=o[136].get("epoch_anon_id"),o[145]=o[136].get("epoch_root_key"),o[146]=o[106].get("minos_epoch"),o[146]!==void 0?(o[148]=o[146].get("epoch_head"),o[147]=o[148]):o[147]=void 0,t.filter(t.db.table(169).fetch([[[o[98]]]]),function(e){return t.i64.eq(e.epochId,o[98])&&t.i64.gt(e.authorityLevel,t.i64.cast([0,80]))}).next().then(function(e){var n=e.done,r=e.value;return n?t.db.table(169).put({epochId:o[98],backupId:o[114],epochAnonIdBlob:o[144],epochRootKeyBlob:o[145],epochStatus:o[116],authorityLevel:t.i64.cast([0,80]),epochHead:o[147]}):0})},function(e){var n;return n=[o[98],o[114],o[144],o[145],o[116],o[147],t.i64.cast([0,80])],o[137]=n[0],o[138]=n[1],o[139]=n[2],o[140]=n[3],o[141]=n[4],o[142]=n[5],o[143]=n[6],n}]):t.sequence([function(e){return o[146]="Error while decrypting epoch data of epoch_anon_id(base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[144]=t[0],t})},function(e){return o[147]=o[144]==null?"":o[144],o[145]="",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[145],o[146],o[145],o[147]].join("")),o[148]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[o[146],",",o[147]].join(""),o[148],t.i64.cast([0,3]))},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[137]=t[0],o[138]=t[1],o[139]=t[2],o[140]=t[3],o[141]=t[4],o[142]=t[5],o[143]=t[6],t}])},function(e){var t;return t=[o[137],o[138],o[139],o[140],o[141],o[142],o[143]],o[118]=t[0],o[119]=t[1],o[120]=t[2],o[121]=t[3],o[122]=t[4],o[123]=t[5],o[124]=t[6],t}]):t.sequence([function(e){return o[127]="Error while reading epoch_data_v2. This is expected if this is the root epoch. epoch_anon_id(base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[125]=t[0],t})},function(e){return o[128]=o[125]==null?"":o[125],o[126]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[126],o[127],o[126],o[128]].join("")),t.resolve()},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[118]=t[0],o[119]=t[1],o[120]=t[2],o[121]=t[3],o[122]=t[4],o[123]=t[5],o[124]=t[6],t}])},function(e){var t;return t=[o[118],o[119],o[120],o[121],o[122],o[123],o[124]],o[107]=t[0],o[108]=t[1],o[109]=t[2],o[110]=t[3],o[111]=t[4],o[112]=t[5],o[113]=t[6],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected error! New epoch is null even though we have a new_epoch_id value"),o[115]="Unexpected error! New epoch is null even though we have a new_epoch_id value",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ","",o[115]].join("")),o[114]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",o[115],o[114],t.i64.cast([0,3]))},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[107]=t[0],o[108]=t[1],o[109]=t[2],o[110]=t[3],o[111]=t[4],o[112]=t[5],o[113]=t[6],t}])},function(e){var t;return t=[o[107],o[108],o[109],o[110],o[111],o[112],o[113]],o[99]=t[0],o[100]=t[1],o[101]=t[2],o[102]=t[3],o[103]=t[4],o[104]=t[5],o[105]=t[6],t}]):t.sequence([function(e){return o[108]="New epoch is null. This is expected if epoch_id is the root or last epoch. epoch_anon_id(base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[106]=t[0],t})},function(e){return o[109]=o[106]==null?"":o[106],o[110]=" , is_forward = ",o[111]="0",o[107]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[107],o[108],o[107],o[109],o[107],o[110],o[107],o[111]].join("")),t.resolve()},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[99]=t[0],o[100]=t[1],o[101]=t[2],o[102]=t[3],o[103]=t[4],o[104]=t[5],o[105]=t[6],t}])},function(e){var t;return t=[o[99],o[100],o[101],o[102],o[103],o[104],o[105]],o[90]=t[0],o[91]=t[1],o[92]=t[2],o[93]=t[3],o[94]=t[4],o[95]=t[5],o[96]=t[6],t}]):t.sequence([function(e){return o[100]="Unexpected error! server epoch is null even though we have epoch_id. epoch_anon_id(base64) = ",t.nativeOperation(n("LSBase64Encode.nop"),o[84]).then(function(e){var t;return t=e,o[98]=t[0],t})},function(e){return o[101]=o[98]==null?"":o[98],o[99]="",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochDerivationUtils] ",o[99],o[100],o[99],o[101]].join("")),o[102]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils",[o[100],",",o[101]].join(""),o[102],t.i64.cast([0,3]))},function(e){var t;return t=[o[82],o[83],o[84],o[85],o[86],o[88],o[87]],o[90]=t[0],o[91]=t[1],o[92]=t[2],o[93]=t[3],o[94]=t[4],o[95]=t[5],o[96]=t[6],t}])},function(e){return o[97]=new t.Map,o[97].set("epoch_id",o[90]),o[97].set("backup_id",o[91]),o[97].set("epoch_anon_id_blob",o[92]),o[97].set("epoch_root_key_blob",o[93]),o[97].set("epoch_status",o[94]),o[97].set("epoch_head",o[95]),o[97].set("authority_level",o[96]),o[76]=o[97]}])}):t.resolve()},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,o[79]=t[0],t})},function(e){return o[79]?o[80]=!0:o[80]=!1,o[80]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),o[82]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",o[82]].join("")),o[81]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",o[82],o[81],t.i64.cast([0,3]))):t.resolve()}])}]):((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBEpochDerivationUtils] Unexpected Error. A base epoch exists on client but not found on server"),o[67]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochDerivationUtils","Unexpected Error. A base epoch exists on client but not found on server",o[67],t.i64.cast([0,3])))}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: epoch storage private key is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch storage private key is null"),o[63]="epoch storage private key is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[63]].join("")),o[62]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[63],o[62],t.i64.cast([0,3]))}])},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_epoch_derivation_end"):t.resolve()}])},function(r){return t.db.table(169).fetch([[[e[4]]]]).next().then(function(r,a){var i=r.done,l=r.value;return i?t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: No epochs keys found."):t.resolve()},function(e){return(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] No epochs keys found."),o[59]=void 0}]):(a=l.item,o[61]=new t.Map,o[61].set("epoch_root_key",a.epochRootKeyBlob),o[61].set("epoch_anon_id",a.epochAnonIdBlob),o[61].set("epoch_id",e[4]),o[61].set("epoch_head",a.epochHead),o[59]=o[61])})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_insert_epoch_data_end"):t.resolve()},function(r){return o[59]!==void 0?t.sequence([function(e){return o[61]=o[59].get("epoch_anon_id"),o[62]=o[59].get("epoch_root_key"),o[63]=t.createArray(),o[69]=(o[63].push(t.i64.cast([0,32])),o[63]),t.nativeOperation(n("LSBase64Encode.nop"),o[61]).then(function(e){var t;return t=e,o[64]=t[0],t})},function(e){return o[64]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_devices","_",o[64]].join("")),void 0,o[62],o[63]).then(function(e){var t;return t=e,o[69]=t[0],t})},function(e){return o[69]?o[70]=!1:o[70]=!0,o[70]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),o[73]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[73]].join("")),o[72]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[73],o[72],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[74]=t[0],t})},function(e){return o[71]=o[74]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[69],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[72]=t[0],o[73]=t[1],t})},function(e){return o[71]=o[72]}])},function(e){return o[65]=o[71]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),o[70]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[70]].join("")),o[69]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[70],o[69],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[71]=t[0],t})},function(e){return o[65]=o[71]}])},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),o[65],o[33]).then(function(e){var t;return t=e,o[66]=t[0],t})},function(e){return o[67]=o[59].get("epoch_root_key"),t.blobs.neq(o[67],void 0)?t.sequence([function(e){return o[69]=t.createArray(),o[75]=(o[69].push(t.i64.cast([0,18])),o[69]),t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,o[67],o[69]).then(function(e){var t;return t=e,o[70]=t[0],t})},function(e){return o[70]!==void 0?t.sequence([function(e){return o[75]=t.i64.of_int32(o[70].length),t.i64.ge(o[75],t.i64.cast([0,1]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[70],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[77]=t[0],o[78]=t[1],t})},function(e){return o[76]=o[77]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),o[78]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",o[78]].join("")),o[77]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",o[78],o[77],t.i64.cast([0,3]))},function(e){return o[76]=void 0}])},function(e){return o[71]=o[76]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),o[76]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",o[76]].join("")),o[75]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",o[76],o[75],t.i64.cast([0,3]))},function(e){return o[71]=void 0}])},function(e){return t.blobs.neq(o[71],void 0)?o[72]=!0:o[72]=!1,o[72]||((function(e){t.logger(e).mustfix(e)})("LS::assert is failed. Attempting to coerce a null value to nonnull."),t.throw("LS::assert is failed. Attempting to coerce a null value to nonnull.")),t.nativeOperation(n("LSBase64Encode.nop"),o[71]).then(function(e){var t;return t=e,o[73]=t[0],t})},function(e){return o[73]!==void 0?o[74]=o[73]:o[74]="encodingfailed",o[68]=o[74]}]):t.resolve(o[68]="null")},function(r){return t.blobs.neq(o[66],void 0)?t.sequence([function(e){return o[69]=o[59].get("epoch_id"),t.nativeOperation(n("LSBase64Encode.nop"),o[33]).then(function(e){var t;return t=e,o[70]=t[0],t})},function(e){return o[88]=o[70]==null?"":o[70],t.nativeOperation(n("LSBase64Encode.nop"),o[66]).then(function(e){var t;return t=e,o[71]=t[0],t})},function(e){return o[87]=o[71]==null?"":o[71],t.nativeOperation(n("LSBase64Encode.nop"),o[35]).then(function(e){var t;return t=e,o[72]=t[0],t})},function(e){return o[89]=o[72]==null?"":o[72],t.nativeOperation(n("LSBase64Encode.nop"),o[36]==null?t.blob("bnVsbA=="):o[36]).then(function(e){var t;return t=e,o[73]=t[0],t})},function(e){return o[90]=o[73]==null?"":o[73],t.nativeOperation(n("LSBase64Encode.nop"),o[38]).then(function(e){var t;return t=e,o[74]=t[0],t})},function(e){return o[91]=o[74]==null?"":o[74],t.nativeOperation(n("LSBase64Encode.nop"),o[39]==null?t.blob("bnVsbA=="):o[39]).then(function(e){var t;return t=e,o[75]=t[0],t})},function(e){return o[92]=o[75]==null?"":o[75],t.nativeOperation(n("LSBase64Encode.nop"),o[43]).then(function(e){var t;return t=e,o[76]=t[0],t})},function(r){return o[93]=o[76]==null?"":o[76],t.nativeOperation(n("LSBase64Encode.nop"),e[10]).then(function(e){var t;return t=e,o[77]=t[0],t})},function(e){return o[94]=o[77]==null?"":o[77],t.blobs.neq(o[29],void 0)?t.sequence([function(e){return o[95]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[29],"private_key",o[32],t.i64.cast([0,1]),o[95]).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return t.blobs.neq(o[96],void 0)?o[97]=o[96]:o[97]=void 0,o[78]=o[97]}]):t.resolve(o[78]=void 0)},function(e){return t.blobs.neq(o[78],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[78]).then(function(e){var t;return t=e,o[95]=t[0],t})},function(e){return o[79]=o[95]}]):t.resolve(o[79]=void 0)},function(e){return t.blobs.neq(o[29],void 0)?t.sequence([function(e){return o[95]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[29],"ocmf_client_state",o[42],t.i64.cast([0,1]),o[95]).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return t.blobs.neq(o[96],void 0)?o[97]=o[96]:o[97]=void 0,o[80]=o[97]}]):t.resolve(o[80]=void 0)},function(e){return t.blobs.neq(o[80],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[80]).then(function(e){var t;return t=e,o[95]=t[0],t})},function(e){return o[81]=o[95]}]):t.resolve(o[81]=void 0)},function(e){return t.blobs.neq(o[29],void 0)?t.sequence([function(e){return o[95]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[29],"epoch_storage_private_key",o[34],t.i64.cast([0,1]),o[95]).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return t.blobs.neq(o[96],void 0)?o[97]=o[96]:o[97]=void 0,o[82]=o[97]}]):t.resolve(o[82]=void 0)},function(e){return t.blobs.neq(o[82],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[82]).then(function(e){var t;return t=e,o[95]=t[0],t})},function(e){return o[83]=o[95]}]):t.resolve(o[83]=void 0)},function(r){return o[84]=new t.Map,o[84].set("supported_encryption_versions",o[47]),o[84].set("client_version",t.i64.cast([0,1])),o[84].set("version_sig",o[56]==null?"":o[56]),e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_issue_add_device_task_start"):t.resolve()},function(r){return t.i64.eq(e[7],t.i64.cast([0,2]))?t.resolve(o[85]=void 0):t.sequence([function(e){return t.nativeOperation(n("LSGetArmadilloPublicKey.nop")).then(function(e){var t;return t=e,o[95]=t[0],t})},function(e){return o[85]=o[95]}])},function(e){return t.blobs.neq(o[85],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSCreateSignatureWithArmadilloKey.nop"),o[33]).then(function(e){var t;return t=e,o[95]=t[0],t})},function(e){return t.blobs.neq(o[95],void 0)?t.resolve(o[96]=o[95]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create labyrinth signature"),o[101]="Failed to create labyrinth signature",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",o[101]].join("")),o[100]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",o[101],o[100],t.i64.cast([0,3]))},function(e){return o[96]=void 0}])},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[32],t.blob("Mw=="),o[85]).then(function(e){var t;return t=e,o[97]=t[0],t})},function(e){return t.blobs.neq(o[97],void 0)?t.resolve(o[98]=o[97]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create armadillo signature"),o[101]="Failed to create armadillo signature",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",o[101]].join("")),o[100]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",o[101],o[100],t.i64.cast([0,3]))},function(e){return o[98]=void 0}])},function(e){return t.blobs.neq(o[98],void 0)?(t.blobs.neq(o[96],void 0)?(o[101]=new t.Map,o[101].set("armadillo_public_key",o[85]),o[101].set("armadillo_key_signature",o[98]),o[101].set("labyrinth_key_signature",o[96]),o[100]=o[101]):o[100]=void 0,o[99]=o[100]):o[99]=void 0,o[86]=o[99]}]):t.resolve(o[86]=void 0)},function(r){return o[86]!==void 0?t.sequence([function(e){return o[95]=o[86].get("armadillo_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[95]).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return o[97]=o[86].get("armadillo_key_signature"),t.nativeOperation(n("LSBase64Encode.nop"),o[97]).then(function(e){var t;return t=e,o[98]=t[0],t})},function(e){return o[99]=o[86].get("labyrinth_key_signature"),t.nativeOperation(n("LSBase64Encode.nop"),o[99]).then(function(e){var t;return t=e,o[100]=t[0],t})},function(r){return o[105]=t.i64.cast([0,1e3]),o[101]=o[105],o[102]=new t.Map,o[102].set("backup_id",e[1]),o[102].set("device_epoch_hmac",o[87]),o[102].set("epoch_root_key_fingerprint",o[68]),o[102].set("device_public_key",o[88]),o[102].set("epoch_storage_pubkey",o[89]),o[102].set("epoch_storage_pubkey_sig",o[90]),o[102].set("epoch_auth_pubkey",o[91]),o[102].set("epoch_auth_pubkey_sig",o[92]),o[102].set("ocmf_rotation_token",o[93]),o[102].set("virtual_device_id",o[94]),o[102].set("device_registration_id",e[11]),o[102].set("base_epoch_id",o[69]),o[102].set("encryption_version_data",o[84]),o[102].set("private_key_debug_token",o[79]),o[102].set("ocmf_client_state_debug_token",o[81]),o[102].set("epoch_storage_pvtkey_debug_token",o[83]),o[102].set("trace_id",e[8]),o[102].set("occam_only_eligible",!0),o[102].set("armadillo_public_key",o[96]==null?"":o[96]),o[102].set("armadillo_key_signature",o[98]==null?"":o[98]),o[102].set("labyrinth_key_signature",o[100]==null?"":o[100]),o[103]=t.toJSON(o[102]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50006]),o[103],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,o[101]).then(function(e){var t;return t=e,o[104]=t[0],t})}]):((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] failed to get armadillo key and device signatures"),o[99]=t.i64.cast([0,1e3]),o[95]=o[99],o[96]=new t.Map,o[96].set("backup_id",e[1]),o[96].set("device_epoch_hmac",o[87]),o[96].set("epoch_root_key_fingerprint",o[68]),o[96].set("device_public_key",o[88]),o[96].set("epoch_storage_pubkey",o[89]),o[96].set("epoch_storage_pubkey_sig",o[90]),o[96].set("epoch_auth_pubkey",o[91]),o[96].set("epoch_auth_pubkey_sig",o[92]),o[96].set("ocmf_rotation_token",o[93]),o[96].set("virtual_device_id",o[94]),o[96].set("device_registration_id",e[11]),o[96].set("base_epoch_id",o[69]),o[96].set("encryption_version_data",o[84]),o[96].set("private_key_debug_token",o[79]),o[96].set("ocmf_client_state_debug_token",o[81]),o[96].set("epoch_storage_pvtkey_debug_token",o[83]),o[96].set("trace_id",e[8]),o[96].set("occam_only_eligible",!0),o[97]=t.toJSON(o[96]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50006]),o[97],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,o[95]).then(function(e){var t;return t=e,o[98]=t[0],t}))},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_issue_add_device_task_end"):t.resolve()}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: $device_epoch_hmac found to be null"):t.resolve()},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,4])})},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $device_epoch_hmac found to be null"),o[70]="$device_epoch_hmac found to be null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[70]].join("")),o[69]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[70],o[69],t.i64.cast([0,3]))}])}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: $latest_epoch_data is null."):t.resolve()},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,4])})},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $latest_epoch_data is null."),o[62]="$latest_epoch_data is null.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[62]].join("")),o[61]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[62],o[61],t.i64.cast([0,3]))}])}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: $mailbox root key is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $mailbox root key is null"),o[47]="$mailbox root key is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[47]].join("")),o[46]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[47],o[46],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] $mailbox root key is null",!1)}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: oblivious validation token is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] oblivious validation token is null"),o[47]="oblivious validation token is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[47]].join("")),o[46]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[47],o[46],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] oblivious validation token is null",!1)}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: epoch root key is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch root key is null"),o[47]="epoch root key is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[47]].join("")),o[46]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[47],o[46],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch root key is null",!1)}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: epoch anon id is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch anon id is null"),o[47]="epoch anon id is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[47]].join("")),o[46]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[47],o[46],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] epoch anon id is null",!1)}])}]):t.sequence([function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_error","LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure: orf client state v1 is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] orf client state v1 is null"),o[41]="orf client state v1 is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ","",o[41]].join("")),o[40]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",o[41],o[40],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] orf client state v1 is null",!1)}])},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_sproc_end"):t.resolve()}]):(i=s.item,t.sequence([function(e){return(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] An authoritative row already exists, aborting execution of addDeviceFromVirtualDevice"),t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,2])})},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_device_already_added"):t.resolve()},function(r){return e[8]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[8],"dasm_add_device_with_virtual_device_and_decryption_key_sproc_end"):t.resolve()}]))})},function(e){return o[2]=t.i64.of_float(Date.now()),o[3]=t.i64.random(),o[5]="Finishing execution. Execution time: ",o[6]=t.i64.to_string(t.i64.sub(o[2],o[0])),o[7]=" ms",o[4]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure] ",o[4],o[5],o[4],o[6],o[4],o[7]].join("")),t.i64.eq(t.i64.mod_(o[3],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(o[8]=",",o[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",[o[5],o[8],o[6],o[8],o[7]].join(""),o[9],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_recovery_code_status","secure_encrypted_backups_epochs"];var s=e;l.default=s}),98);
__d("LSAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure",["LSAddDeviceWithVirtualDeviceAndDecryptionKey","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSAddDeviceWithVirtualDeviceAndDecryptionKey"),a.taskId,a.backupId,a.epochId,a.encryptedSecretValues,a.lastEpochId,a.syncEpochs,a.epochStoragePublicKey,a.backupTenancy,a.traceId,a.blobDecryptionKey,a.virtualDeviceId,a.deviceRegistrationId,a.minosEpoch);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("GaloisField32",["EBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger(),s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,5,7,1,3,13,15,9,11,21,23,17,19,29,31,25,27,0,3,6,5,12,15,10,9,24,27,30,29,20,23,18,17,21,22,19,16,25,26,31,28,13,14,11,8,1,2,7,4,0,4,8,12,16,20,24,28,5,1,13,9,21,17,29,25,10,14,2,6,26,30,18,22,15,11,7,3,31,27,23,19,0,5,10,15,20,17,30,27,13,8,7,2,25,28,19,22,26,31,16,21,14,11,4,1,23,18,29,24,3,6,9,12,0,6,12,10,24,30,20,18,21,19,25,31,13,11,1,7,15,9,3,5,23,17,27,29,26,28,22,16,2,4,14,8,0,7,14,9,28,27,18,21,29,26,19,20,1,6,15,8,31,24,17,22,3,4,13,10,2,5,12,11,30,25,16,23,0,8,16,24,5,13,21,29,10,2,26,18,15,7,31,23,20,28,4,12,17,25,1,9,30,22,14,6,27,19,11,3,0,9,18,27,1,8,19,26,2,11,16,25,3,10,17,24,4,13,22,31,5,12,23,30,6,15,20,29,7,14,21,28,0,10,20,30,13,7,25,19,26,16,14,4,23,29,3,9,17,27,5,15,28,22,8,2,11,1,31,21,6,12,18,24,0,11,22,29,9,2,31,20,18,25,4,15,27,16,13,6,1,10,23,28,8,3,30,21,19,24,5,14,26,17,12,7,0,12,24,20,21,25,13,1,15,3,23,27,26,22,2,14,30,18,6,10,11,7,19,31,17,29,9,5,4,8,28,16,0,13,26,23,17,28,11,6,7,10,29,16,22,27,12,1,14,3,20,25,31,18,5,8,9,4,19,30,24,21,2,15,0,14,28,18,29,19,1,15,31,17,3,13,2,12,30,16,27,21,7,9,6,8,26,20,4,10,24,22,25,23,5,11,0,15,30,17,25,22,7,8,23,24,9,6,14,1,16,31,11,4,21,26,18,29,12,3,28,19,2,13,5,10,27,20,0,16,5,21,10,26,15,31,20,4,17,1,30,14,27,11,13,29,8,24,7,23,2,18,25,9,28,12,19,3,22,6,0,17,7,22,14,31,9,24,28,13,27,10,18,3,21,4,29,12,26,11,19,2,20,5,1,16,6,23,15,30,8,25,0,18,1,19,2,16,3,17,4,22,5,23,6,20,7,21,8,26,9,27,10,24,11,25,12,30,13,31,14,28,15,29,0,19,3,16,6,21,5,22,12,31,15,28,10,25,9,26,24,11,27,8,30,13,29,14,20,7,23,4,18,1,17,2,0,20,13,25,26,14,23,3,17,5,28,8,11,31,6,18,7,19,10,30,29,9,16,4,22,2,27,15,12,24,1,21,0,21,15,26,30,11,17,4,25,12,22,3,7,18,8,29,23,2,24,13,9,28,6,19,14,27,1,20,16,5,31,10,0,22,9,31,18,4,27,13,1,23,8,30,19,5,26,12,2,20,11,29,16,6,25,15,3,21,10,28,17,7,24,14,0,23,11,28,22,1,29,10,9,30,2,21,31,8,20,3,18,5,25,14,4,19,15,24,27,12,16,7,13,26,6,17,0,24,21,13,15,23,26,2,30,6,11,19,17,9,4,28,25,1,12,20,22,14,3,27,7,31,18,10,8,16,29,5,0,25,23,14,11,18,28,5,22,15,1,24,29,4,10,19,9,16,30,7,2,27,21,12,31,6,8,17,20,13,3,26,0,26,17,11,7,29,22,12,14,20,31,5,9,19,24,2,28,6,13,23,27,1,10,16,18,8,3,25,21,15,4,30,0,27,19,8,3,24,16,11,6,29,21,14,5,30,22,13,12,23,31,4,15,20,28,7,10,17,25,2,9,18,26,1,0,28,29,1,31,3,2,30,27,7,6,26,4,24,25,5,19,15,14,18,12,16,17,13,8,20,21,9,23,11,10,22,0,29,31,2,27,6,4,25,19,14,12,17,8,21,23,10,3,30,28,1,24,5,7,26,16,13,15,18,11,22,20,9,0,30,25,7,23,9,14,16,11,21,18,12,28,2,5,27,22,8,15,17,1,31,24,6,29,3,4,26,10,20,19,13,0,31,27,4,19,12,8,23,3,28,24,7,16,15,11,20,6,25,29,2,21,10,14,17,5,26,30,1,22,9,13,18],u=[0,1,18,28,9,23,14,12,22,4,25,16,7,15,6,13,11,24,2,29,30,26,8,5,17,10,21,31,3,19,20,27],c="ACDEFHJKLMNPQRSTUVWXYZ0123456789",d=(function(){for(var e={},t=0;t<c.length;t++){var n=f(t);n!=null&&(e[c[t]]=n)}return e})();function m(e,t){return s[e*32+t]}function p(t){for(var n=[],r=0;r<t.length;r++){if(!(t[r]in d))return e.mustfix("gf32: tried to convert invalid string to GF32 matrix: %s",t),null;n[r]=d[t[r]]}return n}function _(e){var t=[];for(var n of e)t.push(c[n]);return t.join("")}function f(e){return e===0||e===1||e===2||e===3||e===4||e===5||e===6||e===7||e===8||e===9||e===10||e===11||e===12||e===13||e===14||e===15||e===16||e===17||e===18||e===19||e===20||e===21||e===22||e===23||e===24||e===25||e===26||e===27||e===28||e===29||e===30||e===31?e:null}function g(t){for(var n=[],r=0;r<t.length;r++){var o=f(t[r]);if(o==null)throw e.mustfixThrow("gf32: tried to convert bad value to GF32 element: %s",t[r]);n.push(o)}return n}function h(t,n){var r=t^n,o=f(r);if(o==null)throw e.mustfixThrow("gf32: xor of gf32 elements returned a non-element (should be impossible): %s ^ %s = %s",t,n,r);return o}function y(e,t,n,r,o){for(var a=0;a<t;a++)e[n*t+a]=h(e[n*t+a],m(e[r*t+a],o))}function C(e,t,n,r){for(var o=0;o<t;o++){var a=e[n*t+o];e[n*t+o]=e[r*t+o],e[r*t+o]=a}}function b(e,t,n,r){for(var o=0;o<t;o++)e[n*t+o]=m(e[n*t+o],r)}function v(t,n){if(n===0)throw e.mustfixThrow("gf32: tried to divide by 0");return m(t,u[n])}function S(e){for(var t=Array(e*e).fill(0),n=0;n<e;n++)t[n*e+n]=1;return t}function R(e,t){for(var n=e.slice(),r=S(t),o=0;o<t;o++){var a=o;if(n[o*t+a]===0){for(var i=!1,l=o+1;l<t;l++)if(n[l*t+a]!==0){C(n,t,o,l),C(r,t,o,l),i=!0;break}if(!i)return null}for(var s=o+1;s<t;s++){var c=v(n[s*t+a],n[o*t+a]);y(n,t,s,o,c),y(r,t,s,o,c)}}for(var d=t-1;d>=0;d--)for(var m=d,p=d-1;p>=0;p--){var _=v(n[p*t+m],n[d*t+m]);y(n,t,p,d,_),y(r,t,p,d,_)}for(var f=0;f<t;f++){var g=n[f*t+f];if(g===0)return null;b(r,t,f,u[g])}return r}var L=0;l.zero=L,l.matrixToSymbols=_,l.symbolsToMatrix=p,l.invert=R,l.xor=h,l.multiply=m,l.asGf32MatExn=g}),98);
__d("GF32RecoveryCodes",["EBLogger","GaloisField32"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger(),s=34,u=4,c=3,d=s+u,m=o("GaloisField32").asGf32MatExn([18,24,16,12,8,20,2,19,4,22,21,5,28,5,14,21,7,16,15,10,3,9,28,22,11,30,19,6,7,7,9,18,16,2,9,12,18,14,7,6,5,16,9,24,16,28,19,2,14,8,2,4,1,21,26,21,10,27,16,25,18,14,20,17,11,22,21,22,16,20,2,5,0,9,6,7,23,23,23,11,6,5,3,31,29,30,17,28,0,30,28,7,13,5,11,22,12,16,25,3,20,22,26,22,14,29,5,14,5,19,12,19,18,8,25,7,30,7,8,12,0,26,15,10,17,21,2,29,14,4,31,7,29,6,29,1,14,16,17,15,4,16,7,4,7,4,8,26,10,23,24,26]);function p(e,t,n){n===void 0&&(n=1);for(var r=[],o=e;o<t;o+=n)r.push(o);return r}var _={};function f(e,t){function n(e,t,r,o){if(t<=0)return[[]];if(o-r<=t)return[p(r,o)];var a=e|t<<8|r<<16|o<<24,i=_[a];if(i!=null)return i;var l=[];return n(e-1,t-1,r+1,o).forEach(function(e){var t=e.slice();t.splice(0,0,r),l.push(t)}),n(e-1,t,r+1,o).forEach(function(e){l.push(e.slice())}),_[a]=l,l}return n(e,t,0,e)}function g(e,t){for(var n=e.length,r=Array(n*n).fill(0),o=0,a=0;a<u;a++)if(a!==t){for(var i=0;i<n;i++){var l=e[i];r[o*n+i]=m[a*d+l]}o++}return r}function h(e,t){for(var n=0;n<u;n++){var r=g(e,n),a=o("GaloisField32").invert(r,t);if(a!=null)return{excludeRow:n,submatInv:a}}return null}function y(t){for(var n=Array(u).fill(0),r=0;r<u;r++)for(var a=0;a<s;a++)n[r]=o("GaloisField32").xor(n[r],o("GaloisField32").multiply(m[r*d+a],t[a]));for(var i=Array(u*u),l=0;l<u;l++)for(var c=0;c<u;c++)i[l*u+c]=m[l*d+s+c];var p=o("GaloisField32").invert(i,u);if(p==null)throw e.mustfixThrow("gf32: failed to invert error code submatrix (should be impossible): %s",JSON.stringify(i));for(var _=Array(u).fill(0),f=0;f<u;f++)for(var g=0;g<u;g++)_[f]=o("GaloisField32").xor(_[f],o("GaloisField32").multiply(p[f*u+g],n[g]));return _}function C(t){var n=new Set,r=o("GaloisField32").symbolsToMatrix(t);if(r==null)return e.warn("gf32: recovery code %s could not be converted to GF32 matrix",t),[t];for(var a=Array(u).fill(0),i=0;i<u;i++)for(var l=0;l<d;l++)a[i]=o("GaloisField32").xor(a[i],o("GaloisField32").multiply(m[i*d+l],r[l]));var s=f(d,c);for(var p of s){for(var _=a.slice(),g=0;g<u;g++)for(var y of p)_[g]=o("GaloisField32").xor(_[g],o("GaloisField32").multiply(m[g*d+y],r[y]));var C=h(p,c);if(C==null){e.warn("gf32: no submat inverse found for error locs %s",JSON.stringify(p));continue}var b=C.excludeRow,v=C.submatInv,S=Array(c).fill(0),R=_.slice();R.splice(b,1);for(var L=0;L<c;L++)for(var E=0;E<c;E++)S[L]=o("GaloisField32").xor(S[L],o("GaloisField32").multiply(v[L*c+E],R[E]));for(var k=o("GaloisField32").zero,I=0;I<c;I++)k=o("GaloisField32").xor(k,o("GaloisField32").multiply(m[b*d+p[I]],S[I]));if(k===_[b]){for(var T=r.slice(),D=0;D<p.length;D++)T[p[D]]=S[D];n.add(o("GaloisField32").matrixToSymbols(T))}}return Array.from(n)}l.getEccForCode=y,l.getCandidateCodes=C}),98);
__d("checkLSRecoveryCodeMatch",["LSBinaryToHex.nop","LSShape","LSVec","Promise","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,a,i,l,s){var u=r("LSVec").toArray(s).map(function(e){return o("LSShape").toRecord(e)}),c=r("LSBinaryToHex.nop")(t,a,r("nullthrows")(i)),d=function(s,u){return s.then(function(o){if(o[0]!=null)return(e||(e=n("Promise"))).resolve(o);var s=r("LSBinaryToHex.nop")(t,a,u.virtual_device_id);return(e||(e=n("Promise"))).all([c,s]).then(function(t){var r=t[0],o=t[1],a=r.length===o.length&&r.every(function(e,t){return e===o[t]});return a?(e||(e=n("Promise"))).resolve([i,l]):(e||(e=n("Promise"))).resolve([void 0,void 0])})})};return u.reduce(d,(e||(e=n("Promise"))).resolve([void 0,void 0]))}l.default=s}),98);
__d("deriveLSKey",["I64","LSCreateDerivedKeys.nop","LSCryptoUtils","LSVec"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a,i,l){var s=l==="1"?(e||(e=o("I64"))).of_string("8"):(e||(e=o("I64"))).of_string("16"),u=r("LSVec").ofArray([s,(e||(e=o("I64"))).of_string("32")]);return r("LSCreateDerivedKeys.nop")(t,n,o("LSCryptoUtils").strToBuf(i),void 0,o("LSCryptoUtils").strToBuf(a),u).then(function(e){var t=e[0];if(t==null)return[void 0,void 0];var n=r("LSVec").toArray(t);return n.length===2?[n[0],n[1]]:[void 0,void 0]})}l.default=s}),98);
__d("parseLSRecoveryCode",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=e.substring(0,1);if(!(e.length!==40||n!=="1"&&n!=="2")){var r=n==="1"?35:34,o=e.substring(1,2),a=e.substring(2,r+2),i="BackupRecoveryCode_v"+n+"_"+o+"_"+t;return[a,i,n]}}i.default=e}),66);
__d("LSParseRecoveryCode_v2.nop",["CryptoLogger","GF32RecoveryCodes","Promise","checkLSRecoveryCodeMatch","deriveLSKey","parseLSRecoveryCode"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,a,i,l,s){var u=o("CryptoLogger").CryptoLogger("parse_recovery_code_v2"),c=r("parseLSRecoveryCode")(i,l);return c!=null?r("deriveLSKey")(t,a,c[0],c[1],c[2]):(s&&u.mustfix("could not parse recovery code with uid"),(e||(e=n("Promise"))).resolve([void 0,void 0]))}var u=new Map([["B","8"],["G","C"],["I","1"],["O","0"]]),c=new RegExp("["+Array.from(u.keys()).join("")+"]","g");function d(e){return e.replace(c,function(e){return u.get(e)||e})}var m=function(a,i,l,u,c){if(l.length!==40)return(e||(e=n("Promise"))).resolve([void 0,void 0]);var t=l.substring(0,2),m=d(l.substring(2,40)),p=o("GF32RecoveryCodes").getCandidateCodes(m),_=function(l,d){return l.then(function(o){return o[0]!=null?(e||(e=n("Promise"))).resolve(o):s(a,i,t+d,u,!1).then(function(t){var o=t[0];return o==null?(e||(e=n("Promise"))).resolve([void 0,void 0]):r("checkLSRecoveryCodeMatch")(a,i,o,t[1],c)}).then(function(e){return e[0]==null?[void 0,void 0]:e})})};return p.reduce(_,(e||(e=n("Promise"))).resolve([void 0,void 0])).then(function(r){return r[0]==null?s(a,i,t+m,u,!0):(e||(e=n("Promise"))).resolve(r)})};m.__nop_name__="LSParseRecoveryCode_v2",l.default=m}),98);
__d("MWEncryptedBackupsDeviceRegistrationId",["FBLogger","MessengerWebInitData"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e=r("MessengerWebInitData").sessionId;return e==null?(r("FBLogger")("wmi_eb").mustfix("PAKE: Failed to get registration id from MessengerWebInitData"),""):e}l.getDeviceRegistrationId=e}),98);
__d("EBAddDeviceGraphQL",["CometRelay","EBAPIQPLPoints","EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery.graphql","EBGetLSVirtualDevices","EBMinosCheckWasmFeatureSupport","FBLogger","I64","LSAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure","LSDict","LSEncryptedBackupsBackupTenancy","LSFactory","LSParseRecoveryCode_v2.nop","LSShape","LSVec","MWEncryptedBackupsDeviceRegistrationId","Promise","ReQL","WAArrayBufferUtils","WABase64","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=e!==void 0?e:e=n("EBAddDeviceGraphQLEBFetchVirtualDeviceInfoQuery.graphql");function d(e){var t=e.backupId,n=e.qplFlow,r=e.recoveryCode,a=e.storage,i=e.userId;return o("WorkerRelayNetwork").getWorkerNetworkExecute().then(function(){return p({backupId:t,fetchQueryGraphQLFn:function(t,n){return o("WorkerRelay").createWorkerQuery(t,n)},qplFlow:n,recoveryCode:r,storage:a,userId:i})}).catch(function(){return o("WAResultOrError").makeError("worker-environment-error")})}function m(e){var t=e.backupId,n=e.environment,r=e.qplFlow,a=e.recoveryCode,i=e.storage,l=e.userId;return p({backupId:t,fetchQueryGraphQLFn:function(t,r){return o("CometRelay").fetchQuery(n,t,r,{fetchPolicy:"network-only"}).toPromise()},qplFlow:r,recoveryCode:a,storage:i,userId:l})}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.backupId,a=e.fetchQueryGraphQLFn,l=e.qplFlow,d=e.recoveryCode,m=e.storage,p=e.userId,_=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK();try{return y(m).then(function(e){var t=e!=null?e:p;return l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_PARSE_RECOVERY_CODE_START),(u||(u=n("Promise"))).all([m.runInTransaction(function(e){return r("LSParseRecoveryCode_v2.nop")(e,0,d,t,r("LSVec").ofArray([]))},"readwrite","ui",void 0,i.id+":209"),u.resolve(t)])}).then(function(e){l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_PARSE_RECOVERY_CODE_END);var n=e[0][0],u=e[0][1],d=e[1];if(n==null||u==null)return o("WAResultOrError").makeError("missing-mandatory-field");var p=o("WABase64").encodeB64(n);return l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_START),a(c,{request_uuid:d,virtual_device_id:p}).then(function(e){var a,c,d,p;if((e==null||(a=e.fetch_virtual_device_info_for_device_addition_v2)==null?void 0:a.ok)===!1){var y,C,b;return l.addAnnotations({string:{fetch_vd_info_error_code:(y=e==null||(C=e.fetch_virtual_device_info_for_device_addition_v2)==null||(C=C.error)==null?void 0:C.code)!=null?y:""}}),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_END),(e==null||(b=e.fetch_virtual_device_info_for_device_addition_v2)==null||(b=b.error)==null?void 0:b.code)==="NO_VIRTUAL_DEVICE_FOUND"?o("EBGetLSVirtualDevices").getLSVirtualDevices(m).then(function(e){return e.length>0&&l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_EXISTS),o("WAResultOrError").makeError("graphql-fetch-vd-error")}):o("WAResultOrError").makeError("graphql-fetch-vd-error")}l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_END);var v=e==null||(c=e.fetch_virtual_device_info_for_device_addition_v2)==null?void 0:c.data,S=o("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId(),R=(v==null?void 0:v.encrypted_secret_values)!=null?h(v==null?void 0:v.encrypted_secret_values):null,L=v==null?void 0:v.epoch_storage_public_key,E=v==null?void 0:v.epoch_id,k=v==null?void 0:v.last_epoch_id;if(v==null||S===""||R==null||E==null||L==null||k==null){var I=[];return v==null&&I.push("payload"),S===""&&I.push("deviceRegistrationId"),R==null&&I.push("validated_encrypted_secret_values"),E==null&&I.push("epoch_id"),L==null&&I.push("epoch_storage_public_key"),k==null&&I.push("last_epoch_id"),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_MISSING_GRAPHQL_FIELDS,{string_array:{missing_mandatory_field:I}}),o("WAResultOrError").makeError("missing-mandatory-field")}var T=new(r("LSDict"));v.sync_epochs.forEach(function(e){var t=f(e);t!=null&&e.epoch_id!=null&&T.set(e.epoch_id,o("LSShape").ofRecord(t))});var D=g({epoch_head:(d=v.minos_epoch)==null?void 0:d.epoch_head,self_epoch_signature:(p=v.minos_epoch)==null?void 0:p.self_epoch_signature});l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_KEY_SPROC_START);var x={backupId:t,backupTenancy:(s||(s=o("I64"))).of_int32(r("LSEncryptedBackupsBackupTenancy").PRODUCTION),blobDecryptionKey:u,deviceRegistrationId:S,encryptedSecretValues:o("LSShape").ofRecord(R),epochId:s.of_string(E),epochStoragePublicKey:o("WABase64").decodeB64(L),lastEpochId:s.of_string(k),syncEpochs:T,taskId:s.of_int32(0),traceId:l.getQPLAttrs().instanceKey.toString(),virtualDeviceId:n};return(_||r("gkx")("17219"))&&(x=babelHelpers.extends({},x,{minosEpoch:D})),m.runInTransaction(function(e){return r("LSAddDeviceWithVirtualDeviceAndDecryptionKeyStoredProcedure")(r("LSFactory")(e),x)},"readwrite",void 0,void 0,i.id+":382").then(function(){return l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_KEY_SPROC_END),o("WAResultOrError").makeResult()}).catch(function(e){var t=r("getErrorSafe")(e);return l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_VIRTUAL_DEVICE_KEY_SPROC_FAIL,{string:{error_message:t.message}}),o("WAResultOrError").makeError("vd-and-decryption-key-sproc-error")})}).catch(function(e){var t=r("getErrorSafe")(e);return l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_FETCH_VD_GRAPHQL_FAIL,{string:{error_message:t.message}}),o("WAResultOrError").makeError("graphql-fetch-vd-error")})}).catch(function(e){var t=r("getErrorSafe")(e);return l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_PARSE_RECOVERY_CODE_FAIL,{string:{error_message:t.message}}),o("WAResultOrError").makeError("parse-recovery-code-error")})}catch(e){var C=r("getErrorSafe")(e);return r("FBLogger")("wmi_eb").catching(C).mustfix("Runtime error performing EBAddDeviceGraphQL: %s",C.message),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_RUNTIME_ERROR,{string:{error_message:C.message}}),(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("runtime-error"))}}),_.apply(this,arguments)}function f(e){var t=e.backup_id,n=e.encrypted_epoch_key,a=e.epoch_anon_id,i=e.epoch_auth_public_key,l=e.epoch_data_v2,u=e.epoch_id,c=e.is_active_epoch,d=e.minos_epoch,m=e.next_epoch_id,p=e.prev_epoch_id;if(t==null||a==null||i==null||u==null||c==null)return null;var _=d==null?void 0:d.epoch_head,f=d==null?void 0:d.self_epoch_signature,g=_!=null&&f!=null?o("LSShape").ofRecord({epoch_head:o("WABase64").decodeB64(_),self_epoch_signature:o("WABase64").decodeB64(f)}):void 0,h=l==null?void 0:l.epoch_anon_id,y=l==null?void 0:l.epoch_root_key,C=h!=null&&y!=null?{epoch_anon_id:h,epoch_root_key:y}:null,b={backup_id:(s||(s=o("I64"))).of_string(t),encrypted_epoch_key:n!=null?o("WABase64").decodeB64(n):null,epoch_anon_id:o("WAArrayBufferUtils").stringToArrayBuffer(a),epoch_auth_public_key:o("WABase64").decodeB64(i),epoch_data_v2:C?o("LSShape").ofRecord(C):null,epoch_id:s.of_string(u),is_active_epoch:c,next_epoch_id:m!=null?(s||(s=o("I64"))).of_string(m):null,prev_epoch_id:p!=null?(s||(s=o("I64"))).of_string(p):null};return(r("gkx")("20911")||r("gkx")("17219"))&&(b=babelHelpers.extends({},b,{minos_epoch:g})),b}function g(e){var t=e.epoch_head,n=e.self_epoch_signature;return t==null||n==null?void 0:o("LSShape").ofRecord({epoch_head:o("WABase64").decodeB64(t),self_epoch_signature:o("WABase64").decodeB64(n)})}function h(e){var t=e.encrypted_epoch_anon_id,n=e.encrypted_epoch_root_key,r=e.encrypted_epoch_storage_private_key,o=e.encrypted_mailbox_root_key_blob,a=e.encrypted_oblivious_validation_token_blob,i=e.encrypted_ocmf_client_state,l=e.encrypted_orf_client_state_v2;return t==null||n==null||o==null||a==null||i==null?null:{encrypted_epoch_anon_id:t,encrypted_epoch_root_key:n,encrypted_epoch_storage_private_key:r,encrypted_mailbox_root_key_blob:o,encrypted_oblivious_validation_token_blob:a,encrypted_ocmf_client_state:i,encrypted_orf_client_state_v2:l}}function y(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.tables.encrypted_backups)).then(function(e){var t=e==null?void 0:e.encryptionManagementDelegatorId;return t!=null?(s||(s=o("I64"))).to_string(t):null})}l.addDeviceGraphQLWorker=d,l.addDeviceGraphQL=m}),98);
__d("EBSMGating",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("24151")}l.isPersistedEBTableEnabled=e}),98);
__d("EBSMGatingUI",["EBSMGating","MAWWaitForBackendSetup"],(function(t,n,r,o,a,i,l){"use strict";function e(){return o("MAWWaitForBackendSetup").isBackendSetupSuccessful()||o("EBSMGating").isPersistedEBTableEnabled()}l.isBackendSetupSuccessfulForEBSM=e}),98);
__d("LSOnboardFromExistingDeviceStart",["LSGetLatestEpochKeys","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][onboardFromExistingDeviceStart] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.db.table(282).add({stateKey:"auto_restored",stateValue:"true"})},function(n){return t.db.table(185).add({pk:t.i64.cast([0,1]),backupId:e[0],deviceRegistrationId:e[2],taskId:t.i64.cast([0,1])})},function(e){return t.storedProcedure(n("LSGetLatestEpochKeys"),!1).then(function(e){var t;return t=e,r[2]=t[0],r[3]=t[1],t})},function(o){return r[2]!==void 0?t.sequence([function(o){return r[11]=r[2].get("epoch_keys"),r[12]=r[11].get("epoch_id"),r[13]=new t.Map,r[13].set("existing_device_id",e[1]),r[13].set("base_epoch_id",r[12]),r[14]=new t.Map,r[14].set("success",r[13]),r[15]=t.toJSON(r[14]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",t.i64.cast([0,50036]),r[15],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[16]=t[0],t})},function(e){return r[4]=void 0}]):t.sequence([function(e){return r[3]!==void 0?t.sequence([function(e){return r[12]=r[3].get("error_message"),r[13]=r[3].get("error_code"),r[14]=new t.Map,r[14].set("error_code",r[13]),r[14].set("stored_procedure","onboardFromExistingDeviceStart"),r[14].set("error_message",r[12]),r[15]=new t.Map,r[15].set("failure",r[14]),r[16]=t.toJSON(r[15]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",t.i64.cast([0,50036]),r[16],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[17]=t[0],t})},function(e){return r[18]=new t.Map,r[18].set("error_code",r[13]),r[18].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure"),r[18].set("error_message",""),r[11]=r[18]}]):t.sequence([function(e){return r[12]=new t.Map,r[12].set("error_code",t.i64.cast([0,603])),r[12].set("stored_procedure","onboardFromExistingDeviceStart"),r[12].set("error_message","Unknown error encountered"),r[13]=new t.Map,r[13].set("failure",r[12]),r[14]=t.toJSON(r[13]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",t.i64.cast([0,50036]),r[14],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[15]=t[0],t})},function(e){return r[16]=new t.Map,r[16].set("error_code",t.i64.cast([0,603])),r[16].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure"),r[16].set("error_message",""),r[11]=r[16]}])},function(e){return r[4]=r[11]}])},function(e){return r[5]=t.i64.of_float(Date.now()),r[6]=t.i64.random(),r[8]="Finishing execution. Execution time: ",r[9]=t.i64.to_string(t.i64.sub(r[5],r[0])),r[10]=" ms",r[7]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][onboardFromExistingDeviceStart] ",r[7],r[8],r[7],r[9],r[7],r[10]].join("")),t.i64.eq(t.i64.mod_(r[6],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[11]=",",r[12]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"onboardFromExistingDeviceStart",[r[8],r[11],r[9],r[11],r[10]].join(""),r[12],t.i64.cast([0,4]))):t.resolve()},function(e){return o[0]=r[4]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure",e.__tables__=["experiences_shared_state","device_metadata"],a.exports=e}),null);
__d("LSOnboardFromExistingDeviceStartStoredProcedure",["LSOnboardFromExistingDeviceStart","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSOnboardFromExistingDeviceStart"),a.backupId,a.previousDeviceId,a.newDeviceRegistrationId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("EBAddDeviceWithKeys",["ClientConsistencyEventEmitter","CurrentAppID","EBAPIQPLPoints","EBDB","EBSMAPI","EBSMGatingUI","I64","LSAuthorityLevel","LSFactory","LSIntEnum","LSOnboardFromExistingDeviceStartStoredProcedure","LSShape","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWEBODSEntityName.enum","MWEncryptedBackupsInitializeRestoreDeferred","MWEncryptedBackupsLocalStorageEntryEnum","MWEncryptedBackupsSharedState","ODS","Promise","QPLFlow","QPLUserFlow","ReQL","WAHashStringToNumber","WALogger","err","getErrorSafe","justknobx","promiseDone","qpl","requireDeferred","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C=r("requireDeferred")("MWEBUseLocalStorage").__setRef("EBAddDeviceWithKeys");function b(t){var a=t.backupId,l=t.db,_=t.newDeviceRegistrationId,b=t.previousDeviceId,S=t.source,R=t.trackAddingDevice;return new(y||(y=n("Promise")))(function(t,n){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys start"]))),r("QPLUserFlow").addPoint(o("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"START_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC");var y=o("WAHashStringToNumber").hashStringToNumber(r("uuidv4")()),L=r("qpl")._(521473756,"2768"),E=S,k=o("QPLFlow").startQPLFlow(L,{annotations:{bool:{isEBAddDeviceWithKeys:!0,isInWorker:!1},string:{restore_type:E}},instanceKey:y,timeoutInMs:r("justknobx")._("2444")});k.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_START),(f||(f=o("ODS"))).bumpEntityKey(7319,E,"start"),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys caling LSOnboardFromExistingDeviceStartStoredProcedure"]))),l.runInTransaction(function(e){return r("LSOnboardFromExistingDeviceStartStoredProcedure")(r("LSFactory")(e),{backupId:a,newDeviceRegistrationId:_,previousDeviceId:b})},"readwrite",void 0,void 0,i.id+":103").then(function(e){var a=e[0];if(r("QPLUserFlow").addPoint(o("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"END_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC"),k.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_END),a!=null){var i,s=o("LSShape").toRecord(a).error_message;switch(r("QPLUserFlow").addPoint((i=o("MWChatEncryptedBackupsQPLEvents")).restoreDeviceAuthQplEvent,"FAIL_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC_WIPE_EBSM"),r("QPLUserFlow").addPoint(i.restoreQplEvent,"FAIL_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC_WIPE_EBSM"),o("MWChatEncryptedBackupsLogging").endFailure({errorName:s,event:i.restoreQplEvent}),o("MWChatEncryptedBackupsLogging").endFailure({errorName:s,event:i.restoreDeviceAuthQplEvent,odsEntityName:r("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),k.endFail(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{string:{error_code:(g||(g=o("I64"))).to_string(o("LSShape").toRecord(a).error_code),error_message:s}}),(f||(f=o("ODS"))).bumpEntityKey(7319,E,"fail"),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithKeys sproc failed, isInWorker: false, error: ",""])),s),r("promiseDone")(o("EBDB").clearEbStores()),o("CurrentAppID").getAppID()){case 772021112871879 .toString():r("ClientConsistencyEventEmitter").emit("hardRefresh","eb_autorestore_error");break;default:r("ClientConsistencyEventEmitter").emit("softRefresh","eb_autorestore_error")}n(r("err")(s))}k.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SUBSCRIPTION_START);var _=o("ReQL").fromTableAscending(l.tables.secure_encrypted_backups_client_state).subscribe(function(e,a){if(a.operation==="delete"){_();var i="[wmi][ebsm] EBAPI addDeviceWithKeys subscription failed, isInWorker: false, error: client state deleted";v(i,k,E),n(r("err")(i))}else if(a.operation==="add"||a.operation==="put"){var s=a.value,u=s.authorityLevel,y=s.deviceId;(g||(g=o("I64"))).equal(u,(h||(h=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))&&(r("QPLUserFlow").addPoint(o("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"END_LS_ADD_DEVICE_WITH_EB_KEYS_TASK"),k.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SUBSCRIPTION_END),_(),r("promiseDone")(o("MWEncryptedBackupsSharedState").upsertEBSharedStateEntry({db:l,stateKey:r("MWEncryptedBackupsLocalStorageEntryEnum").ENCRYPTED_BACKUPS_RESTORED_SUCCESSFULLY})),o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys client state row added"]))),R(y),C.onReady(function(e){var t=e.mwEBCreateLocalStorageEntry,n=e.mwEBDeleteLocalStorageEntry;t(r("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION),t(r("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION_2),n(r("MWEncryptedBackupsLocalStorageEntryEnum").EBSM_CORRUPTION_WIPE)}),o("MWEncryptedBackupsInitializeRestoreDeferred").encryptedBackupsInitializeRestoreDeferred({db:l,onFailure:function(){o("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:o("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:"FAILED_TO_RESTORE_ENCRYPTED_BACKUP",event:o("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),o("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:o("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:"FAILED_TO_RESTORE_ENCRYPTED_BACKUP",event:o("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:r("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys initialize restore failed"])))},onSuccess:function(){r("QPLUserFlow").addAnnotations(o("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{restore_type:"auto_restore"}}),o("MWChatEncryptedBackupsLogging").endSuccess({annotations:{bool:{is_backend_setup:o("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},event:o("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),o("MWChatEncryptedBackupsLogging").endSuccess({event:o("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:r("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys initialize restore success"])))}}),r("EBSMAPI").fetchBackupIds("EBAddDeviceWithKeys").catch(function(e){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["",""])),r("getErrorSafe")(e).message)}),k.endSuccess(),(f||(f=o("ODS"))).bumpEntityKey(7319,E,"success"),t())}})}).catch(function(e){var t="[wmi][ebsm] EBAPI addDeviceWithKeys sproc error, isInWorker: false, error: "+r("getErrorSafe")(e).message;v(t,k,E),n(r("err")(t))})})}function v(e,t,n){o("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{isBackendSetupOnFail:o("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:e,event:o("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),o("MWChatEncryptedBackupsLogging").endFailure({errorName:e,event:o("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:r("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),t.endFail(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{string:{error_message:e}}),(f||(f=o("ODS"))).bumpEntityKey(7319,n,"fail"),o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["",""])),e)}l.addDeviceWithEBKeys=b}),98);
__d("LSAddDevice",["LSArrayGetObjectAt","LSBase64Encode.nop","LSGetViewerFBID","LSHandleWrongRecoveryCode","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSParseRecoveryCode_v2.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop","justknobx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(i){return t.sequence([function(r){return o[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Beginning execution."),e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_sproc_start"):t.resolve()},function(a){return r("justknobx")._("946")?t.sequence([function(e){return o[8]=t.createArray(),t.forEach(t.db.table(179).fetch(),function(e){var n=e.item;return t.sequence([function(e){return o[15]=n.taskId,t.db.table(2).fetch([[[o[15]]]]).next().then(function(e,t){var n=e.done,r=e.value;return n?o[13]=!1:(t=r.item,o[13]=!0)})},function(e){return o[13]?0:o[16]=(o[8].push(o[15]),o[8])}])})},function(e){return o[9]=t.i64.of_int32(o[8].length),t.i64.gt(o[9],t.i64.cast([0,0]))?t.loopAsync(o[9],function(e){return o[13]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[8],o[13]).then(function(e){var t;return t=e,o[14]=t[0],o[15]=t[1],t})},function(e){return t.forEach(t.db.table(179).fetch([[[o[14]]]]),function(e){return e.delete()})}])}):t.resolve()},function(e){return t.db.table(179).fetch().next().then(function(e,t){var n=e.done,r=e.value;return n?o[10]=!1:(t=r.item,o[10]=!0)})},function(r){return o[10]?t.sequence([function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: add device task already pending"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] add device task already pending"),o[14]="add device task already pending",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ","",o[14]].join("")),o[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",o[14],o[13],t.i64.cast([0,3]))},function(e){return o[12]=t.i64.cast([0,1])}]):t.sequence([function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_vd_error_correction_start"):t.resolve()},function(n){return o[13]=t.createArray(),t.forEach(t.filter(t.db.table(184).fetch(),function(n){return t.i64.eq(n.backupId,e[0])}),function(e){var n=e.item;return o[19]=new t.Map,o[19].set("virtual_device_id",n.virtualDeviceId),o[20]=(o[13].push(o[19]),o[13])})},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_vd_error_correction_end"):t.resolve()},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_parse_recovery_code_start"):t.resolve()},function(e){return t.db.table(172).fetch().next().then(function(e,n){var r=e.done,a=e.value;return r?o[14]=void 0:(n=a.item,o[20]=n.encryptionManagementDelegatorId,t.i64.neq(o[20],void 0)?(t.i64.neq(o[20],t.i64.cast([0,0]))?o[21]=t.i64.to_string(o[20]):o[21]=void 0,o[19]=o[21]):o[19]=void 0,o[14]=o[19])})},function(e){return t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,o[16]=t[0],t})},function(r){return t.nativeOperation(n("LSParseRecoveryCode_v2.nop"),e[1],o[14]==null?t.i64.to_string(o[16]):o[14],o[13]).then(function(e){var t;return t=e,o[17]=t[0],o[18]=t[1],t})},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_parse_recovery_code_end"):t.resolve()},function(r){return t.blobs.neq(o[17],void 0)?t.blobs.neq(o[18],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[17]).then(function(e){var t;return t=e,o[19]=t[0],t})},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,1])})},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_issue_fetch_virtual_device_task_start"):t.resolve()},function(r){return o[24]=t.i64.cast([0,1e3]),o[20]=o[24],o[21]=new t.Map,o[21].set("backup_id",e[0]),o[21].set("virtual_device_id",o[19]==null?"":o[19]),o[21].set("trace_id",void 0),o[22]=t.toJSON(o[21]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50007]),o[22],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,o[20]).then(function(e){var t;return t=e,o[23]=t[0],t})},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_issue_fetch_virtual_device_task_end"):t.resolve()},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_insert_device_registration_id_start"):t.resolve()},function(n){return t.db.table(185).add({pk:t.i64.cast([0,1]),backupId:e[0],deviceRegistrationId:e[2],taskId:o[23]})},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_insert_device_registration_id_end"):t.resolve()},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_insert_recovery_code_data_start"):t.resolve()},function(e){return t.db.table(179).add({taskId:o[23],virtualDeviceId:o[17],blobDecryptionKey:o[18]})},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_insert_recovery_code_data_end"):t.resolve()}]):t.sequence([function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: Invalid recovery code. blob_decryption_key is null"):t.resolve()},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. blob_decryption_key is null",!0)}]):t.sequence([function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: Invalid recovery code. virtual_device_id is null"):t.resolve()},function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. virtual_device_id is null"),o[20]="Invalid recovery code. virtual_device_id is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ","",o[20]].join("")),o[19]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",o[20],o[19],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. virtual_device_id is null",!0)}])},function(e){return o[12]=t.i64.cast([0,0])}])},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_sproc_end"):t.resolve()},function(e){return o[1]=o[12]}]):t.sequence([function(r){return(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] addDeviceFlow is not enabled"),e[4]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_error","LSEncryptedBackupsAddDeviceStoredProcedure: add device flow is disabled"):t.resolve()},function(r){return e[4]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,1021646192]),e[4],"dasm_add_device_sproc_end"):t.resolve()},function(e){return o[1]=t.i64.cast([0,1])}])},function(e){return o[2]=t.i64.of_float(Date.now()),o[3]=t.i64.random(),o[5]="Finishing execution. Execution time: ",o[6]=t.i64.to_string(t.i64.sub(o[2],o[0])),o[7]=" ms",o[4]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ",o[4],o[5],o[4],o[6],o[4],o[7]].join("")),t.i64.eq(t.i64.mod_(o[3],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(o[8]=",",o[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",[o[5],o[8],o[6],o[8],o[7]].join(""),o[9],t.i64.cast([0,4]))):t.resolve()},function(e){return a[0]=o[1]}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsAddDeviceStoredProcedure",e.__tables__=["secure_recovery_code_data","pending_tasks","encrypted_backups_virtual_devices","encrypted_backups","secure_encrypted_backups_recovery_code_status","device_metadata"];var s=e;l.default=s}),98);
__d("LSAddDeviceStoredProcedure",["LSAddDevice","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSAddDevice"),a.backupId,a.recoveryCode,a.deviceRegistrationId,a.backupTenancy,a.traceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSEncryptedBackupsOpStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({SUCCESS:0,FAILURE:1,UNKNOWN:2});i.default=e}),66);
__d("LSEncryptedBackupsRecoveryCodeStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({OPTIMISTIC:1,VALID:2,INVALID:3,SYSTEM_ERROR:4});i.default=e}),66);
__d("MWEncryptedBackupsRecoveryCodeStatus",["FBLogger","I64","LSEncryptedBackupsRecoveryCodeStatus"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.onFailure,a=t.onInvalidRecoveryCode,i=t.onSuccess,l=t.recoveryCodeStatusData;if((l==null?void 0:l.length)===1){var s=l[0].recoveryCodeStatus;switch((e||(e=o("I64"))).to_int32(s)){case r("LSEncryptedBackupsRecoveryCodeStatus").OPTIMISTIC:return r("LSEncryptedBackupsRecoveryCodeStatus").OPTIMISTIC;case r("LSEncryptedBackupsRecoveryCodeStatus").INVALID:return a==null||a(),r("LSEncryptedBackupsRecoveryCodeStatus").INVALID;case r("LSEncryptedBackupsRecoveryCodeStatus").VALID:return i==null||i(),r("LSEncryptedBackupsRecoveryCodeStatus").VALID;case r("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR:return n==null||n(),r("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR;default:n==null||n(),r("FBLogger")("wmi_eb").mustfix("Invalid Recovery Code Status type")}}}l.encryptedBackupsGetRecoveryCodeStatus=s}),98);
__d("EBAddDeviceWithRecoveryCode",["EBAPIQPLPoints","EBAddDeviceGraphQL","EBDeps","FBLogger","I64","LSAddDeviceStoredProcedure","LSEncryptedBackupsBackupTenancy","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","MAWWaitForBackendSetup","MWEncryptedBackupsDeviceRegistrationId","MWEncryptedBackupsRecoveryCodeStatus","Promise","ReQL","WALogger","WAResultOrError","asyncToGeneratorRuntime","isInstamadilloEB","justknobx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=10;function f(e){var t=e.count,a=e.storage;return new(p||(p=n("Promise")))(function(e,n){if(t===_)return e();r("promiseDone")(o("ReQL").firstAsync(o("ReQL").fromTableAscending(a.tables.encrypted_backups)),function(n){var r=n==null?void 0:n.backupId;if(r!=null)return e(r);window.setTimeout(function(){e(f({count:t+1,storage:a}))},1e3)},function(e){return n(e)})})}function g(t){var a=t.environment,l=t.qplFlow,_=t.recoveryCode,g=t.userId,C=function(){},b=!1,v=new(p||(p=n("Promise")))(function(e,t){window.setTimeout(function(){b||(r("FBLogger")("wmi_eb").warn("Add device failed by timeout 90 sec"),y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TIMEOUT),e("ADD_DEVICE_TIMEOUT"))},r("justknobx")._("4226"))}),S=new p((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_START);var p=yield o("EBDeps").getDeps().getLSDB();l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_END),C=p.tables.secure_encrypted_backups_recovery_code_status.subscribe(function(e,n){if(n.operation!=="delete"){var a=[n.value];l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_CHECK_RC_STATUS),o("MWEncryptedBackupsRecoveryCodeStatus").encryptedBackupsGetRecoveryCodeStatus({onFailure:function(){y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILED_TO_GET_RC_STATUS),C(),t("ADD_DEVICE_FAILED_TO_GET_RC_STATUS")},onInvalidRecoveryCode:function(){y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.INVALID_RECOVERY_CODE),C(),t("INVALID_RECOVERY_CODE")},onSuccess:function(){l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_END),l.endSuccess({bool:{isBackendSetupOnSuccess:o("EBDeps").getDeps().isBackendSetupSuccessful()}}),C(),r("promiseDone")(o("EBDeps").getDeps().trackAddingNewDevice()),t("SUCCESS")},recoveryCodeStatusData:a})}}),r("promiseDone")(f({count:0,storage:p}),function(f){if(f!=null)if(r("isInstamadilloEB")()){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device sproc start"])));var b=o("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();return b===""?(y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILED_DEVICE_REGISTRATION_ID_NULL),C(),n("deviceRegistrationId is not defined")):(l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_START),p.runInTransaction(function(e){return r("LSAddDeviceStoredProcedure")(r("LSFactory")(e),{backupId:f,backupTenancy:(d||(d=o("I64"))).of_int32(r("LSEncryptedBackupsBackupTenancy").PRODUCTION),deviceRegistrationId:b,recoveryCode:_})},"readwrite",void 0,void 0,i.id+":232").then(function(e){var t=e[0];if(!(d||(d=o("I64"))).equal(t,(m||(m=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").SUCCESS)))return y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{bool:{is_backend_setup:o("MAWWaitForBackendSetup").isBackendSetupSuccessful()}}),C(),n("Add device sproc failed");l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_END),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_START),o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device sproc success"])))}).catch(function(e){throw l.addAnnotations({string:{error_message:e.message}}),e}))}else{o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device gql start"]))),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_START);var h=a!=null?o("EBAddDeviceGraphQL").addDeviceGraphQL({backupId:f,environment:a,qplFlow:l,recoveryCode:_,storage:p,userId:g}):o("EBAddDeviceGraphQL").addDeviceGraphQLWorker({backupId:f,qplFlow:l,recoveryCode:_,storage:p,userId:g});return h.then(function(e){if(e.success)l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_END),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_START),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device gql success"])));else return y(l,o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_FAIL,{string:{fail_result:e.error}}),l.addPoint(o("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_FAIL),C(),t("ADD_DEVICE_GRAPHQL_ERROR")})}else return y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILURE_BACKUP_NOT_FOUND),C(),t("ADD_DEVICE_ERROR_BACKUP_ID_NOT_DEFINED")},function(e){return r("FBLogger")("wmi_eb").catching(e).mustfix("Add device failed. Could not find backup."),y(l,o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_COULD_NOT_FIND_BACKUP,{string:{error_message:e.message}}),C(),t("ADD_DEVICE_ERROR_COULD_NOT_READ_BACKUP_TABLE")})});return function(e,n){return t.apply(this,arguments)}})());return p.race([S,v]).then(function(e){return b=!0,h(e)})}function h(e){return e==="SUCCESS"?o("WAResultOrError").makeResult():o("WAResultOrError").makeError(e)}var y=function(t,n,r){t.endFail(n,babelHelpers.extends({},r!=null?r:{},{bool:{isBackendSetupOnFail:o("EBDeps").getDeps().isBackendSetupSuccessful()}}))};l.addDeviceWithRecoveryCode=g}),98);
__d("EBAddVirtualDevice",["EBDeps","EBLogger","I64","LSEncryptedBackupsOpStatus","LSEncryptedBackupsRecoveryCodeStatus","LSIntEnum","Promise","ReQL","WAResultOrError","asyncToGeneratorRuntime","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=r("requireDeferred")("MWEncryptedBackupsCreateExtraVirtualDeviceWithRecoveryCodeData").__setRef("EBAddVirtualDevice");function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.actionType,i=t.qplFlow,l=t.recoveryCodeData;i.addPoint("add_virtual_device_get_db_start");var d=yield o("EBDeps").getDeps().getLSDB();return i.addPoint("add_virtual_device_get_db_end"),i.addPoint("add_virtual_device_sproc_start"),new(u||(u=n("Promise")))(function(t,n){return c.onReady(function(n){var u=d.tables.secure_encrypted_backups_recovery_code_status.subscribe(function(){r("promiseDone")(o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(d.tables.secure_encrypted_backups_recovery_code_status)),function(n){if(n!=null&&n.length===1){var a=n[0].recoveryCodeStatus;return(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsRecoveryCodeStatus").VALID))?(u(),t(o("WAResultOrError").makeResult())):(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsRecoveryCodeStatus").INVALID))?(u(),t(o("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_STATUS_INVALID"))):void 0}})});r("promiseDone")(n.initializeCreateExtraVirtualDeviceStoredProcedure(d,(e||(e=o("I64"))).of_int32(a),l),function(n){i.addPoint("add_virtual_device_sproc_end");var a=n[0];if(!(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").SUCCESS)))return(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE))?(i.endFail("add_virtual_device_sproc_failure"),o("EBLogger").EBLogger().mustfix("Error while creating extra virtual device - failure"),t(o("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_STATUS_FAILURE"))):(i.addPoint("add_virtual_device_sproc_fail_unknown"),o("EBLogger").EBLogger().mustfix("Error while creating extra virtual device - unknown"),t(o("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_STATUS_UNKNOWN")))},function(){return o("EBLogger").EBLogger().mustfix("Error while creating extra virtual device."),t(o("WAResultOrError").makeError("ADD_VIRTUAL_DEVICE_ERROR"))})})})}),m.apply(this,arguments)}l.addVirtualDevice=d}),98);
__d("EBBucketUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){if(t===void 0&&(t=100),n===void 0&&(n=5),e===0)return"zero";if(e<0)return"negative";if(n<=0)return"invalidIncrement";if(e>t)return"greaterThanLimit";var r=Math.floor((e-1)/n)*n+1,o=Math.min(r+n-1,t);return r+"-"+o}i.getBucketName=e}),66);
__d("EBDeleteBackupsOnClient",["EBAPIQPLPoints","EBDeps","EBSMAPI","Promise","QPLFlow","Random","ReQL","asyncToGeneratorRuntime","getErrorSafe","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.reason,i=o("Random").uint32(),l=o("QPLFlow").startQPLFlow(r("qpl")._(521485243,"1081"),{annotations:{string:{reason:a}},instanceKey:i});try{var s;l.addPoint((s=o("EBAPIQPLPoints")).EBDeleteBackupsOnClientQPLPoints.GET_DB_START);var u=yield o("EBDeps").getDeps().getLSDB();l.addPoint(s.EBDeleteBackupsOnClientQPLPoints.GET_DB_END),l.addPoint(s.EBDeleteBackupsOnClientQPLPoints.TRANSACTION_START),yield u.runInTransaction((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r,a;l.addPoint((r=o("EBAPIQPLPoints")).EBDeleteBackupsOnClientQPLPoints.CLEAR_CLIENT_STATE_START);var i=yield(a=o("ReQL")).toArrayAsync(a.fromTableAscending(t.secure_encrypted_backups_client_state));yield(e||(e=n("Promise"))).all(i.map(function(e){return t.secure_encrypted_backups_client_state.delete(e.backupId)})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_CLIENT_STATE_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_EPOCHS_START);var s=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.secure_encrypted_backups_epochs));yield e.all(s.map(function(e){return t.secure_encrypted_backups_epochs.delete(e.epochId)})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_EPOCHS_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_RECOVERY_CODE_START);var u=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.secure_encrypted_backups_generated_recovery_code));yield e.all(u.map(function(e){return t.secure_encrypted_backups_generated_recovery_code.delete(e.pk)})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_RECOVERY_CODE_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_ENCRYPTED_BACKUPS_START);var c=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.encrypted_backups));yield e.all(c.map(function(e){return t.encrypted_backups.put(babelHelpers.extends({},e,{backupId:void 0}))})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_ENCRYPTED_BACKUPS_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_METADATA_START);var d=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.encrypted_backups_metadata));yield e.all(d.map(function(e){return t.encrypted_backups_metadata.delete(e.backupId)})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_METADATA_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_VIRTUAL_DEVICES_START);var m=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.encrypted_backups_virtual_devices));yield e.all(m.map(function(e){return t.encrypted_backups_virtual_devices.delete(e.pk)})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_VIRTUAL_DEVICES_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_RECOVERY_CODE_STATUS_START);var p=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.secure_encrypted_backups_recovery_code_status));yield e.all(p.map(function(e){return t.secure_encrypted_backups_recovery_code_status.delete(e.pk)})),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_RECOVERY_CODE_STATUS_END),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_PENDING_BACKUPS_START);var _=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.pending_backups_context_v2));yield e.all(_.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.pendingBackupTaskId;n!=null&&(yield t.pending_tasks.delete(n))});return function(t){return e.apply(this,arguments)}})())),l.addPoint(o("EBAPIQPLPoints").EBDeleteBackupsOnClientQPLPoints.CLEAR_PENDING_BACKUPS_END)});return function(e){return t.apply(this,arguments)}})(),"readwrite"),l.addPoint(s.EBDeleteBackupsOnClientQPLPoints.TRANSACTION_END),l.addPoint(s.EBDeleteBackupsOnClientQPLPoints.FETCH_BACKUP_IDS_START),yield r("EBSMAPI").fetchBackupIds("deleteBackupsOnClient"),l.addPoint(s.EBDeleteBackupsOnClientQPLPoints.FETCH_BACKUP_IDS_END),l.endSuccess()}catch(e){var c=r("getErrorSafe")(e);throw l.endFail("runtime_error",{string:{error_message:c.message}}),e}}),u.apply(this,arguments)}l.deleteBackupsOnClient=s}),98);
__d("LSDeleteBackups",["LSBase64Encode.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","justknobx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(i){return t.sequence([function(a){return o[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] Beginning execution."),r("justknobx")._("803")?t.sequence([function(r){return t.db.table(168).fetch([[[e[0]]]]).next().then(function(r,a){var i=r.done,l=r.value;return i?((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] Row not found in client state table for the backupidDeleting the backup without deleting mailbox"),o[9]=new t.Map,o[9].set("backup_id",e[0]),o[9].set("trace_id",e[1]),o[9].set("backup_deletion_source",e[2]),o[10]=t.toJSON(o[9]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50011]),o[10],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),e[1],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[11]=t[0],t})):(a=l.item,t.sequence([function(r){return o[13]=a.deviceId,t.nativeOperation(n("LSGetBlobFromString.nop"),t.i64.to_string(e[0])).then(function(e){var t;return t=e,o[9]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWFpbGJveF9pZF9zY29wZQ=="),o[9]).then(function(e){var t;return t=e,o[10]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),a.ocmfClientStateBlob,o[10]).then(function(e){var t;return t=e,o[11]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[11]).then(function(e){var t;return t=e,o[12]=t[0],t})},function(r){return t.i64.neq(o[13],void 0)?(o[14]=new t.Map,o[14].set("device_id",o[13]),o[14].set("mailbox_partial_id",o[12]==null?"":o[12]),o[14].set("trace_id",e[1]),o[14].set("backup_deletion_source",e[2]),o[15]=t.toJSON(o[14]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",t.i64.cast([0,50014]),o[15],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),e[1],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[16]=t[0],t})):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] device_id is null"),o[15]="device_id is null",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] ","",o[15]].join("")),o[14]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupsStoredProcedure",o[15],o[14],t.i64.cast([0,3]))},function(r){return o[16]=new t.Map,o[16].set("backup_id",e[0]),o[16].set("trace_id",e[1]),o[16].set("backup_deletion_source",e[2]),o[17]=t.toJSON(o[16]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50011]),o[17],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),e[1],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[18]=t[0],t})}])}]))})},function(e){return o[1]=t.i64.cast([0,0])}]):t.resolve(((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] backup deletion flow is not enabled"),o[1]=t.i64.cast([0,1])))},function(e){return o[2]=t.i64.of_float(Date.now()),o[3]=t.i64.random(),o[5]="Finishing execution. Execution time: ",o[6]=t.i64.to_string(t.i64.sub(o[2],o[0])),o[7]=" ms",o[4]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsDeleteBackupsStoredProcedure] ",o[4],o[5],o[4],o[6],o[4],o[7]].join("")),t.i64.eq(t.i64.mod_(o[3],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(o[8]=",",o[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDeleteBackupsStoredProcedure",[o[5],o[8],o[6],o[8],o[7]].join(""),o[9],t.i64.cast([0,4]))):t.resolve()},function(e){return a[0]=o[1]}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsDeleteBackupsStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"];var s=e;l.default=s}),98);
__d("LSDeleteBackupsStoredProcedure",["LSDeleteBackups","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSDeleteBackups"),a.backupId,a.traceId,a.backupDeletionSource);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("encryptedBackupsDeleteBackupsStoredProcedure",["LSDeleteBackupsStoredProcedure","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSResult","ReQL","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,a,l){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.encrypted_backups)).then((function(){var s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var s=r("LSResult")((e||(e=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE));if(n!=null){var u=n.backupId;u!=null&&(s=yield t.runInTransaction(function(t){return r("LSDeleteBackupsStoredProcedure")(r("LSFactory")(t),{backupDeletionSource:(e||(e=o("LSIntEnum"))).ofNumber(a),backupId:u,traceId:l})},"readwrite",void 0,void 0,i.id+":37"))}return s});return function(e){return s.apply(this,arguments)}})())}l.default=s}),98);
__d("EBDeleteEncryptedBackup",["EBAPIQPLPoints","EBDeps","EBSMAPI","LSEncryptedBackupsOpStatus","LSIntEnum","Promise","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","encryptedBackupsDeleteBackupsStoredProcedure","getSafeQplErrorMessage","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["EB","EBAPIDeleteEncryptedBackup"]);function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.qplFlow,i=t.reason;a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_GET_DB_START);var l=yield o("EBDeps").getDeps().getLSDB();return a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_GET_DB_END),a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_START),new(u||(u=n("Promise")))(function(t,n){r("encryptedBackupsDeleteBackupsStoredProcedure")(l,i,a.getQPLAttrs().instanceKey.toString()).then(function(e){var n=e[0];if(n===(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE)){a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_FAIL),a.endFail("delete_eb_sproc_fail"),t(o("WAResultOrError").makeError("DELETE_EB_SPROC_FAIL"));return}a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_SUCCESS);var i=l.tables.encrypted_backups.subscribe(function(e,n){if(n.operation==="put"){if(n.value.backupId==null)return a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_TASK_SUCCESS),a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.FETCH_BACKUP_IDS_START),r("promiseDone")(r("EBSMAPI").fetchBackupIds("EBDeleteEncryptedBackup"),function(){a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.FETCH_BACKUP_IDS_END),a.endSuccess()},function(){a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.FETCH_BACKUP_IDS_END),a.endFail("fetch_backup_ids_fail")}),t(o("WAResultOrError").makeResult()),i();a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_NON_DELETE_OPERATION)}else a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_NON_PUT_OPERATION)},void 0,["backupId"])}).catch(function(n){c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Exception while calling deleteBackups stored procedure: ",""])),n),a.addPoint(o("EBAPIQPLPoints").EBDeleteEBQPLPoints.DELETE_EB_SPROC_ERROR,{string:{error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(n)}}),a.endFail("delete_eb_sproc_error"),t(o("WAResultOrError").makeError("DELETE_EB_SPROC_ERROR"))})})}),m.apply(this,arguments)}l.deleteEncryptedBackup=d}),98);
__d("EBFetchBackupIds",["EBDeps","I64","LSAuthorityLevel","LSEncryptedBackupsBackupTenancy","LSFactory","LSFetchBackupIdsStoredProcedure","LSIntEnum","MWEBODSEntityName.enum","ODS","Promise","asyncToGeneratorRuntime","err","justknobx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){(c||(c=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MW_EBSM_FETCH_BACKUP_IDS,t+".sproc"),a.addPoint("eb_fetch_backup_ids_get_storage_start");var i=yield o("EBDeps").getDeps().getLSDB();return a.addPoint("eb_fetch_backup_ids_get_storage_ended"),new(e||(e=n("Promise")))(function(e,t){var n,l=i.tables.encrypted_backups.subscribe(function(t,i){if(i.operation==="delete"||!(s||(s=o("I64"))).equal(i.value.authorityLevel,(u||(u=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))){i.operation==="delete"?a.addPoint("eb_fetch_backup_ids_delete_detected"):a.addPoint("eb_fetch_backup_ids_authority_level_not_auth");return}l(),window.clearTimeout(n),a.addPoint("eb_fetch_backup_ids_success"),a.endSuccess(),e()});a.addPoint("eb_fetch_backup_ids_sproc_start"),r("promiseDone")(i.runInTransaction(function(e){return r("LSFetchBackupIdsStoredProcedure")(r("LSFactory")(e),{backupTenancy:(u||(u=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsBackupTenancy").PRODUCTION),isUiBlocking:!1}).then(function(){a.addPoint("eb_fetch_backup_ids_sproc_ended"),n=window.setTimeout(function(){a.endFail("eb_fetch_backup_ids_timeout"),t(r("err")("[wmi][ebapi] Timeout fetching backup ids"))},r("justknobx")._("3868"))})},"readwrite"))})}),m.apply(this,arguments)}function p(e,t){return d(e,t)}l.fetchBackupIds=p}),98);
__d("LSCreateRecoveryCode.nop",["CryptoLogger","GF32RecoveryCodes","GaloisField32","LSResult","Promise","UInt8Array"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){for(;;){var t=o("UInt8Array").getBufferWithRandomValuesFromLength(1),n=new Uint8Array(t)[0];if(n<256-256%e)return n%e}return 0}var u=function(a,i){var t=["2","0"].join("");try{for(var l=[],u=0;u<=33;++u)l.push(s(32));var c=o("GF32RecoveryCodes").getEccForCode(o("GaloisField32").asGf32MatExn(l)),d=l.concat(c),m=o("GaloisField32").matrixToSymbols(o("GaloisField32").asGf32MatExn(d)),p=t+m;return(e||(e=n("Promise"))).resolve(r("LSResult")(p))}catch(e){throw o("CryptoLogger").captureError(o("CryptoLogger").CryptoLogger("create_recovery_code"),e).mustfix("creating recovery code failed"),e}};u.__nop_name__="LSCreateRecoveryCode",l.default=u}),98);
__d("LSGenerateRecoveryCode",["LSCreateRecoveryCode.nop","LSGetViewerFBID","LSLogMebClientEvent.nop","LSParseRecoveryCode_v2.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure] Beginning execution."),t.forEach(t.filter(t.db.table(174).fetch(),function(e){return e.recoveryCode==="1SHADOWTESTINGRECOVERYCODE00000000000000"}),function(e){return e.delete()})},function(e){return t.db.table(174).fetch([[[t.i64.cast([0,1])]]]).next().then(function(e,o){var a=e.done,i=e.value;return a?t.sequence([function(e){return t.nativeOperation(n("LSCreateRecoveryCode.nop")).then(function(e){var t;return t=e,r[15]=t[0],t})},function(e){return t.db.table(174).add({pk:t.i64.cast([0,1]),recoveryCode:r[15]})},function(e){return r[1]=r[15]}]):(o=i.item,r[1]=o.recoveryCode)})},function(n){return t.forEach(t.db.table(174).fetch([[[t.i64.cast([0,1])]]]),function(t){var n=t.update,r=t.item;return n({virtualDeviceType:e[0],cloudServiceAccount:void 0,hsmPinNormalizationStatus:void 0})})},function(e){return r[3]=t.createArray(),t.db.table(172).fetch().next().then(function(e,n){var o=e.done,a=e.value;return o?r[4]=void 0:(n=a.item,r[16]=n.encryptionManagementDelegatorId,t.i64.neq(r[16],void 0)?(t.i64.neq(r[16],t.i64.cast([0,0]))?r[17]=t.i64.to_string(r[16]):r[17]=void 0,r[15]=r[17]):r[15]=void 0,r[4]=r[15])})},function(e){return t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return t.nativeOperation(n("LSParseRecoveryCode_v2.nop"),r[1],r[4]==null?t.i64.to_string(r[6]):r[4],r[3]).then(function(e){var t;return t=e,r[7]=t[0],r[8]=t[1],t})},function(e){return r[9]=t.i64.of_float(Date.now()),r[10]=t.i64.random(),r[12]="Finishing execution. Execution time: ",r[13]=t.i64.to_string(t.i64.sub(r[9],r[0])),r[14]=" ms",r[11]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure] ",r[11],r[12],r[11],r[13],r[11],r[14]].join("")),t.i64.eq(t.i64.mod_(r[10],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[15]=",",r[16]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure",[r[12],r[15],r[13],r[15],r[14]].join(""),r[16],t.i64.cast([0,4]))):t.resolve()},function(e){var n;return n=[r[1],t.i64.cast([0,0]),r[7]],o[0]=n[0],o[1]=n[1],o[2]=n[2],n}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsGenerateRecoveryCodeStoredProcedure",e.__tables__=["secure_encrypted_backups_generated_recovery_code","encrypted_backups"],a.exports=e}),null);
__d("LSGenerateRecoveryCodeStoredProcedure",["LSGenerateRecoveryCode","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSGenerateRecoveryCode"),a.virtualDeviceType);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("EBGenerateRecoveryCode",["Base64Utils","EBDeps","LSEncryptedBackupsOpStatus","LSFactory","LSGenerateRecoveryCodeStoredProcedure","LSIntEnum","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield o("EBDeps").getDeps().getLSDB(),a=t.virtualDeviceType;return n.runInTransaction(function(e){return r("LSGenerateRecoveryCodeStoredProcedure")(r("LSFactory")(e),{virtualDeviceType:a})},"readwrite",void 0,void 0,i.id+":35").then(function(t){var n=t[0],a=t[1],i=t[2];return(e||(e=o("LSIntEnum"))).toNumber(a)!==r("LSEncryptedBackupsOpStatus").SUCCESS?o("WAResultOrError").makeError("sproc_failure"):o("WAResultOrError").makeResult({recoveryCode:n,virtualDeviceId:i!=null?o("Base64Utils").fromArrayBuffer(i):void 0})})}),u.apply(this,arguments)}l.generateRecoveryCode=s}),98);
__d("EBGetContactEpochHead",["EBMinosSecureMailboxKeysForContact","Promise","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.rawContactId;if(r==null)return(e||(e=n("Promise"))).reject(o("WAResultOrError").makeError("invalid-arguments"));var a=yield o("EBMinosSecureMailboxKeysForContact").getSecureMailboxKeysForContact(r);return a==null?o("WAResultOrError").makeResult():o("WAResultOrError").makeResult({epochHead:a.epoch_head,epochHeadCreationTime:a.epoch_head_creation_time})}),u.apply(this,arguments)}l.getContactEpochHead=s}),98);
__d("EBGetCryptoWasm",["WAWasmModuleCache","bx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("bx").getURL(r("bx")("32099")),s=function(){return o("WAWasmModuleCache").loadWasmModule(e)};l.getCryptoWasm=s}),98);
__d("EBGetEBStateQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="23909871918604871"}),null);
__d("EBGetEBStateQuery.graphql",["EBGetEBStateQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null},t={alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:[{kind:"Literal",name:"family_device_id",value:""}],kind:"ScalarField",name:"has_otc_eligible_devices",storageKey:'has_otc_eligible_devices(family_device_id:"")'},{alias:null,args:null,kind:"ScalarField",name:"has_seen_eb_auto_restore_notice",storageKey:null},e,{alias:null,args:null,kind:"ScalarField",name:"is_user_opted_out",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_creation_time",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_tenancy",storageKey:null},{alias:null,args:null,concreteType:"XFBEBVirtualDevice",kind:"LinkedField",name:"virtual_devices",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"creation_time",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"device_created_on",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"device_type",storageKey:null},e,{alias:null,args:null,kind:"ScalarField",name:"migration_status",storageKey:null}],storageKey:null}],storageKey:null},{kind:"ClientExtension",selections:[{alias:null,args:null,kind:"ScalarField",name:"backup_state",storageKey:null}]}],storageKey:null};return{fragment:{argumentDefinitions:[],kind:"Fragment",metadata:null,name:"EBGetEBStateQuery",selections:[{kind:"RequiredField",field:t,action:"LOG",path:"viewer"}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[],kind:"Operation",name:"EBGetEBStateQuery",selections:[t]},params:{id:n("EBGetEBStateQuery_facebookRelayOperation"),metadata:{},name:"EBGetEBStateQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("MAWOneTimeCodeGating",["gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("1910")&&r("justknobx")._("1601")}l.isOneTimeCodeEnabled=e}),98);
__d("EBGetEBState",["EBGetEBStateQuery.graphql","FBLogger","MAWOneTimeCodeGating","RelayHooks","WAResultOrError","XPlatRelayEnvironment","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=e!==void 0?e:e=n("EBGetEBStateQuery.graphql");function u(){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{var e,t,n,a,i,l,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k=yield o("RelayHooks").fetchQuery(o("XPlatRelayEnvironment").getRelayEnvironment(),s,{}).toPromise().then(function(e){return e}),I=k==null||(e=k.viewer)==null?void 0:e.backup_state;if(I===1||I===0)return o("WAResultOrError").makeResult({backupStatus:I});var T=(t=k==null||(n=k.viewer)==null||(n=n.encrypted_backup)==null?void 0:n.virtual_devices)!=null?t:[],D=T.filter(function(e){return e.device_type==="HSM"}),x=T.filter(function(e){return e.device_type==="OFFLINE"});return o("WAResultOrError").makeResult({backupStatus:(k==null||(a=k.viewer)==null?void 0:a.backup_state)!=null?k.viewer.backup_state:0,ebState:{backupMetadata:{backupId:(i=k==null||(l=k.viewer)==null||(l=l.encrypted_backup)==null?void 0:l.id)!=null?i:"",creationTime:(u=k==null||(c=k.viewer)==null||(c=c.encrypted_backup)==null?void 0:c.backup_creation_time)!=null?u:0,deviceCreatedOn:(d=D[0].device_created_on)!=null?d:"",removalStatus:"",requiresHsmMigration:D[0].migration_status!=="DOES_NOT_REQUIRE_MIGRATION",virtualDeviceCreationTime:(m=(p=D[0])==null?void 0:p.creation_time)!=null?m:0,virtualDeviceId:(_=(f=D[0])==null?void 0:f.id)!=null?_:"",virtualDeviceType:(g=(h=D[0])==null?void 0:h.device_type)!=null?g:""},backupTenancy:(y=k==null||(C=k.viewer)==null||(C=C.encrypted_backup)==null?void 0:C.backup_tenancy)!=null?y:"PRODUCTION",hasOtcEligibleDevices:!!(o("MAWOneTimeCodeGating").isOneTimeCodeEnabled()&&(k==null||(b=k.viewer)==null||(b=b.encrypted_backup)==null?void 0:b.has_otc_eligible_devices)!==!1),hasSeenEbAutoRestoreNotice:(v=k==null||(S=k.viewer)==null||(S=S.encrypted_backup)==null?void 0:S.has_seen_eb_auto_restore_notice)!=null?v:!1,isPINCodeRegistered:((R=D[0])==null?void 0:R.id)!=null,isUserOptedOut:(L=k==null||(E=k.viewer)==null||(E=E.encrypted_backup)==null?void 0:E.is_user_opted_out)!=null?L:!1,offlineDevicesCount:x.length}})}catch(e){return r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Failed to check EB enabled"),o("WAResultOrError").makeResult({backupStatus:0})}}),c.apply(this,arguments)}l.GetEbState=u}),98);
__d("EBGetLatestChatJids",["I64","MAWBridgeSafeActionsWorkerAndUI","Promise","ReQL","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=1e3;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){t===void 0&&(t=u);try{var n=m(e,t);return o("WAResultOrError").makeResult(yield n)}catch(e){return o("WAResultOrError").makeError(r("getErrorSafe")(e))}}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r){r===void 0&&(r=u);var a=yield(s||(s=n("Promise"))).all([o("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("getLatestChatJids",{count:r}),yield t.runInTransaction(function(t){return o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.mi_act_mapping_table).map(function(t){var n=t.jid;return(e||(e=o("I64"))).to_string(n)}))},"readonly",void 0,void 0,i.id+":54")]),l=a[0],c=a[1],d=[];if(c.length>0){var m=new Set(c);l.forEach(function(e){var t=e.split("@")[0];m.has(t)&&d.push(e)})}return d}),p.apply(this,arguments)}l.getLatestChatJids=c}),98);
__d("EBGetMessageKeys",["EBMinosDb","FBLogger","Promise","WAResultOrError","WebMps","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("EBMinosDb").getEBMinosDb(),r=yield n.runInTransaction(["secure_minos_message_epoch_heads"],"readonly",function(n){return n.stores.secure_minos_message_epoch_heads.readIndex("[thread_id+message_id]",[e,t])},"LoadNewMinosMessageEpochHead");return r.length===0?null:{epochHead:r[0].epoch_head}});return function(n,r){return e.apply(this,arguments)}})();function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.messageId,i=t.threadId;try{if(a==null||i==null)return o("WAResultOrError").makeError("invalid-arguments");var l=yield o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"get-message-keys"},messageId:a,threadId:i}),c=yield u(i,a);if(c==null)return o("WAResultOrError").makeError("no-epoch-head-found");if(l.success===!1)return o("WAResultOrError").makeError(l.error);var d=l.value;if(d==null)return o("WAResultOrError").makeError("no-message");var m=new Map;yield(s||(s=n("Promise"))).all(Array.from(d.supplementalProtobufs).map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e[0],n=e[1],r=yield u(i,n.messageId);if(r==null)return o("WAResultOrError").makeError("no-epoch-head-found");m.set(t,babelHelpers.extends({},n,{senderEpochHead:r.epochHead}))});return function(t){return e.apply(this,arguments)}})()));var p=babelHelpers.extends({},d.toplevelProtobuf,{senderEpochHead:c.epochHead});return o("WAResultOrError").makeResult(babelHelpers.extends({},d,{supplementalProtobufs:m,toplevelProtobuf:p}))}catch(t){throw r("FBLogger")("wmi_minos").catching(r("getErrorSafe")(t)).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Runtime error in EBGetMessageKeys"]))),t}}),d.apply(this,arguments)}l.getMessageKeys=c}),98);
__d("LSCreateMinosEpochParams.nop",["EBMinosCheckWasmFeatureSupport","EBMinosQplFlow","FBLogger","MAWCurrentUser","WAResultOrError","asyncToGeneratorRuntime","cr:12496","cr:6443","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=n("cr:12496")||n("cr:6443"),u=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l,u,c){var d,m=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupport();if(s==null)throw r("err")("createMinosEpochParamsType error: gk is off but still called");if(!m)throw r("err")("createMinosEpochParamsType error: wasm is not supported");var p=o("EBMinosQplFlow").startMinosCreateEpochParamsQpl(),_=yield s.createMinosEpochParamsType({epochAnonId:i,epochRootKeyBlob:a,previousEpochAnonId:u,previousEpochHead:c,previousEpochRootKeyBlob:l,qplFlow:p,rawUserFbid:o("MAWCurrentUser").getID()}).catch(function(t){var n=r("FBLogger")("minos"),a=r("getErrorSafe")(t);return n.catching(a).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["createMinosEpochParamsType runtime-error"]))),o("WAResultOrError").makeError({errorName:"runtime-error",failReason:a.message})});if(!_.success){var f;throw p.endFailWithError(_.error.errorName,_.error.failReason),r("err")("createMinosEpochParamsType error: "+_.error.errorName+" "+((f=_.error.failReason)!=null?f:""))}return p.endSuccess(),[_.value.mailboxEncryptionPk,_.value.mailboxSigningPk,_.value.mailboxAuthPk,_.value.epochHead,_.value.selfEpochSignature,(d=_.value.previousEpochSignature)!=null?d:void 0]});function a(e,n,r,o,a,i,l){return t.apply(this,arguments)}return a})();u.__nop_name__="LSCreateMinosEpochParamsType",l.default=u}),98);
__d("LSOcmfClientInit_v2.nop",["CryptoLogger","LSResult","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("ristretto255").__setRef("LSOcmfClientInit_v2.nop"),s=function(n,a){return e.load().then(function(e){return r("LSResult")(e.scalar.getRandom().buffer)}).catch(function(e){throw o("CryptoLogger").captureError(o("CryptoLogger").CryptoLogger("ocmf_client_init_v2"),e).mustfix("Failed to init OCMF client."),e})};s.__nop_name__="LSOcmfClientInit_v2",l.default=s}),98);
__d("LSRandom.nop",["CryptoLogger","I64","LSMaxInt32","LSResult","Promise","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(a,i,l){var t=o("CryptoLogger").CryptoLogger("ope_encrypt");if((s||(s=o("I64"))).gt(l,r("LSMaxInt32")))return t.mustfix("numBytes '"+String(l)+"' too large. Returning an empty array"),(e||(e=n("Promise"))).resolve(r("LSResult")(new Uint8Array(0).buffer));for(var u=(s||(s=o("I64"))).to_int32(l),c=new Uint8Array(u),d=65536,m=0;m<u;m+=d){var p=c.subarray(m,m+Math.min(u-m,d));o("XPlatReactCrypto").getRandomValues(p)}return(e||(e=n("Promise"))).resolve(r("LSResult")(c.buffer))};u.__nop_name__="LSRandom",l.default=u}),98);
__d("LSGenerateInitialDeviceSetupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateAuthKeyPair.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientInit_v2.nop","LSOcmfClientMap.nop","LSRandom.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][generateInitialDeviceSetupPayload] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!0}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[33]=new t.Map,r[33].set("error_msg","Expected a nonempty query result"),r[33].set("code",t.i64.cast([0,3])),r[33].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[34]=t.createArray(),r[35]=(r[34].push(r[33]),r[34]),o=[void 0,r[34]],r[2]=o[0],r[3]=o[1]):(n=l.item,r[33]=new t.Map,r[33].set("backup_id",n.backupId),r[33].set("device_public_key_blob",n.devicePublicKeyBlob),r[33].set("device_private_key_blob",n.devicePrivateKeyBlob),r[33].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[33].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[33].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[33].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[33].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[33].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[33].set("orf_client_state_v2_blob",void 0),r[33].set("orf_v2_authority_level",void 0),r[33].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[33].set("device_id",n.deviceId),r[33].set("backup_tenancy",n.backupTenancy),r[33].set("encryption_version",n.encryptionVersion),r[33].set("revision_version",n.revisionVersion),r[33].set("initialize_restore_result",void 0),r[33].set("device_creation_timestamp_sec",void 0),r[33].set("authority_level",n.authorityLevel),a=[r[33],void 0],r[2]=a[0],r[3]=a[1])})},function(e){return r[5]=new t.Map,r[5].set("value",r[2]),r[5].set("errors",r[3]),r[6]=r[5].get("value"),r[6]!==void 0?t.sequence([function(e){return r[33]=r[6].get("backup_id"),r[34]=r[6].get("device_public_key_blob"),r[35]=r[6].get("device_private_key_blob"),r[36]=r[6].get("epoch_storage_public_key_blob"),r[37]=r[6].get("epoch_storage_private_key_blob"),r[38]=r[6].get("epoch_auth_public_key_blob"),r[39]=r[6].get("epoch_auth_private_key_blob"),r[40]=r[6].get("mailbox_root_key_blob"),r[41]=r[6].get("ocmf_client_state_blob"),r[42]=r[6].get("orf_client_state_v2_blob"),r[43]=r[6].get("orf_v2_authority_level"),r[44]=r[6].get("oblivious_validation_token_blob"),r[45]=r[6].get("device_id"),r[46]=r[6].get("backup_tenancy"),r[47]=r[6].get("encryption_version"),r[48]=r[6].get("revision_version"),r[49]=r[6].get("initialize_restore_result"),r[50]=r[6].get("device_creation_timestamp_sec"),r[51]=r[6].get("authority_level"),t.i64.neq(r[45],void 0)?t.sequence([function(e){return r[70]=void 0,t.i64.neq(r[70],void 0)?t.resolve(r[71]=r[70]):t.sequence([function(e){return r[74]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[75]=t[0],t})},function(e){return r[75]&&(r[84]=(r[74].push(t.i64.cast([0,0])),r[74])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[76]=t[0],t})},function(e){return r[76]&&(r[84]=(r[74].push(t.i64.cast([0,2])),r[74])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[77]=t[0],t})},function(e){return r[77]&&(r[84]=(r[74].push(t.i64.cast([0,3])),r[74])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[78]=t[0],t})},function(e){return r[78]&&(r[84]=(r[74].push(t.i64.cast([0,4])),r[74])),r[79]=t.createArray(),r[80]=t.i64.of_int32(r[74].length),t.i64.gt(r[80],t.i64.cast([0,0]))?t.loopAsync(r[80],function(e){return r[84]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[74],r[84]).then(function(e){var t;return t=e,r[85]=t[0],r[86]=t[1],t})},function(e){return r[87]=(r[79].push(r[85]),r[79])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[84]=t.createArray(),r[85]=t.i64.of_int32(r[79].length),t.i64.gt(r[85],t.i64.cast([0,0]))?t.loopAsync(r[85],function(e){return r[87]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[79],r[87]).then(function(e){var t;return t=e,r[88]=t[0],r[89]=t[1],t})},function(e){return r[90]=(r[84].push(t.i64.to_string(r[88])),r[84])}])}):t.resolve()},function(e){return r[86]=r[84].join(","),r[81]=r[86]}])},function(e){return r[79].some(function(e){return t.i64.eq(r[47],e)})?r[82]=r[47]:r[82]=void 0,t.i64.neq(r[82],void 0)?r[83]=r[82]:r[83]=void 0,r[71]=r[83]}])},function(e){var n;return t.i64.neq(r[71],void 0)?r[72]=r[71]:r[72]=t.i64.cast([0,0]),t.i64.neq(r[46],void 0)?r[73]=r[46]:r[73]=t.i64.cast([0,1]),n=[r[33],r[45],r[40],r[41],void 0,void 0,r[72],r[73],r[38],r[39],r[34],r[35],r[36],r[37],r[44],r[51],void 0,void 0],r[52]=n[0],r[53]=n[1],r[54]=n[2],r[55]=n[3],r[56]=n[4],r[57]=n[5],r[58]=n[6],r[59]=n[7],r[60]=n[8],r[61]=n[9],r[62]=n[10],r[63]=n[11],r[64]=n[12],r[65]=n[13],r[66]=n[14],r[67]=n[15],r[68]=n[16],r[69]=n[17]}]):t.sequence([function(e){return t.forEach(t.db.table(169).fetch(),function(e){return e.delete()})},function(e){return r[70]=t.i64.random(),r[71]=t.i64.random(),t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,r[72]=t[0],r[73]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,r[74]=t[0],r[75]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateAuthKeyPair.nop")).then(function(e){var t;return t=e,r[76]=t[0],r[77]=t[1],t})},function(e){return t.nativeOperation(n("LSRandom.nop"),t.i64.cast([0,32])).then(function(e){var t;return t=e,r[78]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientInit_v2.nop")).then(function(e){var t;return t=e,r[79]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientInit_v2.nop")).then(function(e){var t;return t=e,r[80]=t[0],t})},function(e){return t.nativeOperation(n("LSRandom.nop"),t.i64.cast([0,32])).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return r[82]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[83]=t[0],t})},function(e){return r[83]&&(r[109]=(r[82].push(t.i64.cast([0,0])),r[82])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[84]=t[0],t})},function(e){return r[84]&&(r[109]=(r[82].push(t.i64.cast([0,2])),r[82])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[85]=t[0],t})},function(e){return r[85]&&(r[109]=(r[82].push(t.i64.cast([0,3])),r[82])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[86]=t[0],t})},function(e){return r[86]&&(r[109]=(r[82].push(t.i64.cast([0,4])),r[82])),r[87]=t.i64.of_int32(r[82].length),t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[82],t.i64.sub(r[87],t.i64.cast([0,1]))).then(function(e){var t;return t=e,r[88]=t[0],r[89]=t[1],t})},function(e){return t.forEach(t.filter(t.db.table(168).fetch([[[r[70]]]]),function(e){return t.i64.eq(e.backupId,r[70])&&t.i64.lt(e.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(e){return t.db.table(168).add({backupId:r[70],deviceId:r[71],devicePublicKeyBlob:r[73],devicePrivateKeyBlob:r[72],epochStoragePublicKeyBlob:r[75],epochStoragePrivateKeyBlob:r[74],epochAuthPublicKeyBlob:r[77],epochAuthPrivateKeyBlob:r[76],mailboxRootKeyBlob:r[78],ocmfClientStateBlob:r[79],obliviousValidationTokenBlob:r[81],authorityLevel:t.i64.cast([0,20]),encryptionVersion:r[88],revisionVersion:t.i64.cast([0,1]),backupTenancy:t.i64.cast([0,1])})},function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,20]))}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,o){var a,i=e.done,l=e.value;return i?(a=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,t.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,t.i64.cast([0,20]),void 0,void 0],r[90]=a[0],r[91]=a[1],r[92]=a[2],r[93]=a[3],r[94]=a[4],r[95]=a[5],r[96]=a[6],r[97]=a[7],r[98]=a[8],r[99]=a[9],r[100]=a[10],r[101]=a[11],r[102]=a[12],r[103]=a[13],r[104]=a[14],r[105]=a[15],r[106]=a[16],r[107]=a[17],a):(o=l.item,t.sequence([function(e){return r[114]=o.backupTenancy,r[113]=o.encryptionVersion,r[109]=void 0,t.i64.neq(r[109],void 0)?t.resolve(r[110]=r[109]):t.sequence([function(e){return r[115]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[116]=t[0],t})},function(e){return r[116]&&(r[125]=(r[115].push(t.i64.cast([0,0])),r[115])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[117]=t[0],t})},function(e){return r[117]&&(r[125]=(r[115].push(t.i64.cast([0,2])),r[115])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[118]=t[0],t})},function(e){return r[118]&&(r[125]=(r[115].push(t.i64.cast([0,3])),r[115])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[119]=t[0],t})},function(e){return r[119]&&(r[125]=(r[115].push(t.i64.cast([0,4])),r[115])),r[120]=t.createArray(),r[121]=t.i64.of_int32(r[115].length),t.i64.gt(r[121],t.i64.cast([0,0]))?t.loopAsync(r[121],function(e){return r[125]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[115],r[125]).then(function(e){var t;return t=e,r[126]=t[0],r[127]=t[1],t})},function(e){return r[128]=(r[120].push(r[126]),r[120])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[125]=t.createArray(),r[126]=t.i64.of_int32(r[120].length),t.i64.gt(r[126],t.i64.cast([0,0]))?t.loopAsync(r[126],function(e){return r[128]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[120],r[128]).then(function(e){var t;return t=e,r[129]=t[0],r[130]=t[1],t})},function(e){return r[131]=(r[125].push(t.i64.to_string(r[129])),r[125])}])}):t.resolve()},function(e){return r[127]=r[125].join(","),r[122]=r[127]}])},function(e){return r[120].some(function(e){return t.i64.eq(r[113],e)})?r[123]=r[113]:r[123]=void 0,t.i64.neq(r[123],void 0)?r[124]=r[123]:r[124]=void 0,r[110]=r[124]}])},function(e){var n;return t.i64.neq(r[110],void 0)?r[111]=r[110]:r[111]=t.i64.cast([0,0]),t.i64.neq(r[114],void 0)?r[112]=r[114]:r[112]=t.i64.cast([0,1]),n=[o.backupId,o.deviceId,o.mailboxRootKeyBlob,o.ocmfClientStateBlob,void 0,void 0,r[111],r[112],o.epochAuthPublicKeyBlob,o.epochAuthPrivateKeyBlob,o.devicePublicKeyBlob,o.devicePrivateKeyBlob,o.epochStoragePublicKeyBlob,o.epochStoragePrivateKeyBlob,o.obliviousValidationTokenBlob,o.authorityLevel,void 0,void 0],r[90]=n[0],r[91]=n[1],r[92]=n[2],r[93]=n[3],r[94]=n[4],r[95]=n[5],r[96]=n[6],r[97]=n[7],r[98]=n[8],r[99]=n[9],r[100]=n[10],r[101]=n[11],r[102]=n[12],r[103]=n[13],r[104]=n[14],r[105]=n[15],r[106]=n[16],r[107]=n[17]}]))})},function(e){var t;return t=[r[90],r[91],r[92],r[93],r[94],r[95],r[96],r[97],r[98],r[99],r[100],r[101],r[102],r[103],r[104],r[105],r[106],r[107]],r[52]=t[0],r[53]=t[1],r[54]=t[2],r[55]=t[3],r[56]=t[4],r[57]=t[5],r[58]=t[6],r[59]=t[7],r[60]=t[8],r[61]=t[9],r[62]=t[10],r[63]=t[11],r[64]=t[12],r[65]=t[13],r[66]=t[14],r[67]=t[15],r[68]=t[16],r[69]=t[17],t}])},function(e){var t;return t=[r[52],r[53],r[54],r[55],r[56],r[57],r[58],r[59],r[60],r[61],r[62],r[63],r[64],r[65],r[66],r[67],r[68],r[69]],r[7]=t[0],r[8]=t[1],r[9]=t[2],r[10]=t[3],r[11]=t[4],r[12]=t[5],r[13]=t[6],r[14]=t[7],r[15]=t[8],r[16]=t[9],r[17]=t[10],r[18]=t[11],r[19]=t[12],r[20]=t[13],r[21]=t[14],r[22]=t[15],r[23]=t[16],r[24]=t[17],t}]):t.sequence([function(e){return r[33]=r[5].get("errors"),r[34]=r[5].get("errors"),t.forEach(t.db.table(169).fetch(),function(e){return e.delete()})},function(e){return r[35]=t.i64.random(),r[36]=t.i64.random(),t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,r[37]=t[0],r[38]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,r[39]=t[0],r[40]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateAuthKeyPair.nop")).then(function(e){var t;return t=e,r[41]=t[0],r[42]=t[1],t})},function(e){return t.nativeOperation(n("LSRandom.nop"),t.i64.cast([0,32])).then(function(e){var t;return t=e,r[43]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientInit_v2.nop")).then(function(e){var t;return t=e,r[44]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientInit_v2.nop")).then(function(e){var t;return t=e,r[45]=t[0],t})},function(e){return t.nativeOperation(n("LSRandom.nop"),t.i64.cast([0,32])).then(function(e){var t;return t=e,r[46]=t[0],t})},function(e){return r[47]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[48]=t[0],t})},function(e){return r[48]&&(r[74]=(r[47].push(t.i64.cast([0,0])),r[47])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[49]=t[0],t})},function(e){return r[49]&&(r[74]=(r[47].push(t.i64.cast([0,2])),r[47])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[50]=t[0],t})},function(e){return r[50]&&(r[74]=(r[47].push(t.i64.cast([0,3])),r[47])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[51]=t[0],t})},function(e){return r[51]&&(r[74]=(r[47].push(t.i64.cast([0,4])),r[47])),r[52]=t.i64.of_int32(r[47].length),t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[47],t.i64.sub(r[52],t.i64.cast([0,1]))).then(function(e){var t;return t=e,r[53]=t[0],r[54]=t[1],t})},function(e){return t.forEach(t.filter(t.db.table(168).fetch([[[r[35]]]]),function(e){return t.i64.eq(e.backupId,r[35])&&t.i64.lt(e.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(e){return t.db.table(168).add({backupId:r[35],deviceId:r[36],devicePublicKeyBlob:r[38],devicePrivateKeyBlob:r[37],epochStoragePublicKeyBlob:r[40],epochStoragePrivateKeyBlob:r[39],epochAuthPublicKeyBlob:r[42],epochAuthPrivateKeyBlob:r[41],mailboxRootKeyBlob:r[43],ocmfClientStateBlob:r[44],obliviousValidationTokenBlob:r[46],authorityLevel:t.i64.cast([0,20]),encryptionVersion:r[53],revisionVersion:t.i64.cast([0,1]),backupTenancy:t.i64.cast([0,1])})},function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,20]))}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,o){var a,i=e.done,l=e.value;return i?(a=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,t.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,t.i64.cast([0,20]),void 0,void 0],r[55]=a[0],r[56]=a[1],r[57]=a[2],r[58]=a[3],r[59]=a[4],r[60]=a[5],r[61]=a[6],r[62]=a[7],r[63]=a[8],r[64]=a[9],r[65]=a[10],r[66]=a[11],r[67]=a[12],r[68]=a[13],r[69]=a[14],r[70]=a[15],r[71]=a[16],r[72]=a[17],a):(o=l.item,t.sequence([function(e){return r[79]=o.backupTenancy,r[78]=o.encryptionVersion,r[74]=void 0,t.i64.neq(r[74],void 0)?t.resolve(r[75]=r[74]):t.sequence([function(e){return r[80]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return r[81]&&(r[90]=(r[80].push(t.i64.cast([0,0])),r[80])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return r[82]&&(r[90]=(r[80].push(t.i64.cast([0,2])),r[80])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[83]=t[0],t})},function(e){return r[83]&&(r[90]=(r[80].push(t.i64.cast([0,3])),r[80])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[84]=t[0],t})},function(e){return r[84]&&(r[90]=(r[80].push(t.i64.cast([0,4])),r[80])),r[85]=t.createArray(),r[86]=t.i64.of_int32(r[80].length),t.i64.gt(r[86],t.i64.cast([0,0]))?t.loopAsync(r[86],function(e){return r[90]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[80],r[90]).then(function(e){var t;return t=e,r[91]=t[0],r[92]=t[1],t})},function(e){return r[93]=(r[85].push(r[91]),r[85])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[90]=t.createArray(),r[91]=t.i64.of_int32(r[85].length),t.i64.gt(r[91],t.i64.cast([0,0]))?t.loopAsync(r[91],function(e){return r[93]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[85],r[93]).then(function(e){var t;return t=e,r[94]=t[0],r[95]=t[1],t})},function(e){return r[96]=(r[90].push(t.i64.to_string(r[94])),r[90])}])}):t.resolve()},function(e){return r[92]=r[90].join(","),r[87]=r[92]}])},function(e){return r[85].some(function(e){return t.i64.eq(r[78],e)})?r[88]=r[78]:r[88]=void 0,t.i64.neq(r[88],void 0)?r[89]=r[88]:r[89]=void 0,r[75]=r[89]}])},function(e){var n;return t.i64.neq(r[75],void 0)?r[76]=r[75]:r[76]=t.i64.cast([0,0]),t.i64.neq(r[79],void 0)?r[77]=r[79]:r[77]=t.i64.cast([0,1]),n=[o.backupId,o.deviceId,o.mailboxRootKeyBlob,o.ocmfClientStateBlob,void 0,void 0,r[76],r[77],o.epochAuthPublicKeyBlob,o.epochAuthPrivateKeyBlob,o.devicePublicKeyBlob,o.devicePrivateKeyBlob,o.epochStoragePublicKeyBlob,o.epochStoragePrivateKeyBlob,o.obliviousValidationTokenBlob,o.authorityLevel,void 0,void 0],r[55]=n[0],r[56]=n[1],r[57]=n[2],r[58]=n[3],r[59]=n[4],r[60]=n[5],r[61]=n[6],r[62]=n[7],r[63]=n[8],r[64]=n[9],r[65]=n[10],r[66]=n[11],r[67]=n[12],r[68]=n[13],r[69]=n[14],r[70]=n[15],r[71]=n[16],r[72]=n[17]}]))})},function(e){var t;return t=[r[55],r[56],r[57],r[58],r[59],r[60],r[61],r[62],r[63],r[64],r[65],r[66],r[67],r[68],r[69],r[70],r[71],r[72]],r[7]=t[0],r[8]=t[1],r[9]=t[2],r[10]=t[3],r[11]=t[4],r[12]=t[5],r[13]=t[6],r[14]=t[7],r[15]=t[8],r[16]=t[9],r[17]=t[10],r[18]=t[11],r[19]=t[12],r[20]=t[13],r[21]=t[14],r[22]=t[15],r[23]=t[16],r[24]=t[17],t}])},function(o){var a;return t.i64.neq(r[7],void 0)?t.sequence([function(o){var a;return t.blobs.neq(r[18],void 0)?t.sequence([function(o){var a;return t.blobs.neq(r[17],void 0)?t.sequence([function(o){var a;return t.blobs.neq(r[19],void 0)?t.sequence([function(o){var a;return t.blobs.neq(r[15],void 0)?t.sequence([function(o){var a;return t.blobs.neq(r[10],void 0)?t.sequence([function(o){var a;return t.blobs.neq(r[9],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[18],t.blob("MA=="),r[19]).then(function(e){var t;return t=e,r[45]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[18],t.blob("MQ=="),r[15]).then(function(e){var t;return t=e,r[46]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),t.i64.to_string(r[7])).then(function(e){var t;return t=e,r[47]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWFpbGJveF9pZF9zY29wZQ=="),r[47]).then(function(e){var t;return t=e,r[48]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[10],r[48]).then(function(e){var t;return t=e,r[49]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[49]).then(function(e){var t;return t=e,r[50]=t[0],t})},function(n){var o;return r[51]=new t.Map,r[51].set("optimistic_backup_id",r[7]),r[51].set("device_private_key",r[18]),r[51].set("device_public_key",r[17]),r[51].set("epoch_storage_public_key",r[19]),r[51].set("epoch_storage_public_key_sig",r[45]==null?t.blob("bnVsbA=="):r[45]),r[51].set("epoch_auth_public_key",r[15]),r[51].set("epoch_auth_public_key_sig",r[46]==null?t.blob("bnVsbA=="):r[46]),r[51].set("ocmf_client_state",r[10]),r[51].set("mailbox_partial_id",r[50]==null?"":r[50]),r[51].set("mailbox_root_key",r[9]),r[51].set("device_registration_id",e[0]),r[51].set("orf_client_state_v2",void 0),o=[r[51],void 0],r[43]=o[0],r[44]=o[1]}]):t.resolve((r[45]=new t.Map,r[45].set("error_code",t.i64.cast([0,9])),r[45].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[45].set("error_message",""),a=[void 0,r[45]],r[43]=a[0],r[44]=a[1]))},function(e){var t;return t=[r[43],r[44]],r[41]=t[0],r[42]=t[1],t}]):t.resolve((r[43]=new t.Map,r[43].set("error_code",t.i64.cast([0,9])),r[43].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[43].set("error_message",""),a=[void 0,r[43]],r[41]=a[0],r[42]=a[1]))},function(e){var t;return t=[r[41],r[42]],r[39]=t[0],r[40]=t[1],t}]):t.resolve((r[41]=new t.Map,r[41].set("error_code",t.i64.cast([0,9])),r[41].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[41].set("error_message",""),a=[void 0,r[41]],r[39]=a[0],r[40]=a[1]))},function(e){var t;return t=[r[39],r[40]],r[37]=t[0],r[38]=t[1],t}]):t.resolve((r[39]=new t.Map,r[39].set("error_code",t.i64.cast([0,9])),r[39].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[39].set("error_message",""),a=[void 0,r[39]],r[37]=a[0],r[38]=a[1]))},function(e){var t;return t=[r[37],r[38]],r[35]=t[0],r[36]=t[1],t}]):t.resolve((r[37]=new t.Map,r[37].set("error_code",t.i64.cast([0,9])),r[37].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[37].set("error_message",""),a=[void 0,r[37]],r[35]=a[0],r[36]=a[1]))},function(e){var t;return t=[r[35],r[36]],r[33]=t[0],r[34]=t[1],t}]):t.resolve((r[35]=new t.Map,r[35].set("error_code",t.i64.cast([0,9])),r[35].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[35].set("error_message",""),a=[void 0,r[35]],r[33]=a[0],r[34]=a[1]))},function(e){var t;return t=[r[33],r[34]],r[25]=t[0],r[26]=t[1],t}]):t.resolve((r[33]=new t.Map,r[33].set("error_code",t.i64.cast([0,9])),r[33].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),r[33].set("error_message",""),a=[void 0,r[33]],r[25]=a[0],r[26]=a[1]))},function(e){return r[27]=t.i64.of_float(Date.now()),r[28]=t.i64.random(),r[30]="Finishing execution. Execution time: ",r[31]=t.i64.to_string(t.i64.sub(r[27],r[0])),r[32]=" ms",r[29]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][generateInitialDeviceSetupPayload] ",r[29],r[30],r[29],r[31],r[29],r[32]].join("")),t.i64.eq(t.i64.mod_(r[28],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[33]=",",r[34]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"generateInitialDeviceSetupPayload",[r[30],r[33],r[31],r[33],r[32]].join(""),r[34],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[25],r[26]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"],a.exports=e}),null);
__d("LSCreateSymmetricEncryptionSecretKey.nop",["CryptoLogger","LSResult","Promise","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(a,i){return(e||(e=n("Promise"))).resolve(r("LSResult")(o("XPlatReactCrypto").getRandomValues(new Uint8Array(32)).buffer)).catch(function(e){throw o("CryptoLogger").captureError(o("CryptoLogger").CryptoLogger("create_symmetric_encryption_secret_key"),e).mustfix("Creation of symmetric encryption secret key failed"),e})};s.__nop_name__="LSCreateSymmetricEncryptionSecretKey",l.default=s}),98);
__d("LSGetNextEpochAnonId.nop",["CryptoLogger","LSCryptoUtils","LSResult","Promise","XPlatReactTextDecoder"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(a,i,l){var t=o("LSCryptoUtils").strToBuf("0"),s;if(l!=null){var u=l;if(u.byteLength===0)s=t;else{var c=new(o("XPlatReactTextDecoder")).TextDecoder,d=c.decode(u),m=Number.parseInt(d,10),p=m+1;s=o("LSCryptoUtils").strToBuf(String(p))}}else s=t;return(e||(e=n("Promise"))).resolve(r("LSResult")(s)).catch(function(e){throw o("CryptoLogger").captureError(o("CryptoLogger").CryptoLogger("get_next_epoch_anonid"),e).mustfix("Getting next epoch anon id failed"),e})};s.__nop_name__="LSGetNextEpochAnonId",l.default=s}),98);
__d("LSStoreEpoch",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(r){return n[1]="Storing newly derived epoch ",n[2]=t.blobs.to_string(e[2]),n[3]=" authority_level:",n[4]=t.i64.to_string(e[5]),n[5]=" status:",n[6]=t.i64.to_string(e[4]),n[0]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsStoreEpochStoredProcedure] ",n[0],n[1],n[0],n[2],n[0],n[3],n[0],n[4],n[0],n[5],n[0],n[6]].join("")),t.resolve()},function(n){return(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsStoreEpochStoredProcedure] Storing epoch in epochs table (regular execution)"),t.filter(t.db.table(169).fetch([[[e[0]]]]),function(n){return t.i64.eq(n.epochId,e[0])&&t.i64.gt(n.authorityLevel,e[5])}).next().then(function(n){var r=n.done,o=n.value;return r?t.db.table(169).put({epochId:e[0],backupId:e[1],epochAnonIdBlob:e[2],epochRootKeyBlob:e[3],epochStatus:e[4],epochHead:e[7],authorityLevel:e[5]}):0})}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSEncryptedBackupsStoreEpochStoredProcedure",e.__tables__=["secure_encrypted_backups_epochs"],a.exports=e}),null);
__d("LSGenerateInitialEpochSetupPayload",["LSCreateMinosEpochParams.nop","LSCreateSymmetricEncryptionSecretKey.nop","LSGetNextEpochAnonId.nop","LSLogMebClientEvent.nop","LSStoreEpoch","gkx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(i){return t.sequence([function(a){return o[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][generateInitialEpochSetupPayload] Beginning execution."),o[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(169).fetch(),function(e){return t.i64.eq(e.epochStatus,t.i64.cast([0,1]))&&t.i64.eq(e.authorityLevel,t.i64.cast([0,20]))}).next().then(function(a,i){var l,s=a.done,u=a.value;return s?t.sequence([function(e){return(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure] Generating new initial epoch."),t.nativeOperation(n("LSGetNextEpochAnonId.nop"),void 0).then(function(e){var t;return t=e,o[16]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateSymmetricEncryptionSecretKey.nop")).then(function(e){var t;return t=e,o[17]=t[0],t})},function(e){return r("gkx")("11690")&&r("gkx")("16269")?t.sequence([function(e){return t.nativeOperation(n("LSCreateMinosEpochParams.nop"),o[17],o[16],void 0,void 0,void 0).then(function(e){var t;return t=e,o[20]=t[0],o[21]=t[1],o[22]=t[2],o[23]=t[3],o[24]=t[4],o[25]=t[5],t})},function(e){return o[18]=o[23]}]):t.resolve(o[18]=void 0)},function(r){return o[19]=t.i64.random(),t.storedProcedure(n("LSStoreEpoch"),o[19],e[0],o[16],o[17],t.i64.cast([0,1]),t.i64.cast([0,20]),!1,o[18])},function(e){var t;return t=[o[19],o[16],o[17],void 0,void 0,o[18]],o[2]=t[0],o[3]=t[1],o[4]=t[2],o[5]=t[3],o[6]=t[4],o[7]=t[5],t}]):(i=u.item,(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure] Using local optimistic initial epoch."),l=[i.epochId,i.epochAnonIdBlob,i.epochRootKeyBlob,void 0,void 0,i.epochHead],o[2]=l[0],o[3]=l[1],o[4]=l[2],o[5]=l[3],o[6]=l[4],o[7]=l[5])})},function(e){return o[9]=new t.Map,o[9].set("optimistic_epoch_id",o[2]),o[9].set("epoch_anon_id",o[3]),o[9].set("epoch_root_key",o[4]),o[10]=t.i64.of_float(Date.now()),o[11]=t.i64.random(),o[13]="Finishing execution. Execution time: ",o[14]=t.i64.to_string(t.i64.sub(o[10],o[0])),o[15]=" ms",o[12]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][generateInitialEpochSetupPayload] ",o[12],o[13],o[12],o[14],o[12],o[15]].join("")),t.i64.eq(t.i64.mod_(o[11],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(o[16]=",",o[17]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"generateInitialEpochSetupPayload",[o[13],o[16],o[14],o[16],o[15]].join(""),o[17],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[o[9],void 0],a[0]=t[0],a[1]=t[1],t}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure",e.__tables__=["secure_encrypted_backups_epochs"];var s=e;l.default=s}),98);
__d("LSGetOpenEpochKeys",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSDeleteBackupOnClient","LSIsMobileClient","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Beginning execution."),r[11]="Querying latest epoch keys with authority level: ",e[0]?r[1]="OPTIMISTIC":r[1]="AUTHORITATIVE",r[2]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",r[2],r[11],r[2],r[1]].join("")),t.resolve()},function(o){return e[0]?r[3]="OPTIMISTIC":r[3]="AUTHORITATIVE",t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[16]=t[0],t})},function(e){return r[16]?r[17]=!0:r[17]=!1,r[17]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[19]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[19]].join("")),r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[19],r[18],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[16]=t[0],t})},function(e){return r[16]?r[17]=!0:r[17]=!1,r[17]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[19]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[19]].join("")),r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[19],r[18],t.i64.cast([0,3]))):t.resolve()}])},function(n){return r[4]=t.createArray(),t.forEach(t.filter(t.db.table(169).fetch(),function(n){return e[0]||t.i64.eq(n.authorityLevel,t.i64.cast([0,80]))}),function(e){var n=e.item;return r[16]=(r[4].push(t.blobs.to_string(n.epochAnonIdBlob)),r[4])})},function(e){return r[5]=t.i64.of_int32(r[4].length),t.i64.gt(r[5],t.i64.cast([0,0]))?t.sequence([function(e){return r[16]=t.i64.of_int32(r[4].length),t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[21]=t[0],t})},function(e){return r[21]?r[22]=!0:r[22]=!1,r[22]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[24]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[24]].join("")),r[23]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[24],r[23],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[4],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[17]=t[0],r[18]=t[1],t})},function(e){return r[19]=r[17],r[20]=t.i64.of_int32(r[4].length),t.i64.gt(r[20],t.i64.cast([0,0]))?t.loopAsync(r[20],function(e){return r[21]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[4],r[21]).then(function(e){var t;return t=e,r[22]=t[0],r[23]=t[1],t})},function(e){return t.i64.eq([0,r[19].length],[0,r[22].length])?(r[19]===r[22]?r[25]=r[19]:(r[19]>r[22]?r[26]=r[19]:r[26]=r[22],r[25]=r[26]),r[24]=r[25]):(t.i64.gt([0,r[19].length],[0,r[22].length])?r[25]=r[19]:r[25]=r[22],r[24]=r[25]),r[19]=r[24]}])}):t.resolve()},function(e){return r[6]=r[19]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Epoch anon ID list is empty."),r[17]="Epoch anon ID list is empty.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",r[17]].join("")),r[16]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",r[17],r[16],t.i64.cast([0,3]))},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){return r[18]?r[19]=!0:r[19]=!1,r[19]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[21]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[21]].join("")),r[20]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[21],r[20],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[6]=void 0}])},function(e){return r[6]!==void 0?t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[16]=t[0],t})},function(e){return r[16]?r[17]=!0:r[17]=!1,r[17]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[19]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[19]].join("")),r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[19],r[18],t.i64.cast([0,3]))):t.resolve()}]):t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[16]=t[0],t})},function(e){return r[16]?r[17]=!0:r[17]=!1,r[17]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[19]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[19]].join("")),r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[19],r[18],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[12]=t.blobs.of_string(r[6]),t.blobs.neq(r[12],void 0)?t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){return r[18]?r[19]=!0:r[19]=!1,r[19]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[21]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[21]].join("")),r[20]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[21],r[20],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.filter(t.db.table(169).fetch(),function(e){return t.blobs.eq(e.epochAnonIdBlob,r[12])}).next().then(function(e,o){var a=e.done,i=e.value;return a?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Found a most recent epoch anon ID, but unable to locate it again in the table. This can really only happen if the tablesomehow changed in the middle of our transaction."),r[19]="Found a most recent epoch anon ID, but unable to locate it again in the table. This can really only happen if the tablesomehow changed in the middle of our transaction.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",r[19]].join("")),r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",r[19],r[18],t.i64.cast([0,3]))},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[20]=t[0],t})},function(e){return r[20]?r[21]=!0:r[21]=!1,r[21]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[23]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[23]].join("")),r[22]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[23],r[22],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[16]=void 0}]):(o=i.item,t.sequence([function(e){return r[22]=o.epochAnonIdBlob,r[20]="Using latest epoch: ",r[21]=t.blobs.to_string(r[22]),r[18]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",r[18],r[20],r[18],r[21]].join("")),t.resolve()},function(e){return r[19]=new t.Map,r[19].set("epoch_id",o.epochId),r[19].set("epoch_root_key",o.epochRootKeyBlob),r[19].set("epoch_anon_id",r[22]),r[16]=r[19]}]))})},function(e){return r[7]=r[16]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] No epochs whatsoever on client! This should absolutely never happen. Deleting backup from client."),r[17]="No epochs whatsoever on client! This should absolutely never happen. Deleting backup from client.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",r[17]].join("")),r[16]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",r[17],r[16],t.i64.cast([0,3]))},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){return r[18]?r[19]=!0:r[19]=!1,r[19]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[21]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[21]].join("")),r[20]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[21],r[20],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.storedProcedure(n("LSDeleteBackupOnClient"),void 0,"get_open_epoch_keys",!0,void 0,"Attempted to fetch epoch keys when there are no epochs on the client.",!1)},function(e){return r[7]=void 0}])},function(e){return r[8]=t.i64.of_float(Date.now()),r[9]=t.i64.random(),r[13]="Finishing execution. Execution time: ",r[14]=t.i64.to_string(t.i64.sub(r[8],r[0])),r[15]=" ms",r[10]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",r[10],r[13],r[10],r[14],r[10],r[15]].join("")),t.i64.eq(t.i64.mod_(r[9],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[16]=",",r[17]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",[r[13],r[16],r[14],r[16],r[15]].join(""),r[17],t.i64.cast([0,4]))):t.resolve()},function(e){return o[0]=r[7]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",e.__tables__=["secure_encrypted_backups_epochs"],a.exports=e}),null);
__d("LSHandleCreateVirtualDeviceFailure",["LSAppendDataTraceAddon","LSDeleteBackupOnClient","LSFlushDataTrace.nop","LSIsMobileClient","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] Beginning execution."),t.sequence([function(r){return e[2]!==void 0?t.storedProcedure(n("LSAppendDataTraceAddon"),e[2],t.i64.cast([0,1412]),t.i64.cast([0,2]),void 0,void 0):t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[7]=t[0],t})},function(e){return r[7]?r[8]=!0:r[8]=!1,r[8]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[10]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[10]].join("")),r[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[10],r[9],t.i64.cast([0,3]))):t.resolve()}])},function(o){return e[1]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] Failure when creating virtual device, deleting backup"),r[8]="Failure when creating virtual device, deleting backup",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ","",r[8]].join("")),r[7]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",r[8],r[7],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSDeleteBackupOnClient"),e[0],void 0,!1,e[2],void 0,!1)}]):t.sequence([function(o){return r[7]="Failure when creating virtual device",r[7]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ","",r[7]].join("")),r[8]=t.createArray(),e[2]!==void 0&&(r[9]=(r[8].push(e[2]),r[8])),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",r[7],r[8],t.i64.cast([0,3]))):t.resolve()},function(e){return t.db.table(178).put({pk:t.i64.cast([0,1]),recoveryCodeStatus:t.i64.cast([0,3])})}])},function(o){return t.sequence([function(r){return e[2]!==void 0?t.nativeOperation(n("LSFlushDataTrace.nop"),e[2]):t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[7]=t[0],t})},function(e){return r[7]?r[8]=!0:r[8]=!1,r[8]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[10]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[10]].join("")),r[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[10],r[9],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[1]=t.i64.of_float(Date.now()),r[2]=t.i64.random(),r[4]="Finishing execution. Execution time: ",r[5]=t.i64.to_string(t.i64.sub(r[1],r[0])),r[6]=" ms",r[3]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ",r[3],r[4],r[3],r[5],r[3],r[6]].join("")),t.i64.eq(t.i64.mod_(r[2],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[7]=",",r[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",[r[4],r[7],r[5],r[7],r[6]].join(""),r[8],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",e.__tables__=["secure_encrypted_backups_recovery_code_status"],a.exports=e}),null);
__d("LSGenerateInitialVirtualDeviceSetupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSGetBlobFromString.nop","LSGetOpenEpochKeys","LSGetViewerFBID","LSHandleCreateVirtualDeviceFailure","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSParseRecoveryCode_v2.nop","LSSymmetricEncryptionCreateEncryptedString.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][generateInitialVirtualDeviceSetupPayload] Beginning execution."),r[1]=t.i64.of_float(Date.now()),e[1]!==void 0?t.sequence([function(o){return r[10]=e[1].get("recovery_code"),r[11]=e[1].get("virtual_device_type"),r[12]=e[1].get("cloud_service_account"),r[13]=e[1].get("hsm_pin_normalization_status"),r[14]=e[1].get("security_question_type"),r[15]=e[1].get("trusted_contact_id"),r[16]=t.createArray(),t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,r[17]=t[0],t})},function(e){return t.nativeOperation(n("LSParseRecoveryCode_v2.nop"),r[10],t.i64.to_string(r[17]),r[16]).then(function(e){var t;return t=e,r[18]=t[0],r[19]=t[1],t})},function(o){return t.blobs.neq(r[19],void 0)?t.sequence([function(o){return t.blobs.neq(r[18],void 0)?t.sequence([function(e){return t.storedProcedure(n("LSGetOpenEpochKeys"),!0).then(function(e){var t;return t=e,r[24]=t[0],t})},function(o){return r[24]!==void 0?t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!0}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[34]=new t.Map,r[34].set("error_msg","Expected a nonempty query result"),r[34].set("code",t.i64.cast([0,3])),r[34].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[35]=t.createArray(),r[36]=(r[35].push(r[34]),r[35]),o=[void 0,r[35]],r[27]=o[0],r[28]=o[1]):(n=l.item,r[34]=new t.Map,r[34].set("backup_id",n.backupId),r[34].set("device_public_key_blob",n.devicePublicKeyBlob),r[34].set("device_private_key_blob",n.devicePrivateKeyBlob),r[34].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[34].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[34].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[34].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[34].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[34].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[34].set("orf_client_state_v2_blob",void 0),r[34].set("orf_v2_authority_level",void 0),r[34].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[34].set("device_id",n.deviceId),r[34].set("backup_tenancy",n.backupTenancy),r[34].set("encryption_version",n.encryptionVersion),r[34].set("revision_version",n.revisionVersion),r[34].set("initialize_restore_result",void 0),r[34].set("device_creation_timestamp_sec",void 0),r[34].set("authority_level",n.authorityLevel),a=[r[34],void 0],r[27]=a[0],r[28]=a[1])})},function(e){var o;return r[30]=new t.Map,r[30].set("value",r[27]),r[30].set("errors",r[28]),r[31]=r[30].get("value"),r[31]!==void 0?t.sequence([function(e){var o;return r[34]=r[31].get("backup_id"),r[35]=r[31].get("device_public_key_blob"),r[36]=r[31].get("device_private_key_blob"),r[37]=r[31].get("epoch_storage_public_key_blob"),r[38]=r[31].get("epoch_storage_private_key_blob"),r[39]=r[31].get("epoch_auth_public_key_blob"),r[40]=r[31].get("epoch_auth_private_key_blob"),r[41]=r[31].get("mailbox_root_key_blob"),r[42]=r[31].get("ocmf_client_state_blob"),r[43]=r[31].get("orf_client_state_v2_blob"),r[44]=r[31].get("orf_v2_authority_level"),r[45]=r[31].get("oblivious_validation_token_blob"),r[46]=r[31].get("device_id"),r[47]=r[31].get("backup_tenancy"),r[48]=r[31].get("encryption_version"),r[49]=r[31].get("revision_version"),r[50]=r[31].get("initialize_restore_result"),r[51]=r[31].get("device_creation_timestamp_sec"),r[52]=r[31].get("authority_level"),t.i64.neq(r[46],void 0)?t.sequence([function(e){return r[55]=void 0,t.i64.neq(r[55],void 0)?t.resolve(r[56]=r[55]):t.sequence([function(e){return r[107]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[108]=t[0],t})},function(e){return r[108]&&(r[117]=(r[107].push(t.i64.cast([0,0])),r[107])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[109]=t[0],t})},function(e){return r[109]&&(r[117]=(r[107].push(t.i64.cast([0,2])),r[107])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[110]=t[0],t})},function(e){return r[110]&&(r[117]=(r[107].push(t.i64.cast([0,3])),r[107])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[111]=t[0],t})},function(e){return r[111]&&(r[117]=(r[107].push(t.i64.cast([0,4])),r[107])),r[112]=t.createArray(),r[113]=t.i64.of_int32(r[107].length),t.i64.gt(r[113],t.i64.cast([0,0]))?t.loopAsync(r[113],function(e){return r[117]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[107],r[117]).then(function(e){var t;return t=e,r[118]=t[0],r[119]=t[1],t})},function(e){return r[120]=(r[112].push(r[118]),r[112])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[117]=t.createArray(),r[118]=t.i64.of_int32(r[112].length),t.i64.gt(r[118],t.i64.cast([0,0]))?t.loopAsync(r[118],function(e){return r[120]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[112],r[120]).then(function(e){var t;return t=e,r[121]=t[0],r[122]=t[1],t})},function(e){return r[123]=(r[117].push(t.i64.to_string(r[121])),r[117])}])}):t.resolve()},function(e){return r[119]=r[117].join(","),r[114]=r[119]}])},function(e){return r[112].some(function(e){return t.i64.eq(r[48],e)})?r[115]=r[48]:r[115]=void 0,t.i64.neq(r[115],void 0)?r[116]=r[115]:r[116]=void 0,r[56]=r[116]}])},function(e){return t.i64.neq(r[56],void 0)?r[57]=r[56]:r[57]=t.i64.cast([0,0]),t.i64.neq(r[47],void 0)?r[58]=r[47]:r[58]=t.i64.cast([0,1]),t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,r[59]=t[0],r[60]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,r[61]=t[0],r[62]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[59],t.blob("MA=="),r[62]).then(function(e){var t;return t=e,r[63]=t[0],t})},function(e){return r[64]=r[24].get("epoch_anon_id"),r[65]=r[24].get("epoch_root_key"),r[66]=t.createArray(),r[107]=(r[66].push(t.i64.cast([0,32])),r[66]),t.nativeOperation(n("LSBase64Encode.nop"),r[64]).then(function(e){var t;return t=e,r[67]=t[0],t})},function(e){return r[67]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_devices","_",r[67]].join("")),void 0,r[65],r[66]).then(function(e){var t;return t=e,r[107]=t[0],t})},function(e){return r[107]?r[108]=!1:r[108]=!0,r[108]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),r[111]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",r[111]].join("")),r[110]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",r[111],r[110],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[112]=t[0],t})},function(e){return r[109]=r[112]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[107],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[110]=t[0],r[111]=t[1],t})},function(e){return r[109]=r[110]}])},function(e){return r[68]=r[109]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),r[108]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",r[108],r[107],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[109]=t[0],t})},function(e){return r[68]=r[109]}])},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),r[68],r[60]).then(function(e){var t;return t=e,r[69]=t[0],t})},function(e){return t.blobs.neq(r[69],void 0)?t.resolve(r[70]=r[69]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] device_epoch_hmac is null!"),r[108]="device_epoch_hmac is null!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[109]=t[0],t})},function(e){return r[70]=r[109]}])},function(e){return r[71]=r[24].get("epoch_root_key"),r[72]=t.createArray(),r[107]=(r[72].push(t.i64.cast([0,18])),r[72]),t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,r[71],r[72]).then(function(e){var t;return t=e,r[73]=t[0],t})},function(e){return r[73]!==void 0?t.sequence([function(e){return r[107]=t.i64.of_int32(r[73].length),t.i64.ge(r[107],t.i64.cast([0,1]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[73],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[109]=t[0],r[110]=t[1],t})},function(e){return r[108]=r[109]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),r[110]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",r[110]].join("")),r[109]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",r[110],r[109],t.i64.cast([0,3]))},function(e){return r[108]=void 0}])},function(e){return r[74]=r[108]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),r[108]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",r[108],r[107],t.i64.cast([0,3]))},function(e){return r[74]=void 0}])},function(e){return t.blobs.neq(r[74],void 0)?r[75]=!0:r[75]=!1,r[75]||((function(e){t.logger(e).mustfix(e)})("LS::assert is failed. Attempting to coerce a null value to nonnull."),t.throw("LS::assert is failed. Attempting to coerce a null value to nonnull.")),t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),r[42]).then(function(e){var t;return t=e,r[76]=t[0],r[77]=t[1],t})},function(e){var o;return t.blobs.neq(void 0,void 0)?t.sequence([function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),void 0).then(function(e){var t;return t=e,r[107]=t[0],r[108]=t[1],t})},function(e){var t;return t=[r[76],r[77],r[107],r[108]],r[78]=t[0],r[79]=t[1],r[80]=t[2],r[81]=t[3],t}]):t.resolve((o=[r[76],r[77],void 0,void 0],r[78]=o[0],r[79]=o[1],r[80]=o[2],r[81]=o[3],o))},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[59]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),r[82]==null?"":r[82]).then(function(e){var t;return t=e,r[83]=t[0],t})},function(e){return r[83]!==void 0?r[84]=r[83]:r[84]="",r[84]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_device_private_key is empty!"),r[108]="encrypted_device_private_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[61]).then(function(e){var t;return t=e,r[85]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),r[85]==null?"":r[85]).then(function(e){var t;return t=e,r[86]=t[0],t})},function(e){return r[86]!==void 0?r[87]=r[86]:r[87]="",r[87]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_storage_private_key is empty!"),r[108]="encrypted_epoch_storage_private_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[78]).then(function(e){var t;return t=e,r[88]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),r[88]==null?"":r[88]).then(function(e){var t;return t=e,r[89]=t[0],t})},function(e){return r[89]!==void 0?r[90]=r[89]:r[90]="",r[90]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),r[108]="encrypted_orf_client_state_v1_shape is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[45]).then(function(e){var t;return t=e,r[91]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),r[91]==null?"":r[91]).then(function(e){var t;return t=e,r[92]=t[0],t})},function(e){return r[92]!==void 0?r[93]=r[92]:r[93]="",r[93]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_oblivious_validation_token is empty!"),r[108]="encrypted_oblivious_validation_token is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[41]).then(function(e){var t;return t=e,r[94]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),r[94]==null?"":r[94]).then(function(e){var t;return t=e,r[95]=t[0],t})},function(e){return r[95]!==void 0?r[96]=r[95]:r[96]="",r[96]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_mailbox_root_key is empty!"),r[108]="encrypted_mailbox_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){return r[97]=r[24].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Encode.nop"),r[97]).then(function(e){var t;return t=e,r[98]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),r[98]==null?"":r[98]).then(function(e){var t;return t=e,r[99]=t[0],t})},function(e){return r[99]!==void 0?r[100]=r[99]:r[100]="",r[100]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_anon_id is empty!"),r[108]="encrypted_epoch_anon_id is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){return r[101]=r[24].get("epoch_root_key"),t.nativeOperation(n("LSBase64Encode.nop"),r[101]).then(function(e){var t;return t=e,r[102]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[19],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),r[102]==null?"":r[102]).then(function(e){var t;return t=e,r[103]=t[0],t})},function(e){return r[103]!==void 0?r[104]=r[103]:r[104]="",r[104]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_root_key is empty!"),r[108]="encrypted_epoch_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[108],r[107],t.i64.cast([0,3]))):t.resolve()},function(e){var n;return r[105]=new t.Map,r[105].set("encrypted_device_private_key",r[84]),r[105].set("encrypted_epoch_storage_private_key",r[87]),r[105].set("encrypted_ocmf_client_state",r[90]),r[105].set("encrypted_orf_client_state_v2",void 0),r[105].set("encrypted_oblivious_validation_token_blob",r[93]),r[105].set("encrypted_mailbox_root_key_blob",r[96]),r[105].set("encrypted_epoch_anon_id",r[100]),r[105].set("encrypted_epoch_root_key",r[104]),r[106]=new t.Map,r[106].set("virtual_device_public_key",r[60]),r[106].set("virtual_device_id",r[18]),r[106].set("virtual_device_epoch_storage_public_key",r[62]),r[106].set("virtual_device_epoch_storage_public_key_sig",r[63]==null?t.blob("bnVsbA=="):r[63]),r[106].set("device_epoch_hmac",r[70]),r[106].set("epoch_root_key_fingerprint",r[74]),r[106].set("virtual_device_type",r[11]),r[106].set("action_type",t.i64.cast([0,1])),r[106].set("ocmf_rotation_token",r[79]),r[106].set("encrypted_secret_values_payload",r[105]),r[106].set("cloud_service_account",r[12]),r[106].set("hsm_pin_normalization_status",r[13]),r[106].set("security_question_type",r[14]),r[106].set("trusted_contact_id",r[15]),n=[r[106],void 0],r[53]=n[0],r[54]=n[1]}]):t.resolve((r[55]=new t.Map,r[55].set("error_code",t.i64.cast([0,9])),r[55].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[55].set("error_message",""),o=[void 0,r[55]],r[53]=o[0],r[54]=o[1]))},function(e){var t;return t=[r[53],r[54]],r[32]=t[0],r[33]=t[1],t}]):t.resolve((r[34]=r[30].get("errors"),r[35]=r[30].get("errors"),r[36]=new t.Map,r[36].set("error_code",t.i64.cast([0,9])),r[36].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[36].set("error_message",""),o=[void 0,r[36]],r[32]=o[0],r[33]=o[1]))},function(e){var t;return t=[r[32],r[33]],r[25]=t[0],r[26]=t[1],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Epoch keys are unavailable."),r[28]="Epoch keys are unavailable.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[28]].join("")),r[27]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[28],r[27],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[29]=new t.Map,r[29].set("error_code",t.i64.cast([0,11])),r[29].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[29].set("error_message",""),n=[void 0,r[29]],r[25]=n[0],r[26]=n[1]}])},function(e){var t;return t=[r[25],r[26]],r[22]=t[0],r[23]=t[1],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),r[25]="Invalid Recovery Code Provided",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[25]].join("")),r[24]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[25],r[24],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[26]=new t.Map,r[26].set("error_code",t.i64.cast([0,10])),r[26].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[26].set("error_message",""),n=[void 0,r[26]],r[22]=n[0],r[23]=n[1]}])},function(e){var t;return t=[r[22],r[23]],r[20]=t[0],r[21]=t[1],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),r[23]="Invalid Recovery Code Provided",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[23]].join("")),r[22]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[23],r[22],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[24]=new t.Map,r[24].set("error_code",t.i64.cast([0,10])),r[24].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[24].set("error_message",""),n=[void 0,r[24]],r[20]=n[0],r[21]=n[1]}])},function(e){var t;return t=[r[20],r[21]],r[2]=t[0],r[3]=t[1],t}]):t.sequence([function(o){return t.db.table(174).fetch([[[t.i64.cast([0,1])]]]).next().then(function(o,a){var i=o.done,l=o.value;return i?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] No recovery code found in recovery code table"),r[14]="No recovery code found in recovery code table",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[14]].join("")),r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[14],r[13],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[15]=new t.Map,r[15].set("error_code",t.i64.cast([0,501])),r[15].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[15].set("error_message",""),n=[void 0,r[15]],r[10]=n[0],r[11]=n[1]}]):(a=l.item,t.sequence([function(e){return r[13]=t.createArray(),t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,r[14]=t[0],t})},function(e){return t.nativeOperation(n("LSParseRecoveryCode_v2.nop"),a.recoveryCode,t.i64.to_string(r[14]),r[13]).then(function(e){var t;return t=e,r[15]=t[0],r[16]=t[1],t})},function(o){return t.blobs.neq(r[16],void 0)?t.sequence([function(o){return t.blobs.neq(r[15],void 0)?t.sequence([function(e){return t.storedProcedure(n("LSGetOpenEpochKeys"),!0).then(function(e){var t;return t=e,r[21]=t[0],t})},function(o){return r[21]!==void 0?t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!0}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[31]=new t.Map,r[31].set("error_msg","Expected a nonempty query result"),r[31].set("code",t.i64.cast([0,3])),r[31].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[32]=t.createArray(),r[33]=(r[32].push(r[31]),r[32]),o=[void 0,r[32]],r[24]=o[0],r[25]=o[1]):(n=l.item,r[31]=new t.Map,r[31].set("backup_id",n.backupId),r[31].set("device_public_key_blob",n.devicePublicKeyBlob),r[31].set("device_private_key_blob",n.devicePrivateKeyBlob),r[31].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[31].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[31].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[31].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[31].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[31].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[31].set("orf_client_state_v2_blob",void 0),r[31].set("orf_v2_authority_level",void 0),r[31].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[31].set("device_id",n.deviceId),r[31].set("backup_tenancy",n.backupTenancy),r[31].set("encryption_version",n.encryptionVersion),r[31].set("revision_version",n.revisionVersion),r[31].set("initialize_restore_result",void 0),r[31].set("device_creation_timestamp_sec",void 0),r[31].set("authority_level",n.authorityLevel),a=[r[31],void 0],r[24]=a[0],r[25]=a[1])})},function(e){var o;return r[27]=new t.Map,r[27].set("value",r[24]),r[27].set("errors",r[25]),r[28]=r[27].get("value"),r[28]!==void 0?t.sequence([function(e){var o;return r[31]=r[28].get("backup_id"),r[32]=r[28].get("device_public_key_blob"),r[33]=r[28].get("device_private_key_blob"),r[34]=r[28].get("epoch_storage_public_key_blob"),r[35]=r[28].get("epoch_storage_private_key_blob"),r[36]=r[28].get("epoch_auth_public_key_blob"),r[37]=r[28].get("epoch_auth_private_key_blob"),r[38]=r[28].get("mailbox_root_key_blob"),r[39]=r[28].get("ocmf_client_state_blob"),r[40]=r[28].get("orf_client_state_v2_blob"),r[41]=r[28].get("orf_v2_authority_level"),r[42]=r[28].get("oblivious_validation_token_blob"),r[43]=r[28].get("device_id"),r[44]=r[28].get("backup_tenancy"),r[45]=r[28].get("encryption_version"),r[46]=r[28].get("revision_version"),r[47]=r[28].get("initialize_restore_result"),r[48]=r[28].get("device_creation_timestamp_sec"),r[49]=r[28].get("authority_level"),t.i64.neq(r[43],void 0)?t.sequence([function(e){return r[52]=void 0,t.i64.neq(r[52],void 0)?t.resolve(r[53]=r[52]):t.sequence([function(e){return r[104]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[105]=t[0],t})},function(e){return r[105]&&(r[114]=(r[104].push(t.i64.cast([0,0])),r[104])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[106]=t[0],t})},function(e){return r[106]&&(r[114]=(r[104].push(t.i64.cast([0,2])),r[104])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[107]=t[0],t})},function(e){return r[107]&&(r[114]=(r[104].push(t.i64.cast([0,3])),r[104])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[108]=t[0],t})},function(e){return r[108]&&(r[114]=(r[104].push(t.i64.cast([0,4])),r[104])),r[109]=t.createArray(),r[110]=t.i64.of_int32(r[104].length),t.i64.gt(r[110],t.i64.cast([0,0]))?t.loopAsync(r[110],function(e){return r[114]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[104],r[114]).then(function(e){var t;return t=e,r[115]=t[0],r[116]=t[1],t})},function(e){return r[117]=(r[109].push(r[115]),r[109])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[114]=t.createArray(),r[115]=t.i64.of_int32(r[109].length),t.i64.gt(r[115],t.i64.cast([0,0]))?t.loopAsync(r[115],function(e){return r[117]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[109],r[117]).then(function(e){var t;return t=e,r[118]=t[0],r[119]=t[1],t})},function(e){return r[120]=(r[114].push(t.i64.to_string(r[118])),r[114])}])}):t.resolve()},function(e){return r[116]=r[114].join(","),r[111]=r[116]}])},function(e){return r[109].some(function(e){return t.i64.eq(r[45],e)})?r[112]=r[45]:r[112]=void 0,t.i64.neq(r[112],void 0)?r[113]=r[112]:r[113]=void 0,r[53]=r[113]}])},function(e){return t.i64.neq(r[53],void 0)?r[54]=r[53]:r[54]=t.i64.cast([0,0]),t.i64.neq(r[44],void 0)?r[55]=r[44]:r[55]=t.i64.cast([0,1]),t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,r[56]=t[0],r[57]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,r[58]=t[0],r[59]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[56],t.blob("MA=="),r[59]).then(function(e){var t;return t=e,r[60]=t[0],t})},function(e){return r[61]=r[21].get("epoch_anon_id"),r[62]=r[21].get("epoch_root_key"),r[63]=t.createArray(),r[104]=(r[63].push(t.i64.cast([0,32])),r[63]),t.nativeOperation(n("LSBase64Encode.nop"),r[61]).then(function(e){var t;return t=e,r[64]=t[0],t})},function(e){return r[64]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_devices","_",r[64]].join("")),void 0,r[62],r[63]).then(function(e){var t;return t=e,r[104]=t[0],t})},function(e){return r[104]?r[105]=!1:r[105]=!0,r[105]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),r[108]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",r[108]].join("")),r[107]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",r[108],r[107],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[109]=t[0],t})},function(e){return r[106]=r[109]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[104],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[107]=t[0],r[108]=t[1],t})},function(e){return r[106]=r[107]}])},function(e){return r[65]=r[106]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),r[105]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",r[105],r[104],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[106]=t[0],t})},function(e){return r[65]=r[106]}])},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),r[65],r[57]).then(function(e){var t;return t=e,r[66]=t[0],t})},function(e){return t.blobs.neq(r[66],void 0)?t.resolve(r[67]=r[66]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] device_epoch_hmac is null!"),r[105]="device_epoch_hmac is null!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[106]=t[0],t})},function(e){return r[67]=r[106]}])},function(e){return r[68]=r[21].get("epoch_root_key"),r[69]=t.createArray(),r[104]=(r[69].push(t.i64.cast([0,18])),r[69]),t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,r[68],r[69]).then(function(e){var t;return t=e,r[70]=t[0],t})},function(e){return r[70]!==void 0?t.sequence([function(e){return r[104]=t.i64.of_int32(r[70].length),t.i64.ge(r[104],t.i64.cast([0,1]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[70],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[106]=t[0],r[107]=t[1],t})},function(e){return r[105]=r[106]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),r[107]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",r[107]].join("")),r[106]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",r[107],r[106],t.i64.cast([0,3]))},function(e){return r[105]=void 0}])},function(e){return r[71]=r[105]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),r[105]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",r[105],r[104],t.i64.cast([0,3]))},function(e){return r[71]=void 0}])},function(e){return t.blobs.neq(r[71],void 0)?r[72]=!0:r[72]=!1,r[72]||((function(e){t.logger(e).mustfix(e)})("LS::assert is failed. Attempting to coerce a null value to nonnull."),t.throw("LS::assert is failed. Attempting to coerce a null value to nonnull.")),t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),r[39]).then(function(e){var t;return t=e,r[73]=t[0],r[74]=t[1],t})},function(e){var o;return t.blobs.neq(void 0,void 0)?t.sequence([function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),void 0).then(function(e){var t;return t=e,r[104]=t[0],r[105]=t[1],t})},function(e){var t;return t=[r[73],r[74],r[104],r[105]],r[75]=t[0],r[76]=t[1],r[77]=t[2],r[78]=t[3],t}]):t.resolve((o=[r[73],r[74],void 0,void 0],r[75]=o[0],r[76]=o[1],r[77]=o[2],r[78]=o[3],o))},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[56]).then(function(e){var t;return t=e,r[79]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),r[79]==null?"":r[79]).then(function(e){var t;return t=e,r[80]=t[0],t})},function(e){return r[80]!==void 0?r[81]=r[80]:r[81]="",r[81]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_device_private_key is empty!"),r[105]="encrypted_device_private_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[58]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),r[82]==null?"":r[82]).then(function(e){var t;return t=e,r[83]=t[0],t})},function(e){return r[83]!==void 0?r[84]=r[83]:r[84]="",r[84]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_storage_private_key is empty!"),r[105]="encrypted_epoch_storage_private_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[75]).then(function(e){var t;return t=e,r[85]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),r[85]==null?"":r[85]).then(function(e){var t;return t=e,r[86]=t[0],t})},function(e){return r[86]!==void 0?r[87]=r[86]:r[87]="",r[87]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),r[105]="encrypted_orf_client_state_v1_shape is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[42]).then(function(e){var t;return t=e,r[88]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),r[88]==null?"":r[88]).then(function(e){var t;return t=e,r[89]=t[0],t})},function(e){return r[89]!==void 0?r[90]=r[89]:r[90]="",r[90]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_oblivious_validation_token is empty!"),r[105]="encrypted_oblivious_validation_token is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[38]).then(function(e){var t;return t=e,r[91]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),r[91]==null?"":r[91]).then(function(e){var t;return t=e,r[92]=t[0],t})},function(e){return r[92]!==void 0?r[93]=r[92]:r[93]="",r[93]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_mailbox_root_key is empty!"),r[105]="encrypted_mailbox_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){return r[94]=r[21].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Encode.nop"),r[94]).then(function(e){var t;return t=e,r[95]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),r[95]==null?"":r[95]).then(function(e){var t;return t=e,r[96]=t[0],t})},function(e){return r[96]!==void 0?r[97]=r[96]:r[97]="",r[97]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_anon_id is empty!"),r[105]="encrypted_epoch_anon_id is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){return r[98]=r[21].get("epoch_root_key"),t.nativeOperation(n("LSBase64Encode.nop"),r[98]).then(function(e){var t;return t=e,r[99]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),r[16],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),r[99]==null?"":r[99]).then(function(e){var t;return t=e,r[100]=t[0],t})},function(e){return r[100]!==void 0?r[101]=r[100]:r[101]="",r[101]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_root_key is empty!"),r[105]="encrypted_epoch_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[105]].join("")),r[104]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[105],r[104],t.i64.cast([0,3]))):t.resolve()},function(e){var n;return r[102]=new t.Map,r[102].set("encrypted_device_private_key",r[81]),r[102].set("encrypted_epoch_storage_private_key",r[84]),r[102].set("encrypted_ocmf_client_state",r[87]),r[102].set("encrypted_orf_client_state_v2",void 0),r[102].set("encrypted_oblivious_validation_token_blob",r[90]),r[102].set("encrypted_mailbox_root_key_blob",r[93]),r[102].set("encrypted_epoch_anon_id",r[97]),r[102].set("encrypted_epoch_root_key",r[101]),r[103]=new t.Map,r[103].set("virtual_device_public_key",r[57]),r[103].set("virtual_device_id",r[15]),r[103].set("virtual_device_epoch_storage_public_key",r[59]),r[103].set("virtual_device_epoch_storage_public_key_sig",r[60]==null?t.blob("bnVsbA=="):r[60]),r[103].set("device_epoch_hmac",r[67]),r[103].set("epoch_root_key_fingerprint",r[71]),r[103].set("virtual_device_type",a.virtualDeviceType),r[103].set("action_type",t.i64.cast([0,1])),r[103].set("ocmf_rotation_token",r[76]),r[103].set("encrypted_secret_values_payload",r[102]),r[103].set("cloud_service_account",a.cloudServiceAccount),r[103].set("hsm_pin_normalization_status",a.hsmPinNormalizationStatus),r[103].set("security_question_type",void 0),r[103].set("trusted_contact_id",void 0),n=[r[103],void 0],r[50]=n[0],r[51]=n[1]}]):t.resolve((r[52]=new t.Map,r[52].set("error_code",t.i64.cast([0,9])),r[52].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[52].set("error_message",""),o=[void 0,r[52]],r[50]=o[0],r[51]=o[1]))},function(e){var t;return t=[r[50],r[51]],r[29]=t[0],r[30]=t[1],t}]):t.resolve((r[31]=r[27].get("errors"),r[32]=r[27].get("errors"),r[33]=new t.Map,r[33].set("error_code",t.i64.cast([0,9])),r[33].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[33].set("error_message",""),o=[void 0,r[33]],r[29]=o[0],r[30]=o[1]))},function(e){var t;return t=[r[29],r[30]],r[22]=t[0],r[23]=t[1],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Epoch keys are unavailable."),r[25]="Epoch keys are unavailable.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[25]].join("")),r[24]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[25],r[24],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[26]=new t.Map,r[26].set("error_code",t.i64.cast([0,11])),r[26].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[26].set("error_message",""),n=[void 0,r[26]],r[22]=n[0],r[23]=n[1]}])},function(e){var t;return t=[r[22],r[23]],r[19]=t[0],r[20]=t[1],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),r[22]="Invalid Recovery Code Provided",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[22]].join("")),r[21]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[22],r[21],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[23]=new t.Map,r[23].set("error_code",t.i64.cast([0,10])),r[23].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[23].set("error_message",""),n=[void 0,r[23]],r[19]=n[0],r[20]=n[1]}])},function(e){var t;return t=[r[19],r[20]],r[17]=t[0],r[18]=t[1],t}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),r[20]="Invalid Recovery Code Provided",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",r[20]].join("")),r[19]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",r[20],r[19],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[0],!0,void 0)},function(e){var n;return r[21]=new t.Map,r[21].set("error_code",t.i64.cast([0,10])),r[21].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),r[21].set("error_message",""),n=[void 0,r[21]],r[17]=n[0],r[18]=n[1]}])},function(e){var t;return t=[r[17],r[18]],r[10]=t[0],r[11]=t[1],t}]))})},function(e){var t;return t=[r[10],r[11]],r[2]=t[0],r[3]=t[1],t}])},function(e){return r[4]=t.i64.of_float(Date.now()),r[5]=t.i64.random(),r[7]="Finishing execution. Execution time: ",r[8]=t.i64.to_string(t.i64.sub(r[4],r[0])),r[9]=" ms",r[6]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][generateInitialVirtualDeviceSetupPayload] ",r[6],r[7],r[6],r[8],r[6],r[9]].join("")),t.i64.eq(t.i64.mod_(r[5],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[10]=",",r[11]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"generateInitialVirtualDeviceSetupPayload",[r[7],r[10],r[8],r[10],r[9]].join(""),r[11],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[2],r[3]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_generated_recovery_code"],a.exports=e}),null);
__d("LSInitializeBackupV2",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSCreateMinosEpochParams.nop","LSCreateSignature_v2.nop","LSGenerateInitialDeviceSetupPayload","LSGenerateInitialEpochSetupPayload","LSGenerateInitialVirtualDeviceSetupPayload","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","gkx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(i){return t.sequence([function(r){return o[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][initializeBackupV2] Beginning execution."),o[1]=t.i64.of_float(Date.now()),t.storedProcedure(n("LSGenerateInitialDeviceSetupPayload"),e[0]).then(function(e){var t;return t=e,o[2]=t[0],o[3]=t[1],t})},function(r){var a,i,l;return o[2]!==void 0?t.sequence([function(e){return o[15]=o[2].get("device_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[15]).then(function(e){var t;return t=e,o[16]=t[0],t})},function(e){return o[17]=o[2].get("epoch_storage_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[17]).then(function(e){var t;return t=e,o[18]=t[0],t})},function(e){return o[19]=o[2].get("epoch_storage_public_key_sig"),t.nativeOperation(n("LSBase64Encode.nop"),o[19]).then(function(e){var t;return t=e,o[20]=t[0],t})},function(e){return o[21]=o[2].get("epoch_auth_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[21]).then(function(e){var t;return t=e,o[22]=t[0],t})},function(e){return o[23]=o[2].get("epoch_auth_public_key_sig"),t.nativeOperation(n("LSBase64Encode.nop"),o[23]).then(function(e){var t;return t=e,o[24]=t[0],t})},function(e){return o[25]=o[2].get("ocmf_client_state"),t.nativeOperation(n("LSBase64Encode.nop"),o[25]).then(function(e){var t;return t=e,o[26]=t[0],t})},function(e){return o[27]=o[2].get("mailbox_root_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[27]).then(function(e){var t;return t=e,o[28]=t[0],t})},function(e){return o[29]=o[2].get("device_private_key"),o[30]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,o[31]=t[0],t})},function(e){return o[31]&&(o[44]=(o[30].push(t.i64.cast([0,0])),o[30])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,o[32]=t[0],t})},function(e){return o[32]&&(o[44]=(o[30].push(t.i64.cast([0,2])),o[30])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,o[33]=t[0],t})},function(e){return o[33]&&(o[44]=(o[30].push(t.i64.cast([0,3])),o[30])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,o[34]=t[0],t})},function(e){return o[34]&&(o[44]=(o[30].push(t.i64.cast([0,4])),o[30])),o[35]="",o[36]=t.i64.of_int32(o[30].length),t.i64.gt(o[36],t.i64.cast([0,0]))?t.loopAsync(o[36],function(e){return o[44]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[30],o[44]).then(function(e){var t;return t=e,o[45]=t[0],o[46]=t[1],t})},function(e){return o[35]=[o[35],"_",t.i64.to_string(o[45])].join("")}])}):t.resolve()},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),["supported_versions_",o[35],"revision_version_",t.i64.to_string(t.i64.cast([0,1]))].join("")).then(function(e){var t;return t=e,o[37]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[29],t.blob("Mg=="),o[37]).then(function(e){var t;return t=e,o[38]=t[0],t})},function(e){return t.blobs.neq(o[38],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[38]).then(function(e){var t;return t=e,o[44]=t[0],t})},function(e){return o[39]=o[44]}]):t.resolve(o[39]=void 0)},function(n){var r;return o[40]=o[2].get("optimistic_backup_id"),o[41]=o[2].get("mailbox_partial_id"),o[42]=new t.Map,o[42].set("supported_encryption_versions",o[30]),o[42].set("client_version",t.i64.cast([0,1])),o[42].set("version_sig",o[39]==null?"":o[39]),o[43]=new t.Map,o[43].set("device_public_key",o[16]==null?"":o[16]),o[43].set("epoch_storage_public_key",o[18]==null?"":o[18]),o[43].set("epoch_storage_public_key_sig",o[20]==null?"":o[20]),o[43].set("epoch_auth_public_key",o[22]==null?"":o[22]),o[43].set("epoch_auth_public_key_sig",o[24]==null?"":o[24]),o[43].set("device_registration_id",e[0]),o[43].set("ocmf_client_state",o[26]==null?"":o[26]),o[43].set("mailbox_partial_id",o[41]),o[43].set("mailbox_root_key",o[28]==null?"":o[28]),o[43].set("encryption_version_data",o[42]),r=[o[43],o[40],!0,t.i64.cast([0,0])],o[4]=r[0],o[5]=r[1],o[6]=r[2],o[7]=r[3]}]):t.resolve((o[3]!==void 0?(o[19]=o[3].get("error_code"),a=[void 0,t.i64.cast([-1,4294967295]),!1,o[19]],o[15]=a[0],o[16]=a[1],o[17]=a[2],o[18]=a[3]):(i=[void 0,t.i64.cast([-1,4294967295]),!1,t.i64.cast([0,12])],o[15]=i[0],o[16]=i[1],o[17]=i[2],o[18]=i[3]),l=[o[15],o[16],o[17],o[18]],o[4]=l[0],o[5]=l[1],o[6]=l[2],o[7]=l[3]))},function(a){return o[6]?t.sequence([function(a){return o[4]!==void 0?t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!0}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var r,a,i=e.done,l=e.value;return i?(o[25]=new t.Map,o[25].set("error_msg","Expected a nonempty query result"),o[25].set("code",t.i64.cast([0,3])),o[25].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),o[26]=t.createArray(),o[27]=(o[26].push(o[25]),o[26]),r=[void 0,o[26]],o[16]=r[0],o[17]=r[1]):(n=l.item,o[25]=new t.Map,o[25].set("backup_id",n.backupId),o[25].set("device_public_key_blob",n.devicePublicKeyBlob),o[25].set("device_private_key_blob",n.devicePrivateKeyBlob),o[25].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),o[25].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),o[25].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),o[25].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),o[25].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),o[25].set("ocmf_client_state_blob",n.ocmfClientStateBlob),o[25].set("orf_client_state_v2_blob",void 0),o[25].set("orf_v2_authority_level",void 0),o[25].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),o[25].set("device_id",n.deviceId),o[25].set("backup_tenancy",n.backupTenancy),o[25].set("encryption_version",n.encryptionVersion),o[25].set("revision_version",n.revisionVersion),o[25].set("initialize_restore_result",void 0),o[25].set("device_creation_timestamp_sec",void 0),o[25].set("authority_level",n.authorityLevel),a=[o[25],void 0],o[16]=a[0],o[17]=a[1])})},function(e){var a;return o[19]=new t.Map,o[19].set("value",o[16]),o[19].set("errors",o[17]),o[20]=o[19].get("value"),o[20]!==void 0?t.sequence([function(e){var a;return o[25]=o[20].get("backup_id"),o[26]=o[20].get("device_public_key_blob"),o[27]=o[20].get("device_private_key_blob"),o[28]=o[20].get("epoch_storage_public_key_blob"),o[29]=o[20].get("epoch_storage_private_key_blob"),o[30]=o[20].get("epoch_auth_public_key_blob"),o[31]=o[20].get("epoch_auth_private_key_blob"),o[32]=o[20].get("mailbox_root_key_blob"),o[33]=o[20].get("ocmf_client_state_blob"),o[34]=o[20].get("orf_client_state_v2_blob"),o[35]=o[20].get("orf_v2_authority_level"),o[36]=o[20].get("oblivious_validation_token_blob"),o[37]=o[20].get("device_id"),o[38]=o[20].get("backup_tenancy"),o[39]=o[20].get("encryption_version"),o[40]=o[20].get("revision_version"),o[41]=o[20].get("initialize_restore_result"),o[42]=o[20].get("device_creation_timestamp_sec"),o[43]=o[20].get("authority_level"),t.i64.neq(o[37],void 0)?t.sequence([function(e){return o[47]=void 0,t.i64.neq(o[47],void 0)?t.resolve(o[48]=o[47]):t.sequence([function(e){return o[58]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,o[59]=t[0],t})},function(e){return o[59]&&(o[68]=(o[58].push(t.i64.cast([0,0])),o[58])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,o[60]=t[0],t})},function(e){return o[60]&&(o[68]=(o[58].push(t.i64.cast([0,2])),o[58])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,o[61]=t[0],t})},function(e){return o[61]&&(o[68]=(o[58].push(t.i64.cast([0,3])),o[58])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,o[62]=t[0],t})},function(e){return o[62]&&(o[68]=(o[58].push(t.i64.cast([0,4])),o[58])),o[63]=t.createArray(),o[64]=t.i64.of_int32(o[58].length),t.i64.gt(o[64],t.i64.cast([0,0]))?t.loopAsync(o[64],function(e){return o[68]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[58],o[68]).then(function(e){var t;return t=e,o[69]=t[0],o[70]=t[1],t})},function(e){return o[71]=(o[63].push(o[69]),o[63])}])}):t.resolve()},function(e){return t.sequence([function(e){return o[68]=t.createArray(),o[69]=t.i64.of_int32(o[63].length),t.i64.gt(o[69],t.i64.cast([0,0]))?t.loopAsync(o[69],function(e){return o[71]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[63],o[71]).then(function(e){var t;return t=e,o[72]=t[0],o[73]=t[1],t})},function(e){return o[74]=(o[68].push(t.i64.to_string(o[72])),o[68])}])}):t.resolve()},function(e){return o[70]=o[68].join(","),o[65]=o[70]}])},function(e){return o[63].some(function(e){return t.i64.eq(o[39],e)})?o[66]=o[39]:o[66]=void 0,t.i64.neq(o[66],void 0)?o[67]=o[66]:o[67]=void 0,o[48]=o[67]}])},function(e){return t.i64.neq(o[48],void 0)?o[49]=o[48]:o[49]=t.i64.cast([0,0]),t.i64.neq(o[38],void 0)?o[50]=o[38]:o[50]=t.i64.cast([0,1]),o[51]=new t.Map,o[51].set("device_id",o[37]),o[51].set("public_key",o[26]),o[52]=t.createArray(),o[58]=(o[52].push(o[51]),o[52]),t.storedProcedure(n("LSGenerateInitialEpochSetupPayload"),o[25],o[52]).then(function(e){var t;return t=e,o[53]=t[0],o[54]=t[1],t})},function(e){var a,i,l;return o[53]!==void 0?t.sequence([function(e){return o[58]=o[53].get("epoch_anon_id"),o[59]=o[53].get("epoch_root_key"),t.blobs.neq(o[59],void 0)?t.sequence([function(e){return o[76]=t.createArray(),o[82]=(o[76].push(t.i64.cast([0,18])),o[76]),t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,o[59],o[76]).then(function(e){var t;return t=e,o[77]=t[0],t})},function(e){return o[77]!==void 0?t.sequence([function(e){return o[82]=t.i64.of_int32(o[77].length),t.i64.ge(o[82],t.i64.cast([0,1]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[77],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[84]=t[0],o[85]=t[1],t})},function(e){return o[83]=o[84]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),o[85]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",o[85]].join("")),o[84]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",o[85],o[84],t.i64.cast([0,3]))},function(e){return o[83]=void 0}])},function(e){return o[78]=o[83]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),o[83]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",o[83]].join("")),o[82]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",o[83],o[82],t.i64.cast([0,3]))},function(e){return o[78]=void 0}])},function(e){return t.blobs.neq(o[78],void 0)?o[79]=!0:o[79]=!1,o[79]||((function(e){t.logger(e).mustfix(e)})("LS::assert is failed. Attempting to coerce a null value to nonnull."),t.throw("LS::assert is failed. Attempting to coerce a null value to nonnull.")),t.nativeOperation(n("LSBase64Encode.nop"),o[78]).then(function(e){var t;return t=e,o[80]=t[0],t})},function(e){return o[80]!==void 0?o[81]=o[80]:o[81]="encodingfailed",o[60]=o[81]}]):t.resolve(o[60]="null")},function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[52],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[61]=t[0],o[62]=t[1],t})},function(e){return o[63]=o[61].get("public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[63]).then(function(e){var t;return t=e,o[64]=t[0],t})},function(e){return o[65]=o[61].get("public_key"),o[66]=t.createArray(),o[76]=(o[66].push(t.i64.cast([0,32])),o[66]),t.nativeOperation(n("LSBase64Encode.nop"),o[58]).then(function(e){var t;return t=e,o[67]=t[0],t})},function(e){return o[67]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_devices","_",o[67]].join("")),void 0,o[59],o[66]).then(function(e){var t;return t=e,o[76]=t[0],t})},function(e){return o[76]?o[77]=!1:o[77]=!0,o[77]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),o[80]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[80]].join("")),o[79]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[80],o[79],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[81]=t[0],t})},function(e){return o[78]=o[81]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[76],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[79]=t[0],o[80]=t[1],t})},function(e){return o[78]=o[79]}])},function(e){return o[68]=o[78]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),o[77]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[77]].join("")),o[76]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[77],o[76],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[78]=t[0],t})},function(e){return o[68]=o[78]}])},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),o[68],o[65]).then(function(e){var t;return t=e,o[69]=t[0],t})},function(e){return r("gkx")("11690")&&r("gkx")("16269")?t.sequence([function(e){return t.nativeOperation(n("LSCreateMinosEpochParams.nop"),o[59],o[58],void 0,void 0,void 0).then(function(e){var t;return t=e,o[76]=t[0],o[77]=t[1],o[78]=t[2],o[79]=t[3],o[80]=t[4],o[81]=t[5],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[76]).then(function(e){var t;return t=e,o[82]=t[0],t})},function(e){return o[82]!==void 0?o[83]=o[82]:o[83]="",t.nativeOperation(n("LSBase64Encode.nop"),o[78]).then(function(e){var t;return t=e,o[84]=t[0],t})},function(e){return o[84]!==void 0?o[85]=o[84]:o[85]="",t.nativeOperation(n("LSBase64Encode.nop"),o[77]).then(function(e){var t;return t=e,o[86]=t[0],t})},function(e){return o[86]!==void 0?o[87]=o[86]:o[87]="",t.nativeOperation(n("LSBase64Encode.nop"),o[79]).then(function(e){var t;return t=e,o[88]=t[0],t})},function(e){return o[88]!==void 0?o[89]=o[88]:o[89]="",t.blobs.neq(void 0,void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),void 0).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return o[96]!==void 0?o[97]=o[96]:o[97]="",o[90]=o[97]}]):t.resolve(o[90]=void 0)},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[80]).then(function(e){var t;return t=e,o[91]=t[0],t})},function(e){return o[91]!==void 0?o[92]=o[91]:o[92]="",t.blobs.neq(o[81],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[81]).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return o[96]!==void 0?o[97]=o[96]:o[97]="",o[93]=o[97]}]):t.resolve(o[93]=void 0)},function(e){return o[94]=new t.Map,o[94].set("mailbox_encryption_public_key",o[83]),o[94].set("mailbox_auth_public_key",o[85]),o[94].set("mailbox_signing_public_key",o[87]),o[94].set("epoch_head",o[89]),o[94].set("previous_epoch_head",o[90]),o[94].set("self_signature",o[92]),o[94].set("prev_signature",o[93]),o[94]!==void 0?t.resolve(o[95]=o[94]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBEpochUtils] Missing Native Op for MEBMinosCreateMailboxEncryptionKeyPair"),o[97]="Missing Native Op for MEBMinosCreateMailboxEncryptionKeyPair",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBEpochUtils] ","",o[97]].join("")),o[96]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBEpochUtils",o[97],o[96],t.i64.cast([0,3]))},function(e){return o[95]=void 0}])},function(e){return o[70]=o[95]}]):t.resolve(o[70]=void 0)},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[58]).then(function(e){var t;return t=e,o[71]=t[0],t})},function(e){return o[72]=o[53].get("optimistic_epoch_id"),t.blobs.neq(o[69],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[69]).then(function(e){var t;return t=e,o[76]=t[0],t})},function(e){return o[73]=o[76]}]):t.resolve(o[73]=void 0)},function(e){var n;return o[74]=new t.Map,o[74].set("device_pub",o[64]==null?"":o[64]),o[74].set("hmac",o[73]==null?"":o[73]),o[74].set("encrypted_epoch_key",void 0),o[74].set("epoch_root_key_fingerprint",o[60]),o[75]=new t.Map,o[75].set("epoch_data",""),o[75].set("epoch_anon_id",o[71]==null?"":o[71]),o[75].set("minos_epoch_creation_params",o[70]),o[75].set("optimistic_epoch_id",o[72]),o[75].set("membership",o[74]),n=[o[75],!0,t.i64.cast([0,0])],o[55]=n[0],o[56]=n[1],o[57]=n[2]}]):t.resolve((o[54]!==void 0?(o[61]=o[54].get("error_code"),a=[void 0,!1,o[61]],o[58]=a[0],o[59]=a[1],o[60]=a[2]):(i=[void 0,!1,t.i64.cast([0,14])],o[58]=i[0],o[59]=i[1],o[60]=i[2]),l=[o[58],o[59],o[60]],o[55]=l[0],o[56]=l[1],o[57]=l[2]))},function(e){var t;return t=[o[55],o[56],o[57]],o[44]=t[0],o[45]=t[1],o[46]=t[2],t}]):t.resolve((a=[void 0,!1,t.i64.cast([0,9])],o[44]=a[0],o[45]=a[1],o[46]=a[2],a))},function(e){var t;return t=[o[44],o[45],o[46]],o[21]=t[0],o[22]=t[1],o[23]=t[2],t}]):t.resolve((o[25]=o[19].get("errors"),o[26]=o[19].get("errors"),a=[void 0,!1,t.i64.cast([0,9])],o[21]=a[0],o[22]=a[1],o[23]=a[2]))},function(r){return o[22]?t.sequence([function(r){return o[21]!==void 0?t.sequence([function(r){return t.storedProcedure(n("LSGenerateInitialVirtualDeviceSetupPayload"),o[5],e[2]).then(function(e){var t;return t=e,o[26]=t[0],o[27]=t[1],t})},function(e){var r,a,i;return o[26]!==void 0?t.sequence([function(e){return o[32]=o[26].get("virtual_device_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[32]).then(function(e){var t;return t=e,o[33]=t[0],t})},function(e){return o[34]=o[26].get("virtual_device_id"),t.nativeOperation(n("LSBase64Encode.nop"),o[34]).then(function(e){var t;return t=e,o[35]=t[0],t})},function(e){return o[36]=o[26].get("virtual_device_epoch_storage_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[36]).then(function(e){var t;return t=e,o[37]=t[0],t})},function(e){return o[38]=o[26].get("virtual_device_epoch_storage_public_key_sig"),t.nativeOperation(n("LSBase64Encode.nop"),o[38]).then(function(e){var t;return t=e,o[39]=t[0],t})},function(e){return o[40]=o[26].get("device_epoch_hmac"),t.nativeOperation(n("LSBase64Encode.nop"),o[40]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return o[42]=o[26].get("epoch_root_key_fingerprint"),t.blobs.neq(o[42],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[42]).then(function(e){var t;return t=e,o[54]=t[0],t})},function(e){return o[43]=o[54]}]):t.resolve(o[43]=void 0)},function(e){return o[44]=o[26].get("ocmf_rotation_token"),t.nativeOperation(n("LSBase64Encode.nop"),o[44]).then(function(e){var t;return t=e,o[45]=t[0],t})},function(e){var n;return o[46]=o[26].get("encrypted_secret_values_payload"),o[47]=o[26].get("virtual_device_type"),o[48]=o[26].get("action_type"),o[49]=o[26].get("cloud_service_account"),o[50]=o[26].get("hsm_pin_normalization_status"),o[51]=o[26].get("security_question_type"),o[52]=o[26].get("trusted_contact_id"),o[53]=new t.Map,o[53].set("virtual_device_public_key",o[33]==null?"":o[33]),o[53].set("virtual_device_id",o[35]==null?"":o[35]),o[53].set("virtual_device_epoch_storage_public_key",o[37]==null?"":o[37]),o[53].set("virtual_device_epoch_storage_public_key_sig",o[39]==null?"":o[39]),o[53].set("encrypted_secret_values",o[46]),o[53].set("device_epoch_hmac",o[41]==null?"":o[41]),o[53].set("epoch_root_key_fingerprint",o[43]),o[53].set("ocmf_rotation_token",o[45]==null?"":o[45]),o[53].set("virtual_device_type",o[47]),o[53].set("action_type",o[48]),o[53].set("cloud_service_account",o[49]),o[53].set("hsm_pin_normalization_status",o[50]),o[53].set("security_question_type",o[51]),o[53].set("trusted_contact_id",o[52]),n=[o[53],!0,t.i64.cast([0,0])],o[28]=n[0],o[29]=n[1],o[30]=n[2]}]):t.resolve((o[27]!==void 0?(o[35]=o[27].get("error_code"),r=[void 0,!1,o[35]],o[32]=r[0],o[33]=r[1],o[34]=r[2]):(a=[void 0,!1,t.i64.cast([0,16])],o[32]=a[0],o[33]=a[1],o[34]=a[2]),i=[o[32],o[33],o[34]],o[28]=i[0],o[29]=i[1],o[30]=i[2]))},function(r){return o[29]?t.sequence([function(r){return o[28]!==void 0?t.sequence([function(r){return o[33]=new t.Map,o[33].set("optimistic_backup_id",o[5]),o[33].set("device_payload",o[4]),o[33].set("epoch_payload",o[21]),o[33].set("virtual_device_payload",o[28]),o[38]=t.i64.cast([0,1e3]),o[34]=o[38],o[35]=new t.Map,o[35].set("success",o[33]),o[35].set("request_id",e[1]),o[36]=t.toJSON(o[35]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[36],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,o[34]).then(function(e){var t;return t=e,o[37]=t[0],t})},function(e){return o[32]=t.i64.cast([0,0])}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null virtual device payload"),o[34]="Null virtual device payload",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",o[34]].join("")),o[33]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",o[34],o[33],t.i64.cast([0,3]))},function(r){return o[35]=new t.Map,o[35].set("error_code",o[30]),o[35].set("error_message","Null virtual device payload"),o[35].set("stored_procedure","initializeBackupV2"),o[36]=new t.Map,o[36].set("failure",o[35]),o[36].set("request_id",e[1]),o[37]=t.toJSON(o[36]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[37],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[38]=t[0],t})},function(e){return o[32]=t.i64.cast([0,1])}])},function(e){return o[31]=o[32]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create virtual device payload"),o[33]="Could not create virtual device payload",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",o[33]].join("")),o[32]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",o[33],o[32],t.i64.cast([0,3]))},function(r){return o[34]=new t.Map,o[34].set("error_code",o[30]),o[34].set("error_message","Could not create virtual device payload"),o[34].set("stored_procedure","initializeBackupV2"),o[35]=new t.Map,o[35].set("failure",o[34]),o[35].set("request_id",e[1]),o[36]=t.toJSON(o[35]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[36],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[37]=t[0],t})},function(e){return o[31]=t.i64.cast([0,1])}])},function(e){return o[25]=o[31]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null epoch payload"),o[27]="Null epoch payload",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",o[27]].join("")),o[26]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",o[27],o[26],t.i64.cast([0,3]))},function(r){return o[28]=new t.Map,o[28].set("error_code",o[23]),o[28].set("error_message","Null epoch payload"),o[28].set("stored_procedure","initializeBackupV2"),o[29]=new t.Map,o[29].set("failure",o[28]),o[29].set("request_id",e[1]),o[30]=t.toJSON(o[29]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[30],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[31]=t[0],t})},function(e){return o[25]=t.i64.cast([0,1])}])},function(e){return o[24]=o[25]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create epoch payload"),o[26]="Could not create epoch payload",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",o[26]].join("")),o[25]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",o[26],o[25],t.i64.cast([0,3]))},function(r){return o[27]=new t.Map,o[27].set("error_code",o[23]),o[27].set("error_message","Could not create epoch payload"),o[27].set("stored_procedure","initializeBackupV2"),o[28]=new t.Map,o[28].set("failure",o[27]),o[28].set("request_id",e[1]),o[29]=t.toJSON(o[28]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[29],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[30]=t[0],t})},function(e){return o[24]=t.i64.cast([0,1])}])},function(e){return o[15]=o[24]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null device payload"),o[17]="Null device payload",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",o[17]].join("")),o[16]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",o[17],o[16],t.i64.cast([0,3]))},function(r){return o[18]=new t.Map,o[18].set("error_code",o[7]),o[18].set("error_message","Null device payload"),o[18].set("stored_procedure","initializeBackupV2"),o[19]=new t.Map,o[19].set("failure",o[18]),o[19].set("request_id",e[1]),o[20]=t.toJSON(o[19]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[20],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[21]=t[0],t})},function(e){return o[15]=t.i64.cast([0,1])}])},function(e){return o[8]=o[15]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create device payload"),o[16]="Could not create device payload",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",o[16]].join("")),o[15]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",o[16],o[15],t.i64.cast([0,3]))},function(r){return o[17]=new t.Map,o[17].set("error_code",o[7]),o[17].set("error_message","Could not create device payload"),o[17].set("stored_procedure","initializeBackupV2"),o[18]=new t.Map,o[18].set("failure",o[17]),o[18].set("request_id",e[1]),o[19]=t.toJSON(o[18]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50033]),o[19],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[20]=t[0],t})},function(e){return o[8]=t.i64.cast([0,1])}])},function(e){return o[9]=t.i64.of_float(Date.now()),o[10]=t.i64.random(),o[12]="Finishing execution. Execution time: ",o[13]=t.i64.to_string(t.i64.sub(o[9],o[0])),o[14]=" ms",o[11]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][initializeBackupV2] ",o[11],o[12],o[11],o[13],o[11],o[14]].join("")),t.i64.eq(t.i64.mod_(o[10],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(o[15]=",",o[16]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"initializeBackupV2",[o[12],o[15],o[13],o[15],o[14]].join(""),o[16],t.i64.cast([0,4]))):t.resolve()},function(e){return a[0]=o[8]}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsInitializeBackupV2StoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"];var s=e;l.default=s}),98);
__d("LSInitializeBackupV2StoredProcedure",["LSInitializeBackupV2","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSInitializeBackupV2"),a.deviceRegistrationId,a.requestId,a.recoveryCodeData);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MWEncryptedBackupsInitializeBackup",["LSFactory","LSInitializeBackupV2StoredProcedure","LSShape"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a){return e.runInTransaction(function(e){return r("LSInitializeBackupV2StoredProcedure")(r("LSFactory")(e),{deviceRegistrationId:t,recoveryCodeData:a?o("LSShape").ofRecord(a):void 0,requestId:n!=null?n:""})},"readwrite",void 0,void 0,i.id+":28")}l.initializeBackupStoredProcedure=e}),98);
__d("EBInitializeBackup",["EBAPIQPLPoints","EBDeps","EBLogger","EBMainThreadEBDBApiDeferred","EBSMAPI","I64","LSAuthorityLevel","LSEncryptedBackupsOpStatus","LSIntEnum","MAWTraceUtils","MWEncryptedBackupsDeviceRegistrationId","MWEncryptedBackupsInitializeBackup","Promise","Random","RecoveryCodeDB","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var a=yield o("RecoveryCodeDB").getOrCreateRecoveryCodeDB(),i=o("Random").uint32();yield a.runInTransaction(["persisted_recovery_code"],"readwrite",(function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=yield n.stores.persisted_recovery_code.readAll(),a=o.filter(function(e){return e.virtualDeviceType===t&&e.authorityLevel===r("LSAuthorityLevel").OPTIMISTIC}).map(function(e){return e.pk});a.length>0&&(yield n.stores.persisted_recovery_code.bulkDelete(a)),yield n.stores.persisted_recovery_code.bulkPut([{authorityLevel:r("LSAuthorityLevel").OPTIMISTIC,pk:i,recoveryCode:e,virtualDeviceType:t}])});return function(e){return o.apply(this,arguments)}})(),"EBDB - persist recovery code optimistic")}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var a=yield o("RecoveryCodeDB").getOrCreateRecoveryCodeDB();yield a.runInTransaction(["persisted_recovery_code"],"readwrite",(function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=yield n.stores.persisted_recovery_code.readAll(),a=o.find(function(n){return n.recoveryCode===e&&n.virtualDeviceType===t&&n.authorityLevel===r("LSAuthorityLevel").OPTIMISTIC});a!=null&&(yield n.stores.persisted_recovery_code.bulkPut([babelHelpers.extends({},a,{authorityLevel:r("LSAuthorityLevel").AUTHORITATIVE})]))});return function(e){return o.apply(this,arguments)}})(),"RecoveryCodeDB - update recovery code to authoritative")}),p.apply(this,arguments)}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("RecoveryCodeDB").getOrCreateRecoveryCodeDB();yield t.runInTransaction(["persisted_recovery_code"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t.stores.persisted_recovery_code.readAll(),o=n.filter(function(t){return t.virtualDeviceType===e&&t.authorityLevel===r("LSAuthorityLevel").OPTIMISTIC}).map(function(e){return e.pk});o.length>0&&(yield t.stores.persisted_recovery_code.bulkDelete(o))});return function(e){return t.apply(this,arguments)}})(),"RecoveryCodeDB - cleanup recovery code optimistic")}),f.apply(this,arguments)}var g=!1,h=new Map;function y(e,t,n){return C.apply(this,arguments)}function C(){return C=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a,i){if(r("justknobx")._("5261")&&g===!0)return o("EBLogger").EBLogger().warn("initializeBackup: init in progress"),t.endFail(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_RUNNING),(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("init_in_progress"));g=!0;var l=null;try{if((e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(16))){var d=yield o("RecoveryCodeDB").getOrCreateRecoveryCodeDB(),p=yield d.runInTransaction(["persisted_recovery_code"],"readonly",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield e.stores.persisted_recovery_code.readAll(),n=t.find(function(e){return e.virtualDeviceType===16&&e.authorityLevel===r("LSAuthorityLevel").OPTIMISTIC});return n!=null?{pk:n.pk,recoveryCode:n.recoveryCode}:null});return function(t){return e.apply(this,arguments)}})(),"RecoveryCodeDB - read existing optimistic recovery code");t.addAnnotations({bool:{is_auto_eb_retry:p!=null}});var f=r("justknobx")._("776");if(p!=null&&f)return o("EBLogger").EBLogger().mustfix("Auto EB initBackup retry prevented by killswitch: wmi/armadillo:stop_auto_eb_initbackup_retry"),t.endFail("auto_eb_retry_prevented_by_killswitch"),yield _(16),g=!1,(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("auto_eb_init_failed"));if(p!=null)l=p.recoveryCode,t.addAnnotations({int:{recovery_code_db_pk:p.pk}});else{var y=yield r("EBSMAPI").generateRecoveryCode({virtualDeviceType:a});if(y.success===!1)return t.endFail("generate_recovery_code_failure"),g=!1,y;y.success===!0&&(l=y.value.recoveryCode,yield c(l,16))}}}catch(i){var C=r("getErrorSafe")(i);return t.endFail("auto_eb_init_failed"),o("EBLogger").EBLogger().catching(C).mustfix("Auto EB init failed."),(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(16))&&(yield _(16)),g=!1,(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("auto_eb_init_failed"))}var b=function(){},v=new(u||(u=n("Promise")))(function(e,n){window.setTimeout(function(){b(),o("EBLogger").EBLogger().warn("Init backup failed by timeout"),t.endFail(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_TIMEOUT),e(o("WAResultOrError").makeError("timed_out"))},r("justknobx")._("4211"))}),S=new u((function(){var u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(u,c){var d=o("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();if(t.addAnnotations({string:{deviceRegistrationId:d}}),d===""){t.endFail("device_registration_id_null"),u(o("WAResultOrError").makeError("device_registration_id_null"));return}t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.GET_DB_START);var p=yield o("EBDeps").getDeps().getLSDB();t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.GET_DB_END),b=p.tables.secure_encrypted_backups_client_state.subscribe((function(){var i=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n,i){if(i.operation==="delete"){t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SUBSCRIPTION_DELETE,{int:{deleteAuthorityLevel:(e||(e=o("I64"))).to_int32(i.prevValue.authorityLevel),deleteBackupId:e.to_int32(i.prevValue.backupId),deleteInputVirtualDeviceType:e.to_int32(a)}});return}var c=i.value,d=c.authorityLevel,p=c.backupId;(e||(e=o("I64"))).equal(d,(s||(s=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))?(t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_END),l!=null&&(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(16))&&(yield m(l,16)),b(),t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.FETCH_BACKUP_IDS_START),r("EBSMAPI").fetchBackupIds("EBInitializeBackup").finally(function(){t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.FETCH_BACKUP_IDS_END),t.endSuccess(),o("EBMainThreadEBDBApiDeferred").addNewDevice()}),u(o("WAResultOrError").makeResult(p))):t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.OPTIMISTIC_CLIENT_STATE,{int:{ocsAuthorityLevel:(e||(e=o("I64"))).to_int32(d),ocsBackupId:e.to_int32(p),ocsInputVirtualDeviceType:e.to_int32(a)},string:{ocsOperation:i.operation}})});return function(e,t){return i.apply(this,arguments)}})()),h.set(t.getQPLAttrs().instanceKey.toString(),{clientStateUnsubscribe:b,qplFlow:t,resolve:u}),t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_START);var f=yield o("MWEncryptedBackupsInitializeBackup").initializeBackupStoredProcedure(p,d,o("MAWTraceUtils").stringToTraceId(t.getQPLAttrs().instanceKey.toString()),i),g=f[0];if((e||(e=o("I64"))).equal(g,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE))){t.endFail(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_FAIL),(e||(e=o("I64"))).equal(a,(s||(s=o("LSIntEnum"))).ofNumber(16))&&(yield _(16)),u(o("WAResultOrError").makeError("sproc_failure"));return}t.addPoint(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_END,{int:{sproc_status:(e||(e=o("I64"))).to_int32(g)}})});return function(e,t){return u.apply(this,arguments)}})());return u.race([S,v]).then(function(e){return e}).finally(function(){h.delete(t.getQPLAttrs().instanceKey.toString()),g=!1})}),C.apply(this,arguments)}function b(e,t,n){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r){var a=h.get(t);a!=null&&(a.resolve(o("WAResultOrError").makeError("initialize_backup_fail")),a.qplFlow.endFail(o("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_FAIL,{string:{errorMsg:n}}),a.clientStateUnsubscribe()),r!=null&&(e||(e=o("I64"))).equal(r,(s||(s=o("LSIntEnum"))).ofNumber(16))&&(yield _(16)),h.delete(t)}),v.apply(this,arguments)}l.initializeBackup=y,l.resolveInitializeBackupPromiseWithError=b}),98);
__d("EBLoadMostRecentSelfMinosEpoch",["EBDB","EBMinosTypes","WALongInt","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o("EBDB").getEBDB(),t=yield e.store("secure_encrypted_backups_epochs").readAll(),n=Array.from(t).map(function(e){var t=e.epochAnonIdBlob,n=e.epochHead,r=e.epochId,a=e.epochRootKeyBlob;return n==null?null:{epochFbId:o("EBMinosTypes").unsafeCastToEpochFbId(r.toString()),epochHead:o("EBMinosTypes").unsafeCastToEpochHead(n),epochNumber:o("EBMinosTypes").unsafeCastToBase64StringIntToEpochNumber(t),exportRootKey:o("EBMinosTypes").unsafeCastToExportRootKey(a)}}).filter(Boolean).sort(function(e,t){return o("WALongInt").numberOrThrowIfTooLarge(t.epochNumber)-o("WALongInt").numberOrThrowIfTooLarge(e.epochNumber)}),r=n[0];return r});return function(){return e.apply(this,arguments)}})();l.loadMostRecentSelfMinosEpoch=e}),98);
__d("EBMinosWasmOpenEpoch",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t,n=e.minosSignedEpoch,r=n.epochHead,a=n.epochPublicData,i=n.signatures;return o("WAResultOrError").makeResult({epochHead:(t=o("EBMinosTypes")).unsafeCastToEpochHead(r),epochPublicData:{epochNumber:t.unsafeCastToEpochNumber(a.epochNumber),mailboxAuthPk:t.unsafeCastToMailboxAuthPK(a.mailboxAuthPk),mailboxEncryptionPk:t.unsafeCastToMailboxEncryptionPK(a.mailboxEncryptionPk),mailboxSigningPk:t.unsafeCastToMailboxSigningPK(a.mailboxSigningPk),previousEpochHead:a.previousEpochHead==null?null:o("EBMinosTypes").unsafeCastToEpochHead(a.previousEpochHead),userFbid:o("EBMinosTypes").unsafeCastToUserFbId(a.userFbid)},signatures:{prevSignature:i.prevSignature==null?null:o("EBMinosTypes").unsafeCastToEpochPrevSig(i.prevSignature),selfSignature:o("EBMinosTypes").unsafeCastToEpochSelfSig(i.selfSignature)}})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey,a=t.previousEpochHead,i=t.previousEpochNumber,l=t.previousExportRootKey,s=t.userFbid;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosOpenEpochResultSpec,validateResult:e},{minosOpenEpoch:{epochNumber:n,exportRootKey:r,previousEpochHead:a,previousEpochNumber:i,previousExportRootKey:l,userFbid:s}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.openEpoch=s}),98);
__d("EBLoadSelfMinosEpochForDecryption",["EBDB","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasmOpenEpoch","WAGlobals","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["epochNumber"],s,u,c,d,m,p,_,f=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("EBDB").getEBDB(),r=yield n.store("secure_encrypted_backups_epochs").get(BigInt(e));if(r==null)return o("WAResultOrError").makeError("no-self-epoch-found");var a=r.epochHead,i=r.epochRootKeyBlob;if(a!=null)return o("WAResultOrError").makeResult({exportEpochHead:o("EBMinosTypes").unsafeCastToEpochHead(a),exportRootKey:o("EBMinosTypes").unsafeCastToExportRootKey(i)});if(t===o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.V1||t===o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.V2)return o("WAResultOrError").makeResult({exportEpochHead:null,exportRootKey:o("EBMinosTypes").unsafeCastToExportRootKey(i)});o("EBMinosLogger").minosLogger.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["No epoch head found for user's epoch, attempting to re-calculate"])));var l=yield n.store("secure_encrypted_backups_epochs").readAll(),p=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(p==null)return o("WAResultOrError").makeError("no-user-fbid-found");var _=g(l),f=_.firstMinosEpochIndex,y=_.sortedEpochs;if(f===-1)return o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["No minos epoch heads found"]))),o("WAResultOrError").makeError("no-self-epoch-head-found");var C=yield h(f,e,y,p);if(!C.success)return o("EBMinosLogger").minosLogger.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to process epochs: ",""])),C.error),C;var b=C.value,v=b.currentEpochHead,S=b.currentExportRootKey;return v==null||S==null?(o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to re-calculate epoch head"]))),o("WAResultOrError").makeError("no-self-epoch-head-found")):(o("EBMinosLogger").minosLogger.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Successfully recalculated minos epoch head"]))),o("WAResultOrError").makeResult({exportEpochHead:v,exportRootKey:S}))});return function(n,r){return e.apply(this,arguments)}})();function g(e){var t=e.filter(function(e){return e!=null}).map(function(e){return babelHelpers.extends({},e,{epochNumber:o("EBMinosTypes").unsafeCastToBase64StringIntToEpochNumber(e.epochAnonIdBlob)})}).sort(function(e,t){return o("WALongInt").numberOrThrowIfTooLarge(e.epochNumber)-o("WALongInt").numberOrThrowIfTooLarge(t.epochNumber)}),n=(function(){for(var e=t.length-1;e>=0;e--)if(t[e].epochHead!=null)return e;return-1})();return{firstMinosEpochIndex:n,sortedEpochs:t}}function h(e,t,n,r){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a){for(var i,l=r[t].epochHead?o("EBMinosTypes").unsafeCastToEpochHead(r[t].epochHead):null,s=r[t].epochRootKeyBlob?o("EBMinosTypes").unsafeCastToExportRootKey(r[t].epochRootKeyBlob):null,u=(i=r[t].epochNumber)!=null?i:null,c=[],d=t+1;d<r.length;d++){var m=r[d],f=m.epochNumber,g=babelHelpers.objectWithoutPropertiesLoose(m,e),h=o("EBMinosTypes").unsafeCastToExportRootKey(m.epochRootKeyBlob);if(l==null||u==null||s==null)return o("EBMinosLogger").minosLogger.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Failed to open epoch: previousEpochHead, previousEpochNumber, or previousExportRootKey is null"]))),o("WAResultOrError").makeError("failed-to-open-epoch");var y=yield o("EBMinosWasmOpenEpoch").openEpoch({epochNumber:f,exportRootKey:h,previousEpochHead:l,previousEpochNumber:u,previousExportRootKey:s,userFbid:a});if(y.success)l=y.value.epochHead,s=h,u=f,c.push(babelHelpers.extends({},g,{epochHead:y.value.epochHead}));else return o("EBMinosLogger").minosLogger.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Failed to open epoch: ",""])),y.error),o("WAResultOrError").makeError("failed-to-open-epoch");if(m.epochId===BigInt(n))break}return o("WAResultOrError").makeResult({currentEpochHead:l,currentExportRootKey:s,reCalculatedEpochs:c})}),y.apply(this,arguments)}l.loadSelfMinosEpochForDecryption=f}),98);
__d("EBMinosLoadMessageEncryptionKey",["EBMinosDb","WACryptoUtils","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{mek:{key:e.encryption_key_blob,mekId:e.mek_id_blob,rosterHash:e.roster_hash},mekFbid:e.mek_fbid}}var s=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield o("EBMinosDb").getEBMinosDb(),r=yield n.runInTransaction(["secure_minos_thread_message_encryption_keys_v2"],"readonly",function(e){return e.stores.secure_minos_thread_message_encryption_keys_v2.get(t)},"loadMessageEncryptionKeyByMekId");if(r!=null)return e(r)});return function(n){return t.apply(this,arguments)}})(),u=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){var i=yield o("EBMinosDb").getEBMinosDb();if(r("gkx")("380")){var l=yield i.runInTransaction(["secure_minos_thread_message_encryption_keys_v2"],"readonly",function(e){return e.stores.secure_minos_thread_message_encryption_keys_v2.readIndex("[roster_hash+minos_thread_id]",[n,t])},"loadMessageEncryptionKey");for(var s of l)if(s.created_by_self||s.mek_creator_epoch_head!=null&&a!=null&&o("WACryptoUtils").arrayBuffersEqual(s.mek_creator_epoch_head,a))return e(s)}else{var u=yield i.runInTransaction(["secure_minos_thread_message_encryption_keys"],"readonly",function(e){return e.stores.secure_minos_thread_message_encryption_keys.readIndex("[roster_hash+minos_thread_id]",[n,t])},"loadMessageEncryptionKey");if(u.length===0)return null;var c=u[0];return e(c)}});return function(n,r,o){return t.apply(this,arguments)}})();l.loadMessageEncryptionKeyForDecryption=s,l.loadMessageEncryptionKey=u}),98);
__d("EBMinosSaveNewMessageEncryptionKey",["EBMinosDb","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a,i,l){var s=yield o("EBMinosDb").getEBMinosDb();r("gkx")("7918")?yield s.runInTransaction(["secure_minos_thread_message_encryption_keys_v2"],"readwrite",function(r){return r.stores.secure_minos_thread_message_encryption_keys_v2.bulkPut([{created_by_self:a,encryption_key_blob:t.key,last_used_ts_ms:i,mek_creator_epoch_head:l,mek_fbid:n,mek_id_blob:t.mekId,minos_thread_id:e,roster_hash:t.rosterHash}])},"SaveNewMessageEncryptionKeyV2"):a&&(yield s.runInTransaction(["secure_minos_thread_message_encryption_keys"],"readwrite",function(r){return r.stores.secure_minos_thread_message_encryption_keys.bulkPut([{encryption_key_blob:t.key,mek_fbid:n,mek_id_blob:t.mekId,minos_thread_id:e,roster_hash:t.rosterHash}])},"SaveNewMessageEncryptionKey"))});return function(n,r,o,a,i,l){return e.apply(this,arguments)}})();l.saveNewMessageEncryptionKey=e}),98);
__d("EBRegisterMinosMessageEncryptionKeyMutation_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="25185089431099815"}),null);
__d("EBRegisterMinosMessageEncryptionKeyMutation.graphql",["EBRegisterMinosMessageEncryptionKeyMutation_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"input"}],t=[{kind:"Variable",name:"input",variableName:"input"}],r={kind:"InlineFragment",selections:[{alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null}],type:"XFBMinosRegisterMessageEncryptionKeyResponse",abstractKey:null},o={kind:"InlineFragment",selections:[{alias:null,args:null,kind:"ScalarField",name:"code",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"message",storageKey:null}],type:"XFBMinosRegisterMessageEncryptionKeyError",abstractKey:null};return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"EBRegisterMinosMessageEncryptionKeyMutation",selections:[{alias:null,args:t,concreteType:null,kind:"LinkedField",name:"xfb_minos_register_message_encryption_key",plural:!1,selections:[r,o],storageKey:null}],type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"EBRegisterMinosMessageEncryptionKeyMutation",selections:[{alias:null,args:t,concreteType:null,kind:"LinkedField",name:"xfb_minos_register_message_encryption_key",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"__typename",storageKey:null},r,o],storageKey:null}]},params:{id:n("EBRegisterMinosMessageEncryptionKeyMutation_facebookRelayOperation"),metadata:{},name:"EBRegisterMinosMessageEncryptionKeyMutation",operationKind:"mutation",text:null}}})();a.exports=e}),null);
__d("EBRegisterMinosMessageEncryptionKey",["Base64Utils","EBMinosTypes","EBRegisterMinosMessageEncryptionKeyMutation.graphql","WALongInt","WAResultOrError","asyncToGeneratorRuntime","createWorkerMutation"],(function(t,n,r,o,a,i,l){"use strict";var e,s=e!==void 0?e:e=n("EBRegisterMinosMessageEncryptionKeyMutation.graphql"),u=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.actThreadId,a=e.instanceKey,i=e.mekEncryptionVersion,l=e.mekEnvelopes,u=e.mekId,c=e.mekRosterHash,d=e.sender,m=l.map(function(e){var t=e.encryptedMek,n=e.mailboxKey,r=e.mailboxKeyFbid,a=e.participantId;return{encrypted_mek_base64:o("Base64Utils").fromArrayBuffer(t),mailbox_key_base64:o("Base64Utils").fromArrayBuffer(n),mailbox_key_fbid:o("WALongInt").longIntToDecimalString(r),participant_id:a}}),p=r("createWorkerMutation")(s),_=p[0],f=yield _({input:{mek_envelopes:m,mek_info:babelHelpers.extends({act_thread_id:n,mek_encryption_version:i,mek_id_base64:o("Base64Utils").fromArrayBuffer(u),mek_roster_base64:o("Base64Utils").fromArrayBuffer(c)},d.senderType==="Minos"?{minos_sender:{epoch_fbid:d.epochFbId}}:{transport_sender:{ephemeral_hpke_pub_key_base64:o("Base64Utils").fromArrayBuffer(d.ephemeralEncryptionPk),ephemeral_key_signature_base64:o("Base64Utils").fromArrayBuffer(d.signature),signing_pub_key_base64:o("Base64Utils").fromArrayBuffer(d.signingPk)}}),request_uuid:a.toString(),version:"REAL_MAILBOX_KEYS"}});if(f==null)return o("WAResultOrError").makeError({errorName:"empty-response"});if((f==null||(t=f.xfb_minos_register_message_encryption_key)==null?void 0:t.mek_fbid)!=null){var g=f.xfb_minos_register_message_encryption_key.mek_fbid;return o("WAResultOrError").makeResult({mekFbid:o("EBMinosTypes").unsafeCastToMekFbId(g)})}var h=(f==null?void 0:f.xfb_minos_register_message_encryption_key)||{},y=h.code,C=h.message,b="error code: "+(y!=null?y:"null")+" error description: "+(C!=null?C:"null");return y!=null?o("WAResultOrError").makeError({errorName:"graphql-error",failReason:b}):o("WAResultOrError").makeError({errorName:"unexpected-graphql-response",failReason:b})});return function(n){return e.apply(this,arguments)}})();l.registerMinosMessageEncryptionKey=u}),98);
__d("EBInitializeMinosCryptoLibrary",["EBLoadMostRecentSelfMinosEpoch","EBLoadSelfMinosEpochForDecryption","EBMinosCryptoLibrary","EBMinosLoadMessageEncryptionKey","EBMinosLogger","EBMinosSaveNewMessageEncryptionKey","EBRegisterMinosMessageEncryptionKey","FBLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.transportSigningKeypair,a=yield o("EBMinosCryptoLibrary").createMinosCryptoLibrary({io:{loadMessageEncryptionKey:o("EBMinosLoadMessageEncryptionKey").loadMessageEncryptionKey,loadMessageEncryptionKeyForDecryption:o("EBMinosLoadMessageEncryptionKey").loadMessageEncryptionKeyForDecryption,loadMostRecentSelfMinosEpoch:o("EBLoadMostRecentSelfMinosEpoch").loadMostRecentSelfMinosEpoch,loadSelfMinosEpochForDecryption:o("EBLoadSelfMinosEpochForDecryption").loadSelfMinosEpochForDecryption,registerMinosMessageEncryptionKey:o("EBRegisterMinosMessageEncryptionKey").registerMinosMessageEncryptionKey,saveNewMessageEncryptionKey:o("EBMinosSaveNewMessageEncryptionKey").saveNewMessageEncryptionKey},logger:o("EBMinosLogger").minosLogger,transportSigningKeypair:n});if(!a.success){r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to create Minos crypto library ",""])),a.error);return}o("EBMinosCryptoLibrary").setMinosCryptoLibrary(a.value)}),u.apply(this,arguments)}l.initializeMinosCryptoLibrary=s}),98);
__d("EBLabyrinthWasmReactorSingleton",["EBGetCryptoWasm","WAWasmReactor","asyncToGeneratorRuntime","memoizeWithArgs"],(function(t,n,r,o,a,i,l){"use strict";var e="Labyrinth_REPL",s=r("memoizeWithArgs")(function(){return o("WAWasmReactor").createWasmInstance(o("EBGetCryptoWasm").getCryptoWasm,e)},function(){return"cache"}),u=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.InputSpec,r=e.ResultSpec,o=e.validateResult,a=yield s();return a.DEPRECATED_createWasmCommand({InputSpec:n,ResultSpec:r,validateResult:o})(t)});return function(n,r){return e.apply(this,arguments)}})();l.labyrinthCommand=u}),98);
__d("EBMainThreadEBDBApi",["$InternalEnum","EBDB","EBDBConsistencyApi","FBLogger","LSDatabaseSingleton","WAResolvable","WormDump","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;function u(){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield(e||(e=o("LSDatabaseSingleton"))).LSDatabaseSingleton;try{yield o("EBDBConsistencyApi").startListeningDeviceRegistrations(t,o("EBDB").EBDBEnvironment.UI)}catch(e){var n=r("getErrorSafe")(e);r("FBLogger")("wmi_eb").catching(n).mustfix("Error on startListeningDeviceRegistrations in UI")}finally{s.resolve(t)}}),c.apply(this,arguments)}function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){yield o("EBDBConsistencyApi").trackOverprompting(o("EBDB").EBDBEnvironment.UI,e)}),m.apply(this,arguments)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield s.promise;yield o("EBDBConsistencyApi").addNewDevice(t,o("EBDB").EBDBEnvironment.UI,e)}),_.apply(this,arguments)}function f(){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e,t=yield o("EBDB").getEBDB();return t.dump({auto_restore_opt_out:{customFields:{optOutKey:(e=o("WormDump")).wormNonSensitiveField,optOutValue:e.wormNonSensitiveField}},device_metadata:{customFields:{backupId:e.wormNonSensitiveField,deviceRegistrationId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,taskId:e.wormNonSensitiveField}},device_state:{customFields:{deviceId:e.wormNonSensitiveField,env:e.wormNonSensitiveField}},encrypted_backups:{customFields:{authorityLevel:e.wormNonSensitiveField,backupId:e.wormNonSensitiveField,backupTenancy:e.wormNonSensitiveField,hasOtcEligibleDevices:e.wormNonSensitiveField,isUserOptedOut:e.wormNonSensitiveField,pk:e.wormNonSensitiveField}},encrypted_backups_virtual_devices:{customFields:{backupId:e.wormNonSensitiveField,creationTime:e.wormNonSensitiveField,deviceCreatedOn:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,removalStatus:e.wormNonSensitiveField,requiresHsmMigration:e.wormNonSensitiveField}},experiences_shared_state:{},secure_encrypted_backups_client_state:{customFields:{authorityLevel:e.wormNonSensitiveField,backupId:e.wormNonSensitiveField,backupTenancy:e.wormNonSensitiveField,deviceId:e.wormNonSensitiveField,encryptionVersion:e.wormNonSensitiveField}},secure_encrypted_backups_epochs:{customFields:{authorityLevel:e.wormNonSensitiveField,epochId:e.wormNonSensitiveField,epochStatus:e.wormNonSensitiveField}},secure_encrypted_backups_recovery_code_status:{customFields:{pk:e.wormNonSensitiveField,recoveryCodeStatus:e.wormNonSensitiveField}}})}),g.apply(this,arguments)}var h=n("$InternalEnum")({Disabled:0,UIInconsistent:1,WorkerInconsistent:2,Consistent:3});function y(e,t){return C.apply(this,arguments)}function C(){return C=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield s.promise;o("EBDBConsistencyApi").trackConsistency(n,o("EBDB").EBDBEnvironment.UI,e,function(){var e=h.Disabled,n=o("EBDBConsistencyApi").getDeviceId();return n!=null&&t!=null?e=h.Consistent:n!=null&&t==null?e=h.WorkerInconsistent:n==null&&t!=null&&(e=h.UIInconsistent),{int:{crossEnvConsistency:e}}})}),C.apply(this,arguments)}l.startListeningDeviceRegistrations=u,l.trackOverprompting=d,l.addNewDevice=p,l.getEBDBDump=f,l.EBCrossEnvConsistencyResult=h,l.trackConsistency=y}),98);
__d("EBMinosWriteKeyChangeAdminMessage",["EBMinosTypes","FBLogger","MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAppMeta","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWTransactionMode","MpsTypes","Promise","WAArmadilloTransportEvent.pb","WABuildMpsPayload","WADbContact","WAGlobals","WAJids","WAStanzaUtils","WebMps","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert}).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlert)!=null?t:!1})}function c(e,t){var n=o("WAGlobals").getMyUserJid()===t;return!n&&e}function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.deviceChangeType,n=t===void 0?o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED:t,a=e.epochHeadCreationTime,i=e.userJid;try{var l=o("MAWExternalId").generateExternalId(),s=o("WABuildMpsPayload").buildMpsDeviceChangeAdminMessage(i,a,o("WAStanzaUtils").toStanzaId(l),n),u={directive:null,insertionSource:o("MpsTypes").InsertionSource.Receive,message:s};yield o("WebMps").mps().saveNewMessages([u],{source:"eb-minos-device-change"}),r("FBLogger")("wmi_minos").info("Sent device change transport event for user %s with type %s",i,String(n))}catch(e){var c=r("getErrorSafe")(e);throw r("FBLogger")("wmi_minos").catching(c).mustfix("Failed to send device change transport event for user %s",i),c}}),m.apply(this,arguments)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.contactId,i=t.epochHeadCreationTime,l=o("EBMinosTypes").userFbidToUserJid(a);if(l==null)return r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid userJid generated in writeKeyChangeAdminMessage"]))),(s||(s=n("Promise"))).resolve();var m=yield o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDbThreadTxns").getAllThreadsForUsers(e,[l])}})(),p=m.get(l),_=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:[l]});if(p==null||(p==null?void 0:p.length)===0)return(s||(s=n("Promise"))).resolve();var f=p.filter(function(e){var t=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return"group"},user:function(){return"one_to_one"}});return t==="one_to_one"}),g=yield(s||(s=n("Promise"))).all([d({deviceChangeType:o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED,epochHeadCreationTime:i,userJid:l}),o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY,ftsBackloggedMessages:o("MAWTransactionMode").READWRITE,groupInfo:o("MAWTransactionMode").READONLY,messages:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE},"writeKeyChangeAdminMessage",function(e){return function(){return o("MAWDexieTable").dexieAll(f.map(function(t){return u(e).then(function(n){c(n,l)&&_.get(l)===o("WADbContact").TWO_WAY_CONTACT?o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,l,t,"update",i):o("MAWDexieTable").dexieResolve()})}))}})()]),h=g[1];return h}),_.apply(this,arguments)}l.saveDeviceChangeTransportEvent=d,l.writeMinosKeyChangeAdminMessage=p}),98);
__d("EBMinosWriteSecureStorageAlert",["EBMinosTypes","FBLogger","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWIndexedDb","MAWTransactionMode","MAWUnsafeCoerce","Promise","WAJids","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){var a=t.contactId,i=t.epochHead,l=t.epochHeadCreationTime,u=o("WAJids").validateDeviceJid(o("EBMinosTypes").userFbidToUserJid(o("EBMinosTypes").unsafeCastToUserFbId(a)));return u==null?(r("FBLogger")("wmi_minos").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Invalid deviceJid generated in writeMinosSecureStorageAlert"]))),(s||(s=n("Promise"))).resolve()):o("MAWIndexedDb").makeMsgrTransactor({deviceChangeAlerts:o("MAWTransactionMode").READWRITE},"writeMinosSecureStorageAlert",function(e){return function(){return o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:u,epochHead:i,identity:o("MAWUnsafeCoerce").unsafeCoerce(o("WASignalOther").toBytes(i,32)),isArchived:!1,model:"secure_storage",platform:"Meta",ts:l})}})()}l.writeMinosSecureStorageAlert=u}),98);
__d("EBOptOut",["EBAPIQPLPoints","EBDeps","EBSMAPI","Promise","ReQL","WAResultOrError","asyncToGeneratorRuntime","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("encryptedBackupsOptOutOfBackup").__setRef("EBOptOut");function u(t){var a=t.qplFlow;return new(e||(e=n("Promise")))(function(e,t){return void s.load().then((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){a.addPoint("eb_opt_out_get_db_start");var n=yield o("EBDeps").getDeps().getLSDB();a.addPoint("eb_opt_out_get_db_end"),r("promiseDone")(t.optOutOfBackupStoredProcedure(n),function(t){a.addPoint(o("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_SPROC_END);var i=n.tables.secure_encrypted_backups_client_state.subscribe(function(){r("promiseDone")(o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(n.tables.secure_encrypted_backups_client_state)),function(t){if(t!=null)if(t.length===0)r("promiseDone")(r("EBSMAPI").fetchBackupIds("useEncryptedBackupsOptOutOfBackupDeferred.react").finally(function(){a.addPoint(o("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_TASK_END),a.endSuccess(),i(),e(o("WAResultOrError").makeResult())}));else{a.addPoint(o("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_ROW_EXISTS);return}else a.addPoint(o("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_ROW_NULL),a.endFail("opt_out_backup_row_null"),i(),e(o("WAResultOrError").makeError("EB_OPT_OUT_CLIENT_STATE_NULL"))})})},function(){a.addPoint(o("EBAPIQPLPoints").EBOptOutQPLPoints.OPT_OUT_BACKUP_SPROC_FAIL),a.endFail("opt_out_backup_sproc_fail"),e(o("WAResultOrError").makeError("EB_OPT_OUT_SPROC_FAILURE"))})});return function(e){return t.apply(this,arguments)}})())})}l.ebOptOut=u}),98);
__d("LSGenerateLocalKeys",["LSArrayGetObjectAt","LSCreateAuthKeyPair.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][generateLocalKeys] Beginning execution."),r[1]=t.i64.of_float(Date.now()),e[0]?t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!0}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[29]=new t.Map,r[29].set("error_msg","Expected a nonempty query result"),r[29].set("code",t.i64.cast([0,3])),r[29].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[30]=t.createArray(),r[31]=(r[30].push(r[29]),r[30]),o=[void 0,r[30]],r[17]=o[0],r[18]=o[1]):(n=l.item,r[29]=new t.Map,r[29].set("backup_id",n.backupId),r[29].set("device_public_key_blob",n.devicePublicKeyBlob),r[29].set("device_private_key_blob",n.devicePrivateKeyBlob),r[29].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[29].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[29].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[29].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[29].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[29].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[29].set("orf_client_state_v2_blob",void 0),r[29].set("orf_v2_authority_level",void 0),r[29].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[29].set("device_id",n.deviceId),r[29].set("backup_tenancy",n.backupTenancy),r[29].set("encryption_version",n.encryptionVersion),r[29].set("revision_version",n.revisionVersion),r[29].set("initialize_restore_result",void 0),r[29].set("device_creation_timestamp_sec",void 0),r[29].set("authority_level",n.authorityLevel),a=[r[29],void 0],r[17]=a[0],r[18]=a[1])})},function(e){return r[20]=new t.Map,r[20].set("value",r[17]),r[20].set("errors",r[18]),r[21]=r[20].get("value"),r[21]!==void 0?t.sequence([function(e){return r[29]=r[21].get("backup_id"),r[30]=r[21].get("device_public_key_blob"),r[31]=r[21].get("device_private_key_blob"),r[32]=r[21].get("epoch_storage_public_key_blob"),r[33]=r[21].get("epoch_storage_private_key_blob"),r[34]=r[21].get("epoch_auth_public_key_blob"),r[35]=r[21].get("epoch_auth_private_key_blob"),r[36]=r[21].get("mailbox_root_key_blob"),r[37]=r[21].get("ocmf_client_state_blob"),r[38]=r[21].get("orf_client_state_v2_blob"),r[39]=r[21].get("orf_v2_authority_level"),r[40]=r[21].get("oblivious_validation_token_blob"),r[41]=r[21].get("device_id"),r[42]=r[21].get("backup_tenancy"),r[43]=r[21].get("encryption_version"),r[44]=r[21].get("revision_version"),r[45]=r[21].get("initialize_restore_result"),r[46]=r[21].get("device_creation_timestamp_sec"),r[47]=r[21].get("authority_level"),t.i64.neq(r[41],void 0)?t.sequence([function(e){return r[55]=void 0,t.i64.neq(r[55],void 0)?t.resolve(r[56]=r[55]):t.sequence([function(e){return r[59]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[60]=t[0],t})},function(e){return r[60]&&(r[69]=(r[59].push(t.i64.cast([0,0])),r[59])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[61]=t[0],t})},function(e){return r[61]&&(r[69]=(r[59].push(t.i64.cast([0,2])),r[59])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[62]=t[0],t})},function(e){return r[62]&&(r[69]=(r[59].push(t.i64.cast([0,3])),r[59])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[63]=t[0],t})},function(e){return r[63]&&(r[69]=(r[59].push(t.i64.cast([0,4])),r[59])),r[64]=t.createArray(),r[65]=t.i64.of_int32(r[59].length),t.i64.gt(r[65],t.i64.cast([0,0]))?t.loopAsync(r[65],function(e){return r[69]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[59],r[69]).then(function(e){var t;return t=e,r[70]=t[0],r[71]=t[1],t})},function(e){return r[72]=(r[64].push(r[70]),r[64])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[69]=t.createArray(),r[70]=t.i64.of_int32(r[64].length),t.i64.gt(r[70],t.i64.cast([0,0]))?t.loopAsync(r[70],function(e){return r[72]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[64],r[72]).then(function(e){var t;return t=e,r[73]=t[0],r[74]=t[1],t})},function(e){return r[75]=(r[69].push(t.i64.to_string(r[73])),r[69])}])}):t.resolve()},function(e){return r[71]=r[69].join(","),r[66]=r[71]}])},function(e){return r[64].some(function(e){return t.i64.eq(r[43],e)})?r[67]=r[43]:r[67]=void 0,t.i64.neq(r[67],void 0)?r[68]=r[67]:r[68]=void 0,r[56]=r[68]}])},function(e){var n;return t.i64.neq(r[56],void 0)?r[57]=r[56]:r[57]=t.i64.cast([0,0]),t.i64.neq(r[42],void 0)?r[58]=r[42]:r[58]=t.i64.cast([0,1]),n=[!0,r[30],r[31],r[32],r[33],r[34],r[35]],r[48]=n[0],r[49]=n[1],r[50]=n[2],r[51]=n[3],r[52]=n[4],r[53]=n[5],r[54]=n[6]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateLocalKeysStoredProcedure] Fetching keys locally failed. Reason: 24"),r[56]="Fetching keys locally failed. Reason: 24",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateLocalKeysStoredProcedure] ","",r[56]].join("")),r[55]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateLocalKeysStoredProcedure",r[56],r[55],t.i64.cast([0,3]))},function(e){var n;return n=[!1,t.blob("ZGV2aWNlX3B1YmxpY19rZXk="),t.blob("ZGV2aWNlX3ByaXZhdGVfa2V5"),t.blob("ZXBvY2hfc3RvcmFnZV9wdWJsaWNfa2V5"),t.blob("ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),t.blob("ZXBvY2hfYXV0aF9wdWJsaWNfa2V5"),t.blob("ZXBvY2hfYXV0aF9wcml2YXRlX2tleQ==")],r[48]=n[0],r[49]=n[1],r[50]=n[2],r[51]=n[3],r[52]=n[4],r[53]=n[5],r[54]=n[6],n}])},function(e){var t;return t=[r[48],r[49],r[50],r[51],r[52],r[53],r[54]],r[22]=t[0],r[23]=t[1],r[24]=t[2],r[25]=t[3],r[26]=t[4],r[27]=t[5],r[28]=t[6],t}]):t.sequence([function(e){return r[29]=r[20].get("errors"),r[30]=r[20].get("errors"),(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsGenerateLocalKeysStoredProcedure] Fetching keys locally failed. Reason: 1"),r[32]="Fetching keys locally failed. Reason: 1",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGenerateLocalKeysStoredProcedure] ","",r[32]].join("")),r[31]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateLocalKeysStoredProcedure",r[32],r[31],t.i64.cast([0,3]))},function(e){var n;return n=[!1,t.blob("ZGV2aWNlX3B1YmxpY19rZXk="),t.blob("ZGV2aWNlX3ByaXZhdGVfa2V5"),t.blob("ZXBvY2hfc3RvcmFnZV9wdWJsaWNfa2V5"),t.blob("ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),t.blob("ZXBvY2hfYXV0aF9wdWJsaWNfa2V5"),t.blob("ZXBvY2hfYXV0aF9wcml2YXRlX2tleQ==")],r[22]=n[0],r[23]=n[1],r[24]=n[2],r[25]=n[3],r[26]=n[4],r[27]=n[5],r[28]=n[6],n}])},function(e){var t;return t=[r[22],r[23],r[24],r[25],r[26],r[27],r[28]],r[2]=t[0],r[3]=t[1],r[4]=t[2],r[5]=t[3],r[6]=t[4],r[7]=t[5],r[8]=t[6],t}]):t.sequence([function(e){return t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,r[17]=t[0],r[18]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,r[19]=t[0],r[20]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateAuthKeyPair.nop")).then(function(e){var t;return t=e,r[21]=t[0],r[22]=t[1],t})},function(e){var t;return t=[!0,r[18],r[17],r[20],r[19],r[22],r[21]],r[2]=t[0],r[3]=t[1],r[4]=t[2],r[5]=t[3],r[6]=t[4],r[7]=t[5],r[8]=t[6],t}])},function(e){var o;return r[2]?t.sequence([function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[4],t.blob("MA=="),r[5]).then(function(e){var t;return t=e,r[17]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[4],t.blob("MQ=="),r[7]).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){var n;return r[19]=new t.Map,r[19].set("device_private_key",r[4]),r[19].set("device_public_key",r[3]),r[20]=new t.Map,r[20].set("epoch_storage_private_key",r[6]),r[20].set("epoch_storage_public_key",r[5]),r[21]=new t.Map,r[21].set("epoch_auth_private_key",r[8]),r[21].set("epoch_auth_public_key",r[7]),r[22]=new t.Map,r[22].set("device_key",r[19]),r[22].set("epoch_storage_key",r[20]),r[22].set("epoch_storage_public_key_sig",r[17]==null?t.blob("bnVsbA=="):r[17]),r[22].set("epoch_auth_key",r[21]),r[22].set("epoch_auth_public_key_sig",r[18]==null?t.blob("bnVsbA=="):r[18]),n=[r[22],void 0],r[9]=n[0],r[10]=n[1]}]):t.resolve((r[17]=new t.Map,r[17].set("error_code",t.i64.cast([0,9])),r[17].set("stored_procedure","LSEncryptedBackupsGenerateLocalKeysStoredProcedure"),r[17].set("error_message",""),o=[void 0,r[17]],r[9]=o[0],r[10]=o[1]))},function(e){return r[11]=t.i64.of_float(Date.now()),r[12]=t.i64.random(),r[14]="Finishing execution. Execution time: ",r[15]=t.i64.to_string(t.i64.sub(r[11],r[0])),r[16]=" ms",r[13]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][generateLocalKeys] ",r[13],r[14],r[13],r[15],r[13],r[16]].join("")),t.i64.eq(t.i64.mod_(r[12],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[17]=",",r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"generateLocalKeys",[r[14],r[17],r[15],r[17],r[16]].join(""),r[18],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[9],r[10]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsGenerateLocalKeysStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"],a.exports=e}),null);
__d("LSFinishAddPeerDevice",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateSignature_v2.nop","LSDeleteBackupOnClient","LSGenerateLocalKeys","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] Beginning execution."),t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[8]=t[0],t})},function(e){return r[8]?r[9]=!0:r[9]=!1,r[9]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[11]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[11]].join("")),r[10]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[11],r[10],t.i64.cast([0,3]))):t.resolve()}])},function(o){return t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))}).next().then(function(o,a){var i=o.done,l=o.value;return i?t.sequence([function(e){return t.db.table(168).fetch().next().then(function(e,r){var o=e.done,a=e.value;return o?0:(r=a.item,t.storedProcedure(n("LSDeleteBackupOnClient"),r.backupId,void 0,!1,void 0,"null",!0))})},function(o){return r[8]=e[0].get("backup_id"),t.storedProcedure(n("LSGenerateLocalKeys"),!1).then(function(e){var t;return t=e,r[9]=t[0],r[10]=t[1],t})},function(o){return r[9]!==void 0?t.sequence([function(e){return r[11]=r[9].get("device_key"),r[12]=r[9].get("epoch_storage_key"),r[13]=r[9].get("epoch_auth_key"),r[14]=r[11].get("device_private_key"),r[15]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[16]=t[0],t})},function(e){return r[16]&&(r[44]=(r[15].push(t.i64.cast([0,0])),r[15])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[17]=t[0],t})},function(e){return r[17]&&(r[44]=(r[15].push(t.i64.cast([0,2])),r[15])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){return r[18]&&(r[44]=(r[15].push(t.i64.cast([0,3])),r[15])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[19]=t[0],t})},function(e){return r[19]&&(r[44]=(r[15].push(t.i64.cast([0,4])),r[15])),r[20]="",r[21]=t.i64.of_int32(r[15].length),t.i64.gt(r[21],t.i64.cast([0,0]))?t.loopAsync(r[21],function(e){return r[44]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[15],r[44]).then(function(e){var t;return t=e,r[45]=t[0],r[46]=t[1],t})},function(e){return r[20]=[r[20],"_",t.i64.to_string(r[45])].join("")}])}):t.resolve()},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),["supported_versions_",r[20],"revision_version_",t.i64.to_string(t.i64.cast([0,1]))].join("")).then(function(e){var t;return t=e,r[22]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),r[14],t.blob("Mg=="),r[22]).then(function(e){var t;return t=e,r[23]=t[0],t})},function(e){return t.blobs.neq(r[23],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[23]).then(function(e){var t;return t=e,r[44]=t[0],t})},function(e){return r[24]=r[44]}]):t.resolve(r[24]=void 0)},function(o){return r[25]=e[0].get("temp_ocmf_client_state"),t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),r[25]).then(function(e){var t;return t=e,r[26]=t[0],r[27]=t[1],t})},function(e){var o;return t.blobs.neq(void 0,void 0)?t.sequence([function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),void 0).then(function(e){var t;return t=e,r[44]=t[0],r[45]=t[1],t})},function(e){var t;return t=[r[26],r[27],r[44],r[45]],r[28]=t[0],r[29]=t[1],r[30]=t[2],r[31]=t[3],t}]):t.resolve((o=[r[26],r[27],void 0,void 0],r[28]=o[0],r[29]=o[1],r[30]=o[2],r[31]=o[3],o))},function(n){return r[32]=r[11].get("device_public_key"),r[33]=r[11].get("device_private_key"),r[34]=r[12].get("epoch_storage_public_key"),r[35]=r[12].get("epoch_storage_private_key"),r[36]=r[13].get("epoch_auth_public_key"),r[37]=r[13].get("epoch_auth_private_key"),r[38]=e[0].get("mailbox_root_key"),r[39]=e[0].get("oblivious_validation_token"),t.forEach(t.filter(t.db.table(168).fetch([[[r[8]]]]),function(e){return t.i64.eq(e.backupId,r[8])&&t.i64.lt(e.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(e){return t.db.table(168).add({backupId:r[8],devicePublicKeyBlob:r[32],devicePrivateKeyBlob:r[33],epochStoragePublicKeyBlob:r[34],epochStoragePrivateKeyBlob:r[35],epochAuthPublicKeyBlob:r[36],epochAuthPrivateKeyBlob:r[37],mailboxRootKeyBlob:r[38],ocmfClientStateBlob:r[28],obliviousValidationTokenBlob:r[39],authorityLevel:t.i64.cast([0,20]),backupTenancy:t.i64.cast([0,1]),revisionVersion:t.i64.cast([0,1]),encryptionVersion:t.i64.cast([0,0])})},function(o){return r[40]=e[0].get("add_peer_epoch_data"),r[41]=t.i64.of_int32(r[40].length),t.i64.gt(r[41],t.i64.cast([0,0]))?t.loopAsync(r[41],function(e){return r[44]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[40],r[44]).then(function(e){var t;return t=e,r[45]=t[0],r[46]=t[1],t})},function(e){return r[47]=r[45].get("epoch_id"),r[48]=r[45].get("epoch_anon_id"),r[49]=r[45].get("epoch_root_key"),r[50]=r[45].get("epoch_status"),r[51]=r[45].get("epoch_head"),t.forEach(t.filter(t.db.table(169).fetch([[[r[47]]]]),function(e){return t.i64.eq(e.epochId,r[47])&&t.i64.lt(e.authorityLevel,t.i64.cast([0,80]))}),function(e){return e.delete()})},function(e){return t.db.table(169).add({epochId:r[47],authorityLevel:t.i64.cast([0,80]),backupId:r[8],epochAnonIdBlob:r[48],epochRootKeyBlob:r[49],epochStatus:r[50],epochHead:r[51]})}])}):t.resolve()},function(e){return t.count(t.db.table(169).fetch()).then(function(e){return r[42]=e})},function(e){return t.i64.le(r[42],t.i64.cast([0,1]))?t.sequence([function(e){return t.db.table(169).fetch().next().then(function(e,o){var a=e.done,i=e.value;return a?t.sequence([function(e){return r[46]="No epoch available in epochs table",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ","",r[46]].join("")),r[47]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",[r[46]].join(""),r[47],t.i64.cast([0,3]))},function(e){return r[44]=void 0}]):(o=i.item,r[46]=new t.Map,r[46].set("epoch_id",o.epochId),r[46].set("backup_id",o.backupId),r[46].set("epoch_anon_id_blob",o.epochAnonIdBlob),r[46].set("epoch_root_key_blob",o.epochRootKeyBlob),r[46].set("epoch_status",o.epochStatus),r[46].set("epoch_head",o.epochHead),r[46].set("authority_level",o.authorityLevel),r[44]=r[46])})},function(e){return r[43]=r[44]}]):t.sequence([function(e){return r[44]="Multiple epochs available in epochs table",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ","",r[44]].join("")),r[45]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",[r[44]].join(""),r[45],t.i64.cast([0,3]))},function(e){return r[43]=void 0}])},function(o){return r[43]!==void 0?t.sequence([function(e){return r[44]=r[43].get("epoch_anon_id_blob"),r[45]=r[43].get("epoch_root_key_blob"),r[46]=r[11].get("device_public_key"),r[47]=t.createArray(),r[51]=(r[47].push(t.i64.cast([0,32])),r[47]),t.nativeOperation(n("LSBase64Encode.nop"),r[44]).then(function(e){var t;return t=e,r[48]=t[0],t})},function(e){return r[48]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_devices","_",r[48]].join("")),void 0,r[45],r[47]).then(function(e){var t;return t=e,r[51]=t[0],t})},function(e){return r[51]?r[52]=!1:r[52]=!0,r[52]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),r[55]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",r[55]].join("")),r[54]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",r[55],r[54],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[56]=t[0],t})},function(e){return r[53]=r[56]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[51],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[54]=t[0],r[55]=t[1],t})},function(e){return r[53]=r[54]}])},function(e){return r[49]=r[53]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),r[52]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",r[52]].join("")),r[51]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",r[52],r[51],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,r[53]=t[0],t})},function(e){return r[49]=r[53]}])},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),r[49],r[46]).then(function(e){var t;return t=e,r[50]=t[0],t})},function(o){return t.blobs.neq(r[50],void 0)?t.sequence([function(e){return r[51]=r[11].get("device_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),r[51]).then(function(e){var t;return t=e,r[52]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[50]).then(function(e){var t;return t=e,r[53]=t[0],t})},function(e){return r[54]=r[43].get("epoch_root_key_blob"),t.blobs.neq(r[54],void 0)?t.sequence([function(e){return r[81]=t.createArray(),r[87]=(r[81].push(t.i64.cast([0,18])),r[81]),t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,r[54],r[81]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return r[82]!==void 0?t.sequence([function(e){return r[87]=t.i64.of_int32(r[82].length),t.i64.ge(r[87],t.i64.cast([0,1]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[82],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[89]=t[0],r[90]=t[1],t})},function(e){return r[88]=r[89]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),r[90]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",r[90]].join("")),r[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",r[90],r[89],t.i64.cast([0,3]))},function(e){return r[88]=void 0}])},function(e){return r[83]=r[88]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),r[88]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",r[88]].join("")),r[87]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",r[88],r[87],t.i64.cast([0,3]))},function(e){return r[83]=void 0}])},function(e){return t.blobs.neq(r[83],void 0)?r[84]=!0:r[84]=!1,r[84]||((function(e){t.logger(e).mustfix(e)})("LS::assert is failed. Attempting to coerce a null value to nonnull."),t.throw("LS::assert is failed. Attempting to coerce a null value to nonnull.")),t.nativeOperation(n("LSBase64Encode.nop"),r[83]).then(function(e){var t;return t=e,r[85]=t[0],t})},function(e){return r[85]!==void 0?r[86]=r[85]:r[86]="encodingfailed",r[55]=r[86]}]):t.resolve(r[55]="null")},function(e){return r[56]=r[12].get("epoch_storage_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),r[56]).then(function(e){var t;return t=e,r[57]=t[0],t})},function(e){return r[58]=r[9].get("epoch_storage_public_key_sig"),t.nativeOperation(n("LSBase64Encode.nop"),r[58]).then(function(e){var t;return t=e,r[59]=t[0],t})},function(e){return r[60]=r[13].get("epoch_auth_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),r[60]).then(function(e){var t;return t=e,r[61]=t[0],t})},function(e){return r[62]=r[9].get("epoch_auth_public_key_sig"),t.nativeOperation(n("LSBase64Encode.nop"),r[62]).then(function(e){var t;return t=e,r[63]=t[0],t})},function(o){return r[64]=r[11].get("device_private_key"),r[65]=e[0].get("mailbox_root_key"),r[66]=r[12].get("epoch_storage_private_key"),t.blobs.neq(r[65],void 0)?t.sequence([function(e){return r[81]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),r[65],"private_key",r[64],t.i64.cast([0,1]),r[81]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return t.blobs.neq(r[82],void 0)?r[83]=r[82]:r[83]=void 0,r[67]=r[83]}]):t.resolve(r[67]=void 0)},function(e){return t.blobs.neq(r[67],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[67]).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return r[68]=r[81]}]):t.resolve(r[68]=void 0)},function(e){return t.blobs.neq(r[65],void 0)?t.sequence([function(e){return r[81]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),r[65],"ocmf_client_state",r[28],t.i64.cast([0,1]),r[81]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return t.blobs.neq(r[82],void 0)?r[83]=r[82]:r[83]=void 0,r[69]=r[83]}]):t.resolve(r[69]=void 0)},function(e){return t.blobs.neq(r[69],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[69]).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return r[70]=r[81]}]):t.resolve(r[70]=void 0)},function(e){return t.blobs.neq(r[65],void 0)?t.sequence([function(e){return r[81]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),r[65],"epoch_storage_private_key",r[66],t.i64.cast([0,1]),r[81]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return t.blobs.neq(r[82],void 0)?r[83]=r[82]:r[83]=void 0,r[71]=r[83]}]):t.resolve(r[71]=void 0)},function(e){return t.blobs.neq(r[71],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[71]).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return r[72]=r[81]}]):t.resolve(r[72]=void 0)},function(o){return r[73]=e[0].get("backup_id"),t.nativeOperation(n("LSBase64Encode.nop"),r[29]).then(function(e){var t;return t=e,r[74]=t[0],t})},function(o){return r[75]=e[0].get("server_data_id"),r[76]=r[43].get("epoch_id"),r[77]=new t.Map,r[77].set("supported_encryption_versions",r[15]),r[77].set("client_version",t.i64.cast([0,1])),r[77].set("version_sig",r[24]==null?"":r[24]),r[78]=new t.Map,r[78].set("backup_id",r[73]),r[78].set("device_epoch_hmac",r[53]==null?"":r[53]),r[78].set("epoch_root_key_fingerprint",r[55]),r[78].set("device_public_key",r[52]==null?"":r[52]),r[78].set("epoch_auth_pubkey",r[61]==null?"":r[61]),r[78].set("epoch_auth_pubkey_sig",r[63]==null?"":r[63]),r[78].set("epoch_storage_pubkey",r[57]==null?"":r[57]),r[78].set("epoch_storage_pubkey_sig",r[59]==null?"":r[59]),r[78].set("ocmf_rotation_token",r[74]==null?"":r[74]),r[78].set("server_data_id",r[75]),r[78].set("device_registration_id",e[1]),r[78].set("base_epoch_id",r[76]),r[78].set("encryption_version_data",r[77]),r[78].set("private_key_debug_token",r[68]),r[78].set("ocmf_client_state_debug_token",r[70]),r[78].set("epoch_storage_pvtkey_debug_token",r[72]),r[78].set("trace_id",void 0),r[78].set("occam_only_eligible",!0),r[79]=t.toJSON(r[78]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50017]),r[79],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[80]=t[0],t})}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] $device_epoch_hmac found to be null"),r[51]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure","$device_epoch_hmac found to be null",r[51],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSDeleteBackupOnClient"),r[8],"backup_init_flow",!0,void 0,void 0,!1)},function(e){return t.forEach(t.db.table(169).fetch(),function(e){return e.delete()})}])}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] Error! There should be exactly one open epoch. Deleting local state and terminating device addition"),r[44]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure","Error! There should be exactly one open epoch. Deleting local state and terminating device addition",r[44],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSDeleteBackupOnClient"),r[8],"backup_init_flow",!0,void 0,void 0,!1)},function(e){return t.forEach(t.db.table(169).fetch(),function(e){return e.delete()})}])}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] Error! Error in generating the keys. Deleting local state and terminating device addition"),r[11]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure","Error! Error in generating the keys. Deleting local state and terminating device addition",r[11],t.i64.cast([0,3]))},function(e){return t.storedProcedure(n("LSDeleteBackupOnClient"),r[8],"backup_init_flow",!0,void 0,void 0,!1)},function(e){return t.forEach(t.db.table(169).fetch(),function(e){return e.delete()})}])}]):(a=l.item,r[8]="An authoritative row already exists, aborting execution of add peer device",r[8]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ","",r[8]].join("")),r[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",r[8],r[9],t.i64.cast([0,3]))):t.resolve())})},function(e){return r[2]=t.i64.of_float(Date.now()),r[3]=t.i64.random(),r[5]="Finishing execution. Execution time: ",r[6]=t.i64.to_string(t.i64.sub(r[2],r[0])),r[7]=" ms",r[4]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure] ",r[4],r[5],r[4],r[6],r[4],r[7]].join("")),t.i64.eq(t.i64.mod_(r[3],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[8]=",",r[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",[r[5],r[8],r[6],r[8],r[7]].join(""),r[9],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsFinishAddPeerDeviceStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"],a.exports=e}),null);
__d("MWPakeQPLEvents",["qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=r("qpl")._(231349365,"1751");l.pakeInitiatorQplEvent=e}),98);
__d("PAKEMessageQplLoggingAction",[],(function(t,n,r,o,a,i){var e=Object.freeze({ADD_MARKER:0,END_SUCCESS:1,END_FAILURE:2,ADD_ERROR_ANNOTATION:3});i.default=e}),66);
__d("LSQplInteractionHelper.nop",["FBLogger","I64","MWPakeQPLEvents","PAKEMessageQplLoggingAction","Promise","QPLUserFlow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(a,i,l,u,c){var t=(s||(s=o("I64"))).to_int32(u);switch(t){case r("PAKEMessageQplLoggingAction").ADD_MARKER:l==null?r("FBLogger")("wmi_eb").mustfix("PAKE: markerName is null when adding DS PAKE marker."):r("QPLUserFlow").addPoint(o("MWPakeQPLEvents").pakeInitiatorQplEvent,l);break;case r("PAKEMessageQplLoggingAction").END_FAILURE:l==null?r("FBLogger")("wmi_eb").mustfix("PAKE: markerName is null when adding failure DS PAKE marker."):r("QPLUserFlow").endFailure(o("MWPakeQPLEvents").pakeInitiatorQplEvent,l);break;case r("PAKEMessageQplLoggingAction").END_SUCCESS:r("QPLUserFlow").endSuccess(o("MWPakeQPLEvents").pakeInitiatorQplEvent);break;case r("PAKEMessageQplLoggingAction").ADD_ERROR_ANNOTATION:c==null?r("FBLogger")("wmi_eb").mustfix("PAKE: pakeMessageType is null when annotating PAKE error."):r("QPLUserFlow").addAnnotations(o("MWPakeQPLEvents").pakeInitiatorQplEvent,{int:{errorCode:(s||(s=o("I64"))).to_int32(c)}});break}return(e||(e=n("Promise"))).resolve()};u.__nop_name__="LSQplInteractionHelper",l.default=u}),98);
__d("LSDeserializeSecretsAndAddDevice",["LSArrayGetObjectAt","LSBase64Decode.nop","LSDeserializeFromJsonIntoDictionaryV2.nop","LSFinishAddPeerDevice","LSQplInteractionHelper.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return t.nativeOperation(n("LSQplInteractionHelper.nop"),"MEB_DS_DESERIALIZE_SECRETS_NATIVE_OP_START",t.i64.cast([0,0]),void 0)},function(o){return t.nativeOperation(n("LSDeserializeFromJsonIntoDictionaryV2.nop"),e[0]).then(function(e){var t;return t=e,r[0]=t[0],t})},function(e){return t.nativeOperation(n("LSQplInteractionHelper.nop"),"MEB_DS_DESERIALIZE_SECRETS_NATIVE_OP_END",t.i64.cast([0,0]),void 0)},function(e){return r[1]=r[0].get("temp_ocmf_client_state"),t.nativeOperation(n("LSBase64Decode.nop"),r[1]).then(function(e){var t;return t=e,r[2]=t[0],t})},function(e){return r[3]=r[0].get("mailbox_root_key"),t.nativeOperation(n("LSBase64Decode.nop"),r[3]).then(function(e){var t;return t=e,r[4]=t[0],t})},function(e){return r[5]=r[0].get("oblivious_validation_token"),t.nativeOperation(n("LSBase64Decode.nop"),r[5]).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return r[7]=t.createArray(),r[8]=r[0].get("add_peer_epoch_data_serializable"),r[9]=t.i64.of_int32(r[8].length),t.i64.gt(r[9],t.i64.cast([0,0]))?t.loopAsync(r[9],function(e){return r[14]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[8],r[14]).then(function(e){var t;return t=e,r[15]=t[0],r[16]=t[1],t})},function(e){return r[17]=r[15].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Decode.nop"),r[17]).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){return r[19]=r[15].get("epoch_root_key"),t.nativeOperation(n("LSBase64Decode.nop"),r[19]).then(function(e){var t;return t=e,r[20]=t[0],t})},function(e){return r[21]=r[15].get("epoch_id"),r[22]=r[15].get("epoch_status"),r[23]=new t.Map,r[23].set("epoch_id",r[21]),r[23].set("epoch_anon_id",r[18]==null?t.blob(""):r[18]),r[23].set("epoch_root_key",r[20]==null?t.blob(""):r[20]),r[23].set("epoch_status",r[22]),r[24]=r[15].get("epoch_head"),r[24]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSBase64Decode.nop"),r[24]).then(function(e){var t;return t=e,r[25]=t[0],t})},function(e){return r[23].set("epoch_head",r[25])}]):t.resolve()},function(e){return r[25]=(r[7].push(r[23]),r[7])}])}):t.resolve()},function(o){return r[10]=r[0].get("backup_id"),r[11]=r[0].get("server_data_id"),r[12]=new t.Map,r[12].set("backup_id",r[10]),r[12].set("server_data_id",r[11]),r[12].set("temp_ocmf_client_state",r[2]==null?t.blob(""):r[2]),r[12].set("mailbox_root_key",r[4]==null?t.blob(""):r[4]),r[12].set("oblivious_validation_token",r[6]==null?t.blob(""):r[6]),r[12].set("add_peer_epoch_data",r[7]),r[12]!==void 0?t.sequence([function(o){return t.storedProcedure(n("LSFinishAddPeerDevice"),r[12],e[1])},function(e){return r[13]=!0}]):t.resolve(r[13]=!1)},function(e){return o[0]=r[13]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsDeserializeSecretsAndAddDeviceStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSDeserializeSecretsAndAddDeviceStoredProcedure",["LSDeserializeSecretsAndAddDevice","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSDeserializeSecretsAndAddDevice"),a.serializedPayload,a.deviceRegistrationId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("EBOtcAddDevice",["EBAPIQPLPoints","EBDeps","EBLogger","EBMainThreadEBDBApiDeferred","I64","LSDeserializeSecretsAndAddDeviceStoredProcedure","LSEncryptedBackupsRecoveryCodeStatus","LSFactory","LSIntEnum","Promise","ReQL","WAResultOrError","asyncToGeneratorRuntime","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.initiatorId,i=t.qplFlow,l=t.secrets,c=function(){};i.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_START);var d=yield o("EBDeps").getDeps().getLSDB();return i.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_WAIT_FOR_EBLS_END),i.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SPROC_START),new(u||(u=n("Promise")))(function(t,n){return d.runInTransaction(function(e){return r("LSDeserializeSecretsAndAddDeviceStoredProcedure")(r("LSFactory")(e),{deviceRegistrationId:a,serializedPayload:l})},"readwrite").then(function(n){var a=n[0];if(i.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SPROC_END),!a)return i.endFail(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SPROC_FAILURE),t(m("OTC_ADD_DEVICE_SPROC_FAILURE"));c=o("ReQL").fromTableAscending(d.tables.secure_encrypted_backups_recovery_code_status).subscribe(function(n,a){if(a.operation==="add"||a.operation==="put"){c();var l=a.value.recoveryCodeStatus;if((e||(e=o("I64"))).equal(l,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsRecoveryCodeStatus").VALID)))i.addPoint(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SUCCESS),i.endSuccess(),o("EBMainThreadEBDBApiDeferred").addNewDevice(),t(m("SUCCESS"));else if((e||(e=o("I64"))).equal(l,(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR)))i.endFail(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_SYSTEM_ERROR),o("EBLogger").EBLogger().mustfix("PAKE: LSEncryptedBackupsFinishAddPeerDeviceTask task failed"),t(m("OTC_ADD_DEVICE_SYSTEM_ERROR"));else{var u="PAKE: Unexpected recovery code status: "+(e||(e=o("I64"))).to_int32(l);i.endFail(o("EBAPIQPLPoints").EBAddDeviceQPLPoints.OTC_ADD_DEVICE_UNEXPECTED_RECOVERY_CODE_STATUS,{string:{errorMessage:u}}),o("EBLogger").EBLogger("wmi_eb").mustfix(u),t(m("OTC_ADD_DEVICE_UNEXPECTED_RECOVERY_CODE_STATUS",u))}}})}).catch(function(e){c(),t(m("OTC_ADD_DEVICE_SPROC_ERROR",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)))})})}),d.apply(this,arguments)}function m(e,t){return e==="SUCCESS"?o("WAResultOrError").makeResult():o("WAResultOrError").makeError({errorMessage:t,status:e})}l.otcAddDevice=c}),98);
__d("EBParseUploadSerializationPayload",["EBLogger","MAWEBUploadTrackingUtils","WAErrorMessage","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("EBLogger").EBLogger().tags(["parseUploadSerializationResponse"]);function c(t){try{var n=JSON.parse(t);return o("WAResultOrError").makeResult(n)}catch(t){var r=o("WAErrorMessage").maybeGetMessageFromError(t);return u.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["parseUploadSerializationResponse: ",""])),r),o("WAResultOrError").makeError("parse_exception")}}function d(e,t,n){var r=[],a=[];if(e.forEach(function(e){var n=e.error_code+": "+e.error_message;u.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["EB upload "," serializer error: ",""])),t,n),r.push(e.error_code),a.push(e.error_message)}),n!=null){var i,l;o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,t+"_upload_task_serialization_failure",{int_array:(i={},i[t+"_serialization_error_codes"]=r,i),string_array:(l={},l[t+"_serialization_errors"]=a,l)})}}l.parseUploadSerializationResponse=c,l.logUploadSerializationErrors=d}),98);
__d("EBPrewarmSenderUploadQueue",["EBSenderUploadQueue"],(function(t,n,r,o,a,i,l){"use strict";function e(){o("EBSenderUploadQueue").ebSenderUploadQueue()}l.prewarmSenderUploadQueue=e}),98);
__d("EBRepairEpochQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="25352669137720538"}),null);
__d("EBRepairEpochQuery.graphql",["EBRepairEpochQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"input"}],t=[{alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null}],r={alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:[{kind:"Variable",name:"request",variableName:"input"}],concreteType:"XFBRepairEpochResponse",kind:"LinkedField",name:"repair_epoch",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"target_device_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_sync_reason",storageKey:null},{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:t,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:t,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null},{alias:null,args:null,concreteType:"XFBMinosEpoch",kind:"LinkedField",name:"to_minos_epoch",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"self_epoch_signature",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"error_code",storageKey:null}],storageKey:null}],storageKey:null};return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"EBRepairEpochQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[r],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"EBRepairEpochQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[r,{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:n("EBRepairEpochQuery_facebookRelayOperation"),metadata:{},name:"EBRepairEpochQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("EBRepairEpochQuery",["EBRepairEpochQuery.graphql","WAResultOrError","asyncToGeneratorRuntime","createWorkerQuery"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a,i=e!==void 0?e:e=n("EBRepairEpochQuery.graphql"),l=yield r("createWorkerQuery")(i,{input:t}),s=l==null||(a=l.viewer)==null||(a=a.encrypted_backup)==null||(a=a.mailbox)==null?void 0:a.repair_epoch;return(s==null?void 0:s.is_success)===!0&&(s==null?void 0:s.epoch_derivation_set)!=null?o("WAResultOrError").makeResult(s.epoch_derivation_set):(s==null?void 0:s.exception_string)!=null?o("WAResultOrError").makeError({errorCode:s.error_code,message:s.exception_string}):o("WAResultOrError").makeError({message:"Repair epoch failed"})}),u.apply(this,arguments)}l.RepairEpochQuery=s}),98);
__d("EBRepairEpochs",["Base64Utils","EBAPIQPLPoints","EBDeps","EBDeriveAndStoreEpochs","EBEpochUtils","EBGetClientState","EBRepairEpochQuery","I64","LSAuthorityLevel","LSIntEnum","Promise","QPLFlow","Random","ReQL","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("EBDeps").getDeps().getLSDB(),a=o("Random").uint32(),i=String(a),l=o("QPLFlow").startQPLFlow(r("qpl")._(521474335,"1476"),{annotations:{string:{traceId:i}},instanceKey:a});try{l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.GET_CLIENT_STATE_START);var c=yield o("EBGetClientState").getClientState(t);if(l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.GET_CLIENT_STATE_END),c==null)return l.endFail("client_state_is_missing"),o("WAResultOrError").makeError({message:"Client state is missing"});var d=c.backupId,m=c.deviceId;if(d==null||m==null)return l.endFail("backup_id_or_device_id_is_missing"),o("WAResultOrError").makeError({message:"Backup ID or device ID is missing"});l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.GET_EPOCHS_START);var p=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_epochs));l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.GET_EPOCHS_END);var _=yield(u||(u=n("Promise"))).all(p.filter(function(t){return(e||(e=o("I64"))).equal(t.authorityLevel,(s||(s=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}).map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield o("EBEpochUtils").getFingerPrint(t.epochRootKeyBlob,"MEBEpochRootKey");return{epoch_id:(e||(e=o("I64"))).to_string(t.epochId),fingerprint:{sensitive_string_value:o("Base64Utils").fromArrayBuffer(n)}}});return function(e){return t.apply(this,arguments)}})()));l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.REPAIR_EPOCH_QUERY_START);var f=yield o("EBRepairEpochQuery").RepairEpochQuery({backup_id:d,device_id:m,locally_available_epochs:_,trace_id:i});if(l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.REPAIR_EPOCH_QUERY_END),!f.success){var g;return l.endFail("repair_epoch_query_failed",{string:{error_code:String((g=f.error.errorCode)!=null?g:"none"),error_message:f.error.message}}),f}return l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.DERIVE_AND_STORE_EPOCHS_START),yield o("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(t,f.value),l.addPoint(o("EBAPIQPLPoints").EBRepairEpochsQPLPoints.DERIVE_AND_STORE_EPOCHS_END),l.endSuccess(),f}catch(e){var h=r("getErrorSafe")(e);return l.endFail("runtime_error",{string:{error_message:h.message}}),o("WAResultOrError").makeError({message:h.message})}}),d.apply(this,arguments)}l.EBRepairEpochs=c}),98);
__d("LSGetRemoveVirtualDeviceRequestStatus",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return t.islc(t.filter(t.db.table(184).fetch(),function(n){return t.blobs.eq(n.virtualDeviceId,e[0])}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(o,a){var i=o.done,l=o.value;return i?r[0]=t.i64.cast([0,3]):(a=l.item,t.sequence([function(o){return r[3]=a.removalStatus,t.i64.eq(r[3],t.i64.cast([0,1]))?t.resolve(r[2]=t.i64.cast([0,1])):t.sequence([function(o){return t.i64.eq(r[3],t.i64.cast([0,2]))?t.resolve(r[4]=t.i64.cast([0,0])):t.sequence([function(o){return t.i64.eq(r[3],t.i64.cast([0,3]))?t.resolve(r[5]=t.i64.cast([0,2])):t.sequence([function(o){return r[6]=["Unknown RemoveVirtualDeviceStatus found ",t.i64.to_string(r[3])].join(""),r[6]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsGetRemoveVirtualDeviceRequestStatusStoredProcedure] ","",r[6]].join("")),r[7]=t.createArray(),e[1]!==void 0&&(r[8]=(r[7].push(e[1]),r[7])),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetRemoveVirtualDeviceRequestStatusStoredProcedure",r[6],r[7],t.i64.cast([0,3]))):t.resolve()},function(e){return r[5]=t.i64.cast([-1,4294967295])}])},function(e){return r[4]=r[5]}])},function(e){return r[2]=r[4]}])},function(e){return r[0]=r[2]}]))})},function(e){return o[0]=r[0]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsGetRemoveVirtualDeviceRequestStatusStoredProcedure",e.__tables__=["encrypted_backups_virtual_devices"],a.exports=e}),null);
__d("LSGetRemoveVirtualDeviceRequestStatusStoredProcedure",["LSGetRemoveVirtualDeviceRequestStatus","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSGetRemoveVirtualDeviceRequestStatus"),a.virtualDeviceId,a.traceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSRemoveVirtualDevice",["LSAppendDataTraceAddon","LSBase64Encode.nop","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[5]=t[0],t})},function(e){return r[5]?r[6]=!0:r[6]=!1,r[6]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[8]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[8]].join("")),r[7]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[8],r[7],t.i64.cast([0,3]))):t.resolve()}])},function(n){return e[1]!==void 0?r[0]=e[1]:r[0]="vd_removal:remove_vd_task",t.islc(t.filter(t.db.table(184).fetch(),function(n){return t.blobs.eq(n.virtualDeviceId,e[0])}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[void 0,void 0],r[1]=n[0],r[2]=n[1],n):(t=i.item,o=[t.pk,t.backupId],r[1]=o[0],r[2]=o[1])})},function(o){return t.i64.neq(r[2],void 0)?t.sequence([function(o){return t.nativeOperation(n("LSBase64Encode.nop"),e[0]).then(function(e){var t;return t=e,r[5]=t[0],t})},function(e){return r[6]=new t.Map,r[6].set("backup_id",r[2]),r[6].set("virtual_device_id",r[5]==null?"":r[5]),r[6].set("removal_reason",r[0]),r[6].set("trace_id",void 0),r[7]=t.toJSON(r[6]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",t.i64.cast([0,50024]),r[7],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[8]=t[0],t})},function(e){return t.i64.neq(r[1],void 0)?t.forEach(t.db.table(184).fetch([[[r[1]]]]),function(e){var n=e.update,r=e.item;return n({removalStatus:t.i64.cast([0,2])})}):t.resolve()},function(e){return r[4]=t.i64.cast([0,0])}]):t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return r[6]?r[7]=!0:r[7]=!1,r[7]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[9]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[9]].join("")),r[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[9],r[8],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[5]="Backup not found",r[5]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsRemoveVirtualDeviceStoredProcedure] ","",r[5]].join("")),r[6]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsRemoveVirtualDeviceStoredProcedure",r[5],r[6],t.i64.cast([0,3]))):t.resolve()},function(e){return r[4]=t.i64.cast([0,1])}])},function(e){return o[0]=r[4]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsRemoveVirtualDeviceStoredProcedure",e.__tables__=["encrypted_backups_virtual_devices"],a.exports=e}),null);
__d("LSRemoveVirtualDeviceStoredProcedure",["LSRemoveVirtualDevice","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSRemoveVirtualDevice"),a.virtualDeviceId,a.removalReason,a.traceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("EBRevokeVirtualDevice",["Base64Utils","EBAPIQPLPoints","EBDeps","I64","LSEncryptedBackupsOpStatus","LSFactory","LSGetRemoveVirtualDeviceRequestStatusStoredProcedure","LSIntEnum","LSRemoveVirtualDeviceStoredProcedure","Promise","WAResultOrError","asyncToGeneratorRuntime","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){var i,l=function(){},c=(i=a.getQPLAttrs().instanceKey.toString())!=null?i:"";a.addPoint(o("EBAPIQPLPoints").EBRevokeVirtualDeviceQPLPoints.REVOKE_VIRTUAL_DEVICE_DB_START);var d=yield o("EBDeps").getDeps().getLSDB();a.addPoint(o("EBAPIQPLPoints").EBRevokeVirtualDeviceQPLPoints.REVOKE_VIRTUAL_DEVICE_DB_END);var m=o("Base64Utils").toArrayBuffer(t),p=function(t){return d.runInTransaction(function(e){return r("LSGetRemoveVirtualDeviceRequestStatusStoredProcedure")(r("LSFactory")(e),{traceId:c,virtualDeviceId:t})},"readonly").then(function(e){return e[0]})};return d.runInTransaction(function(e){return r("LSRemoveVirtualDeviceStoredProcedure")(r("LSFactory")(e),{traceId:c,virtualDeviceId:m})},"readwrite").then(function(t){var i=t[0];return(s||(s=o("I64"))).equal(i,(u||(u=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").SUCCESS))?new(e||(e=n("Promise")))(function(e,t){l=d.tables.encrypted_backups_virtual_devices.subscribe(function(){p(m).then(function(t){switch((u||(u=o("LSIntEnum"))).toNumber(t)){case 0:return;case 2:case-1:l(),a.endFail(o("EBAPIQPLPoints").EBRevokeVirtualDeviceQPLPoints.REVOKE_VIRTUAL_DEVICE_STATUS_INTERNAL_ERROR),e(o("WAResultOrError").makeError("REVOKE_VIRTUAL_DEVICE_GET_STATUS_INTERNAL_ERROR"));return;case 1:case 3:l(),a.endSuccess(),e(o("WAResultOrError").makeResult());return}}).catch(function(t){l(),a.endFail(o("EBAPIQPLPoints").EBRevokeVirtualDeviceQPLPoints.REVOKE_VIRTUAL_DEVICE_DB_ERROR,{string:{errorMessage:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(t)}}),e(o("WAResultOrError").makeError("REVOKE_VIRTUAL_DEVICE_GET_SPROC_ERROR"))})})}):(l(),a.endFail(o("EBAPIQPLPoints").EBRevokeVirtualDeviceQPLPoints.REVOKE_VIRTUAL_DEVICE_SPROC_FAILURE),o("WAResultOrError").makeError("REVOKE_VIRTUAL_DEVICE_SPROC_FAILURE"))},function(e){return l(),a.endFail(o("EBAPIQPLPoints").EBRevokeVirtualDeviceQPLPoints.REVOKE_VIRTUAL_DEVICE_SPROC_ERROR,{string:{errorMessage:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}}),o("WAResultOrError").makeError("REVOKE_VIRTUAL_DEVICE_SPROC_FAILURE")})}),d.apply(this,arguments)}l.revokeVirtualDevice=c}),98);
__d("EBSetRestoreStatusForInitialRestore",["I64","LSEncryptedBackupsClientRestoreState","LSIntEnum","Promise","ReQL","WAJids","asyncToGeneratorRuntime","performanceAbsoluteNow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){var l=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(a.tables.encrypted_backups_client_restore_status).map(function(e){var t=e.threadId;return t}));return a.runInTransaction((function(){var a=n("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var i=[],d=[];l.forEach(function(e){i.push(a.encrypted_backups_client_restore_status.delete(e))}),yield(c||(c=n("Promise"))).all(i),t.forEach(function(t){d.push(a.encrypted_backups_client_restore_status.put({lastUpdated:(u||(u=o("I64"))).of_float((e||(e=r("performanceAbsoluteNow")))()),restoreStatus:(s||(s=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsClientRestoreState").RESTORE_IN_PROGRESS),threadId:o("WAJids").threadIdForChatJid(t)}))}),yield c.all(d)});return function(e){return a.apply(this,arguments)}})(),"readwrite",void 0,void 0,i.id+":37")}),m.apply(this,arguments)}function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(e.tables.encrypted_backups_client_restore_status).map(function(e){var t=e.threadId;return t}));return e.runInTransaction((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var r=[];t.forEach(function(t){r.push(e.encrypted_backups_client_restore_status.delete(t))}),yield(c||(c=n("Promise"))).all(r)});return function(t){return e.apply(this,arguments)}})(),"readwrite",void 0,void 0,i.id+":75")}),_.apply(this,arguments)}l.setRestoreStatusForInitialRestore=d,l.resetClientRestoreStatus=p}),98);
__d("LSSyncEpochs",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(e){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] Beginning execution."),t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[13]=t[0],t})},function(e){return r[13]?r[14]=!0:r[14]=!1,r[14]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[16]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[16]].join("")),r[15]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[16],r[15],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!1}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[13]=new t.Map,r[13].set("error_msg","Expected a nonempty query result"),r[13].set("code",t.i64.cast([0,3])),r[13].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[14]=t.createArray(),r[15]=(r[14].push(r[13]),r[14]),o=[void 0,r[14]],r[1]=o[0],r[2]=o[1]):(n=l.item,r[13]=new t.Map,r[13].set("backup_id",n.backupId),r[13].set("device_public_key_blob",n.devicePublicKeyBlob),r[13].set("device_private_key_blob",n.devicePrivateKeyBlob),r[13].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[13].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[13].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[13].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[13].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[13].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[13].set("orf_client_state_v2_blob",void 0),r[13].set("orf_v2_authority_level",void 0),r[13].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[13].set("device_id",n.deviceId),r[13].set("backup_tenancy",n.backupTenancy),r[13].set("encryption_version",n.encryptionVersion),r[13].set("revision_version",n.revisionVersion),r[13].set("initialize_restore_result",void 0),r[13].set("device_creation_timestamp_sec",void 0),r[13].set("authority_level",n.authorityLevel),a=[r[13],void 0],r[1]=a[0],r[2]=a[1])})},function(e){return r[4]=new t.Map,r[4].set("value",r[1]),r[4].set("errors",r[2]),r[5]=r[4].get("value"),r[5]!==void 0?t.sequence([function(e){return r[13]=r[5].get("backup_id"),r[14]=r[5].get("device_public_key_blob"),r[15]=r[5].get("device_private_key_blob"),r[16]=r[5].get("epoch_storage_public_key_blob"),r[17]=r[5].get("epoch_storage_private_key_blob"),r[18]=r[5].get("epoch_auth_public_key_blob"),r[19]=r[5].get("epoch_auth_private_key_blob"),r[20]=r[5].get("mailbox_root_key_blob"),r[21]=r[5].get("ocmf_client_state_blob"),r[22]=r[5].get("orf_client_state_v2_blob"),r[23]=r[5].get("orf_v2_authority_level"),r[24]=r[5].get("oblivious_validation_token_blob"),r[25]=r[5].get("device_id"),r[26]=r[5].get("backup_tenancy"),r[27]=r[5].get("encryption_version"),r[28]=r[5].get("revision_version"),r[29]=r[5].get("initialize_restore_result"),r[30]=r[5].get("device_creation_timestamp_sec"),r[31]=r[5].get("authority_level"),t.i64.neq(r[25],void 0)?t.sequence([function(e){return r[33]=void 0,t.i64.neq(r[33],void 0)?t.resolve(r[34]=r[33]):t.sequence([function(e){return r[41]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[42]=t[0],t})},function(e){return r[42]&&(r[51]=(r[41].push(t.i64.cast([0,0])),r[41])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[43]=t[0],t})},function(e){return r[43]&&(r[51]=(r[41].push(t.i64.cast([0,2])),r[41])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[44]=t[0],t})},function(e){return r[44]&&(r[51]=(r[41].push(t.i64.cast([0,3])),r[41])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[45]=t[0],t})},function(e){return r[45]&&(r[51]=(r[41].push(t.i64.cast([0,4])),r[41])),r[46]=t.createArray(),r[47]=t.i64.of_int32(r[41].length),t.i64.gt(r[47],t.i64.cast([0,0]))?t.loopAsync(r[47],function(e){return r[51]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[41],r[51]).then(function(e){var t;return t=e,r[52]=t[0],r[53]=t[1],t})},function(e){return r[54]=(r[46].push(r[52]),r[46])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[51]=t.createArray(),r[52]=t.i64.of_int32(r[46].length),t.i64.gt(r[52],t.i64.cast([0,0]))?t.loopAsync(r[52],function(e){return r[54]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[46],r[54]).then(function(e){var t;return t=e,r[55]=t[0],r[56]=t[1],t})},function(e){return r[57]=(r[51].push(t.i64.to_string(r[55])),r[51])}])}):t.resolve()},function(e){return r[53]=r[51].join(","),r[48]=r[53]}])},function(e){return r[46].some(function(e){return t.i64.eq(r[27],e)})?r[49]=r[27]:r[49]=void 0,t.i64.neq(r[49],void 0)?r[50]=r[49]:r[50]=void 0,r[34]=r[50]}])},function(e){return t.i64.neq(r[34],void 0)?r[35]=r[34]:r[35]=t.i64.cast([0,0]),t.i64.neq(r[26],void 0)?r[36]=r[26]:r[36]=t.i64.cast([0,1]),t.filter(t.db.table(2).fetch(),function(e){return e.context==="50013"}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[37]=!1:(t=o.item,r[37]=!0)})},function(e){return t.filter(t.db.table(2).fetch(),function(e){return e.context==="50025"}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[39]=!1:(t=o.item,r[39]=!0)})},function(e){return r[37]||r[39]?(r[41]="Another sync job is already in progress. Terminating this.",r[41]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",r[41]].join("")),r[42]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",r[41],r[42],t.i64.cast([0,3]))):t.resolve()):t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[49]=t[0],t})},function(e){return r[49]?r[50]=!0:r[50]=!1,r[50]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[52]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[52]].join("")),r[51]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[52],r[51],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[41]=t.createArray(),t.forEach(t.filter(t.db.table(169).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))}),function(e){var t=e.item;return r[49]=(r[41].push(t.epochId),r[41])})},function(e){return r[47]="Queried locally available epochs. Count: ",r[42]=t.i64.of_int32(r[41].length),r[48]=t.i64.to_string(r[42]),r[43]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][MEBEpochClientUtils] ",r[43],r[47],r[43],r[48]].join("")),t.resolve()},function(e){return r[44]=new t.Map,r[44].set("backup_id",r[13]),r[44].set("device_id",r[25]),r[44].set("locally_available_epochs",r[41]),r[44].set("trace_id",void 0),r[45]=t.toJSON(r[44]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_encrypted_backups",t.i64.cast([0,50025]),r[45],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[46]=t[0],t})}])},function(e){return r[32]=!0}]):t.sequence([function(e){return r[33]=["Failed to load client state: ","","NULL_DEVICE_ID"].join(""),r[33]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",r[33]].join("")),r[34]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",r[33],r[34],t.i64.cast([0,3]))):t.resolve()},function(e){return r[32]=!1}])},function(e){return r[6]=r[32]}]):t.sequence([function(e){return r[13]=r[4].get("errors"),r[14]=r[4].get("errors"),r[15]=["Failed to load client state: ","","BACKUP_NOT_FOUND"].join(""),r[15]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ","",r[15]].join("")),r[16]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",r[15],r[16],t.i64.cast([0,3]))):t.resolve()},function(e){return r[6]=!1}])},function(e){return r[7]=t.i64.of_float(Date.now()),r[8]=t.i64.random(),r[10]="Finishing execution. Execution time: ",r[11]=t.i64.to_string(t.i64.sub(r[7],r[0])),r[12]=" ms",r[9]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsSyncEpochsStoredProcedure] ",r[9],r[10],r[9],r[11],r[9],r[12]].join("")),t.i64.eq(t.i64.mod_(r[8],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[13]=",",r[14]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSyncEpochsStoredProcedure",[r[10],r[13],r[11],r[13],r[12]].join(""),r[14],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsSyncEpochsStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","pending_tasks","secure_encrypted_backups_epochs"],a.exports=e}),null);
__d("LSSyncEpochsStoredProcedure",["LSSyncEpochs","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t){var a=t.storedProcedure(r("LSSyncEpochs"));return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}l.default=s}),98);
__d("EBSyncEpochs",["EBAPIQPLPoints","EBDeps","LSFactory","LSSyncEpochsStoredProcedure","Promise","QPLFlow","Random","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Map;function u(e,t){if(t==null){for(var n of s.entries()){var r=n[0],a=n[1];a.unsub(),window.clearTimeout(a.timeout),a.resolve(o("WAResultOrError").makeError(e)),s.delete(r)}return}var i=s.get(t);i!=null&&(i.unsub(),window.clearTimeout(i.timeout),i.resolve(o("WAResultOrError").makeError(e)),s.delete(t))}function c(){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("EBDeps").getDeps().getLSDB(),a,l=o("Random").uint32(),u=String(l),c=o("QPLFlow").startQPLFlow(r("qpl")._(521475098,"1328"),{annotations:{string:{traceId:u}},instanceKey:l});return new(e||(e=n("Promise")))((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,n){var l=t.tables.secure_encrypted_backups_epochs.subscribe(function(t,n){if(n.operation!=="delete")return l(),window.clearTimeout(a),s.delete(u),c.endSuccess(),e(o("WAResultOrError").makeResult())});c.addPoint(o("EBAPIQPLPoints").EBSyncEpochsQPLPoints.SYNC_EPOCH_SPROC_START),yield t.runInTransaction(function(e){return r("LSSyncEpochsStoredProcedure")(r("LSFactory")(e))},"readwrite",void 0,void 0,i.id+":95").then(function(){c.addPoint(o("EBAPIQPLPoints").EBSyncEpochsQPLPoints.SYNC_EPOCH_SPROC_END),a=window.setTimeout(function(){return s.delete(u),c.endFail(o("EBAPIQPLPoints").EBSyncEpochsQPLPoints.SYNC_EPOCH_TIMEOUT),n(o("WAResultOrError").makeError("timeout"))},12e4),s.set(u,{resolve:e,timeout:a,unsub:l})}).catch(function(e){var t=r("getErrorSafe")(e);return l(),s.delete(u),n(o("WAResultOrError").makeError(t.message))})});return function(t,n){return e.apply(this,arguments)}})())}),d.apply(this,arguments)}l.resolveSyncEpochsWithError=u,l.EBSyncEpochs=c}),98);
__d("EBUploadMessagesFromWorkerMutation_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="25145199965171420"}),null);
__d("EBUploadMessagesFromWorkerMutation.graphql",["EBUploadMessagesFromWorkerMutation_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"input"}],t=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTUploadMessageGQLResponse",kind:"LinkedField",name:"xfb_upload_encrypted_msg_to_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBTUploadMessageGQLResponseLabyrinth10",kind:"LinkedField",name:"labyrinth_1_0",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"device_epoch_status",storageKey:null},{alias:null,args:null,concreteType:"XFBTAttachmentUploadStatus",kind:"LinkedField",name:"attachment_upload_status",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"status",storageKey:null},{alias:null,args:null,concreteType:"XFBTAttachmentUploadContext",kind:"LinkedField",name:"upload_context",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"attachment_trace_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"media_type",storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBTUploadMessageHandlerResponse",kind:"LinkedField",name:"backup_write_result_response",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"is_success",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"delete_mailbox",storageKey:null},{alias:null,args:null,concreteType:"XFBTProtobufParams",kind:"LinkedField",name:"protobuf_params",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"delete_on_success",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"EBUploadMessagesFromWorkerMutation",selections:t,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"EBUploadMessagesFromWorkerMutation",selections:t},params:{id:n("EBUploadMessagesFromWorkerMutation_facebookRelayOperation"),metadata:{},name:"EBUploadMessagesFromWorkerMutation",operationKind:"mutation",text:null}}})();a.exports=e}),null);
__d("MAWEBFrontendQPLLogger",["ExecutionEnvironment","FBLogger","MAWBridgeSafeActionsWorkerAndUI","MAWEBUploadTrackingUtils","MWEBODSEntityName.enum","ODS","QPLUserFlow","WAHashStringToNumber","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n){e!=null&&((s||(s=r("ExecutionEnvironment"))).isInWorker?(y("point",t),o("MAWEBUploadTrackingUtils").handleBridgeEbUploadTrackingQPL("point",e,t,n)):o("MAWBridgeSafeActionsWorkerAndUI").fireAndForgetBackendWorkerAndUIShared("addEbUploadTrackingWorkerQPL",{annotations:n,pointName:t,qplInstanceKey:e,qplType:"point"}))}function c(e,t){(s||(s=r("ExecutionEnvironment"))).isInWorker?(y("success","upload_tracking_completed"),o("MAWEBUploadTrackingUtils").handleBridgeEbUploadTrackingQPL("success",e,"upload_tracking_completed",t)):o("MAWBridgeSafeActionsWorkerAndUI").fireAndForgetBackendWorkerAndUIShared("addEbUploadTrackingWorkerQPL",{annotations:t,pointName:"upload_tracking_completed",qplInstanceKey:e,qplType:"success"})}function d(e,t,n){(s||(s=r("ExecutionEnvironment"))).isInWorker?(y("fail",t),o("MAWEBUploadTrackingUtils").handleBridgeEbUploadTrackingQPL("fail",e,t,n)):o("MAWBridgeSafeActionsWorkerAndUI").fireAndForgetBackendWorkerAndUIShared("addEbUploadTrackingWorkerQPL",{annotations:n,pointName:t,qplInstanceKey:e,qplType:"fail"})}function m(e){var t=e.deliveryObjectId,n=e.flow,a=e.mediaType,i=e.messageId,l=e.threadId,s=e.traceId;if(_(n)){var u=o("WAHashStringToNumber").hashStringToNumber(s),c={bool:{is_legacy_hardening:!1,is_unified_attachment:!0},string:{deliveryObjectId:t,flow:n,mediaType:a,messageId:i,threadId:l,traceId:s}};r("QPLUserFlow").start(r("qpl")._(521480391,"1167"),{annotations:c,instanceKey:u})}}function p(e,t,n,a){if(e!=null&&_(n)){var i=o("WAHashStringToNumber").hashStringToNumber(e);if(t){r("QPLUserFlow").endSuccess(r("qpl")._(521480391,"1167"),{instanceKey:i});return}r("QPLUserFlow").endFailure(r("qpl")._(521480391,"1167"),"upload_attachment_backup_failed",{annotations:{string:{error:a!=null?a:"upload_attachment_backup_failed"}},instanceKey:i})}}function _(e){return e==="old"}function f(e,t){e.forEach(function(e){if(e.uploadTrackingInstanceKey!=null){var n={string:{traceId:e.traceId}};u(e.uploadTrackingInstanceKey,t,n)}})}function g(e){return{addAnnotations:function(n){h(e,n)},addPoint:function(n,r){u(e,n,r)},endCancel:function(n,r){d(e,""+(n!=null?n:""),r)},endFail:function(n,r){d(e,n,r)},endSuccess:function(n){c(e,n)},getQPLAttrs:function(){return{instanceKey:e}},isActive:function(){return!0},start:function(){}}}function h(e,t){r("FBLogger")("EBFrontendQPLLogger").warn("addAnnotations not implemented for EB Frontend QPL")}function y(t,n){(e||(e=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_FRONTEND_QPL_IN_WORKER,t+"."+n)}l.addPointEBUploadTracking=u,l.endEBUploadTracking=c,l.failEBUploadTracking=d,l.startFlowUploadAttachmentBackup=m,l.endFlowUploadAttachmentBackup=p,l.addPointForUploadMessageArray=f,l.makeEBFrontendQplFlowFromInstanceKey=g}),98);
__d("LSHandleBackupWriteCompletion",["LSVec","MAWEBFrontendQPLLogger","Promise","asyncToGeneratorRuntime","cr:847"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a,i,l){if(l!=null){var s=r("LSVec").toArray(l);s.forEach(function(e){return o("MAWEBFrontendQPLLogger").endFlowUploadAttachmentBackup(e,i,"unified")})}if(n("cr:847")!=null){var u=l!=null?r("LSVec").toArray(l):[];u.length>0&&(yield n("cr:847")(t,u))}return(e||(e=n("Promise"))).resolve()}),u.apply(this,arguments)}l.call=s}),98);
__d("LSHandleBackupWriteCompletion.nop",["LSHandleBackupWriteCompletion"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r,a){return o("LSHandleBackupWriteCompletion").call(t,n,r,a)};e.__nop_name__="LSHandleBackupWriteCompletion",l.default=e}),98);
__d("LSMarkBackupAsCompleted.nop",["Promise"],(function(t,n,r,o,a,i){"use strict";var e,l=function(r,o,a,i,l,s,u){return(e||(e=n("Promise"))).resolve()};l.__nop_name__="LSMarkBackupAsCompleted",i.default=l}),66);
__d("LSHandleProtobufWriteResult",["LSArrayGetObjectAt","LSMarkBackupAsCompleted.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return e[3]?r[0]=!1:r[0]=!0,r[0]?t.resolve():(r[1]=e[3].get("delete_on_success"),r[1]&&e[0]&&!e[1]?(e[2]?r[2]=!1:r[2]=!0,r[2]?t.resolve():t.sequence([function(o){return r[3]=t.i64.of_float(Date.now()),r[4]=t.i64.of_int32(e[2].length),t.i64.gt(r[4],t.i64.cast([0,0]))?t.loopAsync(r[4],function(o){return r[7]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[2],r[7]).then(function(e){var t;return t=e,r[8]=t[0],r[9]=t[1],t})},function(e){return t.filter(t.db.table(305).fetch(),function(e){return t.i64.eq(e.pendingBackupTaskId,r[8])}).next().then(function(e,r){var o=e.done,a=e.value;return o?0:(r=a.item,t.nativeOperation(n("LSMarkBackupAsCompleted.nop"),r.actThreadId,r.toplevelOfflineThreadingId,r.supplementalKey,r.messageTimestampMs,r.backupAction))})}])}):t.resolve()},function(o){return r[5]=t.i64.of_int32(e[2].length),t.i64.gt(r[5],t.i64.cast([0,0]))?t.loopAsync(r[5],function(o){return r[7]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[2],r[7]).then(function(e){var t;return t=e,r[8]=t[0],r[9]=t[1],t})},function(e){return t.filter(t.db.table(305).fetch(),function(e){return t.i64.eq(e.pendingBackupTaskId,r[8])}).next().then(function(e,n){var o=e.done,a=e.value;return o?0:(n=a.item,r[12]=n.actThreadId,r[13]=n.toplevelOfflineThreadingId,r[11]=n.supplementalKey,r[14]=n.messageTimestampMs,r[11]!==void 0?t.forEach(t.filter(t.db.table(302).fetch(),function(e){return e.threadId===r[12]&&e.toplevelOfflineThreadingId===r[13]&&e.supplementalKey===r[11]&&t.i64.le(e.messageTimestampMs,r[14])}),function(e){return e.delete()}):t.forEach(t.filter(t.db.table(301).fetch(),function(e){return e.threadId===r[12]&&e.offlineThreadingId===r[13]&&t.i64.le(e.messageTimestampMs,r[14])}),function(e){return e.delete()}))})}])}):t.resolve()},function(o){return r[6]=t.i64.of_int32(e[2].length),t.i64.gt(r[6],t.i64.cast([0,0]))?t.loopAsync(r[6],function(o){return r[7]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[2],r[7]).then(function(e){var t;return t=e,r[8]=t[0],r[9]=t[1],t})},function(e){return t.filter(t.db.table(305).fetch(),function(e){return t.i64.eq(e.pendingBackupTaskId,r[8])}).next().then(function(e,n){var r=e.done,o=e.value;return r?0:(n=o.item,t.forEach(t.db.table(304).fetch([[[n.toplevelOfflineThreadingId,n.actThreadId]],"offlineThreadingId"]),function(e){return e.delete()}))})}])}):t.resolve()}])):t.resolve())},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsHandleProtobufWriteResultStoredProcedure",e.__tables__=["pending_protobuf_backups_context","local_message_persistence_store_supplemental","local_message_persistence_store","local_message_persistence_store_tag_index"],a.exports=e}),null);
__d("LSHandleBackupWriteResultV2",["LSArrayGetObjectAt","LSDeleteBackupOnClient","LSHandleBackupWriteCompletion.nop","LSHandleProtobufWriteResult","LSLogMEBUploadSuccessEvent.nop","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Beginning execution."),r[1]=t.createArray(),r[2]=t.createArray(),e[3]?r[3]=!1:r[3]=!0,r[3]?t.resolve():(r[12]=t.i64.of_int32(e[3].length),t.i64.gt(r[12],t.i64.cast([0,0]))?t.loopAsync(r[12],function(o){return r[13]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[3],r[13]).then(function(e){var t;return t=e,r[14]=t[0],r[15]=t[1],t})},function(o){return t.db.table(177).fetch([[[r[14]]],"fk_pending_tasks"]).next().then(function(o,a){var i=o.done,l=o.value;return i?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] Pending backup task id not found!"),r[18]="Pending backup task id not found!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ","",r[18]].join("")),r[17]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",r[18],r[17],t.i64.cast([0,3]))):(a=l.item,t.sequence([function(r){return t.i64.eq(a.contentType,t.i64.cast([0,1]))?t.nativeOperation(n("LSLogMEBUploadSuccessEvent.nop"),a.uniqueKey,a.lsTraceId,e[1]):t.resolve()},function(e){return r[17]=(r[2].push(a.persistentId),r[2])}]))})}])}):t.resolve())},function(r){return t.storedProcedure(n("LSHandleProtobufWriteResult"),e[1],e[2],e[3],e[4],!1)},function(o){return r[4]=t.i64.of_float(Date.now()),e[3]?r[5]=!1:r[5]=!0,r[5]?t.resolve():(r[12]=t.i64.of_int32(e[3].length),t.i64.gt(r[12],t.i64.cast([0,0]))?t.loopAsync(r[12],function(o){return r[13]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[3],r[13]).then(function(e){var t;return t=e,r[14]=t[0],r[15]=t[1],t})},function(e){return t.forEach(t.filter(t.db.table(305).fetch(),function(e){return t.i64.eq(e.pendingBackupTaskId,r[14])}),function(e){return e.delete()})}])}):t.resolve())},function(o){return e[2]?t.sequence([function(o){return r[12]=t.i64.of_int32(e[0].length),t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[0],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[14]=t[0],r[15]=t[1],t})},function(e){return r[13]=r[14]}])},function(e){return t.storedProcedure(n("LSDeleteBackupOnClient"),void 0,void 0,!0,r[13],void 0,!0)}]):t.resolve()},function(o){return t.nativeOperation(n("LSHandleBackupWriteCompletion.nop"),e[1],e[0],r[2])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsHandleBackupWriteResultV2StoredProcedure",e.__tables__=["pending_backups_context_v2","pending_protobuf_backups_context"],a.exports=e}),null);
__d("LSHandleBackupWriteResultV2StoredProcedure",["LSHandleBackupWriteResultV2","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSHandleBackupWriteResultV2"),a.traceIds,a.isSuccess,a.deleteMailbox,a.taskIds,a.protobufParams);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSPrepareOpenEpochV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(e){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Beginning execution."),t.filter(t.db.table(2).fetch(),function(e){return e.context==="50005"}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[1]=!1:(t=o.item,r[1]=!0)})},function(e){return t.filter(t.db.table(2).fetch(),function(e){return e.context==="320"}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[3]=!1:(t=o.item,r[3]=!0)})},function(e){return r[1]||r[3]?t.resolve(((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] Skipping openEpoch start because there is already an openEpoch flow in progress."),r[5]=t.i64.cast([0,1]))):t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[18]=t[0],t})},function(e){return r[18]?r[19]=!0:r[19]=!1,r[19]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[21]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[21]].join("")),r[20]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[21],r[20],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!1}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[18]=new t.Map,r[18].set("error_msg","Expected a nonempty query result"),r[18].set("code",t.i64.cast([0,3])),r[18].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[19]=t.createArray(),r[20]=(r[19].push(r[18]),r[19]),o=[void 0,r[19]],r[12]=o[0],r[13]=o[1]):(n=l.item,r[18]=new t.Map,r[18].set("backup_id",n.backupId),r[18].set("device_public_key_blob",n.devicePublicKeyBlob),r[18].set("device_private_key_blob",n.devicePrivateKeyBlob),r[18].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[18].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[18].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[18].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[18].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[18].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[18].set("orf_client_state_v2_blob",void 0),r[18].set("orf_v2_authority_level",void 0),r[18].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[18].set("device_id",n.deviceId),r[18].set("backup_tenancy",n.backupTenancy),r[18].set("encryption_version",n.encryptionVersion),r[18].set("revision_version",n.revisionVersion),r[18].set("initialize_restore_result",void 0),r[18].set("device_creation_timestamp_sec",void 0),r[18].set("authority_level",n.authorityLevel),a=[r[18],void 0],r[12]=a[0],r[13]=a[1])})},function(e){return r[15]=new t.Map,r[15].set("value",r[12]),r[15].set("errors",r[13]),r[16]=r[15].get("value"),r[16]!==void 0?t.sequence([function(e){return r[18]=r[16].get("backup_id"),r[19]=r[16].get("device_public_key_blob"),r[20]=r[16].get("device_private_key_blob"),r[21]=r[16].get("epoch_storage_public_key_blob"),r[22]=r[16].get("epoch_storage_private_key_blob"),r[23]=r[16].get("epoch_auth_public_key_blob"),r[24]=r[16].get("epoch_auth_private_key_blob"),r[25]=r[16].get("mailbox_root_key_blob"),r[26]=r[16].get("ocmf_client_state_blob"),r[27]=r[16].get("orf_client_state_v2_blob"),r[28]=r[16].get("orf_v2_authority_level"),r[29]=r[16].get("oblivious_validation_token_blob"),r[30]=r[16].get("device_id"),r[31]=r[16].get("backup_tenancy"),r[32]=r[16].get("encryption_version"),r[33]=r[16].get("revision_version"),r[34]=r[16].get("initialize_restore_result"),r[35]=r[16].get("device_creation_timestamp_sec"),r[36]=r[16].get("authority_level"),t.i64.neq(r[30],void 0)?t.sequence([function(e){return r[38]=void 0,t.i64.neq(r[38],void 0)?t.resolve(r[39]=r[38]):t.sequence([function(e){return r[50]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[51]=t[0],t})},function(e){return r[51]&&(r[60]=(r[50].push(t.i64.cast([0,0])),r[50])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[52]=t[0],t})},function(e){return r[52]&&(r[60]=(r[50].push(t.i64.cast([0,2])),r[50])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[53]=t[0],t})},function(e){return r[53]&&(r[60]=(r[50].push(t.i64.cast([0,3])),r[50])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[54]=t[0],t})},function(e){return r[54]&&(r[60]=(r[50].push(t.i64.cast([0,4])),r[50])),r[55]=t.createArray(),r[56]=t.i64.of_int32(r[50].length),t.i64.gt(r[56],t.i64.cast([0,0]))?t.loopAsync(r[56],function(e){return r[60]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[50],r[60]).then(function(e){var t;return t=e,r[61]=t[0],r[62]=t[1],t})},function(e){return r[63]=(r[55].push(r[61]),r[55])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[60]=t.createArray(),r[61]=t.i64.of_int32(r[55].length),t.i64.gt(r[61],t.i64.cast([0,0]))?t.loopAsync(r[61],function(e){return r[63]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[55],r[63]).then(function(e){var t;return t=e,r[64]=t[0],r[65]=t[1],t})},function(e){return r[66]=(r[60].push(t.i64.to_string(r[64])),r[60])}])}):t.resolve()},function(e){return r[62]=r[60].join(","),r[57]=r[62]}])},function(e){return r[55].some(function(e){return t.i64.eq(r[32],e)})?r[58]=r[32]:r[58]=void 0,t.i64.neq(r[58],void 0)?r[59]=r[58]:r[59]=void 0,r[39]=r[59]}])},function(e){return t.i64.neq(r[39],void 0)?r[40]=r[39]:r[40]=t.i64.cast([0,0]),t.i64.neq(r[31],void 0)?r[41]=r[31]:r[41]=t.i64.cast([0,1]),t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[50]=t[0],t})},function(e){return r[50]?r[51]=!0:r[51]=!1,r[51]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[53]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[53]].join("")),r[52]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[53],r[52],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[42]=t.createArray(),t.forEach(t.filter(t.db.table(169).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))}),function(e){var t=e.item;return r[50]=(r[42].push(t.epochId),r[42])})},function(e){return r[48]="Queried locally available epochs. Count: ",r[43]=t.i64.of_int32(r[42].length),r[49]=t.i64.to_string(r[43]),r[44]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][MEBEpochClientUtils] ",r[44],r[48],r[44],r[49]].join("")),t.resolve()},function(e){return r[45]=new t.Map,r[45].set("backup_id",r[18]),r[45].set("locally_available_epochs",r[42]),r[45].set("device_id",r[30]),r[45].set("trace_id",void 0),r[46]=t.toJSON(r[45]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"messenger_request_for_asssoc_devices",t.i64.cast([0,50005]),r[46],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[47]=t[0],t})},function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[50]=t[0],t})},function(e){return r[50]?r[51]=!0:r[51]=!1,r[51]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[53]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[53]].join("")),r[52]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[53],r[52],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[37]=t.i64.cast([0,0])}]):t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[39]=t[0],t})},function(e){return r[39]?r[40]=!0:r[40]=!1,r[40]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[42]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[42]].join("")),r[41]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[42],r[41],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[38]="No backup found.",r[38]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",r[38]].join("")),r[39]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",r[38],r[39],t.i64.cast([0,3]))):t.resolve()},function(e){return r[37]=t.i64.cast([0,1])}])},function(e){return r[17]=r[37]}]):t.sequence([function(e){return r[18]=r[15].get("errors"),r[19]=r[15].get("errors"),t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,r[21]=t[0],t})},function(e){return r[21]?r[22]=!0:r[22]=!1,r[22]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),r[24]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",r[24]].join("")),r[23]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",r[24],r[23],t.i64.cast([0,3]))):t.resolve()}])},function(e){return r[20]="No backup found.",r[20]!==void 0?((function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ","",r[20]].join("")),r[21]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",r[20],r[21],t.i64.cast([0,3]))):t.resolve()},function(e){return r[17]=t.i64.cast([0,1])}])},function(e){return r[5]=r[17]}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){return o[0]=r[5]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsPrepareOpenEpochV2StoredProcedure",e.__tables__=["pending_tasks","secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"],a.exports=e}),null);
__d("LSPrepareOpenEpochV2StoredProcedure",["LSPrepareOpenEpochV2","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){a===void 0&&(a={});var i=t.storedProcedure(r("LSPrepareOpenEpochV2"),a.backupId,a.traceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MAWEBFalcoLoggerUtils",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(e=r("requireDeferred"))("EncryptedBackupTaskFailureFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),u=e("EncryptedBackupTaskIssuedFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),c=e("EncryptedBackupTaskSkippedFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),d=e("EncryptedBackupUploadSuccessFalcoEvent").__setRef("MAWEBFalcoLoggerUtils"),m={0:"unknown",1:"upsert_top_level",2:"upsert_supplemental",3:"delete_top_level",4:"delete_top_level_with_placeholder"};function p(e,t){g(e,t)}function _(e,t,n){g(e,t,n)}function f(e,t,n){g(e,t,void 0,n)}function g(e,t,n,r){n!=null?s.onReady(function(r){r.log(function(){var r,o,a,i,l;return{backup_action:(r=m[(o=(a=e.protoMsg)==null?void 0:a.backupActionType)!=null?o:0])!=null?r:"unknown",backup_protocol:t,failure_reason:n,labyrinth_version:0,message_id:(i=(l=e.protoMsg)==null||(l=l.msgId)==null?void 0:l.externalId)!=null?i:e.messageId,thread_id:e.threadId,trace_id:e.traceId}})}):r!=null?c.onReady(function(n){n.log(function(){var n,o,a,i,l;return{backup_action:(n=m[(o=(a=e.protoMsg)==null?void 0:a.backupActionType)!=null?o:0])!=null?n:"unknown",backup_protocol:t,labyrinth_version:0,message_id:(i=(l=e.protoMsg)==null||(l=l.msgId)==null?void 0:l.externalId)!=null?i:e.messageId,skipped_reason:r,thread_id:e.threadId,trace_id:e.traceId}})}):u.onReady(function(n){n.log(function(){var n,r,o,a,i;return{backup_action:(n=m[(r=(o=e.protoMsg)==null?void 0:o.backupActionType)!=null?r:0])!=null?n:"unknown",backup_protocol:t,labyrinth_version:0,message_id:(a=(i=e.protoMsg)==null||(i=i.msgId)==null?void 0:i.externalId)!=null?a:e.messageId,thread_id:e.threadId,trace_id:e.traceId}})})}function h(e){d.onReady(function(t){t.log(function(){var t,n;return{labyrinth_version:0,message_id:(t=(n=e.protoMsg)==null||(n=n.msgId)==null?void 0:n.externalId)!=null?t:e.messageId,thread_id:e.threadId,trace_id:e.traceId}})})}l.BackupActionMap=m,l.logEBFalcoTaskIssued=p,l.logEBFalcoTaskFailure=_,l.logEBFalcoTaskSkipped=f,l.logEBFalcoEncryptedBackupUploadSuccess=h}),98);
__d("EBWasm.pb",["$InternalEnum","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s,u=(s=n("$InternalEnum"))({UPSERT_BACKUP_ITEM:1,REMOVE_BACKUP_ITEM:2}),c=s({MESSAGE:1,THREAD:2}),d=s({STANDARD:0,VANISH_MODE:1,DUAL_SEND_SHADOW:2,BTV_COMPANION:3,BLEND_DUAL_SEND:4,BLEND_DUAL_SEND_NO_NETWORK:5}),m=s({UNKNOWN:0,ENCRYPTIONKDFWITHVERSION:2,ENCRYPTIONKDFWITHNULLSALT:3,ENCRYPTIONKDFWITHNULLSALTDFCANARY:4,TESTVERSION:99}),p=s({UNKNOWN:0,UPSERT_TOPLEVEL:1,UPSERT_SUPPLEMENTAL:2,DELETE_TOPLEVEL:3,DELETE_TOPLEVEL_WITH_PLACEHOLDER:4}),_=s({PHOTO:0,PERMANENT:1,EPHEMERAL:2,VIDEO:3,GIF:4,AUDIO:5,FILE:6,RAVEN:7,UNREAD_RAVEN:8,SHARE_IG_MEDIA:9,SHARE_LINK:10,SHARE_IG_CLIPS:11,SHH:12,STORY_REPLY:13,DISAPPEARING_MESSAGE:14,RAVEN_SEEN:15,RAVEN_REPLAYED:16,RAVEN_READ_ONCE:17,RAVEN_REPLAYABLE:18,RAVEN_PERMANENT:19,ACTION_LOG:20}),f=s({ECHO_SERIALIZATION_FAILURE:0,ECHO_UPLOAD_IS_DISABLED:1,DELTA_PAYLOAD_IS_TOO_BIG:2,ECHO_VALUE_CLEANED_UP:3,ECHO_UPLOAD_OPTIONAL_FOR_LOOPING_UPLOAD:4,ECHO_UPLOAD_SKIPPED_ON_PROTOBUF_SUCCESS_FOR_LOOPING_UPLOAD:5}),g={},h={},y={},C={},b={},v={},S={},R={};g.name="SupplementalMessage",g.internalSpec={toplevelOfflineThreadingId:[1,(e=o("WAProtoConst")).FLAGS.REQUIRED|e.TYPES.UINT64],supplementalKey:[2,e.FLAGS.REQUIRED|e.TYPES.STRING],payload:[3,e.FLAGS.REQUIRED|e.TYPES.BYTES],maybeOutOfOrder:[4,e.TYPES.BOOL]},h.name="ToplevelMessage",h.internalSpec={payload:[1,e.FLAGS.REQUIRED|e.TYPES.BYTES]},y.name="Epoch",y.internalSpec={epochId:[1,e.FLAGS.REQUIRED|e.TYPES.UINT64],epochAnonId:[2,e.FLAGS.REQUIRED|e.TYPES.BYTES],epochRootKey:[3,e.FLAGS.REQUIRED|e.TYPES.BYTES]},C.name="MessageUploadSerializerInput",C.internalSpec={threadId:[1,e.FLAGS.REQUIRED|e.TYPES.UINT64],operationType:[2,e.FLAGS.REQUIRED|e.TYPES.ENUM,u],contentType:[3,e.FLAGS.REQUIRED|e.TYPES.ENUM,c],attachmentPayload:[6,e.TYPES.STRING],threadSubtype:[7,e.FLAGS.REQUIRED|e.TYPES.ENUM,d],encryptionVersion:[8,e.FLAGS.REQUIRED|e.TYPES.UINT64],actionType:[9,e.FLAGS.REQUIRED|e.TYPES.ENUM,p],messageTags:[10,e.FLAGS.REPEATED|e.TYPES.ENUM,_],tagsToDelete:[11,e.FLAGS.REPEATED|e.TYPES.ENUM,_],offlineThreadingId:[12,e.FLAGS.REQUIRED|e.TYPES.UINT64],timestamp:[13,e.FLAGS.REQUIRED|e.TYPES.UINT64],deletionOtid:[14,e.TYPES.UINT64],requestId:[15,e.FLAGS.REQUIRED|e.TYPES.STRING],supplementalMessage:[4,e.TYPES.MESSAGE,g],toplevelMessage:[5,e.TYPES.MESSAGE,h],__oneofs__:{message:["supplementalMessage","toplevelMessage"]}},b.name="MessageUploadSerializerBatchInput",b.internalSpec={messages:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,C],mailboxRootKeyBlob:[2,e.FLAGS.REQUIRED|e.TYPES.BYTES],ocmfClientStateBlob:[3,e.FLAGS.REQUIRED|e.TYPES.BYTES],epoch:[4,e.FLAGS.REQUIRED|e.TYPES.MESSAGE,y],deviceId:[5,e.FLAGS.REQUIRED|e.TYPES.UINT64],backupId:[6,e.FLAGS.REQUIRED|e.TYPES.UINT64]},v.name="MessageUploadPayloadOutput",v.internalSpec={offlineThreadingId:[3,e.FLAGS.REQUIRED|e.TYPES.UINT64],timestamp:[4,e.FLAGS.REQUIRED|e.TYPES.UINT64],threadId:[5,e.FLAGS.REQUIRED|e.TYPES.UINT64],payload:[1,e.TYPES.STRING],error:[2,e.TYPES.STRING],__oneofs__:{result:["payload","error"]}},S.name="MessageUploadSerializerBatchOutput",S.internalSpec={payloads:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,v]},R.name="LabyrinthCommand",R.internalSpec={messageUploadSerializerBatchInput:[1,e.TYPES.MESSAGE,b],__oneofs__:{commandInput:["messageUploadSerializerBatchInput"]}},l.BackupOperationType=u,l.BackupContentType=c,l.ThreadSubtype=d,l.EncryptionVersion=m,l.EncryptedBackupsKeyValueActionType=p,l.MessageTag=_,l.EchoOptionalUploadReason=f,l.SupplementalMessageSpec=g,l.ToplevelMessageSpec=h,l.EpochSpec=y,l.MessageUploadSerializerInputSpec=C,l.MessageUploadSerializerBatchInputSpec=b,l.MessageUploadPayloadOutputSpec=v,l.MessageUploadSerializerBatchOutputSpec=S,l.LabyrinthCommandSpec=R}),98);
__d("EBWasmSerializeMessagesPayload",["EBLabyrinthWasmReactorSingleton","EBWasm.pb","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WATagsLogger").TAGS(["EBSerializeMessagesPayload"]);function s(){function e(e){var t=e.payloads;return o("WAResultOrError").makeResult({payloads:t})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.messagesData;return yield o("EBLabyrinthWasmReactorSingleton").labyrinthCommand({InputSpec:o("EBWasm.pb").LabyrinthCommandSpec,ResultSpec:o("EBWasm.pb").MessageUploadSerializerBatchOutputSpec,validateResult:e},{messageUploadSerializerBatchInput:n})});return function(e){return t.apply(this,arguments)}})()}var u=s();l.logger=e,l.serializeMessagesPayload=u}),98);
__d("EBWasmSerializeMessagesModule",["EBLogger","EBWasm.pb","EBWasmSerializeMessagesPayload","I64","MAWEBUploadTrackingUtils","MSGDataclassTypes.flow","ReQL","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("EBLogger").EBLogger().tags(["EBWasmSerializeMessagesModule"]);function f(e){return e===o("MSGDataclassTypes.flow").MpsMessageTag.Photo?o("EBWasm.pb").MessageTag.PHOTO:e===o("MSGDataclassTypes.flow").MpsMessageTag.Permanent?o("EBWasm.pb").MessageTag.PERMANENT:e===o("MSGDataclassTypes.flow").MpsMessageTag.Ephemeral?o("EBWasm.pb").MessageTag.EPHEMERAL:e===o("MSGDataclassTypes.flow").MpsMessageTag.Video?o("EBWasm.pb").MessageTag.VIDEO:e===o("MSGDataclassTypes.flow").MpsMessageTag.Gif?o("EBWasm.pb").MessageTag.GIF:e===o("MSGDataclassTypes.flow").MpsMessageTag.Audio?o("EBWasm.pb").MessageTag.AUDIO:e===o("MSGDataclassTypes.flow").MpsMessageTag.File?o("EBWasm.pb").MessageTag.FILE:e===o("MSGDataclassTypes.flow").MpsMessageTag.Raven?o("EBWasm.pb").MessageTag.RAVEN:e===o("MSGDataclassTypes.flow").MpsMessageTag.UnreadRaven?o("EBWasm.pb").MessageTag.UNREAD_RAVEN:e===o("MSGDataclassTypes.flow").MpsMessageTag.ShareIgMedia?o("EBWasm.pb").MessageTag.SHARE_IG_MEDIA:e===o("MSGDataclassTypes.flow").MpsMessageTag.ShareLink?o("EBWasm.pb").MessageTag.SHARE_LINK:e===o("MSGDataclassTypes.flow").MpsMessageTag.ShareIgClips?o("EBWasm.pb").MessageTag.SHARE_IG_CLIPS:e===o("MSGDataclassTypes.flow").MpsMessageTag.Shh?o("EBWasm.pb").MessageTag.SHH:e===o("MSGDataclassTypes.flow").MpsMessageTag.StoryReply?o("EBWasm.pb").MessageTag.STORY_REPLY:e===o("MSGDataclassTypes.flow").MpsMessageTag.DisappearingMessage?o("EBWasm.pb").MessageTag.DISAPPEARING_MESSAGE:e===o("MSGDataclassTypes.flow").MpsMessageTag.RavenSeen?o("EBWasm.pb").MessageTag.RAVEN_SEEN:e===o("MSGDataclassTypes.flow").MpsMessageTag.RavenReplayed?o("EBWasm.pb").MessageTag.RAVEN_REPLAYED:e===o("MSGDataclassTypes.flow").MpsMessageTag.RavenReadOnce?o("EBWasm.pb").MessageTag.RAVEN_READ_ONCE:e===o("MSGDataclassTypes.flow").MpsMessageTag.RavenReplayable?o("EBWasm.pb").MessageTag.RAVEN_REPLAYABLE:e===o("MSGDataclassTypes.flow").MpsMessageTag.RavenPermanent?o("EBWasm.pb").MessageTag.RAVEN_PERMANENT:e===o("MSGDataclassTypes.flow").MpsMessageTag.ActionLog?o("EBWasm.pb").MessageTag.ACTION_LOG:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}function g(e){var t;return(function(e){return e===0?o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UNKNOWN:e===1?o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UPSERT_TOPLEVEL:e===2?o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UPSERT_SUPPLEMENTAL:e===3?o("EBWasm.pb").EncryptedBackupsKeyValueActionType.DELETE_TOPLEVEL:e===4?o("EBWasm.pb").EncryptedBackupsKeyValueActionType.DELETE_TOPLEVEL_WITH_PLACEHOLDER:o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UNKNOWN})((t=e.protoMsg)==null?void 0:t.backupActionType)}function h(t,n,r){var o,a=t==null||(o=t.protoMsg)==null?void 0:o.supplementalKey;if(a==null){_.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Supplemental key is null - unable to serialize payload"])));return}return{payload:r,supplementalKey:a,toplevelOfflineThreadingId:n}}function y(e,t,n){var r,a,i,l=o("WALongInt").decimalStringToLongInt(e.threadId),y=o("WALongInt").decimalStringToLongInt(e.sortOrderMs.toString()),C=g(e);if(C===o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UNKNOWN){_.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Action type is unknown - unable to serialize payload"])));return}var b=e.actionType===2?o("EBWasm.pb").BackupOperationType.REMOVE_BACKUP_ITEM:o("EBWasm.pb").BackupOperationType.UPSERT_BACKUP_ITEM,v=o("EBWasm.pb").ThreadSubtype.STANDARD,S=o("WALongInt").decimalStringToLongInt((p||(p=o("I64"))).to_string(t)),R=e.traceId,L={actionType:C,attachmentPayload:n,contentType:o("EBWasm.pb").BackupContentType.MESSAGE,encryptionVersion:S,operationType:b,requestId:R,threadId:l,threadSubtype:v,timestamp:y},E=(r=e.protoMsg)==null?void 0:r.tags,k=E!=null?E.map(function(e){return f(e)}):[],I=[],T=(a=e.protoMsg)==null||(a=a.originalMsgProtocolId)==null?void 0:a.externalId;if(T==null){_.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Original message otid is null - unable to serialize payload"])));return}var D=o("WALongInt").decimalStringToLongInt(T),x=(i=e.protoMsg)==null||(i=i.protobuf)==null?void 0:i.buffer;if(x==null){_.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Protobuf top level upload payload is null - unable to serialize payload"])));return}if(C===o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UPSERT_TOPLEVEL){var $={payload:x};return babelHelpers.extends({},L,{messageTags:k,offlineThreadingId:D,tagsToDelete:I,toplevelMessage:$})}if(C===o("EBWasm.pb").EncryptedBackupsKeyValueActionType.UPSERT_SUPPLEMENTAL){var P,N=(P=e.protoMsg)==null||(P=P.msgId)==null?void 0:P.externalId;if(N==null){_.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Supplemental otid is null - unable to serialize payload"])));return}var M=o("WALongInt").decimalStringToLongInt(N),w=h(e,D,x);if(w!=null)return babelHelpers.extends({},L,{messageTags:k,offlineThreadingId:M,supplementalMessage:w,tagsToDelete:I})}if(C===o("EBWasm.pb").EncryptedBackupsKeyValueActionType.DELETE_TOPLEVEL||C===o("EBWasm.pb").EncryptedBackupsKeyValueActionType.DELETE_TOPLEVEL_WITH_PLACEHOLDER){var A,F=(A=e.protoMsg)==null||(A=A.msgId)==null?void 0:A.externalId;if(F==null){_.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Deletion message otid is null - unable to serialize payload"])));return}var O=o("WALongInt").decimalStringToLongInt(F),B={payload:x},W=babelHelpers.extends({},L,{messageTags:k,offlineThreadingId:O,tagsToDelete:I,toplevelMessage:B});return C===o("EBWasm.pb").EncryptedBackupsKeyValueActionType.DELETE_TOPLEVEL_WITH_PLACEHOLDER?babelHelpers.extends({},W,{deletionOtid:D}):W}}function C(e,t,n){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.secure_encrypted_backups_client_state)),a=r==null?void 0:r.backupId,i=r==null?void 0:r.deviceId,l=r==null?void 0:r.encryptionVersion,s=yield o("ReQL").firstAsync(o("ReQL").fromTableDescending(e.secure_encrypted_backups_epochs)),u=s==null?void 0:s.epochId,c=s==null?void 0:s.epochAnonIdBlob,d=s==null?void 0:s.epochRootKeyBlob,m=r==null?void 0:r.ocmfClientStateBlob,_=r==null?void 0:r.mailboxRootKeyBlob;if(a==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"backup_id_null",instanceKey:e.uploadTrackingInstanceKey})});if(i==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"device_id_null",instanceKey:e.uploadTrackingInstanceKey})});if(u==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"epoch_id_null",instanceKey:e.uploadTrackingInstanceKey})});if(c==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"epoch_anon_id_null",instanceKey:e.uploadTrackingInstanceKey})});if(d==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"epoch_root_key_null",instanceKey:e.uploadTrackingInstanceKey})});if(m==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"ocmf_client_state_blob_null",instanceKey:e.uploadTrackingInstanceKey})});if(_==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"mailbox_root_key_blob_null",instanceKey:e.uploadTrackingInstanceKey})});if(l==null)return t.map(function(e){return o("WAResultOrError").makeError({error:"encryption_version_null",instanceKey:e.uploadTrackingInstanceKey})});var f=o("WALongInt").decimalStringToLongInt((p||(p=o("I64"))).to_string(a)),g=o("WALongInt").decimalStringToLongInt(p.to_string(i)),h=o("WALongInt").decimalStringToLongInt(p.to_string(u)),C=t.map(function(e,t){var r=n[t];return y(e,l,r!=null?r:void 0)}),b={backupId:f,deviceId:g,epoch:{epochAnonId:c,epochId:h,epochRootKey:d},mailboxRootKeyBlob:_,messages:C.filter(Boolean),ocmfClientStateBlob:m};try{var v=yield o("EBWasmSerializeMessagesPayload").serializeMessagesPayload({messagesData:b});if(v.success){var S=v.value.payloads,R=new Map;return S.forEach(function(e){var t=o("WALongInt").longIntToDecimalString(e.threadId),n=o("WALongInt").longIntToDecimalString(e.offlineThreadingId),r=n+"_"+t;R.set(r,e)}),t.map(function(e){var t,n=e.threadId,r=(t=e.protoMsg)==null||(t=t.msgId)==null?void 0:t.externalId;if(r==null)return o("WAResultOrError").makeError({error:"otid is null",instanceKey:e.uploadTrackingInstanceKey});var a=r+"_"+n,i=R.get(a);if(i==null)return o("WAResultOrError").makeError({error:"serialized_payload_not_found",instanceKey:e.uploadTrackingInstanceKey});var l=i.payload,s=i.error,u=e.uploadTrackingInstanceKey;if(l!=null){if(u!=null){var c=o("MAWEBUploadTrackingUtils").makeEBWorkerQplFlowFromInstanceKey(u);c.addPoint("eb_wasm_serialization_success")}return o("WAResultOrError").makeResult({msg:e,payload:l})}return o("WAResultOrError").makeError({error:s!=null?s:"runtime_error_during_serialization",instanceKey:e.uploadTrackingInstanceKey})})}else return t.map(function(e){return o("WAResultOrError").makeError({error:v.error,instanceKey:e.uploadTrackingInstanceKey})})}catch(e){return t.map(function(e){return o("WAResultOrError").makeError({error:"runtime_error",instanceKey:e.uploadTrackingInstanceKey})})}}),b.apply(this,arguments)}l.serializeMessageBatchWasm=C}),98);
__d("LSBackupContentType",[],(function(t,n,r,o,a,i){var e=Object.freeze({MESSAGE:1,THREAD:2});i.default=e}),66);
__d("LSEncryptedBackupsAttachmentErrorCode",[],(function(t,n,r,o,a,i){var e=Object.freeze({NO_ERROR:0,UNKNOWN_ERROR:1,MEDIA_TYPE_MISSING:2,PRODUCT_TYPE_MISSING:3,SERIALIZATION_ERROR:21});i.default=e}),66);
__d("LSPendingBackupStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({NEEDS_BACKUP:1,BACKUP_IN_PROGRESS:2,BLOCKED:3});i.default=e}),66);
__d("LSSerializeAttachmentBackupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSQplAnnotateString.nop","LSQplMarkPoint.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][serializeAttachmentBackupPayload] Beginning execution."),r[1]=t.i64.of_float(Date.now()),r[2]=void 0,r[3]=t.i64.of_int32(e[0].length),t.i64.gt(r[3],t.i64.cast([0,0]))?t.loopAsync(r[3],function(o){return r[17]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[0],r[17]).then(function(e){var t;return t=e,r[18]=t[0],r[19]=t[1],t})},function(e){return r[20]=r[18].get("attachment_trace_id"),r[2]=r[20]}])}):t.resolve()},function(e){return r[2]!==void 0?t.nativeOperation(n("LSQplMarkPoint.nop"),t.i64.cast([0,637746317]),r[2],"LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure_start"):t.resolve()},function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))||!1}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o,a,i=e.done,l=e.value;return i?(r[17]=new t.Map,r[17].set("error_msg","Expected a nonempty query result"),r[17].set("code",t.i64.cast([0,3])),r[17].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),r[18]=t.createArray(),r[19]=(r[18].push(r[17]),r[18]),o=[void 0,r[18]],r[4]=o[0],r[5]=o[1]):(n=l.item,r[17]=new t.Map,r[17].set("backup_id",n.backupId),r[17].set("device_public_key_blob",n.devicePublicKeyBlob),r[17].set("device_private_key_blob",n.devicePrivateKeyBlob),r[17].set("epoch_storage_public_key_blob",n.epochStoragePublicKeyBlob),r[17].set("epoch_storage_private_key_blob",n.epochStoragePrivateKeyBlob),r[17].set("epoch_auth_public_key_blob",n.epochAuthPublicKeyBlob),r[17].set("epoch_auth_private_key_blob",n.epochAuthPrivateKeyBlob),r[17].set("mailbox_root_key_blob",n.mailboxRootKeyBlob),r[17].set("ocmf_client_state_blob",n.ocmfClientStateBlob),r[17].set("orf_client_state_v2_blob",void 0),r[17].set("orf_v2_authority_level",void 0),r[17].set("oblivious_validation_token_blob",n.obliviousValidationTokenBlob),r[17].set("device_id",n.deviceId),r[17].set("backup_tenancy",n.backupTenancy),r[17].set("encryption_version",n.encryptionVersion),r[17].set("revision_version",n.revisionVersion),r[17].set("initialize_restore_result",void 0),r[17].set("device_creation_timestamp_sec",void 0),r[17].set("authority_level",n.authorityLevel),a=[r[17],void 0],r[4]=a[0],r[5]=a[1])})},function(o){return r[7]=new t.Map,r[7].set("value",r[4]),r[7].set("errors",r[5]),r[8]=r[7].get("value"),r[8]!==void 0?t.sequence([function(o){return r[17]=r[8].get("backup_id"),r[18]=r[8].get("device_public_key_blob"),r[19]=r[8].get("device_private_key_blob"),r[20]=r[8].get("epoch_storage_public_key_blob"),r[21]=r[8].get("epoch_storage_private_key_blob"),r[22]=r[8].get("epoch_auth_public_key_blob"),r[23]=r[8].get("epoch_auth_private_key_blob"),r[24]=r[8].get("mailbox_root_key_blob"),r[25]=r[8].get("ocmf_client_state_blob"),r[26]=r[8].get("orf_client_state_v2_blob"),r[27]=r[8].get("orf_v2_authority_level"),r[28]=r[8].get("oblivious_validation_token_blob"),r[29]=r[8].get("device_id"),r[30]=r[8].get("backup_tenancy"),r[31]=r[8].get("encryption_version"),r[32]=r[8].get("revision_version"),r[33]=r[8].get("initialize_restore_result"),r[34]=r[8].get("device_creation_timestamp_sec"),r[35]=r[8].get("authority_level"),t.i64.neq(r[29],void 0)?t.sequence([function(e){return r[38]=void 0,t.i64.neq(r[38],void 0)?t.resolve(r[39]=r[38]):t.sequence([function(e){return r[44]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[45]=t[0],t})},function(e){return r[45]&&(r[54]=(r[44].push(t.i64.cast([0,0])),r[44])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[46]=t[0],t})},function(e){return r[46]&&(r[54]=(r[44].push(t.i64.cast([0,2])),r[44])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[47]=t[0],t})},function(e){return r[47]&&(r[54]=(r[44].push(t.i64.cast([0,3])),r[44])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[48]=t[0],t})},function(e){return r[48]&&(r[54]=(r[44].push(t.i64.cast([0,4])),r[44])),r[49]=t.createArray(),r[50]=t.i64.of_int32(r[44].length),t.i64.gt(r[50],t.i64.cast([0,0]))?t.loopAsync(r[50],function(e){return r[54]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[44],r[54]).then(function(e){var t;return t=e,r[55]=t[0],r[56]=t[1],t})},function(e){return r[57]=(r[49].push(r[55]),r[49])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[54]=t.createArray(),r[55]=t.i64.of_int32(r[49].length),t.i64.gt(r[55],t.i64.cast([0,0]))?t.loopAsync(r[55],function(e){return r[57]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[49],r[57]).then(function(e){var t;return t=e,r[58]=t[0],r[59]=t[1],t})},function(e){return r[60]=(r[54].push(t.i64.to_string(r[58])),r[54])}])}):t.resolve()},function(e){return r[56]=r[54].join(","),r[51]=r[56]}])},function(e){return r[49].some(function(e){return t.i64.eq(r[31],e)})?r[52]=r[31]:r[52]=void 0,t.i64.neq(r[52],void 0)?r[53]=r[52]:r[53]=void 0,r[39]=r[53]}])},function(o){return t.i64.neq(r[39],void 0)?r[40]=r[39]:r[40]=t.i64.cast([0,0]),t.i64.neq(r[30],void 0)?r[41]=r[30]:r[41]=t.i64.cast([0,1]),t.i64.eq(e[4],t.i64.cast([0,0]))?t.sequence([function(o){return r[44]=t.createArray(),r[45]=t.i64.of_int32(e[0].length),t.i64.gt(r[45],t.i64.cast([0,0]))?t.loopAsync(r[45],function(o){return r[61]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[0],r[61]).then(function(e){var t;return t=e,r[62]=t[0],r[63]=t[1],t})},function(e){return r[64]=r[62].get("media_type"),r[65]=r[62].get("zippy_object_id"),r[66]=r[65],t.like(r[66],"%.%")||t.like(r[66],"%\uFFFD%")?(r[86]=["Object ID: ",r[66]].join(""),(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure] ",r[86]].join("")),r[85]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",r[86],r[85],t.i64.cast([0,4]))):t.resolve()},function(o){return r[67]=r[62].get("attachment_trace_id"),r[68]=t.createArray(),r[85]=(r[68].push(t.i64.to_string(r[17])),r[68]),r[85]=(r[68].push(r[66]),r[68]),r[69]=t.toJSON(r[68]),r[70]=t.createArray(),r[85]=(r[70].push(e[1]),r[70]),r[85]=(r[70].push(r[66]),r[70]),r[71]=t.toJSON(r[70]),t.nativeOperation(n("LSGetBlobFromString.nop"),r[69]).then(function(e){var t;return t=e,r[72]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),r[72]).then(function(e){var t;return t=e,r[73]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[25],r[73]).then(function(e){var t;return t=e,r[74]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[74]).then(function(e){var t;return t=e,r[75]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),r[71]).then(function(e){var t;return t=e,r[76]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),r[76]).then(function(e){var t;return t=e,r[77]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[25],r[77]).then(function(e){var t;return t=e,r[78]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[78]).then(function(e){var t;return t=e,r[79]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),r[69]).then(function(e){var t;return t=e,r[80]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),r[80]).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[25],r[81]).then(function(e){var t;return t=e,r[82]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[82]).then(function(e){var t;return t=e,r[83]=t[0],t})},function(e){return r[84]=new t.Map,r[84].set("attachment_index_key",r[75]==null?"":r[75]),r[84].set("media_type",r[64]),r[84].set("zippy_object_id",r[66]),r[84].set("attachment_trace_id",r[67]),r[84].set("salt_partial_access_token",r[79]==null?"":r[79]),r[84].set("salt_partial_attachment_index_key",r[83]==null?"":r[83]),r[85]=(r[44].push(r[84]),r[44])}])}):t.resolve()},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[1]).then(function(e){var t;return t=e,r[46]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWVzc2FnZV9pZF9zY29wZQ=="),r[46]).then(function(e){var t;return t=e,r[47]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[25],r[47]).then(function(e){var t;return t=e,r[48]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[48]).then(function(e){var t;return t=e,r[49]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[1]).then(function(e){var t;return t=e,r[50]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),r[50]).then(function(e){var t;return t=e,r[51]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[25],r[51]).then(function(e){var t;return t=e,r[52]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[52]).then(function(e){var t;return t=e,r[53]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[2]).then(function(e){var t;return t=e,r[54]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("dGhyZWFkX2lkX3Njb3Bl"),r[54]).then(function(e){var t;return t=e,r[55]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[25],r[55]).then(function(e){var t;return t=e,r[56]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[56]).then(function(e){var t;return t=e,r[57]=t[0],t})},function(n){var o;return r[58]=new t.Map,r[58].set("attachment_infos",r[44]),r[58].set("message_partial_id",r[49]==null?"":r[49]),r[58].set("product_type",e[3]),r[58].set("salt_partial_id",r[53]==null?"":r[53]),r[58].set("thread_partial_id",r[57]==null?"":r[57]),r[59]=t.toJSON(r[58]),r[60]=new t.Map,r[60].set("payload",r[59]),o=[r[60],void 0],r[42]=o[0],r[43]=o[1]}]):t.sequence([function(o){return e[5]!==void 0?r[44]=e[5]:r[44]="",r[45]=".",r[47]=["LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",r[45],r[44],r[45],t.i64.to_string(t.i64.cast([-1,4294967295]))].join(""),r[2]!==void 0&&r[47]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,637746317]),r[2],"attachment_error",r[47]):t.resolve()},function(e){var n;return r[46]=new t.Map,r[46].set("error_code",t.i64.cast([-1,4294967295])),r[46].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),r[46].set("error_message",r[44]),n=[void 0,r[46]],r[42]=n[0],r[43]=n[1]}])},function(e){var t;return t=[r[42],r[43]],r[36]=t[0],r[37]=t[1],t}]):t.sequence([function(e){return r[38]=".",r[40]=["LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",r[38],"Error while reading client state",r[38],t.i64.to_string(t.i64.cast([0,24]))].join(""),r[2]!==void 0&&r[40]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,637746317]),r[2],"attachment_error",r[40]):t.resolve()},function(e){var n;return r[39]=new t.Map,r[39].set("error_code",t.i64.cast([0,24])),r[39].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),r[39].set("error_message",""),n=[void 0,r[39]],r[36]=n[0],r[37]=n[1]}])},function(e){var t;return t=[r[36],r[37]],r[9]=t[0],r[10]=t[1],t}]):t.sequence([function(e){return r[17]=r[7].get("errors"),r[18]=r[7].get("errors"),r[19]=".",r[21]=["LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",r[19],"Error while reading client state",r[19],t.i64.to_string(t.i64.cast([0,1]))].join(""),r[2]!==void 0&&r[21]!==void 0?t.nativeOperation(n("LSQplAnnotateString.nop"),t.i64.cast([0,637746317]),r[2],"attachment_error",r[21]):t.resolve()},function(e){var n;return r[20]=new t.Map,r[20].set("error_code",t.i64.cast([0,1])),r[20].set("stored_procedure","LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure"),r[20].set("error_message",""),n=[void 0,r[20]],r[9]=n[0],r[10]=n[1]}])},function(e){return r[11]=t.i64.of_float(Date.now()),r[12]=t.i64.random(),r[14]="Finishing execution. Execution time: ",r[15]=t.i64.to_string(t.i64.sub(r[11],r[0])),r[16]=" ms",r[13]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][serializeAttachmentBackupPayload] ",r[13],r[14],r[13],r[15],r[13],r[16]].join("")),t.i64.eq(t.i64.mod_(r[12],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[17]=",",r[18]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"serializeAttachmentBackupPayload",[r[14],r[17],r[15],r[17],r[16]].join(""),r[18],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[9],r[10]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsSerializeAttachmentBackupPayloadStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"],a.exports=e}),null);
__d("LSSerializeAttachmentBackupPayloadStoredProcedure",["LSSerializeAttachmentBackupPayload","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSSerializeAttachmentBackupPayload"),a.attachmentInfos,a.messageId,a.threadId,a.productType,a.error,a.errorMessage);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MAWUploadPayloadGenerator",["EBLogger","EBParseUploadSerializationPayload","EBWasmSerializeMessagesModule","I64","LSBackupContentType","LSEncryptedBackupsAttachmentErrorCode","LSFactory","LSIntEnum","LSPendingBackupStatus","LSSerializeAttachmentBackupPayloadStoredProcedure","LSShape","LSTaskSerializerEncryptedBackupsUpload","LSVec","MAWCastToMsgrServerMediaType","MAWEBFrontendQPLLogger","MAWEBUploadTrackingUtils","MWEBODSUtils","Promise","Random","ReQL","WAErrorMessage","WAResultOrError","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("EBLogger").EBLogger().tags(["MAWUploadPayloadGenerator"]),_="0",f=new Set;function g(){for(var e=0;e<1e8;e++){var t=o("Random").uint32();if(!f.has(t))return t}throw p.mustfixThrow("Unable to generate a unique task ID after 100 million attempts")}function h(e,t){return r("gkx")("18428")?y(e,t):b(e,t)}function y(e,t){return C.apply(this,arguments)}function C(){return C=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r){var a=yield(m||(m=n("Promise"))).allSettled(r.map(function(e){var n=e.uploadTrackingInstanceKey;if(n!=null){var r=o("MAWEBUploadTrackingUtils").makeEBWorkerQplFlowFromInstanceKey(n);r.addPoint("wasm_upload_serialization_start")}return k(t,e)})),i=a.map(function(t){if(t.status==="rejected"){p.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate attachment payload: ",""])),t.reason);return}return t.value});return o("EBWasmSerializeMessagesModule").serializeMessageBatchWasm(t,r,i)}),C.apply(this,arguments)}function b(e,t){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var a="unknown";a=(yield D(e))?"available":"unavailable";var i=t.map(function(t){try{var n=g();return f.add(n),o("WAResultOrError").makeResult({msg:t,taskMetadataPromise:S(e,t,n)})}catch(e){return o("WAResultOrError").makeError({error:o("WAErrorMessage").maybeGetMessageFromError(e),instanceKey:t.uploadTrackingInstanceKey})}}),l=yield(m||(m=n("Promise"))).allSettled(i.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(!t.success)return t;var n=t.value,i=n.msg,l=n.taskMetadataPromise;try{var s=yield l,u=s.uploadTrackingInstanceKey;u!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(u,"upload_task_serialization_start",{string:{base_epoch_availability:a}});var d=yield r("LSTaskSerializerEncryptedBackupsUpload")((c||(c=o("I64"))).of_int32(s.task),r("LSFactory")(e)),m=d[0],p=d[1];if(m!=null){var _=o("EBParseUploadSerializationPayload").parseUploadSerializationResponse(m);if(!_.success)return o("WAResultOrError").makeError({error:_.error,instanceKey:u});var g=_.value,h=!1;if(g.failure!=null&&(h=!0,o("EBParseUploadSerializationPayload").logUploadSerializationErrors([g.failure],"echo",s.uploadTrackingInstanceKey)),g.protobuf_failures!=null){var y=r("LSVec").toArray(g.protobuf_failures).filter(Boolean);y.length>0&&(h=!0,o("EBParseUploadSerializationPayload").logUploadSerializationErrors(y,"protobuf",s.uploadTrackingInstanceKey))}u!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(u,h?"upload_task_serialization_failure":"upload_task_serialization_success")}return yield e.pending_backups_context_v2.delete(s.pending_backups_context_v2_pk),s.pending_protobuf_backups_context_pk!=null&&(yield e.pending_protobuf_backups_context.delete(s.pending_protobuf_backups_context_pk)),f.delete(s.task),o("WAResultOrError").makeResult({msg:i,payload:m})}catch(e){return o("WAResultOrError").makeError({error:o("WAErrorMessage").maybeGetMessageFromError(e),instanceKey:i.uploadTrackingInstanceKey})}});return function(e){return t.apply(this,arguments)}})()));return l.map(function(e){return e.status==="rejected"?o("WAResultOrError").makeError(e.reason):e.value})}),v.apply(this,arguments)}function S(e,t,n){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i,l,m,_,f=t.sortOrderMs.toString(),g=(c||(c=o("I64"))).of_int32(n),h=c.of_float(t.actionType),y=void 0;try{y=yield k(e,t)}catch(e){p.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate attachment payload: ",""])),o("WAErrorMessage").maybeGetMessageFromError(e))}var C=t.protoMsg,b=C==null||(a=C.originalMsgProtocolId)==null?void 0:a.externalId,v=C==null||(i=C.msgId)==null?void 0:i.externalId,S=C!=null&&t.actionType===2;if(!S&&(t.echoDocument==null||t.echoDocument.length===0)){var R,L;p.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["upload message is missing echo document msgType: ",""])),(R=t.messageType)!=null?R:"unknown"),o("MWEBODSUtils").markODSForEB("upload","missing_echo_document."+((L=t.messageType)!=null?L:"unknown"))}var E={actionType:h,attachmentErrorCode:T(t),backupStatus:(d||(d=o("LSIntEnum"))).ofNumber(r("LSPendingBackupStatus").BACKUP_IN_PROGRESS),contentType:d.ofNumber(r("LSBackupContentType").MESSAGE),echoContent:S?"":(l=t.echoDocument)!=null?l:"",listKey:t.threadId,pendingBackupTaskId:c.of_int32(n),persistentId:"",pk:g,sortKey:f,uniqueKey:t.messageId};y!=null&&(E=babelHelpers.extends({},E,{attachmentPayload:y}));var I=yield e.pending_backups_context_v2.add(E);if(C==null)return{pending_backups_context_v2_pk:I[0],task:n,uploadTrackingInstanceKey:t.uploadTrackingInstanceKey};var D={actThreadId:t.threadId,backupAction:c.of_float(C.backupActionType),messageTimestampMs:c.of_float(t.sortOrderMs),pendingBackupTaskId:c.of_float(n),supplementalKey:C.supplementalKey,toplevelOfflineThreadingId:C.backupActionType===4?C.msgId.externalId:(m=(_=C.originalMsgProtocolId)==null?void 0:_.externalId)!=null?m:C.msgId.externalId};if(C.backupActionType===2&&b!=null&&v!=null&&b!==v&&(D=babelHelpers.extends({},D,{supplementalOfflineThreadingId:v})),y!=null&&(D=babelHelpers.extends({},D,{attachmentPayload:y})),C.backupActionType===4){var x,$=(x=C.originalMsgProtocolId)==null?void 0:x.externalId;D=babelHelpers.extends({},D,{deletionOfflineThreadingId:$})}var P=yield e.pending_protobuf_backups_context.add(D);return{pending_backups_context_v2_pk:I[0],pending_protobuf_backups_context_pk:P[0],task:n,uploadTrackingInstanceKey:t.uploadTrackingInstanceKey}}),R.apply(this,arguments)}function L(e){if(e.attachmentInfos.length!==1)return[];var t=e.attachmentInfos[0];return[{attachment_trace_id:t.attachmentTraceId,media_type:t.mediaType,zippy_object_id:t.zippyObjectId}]}function E(e){var t,n=e.bridgeUploadAttachmentBackupContext,a=e.messageId,i=e.serverThreadKey,l=e.threadId,s=e.traceId;if(n.attachmentInfos.length!==0){var u=n.attachmentInfos;o("MAWEBFrontendQPLLogger").startFlowUploadAttachmentBackup({deliveryObjectId:u[0].zippyObjectId,flow:"unified",mediaType:(t=o("MAWCastToMsgrServerMediaType").castMediaAttachmentTypeToServerMediaType(u[0].mediaType))!=null?t:"unknown",messageId:a,threadId:l,traceId:s});var c=r("LSVec").ofArray(u.map(function(e){return o("LSShape").ofRecord({attachment_trace_id:e.attachmentTraceId,media_type:e.mediaType,zippy_object_id:e.zippyObjectId})})),m=(d||(d=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR);n.error!=null&&(m=(d||(d=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR));var p={attachment_infos:c,error:m,error_message:null,product_type:n.productType,server_thread_key:i};return p}}function k(e,t){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n,a,i=t.attachmentBackupContext;if(i!=null){if(t.uploadTrackingInstanceKey!=null){var l="undefined";if(i.attachmentInfos.length>0){l="new";for(var s of i.attachmentInfos)if(s.zippyObjectId.length<=60){l="old";break}}o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t.uploadTrackingInstanceKey,"attachment_payload_generation_start",{string:{attachment_object_id_type:l}})}if(a=E({bridgeUploadAttachmentBackupContext:i,messageId:t.messageId,serverThreadKey:null,threadId:t.threadId,traceId:t.traceId}),a!=null){var u=yield r("LSSerializeAttachmentBackupPayloadStoredProcedure")(r("LSFactory")(e),{attachmentInfos:a.attachment_infos,error:a.error,errorMessage:a.error_message,messageId:t.messageId,productType:a.product_type,threadId:t.threadId}),d=u[0],m=u[1];if(d!=null){var p=o("LSShape").toRecord(d);n=JSON.stringify({success:p.payload,upload_context:L(i)}),t.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t.uploadTrackingInstanceKey,"attachment_payload_generation_success",{bool:{attachment_payload_generation_success:!0}})}else if(m!=null){var _=o("LSShape").toRecord(m),f=_.error_code;n=JSON.stringify({failure:{error_code:(c||(c=o("I64"))).to_float(f),error_message:_.error_message,stored_procedure:_.stored_procedure},upload_context:L(i)}),t.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t.uploadTrackingInstanceKey,"attachment_payload_generation_failure",{bool:{attachment_payload_generation_success:!1},string:{attachment_payload_generation_error_code:(c||(c=o("I64"))).to_string(f),attachment_payload_generation_error_message:_.error_message}})}}}return n}),I.apply(this,arguments)}function T(e){var t;return(c||(c=o("I64"))).of_float(((t=e.attachmentBackupContext)==null?void 0:t.error)!=null?r("LSEncryptedBackupsAttachmentErrorCode").UNKNOWN_ERROR:r("LSEncryptedBackupsAttachmentErrorCode").NO_ERROR)}function D(e){var t=new TextDecoder;return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.secure_encrypted_backups_epochs).filter(function(e){return t.decode(e.epochAnonIdBlob)===_})).then(function(e){return e!=null})}l.genUploadPayload=h,l.genLSUploadPayload=b}),98);
__d("XFBEBDeviceEpochStatus.facebook",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum").Mirrored(["INELIGIBLE_FOR_LABYRINTH_11","NO_OPEN_EPOCH","OK","OUTDATED","RATE_LIMITED"]),l=e;i.default=l}),66);
__d("EBUploadMessagesFromWorkerMutation",["EBBucketUtils","EBDeps","EBIsEbEnabled","EBLS","EBLogger","EBMessageProbe","EBSMAPI","EBUploadMessagesFromWorkerMutation.graphql","EncryptedBackupsWriteToMPSTables","FBLogger","I64","LSEBPayloadSerializerError","LSFactory","LSHandleBackupWriteResultV2StoredProcedure","LSPrepareOpenEpochV2StoredProcedure","LSShape","LSVec","MAWCurrentUser","MAWEBFalcoLoggerUtils","MAWEBLSInWorkerSwitch","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWODSProxy","MAWUploadPayloadGenerator","MWEBODSEntityName.enum","MpsTypes","ODS","Promise","WAErrorMessage","WALogger","WAOdsEnums","WAResultOrError","asyncToGeneratorRuntime","createWorkerMutation","err","getErrorSafe","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b=e!==void 0?e:e=n("EBUploadMessagesFromWorkerMutation.graphql");function v(e,t,n){e.forEach(function(e){e.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e.uploadTrackingInstanceKey,t,n)})}function S(e,t){e.forEach(function(e){e.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").addAnnotationsWorkerOnly(e.uploadTrackingInstanceKey,t)})}function R(e,t,n){e.forEach(function(e){e.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e.uploadTrackingInstanceKey,t,n)})}function L(e,t){if(e!=null){var n=new Map;for(var r of t){var a;if(!(r.uploadTrackingInstanceKey==null||((a=r.attachmentBackupContext)==null?void 0:a.attachmentInfos)==null))for(var i of r.attachmentBackupContext.attachmentInfos)i.attachmentTraceId!=null&&n.set(i.attachmentTraceId,r.uploadTrackingInstanceKey)}for(var l of e)if(l.upload_context.length>0){var c=l.upload_context[0].attachment_trace_id;if(c==null){o("EBLogger").EBLogger().WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Received null attachment trace id from the server"])));continue}var d=n.get(c);if(d==null){o("EBLogger").EBLogger().WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Received unknown attachment trace id from the server"])));continue}o("MAWEBUploadTrackingUtils").addPointWorkerOnly(d,"attachment_upload_response_received",{string:{attachment_upload_status:l.status==null?"unknown":l.status}})}}}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.backupWriteResult,a=e.deviceEpochStatus,l=e.exception_string,s=e.inputMessages;if(n==null)return R(s,"ebls_upload_failed_backup_write_result_null",{string:{error:"backupWriteResult is null"}}),o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backupWriteResult is null"]))),o("WAResultOrError").makeError("backup_write_result_null");var u=yield o("EBLS").getLSStorage(),m=n.is_success,p=n.delete_mailbox,_=(t=n.protobuf_params)==null?void 0:t.delete_on_success;if(m!=null&&p!=null){if(m){r("FBLogger")("wmi_eb").info("Worker successfully completed GQL upload batch of size %s",s.length),v(s,"ebls_upload_success");var g=o("EBMessageProbe").getEBMessageProbeInstance();s.forEach(function(e){g.addMarkerToItem(o("MpsTypes").toMessageId(e.messageId),"graphql_upload_success",{batch_size:s.length,is_success:!0})})}else{R(s,"ebls_upload_failed",{string:{error:l}});var f=o("EBMessageProbe").getEBMessageProbeInstance();return s.forEach(function(e){f.addMarkerToItem(o("MpsTypes").toMessageId(e.messageId),"graphql_upload_failed",{is_success:!1,upload_error:l!=null?l:"unknown_error"})}),o("WAResultOrError").makeError("gql_upload_failed")}yield u.runInTransaction(function(e){return r("LSHandleBackupWriteResultV2StoredProcedure")(r("LSFactory")(e),{deleteMailbox:p,isSuccess:m,protobufParams:_!=null?o("LSShape").ofRecord({delete_on_success:_}):void 0,traceIds:r("LSVec").ofArray(s.map(function(e){return e.traceId}))})},"readwrite",void 0,void 0,i.id+":293")}var h=a==null?"null":a;if(S(s,{string:{deviceEpochStatus:h}}),N(a)&&o("EBLogger").EBLogger().MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["EBUpload: deviceEpochStatus is not OK: ",""])),h),a==null)return o("WAResultOrError").makeError("device_epoch_status_null");e:{if(a==="NO_OPEN_EPOCH"){return v(s,"prepare_open_epoch_v2_start"),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"prepare_open_epoch"}),yield u.runInTransaction(function(e){return r("LSPrepareOpenEpochV2StoredProcedure")(r("LSFactory")(e),{backupId:void 0})},"readwrite",void 0,void 0,i.id+":333"),v(s,"prepare_open_epoch_v2_end"),o("WAResultOrError").makeResult();break e}if(a==="OUTDATED"){return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"outdated_epoch"}),yield $(s),o("WAResultOrError").makeError("bad_epoch_status");break e}if(a==="OK"){v(s,"epoch_status_ok");break e}if(a==="INELIGIBLE_FOR_LABYRINTH_11")return v(s,"ineligible_for_labyrinth_1_1"),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"ineligible_for_labyrinth_1_1"}),r("gkx")("20911")?(R(s,"ineligible_for_labyrinth_1_1",{string:{error:"ineligible for labyrinth 1.1"}}),o("WAResultOrError").makeError("bad_epoch_status")):o("WAResultOrError").makeResult();if(a==="RATE_LIMITED"){return v(s,"rate_limited"),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"rate_limited"}),o("WAResultOrError").makeResult();break e}{o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"unknown_epoch_status"}),v(s,"unknown_epoch_status");break e}}return o("WAResultOrError").makeResult()}),k.apply(this,arguments)}function I(e,t){return T.apply(this,arguments)}function T(){return T=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var a=o("EBMessageProbe").getEBMessageProbeInstance();try{var l;(C||(C=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"worker_thread"),v(e,"ebls_init_start"),yield o("EBLS").init();var s=yield o("EBLS").getLSStorage();v(e,"ebls_backup_tenancy_start");var u={bool:{is_main_thread:!1},int:{batch_size:e.length},string:{batch_bucket:o("EBBucketUtils").getBucketName(e.length,100,10),source:t}};if(S(e,u),!(yield o("EBIsEbEnabled").isEbEnabledLS(s.tables))){for(var c of e)if(c.uploadTrackingInstanceKey!=null){var d=c.uploadTrackingInstanceKey;o("MAWEBUploadTrackingUtils").addPointWorkerOnly(d,"user_device_not_enrolled_invalid_gql_request",{bool:{MAWEBLSInWorkerSwitch:r("MAWEBLSInWorkerSwitch").isEnabled(),MAWEBSwitch:r("MAWEBSwitch").isEnabled()}});var g=c.echoDocument!=null?"dual_upload":"protobuf_only";o("MAWEBFalcoLoggerUtils").logEBFalcoTaskSkipped(c,g,"user_device_not_enrolled"),o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(d,"upload_tracking_completed")}return o("WAResultOrError").makeError("user_device_not_enrolled")}v(e,"ebls_upload_start");var k;try{k=yield s.runInTransaction((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=new Map;for(var i of e)i.uploadTrackingInstanceKey!=null&&i.protoMsg!=null&&a.set(i.uploadTrackingInstanceKey,i);if(r("gkx")("18428"))v(e,"ebls_lsdb_write_skipped"),v(e,"ebls_mps_write_skipped");else{var l=yield(h||(h=n("Promise"))).allSettled(a.values().map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.protoMsg,a=e.threadId,i=e.uploadTrackingInstanceKey;if(i==null||n==null)throw r("err")("uploadTrackingInstanceKey or protoMsg are null");o("MAWEBUploadTrackingUtils").addPointWorkerOnly(i,"ebls_mps_write_start");var l=e.uploadTrackingInstanceKey!=null?o("MAWEBUploadTrackingUtils").makeEBWorkerQplFlowFromInstanceKey(e.uploadTrackingInstanceKey):null,s=yield o("EncryptedBackupsWriteToMPSTables").writeToMPSTables(t,n,a,!1,l);if(n.backupActionType===1&&(yield o("EncryptedBackupsWriteToMPSTables").writeTagsToMPSTables(t,n,a)),s.success){o("MAWEBUploadTrackingUtils").addPointWorkerOnly(i,"ebls_mps_write_success");return}var u=s.error,c=u.errorCode,d=u.errorMsg;throw D(c)?o("MAWEBUploadTrackingUtils").endCancelWorkerOnly(i,{int:{errorCode:c!=null?(y||(y=o("I64"))).to_float(c):r("LSEBPayloadSerializerError").UNKNOWN},string:{error:d}}):o("MAWEBUploadTrackingUtils").endFailWorkerOnly(i,"ebls_mps_write_failed",{string:{error:d}}),r("err")("Failed to write to MPS")});return function(t){return e.apply(this,arguments)}})())),s=a.keys().toArray();for(var u of l.entries()){var c=u[0],d=u[1];d.status==="rejected"&&a.delete(s[c])}}var m=yield o("MAWUploadPayloadGenerator").genUploadPayload(t,a.values().toArray());return m.map(function(e){if(e.success){if(e.value.msg.uploadTrackingInstanceKey!=null)return o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e.value.msg.uploadTrackingInstanceKey,"ebls_upload_payload_generated"),e.value}else{var t=e.error,n=t.error,r=t.instanceKey;return r!=null&&o("MAWEBUploadTrackingUtils").endFailWorkerOnly(r,"ebls_payload_generation_failed",{string:{error:n}}),null}}).filter(Boolean)});return function(e){return t.apply(this,arguments)}})(),"readwrite",void 0,void 0,i.id+":445")}catch(t){var I=o("WAErrorMessage").maybeGetMessageFromError(t);return R(e,"ebls_upload_failed_payload",{string:{error:I}}),o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to generate payload: ",""])),I),o("WAResultOrError").makeError("upload_serialization_failure")}if(k.length===0)return R(e,"ebls_upload_payload_empty"),o("WAResultOrError").makeResult();var T=k.map(function(e){return e.msg});T.forEach(function(e){var t=e.echoDocument!=null?"dual_upload":"protobuf_only";o("MAWEBFalcoLoggerUtils").logEBFalcoTaskIssued(e,t)});var $=r("createWorkerMutation")(b),P=$[0];T.forEach(function(e){a.addMarkerToItem(o("MpsTypes").toMessageId(e.messageId),"graphql_upload_start")});var N=yield P({input:{app_id_str:o("MAWCurrentUser").getAppID(),payload:{msg_payloads:k.map(function(e){return e.payload}).filter(Boolean)}}});if(v(T,"ebls_received_gql_upload_response"),N==null)return R(T,"ebls_upload_failed_response_null"),o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphqlResponse is null"]))),T.forEach(function(e){var t=e.echoDocument!=null?"dual_upload":"protobuf_only";o("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(e,t,"ebls_not_initialized"),a.addMarkerToItem(o("MpsTypes").toMessageId(e.messageId),"graphql_upload_failed_null_response")}),o("WAResultOrError").makeError("gql_upload_null_response");var M=(l=N.xfb_upload_encrypted_msg_to_backup)!=null?l:{},w=M.exception_string,A=M.labyrinth_1_0;L(A==null?void 0:A.attachment_upload_status,T);var F=yield E({backupWriteResult:A==null?void 0:A.backup_write_result_response,deviceEpochStatus:A==null?void 0:A.device_epoch_status,exception_string:w,inputMessages:T});return F.success?T.forEach(function(e){o("MAWEBFalcoLoggerUtils").logEBFalcoEncryptedBackupUploadSuccess(e)}):T.forEach(function(e){var t=e.echoDocument!=null?"dual_upload":"protobuf_only";o("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(e,t,F.error)}),F}catch(t){var O=r("getErrorSafe")(t);return R(e,"ebls_upload_failed_response",{string:{error:O.message}}),x(t)&&(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"mismatched_vsr_fingerprint"}),r("justknobx")._("5155")&&(yield r("EBSMAPI").deleteBackupsOnClient({reason:"vsr_fingerprint_mismatch"}))),o("EBLogger").EBLogger().catching(O).MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["EB graphql upload failed"]))),e.forEach(function(e){var t=e.echoDocument!=null?"dual_upload":"protobuf_only";o("MAWEBFalcoLoggerUtils").logEBFalcoTaskFailure(e,t,"ebls_not_initialized"),a.addMarkerToItem(o("MpsTypes").toMessageId(e.messageId),"graphql_upload_exception")}),o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to upload with EBLS: ",""])),t),o("WAResultOrError").makeError("gql_upload_runtime_error")}}),T.apply(this,arguments)}function D(e){var t=e!=null?(y||(y=o("I64"))).to_int32(e):null;switch(t){case r("LSEBPayloadSerializerError").SKIP_MPS_WRITE_DUE_TO_HIGHER_TIMESTAMP_AVAILABILITY:case r("LSEBPayloadSerializerError").MESSAGE_ALREADY_DELETED:return!0;default:return!1}return!1}function x(e){return e!=null&&typeof e=="object"&&"code"in e&&e.code===2018471}function $(e){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){v(e,"sync_epochs_start");var t=yield o("EBDeps").getDeps().getEBSMAPI(),n=yield t.syncEpochs();if(n.success===!1){var r;o("EBLogger").EBLogger().MUSTFIX(g||(g=babelHelpers.taggedTemplateLiteralLoose(["EBUpload syncEpochs failed due to: ",""])),n.error),v(e,"sync_epochs_failure"),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"sync_epochs_failure"}),R(e,"sync_epochs_failed",{string:{error:(r=n.error)!=null?r:"unknown sync epochs error"}}),v(e,"fetch_backup_ids_start"),yield t.fetchBackupIds("sync_epochs_failure"),v(e,"fetch_backup_ids_end")}else o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"sync_epochs_success"}),v(e,"sync_epochs_end")}),P.apply(this,arguments)}function N(e){return e==null?!0:!(e==="NO_OPEN_EPOCH"||e==="OK"||e==="RATE_LIMITED")}l.uploadMessagesFromWorker=I}),98);
__d("EchoSerializationFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5722"),s=o("FalcoLoggerInternal").create("echo_serialization_failure",e),u=s;l.default=u}),98);
__d("EchoSerializationSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5723"),s=o("FalcoLoggerInternal").create("echo_serialization_success",e),u=s;l.default=u}),98);
__d("EncryptedBackupTaskSkippedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5727"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_skipped",e),u=s;l.default=u}),98);
__d("LSCreateExtraVirtualDeviceWithRecoveryCodeData",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDebugToken.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignatureWithArmadilloKey.nop","LSCreateSignature_v2.nop","LSGetArmadilloPublicKey.nop","LSGetBlobFromString.nop","LSGetOpenEpochKeys","LSGetViewerFBID","LSHandleCreateVirtualDeviceFailure","LSHmac_v2.nop","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSParseRecoveryCode_v2.nop","LSSymmetricEncryptionCreateEncryptedString.nop","justknobx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(a){return t.sequence([function(n){return o[0]=e[2].get("recovery_code"),o[1]=e[2].get("virtual_device_type"),o[2]=e[2].get("cloud_service_account"),o[3]=e[2].get("hsm_pin_normalization_status"),o[4]=e[2].get("security_question_type"),o[5]=e[2].get("trusted_contact_id"),t.db.table(168).fetch().next().then(function(e,n){var r=e.done,a=e.value;return r?o[6]=t.i64.cast([0,1]):(n=a.item,o[9]=n.backupTenancy,t.i64.neq(o[9],void 0)?o[8]=o[9]:o[8]=t.i64.cast([0,1]),o[6]=o[8])})},function(a){return t.i64.eq(o[6],t.i64.cast([0,1]))&&o[0]==="1SHADOWTESTINGRECOVERYCODE00000000000000"?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Invalid Recovery Code Used."),o[9]="Invalid Recovery Code Used.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[9]].join("")),o[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[9],o[8],t.i64.cast([0,3]))):t.sequence([function(e){return o[8]=t.createArray(),t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,o[9]=t[0],t})},function(e){return t.nativeOperation(n("LSParseRecoveryCode_v2.nop"),o[0],t.i64.to_string(o[9]),o[8]).then(function(e){var t;return t=e,o[10]=t[0],o[11]=t[1],t})},function(a){return t.blobs.neq(o[11],void 0)?t.blobs.neq(o[10],void 0)?t.sequence([function(e){return t.storedProcedure(n("LSGetOpenEpochKeys"),!1).then(function(e){var t;return t=e,o[12]=t[0],t})},function(a){return o[12]!==void 0?t.sequence([function(a){return o[79]=r("justknobx")._("1310"),e[3]!==void 0?o[79]?t.sequence([function(r){return e[3]!==void 0?t.storedProcedure(n("LSAppendDataTraceAddon"),e[3],t.i64.cast([0,2866]),t.i64.cast([0,2]),void 0,void 0):t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[89]?o[90]=!0:o[90]=!1,o[90]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),o[92]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",o[92]].join("")),o[91]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",o[92],o[91],t.i64.cast([0,3]))):t.resolve()}]):t.sequence([function(r){return e[3]!==void 0?t.storedProcedure(n("LSAppendDataTraceAddon"),e[3],t.i64.cast([0,2867]),t.i64.cast([0,2]),void 0,void 0):t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[89]?o[90]=!0:o[90]=!1,o[90]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),o[92]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",o[92]].join("")),o[91]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",o[92],o[91],t.i64.cast([0,3]))):t.resolve()}]):t.resolve()},function(e){return o[79]?t.resolve():t.sequence([function(e){return t.count(t.db.table(169).fetch()).then(function(e){return o[89]=e})},function(e){return t.i64.gt(o[89],t.i64.cast([0,1]))?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Multiple rows in $epoch_tables."),o[91]="Multiple rows in $epoch_tables.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[91]].join("")),o[90]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[91],o[90],t.i64.cast([0,3]))):t.resolve()}])},function(e){return t.nativeOperation(n("LSCreateSignatureKeyPair.nop")).then(function(e){var t;return t=e,o[13]=t[0],o[14]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateEncryptionKeyPair.nop")).then(function(e){var t;return t=e,o[15]=t[0],o[16]=t[1],t})},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[13],t.blob("MA=="),o[16]).then(function(e){var t;return t=e,o[17]=t[0],t})},function(r){return o[80]=t.blob(""),o[81]=t.blob(""),o[82]=t.blob(""),t.db.table(168).fetch([[[e[1]]]]).next().then(function(e,r){var a,i=e.done,l=e.value;return i?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Row with backupid not found in client state table"),o[90]="Row with backupid not found in client state table",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))},function(e){var t;return t=[o[80],o[81],void 0,o[82]],o[18]=t[0],o[19]=t[1],o[20]=t[2],o[21]=t[3],t}]):(r=l.item,a=[r.obliviousValidationTokenBlob,r.mailboxRootKeyBlob,r.deviceId,r.ocmfClientStateBlob],o[18]=a[0],o[19]=a[1],o[20]=a[2],o[21]=a[3])})},function(e){return t.blobs.eq(o[18],o[80])?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] oblivious_token is empty!"),o[90]="oblivious_token is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return t.blobs.eq(o[19],o[81])?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] mailbox_root_key is empty!"),o[90]="mailbox_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return t.blobs.eq(o[21],o[82])?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ocmf_client_state is empty!"),o[90]="ocmf_client_state is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return o[23]=o[12].get("epoch_anon_id"),o[24]=o[12].get("epoch_root_key"),o[25]=t.createArray(),o[89]=(o[25].push(t.i64.cast([0,32])),o[25]),t.nativeOperation(n("LSBase64Encode.nop"),o[23]).then(function(e){var t;return t=e,o[26]=t[0],t})},function(e){return o[26]!==void 0?t.sequence([function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blobs.of_string(["epoch_devices","_",o[26]].join("")),void 0,o[24],o[25]).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[89]?o[90]=!1:o[90]=!0,o[90]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),o[93]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[93]].join("")),o[92]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[93],o[92],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[94]=t[0],t})},function(e){return o[91]=o[94]}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[89],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[92]=t[0],o[93]=t[1],t})},function(e){return o[91]=o[92]}])},function(e){return o[27]=o[91]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),o[90]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoEpochUtils] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",o[90],o[89],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[91]=t[0],t})},function(e){return o[27]=o[91]}])},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),o[27],o[14]).then(function(e){var t;return t=e,o[28]=t[0],t})},function(e){return t.blobs.neq(o[28],void 0)?t.resolve(o[29]=o[28]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] device_epoch_hmac is null!"),o[90]="device_epoch_hmac is null!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),"").then(function(e){var t;return t=e,o[91]=t[0],t})},function(e){return o[29]=o[91]}])},function(e){return o[30]=o[12].get("epoch_root_key"),t.blobs.neq(o[30],void 0)?t.sequence([function(e){return o[89]=t.createArray(),o[95]=(o[89].push(t.i64.cast([0,18])),o[89]),t.nativeOperation(n("LSCreateDerivedKeys.nop"),t.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,o[30],o[89]).then(function(e){var t;return t=e,o[90]=t[0],t})},function(e){return o[90]!==void 0?t.sequence([function(e){return o[95]=t.i64.of_int32(o[90].length),t.i64.ge(o[95],t.i64.cast([0,1]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[90],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[97]=t[0],o[98]=t[1],t})},function(e){return o[96]=o[97]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),o[98]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",o[98]].join("")),o[97]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",o[98],o[97],t.i64.cast([0,3]))},function(e){return o[96]=void 0}])},function(e){return o[91]=o[96]}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),o[96]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBFingerprint] ","",o[96]].join("")),o[95]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBFingerprint",o[96],o[95],t.i64.cast([0,3]))},function(e){return o[91]=void 0}])},function(e){return t.blobs.neq(o[91],void 0)?o[92]=!0:o[92]=!1,o[92]||((function(e){t.logger(e).mustfix(e)})("LS::assert is failed. Attempting to coerce a null value to nonnull."),t.throw("LS::assert is failed. Attempting to coerce a null value to nonnull.")),t.nativeOperation(n("LSBase64Encode.nop"),o[91]).then(function(e){var t;return t=e,o[93]=t[0],t})},function(e){return o[93]!==void 0?o[94]=o[93]:o[94]="encodingfailed",o[31]=o[94]}]):t.resolve(o[31]="null")},function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),o[21]).then(function(e){var t;return t=e,o[32]=t[0],o[33]=t[1],t})},function(e){var r;return t.blobs.neq(void 0,void 0)?t.sequence([function(e){return t.nativeOperation(n("LSOcmfClientEvolve_v2.nop"),void 0).then(function(e){var t;return t=e,o[89]=t[0],o[90]=t[1],t})},function(e){var t;return t=[o[32],o[33],o[89],o[90]],o[34]=t[0],o[35]=t[1],o[36]=t[2],o[37]=t[3],t}]):t.resolve((r=[o[32],o[33],void 0,void 0],o[34]=r[0],o[35]=r[1],o[36]=r[2],o[37]=r[3],r))},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[13]).then(function(e){var t;return t=e,o[38]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),o[38]==null?"":o[38]).then(function(e){var t;return t=e,o[39]=t[0],t})},function(e){return o[39]!==void 0?o[40]=o[39]:o[40]="",o[40]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_device_private_key is empty!"),o[90]="encrypted_device_private_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[15]).then(function(e){var t;return t=e,o[41]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),o[41]==null?"":o[41]).then(function(e){var t;return t=e,o[42]=t[0],t})},function(e){return o[42]!==void 0?o[43]=o[42]:o[43]="",o[43]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_epoch_storage_private_key is empty!"),o[90]="encrypted_epoch_storage_private_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[34]).then(function(e){var t;return t=e,o[44]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),o[44]==null?"":o[44]).then(function(e){var t;return t=e,o[45]=t[0],t})},function(e){return o[45]!==void 0?o[46]=o[45]:o[46]="",o[46]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),o[90]="encrypted_orf_client_state_v1_shape is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[18]).then(function(e){var t;return t=e,o[47]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),o[47]==null?"":o[47]).then(function(e){var t;return t=e,o[48]=t[0],t})},function(e){return o[48]!==void 0?o[49]=o[48]:o[49]="",o[49]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_oblivious_validation_token is empty!"),o[90]="encrypted_oblivious_validation_token is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[19]).then(function(e){var t;return t=e,o[50]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),o[50]==null?"":o[50]).then(function(e){var t;return t=e,o[51]=t[0],t})},function(e){return o[51]!==void 0?o[52]=o[51]:o[52]="",o[52]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_mailbox_root_key is empty!"),o[90]="encrypted_mailbox_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return o[53]=o[12].get("epoch_anon_id"),t.nativeOperation(n("LSBase64Encode.nop"),o[53]).then(function(e){var t;return t=e,o[54]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),o[54]==null?"":o[54]).then(function(e){var t;return t=e,o[55]=t[0],t})},function(e){return o[55]!==void 0?o[56]=o[55]:o[56]="",o[56]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_epoch_anon_id is empty!"),o[90]="encrypted_epoch_anon_id is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return o[57]=o[12].get("epoch_root_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[57]).then(function(e){var t;return t=e,o[58]=t[0],t})},function(e){return t.nativeOperation(n("LSSymmetricEncryptionCreateEncryptedString.nop"),o[11],t.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),o[58]==null?"":o[58]).then(function(e){var t;return t=e,o[59]=t[0],t})},function(e){return o[59]!==void 0?o[60]=o[59]:o[60]="",o[60]===""?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] encrypted_epoch_root_key is empty!"),o[90]="encrypted_epoch_root_key is empty!",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[90]].join("")),o[89]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[90],o[89],t.i64.cast([0,3]))):t.resolve()},function(e){return o[61]=new t.Map,o[61].set("encrypted_device_private_key",o[40]),o[61].set("encrypted_epoch_storage_private_key",o[43]),o[61].set("encrypted_ocmf_client_state",o[46]),o[61].set("encrypted_orf_client_state_v2",void 0),o[61].set("encrypted_oblivious_validation_token_blob",o[49]),o[61].set("encrypted_mailbox_root_key_blob",o[52]),o[61].set("encrypted_epoch_anon_id",o[56]),o[61].set("encrypted_epoch_root_key",o[60]),t.nativeOperation(n("LSBase64Encode.nop"),o[10]).then(function(e){var t;return t=e,o[62]=t[0],t})},function(e){return o[83]=o[62]==null?"":o[62],t.nativeOperation(n("LSBase64Encode.nop"),o[14]).then(function(e){var t;return t=e,o[63]=t[0],t})},function(e){return o[84]=o[63]==null?"":o[63],t.nativeOperation(n("LSBase64Encode.nop"),o[16]).then(function(e){var t;return t=e,o[64]=t[0],t})},function(e){return o[85]=o[64]==null?"":o[64],t.nativeOperation(n("LSBase64Encode.nop"),o[17]==null?t.blob("bnVsbA=="):o[17]).then(function(e){var t;return t=e,o[65]=t[0],t})},function(e){return o[86]=o[65]==null?"":o[65],t.nativeOperation(n("LSBase64Encode.nop"),o[29]).then(function(e){var t;return t=e,o[66]=t[0],t})},function(e){return o[87]=o[66]==null?"":o[66],t.nativeOperation(n("LSBase64Encode.nop"),o[35]).then(function(e){var t;return t=e,o[67]=t[0],t})},function(e){return o[88]=o[67]==null?"":o[67],t.nativeOperation(n("LSGetBlobFromString.nop"),o[0]).then(function(e){var t;return t=e,o[68]=t[0],t})},function(e){return t.blobs.neq(o[19],void 0)?t.sequence([function(e){return o[89]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[19],"private_key",o[13],t.i64.cast([0,1]),o[89]).then(function(e){var t;return t=e,o[90]=t[0],t})},function(e){return t.blobs.neq(o[90],void 0)?o[91]=o[90]:o[91]=void 0,o[69]=o[91]}]):t.resolve(o[69]=void 0)},function(e){return t.blobs.neq(o[69],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[69]).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[70]=o[89]}]):t.resolve(o[70]=void 0)},function(e){return t.blobs.neq(o[19],void 0)?t.sequence([function(e){return o[89]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[19],"ocmf_client_state",o[34],t.i64.cast([0,1]),o[89]).then(function(e){var t;return t=e,o[90]=t[0],t})},function(e){return t.blobs.neq(o[90],void 0)?o[91]=o[90]:o[91]=void 0,o[71]=o[91]}]):t.resolve(o[71]=void 0)},function(e){return t.blobs.neq(o[71],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[71]).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[72]=o[89]}]):t.resolve(o[72]=void 0)},function(e){return t.blobs.neq(o[19],void 0)?t.sequence([function(e){return o[89]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[19],"epoch_storage_private_key",o[15],t.i64.cast([0,1]),o[89]).then(function(e){var t;return t=e,o[90]=t[0],t})},function(e){return t.blobs.neq(o[90],void 0)?o[91]=o[90]:o[91]=void 0,o[73]=o[91]}]):t.resolve(o[73]=void 0)},function(e){return t.blobs.neq(o[73],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[73]).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[74]=o[89]}]):t.resolve(o[74]=void 0)},function(e){return t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,o[75]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),t.i64.to_string(o[75])).then(function(e){var t;return t=e,o[76]=t[0],t})},function(e){return t.blobs.neq(o[76],void 0)?t.sequence([function(e){return o[89]=new t.Map,t.nativeOperation(n("LSCreateDebugToken.nop"),o[76],"recovery_code",o[68],t.i64.cast([0,1]),o[89]).then(function(e){var t;return t=e,o[90]=t[0],t})},function(e){return t.blobs.neq(o[90],void 0)?o[91]=o[90]:o[91]=void 0,o[77]=o[91]}]):t.resolve(o[77]=void 0)},function(e){return t.blobs.neq(o[77],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSBase64Encode.nop"),o[77]).then(function(e){var t;return t=e,o[89]=t[0],t})},function(e){return o[78]=o[89]}]):t.resolve(o[78]=void 0)},function(r){return t.i64.neq(o[20],void 0)?t.sequence([function(e){return o[89]=o[12].get("epoch_id"),t.db.table(168).fetch().next().then(function(e,n){var r=e.done,a=e.value;return r?o[90]=t.i64.cast([0,1]):(n=a.item,o[95]=n.backupTenancy,t.i64.neq(o[95],void 0)?o[94]=o[95]:o[94]=t.i64.cast([0,1]),o[90]=o[94])})},function(e){return t.i64.eq(o[90],t.i64.cast([0,2]))?t.resolve(o[92]=void 0):t.sequence([function(e){return t.nativeOperation(n("LSGetArmadilloPublicKey.nop")).then(function(e){var t;return t=e,o[94]=t[0],t})},function(e){return o[92]=o[94]}])},function(e){return t.blobs.neq(o[92],void 0)?t.sequence([function(e){return t.nativeOperation(n("LSCreateSignatureWithArmadilloKey.nop"),o[14]).then(function(e){var t;return t=e,o[94]=t[0],t})},function(e){return t.blobs.neq(o[94],void 0)?t.resolve(o[95]=o[94]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create labyrinth signature"),o[100]="Failed to create labyrinth signature",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",o[100]].join("")),o[99]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",o[100],o[99],t.i64.cast([0,3]))},function(e){return o[95]=void 0}])},function(e){return t.nativeOperation(n("LSCreateSignature_v2.nop"),o[13],t.blob("Mw=="),o[92]).then(function(e){var t;return t=e,o[96]=t[0],t})},function(e){return t.blobs.neq(o[96],void 0)?t.resolve(o[97]=o[96]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoKeySigningUtils] Failed to create armadillo signature"),o[100]="Failed to create armadillo signature",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoKeySigningUtils] ","",o[100]].join("")),o[99]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoKeySigningUtils",o[100],o[99],t.i64.cast([0,3]))},function(e){return o[97]=void 0}])},function(e){return t.blobs.neq(o[97],void 0)?(t.blobs.neq(o[95],void 0)?(o[100]=new t.Map,o[100].set("armadillo_public_key",o[92]),o[100].set("armadillo_key_signature",o[97]),o[100].set("labyrinth_key_signature",o[95]),o[99]=o[100]):o[99]=void 0,o[98]=o[99]):o[98]=void 0,o[93]=o[98]}]):t.resolve(o[93]=void 0)},function(r){return o[93]!==void 0?t.sequence([function(e){return o[94]=o[93].get("armadillo_public_key"),t.nativeOperation(n("LSBase64Encode.nop"),o[94]).then(function(e){var t;return t=e,o[95]=t[0],t})},function(e){return o[96]=o[93].get("armadillo_key_signature"),t.nativeOperation(n("LSBase64Encode.nop"),o[96]).then(function(e){var t;return t=e,o[97]=t[0],t})},function(e){return o[98]=o[93].get("labyrinth_key_signature"),t.nativeOperation(n("LSBase64Encode.nop"),o[98]).then(function(e){var t;return t=e,o[99]=t[0],t})},function(r){return o[100]=new t.Map,o[100].set("backup_id",e[1]),o[100].set("request_device_id",o[20]),o[100].set("virtual_device_id",o[83]),o[100].set("encrypted_secret_values",o[61]),o[100].set("public_key",o[84]),o[100].set("epoch_storage_pubkey",o[85]),o[100].set("epoch_storage_pubkey_sig",o[86]),o[100].set("device_epoch_hmac",o[87]),o[100].set("epoch_root_key_fingerprint",o[31]),o[100].set("ocmf_rotation_token",o[88]),o[100].set("is_init",!1),o[100].set("epoch_id",o[89]),o[100].set("virtual_device_type",o[1]),o[100].set("action_type",e[0]),o[100].set("private_key_debug_token",o[70]),o[100].set("ocmf_client_state_debug_token",o[72]),o[100].set("epoch_storage_pvtkey_debug_token",o[74]),o[100].set("recovery_code_debug_token",o[78]),o[100].set("trace_id",e[3]),o[100].set("cloud_service_account",o[2]),o[100].set("hsm_pin_normalization_status",o[3]),o[100].set("security_question_type",o[4]),o[100].set("trusted_contact_id",o[5]),o[100].set("armadillo_public_key",o[95]==null?"":o[95]),o[100].set("armadillo_key_signature",o[97]==null?"":o[97]),o[100].set("labyrinth_key_signature",o[99]==null?"":o[99]),o[101]=t.toJSON(o[100]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50004]),o[101],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),e[3],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[102]=t[0],t})}]):((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] failed to get armadillo key and device signatures"),o[94]=new t.Map,o[94].set("backup_id",e[1]),o[94].set("request_device_id",o[20]),o[94].set("virtual_device_id",o[83]),o[94].set("encrypted_secret_values",o[61]),o[94].set("public_key",o[84]),o[94].set("epoch_storage_pubkey",o[85]),o[94].set("epoch_storage_pubkey_sig",o[86]),o[94].set("device_epoch_hmac",o[87]),o[94].set("epoch_root_key_fingerprint",o[31]),o[94].set("ocmf_rotation_token",o[88]),o[94].set("is_init",!1),o[94].set("epoch_id",o[89]),o[94].set("virtual_device_type",o[1]),o[94].set("action_type",e[0]),o[94].set("private_key_debug_token",o[70]),o[94].set("ocmf_client_state_debug_token",o[72]),o[94].set("epoch_storage_pvtkey_debug_token",o[74]),o[94].set("recovery_code_debug_token",o[78]),o[94].set("trace_id",e[3]),o[94].set("cloud_service_account",o[2]),o[94].set("hsm_pin_normalization_status",o[3]),o[94].set("security_question_type",o[4]),o[94].set("trusted_contact_id",o[5]),o[95]=t.toJSON(o[94]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50004]),o[95],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),e[3],t.i64.cast([0,0])).then(function(e){var t;return t=e,o[96]=t[0],t}))}]):t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[1],!1,e[3])}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Epoch keys are unavailable."),o[14]="Epoch keys are unavailable.",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[14]].join("")),o[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[14],o[13],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[1],!1,e[3])}])}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Invalid Recovery Code Provided"),o[13]="Invalid Recovery Code Provided",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[13]].join("")),o[12]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[13],o[12],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[1],!1,e[3])}]):t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] Invalid Recovery Code Provided"),o[13]="Invalid Recovery Code Provided",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure] ","",o[13]].join("")),o[12]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsCreateVirtualDeviceV2StoredProcedure",o[13],o[12],t.i64.cast([0,3]))},function(r){return t.storedProcedure(n("LSHandleCreateVirtualDeviceFailure"),e[1],!1,e[3])}])}])}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];var s=e;l.default=s}),98);
__d("LSCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure",["LSCreateExtraVirtualDeviceWithRecoveryCodeData","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSCreateExtraVirtualDeviceWithRecoveryCodeData"),a.actionType,a.backupId,a.recoveryCodeData,a.traceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSCreateResignCDNUrlPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSBinaryToHex.nop","LSCreateDerivedKeys.nop","LSFindBackup","LSGetBlobFromInt64BE.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientMap.nop","LSOpeEncrypt.nop","LSTruncateSortKey.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return e[10]?t.sequence([function(o){var a;return t.blobs.neq(e[11],void 0)?t.sequence([function(o){var a;return t.i64.neq(e[8],void 0)?t.sequence([function(o){var a;return e[9]!==void 0?t.sequence([function(o){var a;return t.blobs.neq(e[12],void 0)?t.sequence([function(o){return r[10]=t.createArray(),r[19]=(r[10].push(e[9]),r[10]),r[19]=(r[10].push(e[1]),r[10]),r[11]=t.toJSON(r[10]),r[12]=t.createArray(),r[19]=(r[12].push(t.i64.cast([0,32])),r[12]),t.nativeOperation(n("LSGetBlobFromString.nop"),["thread_ope_key","_",e[5]].join("")).then(function(e){var t;return t=e,r[13]=t[0],t})},function(o){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),r[13],void 0,e[12],r[12]).then(function(e){var t;return t=e,r[14]=t[0],t})},function(e){return r[14]?r[15]=!1:r[15]=!0,r[15]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),r[20]="Got null keys while deriving message list OPE key. Returning null blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoUtils] ","",r[20]].join("")),r[19]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoUtils",r[20],r[19],t.i64.cast([0,3]))},function(e){return r[16]=void 0}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[14],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[19]=t[0],r[20]=t[1],t})},function(e){return r[16]=r[19]}])},function(o){var a;return t.blobs.neq(r[16],void 0)?t.sequence([function(o){return t.nativeOperation(n("LSGetBlobFromInt64BE.nop"),e[6]).then(function(e){var t;return t=e,r[19]=t[0],t})},function(e){return t.nativeOperation(n("LSTruncateSortKey.nop"),r[19]).then(function(e){var t;return t=e,r[20]=t[0],t})},function(e){return t.nativeOperation(n("LSOpeEncrypt.nop"),r[16],r[20],t.i64.cast([0,16])).then(function(e){var t;return t=e,r[21]=t[0],t})},function(e){return t.nativeOperation(n("LSBinaryToHex.nop"),r[21]).then(function(e){var t;return t=e,r[22]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),r[11]).then(function(e){var t;return t=e,r[23]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),r[23]).then(function(e){var t;return t=e,r[24]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[24]).then(function(e){var t;return t=e,r[25]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[25]).then(function(e){var t;return t=e,r[26]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[9]).then(function(e){var t;return t=e,r[27]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWFpbGJveF9pZF9zY29wZQ=="),r[27]).then(function(e){var t;return t=e,r[28]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[28]).then(function(e){var t;return t=e,r[29]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[29]).then(function(e){var t;return t=e,r[30]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[4]).then(function(e){var t;return t=e,r[31]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWVzc2FnZV9pZF9zY29wZQ=="),r[31]).then(function(e){var t;return t=e,r[32]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[32]).then(function(e){var t;return t=e,r[33]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[33]).then(function(e){var t;return t=e,r[34]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[4]).then(function(e){var t;return t=e,r[35]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),r[35]).then(function(e){var t;return t=e,r[36]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[36]).then(function(e){var t;return t=e,r[37]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[37]).then(function(e){var t;return t=e,r[38]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[5]).then(function(e){var t;return t=e,r[39]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("dGhyZWFkX2lkX3Njb3Bl"),r[39]).then(function(e){var t;return t=e,r[40]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[40]).then(function(e){var t;return t=e,r[41]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[41]).then(function(e){var t;return t=e,r[42]=t[0],t})},function(o){return r[43]=new t.Map,r[43].set("attachment_index_key",r[26]==null?"":r[26]),r[43].set("backup_ent_fbid",e[0]),r[43].set("delivery_object_id",e[1]),r[43].set("device_id",e[8]),r[43].set("mailbox_partial_id",r[30]==null?"":r[30]),r[43].set("media_type",e[3]),r[43].set("message_partial_id",r[34]==null?"":r[34]),r[43].set("product_type",e[2]),r[43].set("salt_partial_id",r[38]==null?"":r[38]),r[43].set("sort_key",r[22]==null?"":r[22]),r[43].set("thread_partial_id",r[42]==null?"":r[42]),r[43].set("isOpenEB",e[10]===!0),r[44]=new t.Map,r[44].set("otid",e[4]),r[44].set("server_thread_key",e[7]),r[44].set("timestamp",t.i64.to_string(e[6])),t.nativeOperation(n("LSBase64Encode.nop"),e[11]).then(function(e){var t;return t=e,r[45]=t[0],t})},function(o){return t.nativeOperation(n("LSBase64Encode.nop"),e[12]).then(function(e){var t;return t=e,r[46]=t[0],t})},function(o){return r[47]=new t.Map,r[47].set("ocmf_client_state_blob",r[45]==null?"":r[45]),r[47].set("mailbox_root_key",r[46]==null?"":r[46]),r[48]=t.createArray(),r[60]=(r[48].push(e[4]),r[48]),r[60]=(r[48].push(e[1]),r[48]),r[49]=t.toJSON(r[48]),r[43].set("raw_identifiers",r[44]),r[43].set("backup_id",e[9]),r[43].set("thread_id",e[5]),t.nativeOperation(n("LSGetBlobFromString.nop"),r[49]).then(function(e){var t;return t=e,r[50]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),r[50]).then(function(e){var t;return t=e,r[51]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[51]).then(function(e){var t;return t=e,r[52]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[52]).then(function(e){var t;return t=e,r[53]=t[0],t})},function(e){return r[43].set("salt_partial_access_token",r[53]==null?"":r[53]),t.nativeOperation(n("LSGetBlobFromString.nop"),r[11]).then(function(e){var t;return t=e,r[54]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),r[54]).then(function(e){var t;return t=e,r[55]=t[0],t})},function(o){return t.nativeOperation(n("LSOcmfClientMap.nop"),e[11],r[55]).then(function(e){var t;return t=e,r[56]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[56]).then(function(e){var t;return t=e,r[57]=t[0],t})},function(n){var o;return r[43].set("salt_partial_attachment_index_key",r[57]==null?"":r[57]),r[43].set("raw_tokens",r[47]),e[13]!==void 0&&r[43].set("access_token_secret",e[13]),e[14]!==void 0&&r[43].set("primary_key_secret",e[14]),r[58]=t.toJSON(r[43]),r[59]=new t.Map,r[59].set("payload",r[58]),o=[r[59],void 0],r[17]=o[0],r[18]=o[1]}]):t.resolve((r[19]=new t.Map,r[19].set("error_code",t.i64.cast([0,25])),r[19].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[19].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),a=[void 0,r[19]],r[17]=a[0],r[18]=a[1]))},function(e){var t;return t=[r[17],r[18]],r[8]=t[0],r[9]=t[1],t}]):t.resolve((r[10]=new t.Map,r[10].set("error_code",t.i64.cast([0,20])),r[10].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[10].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),a=[void 0,r[10]],r[8]=a[0],r[9]=a[1]))},function(e){var t;return t=[r[8],r[9]],r[6]=t[0],r[7]=t[1],t}]):t.resolve((r[8]=new t.Map,r[8].set("error_code",t.i64.cast([0,1])),r[8].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[8].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),a=[void 0,r[8]],r[6]=a[0],r[7]=a[1]))},function(e){var t;return t=[r[6],r[7]],r[4]=t[0],r[5]=t[1],t}]):t.resolve((r[6]=new t.Map,r[6].set("error_code",t.i64.cast([0,24])),r[6].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[6].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),a=[void 0,r[6]],r[4]=a[0],r[5]=a[1]))},function(e){var t;return t=[r[4],r[5]],r[2]=t[0],r[3]=t[1],t}]):t.resolve((r[4]=new t.Map,r[4].set("error_code",t.i64.cast([0,22])),r[4].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[4].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),a=[void 0,r[4]],r[2]=a[0],r[3]=a[1]))},function(e){var t;return t=[r[2],r[3]],r[0]=t[0],r[1]=t[1],t}]):t.sequence([function(e){return t.islc(t.filter(t.db.table(168).fetch(),function(e){return t.i64.eq(e.authorityLevel,t.i64.cast([0,80]))}),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,o){var a,i=e.done,l=e.value;return i?(a=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,t.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,t.i64.cast([0,20]),void 0,void 0],r[2]=a[0],r[3]=a[1],r[4]=a[2],r[5]=a[3],r[6]=a[4],r[7]=a[5],r[8]=a[6],r[9]=a[7],r[10]=a[8],r[11]=a[9],r[12]=a[10],r[13]=a[11],r[14]=a[12],r[15]=a[13],r[16]=a[14],r[17]=a[15],r[18]=a[16],r[19]=a[17],a):(o=l.item,t.sequence([function(e){return r[29]=o.backupTenancy,r[28]=o.encryptionVersion,r[24]=void 0,t.i64.neq(r[24],void 0)?t.resolve(r[25]=r[24]):t.sequence([function(e){return r[30]=t.createArray(),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,0])).then(function(e){var t;return t=e,r[31]=t[0],t})},function(e){return r[31]&&(r[40]=(r[30].push(t.i64.cast([0,0])),r[30])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,2])).then(function(e){var t;return t=e,r[32]=t[0],t})},function(e){return r[32]&&(r[40]=(r[30].push(t.i64.cast([0,2])),r[30])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,3])).then(function(e){var t;return t=e,r[33]=t[0],t})},function(e){return r[33]&&(r[40]=(r[30].push(t.i64.cast([0,3])),r[30])),t.storedProcedure(n("LSIsEncryptionVersionSecure"),t.i64.cast([0,4])).then(function(e){var t;return t=e,r[34]=t[0],t})},function(e){return r[34]&&(r[40]=(r[30].push(t.i64.cast([0,4])),r[30])),r[35]=t.createArray(),r[36]=t.i64.of_int32(r[30].length),t.i64.gt(r[36],t.i64.cast([0,0]))?t.loopAsync(r[36],function(e){return r[40]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[30],r[40]).then(function(e){var t;return t=e,r[41]=t[0],r[42]=t[1],t})},function(e){return r[43]=(r[35].push(r[41]),r[35])}])}):t.resolve()},function(e){return t.sequence([function(e){return r[40]=t.createArray(),r[41]=t.i64.of_int32(r[35].length),t.i64.gt(r[41],t.i64.cast([0,0]))?t.loopAsync(r[41],function(e){return r[43]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[35],r[43]).then(function(e){var t;return t=e,r[44]=t[0],r[45]=t[1],t})},function(e){return r[46]=(r[40].push(t.i64.to_string(r[44])),r[40])}])}):t.resolve()},function(e){return r[42]=r[40].join(","),r[37]=r[42]}])},function(e){return r[35].some(function(e){return t.i64.eq(r[28],e)})?r[38]=r[28]:r[38]=void 0,t.i64.neq(r[38],void 0)?r[39]=r[38]:r[39]=void 0,r[25]=r[39]}])},function(e){var n;return t.i64.neq(r[25],void 0)?r[26]=r[25]:r[26]=t.i64.cast([0,0]),t.i64.neq(r[29],void 0)?r[27]=r[29]:r[27]=t.i64.cast([0,1]),n=[o.backupId,o.deviceId,o.mailboxRootKeyBlob,o.ocmfClientStateBlob,void 0,void 0,r[26],r[27],o.epochAuthPublicKeyBlob,o.epochAuthPrivateKeyBlob,o.devicePublicKeyBlob,o.devicePrivateKeyBlob,o.epochStoragePublicKeyBlob,o.epochStoragePrivateKeyBlob,o.obliviousValidationTokenBlob,o.authorityLevel,void 0,void 0],r[2]=n[0],r[3]=n[1],r[4]=n[2],r[5]=n[3],r[6]=n[4],r[7]=n[5],r[8]=n[6],r[9]=n[7],r[10]=n[8],r[11]=n[9],r[12]=n[10],r[13]=n[11],r[14]=n[12],r[15]=n[13],r[16]=n[14],r[17]=n[15],r[18]=n[16],r[19]=n[17]}]))})},function(e){return t.storedProcedure(n("LSFindBackup")).then(function(e){var t;return t=e,r[21]=t[0],t})},function(o){var a;return t.blobs.neq(r[5],void 0)?t.sequence([function(o){var a;return t.i64.neq(r[3],void 0)?t.sequence([function(o){var a;return r[21]!==void 0?t.sequence([function(o){var a;return t.blobs.neq(r[4],void 0)?t.sequence([function(o){return r[30]=t.createArray(),r[39]=(r[30].push(r[21]),r[30]),r[39]=(r[30].push(e[1]),r[30]),r[31]=t.toJSON(r[30]),r[32]=t.createArray(),r[39]=(r[32].push(t.i64.cast([0,32])),r[32]),t.nativeOperation(n("LSGetBlobFromString.nop"),["thread_ope_key","_",e[5]].join("")).then(function(e){var t;return t=e,r[33]=t[0],t})},function(e){return t.nativeOperation(n("LSCreateDerivedKeys.nop"),r[33],void 0,r[4],r[32]).then(function(e){var t;return t=e,r[34]=t[0],t})},function(e){return r[34]?r[35]=!1:r[35]=!0,r[35]?t.sequence([function(e){return(function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBCryptoUtils] Got null keys while deriving message list OPE key. Returning null blobish"),r[40]="Got null keys while deriving message list OPE key. Returning null blobish",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBCryptoUtils] ","",r[40]].join("")),r[39]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBCryptoUtils",r[40],r[39],t.i64.cast([0,3]))},function(e){return r[36]=void 0}]):t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[34],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[39]=t[0],r[40]=t[1],t})},function(e){return r[36]=r[39]}])},function(o){var a;return t.blobs.neq(r[36],void 0)?t.sequence([function(o){return t.nativeOperation(n("LSGetBlobFromInt64BE.nop"),e[6]).then(function(e){var t;return t=e,r[39]=t[0],t})},function(e){return t.nativeOperation(n("LSTruncateSortKey.nop"),r[39]).then(function(e){var t;return t=e,r[40]=t[0],t})},function(e){return t.nativeOperation(n("LSOpeEncrypt.nop"),r[36],r[40],t.i64.cast([0,16])).then(function(e){var t;return t=e,r[41]=t[0],t})},function(e){return t.nativeOperation(n("LSBinaryToHex.nop"),r[41]).then(function(e){var t;return t=e,r[42]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),r[31]).then(function(e){var t;return t=e,r[43]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF9rZXlfc2NvcGU="),r[43]).then(function(e){var t;return t=e,r[44]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[44]).then(function(e){var t;return t=e,r[45]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[45]).then(function(e){var t;return t=e,r[46]=t[0],t})},function(e){return t.nativeOperation(n("LSGetBlobFromString.nop"),r[21]).then(function(e){var t;return t=e,r[47]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWFpbGJveF9pZF9zY29wZQ=="),r[47]).then(function(e){var t;return t=e,r[48]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[48]).then(function(e){var t;return t=e,r[49]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[49]).then(function(e){var t;return t=e,r[50]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[4]).then(function(e){var t;return t=e,r[51]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("bWVzc2FnZV9pZF9zY29wZQ=="),r[51]).then(function(e){var t;return t=e,r[52]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[52]).then(function(e){var t;return t=e,r[53]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[53]).then(function(e){var t;return t=e,r[54]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[4]).then(function(e){var t;return t=e,r[55]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),r[55]).then(function(e){var t;return t=e,r[56]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[56]).then(function(e){var t;return t=e,r[57]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[57]).then(function(e){var t;return t=e,r[58]=t[0],t})},function(o){return t.nativeOperation(n("LSGetBlobFromString.nop"),e[5]).then(function(e){var t;return t=e,r[59]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("dGhyZWFkX2lkX3Njb3Bl"),r[59]).then(function(e){var t;return t=e,r[60]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[60]).then(function(e){var t;return t=e,r[61]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[61]).then(function(e){var t;return t=e,r[62]=t[0],t})},function(o){return r[63]=new t.Map,r[63].set("attachment_index_key",r[46]==null?"":r[46]),r[63].set("backup_ent_fbid",e[0]),r[63].set("delivery_object_id",e[1]),r[63].set("device_id",r[3]),r[63].set("mailbox_partial_id",r[50]==null?"":r[50]),r[63].set("media_type",e[3]),r[63].set("message_partial_id",r[54]==null?"":r[54]),r[63].set("product_type",e[2]),r[63].set("salt_partial_id",r[58]==null?"":r[58]),r[63].set("sort_key",r[42]==null?"":r[42]),r[63].set("thread_partial_id",r[62]==null?"":r[62]),r[63].set("isOpenEB",e[10]===!0),r[64]=new t.Map,r[64].set("otid",e[4]),r[64].set("server_thread_key",e[7]),r[64].set("timestamp",t.i64.to_string(e[6])),t.nativeOperation(n("LSBase64Encode.nop"),r[5]).then(function(e){var t;return t=e,r[65]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[4]).then(function(e){var t;return t=e,r[66]=t[0],t})},function(o){return r[67]=new t.Map,r[67].set("ocmf_client_state_blob",r[65]==null?"":r[65]),r[67].set("mailbox_root_key",r[66]==null?"":r[66]),r[68]=t.createArray(),r[80]=(r[68].push(e[4]),r[68]),r[80]=(r[68].push(e[1]),r[68]),r[69]=t.toJSON(r[68]),r[63].set("raw_identifiers",r[64]),r[63].set("backup_id",r[21]),r[63].set("thread_id",e[5]),t.nativeOperation(n("LSGetBlobFromString.nop"),r[69]).then(function(e){var t;return t=e,r[70]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF90b2tlbl9zYWx0X3Njb3Bl"),r[70]).then(function(e){var t;return t=e,r[71]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[71]).then(function(e){var t;return t=e,r[72]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[72]).then(function(e){var t;return t=e,r[73]=t[0],t})},function(e){return r[63].set("salt_partial_access_token",r[73]==null?"":r[73]),t.nativeOperation(n("LSGetBlobFromString.nop"),r[31]).then(function(e){var t;return t=e,r[74]=t[0],t})},function(e){return t.nativeOperation(n("LSHmac_v2.nop"),t.blob("YXR0YWNobWVudF9rZXlfc2FsdF9zY29wZQ=="),r[74]).then(function(e){var t;return t=e,r[75]=t[0],t})},function(e){return t.nativeOperation(n("LSOcmfClientMap.nop"),r[5],r[75]).then(function(e){var t;return t=e,r[76]=t[0],t})},function(e){return t.nativeOperation(n("LSBase64Encode.nop"),r[76]).then(function(e){var t;return t=e,r[77]=t[0],t})},function(n){var o;return r[63].set("salt_partial_attachment_index_key",r[77]==null?"":r[77]),r[63].set("raw_tokens",r[67]),e[13]!==void 0&&r[63].set("access_token_secret",e[13]),e[14]!==void 0&&r[63].set("primary_key_secret",e[14]),r[78]=t.toJSON(r[63]),r[79]=new t.Map,r[79].set("payload",r[78]),o=[r[79],void 0],r[37]=o[0],r[38]=o[1]}]):t.resolve((r[39]=new t.Map,r[39].set("error_code",t.i64.cast([0,25])),r[39].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[39].set("error_message","OPE key is null for IssueAttachmentRestoreTask"),a=[void 0,r[39]],r[37]=a[0],r[38]=a[1]))},function(e){var t;return t=[r[37],r[38]],r[28]=t[0],r[29]=t[1],t}]):t.resolve((r[30]=new t.Map,r[30].set("error_code",t.i64.cast([0,20])),r[30].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[30].set("error_message","Missing mailbox_root_key for IssueAttachmentRestoreTask"),a=[void 0,r[30]],r[28]=a[0],r[29]=a[1]))},function(e){var t;return t=[r[28],r[29]],r[26]=t[0],r[27]=t[1],t}]):t.resolve((r[28]=new t.Map,r[28].set("error_code",t.i64.cast([0,1])),r[28].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[28].set("error_message","Missing backup_id for IssueAttachmentRestoreTask"),a=[void 0,r[28]],r[26]=a[0],r[27]=a[1]))},function(e){var t;return t=[r[26],r[27]],r[24]=t[0],r[25]=t[1],t}]):t.resolve((r[26]=new t.Map,r[26].set("error_code",t.i64.cast([0,24])),r[26].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[26].set("error_message","Missing device_id for IssueAttachmentRestoreTask"),a=[void 0,r[26]],r[24]=a[0],r[25]=a[1]))},function(e){var t;return t=[r[24],r[25]],r[22]=t[0],r[23]=t[1],t}]):t.resolve((r[24]=new t.Map,r[24].set("error_code",t.i64.cast([0,22])),r[24].set("stored_procedure","LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure"),r[24].set("error_message","Missing ocmf_client_state_blob for IssueAttachmentRestoreTask"),a=[void 0,r[24]],r[22]=a[0],r[23]=a[1]))},function(e){var t;return t=[r[22],r[23]],r[0]=t[0],r[1]=t[1],t}])},function(e){var t;return t=[r[0],r[1]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsCreateResignCDNUrlPayloadStoredProcedure",e.__tables__=["secure_encrypted_backups_client_state"],a.exports=e}),null);
__d("LSCreateResignCDNUrlPayloadStoredProcedure",["LSCreateResignCDNUrlPayload","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSCreateResignCDNUrlPayload"),a.backupEntFbid,a.deliveryObjectId,a.productType,a.mediaType,a.messageId,a.threadId,a.sortOrder,a.serverThreadKey,a.deviceId,a.backupId,a.isOpenEb,a.ocmfClientState,a.mailboxRootKey,a.accessTokenSecret,a.primaryKeySecret);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSOptOutOfBackup",["LSAppendDataTraceAddon","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","justknobx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(i){return t.sequence([function(a){return o[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] Beginning execution."),r("justknobx")._("1099")?t.sequence([function(e){return t.sequence([function(e){return t.resolve()},function(e){return t.storedProcedure(n("LSIsMobileClient")).then(function(e){var t;return t=e,o[11]=t[0],t})},function(e){return o[11]?o[12]=!0:o[12]=!1,o[12]?((function(e){t.logger(e).mustfix(e)})("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),o[14]="LSDataTraceMciTraceLog native op not supported",(function(e){t.logger(e).mustfix(e)})(["[EncryptedBackups][MEBTraceUtils] ","",o[14]].join("")),o[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"MEBTraceUtils",o[14],o[13],t.i64.cast([0,3]))):t.resolve()}])},function(r){return o[8]=new t.Map,o[8].set("backup_id",e[0]),o[8].set("trace_id",void 0),o[9]=t.toJSON(o[8]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_opt_out",t.i64.cast([0,50019]),o[9],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,o[10]=t[0],t})},function(e){return o[1]=t.i64.cast([0,0])}]):t.resolve(((function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] backup opt out flow is not enabled"),o[1]=t.i64.cast([0,1])))},function(e){return o[2]=t.i64.of_float(Date.now()),o[3]=t.i64.random(),o[5]="Finishing execution. Execution time: ",o[6]=t.i64.to_string(t.i64.sub(o[2],o[0])),o[7]=" ms",o[4]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] ",o[4],o[5],o[4],o[6],o[4],o[7]].join("")),t.i64.eq(t.i64.mod_(o[3],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(o[8]=",",o[9]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsOptOutOfBackupStoredProcedure",[o[5],o[8],o[6],o[8],o[7]].join(""),o[9],t.i64.cast([0,4]))):t.resolve()},function(e){return a[0]=o[1]}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSEncryptedBackupsOptOutOfBackupStoredProcedure",e.__tables__=[];var s=e;l.default=s}),98);
__d("LSOptOutOfBackupStoredProcedure",["LSOptOutOfBackup","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSOptOutOfBackup"),a.backupId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("ReplayLastSubject",["relay-runtime"],(function(t,n,r,o,a,i,l){"use strict";var e=Object.freeze({}),s=(function(){function t(t){var n=this;t===void 0&&(t=e),this.$1=!1,this.$5=new Set,this.$3=t,this.$4=o("relay-runtime").Observable.create(function(t){if(n.$1){n.$2!=null?t.error(n.$2):t.complete();return}return n.$5.add(t),n.$3!==e&&t.next(n.$3),function(){n.$5.delete(t)}})}var n=t.prototype;return n.next=function(t){this.$1||this.$3!==t&&(this.$3=t,this.$5.forEach(function(e){return e.next(t)}))},n.error=function(t){this.$1||(this.$1=!0,this.$2=t,this.$5.forEach(function(e){return e.error(t)}))},n.complete=function(){this.$1||(this.$1=!0,this.$5.forEach(function(e){return e.complete()}))},n.subscribe=function(t){return this.$4.subscribe(t)},n.getObserverCount=function(){return this.$5.size},t})();l.ReplayLastSubject=s}),98);
__d("MAWUISnippetsMessagesMetadataMapObservable",["I64","ReplayLastSubject"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(e){function t(t){var n;return n=e.call(this,t)||this,n.value=t,n}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.next=function(n){this.value=n,e.prototype.next.call(this,n)},t})(o("ReplayLastSubject").ReplayLastSubject),u=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.get=function(n){var t=(e||(e=o("I64"))).to_string(n),r=this.$1.get(t);if(r==null){var a=new s([]);return this.$1.set(t,a),a}return r},n.set=function(t,n){var e=this.get(t),r=e.value;if(r.length!==n.length){e.next(n);return}var o=r.every(function(e,t){var r=n[t];return e.externalId===r.externalId&&e.sortOrderMs===r.sortOrderMs});o||e.next(n)},t})();l.Subject=s,l.MAWUISnippetsMessagesMetadataMapObservable=u}),98);
__d("updateMWLSThreadSnippet",["FBLogger","I64","MAWBridgeBuildThreadSnippet","asyncToGeneratorRuntime","getMAWLastMessageCtaType"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n,a=t.thread,i=t.threadSnippet,l=t.txn,s=i.snippetParams,u=o("MAWBridgeBuildThreadSnippet").buildBridgeThreadSnippet({snippetContactIDs:s.contactIDs,snippetMentionJIDs:(n=s.mentionJIDs)!=null?n:[],snippetParams:s.strings,snippetSenderContactId:i.snippetSenderContactId,snippetType:i.snippetType});u==null&&r("FBLogger")("messenger_web").warn("[updateMWLSThreadSnippet] null snippet is calculated for a thread, snippetType: %s, contactsIDs is null: %s, snippetParams is null: %s",i.snippetType,s.contactIDs==null,s.strings==null);var c=i.snippetSenderContactId!=null?(e||(e=o("I64"))).of_string(i.snippetSenderContactId):(e||(e=o("I64"))).zero,d=r("getMAWLastMessageCtaType")(i.snippetType);yield l.threads.put(babelHelpers.extends({},a,{lastMessageCtaType:d,snippet:u,snippetSenderContactId:c}))}),u.apply(this,arguments)}l.updateMWLSThreadSnippet=s}),98);
__d("MAWUISnippetsCacheService",["FBLogger","I64","LSDatabaseSingleton","MAWChatJid","MAWJids","MAWMiActGetThreadLifecycleState__DO_NOT_USE","MAWUISnippetsMessagesMetadataMapObservable","Promise","ReStoreVaulting","WAJids","asyncToGeneratorRuntime","promiseDone","updateMWLSThreadSnippet"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(function(){function t(){this.namespace="snippets",this.$1=new(o("MAWUISnippetsMessagesMetadataMapObservable")).MAWUISnippetsMessagesMetadataMapObservable}var a=t.prototype;return a.onCacheChange=function(a,l){r("promiseDone")((u||(u=o("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(t){return t.runInTransaction(function(t){return(e||(e=n("Promise"))).all(a.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e[0],r=e[1],a=o("WAJids").unsafeCoerceToChatJid(n),i=yield o("MAWChatJid").toThreadMaybe(t,a);if(i==null){yield m(t,a);return}var s=r.value.snippet,u=babelHelpers.extends({},s.snippetParams,{strings:s.snippetParams.strings.map(function(e){return o("ReStoreVaulting").maybeVault(e)})});return o("updateMWLSThreadSnippet").updateMWLSThreadSnippet({thread:i,threadSnippet:babelHelpers.extends({},s,{snippetParams:u}),txn:t}).then(function(){_(i.threadKey,l,r)})});return function(t){return e.apply(this,arguments)}})()))},"readwrite",void 0,void 0,i.id+":47")}))},a.getNewestIncomingMessagesMetadata=function(t){return this.$1.get(t)},t})(),d="[SnippetsCacheService][UI]";function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("MAWMiActGetThreadLifecycleState__DO_NOT_USE").getThreadLifecycleStateByJid(e,o("MAWJids").convertChatJidToIntJid(t),"MAWUISnippetsCacheService");r("FBLogger")("MAWCacheService").mustfix(d+" Missing LSDBThread when updating snippet. jid: %s, thread state: %s",t,n.type)}),p.apply(this,arguments)}function _(e,t,n){r("FBLogger")("MAWCacheService").info(d+" Updated thread snippet. threadKey: %s, source: %s, msgId: %s, reactionId: %s, ack level %s",(s||(s=o("I64"))).to_string(e),t,n.value.snippetMsgId,n.value.snippetReactionId,n.value.snippetMsgAckLevel)}var f=new c;function g(){return f}l.getMAWUISnippetsCacheService=g}),98);
__d("MAWUICacheServiceRegistry",["MAWUISnippetsCacheService"],(function(t,n,r,o,a,i,l){"use strict";var e={snippets:o("MAWUISnippetsCacheService").getMAWUISnippetsCacheService()};function s(){return e}l.getUICacheServiceRegistry=s}),98);
__d("MAWUICacheServices",["BroadcastChannelFallback","FBLogger","MAWBridgeSendAndReceive","MAWCacheServiceQPL","MAWCacheServiceUtils","MAWLoggerUtils","MAWUICacheServiceRegistry","MAWUICacheServicesBase","asyncToGeneratorRuntime","promiseDone","shallowArrayEqual"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(){this.$1=new(o("MAWUICacheServicesBase")).MAWUICacheServicesBase(o("MAWUICacheServiceRegistry").getUICacheServiceRegistry()),this.$2=o("MAWCacheServiceUtils").getMAWCacheServiceBroadcastChannel(),this.$3()}var t=e.prototype;return t.$3=function(){var e=this,t=function(n){var t,o,a,i,l,s;if(typeof n=="object"&&n!=null&&typeof n.data=="object"&&n.data!==null&&typeof((t=n.data)==null?void 0:t.namespace)=="string"&&((o=n.data)==null?void 0:o.namespace)!==null&&typeof((a=n.data)==null?void 0:a.source)=="string"&&((i=n.data)==null?void 0:i.source)!==null&&typeof((l=n.data)==null?void 0:l.cache)=="object"&&((s=n.data)==null?void 0:s.cache)!==null&&Array.isArray(n.data.cache)){var u,c,d=n.data.namespace,m=n.data.cache,p=n.data.source,_;typeof((u=n.data)==null?void 0:u.instanceKey)=="number"&&((c=n.data)==null?void 0:c.instanceKey)!==null?(_=n.data.instanceKey,p==="realtime-update"&&r("MAWCacheServiceQPL").registerInstanceKeyInUI(_),r("MAWCacheServiceQPL").addPointQPL(_,"broadcasting_to_ui_end",p)):r("FBLogger")("MAWCacheService").info("Invalid instance key received via broadcast channel."),e.$1.updateInMemoryCacheAndTriggerCallback(d,m,p,_)}else throw r("FBLogger")("messenger_web").mustfixThrow("Invalid payload received via broadcast channel.")};this.$2==null?o("BroadcastChannelFallback").registerBroadcastChannelFallbackListener(o("MAWCacheServiceUtils").MAW_CACHE_SERVICE_BROADCAST_CHANNEL,t):this.$2.onmessage=t},t.resetInMemoryCache=function(t,n){this.$1.resetInMemoryCache(t,n)},t.checkExistingCacheOrGetFromScratchAndNotifyListenersFor=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=this,a=Array.from(new Set(t)),i=o("MAWLoggerUtils").getInstanceKey();r("MAWCacheServiceQPL").startQPL(i,e),r("MAWCacheServiceQPL").addAnnotationsQPL(i,{string:{instanceKey:i.toString()},string_array:{allKeys:r("MAWCacheServiceQPL").redactKeysForNonEmployee(a)}});var l=this.$1.checkInMemoryCacheAndTriggerCallback(e,a,i);if(l.length===0){r("FBLogger")("MAWUICacheServices").info("All keys are in memory cache. Namespace: %s",e);return}var s=yield this.$1.checkPersistedCacheAndTriggerCallback(e,l,i).catch(function(t){return r("FBLogger")("MAWCacheService").catching(t).mustfix("Failed to read from persisted cache in UI.",e),r("MAWCacheServiceQPL").addPointQPL(i,"read_from_persisted_cache_failed"),l});if(r("shallowArrayEqual")(l,s)?this.$1.QPLMetadata.set(i,"all-from-scratch"):(r("FBLogger")("MAWUICacheServices").info("Sending low priority bridge call to invalidate cache for keys: %s",l.join(", ")),r("MAWCacheServiceQPL").addPointQPL(i,"invalidating_cache"),r("MAWCacheServiceQPL").addAnnotationsQPL(i,{string_array:{keysToInvalidateCacheFor:r("MAWCacheServiceQPL").redactKeysForNonEmployee(l)}}),r("promiseDone")(o("MAWBridgeSendAndReceive").sendAndReceive("backend","computeCachePayloadFromScratch",{instanceKey:i,isLowPriority:!0,keys:l,namespace:e}).catch(function(t){r("MAWCacheServiceQPL").addPointQPL(i,"invalidating_cache_failed"),r("FBLogger")("MAWCacheService").catching(t).mustfix("Failed to invalidate potential outdated persisted cache.",e)}))),r("MAWCacheServiceQPL").addAnnotationsQPL(i,{int:{memoryHitRate:Math.floor((a.length-l.length)/a.length*100),persistedHitRate:Math.floor((l.length-s.length)/l.length*100)}}),s.length===0){r("FBLogger")("MAWUICacheServices").info("All keys are in persisted cache. Namespace: %s",e);return}r("FBLogger")("MAWUICacheServices").info("Sending bridge call to calculate cache from scratch for keys: %s",s.join(", ")),r("MAWCacheServiceQPL").addPointQPL(i,"sending_bridge_call_to_compute_from_scratch"),r("MAWCacheServiceQPL").addAnnotationsQPL(i,{string_array:{keysToBeCalculatedFromScratch:r("MAWCacheServiceQPL").redactKeysForNonEmployee(s)}}),yield o("MAWBridgeSendAndReceive").sendAndReceive("backend","computeCachePayloadFromScratch",{instanceKey:i,isLowPriority:!1,keys:s,namespace:e}).catch(function(t){r("MAWCacheServiceQPL").endFailureQPL(i,"sending_bridge_call_to_compute_from_scratch_failed"),r("MAWCacheServiceQPL").addAnnotationsQPL(i,{string:{error:t.message}}),n.$1.QPLMetadata.delete(i),r("FBLogger")("MAWCacheService").catching(t).mustfix("Failed to compute cache from scratch for",e)})});function t(t,n){return e.apply(this,arguments)}return t})(),t.getFromScratchSkippingCacheAndNotifyListenersFor=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=this,a,i=Array.from(new Set(t)),l=o("MAWLoggerUtils").getInstanceKey();(a=r("MAWCacheServiceQPL")).startQPL(l,e),a.addAnnotationsQPL(l,{string:{instanceKey:l.toString()},string_array:{allKeys:a.redactKeysForNonEmployee(i)}}),this.$1.QPLMetadata.set(l,"all-from-scratch"),a.addPointQPL(l,"sending_bridge_call_to_compute_from_scratch_skipping_cache"),yield o("MAWBridgeSendAndReceive").sendAndReceive("backend","computeCachePayloadFromScratch",{instanceKey:l,isLowPriority:!1,keys:i,namespace:e}).catch(function(t){r("MAWCacheServiceQPL").endFailureQPL(l,"sending_bridge_call_to_compute_from_scratch_failed"),r("MAWCacheServiceQPL").addAnnotationsQPL(l,{string:{error:t.message}}),n.$1.QPLMetadata.delete(l),r("FBLogger")("MAWCacheService").catching(t).mustfix("Failed to compute cache from scratch for",e)})});function t(t,n){return e.apply(this,arguments)}return t})(),e})(),s=null,u=function(){return s==null&&(s=new e),s};l.getMAWUICacheServices=u}),98);
__d("MWEncryptedBackupsCreateExtraVirtualDeviceWithRecoveryCodeData",["LSCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSShape","ReQL","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){var l=yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.encrypted_backups));if(l==null)return[(e||(e=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE)];var s=l.backupId;return s!=null?(yield t.runInTransaction(function(e){return r("LSCreateExtraVirtualDeviceWithRecoveryCodeDataStoredProcedure")(r("LSFactory")(e),{actionType:n,backupId:s,recoveryCodeData:o("LSShape").ofRecord(a),traceId:void 0})},"readwrite",void 0,void 0,i.id+":41"),[(e||(e=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").SUCCESS)]):[(e||(e=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE)]}),u.apply(this,arguments)}l.initializeCreateExtraVirtualDeviceStoredProcedure=s}),98);
__d("MWEncryptedBackupsInitializeRestore",["EBGetLatestChatJids","EBSetRestoreStatusForInitialRestore","ExecutionEnvironment","FBLogger","LSRequestId","MAWBridge","MAWBridgeSendAndReceive","MAWEBRestoreTrackingUtils","MAWMpsGating","MAWUICacheServices","MpsOverBridge","MpsTypes","Promise","asyncToGeneratorRuntime","getErrorSafe","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=20;function d(e){var t=r("LSRequestId").generate();return o("MAWMpsGating").isFullMpsEnabled()?m(e,t,_,"FULL_MPS"):m(e,t,f,"MPS")}function m(e,t,n,r){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i){r("FBLogger")("messenger_web").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Initializing restore with ",""])),i),g(i);try{o("MAWEBRestoreTrackingUtils").markEBRestoreInitial({querySource:"GQL_MAIN_THREAD",traceId:n});var l=yield o("EBGetLatestChatJids").getLatestChatJids(t,50);if(l.success===!1){o("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,(u||(u=r("ExecutionEnvironment"))).isInWorker,"latestChatJidsResultOrError: "+r("getErrorSafe")(l.error).message);return}if(yield o("EBSetRestoreStatusForInitialRestore").setRestoreStatusForInitialRestore(l.value,t),o("MAWMpsGating").isMpsSnippetsCacheServiceEnabled()||r("gkx")("2792")){var s=o("MAWUICacheServices").getMAWUICacheServices();r("promiseDone")(s.getFromScratchSkippingCacheAndNotifyListenersFor("snippets",l.value.map(o("MpsTypes").toThreadId)))}yield a(l.value),o("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(n)}catch(e){throw o("MAWEBRestoreTrackingUtils").markEBRestoreFail(n,(u||(u=r("ExecutionEnvironment"))).isInWorker,"initialize_restore_failed: "+r("getErrorSafe")(e).message),e}finally{yield o("EBSetRestoreStatusForInitialRestore").resetClientRestoreStatus(t)}}),p.apply(this,arguments)}function _(e){return(s||(s=n("Promise"))).all(e.map(function(e){return o("MpsOverBridge").mps().loadMessages({debug:{purpose:"InitializeRestore"},direction:"desc",from:[o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),void 0],numMessages:c,threadId:o("MpsTypes").toThreadId(e)})})).then(function(){})}function f(e){return o("MAWBridgeSendAndReceive").sendAndReceive("backend","maw_load_msgs_by_chat_jids_into_maw",{actionType:"pre-load",config:e.map(function(e){return{chatJid:e,direction:"before",includeLowerBoundMsg:!0,lowerBoundSortOrderMs:Date.now(),numMsgs:c}})})}function g(e){o("MAWBridge").getBridge().fireAndForget("backend","logInitRestoreMethodForDebugging",{method:e})}l.initializeRestore=d}),98);
__d("X25519",["$InternalEnum","Promise","WACryptoCurve25519Dependencies","WASignalKeys","WASignalOther","WASignalSignatures"],(function(t,n,r,o,a,i,l){"use strict";var e,s=n("$InternalEnum").Mirrored(["Encryption","Signing"]),u=n("$InternalEnum")({PublicKey:0,PrivateKey:1,Signature:2});function c(e,t){if(t===s.Encryption)return[];var n=1;switch(e){case u.PublicKey:n=1;break;case u.PrivateKey:n=2;break;case u.Signature:n=3;break}return[255,n]}function d(e,t,n){var r=c(t,n),o=r.length;if(o<=0)return e;var a=new Uint8Array(o+e.byteLength);return a.set(Array.from(r)),a.set(e,o),a}function m(e,t,n){var r=c(t,n).length;return e.slice(r)}function p(e,t){return{privateKey:d(e.privateKey,u.PrivateKey,t),publicKey:d(e.publicKey,u.PublicKey,t)}}function _(e){var t=p(o("WASignalKeys").makeKeyPair(),e);return{pk:t.publicKey,sk:t.privateKey}}function f(e,t){if(t===s.Encryption)return 32;switch(e){case u.PublicKey:case u.PrivateKey:return 32;case u.Signature:return 64}}function g(e,t,n){var r=c(t,n),o=r.length,a=f(t,n),i=a!=null?o+a:0;if(e.length!==i)return!1;var l=e.subarray(0,o),s=new Uint8Array(r);return s.length===l.length&&s.every(function(e,t){return e===l[t]})}function h(e,t){if(g(e,u.PublicKey,t))return e}function y(e,t){if(g(e,u.PrivateKey,t))return e}function C(e,t){var n=h(e.pkBytes,t),r=y(e.skBytes,t);if(n!=null&&r!=null)return{pk:n,sk:r}}function b(t,r){var a=m(t,u.PrivateKey,s.Signing);return o("WASignalSignatures").signMsg(o("WASignalKeys").makeKeyPairFrom(o("WASignalOther").ensureSize(a,32)),r).then(function(t){var r=d(t,u.Signature,s.Signing);return(e||(e=n("Promise"))).resolve(r)})}function v(e){if(g(e,u.Signature,s.Signing))return e}function S(e,t,n){var r=m(t,u.PublicKey,s.Signing);return o("WASignalSignatures").verifyMsgSignalVariant(o("WASignalKeys").serializeIdentity(r),n,o("WASignalOther").ensureSize(m(e,u.Signature,s.Signing),64))}function R(t,r){var a=r,i=t;return!g(i,u.PublicKey,s.Encryption)||!g(a,u.PrivateKey,s.Encryption)?(e||(e=n("Promise"))).resolve():o("WACryptoCurve25519Dependencies").calculateAgreement(i,a).then(function(t){return(e||(e=n("Promise"))).resolve(new Uint8Array(t))})}l.KeyPurpose=s,l.generateKeys=_,l.publicKeyFromBytes=h,l.secretKeyFromBytes=y,l.keysFromBytes=C,l.sign=b,l.signatureFromBytes=v,l.verify=S,l.exchangeKeys=R}),98);
__d("PublicKeyCrypto",["Promise","UInt8Array","X25519"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,r){return(e||(e=n("Promise"))).all([t,r]).then(function(t){return(e||(e=n("Promise"))).resolve(t[0]!=null&&t[1]!=null?o("UInt8Array").concatBytes([t[0],t[1]]):void 0)})}function u(e,t,n){return s(o("X25519").exchangeKeys(n,e),o("X25519").exchangeKeys(n,t))}function c(e,t,n){return s(o("X25519").exchangeKeys(n,e),o("X25519").exchangeKeys(t,e))}l.senderDeriveSharedSecret=u,l.receiverDeriveSharedSecret=c}),98);
__d("ReverbWriteFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5829"),s=o("FalcoLoggerInternal").create("reverb_write_failure",e),u=s;l.default=u}),98);
__d("ReverbWriteSuccessFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5831"),s=o("FalcoLoggerInternal").create("reverb_write_success",e),u=s;l.default=u}),98);
__d("WASmaxInAbPropsIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",r.value);if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","error");return s.success?o("WAResultOrError").makeResult({type:s.value}):s}l.parseIQErrorResponseMixin=e}),98);
__d("WASmaxInAbPropsIQErrorBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","bad-request");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",400);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorBadRequestMixin=e}),98);
__d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","feature-not-implemented");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",501);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorFeatureNotImplementedMixin=e}),98);
__d("WASmaxInAbPropsNoRetryErrors",["WAResultOrError","WASmaxInAbPropsIQErrorBadRequestMixin","WASmaxInAbPropsIQErrorFeatureNotImplementedMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInAbPropsIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:t.value});var n=o("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin").parseIQErrorFeatureNotImplementedMixin(e);return n.success?o("WAResultOrError").makeResult({name:"IQErrorFeatureNotImplemented",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorBadRequest","IQErrorFeatureNotImplemented"],[t,n])}l.parseNoRetryErrors=e}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry",["WAResultOrError","WASmaxInAbPropsIQErrorResponseMixin","WASmaxInAbPropsNoRetryErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInAbPropsNoRetryErrors").parseNoRetryErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorNoRetryErrors:i.value})):i}l.parseGetExperimentConfigResponseErrorNoRetry=e}),98);
__d("WASmaxInAbPropsIQErrorInternalServerErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","internal-server-error");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",500);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorInternalServerErrorMixin=e}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry",["WAResultOrError","WASmaxInAbPropsIQErrorInternalServerErrorMixin","WASmaxInAbPropsIQErrorResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInAbPropsIQErrorInternalServerErrorMixin").parseIQErrorInternalServerErrorMixin(r.value);if(!a.success)return a;var i=o("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({errorIQErrorInternalServerErrorMixin:a.value},i.value)):i}l.parseGetExperimentConfigResponseErrorRetry=e}),98);
__d("WASmaxInAbPropsExperimentConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"prop");if(!t.success)return t;var n=o("WASmaxParseUtils").attrIntRange(e,"config_code",1,void 0);if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(e,"config_value");if(!r.success)return r;var a=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,e,"config_expo_key",0,void 0);return a.success?o("WAResultOrError").makeResult({configCode:n.value,configValue:r.value,configExpoKey:a.value}):a}l.parseExperimentConfigMixin=e}),98);
__d("WASmaxInAbPropsSamplingConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"prop");if(!t.success)return t;var n=o("WASmaxParseUtils").attrIntRange(e,"event_code",1,void 0);if(!n.success)return n;var r=o("WASmaxParseUtils").attrIntRange(e,"sampling_weight",-1e4,1e4);return r.success?o("WAResultOrError").makeResult({eventCode:n.value,samplingWeight:r.value}):r}l.parseSamplingConfigMixin=e}),98);
__d("WASmaxInAbPropsConfigs",["WAResultOrError","WASmaxInAbPropsExperimentConfigMixin","WASmaxInAbPropsSamplingConfigMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInAbPropsExperimentConfigMixin").parseExperimentConfigMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"ExperimentConfig",value:t.value});var n=o("WASmaxInAbPropsSamplingConfigMixin").parseSamplingConfigMixin(e);return n.success?o("WAResultOrError").makeResult({name:"SamplingConfig",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["ExperimentConfig","SamplingConfig"],[t,n])}l.parseConfigs=e}),98);
__d("WASmaxInAbPropsEnums",[],(function(t,n,r,o,a,i){var e={false:"false",true:"true"};i.ENUM_FALSE_TRUE=e}),66);
__d("WASmaxInAbPropsIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseReference").attrStringFromReference(t,["id"]);if(!r.success)return r;var a=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"id",r.value);if(!a.success)return a;var i=o("WASmaxParseReference").attrStringFromReference(t,["to"]);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"from",i.value);if(!l.success)return l;var s=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"type","result");return s.success?o("WAResultOrError").makeResult({type:s.value}):s}l.parseIQResultResponseMixin=e}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseSuccess",["WAResultOrError","WASmaxInAbPropsConfigs","WASmaxInAbPropsEnums","WASmaxInAbPropsIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"prop");if(!t.success)return t;var n=o("WASmaxInAbPropsConfigs").parseConfigs(e);return n.success?o("WAResultOrError").makeResult({configs:n.value}):n}function s(e){var t=o("WASmaxParseUtils").assertTag(e,"erid");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(e,1,100);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function u(t,n){var r=o("WASmaxParseUtils").assertTag(t,"iq");if(!r.success)return r;var a=o("WASmaxParseUtils").flattenedChildWithTag(t,"props");if(!a.success)return a;var i=o("WASmaxParseUtils").optionalChildWithTag(t,"erid",s);if(!i.success)return i;var l=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,a.value,"protocol","1");if(!l.success)return l;var u=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,a.value,"ab_key");if(!u.success)return u;var c=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrString,a.value,"hash");if(!c.success)return c;var d=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,a.value,"refresh",0,void 0);if(!d.success)return d;var m=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrIntRange,a.value,"refresh_id",0,void 0);if(!m.success)return m;var p=o("WASmaxParseUtils").optional(o("WASmaxParseUtils").attrStringEnum,a.value,"delta_update",o("WASmaxInAbPropsEnums").ENUM_FALSE_TRUE);if(!p.success)return p;var _=o("WASmaxInAbPropsIQResultResponseMixin").parseIQResultResponseMixin(t,n);if(!_.success)return _;var f=o("WASmaxParseUtils").mapChildrenWithTag(a.value,"prop",0,1/0,e);return f.success?o("WAResultOrError").makeResult(babelHelpers.extends({propsProtocol:l.value,propsAbKey:u.value,propsHash:c.value,propsRefresh:d.value,propsRefreshId:m.value,propsDeltaUpdate:p.value},_.value,{erid:i.value,propsProp:f.value})):f}l.parseGetExperimentConfigResponseSuccessPropsProp=e,l.parseGetExperimentConfigResponseSuccessErid=s,l.parseGetExperimentConfigResponseSuccess=u}),98);
__d("WASmaxOutAbPropsBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxJsx").smax("iq",{id:o("WAWap").generateId(),type:"get"});return e}function s(t){var n=e();return o("WASmaxMixins").mergeStanzas(t,n)}l.mergeBaseIQGetRequestMixin=s}),98);
__d("WASmaxOutAbPropsGetExperimentConfigRequest",["WASmaxAttrs","WASmaxJsx","WASmaxOutAbPropsBaseIQGetRequestMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.propsHash,n=e.propsRefreshId,r=o("WASmaxOutAbPropsBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(o("WASmaxJsx").smax("iq",{xmlns:"abt",to:o("WAWap").S_WHATSAPP_NET},o("WASmaxJsx").smax("props",{protocol:"1",hash:o("WASmaxAttrs").OPTIONAL(o("WAWap").CUSTOM_STRING,t),refresh_id:o("WASmaxAttrs").OPTIONAL(o("WAWap").INT,n)})));return r}l.makeGetExperimentConfigRequest=e}),98);
__d("WASmaxAbPropsGetExperimentConfigRPC",["WAComms","WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry","WASmaxInAbPropsGetExperimentConfigResponseErrorRetry","WASmaxInAbPropsGetExperimentConfigResponseSuccess","WASmaxOutAbPropsGetExperimentConfigRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=o("WASmaxOutAbPropsGetExperimentConfigRequest").makeGetExperimentConfigRequest(e),r=yield o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInAbPropsGetExperimentConfigResponseSuccess").parseGetExperimentConfigResponseSuccess(r,n);if(a.success)return{name:"GetExperimentConfigResponseSuccess",value:a.value};var i=o("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry").parseGetExperimentConfigResponseErrorNoRetry(r,n);if(i.success)return{name:"GetExperimentConfigResponseErrorNoRetry",value:i.value};var l=o("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry").parseGetExperimentConfigResponseErrorRetry(r,n);if(l.success)return{name:"GetExperimentConfigResponseErrorRetry",value:l.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("GetExperimentConfig",{Success:a,ErrorNoRetry:i,ErrorRetry:l}))}),s.apply(this,arguments)}l.sendGetExperimentConfigRPC=e}),98);
__d("WAGetAbPropsProtocol",["WALogger","WAResultOrError","WASmaxAbPropsGetExperimentConfigRPC","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield o("WASmaxAbPropsGetExperimentConfigRPC").sendGetExperimentConfigRPC(t);if(n.name==="GetExperimentConfigResponseSuccess"){var r=n.value,a=r.erid,i=r.propsAbKey,l=r.propsDeltaUpdate,s=r.propsHash,u=r.propsProp,d=r.propsRefresh,m=r.propsRefreshId,p=c(u),_=p.newProps,f=p.samplingConfigs;return o("WAResultOrError").makeResult({abKey:i,hash:s,refresh:d,refreshId:m,props:_,samplingConfigs:f,erid:a==null?void 0:a.elementValue,isDeltaUpdate:l==="true"})}return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["getAbPropsProtocol failed ",""])),n.value),o("WAResultOrError").makeError()}),u.apply(this,arguments)}function c(e){var t=[],n=[];return e.forEach(function(e){var r=e.configs;if(r.name==="ExperimentConfig"){var o;t.push({configCode:r.value.configCode,configValue:r.value.configValue,configExpoKey:(o=r.value.configExpoKey)==null?void 0:o.toString()})}else r.name==="SamplingConfig"&&n.push({eventCode:r.value.eventCode,samplingWeight:r.value.samplingWeight})}),{newProps:t,samplingConfigs:n}}l.getAbPropsProtocol=s}),98);
__d("WAAbPropsSync",["WAAbProps","WAAbPropsHelpers","WAGetAbPropsProtocol","WALogger","WAPromiseManagement","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WAPromiseManagement").cacheWhilePending(function(){return"abProps"},m);function m(e){var t=e.sendHash,n=t===void 0?!0:t;return n==null||n===!1?_(null):o("WAAbProps").getHash().then(function(e){return _(e)})}var p=m;function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield o("WAGetAbPropsProtocol").getAbPropsProtocol({propsHash:t});if(!n.success)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["fetchAbProps failed"])));else{var r=n.value,a=r.abKey,i=r.hash,l=r.props,u=r.refresh,c=o("WAAbPropsHelpers").parseAbProps(o("WAAbProps").getConfig(),l),d=yield g(a,i,u,c);d.success===!1&&(d.error,o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["syncAbProps: detected no hash"]))))}var m=yield o("WAAbProps").getRefreshSecs();return{seconds:m}}),f.apply(this,arguments)}function g(e,t,n,r){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=yield o("WAAbProps").getAbProps(),i={abKey:e!=null?e:a.abKey,hash:t!=null?t:a.hash,refresh:o("WAAbPropsHelpers").maybeUpdateRefresh(n),lastSyncTime:o("WATimeUtils").unixTime(),propValues:a.propValues,propExpoKeys:a.propExpoKeys,internalExpoKeys:a.internalExpoKeys,expoKeyStr:a.expoKeyStr};if(t==null)return yield o("WAAbProps").setAbProps(i),o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: detected no hash"]))),o("WAResultOrError").makeError("noHash");o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: updating ab configs"])));var l=r.expoKeys,s=r.values,d=o("WAAbPropsHelpers").maybeUpdatePropValues(s,a.propValues,o("WAAbProps").getConfig()),m=o("WAAbPropsHelpers").maybeUpdateExpoKeys(l,a.propExpoKeys,o("WAAbProps").getConfig()),p=m.expoKeysToDelete,_=m.propExpoKeys,f,g,h=o("WAAbPropsHelpers").maybeUpdateInternalExpoKeys(p,a.internalExpoKeys);return h!=null&&(f=h.internalExpoKeys,g=h.expoKeyStr),yield o("WAAbProps").setAbProps(babelHelpers.extends({},i,{propValues:d,propExpoKeys:_,internalExpoKeys:f,expoKeyStr:g})),o("WAResultOrError").makeResult()}),h.apply(this,arguments)}l.syncAbProps=d,l.syncAbPropsDebug=p}),98);
__d("WASmaxInDevicesFetchSelfResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup").parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup:i.value})):i}l.parseFetchSelfResponseError=e}),98);
__d("WASmaxInDevicesDeviceInfoMixin",["WAResultOrError","WASmaxInDevicesIdentityKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"platform");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function s(e){var t=o("WASmaxParseUtils").assertTag(e,"manufacturer");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function u(e){var t=o("WASmaxParseUtils").assertTag(e,"model");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function c(e){var t=o("WASmaxParseUtils").assertTag(e,"seen");if(!t.success)return t;var n=o("WASmaxParseUtils").contentInt(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function d(e){var t=o("WASmaxParseUtils").assertTag(e,"creation");if(!t.success)return t;var n=o("WASmaxParseUtils").contentInt(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function m(e){var t=o("WASmaxParseUtils").assertTag(e,"ip");if(!t.success)return t;var n=o("WASmaxParseUtils").contentString(e);return n.success?o("WAResultOrError").makeResult({elementValue:n.value}):n}function p(e){var t=o("WASmaxParseUtils").assertTag(e,"location");if(!t.success)return t;var n=o("WASmaxParseUtils").attrString(e,"latitude");if(!n.success)return n;var r=o("WASmaxParseUtils").attrString(e,"longitude");if(!r.success)return r;var a=o("WASmaxParseUtils").contentString(e);return a.success?o("WAResultOrError").makeResult({latitude:n.value,longitude:r.value,elementValue:a.value}):a}function _(t){var n=o("WASmaxParseUtils").assertTag(t,"device");if(!n.success)return n;var r=o("WASmaxParseUtils").optionalChildWithTag(t,"platform",e);if(!r.success)return r;var a=o("WASmaxParseUtils").optionalChildWithTag(t,"manufacturer",s);if(!a.success)return a;var i=o("WASmaxParseUtils").optionalChildWithTag(t,"model",u);if(!i.success)return i;var l=o("WASmaxParseUtils").optionalChildWithTag(t,"seen",c);if(!l.success)return l;var _=o("WASmaxParseUtils").optionalChildWithTag(t,"creation",d);if(!_.success)return _;var f=o("WASmaxParseUtils").optionalChildWithTag(t,"ip",m);if(!f.success)return f;var g=o("WASmaxParseUtils").optionalChildWithTag(t,"location",p);if(!g.success)return g;var h=o("WASmaxParseUtils").attrIntRange(t,"id",1,999);if(!h.success)return h;var y=o("WASmaxInDevicesIdentityKeyMixin").parseIdentityKeyMixin(t);return y.success?o("WAResultOrError").makeResult(babelHelpers.extends({id:h.value},y.value,{platform:r.value,manufacturer:a.value,model:i.value,seen:l.value,creation:_.value,ip:f.value,location:g.value})):y}l.parseDeviceInfoPlatform=e,l.parseDeviceInfoManufacturer=s,l.parseDeviceInfoModel=u,l.parseDeviceInfoSeen=c,l.parseDeviceInfoCreation=d,l.parseDeviceInfoIp=m,l.parseDeviceInfoLocation=p,l.parseDeviceInfoMixin=_}),98);
__d("WASmaxInDevicesFetchSelfResponseSuccess",["WAResultOrError","WASmaxInDevicesDeviceInfoMixin","WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"device");if(!t.success)return t;var n=o("WASmaxInDevicesDeviceInfoMixin").parseDeviceInfoMixin(e);return n.success,n}function s(t,n){var r=o("WASmaxParseUtils").assertTag(t,"iq");if(!r.success)return r;var a=o("WASmaxParseUtils").flattenedChildWithTag(t,"self");if(!a.success)return a;var i=o("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(t,n);if(!i.success)return i;var l=o("WASmaxParseUtils").mapChildrenWithTag(a.value,"device",1,25,e);return l.success?o("WAResultOrError").makeResult(babelHelpers.extends({},i.value,{selfDevice:l.value})):l}l.parseFetchSelfResponseSuccessSelfDevice=e,l.parseFetchSelfResponseSuccess=s}),98);
__d("WASmaxOutDevicesFetchSelfRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQGetRequestMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutDevicesBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},o("WASmaxJsx").smax("self",null)));return e}l.makeFetchSelfRequest=e}),98);
__d("WASmaxDevicesFetchSelfRPC",["WAComms","WASmaxInDevicesFetchSelfResponseError","WASmaxInDevicesFetchSelfResponseSuccess","WASmaxOutDevicesFetchSelfRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WASmaxOutDevicesFetchSelfRequest").makeFetchSelfRequest(),n=yield o("WAComms").sendSmaxStanza(t,e),r=o("WASmaxInDevicesFetchSelfResponseSuccess").parseFetchSelfResponseSuccess(n,t);if(r.success)return{name:"FetchSelfResponseSuccess",value:r.value};var a=o("WASmaxInDevicesFetchSelfResponseError").parseFetchSelfResponseError(n,t);if(a.success)return{name:"FetchSelfResponseError",value:a.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("FetchSelf",{Success:r,Error:a}))}),s.apply(this,arguments)}l.sendFetchSelfRPC=e}),98);
__d("WAGetCurrentUserDeviceList",["WAAssertUnreachable","WAGlobals","WAJids","WALogger","WAPersistedJobManager","WASignalKeys","WASmaxDevicesFetchSelfRPC","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){if(t.isCurrentDevice&&n.isCurrentDevice)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Two devices were detected as isCurrentDevice in getCurrentUserDeviceList"]))),0;if(t.isCurrentDevice)return-1;if(n.isCurrentDevice)return 1;if(t.lastSeen!=null&&n.lastSeen==null)return-1;if(t.lastSeen==null&&n.lastSeen!=null)return 1;if(t.lastSeen!=null&&n.lastSeen!=null){var r=t.lastSeen,a=n.lastSeen;return a.getTime()-r.getTime()}return 0}function u(){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o("WASmaxDevicesFetchSelfRPC").sendFetchSelfRPC();switch(e.name){case"FetchSelfResponseError":{var t=e.value.errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup;switch(t.name){case"RetryableIQError":{var n=t.value.backoff;throw n!=null?new(o("WAPersistedJobManager")).RetryOnBackoff({algo:{delay:n,type:"constant"},jitter:0}):new(o("WAPersistedJobManager")).RetryOnBackoff({algo:{first:o("WATimeUtils").HOUR_MILLISECONDS/60,type:"exponential"},jitter:.1})}default:{t.name;var a=t.value.code;throw r("err")("Failed with an error code "+a)}}}case"FetchSelfResponseSuccess":{var i=o("WAJids").extractDeviceId(o("WAGlobals").getMyDeviceJid());return e.value.selfDevice.map(function(e){var t,n,r,a,l,s=e.creation,u=e.elementValue,c=e.id,d=e.ip,m=e.location,p=e.manufacturer,_=e.model,f=e.platform,g=e.seen;return{creationTime:s==null?null:o("WATimeUtils").toDate(o("WATimeUtils").castToUnixTime(s.elementValue)),id:o("WAJids").interpretAsDeviceId(c),identityKey:o("WASignalKeys").serializeIdentity(u),ipAddress:(t=d==null?void 0:d.elementValue)!=null?t:null,isCurrentDevice:c===i,lastSeen:g==null?null:o("WATimeUtils").toDate(o("WATimeUtils").castToUnixTime(g.elementValue)),latitude:m==null?null:parseFloat(m.latitude),location:(n=m==null?void 0:m.elementValue)!=null?n:null,longitude:m==null?null:parseFloat(m.longitude),manufacturer:(r=p==null?void 0:p.elementValue)!=null?r:null,model:(a=_==null?void 0:_.elementValue)!=null?a:null,platform:(l=f==null?void 0:f.elementValue)!=null?l:null}}).sort(s)}default:return r("WAAssertUnreachable")(e.name)}}),c.apply(this,arguments)}l.getCurrentUserDeviceList=u}),98);
__d("WAPublishAppDataProtocol",["FBLogger","WABridge","WAEncUserMsg","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAOdsEnums","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["sendAppDataFanout"]);function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.externalId,a=t.identities,i=t.messagePayload,l=a.get(o("WAGlobals").getMyUserJid());if(l==null)throw r("FBLogger")("wmi").mustfixThrow("Missing my user identities");var c=Array.from(l.entries()).map(function(e){var t=e[0],n=e[1];return{identity:n,jid:t}}),d=[{devicesInfo:c,user:o("WAGlobals").getMyUserJid()}],m=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WAEncUserMsg").encryptUserMsg(d,{messageBytes:i.messageBytes,type:"appdata"},{cryptoManager:t})},{operationType:"encrypt",flush:!0}),p=m.phash,_=!1,f=[];m.participants!=null&&m.participants.forEach(function(e){e.type==="pkmsg"&&(_=!0),f.push({toJid:e.to,encTypeIndividualMixinArgs:{encType:e.type,encElementValue:e.ciphertext},encVersionFutureproofMixinArgs:{encV:parseInt(e.v,10)}})});var g={appdataTo:o("WAGlobals").getMyUserJid(),toArgs:f},h={peerPeerFanout:g},y=void 0;if(_){var C=yield o("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo(),b=C==null?void 0:C.identityKey;if(b==null)throw u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"]))),r("FBLogger")("wmi").mustfixThrow("No public identity key");y={deviceIdentityElementValue:b}}var v={appdataDeviceListCheck:"true"},S={appdataId:n,peerMsgTypesArgs:h,deviceIdentityMixinArgs:y,withDeviceListCheckMixinArgs:v},R=yield o("WASmaxAppdataPublishPeerRPC").sendPeerRPC(S);switch(R.name){case"PeerResponseSuccess":{var L,E=(L=R.value.deviceListStaleMixin)==null?void 0:L.phash;return E!=null&&p!=null&&E!==p?(u.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"])),p,E),o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"}),{type:"success",ts:o("WATimeUtils").castToUnixTime(R.value.t),phash:{type:"mismatch",local:p,server:E},count:null,reportingMeta:null}):{type:"success",ts:o("WATimeUtils").castToUnixTime(R.value.t),phash:{type:"ok"},count:null,reportingMeta:null}}default:throw R.name,r("FBLogger")("wmi").mustfixThrow("Failed to send appdata %s",R.value.error)}}),d.apply(this,arguments)}l.publishAppData=c}),98);
__d("WASaveReceiptApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"saveReceipt",function(e){return(function(t){return e.receipts.put({msgId:t.id.externalId.toString(),permittedIdentitiesPerDevice:t.permittedIdentitiesPerDevice,recipientDevices:t.recipientDevices,waMsgId:o("WAMsg").craftWAMsgIdString(t.id)}).then(function(){})})});l.saveReceipt=e}),98);
__d("WAPublishMessage",["FBLogger","Promise","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.identities,r=e.messagePayload,a={author:r.protocolMsgId.author,chat:r.protocolMsgId.chat,externalId:r.protocolMsgId.externalId},i=yield o("WALoadReceiptApi").loadReceipt(a);if(i.success)return i.value;var l=new Map;for(var s of n){var u=s[0],c=s[1];for(var d of c){var m=d[0],p=d[1];m!==o("WAGlobals").getMyDeviceJid()&&l.set(m,{pubKey:p})}}var _=new Set,f={permittedIdentitiesPerDevice:l,recipientDevices:_,id:a};return t.addPoint("save_receipts_start"),yield o("WASaveReceiptApi").saveReceipt(f),t.addPoint("save_receipts_end"),f}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){var i=t.identities,l=t.messagePayload,s=t.sendIdentity,d=s===void 0?!1:s;a.addPoint("prepare_receipt_start");var m=yield c({messagePayload:l,identities:i},a);a.addPoint("prepare_receipt_end"),a.addPoint("calculate_recipients_start");var p=l.backupDirective,g=l.frankingKey,h=l.frankingVersion,y=l.messageBytes,C=l.messageType,b=l.protocolMsgId,v=_(m.permittedIdentitiesPerDevice),S=C.type==="text"&&C.invitedParticipantUserJid!=null?v.filter(function(e){return e.user===C.invitedParticipantUserJid||e.user===o("WAGlobals").getMyUserJid()}):v;a.addPoint("calculate_recipients_end",{int:{recipientsCount:S.length}});var R=C.type==="text"&&C.invitedParticipantUserJid!=null?C.invitedParticipantUserJid:b.chat,L=b.chat===o("WAGlobals").getMyUserJid();if(S.length===0&&!L)throw r("FBLogger")("wmi").mustfixThrow("Trying to send a message with no recipients");if(S.length===0&&L)return{serverResponse:{type:"success",ts:o("WATimeUtils").unixTime(),phash:{type:"ok"},count:null,reportingMeta:null},encryption:{type:"user",messageTo:o("WAGlobals").getMyUserJid(),participants:[],phash:""}};var E=d?yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return f(t)},{operationType:"get_my_device_identity",flush:!1,afterInit:!0}):null,k=yield C.isRevoked===!0?(u||(u=n("Promise"))).resolve(null):o("WAGenReportingMeta").genReportingMeta(y.bytes,g,h),I=yield o("WASendMsgInternal").sendMessageV2({type:"chat",messageBytes:y,chat:R,deviceIdentity:E,messageType:C,protocolMsgId:b,externalId:b.externalId,recipients:S,reportingMeta:k,backupDirective:p},a),T=I.serverResponse;return T.type==="success"&&(yield o("WASentBytesCache").sentBytesCache().saveSentBytes({ts:T.ts,frankingKey:g,frankingVersion:h,messageBytes:y,backupDirective:p,messageType:C,protocolMsgId:b,waMsgId:o("WAMsg").craftWAMsgIdString({author:b.author,chat:b.chat,externalId:b.externalId})}).catch(function(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""])),t)})),I}),p.apply(this,arguments)}function _(e){var t=new Map;return e.forEach(function(e,n){var r=e.pubKey,a=o("WAJids").extractUserJid(n),i={identity:r,jid:n},l=t.get(a)||[];l.push(i),t.set(a,l)}),Array.from(t,function(e){var t=e[0],n=e[1];return{devicesInfo:n,user:t}})}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{var t=yield e.storage.loadIdentities(o("WAGlobals").getMyUserJid()),n=t.get(o("WAGlobals").getMyDeviceJid());if(n!=null)return n;throw r("err")("missing-identity")}catch(e){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""])),e)}}),g.apply(this,arguments)}l.publishMessage=m}),98);
__d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestMixin","WASmaxInDevicesIQErrorItemNotFoundMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInDevicesIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:t.value});var n=o("WASmaxInDevicesIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(e);return n.success?o("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorBadRequest","IQErrorItemNotFound"],[t,n])}l.parseIQErrorBadRequestOrItemNotFoundMixinGroup=e}),98);
__d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup").parseIQErrorBadRequestOrItemNotFoundMixinGroup(e);return n.success?o("WAResultOrError").makeResult({iQErrorBadRequestOrItemNotFoundMixinGroup:n.value}):n}l.parseNonRetryableRemoveDeviceIQErrorMixin=e}),98);
__d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup",["WAResultOrError","WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin","WASmaxInDevicesRetryableIQErrorMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInDevicesRetryableIQErrorMixin").parseRetryableIQErrorMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"RetryableIQError",value:t.value});var n=o("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin").parseNonRetryableRemoveDeviceIQErrorMixin(e);return n.success?o("WAResultOrError").makeResult({name:"NonRetryableRemoveDeviceIQError",value:n.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["RetryableIQError","NonRetryableRemoveDeviceIQError"],[t,n])}l.parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup=e}),98);
__d("WASmaxInDevicesRemoveResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup").parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup:i.value})):i}l.parseRemoveResponseError=e}),98);
__d("WASmaxInDevicesRemoveResponseSuccess",["WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseRemoveResponseSuccess=e}),98);
__d("WASmaxOutDevicesKeyDataMixin",["WASmaxJsx","WASmaxMixins"],(function(t,n,r,o,a,i,l){function e(e){var t=e.anyElementValue,n=o("WASmaxJsx").smax("smax$any",null,t);return n}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeKeyDataMixin=s}),98);
__d("WASmaxOutDevicesIdentityKeyMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutDevicesKeyDataMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxJsx").smax("smax$any",null,o("WASmaxOutDevicesKeyDataMixin").mergeKeyDataMixin(o("WASmaxJsx").smax("identity",null),e));return t}function s(t,n){var r=e(n);return o("WASmaxMixins").mergeStanzas(t,r)}l.mergeIdentityKeyMixin=s}),98);
__d("WASmaxOutDevicesRemoveRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQSetRequestMixin","WASmaxOutDevicesIdentityKeyMixin","WAWap"],(function(t,n,r,o,a,i,l){function e(e){var t=e.removeId,n=e.identityKeyMixinArgs,r=o("WASmaxOutDevicesBaseIQSetRequestMixin").mergeBaseIQSetRequestMixin(o("WASmaxJsx").smax("iq",{to:o("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},o("WASmaxOutDevicesIdentityKeyMixin").mergeIdentityKeyMixin(o("WASmaxJsx").smax("remove",{id:o("WAWap").INT(t)}),n)));return r}l.makeRemoveRequest=e}),98);
__d("WASmaxDevicesRemoveRPC",["WAComms","WASmaxInDevicesRemoveResponseError","WASmaxInDevicesRemoveResponseSuccess","WASmaxOutDevicesRemoveRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=o("WASmaxOutDevicesRemoveRequest").makeRemoveRequest(e),r=yield o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInDevicesRemoveResponseSuccess").parseRemoveResponseSuccess(r,n);if(a.success)return{name:"RemoveResponseSuccess",value:a.value};var i=o("WASmaxInDevicesRemoveResponseError").parseRemoveResponseError(r,n);if(i.success)return{name:"RemoveResponseError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("Remove",{Success:a,Error:i}))}),s.apply(this,arguments)}l.sendRemoveRPC=e}),98);
__d("WARemoveDevice",["WALogger","WAPersistedJobManager","WAPushSafeTypes","WAResultOrError","WASignalOther","WASmaxDevicesRemoveRPC","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=o("WAPushSafeTypes").unsafeNotNullable(t),r=n.deviceId,a=n.identity,i=o("WASignalOther").sliceBytes(a,1,32),l=yield o("WASmaxDevicesRemoveRPC").sendRemoveRPC({removeId:r,identityKeyMixinArgs:{anyElementValue:i}});if(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["removeDevice result for ",": "," "])),r,l),l.name==="RemoveResponseSuccess")return o("WAResultOrError").makeResult();l.name;var s=l.value.errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup;if(s.name!=="RetryableIQError")return o("WAResultOrError").makeError();s.name;var u=s.value.backoff;throw u!=null?new(o("WAPersistedJobManager")).RetryOnBackoff({algo:{type:"constant",delay:u},jitter:0}):new(o("WAPersistedJobManager")).RetryOnBackoff({algo:{type:"exponential",first:o("WATimeUtils").HOUR_MILLISECONDS/60},jitter:.1})}),u.apply(this,arguments)}l.removeDevice=s}),98);
__d("WARemoveCurrentDevice",["WAGetCurrentUserDeviceInfoApi","WAGlobals","WALogger","WARemoveDevice","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();if(t==null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["There is no stored user info, it was already deleted or this job was called twice, possibly from another tab"]))),o("WAResultOrError").makeResult();var n=t.deviceId,r=t.identityKey,a=yield o("WARemoveDevice").removeDevice({deviceId:n,identity:r});return a.success&&(yield o("WAGlobals").getDependencies().clearSignalAndTempStores()),o("WAResultOrError").makeResult()});return function(){return t.apply(this,arguments)}})();l.removeCurrentDevice=s}),98);
__d("WASendAppDataFanoutProtocol",["WAAsMessageApplication","WABridge","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("WATagsLogger").TAGS(["sendAppDataFanout"]),f=24;function g(t){var n=t.checkPhash,r=n===void 0?"checkPhash":n,a=t.contents,i=t.externalId,l=t.permittedIdentitiesPerDevice;return h(a,i,l,r).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return _.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to devices with error: ",""])),n),o("WAResultOrError").makeError("runtime-error")})}function h(e,t,n,r){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){r===void 0&&(r="checkPhash"),_.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""])),t);var a=o("WAConvertAppData").convertAppData(e),i={bytes:o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()),version:"v3"},l=[],g=Array.from(n.entries()).map(function(e){var t=e[0],n=e[1];return{identity:n.pubKey,jid:t}}),h=f;g.length>h&&(_.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to "," devices"])),g.length),_.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to more than the allowed "," devices"])),h),g=g.slice(0,h));var y=[{devicesInfo:g,user:o("WAGlobals").getMyUserJid()}],C=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WAEncUserMsg").encryptUserMsg(y,{messageBytes:i,type:"appdata"},{cryptoManager:t})},{operationType:"encrypt",flush:!0}),b=C.phash,v=!1;C.participants!=null&&C.participants.forEach(function(e){e.type==="pkmsg"&&(v=!0),l.push({toJid:e.to,encTypeIndividualMixinArgs:{encType:e.type,encElementValue:e.ciphertext},encVersionFutureproofMixinArgs:{encV:parseInt(e.v,10)}})});var S={appdataTo:o("WAGlobals").getMyUserJid(),toArgs:l},R={peerPeerFanout:S},L=void 0;if(v){var E=yield o("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo(),k=E==null?void 0:E.identityKey;if(k==null)return _.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"]))),o("WAResultOrError").makeError("no-public-identity");L={deviceIdentityElementValue:k}}var I={appdataDeviceListCheck:r==="checkPhash"?"true":"false"},T={appdataId:t,peerMsgTypesArgs:R,deviceIdentityMixinArgs:L,withDeviceListCheckMixinArgs:I},D=yield o("WASmaxAppdataPublishPeerRPC").sendPeerRPC(T);switch(D.name){case"PeerResponseSuccess":{var x,$=(x=D.value.deviceListStaleMixin)==null?void 0:x.phash;return $!=null&&b!=null&&$!==b?(_.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"])),b,$),o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"}),o("WAResultOrError").makeResult({phashMismatch:!0,serverTs:o("WATimeUtils").castToUnixTime(D.value.t)})):o("WAResultOrError").makeResult({phashMismatch:!1,serverTs:o("WATimeUtils").castToUnixTime(D.value.t)})}default:return D.name,_.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""])),D.value.error),o("WAResultOrError").makeError("ack-failure")}}),y.apply(this,arguments)}l.MAX_APPDATA_RECIPIENTS=f,l.sendAppDataToDevicesProtocol=g}),98);
__d("WASendMsgUtilV2",["Promise","WADevicesState","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WAResultOrError","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e){return(_||(_=n("Promise"))).resolve()}function g(e,t){return o("WADevicesState").getDevicesState().waitForUserDevices(Array.from(new Set([e,o("WAGlobals").getMyUserJid()])),"GetDevicesBeforeSend: "+t)}function h(t){var r=t.chatJid,a=t.reason;return o("WAJids").switchOnChatJidType(r,{group:function(t){return f(t)},interopUser:function(t){return g(t,a)},lidUser:function(t){return g(t,a)},msgrUser:function(t){return g(t,a)},phoneUser:function(t){return g(t,a)}}).catch(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during get devices before sending: ",""])),t),(_||(_=n("Promise"))).resolve()})}function y(e,t){return C.apply(this,arguments)}function C(){return C=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.loadThreadParticipants,r=e.messagePayload,a={author:r.protocolMsgId.author,chat:r.protocolMsgId.chat,externalId:r.protocolMsgId.externalId},i=yield o("WALoadReceiptApi").loadReceipt(a);if(i.success)return i;t.addPoint("get_devices_before_send_start"),yield h({chatJid:r.protocolMsgId.chat,reason:"prepareReceipt"}),t.addPoint("get_devices_before_send_end");var l=yield n(r.protocolMsgId.chat);t.addPoint("get_identities_start");var u=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return t.storage.bulkLoadIdentities(l)},{flush:!1,afterInit:!0,operationType:"prepare_receipt_load_identities"}),c=[];if(u.size===0)c=[].concat(l);else for(var d of u){var m=d[0],p=d[1];p.size===0&&c.push(m)}c.length>0&&(yield o("WADevicesState").getDevicesState().waitForUserDevices(c,"GetDevicesBeforeSend: prepareReceipt",!0),u=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return t.storage.bulkLoadIdentities(l)},{afterInit:!0,flush:!1,operationType:"prepare_receipt_load_identities"}));var _=new Map;for(var f of u){var g=f[0],y=f[1];for(var C of y){var b=C[0],v=C[1];b!==o("WAGlobals").getMyDeviceJid()&&_.set(b,{pubKey:v})}}t.addPoint("get_identities_end");var S=new Set,R={permittedIdentitiesPerDevice:_,recipientDevices:S,id:a};return t.addPoint("save_receipts_start"),yield o("WASaveReceiptApi").saveReceipt(R).catch(function(e){return t.addPoint("save_receipts_fail"),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to save receipt for message with error ",""])),e),o("WAResultOrError").makeError("missing-receipt")}),t.addPoint("save_receipts_end"),o("WAResultOrError").makeResult(R)}),C.apply(this,arguments)}function b(e,t){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var r=e.isInstamadillo,a=r===void 0?!1:r,i=e.loadThreadParticipants,l=e.messagePayload,s=e.sendIdentity,p=s===void 0?!1:s;t.addPoint("prepare_receipt_start");var f=yield y({messagePayload:l,loadThreadParticipants:i},t);if(f.success===!1)return t.addPoint("prepare_receipt_fail"),o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message that does not have a receipt in db"]))),o("WAResultOrError").makeError({type:"missing-receipt"});t.addPoint("prepare_receipt_end");var g=f.value,h=l.backupDirective,C=l.frankingKey,b=l.frankingVersion,v=l.messageBytes,L=l.messageType,E=l.protocolMsgId,k=S(g.permittedIdentitiesPerDevice),I=L.type==="text"&&L.invitedParticipantUserJid!=null?k.filter(function(e){return e.user===L.invitedParticipantUserJid||e.user===o("WAGlobals").getMyUserJid()}):k;t.addPoint("recipients-calculated",{int:{recipientsCount:I.length},string:{msgType:L.type}});var T=L.type==="text"&&L.invitedParticipantUserJid!=null?L.invitedParticipantUserJid:E.chat,D=E.chat===o("WAGlobals").getMyUserJid();if(I.length===0&&!D)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients"]))),o("WAResultOrError").makeError({type:"no-recipients",isRetriable:!1});if(I.length===0&&D)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients, but it is a self thread"]))),o("WAResultOrError").makeResult({baseKey:null,reportingMeta:null,serverTs:o("WATimeUtils").unixTime()});var x=p?yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return R(t)},{operationType:"get_my_device_identity",flush:!1,afterInit:!0}):null,$=yield L.isRevoked===!0?(_||(_=n("Promise"))).resolve(null):o("WAGenReportingMeta").genReportingMeta(v.bytes,C,b);return o("WASendMsgInternal").sendMessage({type:"chat",messageBytes:v,chat:T,deviceIdentity:x,messageType:L,protocolMsgId:E,externalId:E.externalId,recipients:I,reportingMeta:$,backupDirective:h},t,a).then(function(e){return e.success?o("WASentBytesCache").sentBytesCache().saveSentBytes({ts:e.value.serverTs,frankingKey:C,frankingVersion:b,messageBytes:v,backupDirective:h,messageType:L,protocolMsgId:E,waMsgId:o("WAMsg").craftWAMsgIdString({author:E.author,chat:E.chat,externalId:E.externalId})}).catch(function(e){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""])),e)}).then(function(){return e}):e})}),v.apply(this,arguments)}function S(e){var t=new Map;return e.forEach(function(e,n){var r=e.pubKey,a=o("WAJids").extractUserJid(n),i={identity:r,jid:n},l=t.get(a)||[];l.push(i),t.set(a,l)}),Array.from(t,function(e){var t=e[0],n=e[1];return{devicesInfo:n,user:t}})}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{var t=yield e.storage.loadIdentities(o("WAGlobals").getMyUserJid()),n=t.get(o("WAGlobals").getMyDeviceJid());if(n!=null)return n;throw r("err")("missing-identity")}catch(e){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""])),e)}}),L.apply(this,arguments)}l.getDevicesBeforeSend=h,l.sendChatMessage=b}),98);
__d("WASetClockSkewApi",["WASetMetaApi"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){var e=t.clockSkew;return o("WASetMetaApi").setMeta({clockSkew:e})};l.setClockSkew=e}),98);
__d("WASendPing",["WAComms","WALogger","WASetClockSkewApi","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendPing: sending"]))),o("WAComms").sendPing()}function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.clockSkew;o("WATimeUtils").setClockSkew(t),yield o("WASetClockSkewApi").setClockSkew({clockSkew:t})}),c.apply(this,arguments)}l.sendPing=s,l.updateClockSkew=u}),98);
__d("WASyncAbProps",["WAAbPropsSync","WALogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.sendHash;o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Syncing ABProps"]))),yield o("WAAbPropsSync").syncAbProps({sendHash:n})}),u.apply(this,arguments)}l.syncAbProps=s}),98);
__d("XmaEventsE2eeFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("1399"),s=o("FalcoLoggerInternal").create("xma_events_e2ee",e),u=s;l.default=u}),98);
__d("encryptedBackupsOptOutOfBackup",["LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSOptOutOfBackupStoredProcedure","ReQL"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.encrypted_backups)).then(function(n){if(n==null)return[(e||(e=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE)];var a=n.backupId;return a!=null?t.runInTransaction(function(e){return r("LSOptOutOfBackupStoredProcedure")(r("LSFactory")(e),{backupId:a})},"readwrite",void 0,void 0,i.id+":32"):[(e||(e=o("LSIntEnum"))).ofNumber(r("LSEncryptedBackupsOpStatus").FAILURE)]})}l.optOutOfBackupStoredProcedure=s}),98);