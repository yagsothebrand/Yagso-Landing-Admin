;/*FB_PKG_DELIM*/

__d("ACTSanitizerApiTypes",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({Valid:0,UrlFailure:1,MessageTextFailure:2,CtaFailure:3});i.ACTSanitizerValidationResult=e}),66);
__d("ACTSanitizerApiWasm",["ACTSanitizerApiTypes","FBLogger","WAArmadilloXMA.pb","WAResolvable","WATagsLogger","WAWasmModuleCache","actsanitizer_api_v2","asyncToGeneratorRuntime","bx","encodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=r("bx").getURL(r("bx")("30948")),f=o("WATagsLogger").TAGS(["ACTSanitizerWasm"]);function g(){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=new(o("WAResolvable")).Resolvable,n=r("actsanitizer_api_v2")({instantiateWasm:function(a,i){return o("WAWasmModuleCache").loadWasmModule(_).then(function(e){return WebAssembly.instantiate(e,a)}).then(function(n){f.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["instantiateWasm succeeded"]))),i(n),t.resolve()}).catch(function(e){f.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["WebAssembly.instantiate failed with error: ",""])),r("getErrorSafe")(e).toString()),t.reject(e)}),{}}}).catch(function(e){throw f.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["initWasm failed with error: ",""])),r("getErrorSafe")(e).toString()),t.reject(e),e}),a=yield t.promise.then(function(){return n});return{getWasmMemorySize:function(){var e;return(e=a.wasmMemory)==null?void 0:e.buffer.byteLength},isMessageTextValid:function(t){try{var e=new TextEncoder,n=e.encode(t),i=a._malloc(n.byteLength);a.HEAPU8.set(n,i);var l=a._ACTSanitizer_isMessageTextValid(i,n.byteLength);a._free(i);var s=o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.cast(l);if(s==null)throw r("FBLogger")("messenger_web").mustfixThrow("ACT Sanitizer WASM module returned invalid validation result");return s}catch(e){throw f.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["isMessageTextValid runtime error: ",""])),r("getErrorSafe")(e).toString()),e}},isXMAValid:function(t){var e,n;try{n=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloXMA.pb").ExtendedContentMessageSpec,t).readByteArrayView(),e=a._malloc(n.byteLength),a.HEAPU8.set(n,e);var i=a._ACTSanitizer_isXMAValid(e,n.byteLength),l=o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.cast(i);if(l==null)throw f.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["module returned invalid validation result: ",""])),l),r("FBLogger")("messenger_web").mustfixThrow("ACTSanitizerWasm module returned invalid validation result");return f.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["isXMAValid succeeded with result: ",""])),l),l}catch(e){var s,u,c,_;throw f.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["isXMAValid runtime error: ",". Final memory allocation: ",". input page size: ",". xma target type: ",""])),r("getErrorSafe")(e).toString(),(s=y((u=a.wasmMemory)==null?void 0:u.buffer.byteLength))!=null?s:"unknown",(c=y((_=n)==null?void 0:_.byteLength))!=null?c:"unknown",t.targetType),e}finally{e!=null&&a._free(e)}}}}),h.apply(this,arguments)}function y(e){return e==null?null:Math.ceil(e/65536)}l.ACTSanitizerWasm=g}),98);
__d("ACTSanitizerApiLazyLoader",["ACTSanitizerApiWasm"],(function(t,n,r,o,a,i,l){"use strict";var e=null,s=1024*1024;function u(){e==null&&(e=o("ACTSanitizerApiWasm").ACTSanitizerWasm());var t=e;return t.then(function(t){var n=t.getWasmMemorySize();n!=null&&n>=s&&(e=o("ACTSanitizerApiWasm").ACTSanitizerWasm())}),t}l.loadACTSanitizerApi=u}),98);
__d("Cache",["TimeSlice"],(function(t,n,r,o,a,i,l){"use strict";var e=6e4,s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.has=function(t){return this.$1.has(t)},n.get=function(t,n){var e=this.__getRaw(t);return e?e.$2:n},n.getAll=function(t,n){var e=this,r=new Map;return t.forEach(function(t){return r.set(t,e.get(t,n))}),r},n.delete=function(t){var e=this.__getRaw(t);return e&&e.$3&&clearTimeout(e.$3),this.$1.delete(t)},n.clear=function(){this.$1.forEach(function(e){e&&e.$3&&clearTimeout(e.$3)}),this.$1.clear()},n.set=function(n,o,a,i){if(!this.shouldUpdate(n,a))return!1;var t=this.__getRaw(n);return t||(t=this.__getNewRawObject()),delete t.$2,delete t.$4,t.$3&&clearTimeout(t.$3),delete t.$3,t.$2=o,a!=null&&(t.$4=a),i!=null&&i>=0&&(t.$3=setTimeout(r("TimeSlice").guard(this.delete.bind(this,n),"Cache expiration timeout"),i*e)),this.__setRaw(n,t),!0},n.shouldUpdate=function(t,n){var e=this.__getRaw(t);return e==null||e.$4==null||n==null||n>e.$4},n.size=function(){return this.$1.size},n.__getRaw=function(t){return this.$1.get(t)},n.__setRaw=function(t,n){this.$1.set(t,n)},n.__getNewRawObject=function(){return{$2:null,$3:null,$4:null,$5:null,$6:null}},n.__keys=function(){return this.$1.keys()},t})();l.default=s}),98);
__d("E2EEMetadataMailboxFetchGroupInfoV3Mutation_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="33871081882490185"}),null);
__d("E2EEMetadataMailboxFetchGroupInfoV3Mutation.graphql",["E2EEMetadataMailboxFetchGroupInfoV3Mutation_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"input"}],t=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTFetchGroupInfoGQLResponseV3",kind:"LinkedField",name:"xfb_fetch_group_info_from_mi_v3",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"success",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"transport_thread_fbid",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"participant_update_mode",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"creator_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"creation_ts_ms",storageKey:null},{alias:null,args:null,concreteType:"XFBTFetchGroupInfoSubjectChangeGQLResponseV2",kind:"LinkedField",name:"subject_change",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"subject",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"subject_change_ts_ms",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"subject_changer_id",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBTFetchGroupInfoParticipantGQLResponse",kind:"LinkedField",name:"participants",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"contact_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"is_addressable",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"type",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"status",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"dma_interop_integrator_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"dma_interop_device_id",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"participant_version_id",storageKey:null},{alias:null,args:null,concreteType:"XFBTFetchGroupInfoEphemeralDataGQLResponseV2",kind:"LinkedField",name:"thread_ephemerality_data",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"mode",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ttl_sec",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_actor_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_timestamp_ms",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_action_log_type",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_ttl_sec",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"e2ee_attribution_timestamp_ms",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"group_evolution_version",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"open_thread_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"group_domain",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_error_code",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"E2EEMetadataMailboxFetchGroupInfoV3Mutation",selections:t,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"E2EEMetadataMailboxFetchGroupInfoV3Mutation",selections:t},params:{id:n("E2EEMetadataMailboxFetchGroupInfoV3Mutation_facebookRelayOperation"),metadata:{},name:"E2EEMetadataMailboxFetchGroupInfoV3Mutation",operationKind:"mutation",text:null}}})();a.exports=e}),null);
__d("E2EEMetadataMailboxFetchGroupInfoV3Mutation",["E2EEMetadataMailboxFetchGroupInfoV3Mutation.graphql","FBLogger","asyncToGeneratorRuntime","createWorkerMutation"],(function(t,n,r,o,a,i,l){"use strict";var e,s=e!==void 0?e:e=n("E2EEMetadataMailboxFetchGroupInfoV3Mutation.graphql");function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=r("createWorkerMutation")(s),n=t[0],o=yield n({input:e});if(o==null)throw r("FBLogger")("wmi").mustfixThrow("Failed to fetch E2EE metadata mailbox group info from MI (V3)");return o}),c.apply(this,arguments)}l.fetchGroupInfoFromMIOverGraphQLV3=u}),98);
__d("EBAPIConvertNativeToLS",["I64","LSDict","LSShape","LSVec"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return{decrypted_protobuf:t.decryptedProtobuf,protobuf_timestamp_ms:(e||(e=o("I64"))).of_float(t.protobufTimestampMs)}}function u(e,t){var n=r("LSVec").ofArray(e.map(function(e){return e.value}).filter(Boolean)),o=r("LSVec").ofArray(t.map(function(e){return c(e)}).filter(Boolean));return{echo:n,protobuf:o}}function c(e){var t=e.topLevelProtobuf,n=e.supplementalProtobufs,a=e.otid;if(a!=null){var i=new Map;n.forEach(function(e,t){var n=o("LSShape").ofRecord(s(e));i.set(t,n)});var l={otid:a,supplemental_protobufs:new(r("LSDict"))(i),tags:e.messageTags.map(function(e){return e}),toplevel_protobuf:o("LSShape").ofRecord(s(t))};return o("LSShape").ofRecord(l)}}l.convertNativeProtobufToLSType=s,l.convertNativeDecryptionResponseToDecryptedMessageType=u,l.convertDecryptedProtobufMessageToLSNativeType=c}),98);
__d("MEBEncryptionVersion",[],(function(t,n,r,o,a,i){var e=Object.freeze({UNKNOWN:0,ENCRYPTION_KDF_WITH_VERSION:2,ENCRYPTION_KDF_WITH_NULL_SALT:3,ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY:4,TEST_VERSION:99});i.default=e}),66);
__d("EBCryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionCreateEncryptedData","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=2147483647,u="message_key_in_epoch",c="_",d="cipher_version",m="thread",p="message_thread",_="supplemental_enc_aad",f="kdf_info:mailbox_root_key_v2>supplemental_enc_key";function g(t,n,o,a,i){var l=o>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:h(a),s=y(t,o,a);if(s==null)throw i.endFailWithError("failed_to_derive_message_symmetric_key"),r("err")("Error in derive message symmetric key. info is null");return b(s,l,n,[e],i)}function h(e){try{return new TextEncoder().encode(e).buffer}catch(e){throw r("err")("Error in get blob from string with exception: ",e)}}function y(e,t,n){var r=C(e,t,n);return h(r)}function C(e,t,n){return t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?[u,new TextDecoder().decode(e),d,t,m,n].join(c):t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION?[u,new TextDecoder().decode(e),d,t].join(c):[u,new TextDecoder().decode(e)].join(c)}function b(e,t,n,a,i){if(a.length<1||a.some(function(e){return e>s}))throw i==null||i.endFailWithError("invalid_key_lengths_for_derive_keys"),r("err")("Invalid key lengths for derive keys");var l=a.reduce(function(e,t){return e+t},0)*8;return o("XPlatReactCrypto").subtleImportKey("raw",n,"HKDF",!1,["deriveBits"]).then(function(n){return o("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:e,name:"HKDF",salt:t!=null?t:new Uint8Array(10).buffer},n,l)}).then(function(e){for(var t=new Uint8Array(e),n=[],r=0,o=0,i=a.length;o<i;++o){var l=r+a[o];n.push(t.slice(r,l).buffer),r=l}return n}).catch(function(e){throw i==null||i.endFailWithError("exception_in_create_derived_keys",e),r("err")("Exception in create derived keys",e)})}function v(e,t,n,a,i){var l=o("Base64Utils").toArrayBuffer(n);return S(e,t,l).then(function(e){if(e==null)throw a==null||a.endFailWithError("symmetric_string_decryption_with_null_result"),r("err")("symmetric string decryption with null result");return e}).catch(function(e){throw a==null||a.endFailWithError("symmetric_string_decryption_failed_with_error",e),r("err")("symmetric string decryption failed with encryption version: "+(i!=null?i:"null")+" and error",e)})}function S(e,t,n){if(n.byteLength<o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw r("err")("cipher text is invalid");var a=new Uint8Array(n),i=a.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),l=new(o("HChaCha20")).HChaCha20,s=a.slice(o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer,u=l.hChaCha20Bytes(i.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,e);return o("XPlatReactCrypto").subtleImportKey("raw",u,"AES-GCM",!1,["decrypt"]).then(function(e){return o("XPlatReactCrypto").subtleDecrypt({additionalData:t,iv:new Uint8Array(i.slice(o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},e,s)}).then(function(e){var t=o("SymmetricEncryptionPaddingUtils").stripPadding(e);if(t==null)throw r("err")("Failed to strip padding for symmetric decryption");return t}).catch(function(e){throw r("err")("symmetric data decryption failed with error",e)})}function R(e,t,n){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield r("SymmetricEncryptionCreateEncryptedData")(t,new TextEncoder().encode([p,n].join(c)).buffer,e),i=a[0];return i!=null?o("Base64Utils").fromArrayBuffer(i):null}),L.apply(this,arguments)}l.KEY_LEN=e,l.MAX_INT_32=s,l.STRING_JOIN_SEPARATOR=c,l.MESSAGE_ENCYPTION_AAD=p,l.SUPPLEMENTAL_ENC_AAD=_,l.SUPPLEMENTAL_ENC_KEY_INFO=f,l.deriveMessageSymmetricKey=g,l.getBlobFromString=h,l.getInfoByEncryptionVersion=C,l.createDerivedKeys=b,l.symmetricEncryptionCreateDecryptedString=v,l.encryptThenBase64EncodeBlob=R}),98);
__d("EBDecryptQplFlow",["QPLUserFlow","Random","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.annotations,n=e.decryptionType,a=e.entryPoint,i=e.isMinos,l=e.source,u=e.threadId,c=r("qpl")._(521485751,"1118"),d=o("Random").uint32();return r("QPLUserFlow").start(c,{annotations:babelHelpers.extends({},t,{bool:babelHelpers.extends({},t==null?void 0:t.bool,{is_wasm_serializer_on:r("gkx")("18428"),isMinos:i,minos_rollout_enabled:r("gkx")("20911"),occam_only_mailbox_users:r("gkx")("16674")}),int:babelHelpers.extends({},t==null?void 0:t.int,{instanceKey:d,retryCount:0}),string:babelHelpers.extends({},t==null?void 0:t.string,{decryptionType:n,queryType:a,source:l!=null?l:"unknown",threadId:u})}),instanceKey:d}),s(c,d)}function s(e,t){return{addAnnotations:function(o){r("QPLUserFlow").addAnnotations(e,o,{instanceKey:t})},addPoint:function(o,a){a&&r("QPLUserFlow").addAnnotations(e,a,{instanceKey:t}),r("QPLUserFlow").addPoint(e,o,{instanceKey:t})},endFailWithError:function(o,a,i){var n=babelHelpers.extends({},i,{string:babelHelpers.extends({},i==null?void 0:i.string,{failReason:a})});r("QPLUserFlow").endFailure(e,o,{annotations:n,instanceKey:t})},endSuccess:function(o){r("QPLUserFlow").endSuccess(e,{annotations:o,instanceKey:t})},getInstanceKey:function(){return t}}}l.startDecryptQplFlow=e}),98);
__d("EBEchoMessageDecryptor",["EBCryptoUtils","EBDecryptQplFlow","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","Promise","ReQL","WACryptoUtils","WALogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]))),r("err")("no-backup-id-provided");var a=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_epochs));if(a.length===0)throw o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] SecureEncryptedBackupsEpoch table is empty"]))),r("err")("secure-epochs-table-empty");return a.filter(function(e){return(p||(p=o("I64"))).equal(e.authorityLevel,(_||(_=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))&&(p||(p=o("I64"))).equal(e.backupId,(p||(p=o("I64"))).of_string(t))&&n.equals(e[n.key])})}),g.apply(this,arguments)}function h(e,t){var n=t.epoch_id;return n!=null?f(e,t.backup_id,{equals:function(t){return t instanceof ArrayBuffer?!1:(p||(p=o("I64"))).equal(n,t)},key:"epochId",value:n}):f(e,t.backup_id,{equals:function(n){return n instanceof ArrayBuffer?o("WACryptoUtils").arrayBuffersEqual(t.epoch_anon_id,n):!1},key:"epochAnonIdBlob",value:t.epoch_anon_id})}var y=(function(){function t(){}var a=t.prototype;return a.decrypt=function(a,i,l,c,d){var t=l.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n,l,m=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"echo_message_decryptor",entryPoint:d,isMinos:!1,source:c,threadId:i});if(t.value==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Empty echo message string - cannot decrypt"]))),m.endFailWithError("empty_echo_message_string"),{otid:t.otid,value:void 0};var p=t.value;m.addPoint("get_epoch_keys_by_id_start");var _=yield h(a,t);if(_.length===0)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),m.endFailWithError("no_epoch_keys_found_for_message"),{otid:t.otid,value:void 0};m.addPoint("get_epoch_keys_by_id_end"),m.addPoint("derive_message_symmetric_key_start");var f=yield o("EBCryptoUtils").deriveMessageSymmetricKey(_[0].epochAnonIdBlob,_[0].epochRootKeyBlob,(n=t.encryption_version)!=null?n:r("MEBEncryptionVersion").UNKNOWN,i,m);if(f==null||f.length===0)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),m.endFailWithError("failed_to_derive_symmetric_key"),{otid:t.otid,value:void 0};m.addPoint("derive_message_symmetric_key_end"),m.addPoint("symmetric_encryption_create_decrypted_string_start");var g=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(f[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,i].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,p,m,(l=t.encryption_version)!=null?l:r("MEBEncryptionVersion").UNKNOWN);return m.addPoint("symmetric_encryption_create_decrypted_string_end"),m.endSuccess(),{otid:t.otid,value:g!=null?new TextDecoder().decode(g):void 0}});return function(e){return t.apply(this,arguments)}})());return(m||(m=n("Promise"))).all(t)},t})();l.getEpochKeysByID=h,l.EchoMessageDecryptor=y}),98);
__d("EBTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeCastToDecryptedLabyrinthMessage=e}),66);
__d("EBProtobufMessageDecryptor",["Base64Utils","EBCryptoUtils","EBDecryptQplFlow","EBEchoMessageDecryptor","EBTypes","MEBEncryptionVersion","MpsTypes","Promise","WALogger","WALongInt","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=(function(){function t(){}var a=t.prototype;return a.$1=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var m,p,_=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:l,isMinos:!1,source:i,threadId:n});_.addAnnotations({string:{message_id:a.otid}}),_.addPoint("get_epoch_keys_by_id_start");var f=yield o("EBEchoMessageDecryptor").getEpochKeysByID(t,a);if(f.length===0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),_.endFailWithError("no_epoch_keys_found_for_message");return}_.addPoint("get_epoch_keys_by_id_end");var g=f[0];_.addPoint("derive_message_symmetric_key_start");var h=yield o("EBCryptoUtils").deriveMessageSymmetricKey(g.epochAnonIdBlob,g.epochRootKeyBlob,(m=a.encryption_version)!=null?m:r("MEBEncryptionVersion").UNKNOWN,n,_);if(h==null||h.length===0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),_.endFailWithError("failed_to_derive_symmetric_key");return}if(_.addPoint("derive_message_symmetric_key_end"),_.addPoint("symmetric_encryption_create_decrypted_string_start"),a.encryptedProtobufContent==null){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] encrypted protobuf content is null"]))),_.endFailWithError("encrypted_protobuf_content_is_null");return}var y=a.encryptedProtobufContent,C=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(h[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,n].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,y,_,(p=a.encryption_version)!=null?p:r("MEBEncryptionVersion").UNKNOWN),b;if(a.skCipherText!=null){var v,S,R=a.skCipherText,L=yield(S=o("EBCryptoUtils")).createDerivedKeys(new TextEncoder().encode(S.SUPPLEMENTAL_ENC_KEY_INFO).buffer,void 0,g.epochRootKeyBlob,[S.KEY_LEN],_);b=yield S.symmetricEncryptionCreateDecryptedString(L[0],new TextEncoder().encode(S.SUPPLEMENTAL_ENC_AAD).buffer,R,_,(v=a.encryption_version)!=null?v:r("MEBEncryptionVersion").UNKNOWN)}if(C==null){_.endFailWithError("failed_to_decrypt_protobuf"),o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf"])));return}_.addPoint("symmetric_encryption_create_decrypted_string_end"),_.addPoint("decrypt_supplemental_key_start");var E=b!=null?o("MpsTypes").toSupplementalKey(new TextDecoder().decode(b)):void 0;if(_.addPoint("decrypt_supplemental_key_end"),a.protobufTimestampMs==null){_.endFailWithError("protobuf_timestamp_is_null"),o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] protobuf timestamp is null"])));return}var k=o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(a.protobufTimestampMs));return _.endSuccess(),{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(C),decryptedSupplementalKey:E,protobufTimestampMs:k}});function a(e,n,r,o,a){return t.apply(this,arguments)}return a})(),a.$2=function(t){var e=t.topLevelProtobuf.encryptedProtobufContent,n=t.topLevelProtobuf.protobufTimestampMs,r=t.topLevelProtobuf.otid;if(!(e==null||n==null||r==null))return{messageTags:t.messageTags,otid:o("MpsTypes").toMessageId(r),supplementalProtobufs:new Map,topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(o("Base64Utils").toArrayBuffer(e)),decryptedSupplementalKey:void 0,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(n))}}},a.$3=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=r.topLevelProtobuf,u=r.supplementalProtobufs,c=yield this.$1(e,t,s,a,i);if(c==null){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt top level protobuf"])));return}var d=new Map;return yield(g||(g=n("Promise"))).all(u.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=yield l.$1(e,t,n,a,i);if(r==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt supplemental protobuf"])));return}var s=r.decryptedSupplementalKey;if(s==null){o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] decrypted supplemental key is null"])));return}d.set(s,r)});return function(e){return r.apply(this,arguments)}})())),{messageTags:r.messageTags,otid:r.topLevelProtobuf.otid!=null?o("MpsTypes").toMessageId(r.topLevelProtobuf.otid):void 0,supplementalProtobufs:d,topLevelProtobuf:c}});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),a.decrypt=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=[];return yield(g||(g=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){if(n.isUnencrypted===!0){var r=l.$2(n);r!=null&&s.push(r);return}var u=yield l.$3(e,t,n,a,i);if(u==null){o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf message for message with otid ",""])),n.topLevelProtobuf.otid);return}s.push(u)});return function(e){return r.apply(this,arguments)}})())),s});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),t})();l.ProtobufMessageDecryptor=h}),98);
__d("EBAPIDecryptionModule",["EBEchoMessageDecryptor","EBProtobufMessageDecryptor","WALogger","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,o,a){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Running native decryption"])));var u=new(o("EBEchoMessageDecryptor")).EchoMessageDecryptor,c=new(o("EBProtobufMessageDecryptor")).ProtobufMessageDecryptor;try{var d=a.length>0?yield u.decrypt(t,n,a,i,l):[],m=r.length>0?yield c.decrypt(t,n,r,i,l):[];return o("WAResultOrError").makeResult({decryptedEchoMessages:d,decryptedProtobufs:m})}catch(e){return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error thrown when running native decryption: ",""])),e),o("WAResultOrError").makeError(e)}}),c.apply(this,arguments)}l.decryptUsingNativeJS=u}),98);
__d("EBAPISharedTypes",[],(function(t,n,r,o,a,i){"use strict";var e=["ebls-not-initialized","no-client-state","runtime-error","invalid-client-state","invalid-graphql-response","empty-decryption-response","delete-mailbox","unsupported-context","eb-not-enabled","echo-to-protobuf-conversion-error","called-from-main-thread","missing-message-range-info","server-side-exception","thread-not-found-in-mi-act-mapping-table","thread-not-found-on-server","echo-decryption-failure","protobuf-decryption-failure","decryption-error","null-chat-jid","native-decryption-error","invalid-parameters","secure-epochs-table-empty","no-backup-id-provided"],l=new Set(e);i.EBAPIRestoreErrorValues=e,i.errorSet=l}),66);
__d("EBBase64Decode",["Base64Utils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=").replace("/,/","="),n=4-t.length%4;if(n<4)for(var r=0;r<n;r++)t+="=";return t}function s(t){return o("Base64Utils").toArrayBuffer(e(t))}l.default=s}),98);
__d("EBConvertMinosProtobufShape",["EBTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;return{messageTags:e.messageTags,otid:(t=e.otid)!=null?t:void 0,supplementalProtobufs:s(e.supplementalProtobufs),topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.topLevelProtobuf.decryptedProtobuf),decryptedSupplementalKey:e.topLevelProtobuf.decryptedSupplementalKey,protobufTimestampMs:e.topLevelProtobuf.protobufTimestampMs}}}function s(e){var t=new Map;return e.forEach(function(e,n){var r={decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.decryptedProtobuf),decryptedSupplementalKey:n,protobufTimestampMs:e.protobufTimestampMs};t.set(n,r)}),t}l.convertMinosProtobufShape=e}),98);
__d("EBDBConsistencyApi",["$InternalEnum","EBDB","FBLogger","I64","QPLUserFlow","ReQL","asyncToGeneratorRuntime","getErrorSafe","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s=["encrypted_backups_virtual_devices","secure_encrypted_backups_recovery_code_status","device_metadata","secure_encrypted_backups_epochs","secure_encrypted_backups_client_state","encrypted_backups","experiences_shared_state","auto_restore_opt_out"],u=null;function c(){return u}function d(e,t){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){try{var a=yield o("EBDB").getEBDB(),l=BigInt((e||(e=o("I64"))).to_string(n));yield a.runInTransaction(["device_state"],"readwrite",function(e){return e.stores.device_state.bulkPut([{deviceId:l,env:t}])},"EBDB - AddDevice",i.id+":54"),u=l}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on EBDB - AddDevice")}}),m.apply(this,arguments)}function p(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_client_state)).then(function(e){return e==null?void 0:e.deviceId})}function _(e,t,n){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(n!=null)return d(t,n);try{var o=yield p(e);return o==null?void 0:d(t,o)}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on fetching secure_encrypted_backups_client_state")}}),f.apply(this,arguments)}function g(e,t){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){r("QPLUserFlow").addPoint(t,"track_overprompting_start");try{var a=yield o("EBDB").getEBDB(),l=!1;yield a.runInTransaction(["device_state"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t.stores.device_state.get(e);(n==null?void 0:n.deviceId)!=null&&(l=!0)});return function(e){return t.apply(this,arguments)}})(),"EBDB - AddDevice",i.id+":107"),r("QPLUserFlow").addAnnotations(t,{bool:{overprompting:l}}),r("QPLUserFlow").addPoint(t,"track_overprompting_end")}catch(e){r("QPLUserFlow").addPoint(t,"track_overprompting_fail"),r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on track overpropting")}}),h.apply(this,arguments)}var y=n("$InternalEnum")({Disabled:0,EbsmInconsistent:1,EbdbInconsistent:2,Enabled:3,Inconsistent:4});function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield p(t),r=n!=null?BigInt((e||(e=o("I64"))).to_string(n)):null;return r==null&&u==null?y.Disabled:r==null&&u!=null?y.EbsmInconsistent:r!=null&&u==null?y.EbdbInconsistent:r===u?y.Enabled:y.Inconsistent}),b.apply(this,arguments)}function v(e,t,n,r){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o){var a=1/r("justknobx")._("3914");if(!(Math.random()>=a)){var i=r("qpl")._(521471316,"2831");try{r("QPLUserFlow").start(i);var l=yield C(e);o!=null&&r("QPLUserFlow").addAnnotations(i,o()),r("QPLUserFlow").endSuccess(i,{annotations:{int:{consistency:l,env:t,operation:n}}})}catch(e){r("QPLUserFlow").endFailure(i,"error"),r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("Error on trackConsistency in %s",t)}}}),S.apply(this,arguments)}function R(){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o("EBDB").clearDeviceState(),u=null}),L.apply(this,arguments)}var E;function k(e,t){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){E!=null&&E(),yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.encrypted_backups)).then(function(e){e!=null&&((e==null?void 0:e.backupId)==null||(e==null?void 0:e.isUserOptedOut)===!0)&&R()}).catch(function(e){r("FBLogger")("wmi_eb").catching(e).mustfix("EBDBApi: EBLS error on fetching data from encrypted_backups")}),E=t.tables.encrypted_backups.subscribe(function(e,t){t.operation!=="delete"&&(t.value.backupId==null||t.value.isUserOptedOut===!0)&&R()});var a=yield o("EBDB").getEBDB(),l=yield a.runInTransaction(["device_state"],"readonly",function(e){return e.stores.device_state.get(n)},"EBDB - readDeviceState",i.id+":250").catch(function(e){r("FBLogger")("wmi_eb").catching(e).mustfix("EBDB error: fetching device_state")});if(u=T(l==null?void 0:l.deviceId),u==null){var s=yield p(t);if(s==null)return;var c=BigInt((e||(e=o("I64"))).to_string(s));u=c,yield a.runInTransaction(["device_state"],"readwrite",function(e){return e.stores.device_state.bulkPut([{deviceId:c,env:n}])},"EBDB - writeDeviceState",i.id+":272").catch(function(e){r("FBLogger")("wmi_eb").catching(e).mustfix("EBDB error: write device_state")})}}),I.apply(this,arguments)}function T(t){if(t!=null){if(typeof t=="bigint")return t;if(typeof t=="number")return BigInt(t);if(typeof t=="string")try{return BigInt(t)}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("EBDBApi: Parsing string as BigInt"),R();return}if(Array.isArray(t))try{return BigInt((e||(e=o("I64"))).to_string(t))}catch(e){r("FBLogger")("wmi_eb").catching(r("getErrorSafe")(e)).mustfix("EBDBApi: Parsing I64 as BigInt"),R();return}r("FBLogger")("wmi_eb").mustfix("EBDBApi: Parsing unknown as BigInt %s",String(t)),R()}}l.EB_STORES=s,l.getDeviceId=c,l.addNewDevice=_,l.trackOverprompting=g,l.EBConsistencyResult=y,l.checkRegistrationConsistency=C,l.trackConsistency=v,l.clearDeviceState=R,l.startListeningDeviceRegistrations=k}),98);
__d("EBDBMetricsConsistencyOperationEnum",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({Upload:0});i.EBConsistencyOperation=e}),66);
__d("EBDedupeEncryptedLabyrinthMessages",["MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=["supplemental_protobufs","supplemental_protobufs_v2","top_level_protobuf","top_level_protobuf_unencrypted","top_level_protobuf_v2"];function s(t,n,r){return t.map(function(t){var a,i,l=t.protobuf_stanzas,s=t.otid;if(!l||s==null)return t;var u=l.supplemental_protobufs,c=l.supplemental_protobufs_v2,d=l.top_level_protobuf,m=l.top_level_protobuf_unencrypted,p=l.top_level_protobuf_v2,_=babelHelpers.objectWithoutPropertiesLoose(l,e),f=o("MpsTypes").toMessageId(s),g=n.get(f);if(g==null)return t;var h=(a=u==null?void 0:u.length)!=null?a:0,y=(i=c==null?void 0:c.length)!=null?i:0,C=!0;if(h>0||y>0){var b=u==null?void 0:u.map(function(e){return e.supplemental_otid}).filter(function(e){return e!=null}),v=new Map;if(c)for(var S of c)S.supplemental_otid!=null&&S.supplemental_key!=null&&v.set(S.supplemental_otid,S.supplemental_key);for(var R of b){var L=v.get(R);if(L==null){C=!1;break}var E=g.supplementalProtobufs.get(o("MpsTypes").toSupplementalKey(L));if(g.supplementalProtobufs.size>0&&E==null){C=!1;break}}}if(C){var k=d==null;return r.addAnnotations({bool:{missing_message_minos_restore:k}}),babelHelpers.extends({},t,{protobuf_stanzas:babelHelpers.extends({},_,{supplemental_protobufs:[],supplemental_protobufs_v2:c,top_level_protobuf:null,top_level_protobuf_unencrypted:null,top_level_protobuf_v2:p})})}return t})}l.dedupeEncryptedLabyrinthMessages=s}),98);
__d("EBDedupeLabyrinthMessages",["EBConvertMinosProtobufShape","MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=new Map;return e.forEach(function(e,n){var r=o("EBConvertMinosProtobufShape").convertMinosProtobufShape(e);t.set(n,r)}),t}function s(t,n){if(n==null)return t;var r=e(n),a=[];t.forEach(function(e){if(e.otid!=null){var t=o("MpsTypes").toMessageId(e.otid),n=r.get(t);if(n!=null){var i=u(e.supplementalProtobufs,n.supplementalProtobufs);n.supplementalProtobufs=i,a.push(n),r.delete(t)}else a.push(e)}});for(var i of r.values())a.push(i);return a}function u(e,t){var n=new Map;return e.forEach(function(e,r){var o=t.get(r);o!=null?(n.set(r,o),t.delete(r)):n.set(r,e)}),t.forEach(function(e,t){n.set(t,e)}),n}l.dedupeLabyrinthMessages=s}),98);
__d("PublicKeyEncryptionUtils",["Promise","UInt8Array","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){}function u(e){return e!=null?e:new Uint8Array(0).buffer}function c(e,t,n,r,a){return o("UInt8Array").concatBytes([e,t,n,r,a]).buffer}function d(e,t,n,r){return o("XPlatReactCrypto").subtleImportKey("raw",e.buffer,"HKDF",!1,["deriveKey"]).then(function(e){return o("XPlatReactCrypto").subtleDeriveKey({hash:"SHA-256",info:n,name:"HKDF",salt:t},e,{length:256,name:"AES-GCM"},!1,[r])})}var m="key length is not 32";function p(e,t){if(e.length!==32)return t(m)}function _(t){return new(e||(e=n("Promise")))(function(e,n){return p(t,n),e()})}var f=32;l.assertValidCurvePoint=s,l.getSalt=u,l.concatAad=c,l.getAesKey=d,l.testKeyLength=p,l.assertKeyLength=_,l.keyLength=f}),98);
__d("PublicEncryptionCreateDecryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateDecryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateDecryptedData");function c(e,t){var n=1+o("PublicKeyEncryptionUtils").keyLength+16,r=e.length;r<1+o("PublicKeyEncryptionUtils").keyLength+16&&t("CipherText length is "+r+", < "+n)}function d(e,t,n){var r=t[0];if(r!==e)return n("Unexpected version "+r)}function m(t){return new(e||(e=n("Promise")))(function(e,n){return d(1,t,n),c(t,n),e()})}function p(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(t,n),o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),e()})}function _(t,r,a,i,l,c){var d,_=new Uint8Array(l),f=new Uint8Array([1]),g=(d=o("PublicKeyEncryptionUtils")).getSalt(i),h=new Uint8Array(t),y=new Uint8Array(a),C=new Uint8Array(r),b=new Uint8Array(c);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(C),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return m(b)}).then(function(){return u.load()}).then(function(t){var r=b.slice(1,o("PublicKeyEncryptionUtils").keyLength+1),a=t.publicKeyFromBytes(r,t.KeyPurpose.Encryption);return p(a,y).then(function(){var i=o("PublicKeyEncryptionUtils").concatAad(f,y,h,r,_),l=function(o,i,l){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),s=t.publicKeyFromBytes(i,t.KeyPurpose.Encryption),u=t.secretKeyFromBytes(l,t.KeyPurpose.Encryption);return r==null||s==null||u==null||a==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,s,u,a])};return l(h,y,C).then(function(e){if(e!=null)return{ephemeralPub:e[3],innerAad:i,receiverPriv:e[2],receiverPub:e[0],senderPub:e[1]}})})}).then(function(e){if(e!=null){var t=e.ephemeralPub,n=e.receiverPriv,r=e.senderPub,a=e.innerAad;return s.load().then(function(e){return e.receiverDeriveSharedSecret(n,t,r)}).then(function(e){return e==null?null:o("PublicKeyEncryptionUtils").getAesKey(e,g,a,"decrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer,n=b.slice(o("PublicKeyEncryptionUtils").keyLength+1).buffer;return o("XPlatReactCrypto").subtleDecrypt({additionalData:a,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,n)}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_decrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of decrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=_}),98);
__d("PublicEncryptionCreateEncryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","UInt8Array","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateEncryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateEncryptedData");function c(e,t){if(e.byteLength>32)return t("PSK is too long")}function d(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),c(t,n),e()})}function m(t,r,a,i,l,c){var m,p=new Uint8Array([1]),_=new Uint8Array(l),f=(m=o("PublicKeyEncryptionUtils")).getSalt(i),g=new Uint8Array(t),h=new Uint8Array(r),y=new Uint8Array(a);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(g),o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return d(f,g)}).then(function(){return u.load()}).then(function(t){var r=t.generateKeys(t.KeyPurpose.Encryption),a=r.pk,i=o("PublicKeyEncryptionUtils").concatAad(p,h,g,a,_),l=function(o,a,i){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),l=t.publicKeyFromBytes(a,t.KeyPurpose.Encryption),s=t.secretKeyFromBytes(i,t.KeyPurpose.Encryption);return r==null||l==null||s==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,l,s])};return l(g,h,y).then(function(e){return e==null?null:{ephemeralPriv:r.sk,ephemeralPubBytes:r.pk,innerAad:i,receiverPub:e[0],senderPriv:e[2],senderPub:e[1]}})}).then(function(e){if(e!=null){var t=e.ephemeralPubBytes,n=e.ephemeralPriv,r=e.senderPriv,a=e.receiverPub,i=e.innerAad;return s.load().then(function(e){return e.senderDeriveSharedSecret(r,n,a)}).then(function(e){if(e!=null)return o("PublicKeyEncryptionUtils").getAesKey(e,f,i,"encrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer;return o("XPlatReactCrypto").subtleEncrypt({additionalData:i,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,c)}}).then(function(e){if(e!=null){var n=new Uint8Array(e);return o("UInt8Array").concatBytes([p,t,n]).buffer}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_encrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of encrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=m}),98);
__d("EBEpochUtils",["Base64Utils","EBCryptoUtils","FBLogger","I64","Promise","PublicEncryptionCreateDecryptedData","PublicEncryptionCreateEncryptedData","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u="epoch_chaining",c="epoch_root_key",d="epoch_data_storage",m="epoch_data_metadata",p=18;function _(e){var t=new TextEncoder().encode("0").buffer;if(e==null||e.byteLength===0)return t;var n=new TextDecoder,o=n.decode(e),a=Number.parseInt(o,10);if(Number.isNaN(a))throw r("FBLogger")("messenger_web").mustfixThrow("currentEpochInt is NaN");var i=a+1;return new TextEncoder().encode(i.toString()).buffer}function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=[(a=o("EBCryptoUtils")).KEY_LEN,a.KEY_LEN],l=a.getBlobFromString([u,e,(s||(s=o("I64"))).to_string(t)].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR));if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("infoForEpochChaining is empty");var c=yield o("EBCryptoUtils").createDerivedKeys(l,null,n,i);return{epoch_chaining_key:c[0],epoch_distribution_pre_shared_key:c[1]}}),g.apply(this,arguments)}function h(e,t,n,r,o,a){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateDecryptedData")(e,t,n,o,v(a),i);return l[0]}),y.apply(this,arguments)}function C(e,t,n,r,o,a){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateEncryptedData")(e,t,n,o,v(a),i);return l[0]}),b.apply(this,arguments)}function v(e){return new TextEncoder().encode(["epoch_",e].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer}function S(e,t,n,r){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=yield o("EBCryptoUtils").createDerivedKeys(e,t,n,r);return a[0]}),R.apply(this,arguments)}function L(e,t){var n=o("EBCryptoUtils").getBlobFromString(c);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("epochRootKey is empty");return S(n,e,t,[o("EBCryptoUtils").KEY_LEN])}function E(e,t){var n=new TextEncoder().encode("meb/debug/fingerprint/"+t).buffer;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("blob type for which fingerprints are supported is empty");return S(n,null,e,[p])}function k(e,t,n){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a){var i=[o("EBCryptoUtils").KEY_LEN],l=o("Base64Utils").fromArrayBuffer(r),s=[t,l].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR),u=yield o("EBCryptoUtils").createDerivedKeys(new TextEncoder().encode(s).buffer,null,a,i);return u.length===0?(e||(e=n("Promise"))).resolve():u[0]}),I.apply(this,arguments)}function T(e){return k(d,e.epochAnonIdBlob,e.epochRootKeyBlob)}function D(e,t){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield $(t,e,m);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("symmetricDecryptAndBase64Decode output is empty while decrypting backward edge");return o("Base64Utils").toArrayBuffer(n)}),x.apply(this,arguments)}function $(e,t,n){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=new TextEncoder().encode(n).buffer;if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("aadBuffer is empty");var i=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(t,a,e);if(i==null)throw r("FBLogger")("messenger_web").mustfixThrow("decrypted_arraybuffer is empty");return new TextDecoder().decode(i)}),P.apply(this,arguments)}l.getNextEpochId=_,l.generateEpochChainingAndDistributionPreSharedKey=f,l.decryptEpochKey=h,l.generateEncryptedEpochKey=C,l.deriveKey=S,l.generateEpochRootKey=L,l.getFingerPrint=E,l.createDerivedKeysForEpoch=k,l.deriveBackwardEdgeKey=T,l.decryptBackwardEdge=D}),98);
__d("LSEpochStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({ES_OPEN:1,ES_CLOSE:2});i.default=e}),66);
__d("MEBEpochDerivationResult",[],(function(t,n,r,o,a,i){var e=Object.freeze({SUCCESS:0,UNKNOWN_ERROR:1,EDGE_NEITHER_FORWARD_NOR_BACKWARD:2,FORWARD_DECRYPTION_FAILED:3,FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:4,BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:5,BACKWARD_DECRYPTION_FAILED:6,MISSING_CLIENT_STATE:7,DEVICE_ID_MISMATCH:8,SOURCE_FINGERPRINT_MISMATCH:9,DEST_FINGERPRINT_MISMATCH:10,STORAGE_KEY_MISMATH:11,PSK_FINGERPRINT_MISMATCH:12,SOURCE_EPOCH_NOT_FOUND:13,FORWARD_EDGE_NOT_CONSECUTIVE:14,BACKWARD_EDGE_NOT_CONSECUTIVE:15,DERIVATION_DEST_EXISTS:16,DERIVATION_DEST_ANON_ID_EXISTS:17});i.default=e}),66);
__d("EBDeriveAndStoreEpochs",["Base64Utils","EBBase64Decode","EBEpochUtils","I64","LSAuthorityLevel","LSEpochStatus","MEBEpochDerivationResult","ReQL","WACryptoUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i){var l,s,u,c,d=yield o("EBEpochUtils").getNextEpochId(i.epochAnonIdBlob),m=a==null||(l=a.to_epoch)==null?void 0:l.epoch_anon_id;if(m==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var p=r("EBBase64Decode")(m);if(new TextDecoder().decode(d)!==new TextDecoder().decode(p))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge not consecutive",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var _=a==null||(s=a.from_epoch)==null?void 0:s.epoch_id,f=a==null||(u=a.from_epoch)==null?void 0:u.epoch_anon_id;if(_==null||f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f),h=new TextDecoder().decode(g),y=yield o("EBEpochUtils").generateEpochChainingAndDistributionPreSharedKey(h,(e||(e=o("I64"))).of_string(_),i.epochRootKeyBlob),C=y.epoch_distribution_pre_shared_key,b=yield o("EBEpochUtils").getFingerPrint(C,"MEBCryptoPreSharedKey");if((n==null?void 0:n.psk_fingerprint)!==o("Base64Utils").fromArrayBuffer(b))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge psk fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").PSK_FINGERPRINT_MISMATCH});var v=n==null?void 0:n.epoch_storage_public_key;if(o("Base64Utils").fromArrayBuffer(t.epochStoragePublicKeyBlob)!==v)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge storage key mismatch",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH});var S=n==null?void 0:n.auth_public_key;if(S==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var R=a==null||(c=a.to_epoch)==null?void 0:c.epoch_anon_id;if(R==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var L=n==null?void 0:n.encrypted_entropy;if(L==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var E=r("EBBase64Decode")(S);if(E==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var k=r("EBBase64Decode")(L);if(k==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var I=r("EBBase64Decode")(R),T=new TextDecoder().decode(I),D=yield o("EBEpochUtils").decryptEpochKey(t.epochStoragePublicKeyBlob,t.epochStoragePrivateKeyBlob,E,C,T,k);return D==null?o("WAResultOrError").makeError({errorMessage:"epoch forward edge entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_DECRYPTION_FAILED}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").generateEpochRootKey(y.epoch_chaining_key,D))}),u.apply(this,arguments)}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=t==null||(a=t.to_epoch)==null?void 0:a.epoch_anon_id;if(i==null)return o("WAResultOrError").makeError({errorMessage:"toEpochId is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var l=o("EBEpochUtils").getNextEpochId(r("EBBase64Decode")(i));if(!o("WACryptoUtils").arrayBuffersEqual(l,e.epochAnonIdBlob))return o("WAResultOrError").makeError({errorMessage:"epoch backward edge not consecutive",resultCode:r("MEBEpochDerivationResult").BACKWARD_EDGE_NOT_CONSECUTIVE});var s=yield o("EBEpochUtils").deriveBackwardEdgeKey(e);return s==null?o("WAResultOrError").makeError({errorMessage:"epoch backward edge storage key is null",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").decryptBackwardEdge(s,n))}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a,l,u,d,m=yield t.runInTransaction(function(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.secure_encrypted_backups_client_state))},"readwrite",void 0,void 0,i.id+":224");if(m==null)return o("WAResultOrError").makeError({errorMessage:"client state is missing",resultCode:r("MEBEpochDerivationResult").MISSING_CLIENT_STATE});var p=n==null||(a=n.from_epoch)==null?void 0:a.epoch_id;if(p==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var _=yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.get((e||(e=o("I64"))).of_string(p))},"readwrite",void 0,void 0,i.id+":242");if(_==null)return o("WAResultOrError").makeError({errorMessage:"source epoch is missing",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var f=n==null||(l=n.from_epoch)==null?void 0:l.epoch_anon_id;if(f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f);if(new TextDecoder().decode(_.epochAnonIdBlob)!==new TextDecoder().decode(g))return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch anon id mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var h=n==null?void 0:n.from_epoch_fingerprint,y=yield o("EBEpochUtils").getFingerPrint(_.epochRootKeyBlob,"MEBEpochRootKey");if(o("Base64Utils").fromArrayBuffer(y)!==h)return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var C=n==null?void 0:n.forward_edge,b;if(C!=null)b=yield s(m,C,n,_);else{var v=n==null?void 0:n.backward_edge;if(v==null)return o("WAResultOrError").makeError({errorMessage:"backward edge is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=yield c(_,n,v)}var S=n==null?void 0:n.to_epoch_fingerprint,R=b.value,L=n==null||(u=n.to_epoch)==null?void 0:u.epoch_id,E=n==null||(d=n.to_epoch)==null?void 0:d.epoch_anon_id;if(L==null||E==null)return o("WAResultOrError").makeError({errorMessage:"target epoch id or anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});if(R==null)return b;var k=yield o("EBEpochUtils").getFingerPrint(R,"MEBEpochRootKey");if(S!==o("Base64Utils").fromArrayBuffer(k))return o("WAResultOrError").makeError({errorMessage:"epoch derivation target epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").DEST_FINGERPRINT_MISMATCH});var I=r("EBBase64Decode")(E);return yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.put({authorityLevel:(e||(e=o("I64"))).of_float(r("LSAuthorityLevel").AUTHORITATIVE),backupId:m.backupId,epochAnonIdBlob:I,epochId:e.of_string(L),epochRootKeyBlob:R,epochStatus:e.of_float(r("LSEpochStatus").ES_CLOSE)})},"readwrite",void 0,void 0,i.id+":331"),o("WAResultOrError").makeResult(R)}),p.apply(this,arguments)}function _(e,t){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if((t==null?void 0:t.epoch_edges)==null)return[];var n=[];for(var o of t.epoch_edges){var a,i,l,s,u,c=yield m(e,o),d={resultForEpochSync:{error_message:(a=c.error)==null?void 0:a.errorMessage,from:{epoch_anon_id:(i=o.from_epoch)==null?void 0:i.epoch_anon_id,epoch_id:o==null||(l=o.from_epoch)==null?void 0:l.epoch_id},has_backward_edge:(o==null?void 0:o.backward_edge)!=null,has_forward_edge:(o==null?void 0:o.forward_edge)!=null,result_code:c.success?r("MEBEpochDerivationResult").SUCCESS:c.error.resultCode,to:{epoch_anon_id:o==null||(s=o.to_epoch)==null?void 0:s.epoch_anon_id,epoch_id:o==null||(u=o.to_epoch)==null?void 0:u.epoch_id}}};n.push(d)}return n}),f.apply(this,arguments)}l.deriveAndStoreEpochsNonLS=_}),98);
__d("EBMinosEncryptedMekVersion",["$InternalEnum","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({V1:1,V2:2}),s=e.V1,u=r("gkx")("19417")?e.V2:e.V1;l.MinosEncryptedMekVersion=e,l.INITIAL_VERSION=s,l.MINOS_ENCRYPTED_MEK_CURRENT_VERSION=u}),98);
__d("EBMinosClientConfig",["EBMinosEncryptedMekVersion","EBMinosMessageEncryptionVersion"],(function(t,n,r,o,a,i,l){"use strict";var e={preferredMekEncryptionVersion:o("EBMinosEncryptedMekVersion").MINOS_ENCRYPTED_MEK_CURRENT_VERSION,preferredMessageEncryptionVersion:o("EBMinosMessageEncryptionVersion").MINOS_MESSAGE_ENCRYPTION_CURRENT_VERSION};l.MINOS_CLIENT_CONFIG=e}),98);
__d("EBMinosWasmEncryptMekForDistribution",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.version,a=o("WALongInt").maybeNumberOrThrowIfTooLarge(r);if(a==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var i=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),a),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(n),mekEncryptionVersion:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.fromKeypair,r=e.mek,a=e.senderEpochHead,i=e.toEpochHead,l=e.toMailboxPk;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMekForDistributionResultSpec,validateResult:t},{encryptMekForDistribution:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,fromKeypair:n,mek:r,senderEpochHead:a,toEpochHead:i,toMailboxPk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptMekForDistribution=u}),98);
__d("EBMinosWasmEncryptMeksForDistributionFromTransportSender",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.encryptedMeks,r=t.ephemeralEncryptionPk,a=t.signature,i=t.signingPk,l=t.version,s=o("WALongInt").maybeNumberOrThrowIfTooLarge(l);if(s==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var u=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(s);return u==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),s),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMeks:n.map(o("EBMinosTypes").unsafeCastToEncryptedMek),encryptedMekVersion:u,ephemeralEncryptionPk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(r),signature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(a),signingPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(i)})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mek,r=e.recipientEpochHeads,a=e.recipientMailboxEncryptionPks,i=e.transportSigningKp;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMeksForDistributionFromTransportSenderResultSpec,validateResult:t},{encryptMeksForDistributionFromTransportSender:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,recipientEpochHeads:r,recipientMailboxEncryptionPks:a,transportSigningKp:i}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.createMinosWasmEncryptMeksForDistributionFromTransportSender=s,l.encryptMeksForDistributionFromTransportSender=u}),98);
__d("EBMinosWasmGenerateMek",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mek;return o("WAResultOrError").makeResult({key:o("EBMinosTypes").unsafeCastMekKey(t.key),mekId:o("EBMinosTypes").unsafeCastToMekId(t.mekId),rosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(t.rosterHash)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekResultSpec,validateResult:e},{generateMek:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMek=s}),98);
__d("WAPromiseMap",["Promise"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r){return(e||(e=n("Promise"))).resolve(t).then(function(t){return(e||(e=n("Promise"))).all(t.map(function(e,t){return r(e,t)}))})}i.promiseMap=l}),66);
__d("EBGenerateAndUploadMek",["EBMinosEncryptedMekVersion","EBMinosWasmEncryptMekForDistribution","EBMinosWasmEncryptMeksForDistributionFromTransportSender","EBMinosWasmGenerateMek","WAErrorMessage","WAPromiseMap","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["mekEncryptionVersion","mekEnvelopes"],s,u,c,d,m,p,_,f,g,h,y,C,b;function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.io,a=t.logger,i=t.msgUploadQpl,l=t.participantMailboxes,f=t.sender;a.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start generate and upload mek"]))),i.addPoint("generate_mek_start");var g=l.map(function(e){var t=e.epochHead;return t}),h=yield o("EBMinosWasmGenerateMek").generateMek({epochHeads:g});if(!h.success)return a.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["mek generated error: ",""])),h.error),o("WAResultOrError").makeError("generate-mek-error");i.addPoint("generate_mek_end"),a.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Sender type: ",". Epoch FBID: ",""])),f.senderType,f.senderEpochFbId),i.addPoint("get_minos_mailbox_key_end",{string:{senderType:f.senderType}}),a.DEV(d||(d=babelHelpers.taggedTemplateLiteralLoose(["start encrypy mek. senderType: ",""])),f.senderType),i.addPoint("encrypt_mek_envelopes_start");var y=h.value,C=yield f.senderType==="Minos"?R({fromKeypair:f.fromKeypair,logger:a,mek:y,participantMailboxes:l,senderEpochFbId:f.senderEpochFbId,senderEpochHead:f.senderEpochHead}):E({logger:a,mek:y,participantMailboxes:l,transportSigningKp:f.transportSigningKp});if(!C.success)return i.addPoint("encrypt_mek_envelopes_fail"),o("WAResultOrError").makeError("encrypt-mek-error");i.addPoint("encrypt_mek_envelopes_end");var b=C.value,v=b.mekEncryptionVersion,S=b.mekEnvelopes,L=babelHelpers.objectWithoutPropertiesLoose(b,e);i.addAnnotations({int:{mek_encryption_version:v}}),i.addPoint("register_mek_gql_start");var k=yield r.registerMinosMessageEncryptionKey({actThreadId:n,instanceKey:i.getInstanceKey(),mekEncryptionVersion:v,mekEnvelopes:S,mekId:y.mekId,mekRosterHash:y.rosterHash,sender:L}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return a.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["upload mek runtime-error: ",". ",""])),t,e),o("WAResultOrError").makeError({errorName:"runtime-error",failReason:t})});if(k.success!==!0){var I=k.error,T=I.errorName,D=I.failReason;return a.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["upload mek error: ",". Reason: ",""])),T,D),i.addPoint("register_mek_gql_fail"),o("WAResultOrError").makeError("distribute-mek-error")}return i.addPoint("register_mek_gql_end"),a.DEV(_||(_=babelHelpers.taggedTemplateLiteralLoose(["register minos message encryption key success"]))),o("WAResultOrError").makeResult({mek:y,mekFbid:k.value.mekFbid})}),S.apply(this,arguments)}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.fromKeypair,r=e.logger,a=e.mek,i=e.participantMailboxes,l=e.senderEpochFbId,s=e.senderEpochHead,u=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,c=yield o("WAPromiseMap").promiseMap(i,(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.epochHead,i=e.mailboxKey,l=e.mailboxKeyFbid,c=e.participantId,d=yield o("EBMinosWasmEncryptMekForDistribution").encryptMekForDistribution({fromKeypair:t,mek:a,senderEpochHead:s,toEpochHead:n,toMailboxPk:i});if(!d.success)return r.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),d.error),null;var m=d.value.mekEncryptionVersion;if(m!=null)u=m;else return r.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),d.value.mekEncryptionVersion),null;return{encryptedMek:d.value.encryptedMek,mailboxKey:i,mailboxKeyFbid:l,participantId:c}});return function(t){return e.apply(this,arguments)}})()),d=c.filter(Boolean);return d.length===0?(r.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["no successful mek encryption results"]))),o("WAResultOrError").makeError("encrypt-mek-error")):o("WAResultOrError").makeResult({epochFbId:l,mekEncryptionVersion:u,mekEnvelopes:d,senderType:"Minos"})}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mek,r=e.participantMailboxes,a=e.transportSigningKp,i=yield o("EBMinosWasmEncryptMeksForDistributionFromTransportSender").encryptMeksForDistributionFromTransportSender({mek:n,recipientEpochHeads:r.map(function(e){var t=e.epochHead;return t}),recipientMailboxEncryptionPks:r.map(function(e){var t=e.mailboxKey;return t}),transportSigningKp:a});if(!i.success)return t.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),i.error),o("WAResultOrError").makeError("encrypt-mek-error");if(i.value.encryptedMeks.length!==r.length)return t.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["number of encrypted meks does not match number of participants"]))),o("WAResultOrError").makeError("encrypt-mek-error");var l=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,s=r.map(function(e,n){var r=i.value.encryptedMekVersion;if(r!=null)l=r;else return t.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),i.value.encryptedMekVersion),null;return{encryptedMek:i.value.encryptedMeks[n],mailboxKey:e.mailboxKey,mailboxKeyFbid:e.mailboxKeyFbid,participantId:e.participantId}}),u=s.filter(Boolean);return o("WAResultOrError").makeResult({ephemeralEncryptionPk:i.value.ephemeralEncryptionPk,mekEncryptionVersion:l,mekEnvelopes:u,senderType:"Transport",signature:i.value.signature,signingPk:i.value.signingPk})}),k.apply(this,arguments)}l.generateAndUploadMek=v}),98);
__d("EncryptedBackupsUtils",["FBLogger","WAJids","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return Date.now()-t>o("WATimeUtils").DAY_MILLISECONDS*30},s=function(t){return Date.now()-t>o("WATimeUtils").DAY_MILLISECONDS*30};function u(e,t,n,r,o){var a={frankingTag:r==null?void 0:r.frankingTag,reportingTag:r==null?void 0:r.reportingTag},i={frankingMetadata:a,messageId:t,senderId:e,timestampMs:n};return{encryptedTransportMessage:o,metadata:i}}function c(e){return JSON.stringify([e.author,e.chat,e.externalId])}function d(e){var t=JSON.parse(e);if(!Array.isArray(t))throw r("FBLogger")("wmi_eb").mustfixThrow("Unable to parse msg id string as proper json");if(t.length!==3)throw r("FBLogger")("wmi_eb").mustfixThrow("Parsed array should have 3 components");var n=o("WAJids").unsafeCoerceToUserJid(t[0]),a=o("WAJids").unsafeCoerceToChatJid(t[1]),i=o("WAStanzaUtils").toStanzaId(t[2]);return{author:n,chat:a,externalId:i}}l.entryOlderThan30Days=e,l.timestampOlderThan30Days=s,l.asBackupMessage=u,l.convertWAMsgIdToStringId=c,l.convertStringIdToWAMsgId=d}),98);
__d("MAWExtractMsFromExternalId",["I64","MAWExternalId","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=2199023255551;function c(t){try{var n=(s||(s=o("I64"))).of_string_opt(t);if(n!=null){var r;return(r=d(n))!=null?r:0}}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to convert externalId to number: ",""])),t)}return 0}function d(e){var t=Number((s||(s=o("I64"))).to_string(s.and_(s.lsr_(e,22),s.of_float(u))));return o("MAWExternalId").getThreeMostSignificantDigitsForSortOrderTimestamp(t)}l.extractMsFromStanzaId=c,l.extractMsFromExternalId=d}),98);
__d("EBGenerateMessageTags",["EncryptedBackupsUploadEntity","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return o("MSGDataclassTypes.flow").MpsMessageTag.Photo;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return o("MSGDataclassTypes.flow").MpsMessageTag.Video;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return o("MSGDataclassTypes.flow").MpsMessageTag.Gif;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return o("MSGDataclassTypes.flow").MpsMessageTag.Audio;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return o("MSGDataclassTypes.flow").MpsMessageTag.File;default:return null}}l.generateEBMessageTags=e}),98);
__d("EBGetClientState",["EBLogger","EBMinosInterfaceTypes","I64","LSAuthorityLevel","LSIntEnum","ReQL","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a=n!=null?yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_client_state)):yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_client_state)),i=n!=null?yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_epochs)):yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_epochs)),l=i.filter(function(e){return(s||(s=o("I64"))).equal(e.authorityLevel,(u||(u=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}).map(function(e){return(s||(s=o("I64"))).to_string(e.epochId)});if(a==null){o("EBLogger").EBLogger("wmi").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web Client state is null - unable to proceed with GQL restore"])));return}var c=(a==null?void 0:a.deviceId)!=null?o("EBMinosInterfaceTypes").unsafeCastToDeviceId((s||(s=o("I64"))).to_string(a==null?void 0:a.deviceId)):null,d=a.mailboxRootKeyBlob,m=a.ocmfClientStateBlob,p=o("EBMinosInterfaceTypes").unsafeCastToBackupFbid((s||(s=o("I64"))).to_string(a.backupId)),_=a.encryptionVersion;return{backupId:p,deviceId:c,encryptionVersion:_,locally_available_epochs:l,mailboxRootKey:d,ocmfClientStateBlob:m}}),d.apply(this,arguments)}l.getClientState=c}),98);
__d("EBGetMinosAttachmentPayloadFromMpsMessage",["EBMinosTypes","EBMinosWasmDeriveAttachmentAccessTokenSecret","EBMinosWasmDeriveAttachmentPrimaryKeySecret","MpsMessageToBridgeWrapper","Promise","WAMediaUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e){var t,r,a=e.logger,i=e.message,l=e.qplFlow,s=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(i),u=s.deserialize(),c=(t=u.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(c!=null)return f({consumerApplication:c,logger:a,qplFlow:l});var d=(r=u.encryptedTransportMessage())==null||(r=r.armadillo())==null?void 0:r.extendedContentMessage();return d!=null?h({extendedContentMessage:d,logger:a,qplFlow:l}):(p||(p=n("Promise"))).resolve([])}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n,r,a,i,l,s=e.consumerApplication,u=e.logger,c=e.qplFlow,d=s.attachmentMessage();if(d==null||((t=d.payload.integral)==null?void 0:t.receiverFetchId)!=null)return[];var m=d.kind,p=d.payload.integral,_=(n=p==null||(r=p.transport)==null?void 0:r.integral)!=null?n:{},f=_.mediaKey,g=(a=p==null||(i=p.transport)==null?void 0:i.ancillary)!=null?a:{},h=g.objectId,y=yield C({logger:u,maybeMediaKey:f,maybeObjectId:h}),b=p==null||(l=p.transport)==null||(l=l.ancillary)==null||(l=l.thumbnail)==null?void 0:l.downloadableThumbnail,S=b==null?null:yield C({logger:u,maybeMediaKey:b.mediaKey,maybeObjectId:b.objectId}),R=c.getInstanceKey().toString();return[y.success===!0?babelHelpers.extends({},y.value,{attachmentTraceId:R,mediaType:v(m)}):null,(S==null?void 0:S.success)===!0?babelHelpers.extends({},S.value,{attachmentTraceId:R,mediaType:o("EBMinosTypes").MinosAttachmentMediaType.MESSENGER_PREVIEW}):null].filter(Boolean)}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.extendedContentMessage,a=t.logger,i=t.qplFlow,l=[r.favicon(),r.headerImage()].concat(r.previews()).filter(Boolean);if(l.length===0)return[];var u=yield(p||(p=n("Promise"))).all(l.map(function(e){var t,n;return C({logger:a,maybeMediaKey:(t=e.integral)==null||(t=t.transport)==null||(t=t.integral)==null?void 0:t.mediaKey,maybeObjectId:(n=e.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId})})),c=u.filter(function(e){return e.success===!0}),d=u.filter(function(e){return e.success===!1});return d.forEach(function(t){a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse an attachment in XMA message: ",""])),t.error)}),c.length===0&&a.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse all attachments in XMA message"]))),c.map(function(e){return babelHelpers.extends({},e.value,{attachmentTraceId:i.getInstanceKey().toString(),mediaType:o("EBMinosTypes").MinosAttachmentMediaType.XMA})})}),y.apply(this,arguments)}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.maybeMediaKey,r=e.maybeObjectId;if(n==null)return t.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing mediaKey in media message protobuf"]))),o("WAResultOrError").makeError("missing-media-key");if(r==null)return t.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing objectId in media message protobuf"]))),o("WAResultOrError").makeError("missing-object-id");var a=o("WAMediaUtils").castToMediaKey(n),i=yield o("EBMinosWasmDeriveAttachmentPrimaryKeySecret").deriveAttachmentPrimaryKeySecret({mediaKey:a});if(!i.success)return t.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment primary key secret"]))),o("WAResultOrError").makeError("derive-primary-key-secret-error");var l=yield o("EBMinosWasmDeriveAttachmentAccessTokenSecret").deriveAttachmentAccessTokenSecret({mediaKey:a});return l.success?o("WAResultOrError").makeResult({accessTokenSecret:l.value,primaryKeySecret:i.value,zippyObjectId:o("WAMediaUtils").stringToDeliveryObjectId(r)}):(t.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment access token secret"]))),o("WAResultOrError").makeError("derive-access-token-secret-error"))}),b.apply(this,arguments)}function v(e){return e==="audioTransport"?o("EBMinosTypes").MinosAttachmentMediaType.PTT:e==="imageTransport"?o("EBMinosTypes").MinosAttachmentMediaType.IMAGE:e==="videoTransport"?o("EBMinosTypes").MinosAttachmentMediaType.VIDEO:e==="stickerTransport"?o("EBMinosTypes").MinosAttachmentMediaType.STICKER:e==="documentTransport"?o("EBMinosTypes").MinosAttachmentMediaType.DOCUMENT:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}l.getMinosAttachmentPayloadFromMpsMessage=_}),98);
__d("EBGraphQLRestoreDefinition",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.toMpsMessageQueryForGraphQLQuery=e}),66);
__d("EBMessageEncryptionKeyStorage",["WABase64","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return o("WABase64").encodeB64(e)+"|"+o("WABase64").encodeB64(t)}function u(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekCreatorEpochHead,i=t.minosThreadId,l=t.rosterHash,u=s(l,i),c=a.get(u);if(c!=null)return{cacheStatus:"cached-by-memory",registeredMek:c};var d=yield r.loadMessageEncryptionKey(i,l,n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKey runtime-error: ",""])),t),null});return d!=null?(a.set(u,d),{cacheStatus:"cached-by-db",registeredMek:d}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.createdBySelf,n=e.lastUsedTsMs,o=e.mekCreatorEpochHead,i=e.minosThreadId,l=e.registeredMek,u=e.rosterHash,c=s(u,i);a.set(c,l),yield r.saveNewMessageEncryptionKey(i,l.mek,l.mekFbid,t,n,o)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKey:i,setNewMessageEncryptionKey:l}}l.createMessageEncryptionKeyStorage=u}),98);
__d("EBMessageEncryptionKeyStorageDecrypt",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekId,i=a.get(n);if(i!=null)return{cacheStatus:"cached-by-memory",registeredMek:i};var l=yield r.loadMessageEncryptionKeyForDecryption(n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKeyForDecryption runtime-error: ",""])),t),null});return l!=null?(a.set(n,l),{cacheStatus:"cached-by-db",registeredMek:l}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.createdBySelf,n=e.lastUsedTsMs,o=e.minosThreadId,i=e.registeredMek,l=i.mek.mekId;a.set(l,i),yield r.saveNewMessageEncryptionKey(o,i.mek,i.mekFbid,t,n,null)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKeyDecrypt:i,setNewMessageEncryptionKeyDecrypt:l}}i.createMessageEncryptionKeyStorageDecrypt=l}),66);
__d("EBSMAPI",["EBDeps","Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(){return s!=null||(s=o("EBDeps").getDeps().getEBSMAPI()),s}var c={addDeviceWithEBKeys:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).addDeviceWithEBKeys.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),addDeviceWithRecoveryCode:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).addDeviceWithRecoveryCode.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),addVirtualDevice:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).addVirtualDevice.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),deleteBackupsOnClient:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).deleteBackupsOnClient.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),deleteEncryptedBackup:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).deleteEncryptedBackup.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),ebOptOut:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).ebOptOut.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),fetchBackupIds:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).fetchBackupIds.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),generateRecoveryCode:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).generateRecoveryCode.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),getEBState:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield u()).getEBState()});function t(){return e.apply(this,arguments)}return t})(),getLSVirtualDevices:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return(yield u()).getLSVirtualDevices(e)});function t(t){return e.apply(this,arguments)}return t})(),initializeBackup:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).initializeBackup.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),isEbEnabled:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).isEbEnabled.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),optOutOfBackup:function(){return(e||(e=n("Promise"))).resolve()},otcAddDevice:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).otcAddDevice.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),repairEpochs:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield u()).repairEpochs()});function t(){return e.apply(this,arguments)}return t})(),revokeVirtualDevice:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e;return(e=yield u()).revokeVirtualDevice.apply(e,arguments)});function t(){return e.apply(this,arguments)}return t})(),syncEpochs:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield u()).syncEpochs()});function t(){return e.apply(this,arguments)}return t})()},d=c;l.default=d}),98);
__d("RecoveryCodeDB",["MAWCurrentUser","MAWIndexedDbMetadata","MAWODSProxy","MessengerWebInitData","QPLFlow","WAHex","WALogger","WAOdsEnums","WAResolvable","Worm","WormEAR","WormIDbDriver","asyncToGeneratorRuntime","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={persisted_recovery_code:{indexes:{},primaryKey:"pk"}},c=1e4,d=new(o("WAResolvable")).Resolvable;function m(){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=o("MAWIndexedDbMetadata").ebRecoveryCodeDBName(o("MAWCurrentUser").getID()),n=o("WAHex").parseHex(r("MessengerWebInitData").accountKeyV2),a={log:function(t){return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RECOVERY_CODE_DB,key:t})}},i=r("qpl")._(1056840657,"2716"),l=o("QPLFlow").startQPLFlow(i,{annotations:{string:{dbType:"recovery_code_db",operationType:"initRecoveryCodeDB"}},timeoutInMs:c});try{var m="recovery_code_db",p=new(o("WormEAR")).WormEAR(u,m,n),_=new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(t,m,u,p,a,{onTransactionError:function(n){n instanceof o("WormEAR").DecryptionError&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error decrypting RecoveryCodeDB"])))},safeToDeleteStores:new Set(["migration"])}),i);yield _.init({eventFlow:l}),l.endSuccess(),d.resolve(_)}catch(e){throw l.endFail("error"),o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error initializing RecoveryCodeDB: ",""])),e),d.reject(e),e}}),p.apply(this,arguments)}function _(){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return d.resolveWasCalled()||(yield m()),d.promise}),f.apply(this,arguments)}l.schema=u,l.getOrCreateRecoveryCodeDB=_}),98);
__d("MWEBODSEntityKey.enum",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({START:"start",SUCCESS:"success",FAIL:"fail",INCORRECT_PIN_CODE:"incorrect_pin_code",INCORRECT_RECOVERY_CODE:"incorrect_recovery_code",TIMEOUT:"timeout",CANCEL:"cancel"}),l=e;i.default=l}),66);
__d("MWEncryptedBackupsFirstRestoreUpsellTime",["EBAPIWorkerCheck","FBLogger","WebStorage","getErrorSafe","getMWEncryptedBackupsIsLocalStorageSupported"],(function(t,n,r,o,a,i,l){"use strict";var e,s="mw_encrypted_backups_restore_upsell_first_impression_time_key";function u(){var t=Date.now().toString();if(o("EBAPIWorkerCheck").runningInWorker())return d(t);if(!o("getMWEncryptedBackupsIsLocalStorageSupported").getMWEncryptedBackupsIsLocalStorageSupported())return t;try{var n,a=(n=(e||(e=r("WebStorage"))).getLocalStorage())==null?void 0:n.getItem(s);if(a==null){var i;return(i=(e||(e=r("WebStorage"))).getLocalStorage())==null||i.setItem(s,t),t}return a}catch(e){return r("FBLogger")("wmi_eb").warn("[labyrinth][web] Failed to set EB session identifier due to %s",r("getErrorSafe")(e).message),t}}var c=null;function d(e){return c==null&&(c=e),c}l.getFirstRestoreUpsellTime=u,l.getFirstRestoreUpsellTimeForEBLS=d}),98);
__d("createReStoreTableNameAllowListPersistence",["Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r,o){var a;return{clearCache:function(){t.clearCache==null||t.clearCache(),r.clearCache==null||r.clearCache()},close:function(){t.close==null||t.close(),r.close==null||r.close()},flush:(function(){var a=n("asyncToGeneratorRuntime").asyncToGenerator(function*(a,i){var l=new Map,s=new Map;a.forEach(function(e,t){o.has(t)?s.set(t,e):l.set(t,e)}),yield(e||(e=n("Promise"))).all([t.flush(l,i),r.flush(s,i)])});function i(e,t){return a.apply(this,arguments)}return i})(),get:function(n,a,i,l){return o.has(a)?r.get(n,a,i,l):t.get(n,a,i,l)},isClosed:function(){return(t.isClosed==null?void 0:t.isClosed())||!1},isPersistenceSupported:t.isPersistenceSupported,logError:function(n,a,i,l){o.has(n)?r.logError==null||r.logError(n,a,i,l):t.logError==null||t.logError(n,a,i,l)},permitsSynchronousIO:function(n){if(o.has(n)){var e;return(e=r.permitsSynchronousIO==null?void 0:r.permitsSynchronousIO(n))!=null?e:!1}else{var a;return(a=t.permitsSynchronousIO==null?void 0:t.permitsSynchronousIO(n))!=null?a:!1}},runExclusively:function(a,i){return t.runExclusively(function(){return new(e||(e=n("Promise")))(function(t,o){var l=r.runExclusively(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var r=yield a(),o=r[0],i=r[1],s=new(e||(e=n("Promise")))(function(e){t([function(){return e(),l},i])});return[n("asyncToGeneratorRuntime").asyncToGenerator(function*(){return yield s,o()}),i]}),i);l.catch(o)})},i)},shouldApplySync:function(n,a){return o.has(a)?r.shouldApplySync(n,a):t.shouldApplySync(n,a)},shouldInline:function(n,a){return o.has(n)?r.shouldInline(n,a):t.shouldInline(n,a)},shouldSync:function(n,a){return o.has(a)?r.shouldSync(n,a):t.shouldSync(n,a)},tabTablesNotifier:(a=t.tabTablesNotifier)!=null?a:r.tabTablesNotifier,types:[].concat(t.types,r.types),uniqueId:r.uniqueId+t.uniqueId}}i.default=l}),66);
__d("MAWEBLSInWorkerSwitch",["MAWEBEnabledStateManager"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("MAWEBEnabledStateManager")).MAWEBEnabledStateManager,s=e;l.default=s}),98);
__d("LSIssueNewEbTaskAndGetTaskIDV2",["LSIssueNewTaskAndGetTaskID"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(o){return t.storedProcedure(n("LSIssueNewTaskAndGetTaskID"),e[0],e[1],e[2],void 0,void 0,t.i64.cast([0,0]),e[3],e[4],void 0,e[5],e[7]).then(function(e){var t;return t=e,r[0]=t[0],t})},function(e){return o[0]=r[0]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsIssueNewEbTaskAndGetTaskIDV2StoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSFetchBackupIds",["LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][LSEncryptedBackupsFetchBackupIdsStoredProcedure] Beginning execution."),r[11]=t.i64.cast([0,0]),r[7]=r[11],r[8]=new t.Map,r[8].set("backup_tenancy",e[0]),r[8].set("trace_id",void 0),r[9]=t.toJSON(r[8]),t.storedProcedure(n("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",t.i64.cast([0,50008]),r[9],t.i64.cast([0,0]),t.i64.cast([0,93]),t.i64.cast([0,0]),void 0,r[7]).then(function(e){var t;return t=e,r[10]=t[0],t})},function(e){return r[1]=t.i64.of_float(Date.now()),r[2]=t.i64.random(),r[4]="Finishing execution. Execution time: ",r[5]=t.i64.to_string(t.i64.sub(r[1],r[0])),r[6]=" ms",r[3]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][LSEncryptedBackupsFetchBackupIdsStoredProcedure] ",r[3],r[4],r[3],r[5],r[3],r[6]].join("")),t.i64.eq(t.i64.mod_(r[2],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[7]=",",r[8]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"LSEncryptedBackupsFetchBackupIdsStoredProcedure",[r[4],r[7],r[5],r[7],r[6]].join(""),r[8],t.i64.cast([0,4]))):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSEncryptedBackupsFetchBackupIdsStoredProcedure",e.__tables__=["encrypted_backups"],a.exports=e}),null);
__d("LSFetchBackupIdsStoredProcedure",["LSFetchBackupIds","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSFetchBackupIds"),a.backupTenancy,a.traceId,a.isUiBlocking);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("isInstamadilloEB",["qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("qex")._("670")===!0}l.default=e}),98);
__d("EBMessagePointQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="32643898351892811"}),null);
__d("EBMessagePointQuery.graphql",["EBMessagePointQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={defaultValue:null,kind:"LocalArgument",name:"app_id"},t={defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"},r={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},o={defaultValue:null,kind:"LocalArgument",name:"restore_type"},a=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],i={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},C={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},b={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},v={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},S={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},R={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},L={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},E=[l,s],k={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null};return{fragment:{argumentDefinitions:[e,t,r,o],kind:"Fragment",metadata:null,name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:[{kind:"Variable",name:"minos_gk_enabled",variableName:"minos_gk_enabled"}],kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[r,o,e,t],kind:"Operation",name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},i,l,s,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[u,i,l,s,c,d],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[u,i,l,s,c,d,m,p],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},c],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[_,f,g,h,y,C,b,v,S,R,L],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[_,f,y,g,h,m,p,C,b,v,S,R,L],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[k,{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[h,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},l,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],storageKey:null}],storageKey:null},k],storageKey:null}],storageKey:null}]},params:{id:n("EBMessagePointQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("EBMinosWasmDecryptAndVerifyMessage",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToDecryptedMessage(e.success.plaintext)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.cipherText,r=t.mekKey,a=t.messageEncryptionVersion,i=t.metadata,l=t.signature,s=t.transportSigningPK;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosDecryptAndVerifyMessageResultSpec,validateResult:e},{decryptAndVerifyMessage:{encryptedMessageCiphertext:n,encryptedMessageSignature:l,mek:r,messageEncryptionVersion:a,metadata:i,transportSigningPk:s}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptAndVerifyMessage=s}),98);
__d("EBMinosWasmDecryptMekForDistribution",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.encryptedMek,r=t.mailboxAuthPk,a=t.mailboxEncSk,i=t.mekEncryptionVersion,l=t.mekId,s=t.recipientEpochHead,u=t.rosterHash,c=t.senderEpochHead;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionResultSpec,validateResult:e},{decryptMekForDistribution:{ciphertext:n,fromPk:r,mekEncryptionVersion:i,mekId:l,rosterHash:u,senderEpochHead:c,toEpochHead:s,toMailboxSk:a}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptMekForDistribution=s}),98);
__d("EBMinosWasmDecryptMekForDistributionFromTransportSender",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekDistribution,r=t.mekEncryptionVersion,a=t.mekId,i=t.recipientEncSk,l=t.rosterHash;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionFromTransportSenderResultSpec,validateResult:e},{decryptMekForDistributionFromTransportSender:{mekDistribution:n,mekId:a,recipientEncSk:i,rosterHash:l,version:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.createMinosWasmDecryptMekForDistributionFromTransportSender=e,l.decryptMekForDistributionFromTransportSender=s}),98);
__d("EBMinosWasmDeriveMailboxAuthKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxAuthPrivateKey,n=e.mailboxAuthPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxAuthSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxAuthKeypairResultSpec,validateResult:e},{deriveMailboxAuthKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxAuthKeypair=s}),98);
__d("EBMinosWasmDeriveMailboxEncryptionKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxEncryptionPrivateKey,n=e.mailboxEncryptionPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxEncryptionPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxEncryptionSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxEncryptionKeypairResultSpec,validateResult:e},{deriveMailboxEncryptionKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxEncryptionKeypair=s}),98);
__d("EBMinosWasmEncryptAndSignMessage",["EBMinosClientConfig","EBMinosLogger","EBMinosMessageEncryptionVersion","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.signature,a=t.version,i=o("EBMinosMessageEncryptionVersion").MinosMessageEncryptionVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast message encryption version: ",""])),a),o("WAResultOrError").makeError("invalid-message-encryption-version")):o("WAResultOrError").makeResult({encryptedMsg:o("EBMinosTypes").unsafeCastToEncryptedMessage(n),signature:o("EBMinosTypes").unsafeCastToEncryptedMessageSignature(r),version:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mekKey,r=e.metadata,a=e.plaintext,i=e.transportSigningPK,l=e.transportSigningSK;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosEncryptAndSignMessageResultSpec,validateResult:t},{encryptAndSignMessage:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,metadata:r,plaintext:a,transportSigningPk:i,transportSigningSk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptAndSignMessage=u}),98);
__d("EBMinosWasmGenerateMekRosterHash",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.rosterHash;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekRosterHash(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekRosterHashResultSpec,validateResult:e},{generateMekRosterHash:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMekRosterHash=s}),98);
__d("EBMinosWasmWrapTransportSigningPublicKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningPK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPublicKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningPublicKeyResultSpec,validateResult:e},{wrapTransportSigningPublicKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningPublicKey=s}),98);
__d("EBMinosWasmWrapTransportSigningSecretKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningSK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPrivateKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningSecretKeyResultSpec,validateResult:e},{wrapTransportSigningSecretKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningSecretKey=s}),98);
__d("EBMinosWrapTransportSigningKeypair",["EBMinosLogger","EBMinosWasmWrapTransportSigningPublicKey","EBMinosWasmWrapTransportSigningSecretKey","WAByteArray","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.privateKey,r=t.publicKey,a=o("EBMinosWasmWrapTransportSigningPublicKey").wrapTransportSigningPublicKey({signalIdentityPublicKey:o("WAByteArray").uint8ArrayToBuffer(r)}),i=yield a,l=o("EBMinosWasmWrapTransportSigningSecretKey").wrapTransportSigningSecretKey({signalIdentityPrivateKey:o("WAByteArray").uint8ArrayToBuffer(n)}),u=yield l;if(!i.success)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing public key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");if(!u.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing secret key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");var c={pk:i.value,sk:u.value};return o("WAResultOrError").makeResult(c)}),c.apply(this,arguments)}l.wrapTransportSigningKeypair=u}),98);
__d("EBMinosWasmMinosThreadIdFromActThreadId",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromActThreadIdResultSpec,validateResult:e},{minosThreadIdFromActThreadId:{actThreadId:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromActThreadId=s}),98);
__d("EBMinosWasmMinosThreadIdFromOneToOneThread",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.selfFbid;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromOneToOneThreadResultSpec,validateResult:e},{minosThreadIdFromOneToOneThread:{actThreadId:n,selfFbid:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromOneToOneThread=s}),98);
__d("MpsThreadIdToMinosThreadId",["EBMinosLogger","EBMinosWasmMinosThreadIdFromActThreadId","EBMinosWasmMinosThreadIdFromOneToOneThread","Promise","WAJids","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,r){var a=o("WAJids").validateUserJid(t);if(a!=null){var i=o("WAJids").userIdFromJid(a);return o("EBMinosWasmMinosThreadIdFromOneToOneThread").minosThreadIdFromOneToOneThread({actThreadId:i,selfFbid:r}).then(function(t){return t.success?o("WAResultOrError").makeResult(t.value):(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId UserJid error: ",""])),t.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}var l=o("WAJids").validateGroupJid(t);if(l!=null){var c=o("WAJids").groupIdFromJid(l);return o("EBMinosWasmMinosThreadIdFromActThreadId").minosThreadIdFromActThreadId({actThreadId:c}).then(function(e){return e.success?o("WAResultOrError").makeResult(e.value):(o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId GroupJid error: ",""])),e.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}return(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("invalid-mps-thread-id"))}l.mpsThreadIdToMinosThreadId=c}),98);
__d("MpsThreadIdToWaThreadId",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("WAJids").validateUserJid(e);if(t!=null)return o("WAJids").userIdFromJid(t);var n=o("WAJids").validateGroupJid(e);return n!=null?o("WAJids").groupIdFromJid(n):null}l.mpsThreadIdToWaThreadId=e}),98);
__d("EBMinosCryptoLibrary",["Base64Utils","EBDecryptQplFlow","EBDeps","EBGenerateAndUploadMek","EBGetMinosAttachmentPayloadFromMpsMessage","EBMessageEncryptionKeyStorage","EBMessageEncryptionKeyStorageDecrypt","EBMinosCheckWasmFeatureSupport","EBMinosLogger","EBMinosMessageMetadataVersion","EBMinosProcessMessages","EBMinosTypes","EBMinosWasmDecryptAndVerifyMessage","EBMinosWasmDecryptMekForDistribution","EBMinosWasmDecryptMekForDistributionFromTransportSender","EBMinosWasmDeriveMailboxAuthKeypair","EBMinosWasmDeriveMailboxEncryptionKeypair","EBMinosWasmEncryptAndSignMessage","EBMinosWasmGenerateMekRosterHash","EBMinosWrapTransportSigningKeypair","MAWProtobufDeserializers","MpsThreadIdToMinosThreadId","MpsThreadIdToWaThreadId","MpsTypes","WAFrankingTypes","WAGetPlatformFromStanzaId","WAGlobals","WAResultOrError","WAStanzaUtils","asyncToGeneratorRuntime","err","gkx","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E;function k(e){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.io,a=t.loadMessageEncryptionKey,i=t.loadMessageEncryptionKeyForDecryption,l=t.loadMostRecentSelfMinosEpoch,s=t.loadSelfMinosEpochForDecryption,u=t.registerMinosMessageEncryptionKey,c=t.saveNewMessageEncryptionKey,d=e.logger,R=e.transportSigningKeypair,L=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK();d.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["gk minos_rollout_enabled: ",""])),L);var E=o("EBMessageEncryptionKeyStorage").createMessageEncryptionKeyStorage({io:{loadMessageEncryptionKey:a,saveNewMessageEncryptionKey:c},logger:d}),k=o("EBMessageEncryptionKeyStorageDecrypt").createMessageEncryptionKeyStorageDecrypt({io:{loadMessageEncryptionKeyForDecryption:i,saveNewMessageEncryptionKey:c},logger:d}),I=yield o("EBMinosWrapTransportSigningKeypair").wrapTransportSigningKeypair(R);if(I.success===!1)return o("WAResultOrError").makeError("transport-signing-keypair-error");var T=I.value,D=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.qplFlow,n=e.uploadEntity,a=n.deletionOfflineThreadingId,i=n.directive,s=n.isEphemeral,c=n.mailboxKeys,m=n.messageId,y=n.payload,C=n.senderId,b=n.supplementalOpToken,v=n.tags,S=n.threadId,R=n.timestampMs;t.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")}}),t.addPoint("generate_mek_roster_hash_start");var L=c.map(function(e){var t=e.epochHead;return t}),k=yield o("EBMinosWasmGenerateMekRosterHash").generateMekRosterHash({epochHeads:L});if(!k.success)return t.addPoint("generate_mek_roster_hash_fail"),o("WAResultOrError").makeError("generate-mek-roster-hash-error");var I=k.value;t.addPoint("generate_mek_roster_hash_end"),t.addPoint("get_or_generate_mek_start");var D=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(D==null)return d.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["selfFbid is invalid"]))),o("WAResultOrError").makeError("invalid-self-fbid");var x=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(S,D);if(!x.success)return d.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId error: ",""])),x.error),o("WAResultOrError").makeError("create-minos-thread-id-error");var P=x.value,N=yield M({actThreadId:r("nullthrows")(o("MpsThreadIdToWaThreadId").mpsThreadIdToWaThreadId(S),"invalid MPS threadId"),io:{loadMostRecentSelfMinosEpoch:l,registerMinosMessageEncryptionKey:u},logger:d,mailboxKeys:c,mekStorage:E,minosThreadId:P,msgUploadQpl:t,rosterHash:I,transportSigningKeypair:T});if(!N.success)return d.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["get or generate mek error: ",""])),N.error),t.addPoint("get_or_generate_mek_fail"),o("WAResultOrError").makeError("get-mek-error");t.addPoint("get_or_generate_mek_end",{string:{mekCacheStatus:N.value.cacheStatus}});var w=N.value.registeredMek,A=w.mek,F=w.mekFbid,O=o("EBMinosProcessMessages").createMessageTimestamp(R,o("EBMinosMessageMetadataVersion").MESSAGE_METADATA_CURRENT_VERSION,m);t.addPoint("encrypt_message_start");var B=yield o("EBMinosWasmEncryptAndSignMessage").encryptAndSignMessage({mekKey:A.key,metadata:{mekId:A.mekId,messageId:m,threadId:P,timestamp:O},plaintext:new Uint8Array(y),transportSigningPK:T.pk,transportSigningSK:T.sk});if(!B.success)return d.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["message encryption error: ",""])),B.error),t.addPoint("encrypt_message_fail"),o("WAResultOrError").makeError("encrypt-message-error");t.addAnnotations({int:{message_encryption_version:B.value.version}}),t.addPoint("encrypt_message_end");var W=yield o("EBGetMinosAttachmentPayloadFromMpsMessage").getMinosAttachmentPayloadFromMpsMessage({logger:d,message:{messageId:m,payload:y,senderId:C,threadId:S,timestampMs:R},qplFlow:t});d.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose([""," attchmentSecrets generated"])),W.length);var q=$(a,y),U=q.frankingTag,V=q.reportingTag;return o("WAResultOrError").makeResult({attachmentPayload:W,backupActionType:i.actionType,backupFbid:n.backupFbid,deletionOfflineThreadingId:a,encryptedMsg:B.value.encryptedMsg,encryptedMsgSignature:B.value.signature,frankingTag:U,isEphemeral:s,mekFbid:F,mekId:A.mekId,messageEncryptionVersion:B.value.version,messageTimestampMs:R,otid:m,reportingTag:V,supplementalOpToken:b,tags:v,toplevelOfflineThreadingId:o("MpsTypes").toMessageId(i.originalMsgProtocolId.externalId),transportSigningPK:T.pk,waThreadId:S})});return function(n){return e.apply(this,arguments)}})(),x=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.encryptedMessage,a=e.encryptedMsgSignature,i=e.entryPoint,l=e.mekCreatorInfo,u=e.mekFbid,c=e.mekInfo,m=e.messageEncryptionVersion,p=e.messageInfo,_=e.recipientInfo,f=e.source,g=e.threadId,h=e.transportSigningPK,R=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:i,isMinos:!0,source:f,threadId:g});R.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")},int:{mek_creation_time_sec:c.mekCreationTimestamp,mek_encryption_version:c.mekEncryptionVersion,message_encryption_version:m,metadata_version:o("EBMinosMessageMetadataVersion").MESSAGE_METADATA_CURRENT_VERSION},string:{mek_fbid:u,message_id:p.messageId,platform_type:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(o("WAStanzaUtils").toStanzaId(p.messageId)),sender_type:l.senderType}}),R.addPoint("load_self_minos_epoch_for_decryption_start");var L=yield s(_.epochFbId,c.mekEncryptionVersion);if(!L.success&&r("gkx")("269")&&L.error==="no-self-epoch-found"){d.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["no self epoch found - will try to sync epochs"]))),R.addPoint("sync_epochs_start");var E=yield o("EBDeps").getDeps().getEBSMAPI(),I=yield E.repairEpochs();I.success?(R.addPoint("sync_epochs_end"),L=yield s(_.epochFbId,c.mekEncryptionVersion)):(d.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["sync epochs error: ",""])),I.error),R.addAnnotations({string:{sync_epochs_error:I.error.message,sync_epochs_error_code:I.error.errorCode}}),R.addPoint("sync_epochs_fail"))}if(!L.success)return d.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["epoch decryption error for message ID ",": ",""])),p.messageId,L.error),R.endFailWithError("load_self_minos_epoch_for_decryption_fail",L.error),o("WAResultOrError").makeError(L.error);R.addPoint("load_self_minos_epoch_for_decryption_end"),R.addPoint("derive_mailbox_encryption_key_pair_start");var T=yield o("EBMinosWasmDeriveMailboxEncryptionKeypair").deriveMailboxEncryptionKeypair({epochNumber:_.epochAnonId,exportRootKey:L.value.exportRootKey});if(!T.success)return d.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["mailbox encryption key pair derivation error for message ID ",": ",""])),p.messageId,T.error),R.endFailWithError("derive_mailbox_encryption_key_pair_fail",T.error),o("WAResultOrError").makeError("derive-mailbox-keys-error");var D=T.value.sk;R.addPoint("derive_mailbox_encryption_key_pair_end"),R.addPoint("get_or_decrypt_message_encryption_key_start");var x=yield P({logger:d,mailboxEncryptionSK:D,mekCreatorInfo:l,mekFbid:u,mekInfo:c,mekStorageDecrypt:k,minosThreadId:p.threadId,qplFlow:R,recipientEpochHead:(t=_.epochHead)!=null?t:L.value.exportEpochHead,transportSigningPK:h});if(!x.success){var $;return R.endFailWithError(x.error.errorName,($=x.error.failReason)!=null?$:"decrypt-mek-error"),o("WAResultOrError").makeError("decrypt-mek-error")}R.addPoint("get_or_decrypt_mailbox_encryption_key_end",{string:{mekCacheStatus:x.value.cacheStatus}}),R.addPoint("decrypt_and_verify_message_start");var N=yield o("EBMinosWasmDecryptAndVerifyMessage").decryptAndVerifyMessage({cipherText:n,mekKey:x.value.mekKey,messageEncryptionVersion:m,metadata:{mekId:c.mekId,messageId:p.messageId,threadId:p.threadId,timestamp:p.timestamp},signature:a,transportSigningPK:h});if(!N.success){var M=N.error,w=M.errorName,A=M.failReason;return d.ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["message decryption error for message ID ",": ",""])),p.messageId,A!=null?A:w),R.endFailWithError("decrypt_and_verify_message_fail",w!=null?w:A),o("WAResultOrError").makeError("decrypt-message-error")}return R.addPoint("decrypt_and_verify_message_end"),R.endSuccess(),o("WAResultOrError").makeResult(N.value)});return function(n){return e.apply(this,arguments)}})();return o("WAResultOrError").makeResult({decryptMessage:x,encryptMessage:D})}),I.apply(this,arguments)}var T=null;function D(t){if(T!=null){o("EBMinosLogger").minosLogger.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is already set"])));return}o("EBMinosLogger").minosLogger.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is initialized"]))),T=t}function x(){if(T==null)throw o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is not set"]))),r("err")("Minos crypto library is not set");return T}function $(e,t){var n=null,r=null;if(e==null){var a,i,l=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),s=(a=l.proto.metadata)==null||(a=a.frankingMetadata)==null?void 0:a.frankingTag;s==null?o("EBMinosLogger").minosLogger.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["missing frankingTag in upload"]))):n=o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s));var u=(i=l.proto.metadata)==null||(i=i.frankingMetadata)==null?void 0:i.reportingTag;u==null?o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["missing reportingTag in upload"]))):r=o("WAFrankingTypes").castToReportingTag(new Uint8Array(u))}return{frankingTag:n,reportingTag:r}}function P(e){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mailboxEncryptionSK,a=e.mekCreatorInfo,i=e.mekFbid,l=e.mekInfo,s=e.mekStorageDecrypt,u=e.minosThreadId,c=e.qplFlow,d=e.recipientEpochHead,m=e.transportSigningPK;if(r("gkx")("7918")){var p=yield s.getMessageEncryptionKeyDecrypt({mekId:l.mekId});if(c.addAnnotations({bool:{mek_reuse:p!=null}}),p!=null)return o("WAResultOrError").makeResult({cacheStatus:p.cacheStatus,mekKey:p.registeredMek.mek.key})}c.addPoint("decrypt_mek_start");var _=a.senderType==="Transport"?yield o("EBMinosWasmDecryptMekForDistributionFromTransportSender").decryptMekForDistributionFromTransportSender({mekDistribution:{encryptedMek:l.encryptedMek,ephemeralEncryptionPk:a.transportSenderEphemeralPK,recipientEpochHead:d,signature:a.transportSenderEphemeralKeySig,signingPk:m},mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEncSk:n,rosterHash:l.mekRosterHash}):yield o("EBMinosWasmDecryptMekForDistribution").decryptMekForDistribution({encryptedMek:l.encryptedMek,mailboxAuthPk:a.senderMailboxAuthPK,mailboxEncSk:n,mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEpochHead:d,rosterHash:l.mekRosterHash,senderEpochHead:a.senderEpochHead});if(c.addPoint("decrypt_mek_end"),!_.success)return t.ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["mek decryption error: ",""])),_.error),_;if(r("gkx")("7918")&&a.senderType!=="Transport"){var f={key:_.value,mekId:l.mekId,rosterHash:l.mekRosterHash},g={mek:f,mekFbid:i};yield s.setNewMessageEncryptionKeyDecrypt({createdBySelf:!1,lastUsedTsMs:o("MpsTypes").toTimestamp(Date.now()),minosThreadId:u,registeredMek:g})}return o("WAResultOrError").makeResult({cacheStatus:"new",mekKey:_.value})}),N.apply(this,arguments)}function M(e){return w.apply(this,arguments)}function w(){return w=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.actThreadId,r=e.io,a=e.logger,i=e.mailboxKeys,l=e.mekStorage,s=e.minosThreadId,u=e.msgUploadQpl,c=e.rosterHash,d=e.transportSigningKeypair,m=yield r.loadMostRecentSelfMinosEpoch().then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e==null)return o("WAResultOrError").makeError("unable-to-get-latest-epoch");var t=yield o("EBMinosWasmDeriveMailboxAuthKeypair").deriveMailboxAuthKeypair({epochNumber:e.epochNumber,exportRootKey:e.exportRootKey});return t.success?(u.addAnnotations({string:{epoch_fbid:e.epochFbId,epoch_head:o("Base64Utils").fromArrayBuffer(e.epochHead)}}),o("WAResultOrError").makeResult({epochFbId:e.epochFbId,epochHead:e.epochHead,mailboxAuthKeyPair:t.value})):(a.ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["Unable to get mailbox auth key pair for sender - failed with exception ",""])),t.error),o("WAResultOrError").makeError("unable-to-get-sender-mailbox-auth-key-pair"))});return function(t){return e.apply(this,arguments)}})()),p=m.success?{fromKeypair:m.value.mailboxAuthKeyPair,senderEpochFbId:m.value.epochFbId,senderEpochHead:m.value.epochHead,senderType:"Minos"}:{senderType:"Transport",transportSigningKp:d};if(p.senderType!=="Transport"){var _=yield l.getMessageEncryptionKey({mekCreatorEpochHead:p.senderEpochHead,minosThreadId:s,rosterHash:c});if(_!=null)return o("WAResultOrError").makeResult(_)}var f=yield o("EBGenerateAndUploadMek").generateAndUploadMek({actThreadId:t,io:{registerMinosMessageEncryptionKey:r.registerMinosMessageEncryptionKey},logger:a,msgUploadQpl:u,participantMailboxes:i,sender:p});if(!f.success)return a.ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["mek register error: ",""])),f.error),o("WAResultOrError").makeError("register-mek-error");var g={mek:f.value.mek,mekFbid:f.value.mekFbid};return p.senderType!=="Transport"&&(yield l.setNewMessageEncryptionKey({createdBySelf:!0,lastUsedTsMs:o("MpsTypes").toTimestamp(Date.now()),mekCreatorEpochHead:p.senderEpochHead,minosThreadId:s,registeredMek:g,rosterHash:c})),o("WAResultOrError").makeResult({cacheStatus:"new",registeredMek:g})}),w.apply(this,arguments)}l.createMinosCryptoLibrary=k,l.setMinosCryptoLibrary=D,l.getMinosCryptoLibrary=x}),98);
__d("EBMinosSaveNewMinosMessageEpochHead",["EBMinosDb","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield o("EBMinosDb").getEBMinosDb();yield r.runInTransaction(["secure_minos_message_epoch_heads"],"readwrite",function(r){return r.stores.secure_minos_message_epoch_heads.bulkPut([{epoch_head:e,message_id:t,thread_id:n}])},"SaveNewMinosMessageEpochHead")});return function(n,r,o){return e.apply(this,arguments)}})();l.saveNewMinosMessageEpochHead=e}),98);
__d("EBMinosDecryptMessages",["EBMinosCryptoLibrary","EBMinosLogger","EBMinosProcessMessages","EBMinosSaveNewMinosMessageEpochHead","EBMinosTypes","MpsThreadIdToMinosThreadId","MpsTypes","Promise","WAGlobals","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){var t=e.keys.mekCreatorInfo.minosKeys,n=e.keys.mekCreatorInfo.transportKeys;return t!=null?{senderEpochHead:t.senderEpochHead,senderMailboxAuthPK:t.senderAuthPk,senderType:"Minos"}:n?{senderType:"Transport",transportSenderEphemeralKeySig:n.ephmSignature,transportSenderEphemeralPK:n.ephmHpkePk}:null}function d(e,t,n,r,o,a,i){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l,s){var u=r.get(a.mekFbid);if(u==null)return o("WAResultOrError").makeError("missing-encrypted-mek");var d=c(u);if(d==null)return o("WAResultOrError").makeError("missing-mek-creator-info");var m=o("EBMinosProcessMessages").createMessageTimestamp(a.protobufTimestamp,a.messageMetadataVersion,n),p=yield o("EBMinosCryptoLibrary").getMinosCryptoLibrary().decryptMessage({encryptedMessage:a.encryptedProtobuf,encryptedMsgSignature:a.transportSenderMessageSignature,entryPoint:s,mekCreatorInfo:d,mekFbid:a.mekFbid,mekInfo:u.keys.mekInfo,messageEncryptionVersion:a.messageEncryptionVersion,messageInfo:{messageId:n,threadId:t,timestamp:m},recipientInfo:u.keys.recipientInfo,source:l,threadId:i,transportSigningPK:a.transportSenderSigningPk});if(!p.success)return o("WAResultOrError").makeError(p.error);var _={decryptedProtobuf:p.value,decryptedSupplementalKey:null,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(a.protobufTimestamp)};return d.senderType==="Minos"&&(yield o("EBMinosSaveNewMinosMessageEpochHead").saveNewMinosMessageEpochHead(d.senderEpochHead,n,i).catch(function(t){return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["saveNewMinosMessageEpochHead failed with error: ",""])),t),o("WAResultOrError").makeError("failed-to-save-epoch-head")})),o("WAResultOrError").makeResult(_)}),m.apply(this,arguments)}function p(e,t,n,r,o,a,i){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var u=n.supplementalOtid,d=t.get(n.mekFbid);if(d==null)return o("WAResultOrError").makeError("missing-encrypted-mek");var m=c(d);if(m==null)return o("WAResultOrError").makeError("missing-mek-creator-info");if(u==null)return o("WAResultOrError").makeError("missing-supplemental-otid");var p=o("MpsTypes").toMessageId(u),_=yield o("EBMinosCryptoLibrary").getMinosCryptoLibrary().decryptMessage({encryptedMessage:n.encryptedProtobuf,encryptedMsgSignature:n.transportSenderMessageSignature,entryPoint:l,mekCreatorInfo:m,mekFbid:n.mekFbid,mekInfo:d.keys.mekInfo,messageEncryptionVersion:n.messageEncryptionVersion,messageInfo:{messageId:p,threadId:e,timestamp:n.protobufTimestamp},recipientInfo:d.keys.recipientInfo,source:i,threadId:a,transportSigningPK:n.transportSenderSigningPk});if(!_.success)return o("WAResultOrError").makeError(_.error);var f={decryptedProtobuf:_.value,decryptedSupplementalKey:r,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(n.protobufTimestamp)};return m.senderType==="Minos"&&(yield o("EBMinosSaveNewMinosMessageEpochHead").saveNewMinosMessageEpochHead(m.senderEpochHead,p,a).catch(function(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["saveNewMinosMessageEpochHead failed with error: ",""])),e),o("WAResultOrError").makeError("save-epoch-head-error")})),o("WAResultOrError").makeResult(f)}),_.apply(this,arguments)}function f(e,t,n,r,o){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=new Map,s=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(s==null)return o("WAResultOrError").makeError("invalid-self-fbid");var c=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(e,s);if(!c.success)return o("WAResultOrError").makeError("create-minos-thread-id-error");var m=[];return yield(u||(u=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(r){var s=r.messageTags,_=r.otid,f=r.supplementalProtobufsV2,g=r.topLevelProtobufV2,h=yield d(c.value,_,t,g,e,a,i);if(!h.success)return m.push("failed_to_decrypt_top_level_protobuf_"+h.error);var y=new Map;f!=null&&(yield(u||(u=n("Promise"))).all(f.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.supplementalKey;if(r!=null){var l=yield p(c.value,t,n,r,e,a,i);if(l.success)y.set(o("MpsTypes").toSupplementalKey(r),l.value);else return m.push("failed_to_decrypt_supplemental_level_protobuf_"+l.error)}});return function(e){return r.apply(this,arguments)}})()))),l.set(_,{messageTags:s,otid:_,supplementalProtobufs:y,topLevelProtobuf:h.value})});return function(e){return r.apply(this,arguments)}})())),o("WAResultOrError").makeResult({decryptionResult:l,errorMessages:m})}),g.apply(this,arguments)}l.minosDecryptMessages=f}),98);
__d("EBValidateMinosMessages",["EBMinosLogger","EBMinosProcessMessages","EBMinosTypes","MAWProtobufDeserializers","MpsTypes","Promise","WAArmadilloXMA.pb","WACryptoUtils","WAFranking","WAFrankingTypes","WAGlobals","WALongInt","WAResultOrError","asyncToGeneratorRuntime","getErrorSafe","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n,r){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i){var l=yield(c||(c=n("Promise"))).all(e.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.otid,i=e.topLevelProtobufV2.protobufTimestamp,l=e.topLevelProtobufV2.actorToken,c=t.get(n);if(c==null)return t.delete(n),"message-id-not-found";var d=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(c.topLevelProtobuf.decryptedProtobuf);if(d==null)return t.delete(n),"failed-to-deserialize-decrypted-protobuf";var m=d.proto.metadata;if(m==null)return t.delete(n),"protobuf-message-metadata-null";var g=m.timestampMs;if(g==null)return t.delete(n),"minos-protobuf-timestamps-mismatch";try{var h=o("WALongInt").numberOrThrowIfTooLarge(g);if(o("MpsTypes").toTimestamp(h)!==i)return t.delete(n),"minos-protobuf-timestamps-mismatch"}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["timestamp-convert-error-",""])),r("getErrorSafe")(e).message),t.delete(n),"timestamp-covert-error"}if(m.senderId==null||o("EBMinosTypes").unsafeCastToUserFbId(m.senderId)!==l)return t.delete(n),"sender-id-actor-token-mismatch";var y=d.payload();if(y==null)return t.delete(n),"protobuf-message-payload-null";if(p(d,l))return t.delete(n),"peer-only-protobuf-message-validation-failure";if(_(d))return t.delete(n),"calling-xma-protobuf-message-validation-failure";var C=yield f(d,a);if(!C.success)return t.delete(n),o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["act sanitizer validation failed: ",""])),C.error),"act_sanitizer_validation_failed";if(y.kind==="messageApplication"){var b,v,S,R,L=y.consumerMessage(),E=L==null||(b=L.payload)==null||(b=b.applicationData)==null?void 0:b.revoke;if(E!=null)return;var k=(v=y.proto.metadata)==null?void 0:v.frankingKey,I=y.bytes,T=e.topLevelProtobufV2.frankingTag,D=(S=y.proto.metadata)==null?void 0:S.frankingVersion;if(k==null)return t.delete(n),"franking-key-null";if(T==null)return r("gkx")("704")&&t.delete(n),"franking-tag-null";var x=yield o("WAFranking").validateFrankingTag(new Uint8Array(I),o("WAFrankingTypes").castToFrankingKey(new Uint8Array(k)),o("WAFrankingTypes").castToFrankingTag(new Uint8Array(T)),D);if(x===!1)return r("gkx")("704")&&t.delete(n),"franking-tag-validation-failed";var $=e.topLevelProtobufV2.reportingTag,P=(R=m.frankingMetadata)==null?void 0:R.reportingTag;if($==null||P==null)return r("gkx")("704")&&t.delete(n),"reporting-tag-null";if(!o("WACryptoUtils").arrayBuffersEqual($.buffer,P))return r("gkx")("704")&&t.delete(n),"reporting-tag-mismatch";var N=m.clientTimestampMs;if(N!=null?N=o("WALongInt").numberOrThrowIfTooLarge(N):N=o("EBMinosProcessMessages").extractTimestampFromOtid(n),Math.abs(N-i)>36e5)return t.delete(n),"client_server_timestamp_delta_over_1_hour"}});return function(t){return e.apply(this,arguments)}})())),d=l.filter(Boolean);return i.addAnnotations({bool:{minos_validation_success:d.length===0},string_array:{minos_validation_errors:d}}),t}),m.apply(this,arguments)}function p(t,n){var r,a=(r=t.encryptedTransportMessage())==null||(r=r.armadillo())==null||(r=r.payload)==null||(r=r.applicationData)==null||(r=r.metadataSync)==null?void 0:r.actions;if(a==null)return!1;var i=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(i==null)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed-to-get-userFbid"]))),!0;for(var l of a!=null?a:[])if((l.attachmentInterventionAction!=null||l.chatAction!=null||l.messageAction!=null||l.spectraAction!=null)&&i!==n)return!0;return!1}function _(e){var t,n=(t=e.encryptedTransportMessage())==null||(t=t.armadillo())==null||(t=t.extendedContentMessage())==null||(t=t.payload)==null?void 0:t.targetType;return!r("gkx")("5782")||n==null?!1:n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_GROUP_VIDEO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_ONGOING_AUDIO_CALL||n===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_ONGOING_VIDEO_CALL}function f(e,t){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n,r=(n=e.encryptedTransportMessage())==null||(n=n.armadillo())==null||(n=n.payload)==null||(n=n.content)==null?void 0:n.extendedContentMessage;if(r==null)return o("WAResultOrError").makeResult();var a=yield t(r);return a}),g.apply(this,arguments)}l.validateMinosMessages=d}),98);
__d("EBMinosDecryptAndValidateMessages",["Base64Utils","EBMinosDecryptMessages","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBValidateMinosMessages","MpsTypes","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t){if(t==null)return null;var n=t.id,r=t.keys;if(n==null||r==null)return null;var a=o("EBMinosTypes").unsafeCastToMekFbId(n),i=r.mek_creator_info,l=r.mek_info,s=r.recipient_info;if(l==null||i==null||s==null)return null;var u=l.encrypted_mek,c=l.mek_creation_timestamp,d=l.mek_encryption_version,m=l.mek_id,p=l.roster_hash;if(u==null||d==null||m==null||p==null||c==null)return null;var _=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(d);if(_==null)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast mek encryption version: ",""])),d),null;var f={encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(o("Base64Utils").toArrayBuffer(u)),mekCreationTimestamp:o("MpsTypes").toTimestamp(parseInt(c,10)),mekEncryptionVersion:_,mekId:o("EBMinosTypes").unsafeCastToMekId(o("Base64Utils").toArrayBuffer(m)),mekRosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(o("Base64Utils").toArrayBuffer(p))},g=s.epoch_anon_id,h=s.epoch_fbid,y=s.epoch_head;if(g==null||h==null||y==null)return null;var C={epochAnonId:o("EBMinosTypes").unsafeCastToEpochNumber(o("WALongInt").decimalStringToLongInt(new TextDecoder().decode(o("Base64Utils").toArrayBuffer(g)))),epochFbId:o("EBMinosTypes").unsafeCastToEpochFbId(h),epochHead:o("EBMinosTypes").unsafeCastToEpochHead(o("Base64Utils").toArrayBuffer(y))},b=i.minos_keys,v=i.transport_keys;if(b==null&&v==null)return null;var S=b!=null?b:{},R=S.sender_auth_pk,L=S.sender_epoch_head,E=R!=null&&L!=null?{senderAuthPk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(o("Base64Utils").toArrayBuffer(R)),senderEpochHead:o("EBMinosTypes").unsafeCastToEpochHead(o("Base64Utils").toArrayBuffer(L))}:null,k=v!=null?v:{},I=k.ephm_hpke_pk,T=k.ephm_signature,D=k.mek_creator_transport_signing_pk,x=I!=null&&T!=null&&D!=null?{ephmHpkePk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(o("Base64Utils").toArrayBuffer(I)),ephmSignature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(o("Base64Utils").toArrayBuffer(T)),mekCreatorTransportSigningPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(o("Base64Utils").toArrayBuffer(D))}:null;return E==null&&x==null?null:{id:a,keys:{mekCreatorInfo:{minosKeys:E,transportKeys:x},mekInfo:f,recipientInfo:C}}}function p(e){var t=new Map((e!=null?e:[]).map(function(e){return e.id==null?null:[o("EBMinosTypes").unsafeCastToMekFbId(e.id),m(e)]}).filter(Boolean));return t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.encryptedMinosMessages,n=e.entryPoint,r=e.minosDecryptionKeys,a=e.qplFlow,i=e.source,l=e.threadId,m=e.validator;if(t.length===0)return o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]});try{var _=p(r),f=yield o("EBMinosDecryptMessages").minosDecryptMessages(l,_,t,i,n);if(!f.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["decrypt msgs failed: "," }"])),f.error),f;if(o("EBMinosLogger").minosLogger.DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["decrypt msgs completed. total: ",", success: ",", failed: ",""])),t.length,f.value.decryptionResult.size,f.value.errorMessages.length),f.value.decryptionResult.size===0)return f;var g=yield o("EBValidateMinosMessages").validateMinosMessages(t,f.value.decryptionResult,m,a);return o("EBMinosLogger").minosLogger.DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["validate msgs completed. total: ",", success: ",""])),t.length,g.size),o("WAResultOrError").makeResult({decryptionResult:g,errorMessages:f.value.errorMessages})}catch(e){return o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to decrypt messages: ",""])),e),o("WAResultOrError").makeError("runtime-error")}}),f.apply(this,arguments)}l.minosDecryptAndValidateMessages=_}),98);
__d("EBgenerateMPSMessageQuery",["EBGraphQLRestoreDefinition","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return{__typename:"MPSMessageQuery",ctx:{__typename:"MPSQueryContext",caller:o("MSGDataclassTypes.flow").MpsQueryCaller.HistoryRestore},query:{__typename:"MPSMessagePointQuery",include_deleted:!1,otids:t,thread_id:e}}}function s(t,n){return o("EBGraphQLRestoreDefinition").toMpsMessageQueryForGraphQLQuery(JSON.stringify(e(t,n)))}l.generateMPSMessageQuery=e,l.generateMPSMessageQueryForGraphQLQuery=s}),98);
__d("WAMsgIdToMessageKey",["WAGlobals","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.chat,r=e.externalId,a=o("WAJids").isAuthorMe(t),i=o("WAJids").interpretAsGroupJid(n),l=a?o("WAGlobals").getMyUserJid():t,s=n,u=i!=null?l:void 0;return{fromMe:a,id:r,remoteJid:s,participant:u}}l.msgIdToMessageKey=e}),98);
__d("WAAsConsumerApplication",["WAAssertUnreachable","WAConsumerApplication.pb","WAMsgIdToMessageKey","WAMsgType","err"],(function(t,n,r,o,a,i,l){"use strict";var e="image/jpeg",s="video/mp4",u="audio/wav",c="image/gif",d="image/webp";function m(e){switch(e.type){case o("WAMsgType").MSG_TYPE.TEXT:return p(e);case o("WAMsgType").MSG_TYPE.REACTION:return _(e);case o("WAMsgType").MSG_TYPE.REVOKED:return f(e);default:return r("WAAssertUnreachable")(e.type)}}function p(e){var t={payload:{content:{messageText:{mentionedJid:[],text:e.msgContent.content}}}};if(e.specialTextSize!=null){var n=e.specialTextSize===1?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:e.specialTextSize===2?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;t.metadata={specialTextSize:n}}return t}function _(e){if(e.reactToMsgId==null)throw r("err")("cannot send reaction that reacts to no message");var t=o("WAMsgIdToMessageKey").msgIdToMessageKey(e.reactToMsgId),n={groupingKey:e.groupingKey==null?void 0:e.groupingKey,key:t,senderTimestampMs:e.ts,text:e.reaction==null?void 0:e.reaction};return{payload:{content:{reactionMessage:n}}}}function f(e){var t={remoteJid:e.id.chat,fromMe:!0,id:e.revokedExternalId};return{payload:{applicationData:{revoke:{key:t}}}}}l.IMAGE_MIME_TYPE=e,l.VIDEO_MIME_TYPE=s,l.AUDIO_MIME_TYPE=u,l.GIF_MIME_TYPE=c,l.STICKER_MIME_TYPE=d,l.asConsumerApplication=m,l.encodeTextMessage=p,l.encodeReactionMessage=_}),98);
__d("MAWDexie",["cr:10766"],(function(t,n,r,o,a,i,l){"use strict";i.exports=n("cr:10766")}),34);
__d("MAWDexieTable",["MAWDexie","Promise","asyncToGeneratorRuntime","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=n("Promise"))).resolve(t)}function u(e){return e.reduce(function(e,t,n){return e.then(function(e){return t(n).then(function(t){return e.push(t),e})})},g([]))}function c(e){return r("MAWDexie").Promise.all(e)}function d(e){return r("MAWDexie").Promise.allSettled(e)}function m(e){return r("MAWDexie").Promise.PSD[e]}function p(e,t){r("MAWDexie").Promise.PSD[e]=t}function _(e){r("MAWDexie").Promise.PSD[e]=void 0}var f=(function(){function e(e,t,n,o){n===void 0&&(n=!0);var a=new(r("MAWDexie"))(e,babelHelpers.extends({},o,{chromeTransactionDurability:"relaxed",modifyChunkSize:r("justknobx")._("3166")}));t(a),this.name=e,this.stores=a,n&&this.open()}var t=e.prototype;return t.open=function(){this.stores.open()},t.close=function(){this.stores.close()},t.transact=function(t,r,o){var e=this;return s(this.stores.transaction(t,r.map(function(t){return e.stores[t]}),n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield o();return e})))},babelHelpers.createClass(e,[{key:"tables",get:function(){return this.stores.tables}}])})();function g(e){return r("MAWDexie").Promise.resolve(e)}l.DEXIE_MIN_KEY=o("MAWDexie").Dexie.minKey,l.DEXIE_MAX_KEY=o("MAWDexie").Dexie.maxKey,l.undexify=s,l.dexieSequentialAll=u,l.dexieAll=c,l.dexieAllSettled=d,l.getDexiePSDItem=m,l.setDexiePSDItem=p,l.clearDexiePSDItem=_,l.DexieTable=f,l.dexieResolve=g}),98);
__d("MAWDbParticipant",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e+"_"+t}i.craftParticipantId=e}),66);
__d("MAWDbThread",["MAWHexUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("MAWHexUtils").orderPreservingHex(e)+"_"+t}l.craftThreadOrder=e}),98);
__d("MAWDbSchema.dexie",["FBLogger","MAWDbMsg","MAWDbParticipant","MAWDbThread","MAWDbVersionList","MAWDexie","MAWDexieTable","MAWFolderTypes","MAWLocalizationType","MAWODSProxy","MAWTimeUtils","WAJids","WALogger","WAMsg","WAMsgType","WAOdsEnums","WAStanzaUtils","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(t){var e=function(t){var e,n=(e=t.quote)==null?void 0:e.content;return t.quoteExternalId!=null&&(n==null?void 0:n.media)!=null};return t.messages.where("quoteExternalId").between(o("WAStanzaUtils").toStanzaId("0"),o("WAStanzaUtils").toStanzaId("["),!0,!0).filter(e).toArray().catch(function(){return t.messages.filter(e).toArray()}).then(function(e){var n=new Set(e.map(function(e){var t,n,r=(t=e.quote)==null?void 0:t.content;return r==null||(n=r.media)==null?void 0:n.plaintextHash}).filter(Boolean)),r=e.map(function(e){var t=e.msgId;return t});return t.media.filter(function(e){var t=e.plaintextHash;return n.has(t)}).toArray().then(function(e){var n=new Map(e.map(function(e){var t=e.mediaId,n=e.plaintextHash;return[n,t]}));return t.messages.where("msgId").anyOf(r).modify(function(e){var t=e.quote;if(t!=null&&t.content!=null){var r=t.content;r.mediaId=n.get(r.media.plaintextHash),delete r.media}})})})},c=function(t){return t.groupInfo.toCollection().modify(function(e){typeof e.inviter=="number"&&delete e.inviter})},d=function(){return o("MAWDexieTable").dexieResolve()},m=function(t){return t.threads.filter(function(e){return o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(){return!1},user:function(){return e.oldestMsg!=null}})}).toArray().then(function(e){var n=[];return e.forEach(function(e){n.push(e.oldestMsg),n.push(o("MAWDbMsg").toMsgId__UNSAFE_DO_NOT_USE(e.newestMsg))}),t.messages.where("msgId").anyOf(n.filter(Boolean)).toArray().then(function(n){var r=new Map,a=[],i=[];n.forEach(function(e){r.set(e.msgId,e)}),e.forEach(function(e){var n=r.get(e.oldestMsg),l=r.get(e.newestMsg);return(n==null?void 0:n.type)==="Admin"&&(l==null?void 0:l.type)==="Admin"&&(n.msgId===l.msgId?i.push(e.chatId):a.push(e)),o("MAWDexieTable").dexieAll(a.map(function(e){return t.messages.where("thread").equals(e.chatId).toArray()})).then(function(e){return e.forEach(function(e){if(e.length!==0){var t=e[0].thread,n=e.filter(function(e){return e.type!=="Admin"});n.length>0||i.push(t)}}),o("MAWDexieTable").dexieAll([t.threads.bulkDelete(i),t.messages.where("thread").anyOf(i).delete()])})})})})},p=function(t){return t.unrenderedMessages.toCollection().modify(function(e){if(e.type===o("WAMsgType").MSG_TYPE.DELETE_FOR_ME){var t=e.messageDeleteForMeTs;e.messageDeleteForMeTs=t}})},_=function(t){var e=0,n=0,a=r("MAWDexie").currentTransaction;if(a==null)throw r("FBLogger")("maw_db").mustfixThrow("transaction does not exist");return a.on("complete",function(){e>0&&o("MAWODSProxy").odsBumpEntityKey({amount:e,entity:o("WAOdsEnums").Entity.MESSAGE_MISSING_THREAD_JID,key:"fail"}),n>0&&o("MAWODSProxy").odsBumpEntityKey({amount:n,entity:o("WAOdsEnums").Entity.MESSAGE_MISSING,key:"fail"})}),t.threads.toArray().then(function(r){var a=r.reduce(function(e,t){return t!=null&&e.set(t.chatId,t),e},new Map);return o("MAWDexieTable").dexieAll([t.messages.toCollection().modify(function(t){if(t!=null){var r=a.get(t.thread);r!=null?t.threadJid=r.jid:e+=1}else n+=1}),t.unrenderedMessages.toCollection().modify(function(t){if(t!=null){var r=a.get(t.thread);r!=null?t.threadJid=r.jid:e+=1}else n+=1})])})},f=function(t){return t.isDualSend.toCollection().modify(function(e){e.version==null&&(e.version=1)})},g=function(t){return t.messages.toCollection().modify(function(e){e.type===o("WAMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION&&(e.altIndex=o("MAWDbMsg").craftE2eeAdminMsgAltIndex(e.thread))})},h=function(t){return t.messages.toCollection().modify(function(e){e.sortOrderMs=o("MAWDbMsg").getSortOrderWithFallback(e)})},y=function(t){return t.threads.toCollection().modify(function(e){e.folder==null&&(e.folder=o("MAWFolderTypes").FOLDER_ID.INBOX)})},C=function(t){return t.messages.toCollection().modify(function(e){e.sortOrderMs=o("MAWDbMsg").getSortOrderWithFallback(e)})},b=function(t){return t.personalSenderKeyStatuses.toCollection().modify(function(e){e.rotateSenderKey=!0,e.hasSenderKey=new Set})},v=function(t){return t.messages.toCollection().modify(function(e){e.type===o("WAMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE&&e.sortOrderMs!=null&&e.sortOrderMs>0&&(e.sortOrderMs=0)})},S=function(t){return t.messages.toCollection().modify(function(e){!(e.type===o("WAMsgType").MSG_TYPE.ADMIN&&(e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE||e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION))&&e.sortOrderMs!=null&&e.sortOrderMs<1661204086&&(e.sortOrderMs=o("MAWDbMsg").getCanonicalTsFromMsg(e)*1e3)})},R=function(t){return t.threads.filter(function(e){return e.isMigratedLocally===!0&&e.newestMsg!=null}).toArray().then(function(e){var n=e.map(function(e){return e.chatId}),r=new Map;return o("MAWDexieTable").dexieAll(e.map(function(e){return t.messages.where(["thread","sortOrderMs"]).between([e.chatId,0],[e.chatId,Number.MAX_VALUE]).last().then(function(e){e!=null&&r.set(e.thread,e.msgId)})})).then(function(){return t.threads.where("chatId").anyOf(n)})})},L=function(){return o("MAWDexieTable").dexieResolve()},E=function(t){return t.threads.toCollection().modify(function(e){if(e.lastReadMsgTs!=null&&e.lastReadMsgTs<o("WATimeUtils").MAX_INT&&(e.lastReadMsgTs=o("MAWTimeUtils").ensureValidMillisTime(e.lastReadMsgTs)),e.newestMsgTs!=null&&e.newestMsgTs<o("WATimeUtils").MAX_INT){var t=o("MAWTimeUtils").ensureValidMillisTime(e.newestMsgTs);e.newestMsgTs=t,t!=null&&(e.threadOrder=o("MAWDbThread").craftThreadOrder(t,e.jid))}})},k=function(t){return t.messages.toCollection().modify(function(e){e.type===o("WAMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_THREAD_ADMIN_MESSAGE&&(e.altIndex=o("MAWDbMsg").craftCutoverAdminMsgAltIndex(e.thread))})},I=function(){return o("MAWDexieTable").dexieResolve()},T=function(){return o("MAWDexieTable").dexieResolve()},D=function(){return o("MAWDexieTable").dexieResolve()},x=function(t){return t.participants.toCollection().modify(function(e){var t;e==null||!((t=e.userJid)!=null&&t.includes("@msgr@msgr"))||(e.id=e.id.replace("@msgr@msgr","@msgr"),e.userJid=e.userJid.replace("@msgr@msgr","@msgr"))}).then(r("emptyFunction"))},$=function(t){var e=t.threads.filter(function(e){return e.snippetMsg!=null&&e.snippetMsgTs==null});return e.toArray().then(function(n){var r=n.reduce(function(e,t){return t!=null&&t.snippetMsg!=null&&e.set(t.jid,t.snippetMsg),e},new Map),a=Array.from(r.values());return t.messages.where("msgId").anyOf(a).toArray().then(function(t){var n=t.reduce(function(e,t){return t!=null&&t.serverTs!=null&&e.set(t.msgId,t.serverTs),e},new Map);e.modify(function(e){var t=r.get(e.jid);if(t!=null){var a=n.get(t);a!=null&&(e.snippetMsgTs=o("WATimeUtils").castUnixTimeToMillisTime(a))}})})})},P=function(t){return t.threads.toArray().then(function(e){return o("MAWDexieTable").dexieAll(e.map(function(e){return t.participants.where("threadId").equals(e.chatId).modify(function(t){var n;t.threadJid=(n=t.threadJid)!=null?n:e.jid})}))})},N=P,M=function(t){var e=[];return t.groupInvites.toArray().then(function(n){var r=n.map(function(e){return e.invitedParticipantId});return t.participants.bulkGet(r).then(function(r){r.forEach(function(t,r){if(t==null){var o=n[r];e.push(o)}});var o=r.filter(Boolean);return t.groupInvites.bulkPut(n.map(function(t){var n=o.find(function(e){return e.id===t.invitedParticipantId});return n!=null?(t.inviteeJid=n.userJid,t.threadJid=n.threadJid,babelHelpers.extends({},t,{inviteeJid:n.userJid,threadJid:n.threadJid})):(e.push(t),t)}))})}).then(function(){return t.groupInvites.bulkDelete(e.map(function(e){return[e.invitedParticipantId,e.inviterJid]}))})},w=function(n){var t=new Map;return n.receipts.toArray().then(function(a){return o("MAWDexieTable").dexieAll(a.map(function(a){return n.messages.get({msgId:a.msgId}).then(function(i){if(i==null)return n.receipts.delete(a.msgId).then(r("emptyFunction"));var l=o("WAMsg").craftWAMsgIdString({author:i.author,chat:i.threadJid,externalId:i.externalId});if(t.has(l)){var s,u=(s=t.get(l))!=null?s:1;return t.set(l,u),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Duplicate waMsgId found for receipt, number of duplicates: ",""])),u),n.receipts.delete(a.msgId).then(r("emptyFunction"))}else return t.set(l,1),n.receipts.where("msgId").equals(i.msgId).modify(function(e){e.waMsgId=l}).then(r("emptyFunction"))})}))})},A=function(){return o("MAWDexieTable").dexieResolve()},F=function(t){return t.participants.toArray().then(function(e){var n=e.map(function(e){return babelHelpers.extends({},e,{id:o("MAWDbParticipant").craftParticipantId(e.threadJid,e.userJid)})}),r=e.map(function(e){return e.id});return t.participants.bulkDelete(r).then(function(){t.participants.bulkPut(n)})})},O=function(t){return t.reactions.toCollection().modify(function(e){e.ts=e.ts})},B=new Map([[(s=o("MAWDbVersionList")).VERSION.V26,u],[s.VERSION.V27,c],[s.VERSION.V28,d],[s.VERSION.V29,m],[s.VERSION.V30,p],[s.VERSION.V31,_],[s.VERSION.V43,f],[s.VERSION.V44,g],[s.VERSION.V45,h],[s.VERSION.V46,y],[s.VERSION.V47,C],[s.VERSION.V53,b],[s.VERSION.V54,v],[s.VERSION.V55,S],[s.VERSION.V56,R],[s.VERSION.V57,L],[s.VERSION.V58,E],[s.VERSION.V60,k],[s.VERSION.V66,I],[s.VERSION.V68,T],[s.VERSION.V71,D],[s.VERSION.V72,x],[s.VERSION.V82,$],[s.VERSION.V85,P],[s.VERSION.V87,N],[s.VERSION.V90,M],[s.VERSION.V91,w],[s.VERSION.V101,A],[s.VERSION.V104,F],[s.VERSION.V116,O]]);l.dbUpgrades=B}),98);
__d("MAWDbSchemaReStoreDexieUtils",["FBLogger","MAWDbSchema","MAWDbSchema.dexie","sortBy"],(function(t,n,r,o,a,i,l){"use strict";var e=r("sortBy")(Array.from(new Set([].concat(Array.from(o("MAWDbSchema").dbSchema.keys()),Array.from(o("MAWDbSchema.dexie").dbUpgrades.keys())))).map(function(e){return{schema:o("MAWDbSchema").dbSchema.get(e),upgrade:o("MAWDbSchema.dexie").dbUpgrades.get(e),version:e}}),function(e){var t=e.version;return t}),s=function(t,n){return Array.from(t.filter(function(e){return e.version<=n&&e.schema!=null}).reduce(function(e,t){var n;return(n=t.schema)==null||n.forEach(function(t){e.set(t.name,t)}),e},new Map).values())},u=function(t,n){return s(t,n).reduce(function(e,t){var n=t.autoIncrement,o=t.dexieOnly_primaryKeyUnique,a=t.name,i=t.primaryKey,l=t.removed,s=a.replace(/^e2ee_/,"");if(l===!0)return e[s]=null,e;if(n&&o===!0)throw r("FBLogger")("messenger_web").mustfixThrow("Invalid schema, cannot have both autoincremnet and unique constraints "+JSON.stringify(t));var u=n?"++":"",c=o===!0?"&":"",d=(i.length>1?"[":"")+i.join("+")+(i.length>1?"]":""),m=Object.values(t.indexes).map(function(e){var t=e.columns,n=e.unique!==!1,r=t.length>1,o=e.multiEntry_DO_NOT_USE===!0,a=n&&!o?"&":"",i=o?"*":"",l=""+a+i;return""+l+(r?"[":"")+t.join("+")+(r?"]":"")}).join(",");return e[s]=[""+u+c+d,m].filter(Boolean).join(","),e},{})},c=function(n){return u(e,n)};l.MAW_DB_VERSION_CHANGES=e,l.getDexieSchemaForVersion=u,l.getCompleteDexieSchemaForVersion=c}),98);
__d("MAWDbVersion",["MAWCurrentUser","MAWDbSchemaReStoreDexieUtils","MAWDbVersionList","MAWGetDbVersion","MAWIndexedDbMetadata","MAWODSProxy","MWFBLogger","Promise","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=o("MWFBLogger").MWLogger().tags(["db","getDexieDbVersion"]),y=o("MAWGetDbVersion").getArmadilloDbVersion(),C=o("MAWDbSchemaReStoreDexieUtils").getCompleteDexieSchemaForVersion(Math.min(o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES[o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.length-1].version,y>0?y:1/0));function b(e,t){var n=t.schema,r=t.upgrade,o=t.version;return n!=null&&r!=null?e.version(o).stores(n).upgrade(r):n!=null?e.version(o).stores(n):r!=null?e.version(o).upgrade(r):e.version(o),o}function v(t){return new(g||(g=n("Promise")))(function(n){if(!indexedDB){n();return}var r=indexedDB.open(t);r.onupgradeneeded=function(r){r.target.transaction.abort();var o=r.target.result;h.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose([""," onupgradeneeded - closing db"])),t),o==null||o.close(),n()},r.onsuccess=function(e){var r=e.target.result,a=r==null?void 0:r.version;h.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose([""," version: ",""])),t,a!=null?a:"null"),r==null||r.close(),a!=null?(a%10>=1&&o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_DB_UNEXPECTED_VERSION,key:"fail_"+a%10}),n(o("MAWDbVersionList").toVersion(a/10))):n()},r.onerror=function(e){var r;h.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," error ",""])),t,e==null||(r=e.target)==null||(r=r.error)==null?void 0:r.message),n()},r.onblocked=function(e){var n=e.target.result,r=n==null?void 0:n.version;h.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," blocked, version: ",""])),t,r!=null?r:"null"),n==null||n.close()}})}function S(){var e=o("MAWCurrentUser").getID();return v(o("MAWIndexedDbMetadata").dbName(e))}function R(e,t){if(e.upgrade!=null||t.upgrade!=null)return!0;var n=Object.keys((e==null?void 0:e.schema)||{}),r=Object.keys((t==null?void 0:t.schema)||{}),o=[].concat(n,r),a=new Set(o);return a.size!==o.length}function L(e){return e.reduce(function(e,t,n){if(n===0)return[babelHelpers.extends({},t,{schema:o("MAWDbSchemaReStoreDexieUtils").getCompleteDexieSchemaForVersion(t.version)})];var r=e[e.length-1],a=babelHelpers.extends({},t,{schema:t.schema!=null?o("MAWDbSchemaReStoreDexieUtils").getDexieSchemaForVersion([t],t.version):null});return R(r,a)?(e.push(a),e):(e.splice(e.length-1,1,babelHelpers.extends({},r,a,{schema:babelHelpers.extends({},r==null?void 0:r.schema,a==null?void 0:a.schema)})),e)},[])}function E(e,t,n,r){var a=r!=null?r:o("MAWGetDbVersion").getArmadilloDbVersion==null?void 0:o("MAWGetDbVersion").getArmadilloDbVersion();h.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["current db version: ",", target db version: ",""])),n,a),a==null&&h.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["version is not set in QE"]))),n!=null&&n>a&&(h.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["current db version is greater than target db version"]))),a=n);var i=o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.filter(function(e){var t=e.version;return n==null||t>n}).filter(function(e){var t=e.version;return a==null||a>=t}),l=o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.filter(function(e){var t=e.version;return a==null||a>=t});if(i.length===0||i.length===l.length){h.DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Skipping db upgrade and just applying latest schema"]))),t.addAnnotations({bool:{isUpgradeNeeded:!1}});var s=o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES[o("MAWDbSchemaReStoreDexieUtils").MAW_DB_VERSION_CHANGES.length-1].version,u=Math.min(a!=null&&a>0?a:s,s);return e.version(u).stores(o("MAWDbSchemaReStoreDexieUtils").getCompleteDexieSchemaForVersion(u)),u}var c=L(i);h.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Applying "," updates between "," and ",""])),c.length,i[0].version,i[i.length-1].version);var g=c.filter(function(e){return!!e.upgrade}).map(function(e){return e.version.toString()}),y=c.filter(function(e){return!!e.schema}).map(function(e){return e.version.toString()});g.length&&t.addAnnotations({string_array:{dataMigrationVersions:g}}),y.length&&t.addAnnotations({string_array:{schemaUpgradeVersions:y}}),t.addAnnotations({bool:{isUpgradeNeeded:!0}});var C=0;return c.forEach(function(t){var n;C=Math.max((n=b(e,t))!=null?n:0,C!=null?C:0)}),C}l.CURRENT_MAW_STORES=C,l.getDexieDbVersion=v,l.getDBVersion=S,l.updateDB=E}),98);
__d("MAWDexieError",[],(function(t,n,r,o,a,i){"use strict";var e="ModifyError",l="BulkError",s="OpenFailedError",u="VersionChangeError",c="SchemaError",d="UpgradeError",m="InvalidTableError",p="MissingAPIError",_="NoSuchDatabaseError",f="InvalidArgumentError",g="SubTransactionError",h="UnsupportedError",y="InternalError",C="DatabaseClosedError",b="PrematureCommitError",v="ForeignAwaitError",S="UnknownError",R="ConstraintError",L="DataError",E="TransactionInactiveError",k="ReadOnlyError",I="VersionError",T="NotFoundError",D="InvalidStateError",x="InvalidAccessError",$="AbortError",P="TimeoutError",N="QuotaExceededError",M="SyntaxError",w="DataCloneError",A={AbortError:$,BulkError:l,ConstraintError:R,DatabaseClosedError:C,DataCloneError:w,DataError:L,ForeignAwaitError:v,InternalError:y,InvalidAccessError:x,InvalidArgumentError:f,InvalidStateError:D,InvalidTableError:m,MissingAPIError:p,ModifyError:e,NoSuchDatabaseError:_,NotFoundError:T,OpenFailedError:s,PrematureCommitError:b,QuotaExceededError:N,ReadOnlyError:k,SchemaError:c,SubTransactionError:g,SyntaxError:M,TimeoutError:P,TransactionInactiveError:E,UnknownError:S,UnsupportedError:h,UpgradeError:d,VersionChangeError:u,VersionError:I};i.DEXIE_ERROR=A}),66);
__d("MAWIDbSetupQplEventListener",["MAWDexieError","MAWQplProxy","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null;function u(t){var n=new Set(Object.keys(o("MAWDexieError").DEXIE_ERROR));n.has(t.reason)&&e!=null&&(e.endFail(t.reason),o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25310776,"6155"),"database_setup_failed"),s!=null&&(s(),s=null))}var c=function(r,o){return e=r,s=o,t.addEventListener("unhandledrejection",u),function(){return t.removeEventListener("unhandledrejection",u)}};l.trackDbSetupFailure=c}),98);
__d("MAWLowLevelApiTypes",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e={EXISTING_GROUP_INVITE:"existing_group_invite",MISSING_GROUP:"missing_group"},l={EXPIRED_GROUP_INVITE:"expired_group_invite",MISSING_GROUP:"missing_group",MISSING_GROUP_INVITE:"missing_group_invite"},s=n("$InternalEnum")({Initializing:"initializing",Open:"open",Closed:"closed",Error:"error",Upgrading:"upgrading"});i.WRITE_GROUP_INVITE_ERROR=e,i.GET_GROUP_INVITE_ERROR=l,i.DatabaseState=s}),66);
__d("MAWDbFactory",["ClientConsistencyEventEmitter","Deferred","MAWCurrentUser","MAWDbVersion","MAWDexieTable","MAWGetDbVersion","MAWIDbSetupQplEventListener","MAWIndexedDBDeletion","MAWIndexedDbMetadata","MAWLowLevelApiTypes","MAWQplProxy","MAWReliabilityMonitor","MWFBLogger","Promise","asyncToGeneratorRuntime","getErrorSafe","gkx","promiseDone","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=["backendInitPromise","middleware","onDbPopulate"],h;function y(t,a){var i=null,l=o("MWFBLogger").MWLogger().tags(["db",t,a]),y=new(r("Deferred")),C=!1,b=!1,v,S=!1,R=null,L=a!=="worker"?null:o("MAWReliabilityMonitor").MAWReliabilityMonitorSingleton.startMonitoring("DB_"+t+"_"+a,function(){return{extra:{isMakingDB:String(C),willBeSetup:String(b)},reason:String(R),state:(function(){if(R==null)return o("MAWReliabilityMonitor").HealthReportState.UNKNOWN;switch(R){case o("MAWLowLevelApiTypes").DatabaseState.Initializing:case o("MAWLowLevelApiTypes").DatabaseState.Upgrading:return o("MAWReliabilityMonitor").HealthReportState.PENDING;case o("MAWLowLevelApiTypes").DatabaseState.Open:return o("MAWReliabilityMonitor").HealthReportState.OK;case o("MAWLowLevelApiTypes").DatabaseState.Closed:case o("MAWLowLevelApiTypes").DatabaseState.Error:return o("MAWReliabilityMonitor").HealthReportState.ERROR}})()}});function E(){y=new(r("Deferred")),v==null||v(),C=!1,b=!1}function k(){return b}function I(){return y.getPromise().then(function(){return S})}function T(e,t,n){return D.apply(this,arguments)}function D(){return D=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n,h,k){var I=h.backendInitPromise,T=h.middleware,D=h.onDbPopulate,x=babelHelpers.objectWithoutPropertiesLoose(h,g),$=o("MAWCurrentUser").getID(),P=o("MAWIndexedDbMetadata").dbName($),N=r("qpl")._(25310776,"6155");function M(e){R=e,L==null||L.updateState()}if(i!=null){l.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["DB exists"]))),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_exsists");return}var w=o("MAWQplProxy").startQplUserFlow(r("qpl")._(1056836116,"905"),{string:{db:t,name:P}});if(b=!0,C)return o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_make_in_progress"),y.getPromise();l.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Starting DB Setup"]))),C=!0,o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_make_started"),v=o("MAWIDbSetupQplEventListener").trackDbSetupFailure(w,function(){M(o("MAWLowLevelApiTypes").DatabaseState.Error),y.reject("DB setup failed"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_setup_failed"),E()}),M(o("MAWLowLevelApiTypes").DatabaseState.Initializing);var A=yield o("MAWDbVersion").getDexieDbVersion(P);A==null&&(S=!0),w.addAnnotations({int:{currentVersion:A}});var F=k!=null?k:o("MAWGetDbVersion").getArmadilloDbVersion();if(w.addAnnotations({int:{targetVersion:F}}),I&&(A||0)<F){w.addPoint("separate_read_waiting_on_worker_upgrade"),l.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Waiting for worker to upgrade schema..."])));try{yield I}catch(e){throw l.catching(r("getErrorSafe")(e)).mustfixThrow("Worker startup promise rejected, schema upgrade failed.")}var O=yield o("MAWDbVersion").getDexieDbVersion(P);if(O!==F)throw l.mustfixThrow("Main thread waiting on worker schema upgrade from %s to %s, upgrade failed with version %s",A,F,O);A=O}else a==="worker"&&(o("MAWQplProxy").sendQPLIntAnnotationThroughBridge(r("qpl")._(1056839232,"112"),"dbVersion",A!=null?A:0),o("MAWQplProxy").sendQPLIntAnnotationThroughBridge(r("qpl")._(1056839232,"112"),"useSentBytesCache",r("gkx")("33008")?1:0));var B=function(n){var e=o("MAWDbVersion").updateDB(n,w,A,k);return!I&&a==="worker"&&o("MAWQplProxy").sendQPLBoolAnnotationThroughBridge(r("qpl")._(1056839232,"112"),"dbUpgradeNeeded",A!==e),l.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["latest pushed version: ",", current: ",", requested: ",""])),e,A,k!=null?k:"<latest>"),a==="worker"&&(A!==e?o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_version_upgraded"):o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_version_upgrade_not_required")),e};return i=new(o("MAWDexieTable")).DexieTable(P,function(e){T.forEach(function(t){e.use(t(n))});var i=B(e);e.on("populate",function(e){if(!e){M(o("MAWLowLevelApiTypes").DatabaseState.Error),y.reject("Missing DB for populate event"),w.endFail("on_populata-missing_txn"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_on_populate_missing_txn");return}l.info("MAWDB populated. HasPopulateEvent: %s",!!D),D==null||D(e)}),e.on("blocked",function(){l.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["DB Open blocked"]))),M(o("MAWLowLevelApiTypes").DatabaseState.Error),y.reject("DB Open blocked"),w.endFail("db_blocked"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_blocked"),E()}),e.on("ready",function(e){if(l.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["MAW DB setup complete"]))),C=!1,e==null){M(o("MAWLowLevelApiTypes").DatabaseState.Error),l.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["DB is null"]))),y.reject("DB is null"),w.endFail("db_null"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_null"),E();return}M(o("MAWLowLevelApiTypes").DatabaseState.Open),v==null||v(),y.resolve(),w.endSuccess({int:{dbVersion:i}}),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_ready")}),e.on("close",function(){M(o("MAWLowLevelApiTypes").DatabaseState.Closed),l.WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["DB forcibly closed"]))),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_forcibly_closed")}),e.on("versionchange",function(e){l.WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Versionchange detected: ("," -> "," (event version: ",", highestUsed: (","), name: ",""])),e==null?void 0:e.oldVersion,e==null?void 0:e.newVersion,String(e==null?void 0:e.version),i,e==null?void 0:e.name),M(o("MAWLowLevelApiTypes").DatabaseState.Upgrading),a!=="worker"&&r("ClientConsistencyEventEmitter").emit("softRefresh","mawdb_versionchange"),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_versionchange")})},void 0,x),o("MAWQplProxy").sendQplPointThroughBridge(N,"database_"+t+"_make_requested"),y.getPromise()}),D.apply(this,arguments)}function x(e){if(i==null)throw l.mustfixThrow('IndexDB has not been initialized before executing "'+(e!=null?e:"unnamed")+'"');return i}function $(e){return i!=null&&!C?(h||(h=n("Promise"))).resolve(i):(y=y||new(r("Deferred")),y.getPromise().then(function(){return x(e)}))}function P(){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield $();e!=null&&(e.close(),i=null),E()}),N.apply(this,arguments)}function M(){i=null,E()}function w(e){r("promiseDone")(P());var t=o("MAWIndexedDbMetadata").dbName(e!=null?e:o("MAWCurrentUser").getID());r("promiseDone")(o("MAWIndexedDBDeletion").deleteDB(t,"maw")),L==null||L.stopMonitoring()}return{closeDB:P,deleteDb:w,getDB:$,getDBExn:x,isNewDb:I,makeDB:T,reset_singleton_INTERNAL_ONLY:M,setupPromise:function(){return y.getPromise()},willSetupDB:k}}l.makeIDBFactory=y}),98);
__d("MAWIndexedDbUI",["ExecutionEnvironment","MAWDbFactory","MAWDbMutationMiddleware","MAWDbProtocolMsgIdMiddleware","MAWDexieTable","MAWIndexedDb","MAWTransactor","Promise","cr:3527","gkx","performance"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(){var e=o("MAWDbFactory").makeIDBFactory("ui_idb","main");return{closeDB:e.closeDB,deleteDb:e.deleteDb,getDB:e.getDB,makeDB:function(a,i,l){var t=[o("MAWDbMutationMiddleware").getMAWDbMutationMiddleware];r("gkx")("1760")&&t.push(o("MAWDbProtocolMsgIdMiddleware").MAWDbProtocolMsgIdMiddleware),n("cr:3527")!=null&&t.push(n("cr:3527"));var s=e.makeDB(a,{autoOpen:r("gkx")("6817"),backendInitPromise:i.backendInitPromise,cache:"disabled",middleware:t,onDbPopulate:i.onDbPopulate},l);return s},reset_singleton_INTERNAL_ONLY:e.reset_singleton_INTERNAL_ONLY}}var d=c(),m=d.makeDB,p=d.closeDB,_=d.getDB,f=d.deleteDb,g=d.reset_singleton_INTERNAL_ONLY,h=(s||(s=r("ExecutionEnvironment"))).isInBrowser?_("MawDbInUISingleton_INTERNAL_ONLY").then(function(e){return{openReadonlyTransaction:function(n,a,i){return e.stores.transaction("r",a,function(){return o("MAWDexieTable").setDexiePSDItem("transactorName",n),o("MAWDexieTable").setDexiePSDItem("transactionRequested",(u||(u=r("performance"))).now()+u.timeOrigin),i(e.stores)})},openReadWriteTransaction:function(n,a,i){return e.stores.transaction("rw",a,function(){return o("MAWDexieTable").setDexiePSDItem("transactorName",n),o("MAWDexieTable").setDexiePSDItem("transactionRequested",(u||(u=r("performance"))).now()+u.timeOrigin),i(e.stores)})}}}):new(e||(e=n("Promise")))(function(){});l.makeMsgrTransactor=o("MAWTransactor").makeMsgrUITransactor_IMPORT_FROM_MAWIndexedDbUI_INSTEAD,l.afterTransaction=o("MAWIndexedDb").afterTransaction,l.makeMAWIndexedDBFactory=c,l.makeDB=m,l.closeDB=p,l.getDB=_,l.deleteDb=f,l.reset_singleton_INTERNAL_ONLY=g,l.MawDbInUISingleton=h}),98);
__d("MAWWorkerCacheServiceRegistry",["MAWSnippetsCacheService"],(function(t,n,r,o,a,i,l){"use strict";var e={snippets:o("MAWSnippetsCacheService").getMAWSnippetsCacheService()};function s(){return e}l.getWorkerRegistry=s}),98);
__d("MAWCacheServiceQPL",["ExecutionEnvironment","MAWCurrentUser","MAWQplProxy","QPLUserFlow","performanceAbsoluteNow","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new Set,c=new Set,d=3e3,m=r("qpl")._(1056836703,"2955");function p(t,n){var a=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(a){if(c.has(t))return;f(t),o("MAWQplProxy").startQplUserFlow(m,{},{callBridgeWithTimestamp:!0,providedInstanceKey:t})}else{if(u.has(t))return;_(t),r("QPLUserFlow").start(m,{annotations:{string:{service:n}},instanceKey:t})}}function _(e){u.add(e)}function f(e){c.add(e)}function g(t,n,a){var i=b(a),l=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(l){if(!c.has(t))return;o("MAWQplProxy").sendQplPointThroughBridge(m,"worker@"+i+n,{instanceKey:t},!0)}else{if(!u.has(t))return;var p=(s||(s=r("performanceAbsoluteNow")))();a==="realtime-update"?window.setTimeout(function(){r("QPLUserFlow").addPoint(m,"ui@"+n,{instanceKey:t,timestamp:p})},d):r("QPLUserFlow").addPoint(m,"ui@"+n,{instanceKey:t})}}function h(t,n){var a=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(a){if(!c.has(t))return;o("MAWQplProxy").sendQPLAnnotationsThroughBridge(m,n,t)}else{if(!u.has(t))return;r("QPLUserFlow").addAnnotations(m,n,{instanceKey:t})}}function y(t){var n=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(n){if(!c.has(t))return;c.delete(t),o("MAWQplProxy").sendQPLSuccessThroughBridge(m,{},t,!0)}else{if(!u.has(t))return;var a=(s||(s=r("performanceAbsoluteNow")))();window.setTimeout(function(){u.delete(t),r("QPLUserFlow").endSuccess(m,{instanceKey:t,timestamp:a})},d)}}function C(t,n,a){var i=b(a),l=(e||(e=r("ExecutionEnvironment"))).isInWorker||(e||(e=r("ExecutionEnvironment"))).isInSharedWorker;if(l){if(!c.has(t))return;o("MAWQplProxy").sendQPLFailThroughBridge(m,"worker@"+i+n,{},t,!0)}else{if(!u.has(t))return;var p=(s||(s=r("performanceAbsoluteNow")))();window.setTimeout(function(){u.delete(t),r("QPLUserFlow").endFailure(m,"ui@"+n,{instanceKey:t,timestamp:p})},d),u.delete(t)}}function b(e){return e?e.replace(/-/g,"_")+"_":""}function v(e){return o("MAWCurrentUser").isEmployee()||o("MAWCurrentUser").isTestUser()?e:void 0}var S={addAnnotationsQPL:h,addPointQPL:g,endFailureQPL:C,endSuccessQPL:y,redactKeysForNonEmployee:v,registerInstanceKeyInUI:_,registerInstanceKeyInWorker:f,startQPL:p};l.default=S}),98);
__d("MAWCacheServiceUtils",["FBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e="maw_cache_service_broadcast",s=typeof window!="undefined"?window:self,u=function(){return s.BroadcastChannel?new s.BroadcastChannel(e):(r("FBLogger")("messenger_e2ee_web").warn("BroadcastChannel is not supported in this browser"),null)},c={concurrency:1,maxTaskLimit:1,maxThrottleMs:500};function d(e){return"maw-cache-service-"+e}function m(e,t){var n=new Set,r=[];return e.forEach(function(e){var o=t(e);if(n.has(o)){r.push(e);return}n.add(o)}),r}l.MAW_CACHE_SERVICE_BROADCAST_CHANNEL=e,l.globalScope=s,l.getMAWCacheServiceBroadcastChannel=u,l.SCHEDULER_CONFIG=c,l.getSchedulerName=d,l.findDuplicates=m}),98);
__d("MAWDbMsgOrReaction",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function l(e,t){return e==null?t.forNull():e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function s(e,t){return e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}function u(e,t){return e==null?t.forNull():e.reactToExternalId!=null?t.forReaction(e):t.forMessage(e)}i.switchOnMsgOrReaction=e,i.switchOnMsgOrReactionNullish=l,i.switchOnMsgOrReactionMaybeUnstored=s,i.switchOnMsgOrReactionMaybeUnstoredNullish=u}),66);
__d("MAWWorkerCacheServices",["FBLogger","MAWBridge","MAWCacheServiceDB","MAWCacheServiceQPL","MAWCacheServiceUtils","MAWDbMsgOrReaction","MAWLoggerUtils","MAWSnippetsCacheCalculateDelta","MAWWorkerCacheServiceRegistry","Promise","WorkerScheduler","asyncToGeneratorRuntime","cr:2354","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function t(){this.$1=o("MAWCacheServiceUtils").getMAWCacheServiceBroadcastChannel();var e=o("MAWWorkerCacheServiceRegistry").getWorkerRegistry();this.registry=e,this.schedulerRegistry=Object.keys(e).reduce(function(e,t){var n;return babelHelpers.extends({},e,(n={},n[t]=o("WorkerScheduler").makeScheduler(o("MAWCacheServiceUtils").getSchedulerName(t),o("MAWCacheServiceUtils").SCHEDULER_CONFIG),n))},{})}var a=t.prototype;return a.$2=function(t,n,r,a){var e={cache:n,instanceKey:a,namespace:t,source:r};this.$1==null?o("MAWBridge").getBridge().fireAndForget("event","broadcastChannelFallback",{event:{data:e},namespace:o("MAWCacheServiceUtils").MAW_CACHE_SERVICE_BROADCAST_CHANNEL}):this.$1.postMessage(e)},a.$3=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a,i){var l=o("MAWCacheServiceUtils").findDuplicates(t,function(e){var t=e[0],n=e[1];return t});if(l.length>0&&(r("FBLogger")("MAWCacheService").mustfix("Found duplicate keys in cache: %s. Original keys: %s, Namespace: %s, Source: %s",l.map(function(e){var t=e[0],n=e[1];return t}).join(", "),t.map(function(e){var t=e[0],n=e[1];return t}).join(", "),e,n),a!=null&&r("MAWCacheServiceQPL").addAnnotationsQPL(a,{bool:{hasDuplicateKeys:!0},string_array:{duplicateKeys:r("MAWCacheServiceQPL").redactKeysForNonEmployee(l.map(function(e){var t=e[0],n=e[1];return t}))}})),t.length===0){a!=null&&(r("MAWCacheServiceQPL").addPointQPL(a,"nothing_to_update_in_cache",n),r("MAWCacheServiceQPL").endSuccessQPL(a));return}a!=null&&r("MAWCacheServiceQPL").addPointQPL(a,"updating_cache_in_persisted_start",n);var s=this.registry[e];s.updateInMemoryCacheBulk(t);try{var u=o("MAWCacheServiceDB").convertCacheValueToDBRawValue(t),c=yield o("MAWCacheServiceDB").getOrSetupMAWCacheDB();yield c.runInTransaction([e],"readwrite",function(t){var n=u.map(function(e){return{item:e,selector:[e.key]}});return t.stores[e].bulkUpsert("key",n)},"update_cache_"+e),i==null||i(u.map(function(e){var t=e.key;return t})),a!=null&&r("MAWCacheServiceQPL").addPointQPL(a,"updating_cache_in_persisted_end",n)}catch(e){var d=r("getErrorSafe")(e);a!=null&&(r("MAWCacheServiceQPL").addAnnotationsQPL(a,{string:{error:d.message}}),r("MAWCacheServiceQPL").addPointQPL(a,"updating_cache_in_persisted_failed",n)),r("FBLogger")("MAWCacheService").catching(d).mustfix("Failed to update persisted cache")}a!=null&&r("MAWCacheServiceQPL").addPointQPL(a,"broadcasting_to_ui_start",n),this.$2(e,t,n,a)});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),a.calculateDelta=function(a){var t=this,i=Object.values(this.registry).map(function(e){var i=e.shouldDropDelta(a);return i.then(function(i){if(!i){var l=t.schedulerRegistry[e.namespace];return l.runTask({fn:function(){return e.calculateDelta(a).then(function(i){var s=i.map(function(e){var t=e[0],n=e[1];return t}),c=o("MAWLoggerUtils").getInstanceKey();i.length!==0&&(r("MAWCacheServiceQPL").startQPL(c,e.namespace),r("MAWCacheServiceQPL").addAnnotationsQPL(c,{bool:{isRealtimeUpdate:!0},int:{instanceKey:c},string_array:{realtimeUpdatedKeys:s}}));var d=u(a);return t.$3(e.namespace,i,"realtime-update",c,function(e){n("cr:2354")==null||n("cr:2354").notifyCacheWrite(e,l,d)})}).catch(function(t){r("FBLogger")("MAWCacheService").catching(t).warn("Failed to calculate delta for: %s",e.namespace)})},name:"maw_calculate_delta",priority:o("WorkerScheduler").REGULAR_PRIORITY})}})});(e||(e=n("Promise"))).all([].concat(i)).catch(function(e){r("FBLogger")("MAWCacheService").catching(e).mustfix("Failed to calculate delta for all services")})},a.computeCachePayloadFromScratch=function(t,n,a,i){var e=this;i!=null&&r("MAWCacheServiceQPL").registerInstanceKeyInWorker(i),r("MAWCacheServiceQPL").addPointQPL(i,"compute_from_scratch_start",a),r("MAWCacheServiceQPL").addAnnotationsQPL(i,{string_array:{keysReceivedInWorker:r("MAWCacheServiceQPL").redactKeysForNonEmployee(n)}});var l=this.registry[t],s=this.schedulerRegistry[l.namespace];if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("No service found for namespace: "+t);return s.runTask({fn:function(s){var o=s.metric;return l.computeCachePayloadFromScratch(n,o).then(function(n){return r("MAWCacheServiceQPL").addPointQPL(i,"compute_from_scratch_end",a),e.$3(t,n,a,i)}).catch(function(e){r("MAWCacheServiceQPL").endFailureQPL(i,"compute_from_scratch_failed",a),r("FBLogger")("MAWCacheService").catching(e).warn("Failed to compute cache payload from scratch")})},name:"maw_compute_cache_payload_from_scratch",priority:o("WorkerScheduler").REGULAR_PRIORITY})},t})();function u(e){var t=e.filter(function(e){var t=e[0];return["messages","reactions"].includes(t)}),n=o("MAWSnippetsCacheCalculateDelta").parseAndGetMostRecentSnippetUpdateMutateRequestForChatJids(t.map(function(e){var t=e[0],n=e[1];return n})),r=n.values().every(function(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReaction(e.value,{forMessage:function(t){return t.source==="eb_restore"},forReaction:function(){return!0}})});return r?"eb_restore":"whatsapp"}var c=null,d=function(){return c==null&&(c=new s),c};l.getMAWWorkerCacheServices=d}),98);
__d("MAWGetBumpTimestampMs",["I64","MAWAckLevel","MAWDbMsgOrReaction","MAWExtractMsFromExternalId","MAWTimeUtils","WALongInt","WATimeUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=n==null?null:o("MAWExtractMsFromExternalId").extractMsFromExternalId(n);return(e||(e=o("I64"))).add(o("MAWTimeUtils").millisTimeToTimestamp(t),e.of_int32(r!=null?r:0))}function u(t){var n=t.msg,a=t.throwIfNoServerTs,i=a?r("nullthrows")(n.serverTs):n.serverTs;return s(o("WATimeUtils").castUnixTimeToMillisTime(i!=null?i:n.ts),(e||(e=o("I64"))).of_string(n.externalId))}function c(t){return t.senderTimestampMs!=null?(e||(e=o("I64"))).of_string(o("WALongInt").longIntToDecimalString(t.senderTimestampMs)):s(o("WATimeUtils").castUnixTimeToMillisTime(t.ts),(e||(e=o("I64"))).of_string(t.externalId))}function d(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstoredNullish(t,{forMessage:function(n){return o("MAWAckLevel").isMsgAuthoritative(n.ack)&&n.sortOrderMs!=null?(e||(e=o("I64"))).of_float(n.sortOrderMs):u({msg:n,throwIfNoServerTs:!1})},forNull:function(){return(e||(e=o("I64"))).zero},forReaction:c})}l.calculateBumpTimestampMs=s,l.getBumpTimestampMs=d}),98);
__d("MAWSnippetsCacheServiceUtils",["I64","MAWDbMsgOrReaction","MAWGetBumpTimestampMs"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionNullish(t,{forMessage:function(n){return{msgAckLevel:n.ack,msgId:n.msgId,reactionId:void 0,timestamp:n.sortOrderMs!=null?n.sortOrderMs:(e||(e=o("I64"))).to_float(o("MAWGetBumpTimestampMs").getBumpTimestampMs(n))}},forNull:function(){return{msgAckLevel:void 0,msgId:void 0,reactionId:void 0,timestamp:Number.MIN_SAFE_INTEGER}},forReaction:function(n){return{msgAckLevel:void 0,msgId:void 0,reactionId:n.reactionId,timestamp:(e||(e=o("I64"))).to_float(o("MAWGetBumpTimestampMs").getBumpTimestampMs(n))}}})}l.getMsgOrReactionIdAndTimestamp=s}),98);
__d("MAWUpdateThreadListItemUtils",["MAWAckLevel","MAWDbMsg","MAWDbMsgOrReaction","MAWMsgType","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(e,{forMessage:function(t){return t.altIndex===o("MAWDbMsg").SPAM_ALT_INDEX||t.altIndex===o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX},forReaction:function(){return!1}})}function s(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(e,{forMessage:function(t){return t.ack===o("MAWAckLevel").ACK.clock},forReaction:function(){return!1}})}function u(e){var t;return e.msgId!=null&&e.type===o("MAWMsgType").MSG_TYPE.XMA&&((t=e.msgContent)==null?void 0:t.content)===""}function c(e){return e.type===o("MAWMsgType").MSG_TYPE.XMA&&o("MAWXMAUtils").isRtcXMA(e==null?void 0:e.xmaMessageType)}l.isSpamMessage=e,l.isOptimisticMessage=s,l.isXMAThreadSnippet=u,l.isRTCXMAMessage=c}),98);
__d("MAWSnippetsCacheCalculateDelta",["FBLogger","MAWDbMsgOrReaction","MAWGetThreadUpdateType","MAWSnippetsCacheServiceUtils","MAWUpdateThreadListItemUtils"],(function(t,n,r,o,a,i,l){"use strict";var e="[SnippetsCacheService][Worker]";function s(e){var t=new Set(e.map(function(e){var t,n,r=(t=e.decryptedValues)!=null?t:[],o=(n=e.deletedValues)!=null?n:[];return[].concat(r,o)}).flat().map(function(e){return o("MAWUpdateThreadListItemUtils").isOptimisticMessage(e)?null:e.msgId}).filter(Boolean));return e.reduce(function(e,n){var r=n.type==="delete"?n.deletedValues:n.decryptedValues,o=p(r);return o=_(t,o),o.length===0||o.forEach(function(t){var r=t.threadJid,o=e.get(r),a=m({type:n.type,value:t},o);e.set(r,a)}),e},new Map)}function u(e){return e.some(function(e){var t=e.chatJid,n=e.lastComputedCacheValue,r=e.mutateReq;return!c(r)||d(r.value)})}function c(e){return!(e.type==="delete"||e.type==="deleteRange"||o("MAWUpdateThreadListItemUtils").isXMAThreadSnippet(e.value)||h(e.value)||y(e.value))}function d(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReaction(e,{forMessage:function(t){return!1},forReaction:function(t){return t.reaction!=null&&o("MAWGetThreadUpdateType").canReactionAffectBump(t)}})}function m(e,t){if(t==null)return e;var n=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(e.value),r=n.timestamp,a=e.value.externalId,i=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(t.value),l=i.timestamp,s=t.value.externalId;return r===l?e.type==="delete"||e.type==="deleteRange"?e:t.type==="delete"||t.type==="deleteRange"?t:a.localeCompare(s)>0?e:t:r==null?t:l==null||r>l?e:t}function p(e){return e==null||e.length===0?[]:e.filter(function(e){return f(e)})}function _(e,t){return t.reduce(function(t,n){var r=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(n),a=r.msgId;return a!=null&&o("MAWUpdateThreadListItemUtils").isOptimisticMessage(n)&&e.has(a)?t:[].concat(t,[n])},[])}function f(e){var t=g(e)&&!o("MAWUpdateThreadListItemUtils").isSpamMessage(e);return t||C(e),t}function g(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReaction(e,{forMessage:function(n){return o("MAWGetThreadUpdateType").isThreadUpdateTypeEligibleForSnippet(e)},forReaction:function(n){return o("MAWGetThreadUpdateType").canReactionAffectBump(n)&&h(n)||o("MAWGetThreadUpdateType").isThreadUpdateTypeEligibleForSnippet(e)}})}function h(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReaction(e,{forMessage:function(t){return!1},forReaction:function(t){return t.reaction==null}})}function y(e){return o("MAWDbMsgOrReaction").switchOnMsgOrReaction(e,{forMessage:function(t){return t.ephemeralMsgDisappeared===!0},forReaction:function(t){return!1}})}function C(t){var n=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(t),a=n.msgId,i=n.reactionId;r("FBLogger")("MAWCacheService").info(e+" msg or reaction is not eligible for snippet update, msgId: %s, reactionId: %s",a,i)}l.parseAndGetMostRecentSnippetUpdateMutateRequestForChatJids=s,l.isDbTransactionRequiredForSnippetUpdate=u,l.canCalculateSnippetUpdateFromDelta=c,l.isNeededToCheckMessageExistence=d}),98);
__d("MAWUICacheServicesBase",["FBLogger","MAWCacheServiceDB","MAWCacheServiceQPL","MAWMpsGating","Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["id"],s;function u(e){return o("MAWMpsGating").isMpsSnippetsCacheServiceEnabled()?e+"_mps_reactive":e}var c=(function(){function t(e){this.$1=new Map,this.QPLMetadata=new Map,this.$2=e}var a=t.prototype;return a.resetInMemoryCache=function(t,n){var e=this.$1.get(t);e!=null&&(n==null||n.length===0||(r("FBLogger")("MAWUICacheServices").info("Reset in memory cache. Namespace: %s",t),n.forEach(function(t){e.delete(t)})))},a.updateInMemoryCacheAndTriggerCallback=function(t,n,o,a,i){this.$3(t,n);var e=this.$2[t];e!=null&&(a!=null&&(r("MAWCacheServiceQPL").addPointQPL(a,"triggering_callback",o),(o==="cache-invalidation"||o==="realtime-update"||o==="from-scratch"&&this.QPLMetadata.get(a)==="all-from-scratch"||o==="in-memory"&&i===!0)&&(r("MAWCacheServiceQPL").endSuccessQPL(a),this.QPLMetadata.delete(a))),e.onCacheChange(n,o))},a.checkInMemoryCacheAndTriggerCallback=function(t,n,o){var e=this,a=[],i=[];n.forEach(function(n){var r=e.$4(t,n);r==null?a.push(n):i.push([n,r])});var l=a.length===0;return l&&o!=null&&r("MAWCacheServiceQPL").addPointQPL(o,"all_in_memory"),i.length>0&&this.updateInMemoryCacheAndTriggerCallback(t,i,"in-memory",o,l),a},a.checkPersistedCacheAndTriggerCallback=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a,i){var l=yield o("MAWCacheServiceDB").getOrSetupMAWCacheDB(),c=yield l.runInTransaction([t],"readonly",function(e){return(s||(s=n("Promise"))).all(a.map(function(n){return e.stores[t].getByIndex("key",[u(n)])}))},"read_from_persisted_"+t),d=[],m=[];return c.forEach(function(t,n){if(t==null)d.push(a[n]);else{var r=t.id,o=babelHelpers.objectWithoutPropertiesLoose(t,e);m.push([a[n],o])}}),i!=null&&r("MAWCacheServiceQPL").addAnnotationsQPL(i,{int:{numPersistedHit:m.length,numPersistedMiss:d.length}}),d.length===0&&i!=null&&r("MAWCacheServiceQPL").addPointQPL(i,"all_in_persisted"),m.length>0&&this.updateInMemoryCacheAndTriggerCallback(t,m,"persisted",i),d});function a(e,n,r){return t.apply(this,arguments)}return a})(),a.$3=function(t,n){var e,r=(e=this.$1.get(t))!=null?e:new Map;n.forEach(function(e){var t=e[0],n=e[1];r.set(t,n)}),this.$1.set(t,r)},a.$4=function(t,n){var e=this.$1.get(t);if(e==null)return null;var r;return(r=e.get(n))!=null?r:null},t})();l.adjustCacheKey=u,l.MAWUICacheServicesBase=c}),98);
__d("MAWCacheServiceBase",["MAWCacheServiceDB","MAWUICacheServicesBase","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["id"],s=(function(){function t(e){this.$1=new Map,this.namespace=e}var r=t.prototype;return r.$2=function(t){var e;return(e=this.$1.get(t))!=null?e:null},r.updateInMemoryCache=function(t,n){this.$1.set(t,n)},r.updateInMemoryCacheBulk=function(t){var e=this;t.forEach(function(t){var n=t[0],r=t[1];e.updateInMemoryCache(n,r)})},r.getValueFromCache=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=this,r=this.$2(t);if(r!=null)return r;var a=yield o("MAWCacheServiceDB").getOrSetupMAWCacheDB(),i=yield a.runInTransaction([this.namespace],"readonly",function(e){return e.stores[n.namespace].getByIndex("key",[o("MAWUICacheServicesBase").adjustCacheKey(t)])},"read_from_persisted_"+this.namespace);if(i==null)return null;var l=i.id,s=babelHelpers.objectWithoutPropertiesLoose(i,e);return this.updateInMemoryCache(t,s),s});function r(e){return t.apply(this,arguments)}return r})(),t})();l.default=s}),98);
__d("MAWSnippetsCacheService",["FBLogger","MAWAckLevel","MAWCacheServiceBase","MAWDbMsgOrReaction","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWSnippetsCacheCalculateDelta","MAWSnippetsCacheServiceUtils","MAWThreadSnippetBuildTxns","MAWThreadSnippetUtils","MAWTransactionMode","MAWUpdateThreadListItemUtils","MAWVault","Promise","WAJids","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=["messages","reactions"],u="[SnippetsCacheService][Worker]",c=(function(t){function r(){return t.call(this,"snippets")||this}babelHelpers.inheritsLoose(r,t);var a=r.prototype;return a.$MAWSnippetsCacheService$p_1=function(r){var t=this,a=r.filter(function(e){var t=e[0];return s.includes(t)}),i=o("MAWSnippetsCacheCalculateDelta").parseAndGetMostRecentSnippetUpdateMutateRequestForChatJids(a.map(function(e){var t=e[0],n=e[1];return n}));return(e||(e=n("Promise"))).all(Array.from(i.entries()).map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e[0],r=e[1],o=yield t.getValueFromCache(n);return{chatJid:n,lastComputedCacheValue:o,mutateReq:r}});return function(t){return e.apply(this,arguments)}})()))},a.calculateDelta=function(r){var t=this;return this.$MAWSnippetsCacheService$p_1(r).then(function(r){return r.length===0?(e||(e=n("Promise"))).resolve([]):o("MAWSnippetsCacheCalculateDelta").isDbTransactionRequiredForSnippetUpdate(r)?o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY,reactions:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"MAWSnippetsCacheService:calculateDelta",function(e){return(function(n){return t.$MAWSnippetsCacheService$p_2(e,n)})})(r):t.$MAWSnippetsCacheService$p_3(r)})},a.computeCachePayloadFromScratch=function(t,n){var e=this;return o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY,reactions:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"MAWSnippetsCacheService:computeCachePayloadFromScratch",function(t){return function(r){return o("MAWDexieTable").dexieAll(r.map(function(r,a){var i=o("WAJids").unsafeCoerceToChatJid(r);return e.$MAWSnippetsCacheService$p_4(t,i,"from-scratch",a,n)})).then(function(e){return e.filter(Boolean)})}})(t)},a.$MAWSnippetsCacheService$p_5=function(t,n){if(n==null)return"no-value-calculated-from-scratch";if(o("MAWUpdateThreadListItemUtils").isOptimisticMessage(t.value))return null;var e=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(t.value),r=e.msgAckLevel,a=e.msgId,i=e.reactionId,l=e.timestamp;return l==null?"missing-timestamp":a!=null&&a===n.value.snippetMsgId||i!=null&&i===n.value.snippetReactionId?null:a!=null&&r!==o("MAWAckLevel").ACK.received&&n.value.snippetMsgAckLevel===o("MAWAckLevel").ACK.clock?"optimistic-snippet-in-cache":l<n.timestamp?"older-than-last-snippet-value":null},a.shouldDropDelta=function(r){var t=this;return this.$MAWSnippetsCacheService$p_1(r).then(function(r){return r.length===0?(e||(e=n("Promise"))).resolve(!0):(e||(e=n("Promise"))).all(r.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.chatJid,r=e.lastComputedCacheValue,o=e.mutateReq,a=yield t.$MAWSnippetsCacheService$p_5(o,r);return a!=null?(m({dropReason:a,key:n,msgOrReaction:o.value,operation:o.type}),!0):!1});return function(t){return e.apply(this,arguments)}})())).then(function(e){return!!e.every(function(e){return e===!0})})})},a.$MAWSnippetsCacheService$p_4=function(t,n,r,a,i){var e=this;return o("MAWThreadSnippetUtils").getThreadSnippetFromScratch(t,n,a,i).then(function(t){var a=e.$MAWSnippetsCacheService$p_6(n,t,r);if(a!=null)return o("MAWDexieTable").dexieResolve([n,a])})},a.$MAWSnippetsCacheService$p_3=function(t){var e=this;return t.map(function(t){var n=e.$MAWSnippetsCacheService$p_7(t);if(n!=null)return[t.chatJid,n]}).filter(Boolean)},a.$MAWSnippetsCacheService$p_2=function(t,n){var e=this;return o("MAWDexieTable").dexieAll(n.map(function(n){return o("MAWSnippetsCacheCalculateDelta").canCalculateSnippetUpdateFromDelta(n.mutateReq)?e.$MAWSnippetsCacheService$p_8(t,n.mutateReq.value).then(function(t){if(!t){var r=e.$MAWSnippetsCacheService$p_7(n);if(r!=null)return o("MAWDexieTable").dexieResolve([n.chatJid,r])}}):e.$MAWSnippetsCacheService$p_4(t,n.chatJid,"realtime-from-scratch")})).then(function(e){return e.filter(Boolean)})},a.$MAWSnippetsCacheService$p_7=function(t){var e=o("MAWThreadSnippetBuildTxns").buildThreadSnippetForMsgOrIncomingReaction(t.chatJid,t.mutateReq.value),n=this.$MAWSnippetsCacheService$p_6(t.chatJid,{snippet:e,snippetMsgOrReaction:t.mutateReq.value},"realtime-calculate-delta");return n},a.$MAWSnippetsCacheService$p_6=function(t,n,r){if(n==null){d({flow:r,key:t,threadSnippetResult:n});return}var e=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(n.snippetMsgOrReaction),a=e.msgAckLevel,i=e.msgId,l=e.reactionId,s=e.timestamp;if(d({flow:r,key:t,msgAckLevel:a,msgId:i,reactionId:l,threadSnippetResult:n,timestamp:s}),s!=null){var u=babelHelpers.extends({},n.snippet.snippetParams,{strings:n.snippet.snippetParams.strings.map(function(e){return o("MAWVault").unvault(e)})});return{key:t,timestamp:s,value:{snippet:babelHelpers.extends({},n.snippet,{snippetParams:u}),snippetMsgAckLevel:a,snippetMsgId:i,snippetReactionId:l}}}},a.$MAWSnippetsCacheService$p_8=function(t,n){if(!o("MAWSnippetsCacheCalculateDelta").isNeededToCheckMessageExistence(n))return o("MAWDexieTable").dexieResolve(!1);var e=o("MAWDbMsgOrReaction").switchOnMsgOrReaction(n,{forMessage:function(t){return null},forReaction:function(t){return t.reactToMsgId}});return e==null?o("MAWDexieTable").dexieResolve(!0):o("MAWDbMsgTxns").getMsgsByMsgIds(t,[e]).then(function(e){return e.length===0})},r})(r("MAWCacheServiceBase"));function d(e){var t=e.flow,n=e.key,o=e.msgAckLevel,a=e.msgId,i=e.reactionId,l=e.threadSnippetResult,s=e.timestamp;if(l==null){r("FBLogger")("MAWCacheService").warn(u+"["+t+"] Failed to calculate thread snippet, key: %s",n);return}if(s==null){r("FBLogger")("MAWCacheService").warn(u+"["+t+"] No timestamp found for the thread snippet, key: %s,\n      msgId: %s, reactionId: %s",n,a,i);return}r("FBLogger")("MAWCacheService").info(u+"["+t+"] Snippet successfully calculated, key: %s,\n    timestamp: %s, msgId: %s, reactionId: %s, ack level %s",n,s,a,i,o)}function m(e){var t=e.dropReason,n=e.key,a=e.msgOrReaction,i=e.operation,l=o("MAWSnippetsCacheServiceUtils").getMsgOrReactionIdAndTimestamp(a),s=l.msgAckLevel,c=l.msgId,d=l.reactionId,m=l.timestamp;r("FBLogger")("MAWCacheService").info(u+" Drop update for msg or reaction, reason: %s, key: %s, msgId: %s, reactionId: %s, timestamp: %s, ackLevel: %s, operation: %s",t,n,c,d,m,s,i)}var p=new c,_=function(){return p};l.getMAWSnippetsCacheService=_}),98);
__d("MAWDataSyncQueue",["Promise","WALogger","asyncToGeneratorRuntime","getErrorSafe","qex","throttle"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=r("qex")._("853")||1e3,d=r("qex")._("855")||1e3,m=function(){return f=!1,b({isUnloading:!0})},p=[],_=[],f=!1,g=[],h=function(){var e,t=p.splice(0,p.length);(e=_).push.apply(e,t)},y=function(){return _.splice(0,c)},C=function(r){var t=y();if(t.length!==0)return(u||(u=n("Promise"))).all(g.map(function(n,a){return n(t,r).catch(function(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unhandled exception caught in middleware "," sync: ",""])),a,t)})})).then(function(){return C(r)})},b=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(!f){f=!0,h();try{yield C(e)}catch(e){var t,n=r("getErrorSafe")(e);throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[MAWIndexedDbMiddleware] error handling queue batch: ",""])),(t=n==null?void 0:n.message)!=null?t:n.toString()),e}finally{f=!1,p.length>0&&v()}}});return function(n){return e.apply(this,arguments)}})(),v=r("throttle")(b,d),S=function(t,n){p.push({type:t,value:n}),v()},R=function(t){g.some(function(e){return e===t})||g.push(t)},L=function(){g=[]},E=function(){p=[],_=[]},k=function(){return p};l.forceFlushDataSyncQueue=m,l.addSyncItem=S,l.registerDataSyncCallback=R,l.clearDataSyncCallbacks=L,l.clearDataSyncQueue_FOR_TESTING_ONLY=E,l.getDataSyncQueue_FOR_TESTING_ONLY=k}),98);
__d("MAWDataSyncMiddleware",["FBLogger","MAWDataSyncQueue","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set(["contacts","groupInfo","messages","participants","threads","reactions","xma","pendingStanzas"]);function s(t,n){var r=t.table(n);return e.has(n)?babelHelpers.extends({},r,{mutate:function(t){return r.mutate(t).then(function(e){return t.type==="delete"?(t.keys.forEach(function(e){o("MAWDataSyncQueue").addSyncItem(t.type,{key:e,tableName:n})}),e):(e.results!=null?e.results.forEach(function(e){o("MAWDataSyncQueue").addSyncItem(t.type,{key:e,tableName:n,values:t.values})}):e.lastResult!=null&&o("MAWDataSyncQueue").addSyncItem(t.type,{key:e.lastResult,tableName:n,values:t.values}),e)})}}):r}function u(){return{create:function(t){try{return babelHelpers.extends({},t,{table:function(n){return s(t,n)}})}catch(n){var e=r("getErrorSafe")(n);return r("FBLogger")("messenger_web").catching(e).mustfix("Error applying DataSync Middleware, messages made during this session will not be properly synced to registered consumers"),t}},name:"MAWDataSyncMiddleware",stack:"dbcore"}}l.getDataSyncMiddleware=u}),98);
__d("MAWIndexedDb",["ExecutionEnvironment","FBLogger","MAWBridge","MAWCacheServiceMiddleware","MAWDataSyncMiddleware","MAWDbFactory","MAWDbMutationMiddleware","MAWDbProtocolMsgIdMiddleware","MAWDbSchema","MAWDexie","MAWLSDataSyncMiddleware","MAWLoadDbMigrationVersion","MAWMpsGating","MAWTransactor","MWFBLogger","asyncToGeneratorRuntime","cr:10181","cr:10182","cr:3527","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){e===void 0&&(e="idb");var t=o("MAWDbFactory").makeIDBFactory(e,"worker");function a(e){return t.setupPromise().then(function(){return t.getDBExn(e)})}return babelHelpers.extends({},t,{getSignalDB:a,makeDB:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,a,i){var l=[o("MAWDbMutationMiddleware").getMAWDbMutationMiddleware];return o("MAWMpsGating").isMpsMessageRendering()||l.push(o("MAWLSDataSyncMiddleware").getMAWLSDataSyncMiddleware),r("gkx")("1760")&&l.push(o("MAWDbProtocolMsgIdMiddleware").MAWDbProtocolMsgIdMiddleware),l.push(r("MAWCacheServiceMiddleware")),a.enableDataSyncMiddleware&&l.push(o("MAWDataSyncMiddleware").getDataSyncMiddleware),n("cr:3527")!=null&&l.push(n("cr:3527")),r("justknobx")._("4087")&&(yield r("MAWLoadDbMigrationVersion")(e)),t.makeDB(e,{autoOpen:!0,middleware:l,onDbPopulate:a.onDbPopulate},i)});function a(t,n,r){return e.apply(this,arguments)}return a})()})}var c=u(),d="idle",m=c.isNewDb,p=c.willSetupDB,_=function(t,n,r){return c.makeDB(t,n,r).then(function(){d="ready"})},f=c.closeDB,g=c.getDBExn,h=c.getSignalDB,y=c.getDB,C=function(t){return c.reset_singleton_INTERNAL_ONLY()},b=c.deleteDb;function v(){return d}function S(e){var t=d;return d="migrating",e.finally(function(){d=t})}var R=new WeakMap,L=new WeakMap,E=o("MWFBLogger").MWLogger().tags(["db","afterTransaction"]);function k(e){var t=r("MAWDexie").currentTransaction;if(t==null)throw E.mustfixThrow("afterTransactionEffect called outside of dexie transaction");if(typeof e=="function"){var n=R.get(t)||[];n.push(e),R.set(t,n),n.length===1&&t.on("complete",function(){var e=R.get(t)||[];e.forEach(function(e){e()}),R.delete(t)})}}function I(e){var t=r("MAWDexie").currentTransaction;if(t==null)throw E.mustfixThrow("afterTransaction called outside of dexie transaction","maw_db");var a=L.get(t);if(a!=null)a.push(e);else{var i=[e];L.set(t,i),t.on("complete",function(){L.delete(t),r("gkx")("5675")&&(s||(s=r("ExecutionEnvironment"))).isInMainThread&&n("cr:10182")!==null&&n("cr:10181")!==null?n("cr:10182").handleEvents(n("cr:10181").LSDatabaseSingleton,i):o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:i})})}}var T=new Set(["NewMsg","NewMsgs","MsgUpdated","NewMedia","NewMediaRange","MediaExpired","XMAShareExpired","DeleteMessagesOfThread","UpsertReaction","DeleteReaction","DeleteMessages","NewXMA","EditMsgHistoryAdded","MsgsStartCountdown","MsgClearCountdown","XMAShareTombstoned","NewReceiverFetchInfo","NewXMAs","NewPoll","RavenActionUpdate"]);function D(t,n){if(n!==!0&&o("MAWMpsGating").isMpsMessageRendering()&&T.has(t.tag)){r("FBLogger")("wmi").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[MpsMessageRendering] Ignoring afterTxn event: ",""])),t.tag);return}if(t.tag==="UpdateThreadActivity"&&r("FBLogger")("wmi").mustfix("Thread consistency uses MAW DB mechanism instead of new one"),t.tag==="ThreadUpdated")try{var a=t.value.snippetContactIDs;a!=null&&a.some(function(e){return e==="Facebook User"})&&(E.mustfix('Something is still setting a contact id as "Facebook User"'),t.value=babelHelpers.extends({},t.value,{snippetContactIDs:a.map(function(e){return e==="Facebook User"?"0":e})}))}catch(e){}I(t)}function x(e,t){var n=r("MAWDexie").currentTransaction;if(n==null)throw E.mustfixThrow("afterTransactionForThreadEvent called outside of dexie transaction","maw_db");n.on("complete",function(){o("MAWBridge").getBridge().fireAndForget("threadEvent",t,e)})}l.TABLES_TO_ENCRYPT=o("MAWDbSchema").TABLES_TO_ENCRYPT,l.makeMsgrTransactor=o("MAWTransactor").makeMsgrTransactor,l.makeMAWIndexedDBFactory=u,l.isNewDb=m,l.willSetupDB=p,l.makeDB=_,l.closeDB=f,l.getDBExn=g,l.getSignalDB=h,l.getDB=y,l.setDB_INTERNAL_USE_ONLY=C,l.deleteDb=b,l.getDbStatus=v,l.updateStatusDuringMigration=S,l.afterTransactionEffect=k,l.afterTransaction=D,l.afterTransactionThreadEvent=x}),98);
__d("MAWDbAppMeta",[],(function(t,n,r,o,a,i){"use strict";var e={allowSecurityAlert:"allowSecurityAlert",allowSecurityAlertForSelf:"allowSecurityAlertForSelf",dbMigrationVersion:"dbMigrationVersion",deviceJid:"deviceJid",hasMigratedFromDexie:"hasMigratedFromDexie",hmacKey:"hmacKey",hotlikeSticker:"hotlikeSticker",isBackfilledForOccamadillo:"isBackfilledForOccamadillo",msgTypeVersion:"msgTypeVersion",restoreMigrationAttempts:"restoreMigrationAttempts",restoreToDexieMigrationComplete:"restoreToDexieMigrationComplete"};i.AppMetaKeysEnum=e}),66);
__d("MAWLoadDbMigrationVersion",["ExecutionEnvironment","MAWBridge","MAWCurrentUser","MAWDBMigrationUtils","MAWDbAppMeta","MAWDbObjEncryption","MAWIndexedDbMetadata","MAWUnrecoverableDbErrors","MWFBLogger","Promise","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("MWFBLogger").MWLogger().tags(["db","MAWLoadDbMigrationVersion"]);function h(t){var a=o("MAWCurrentUser").getID(),i=o("MAWIndexedDbMetadata").dbName(a);return new(f||(f=n("Promise")))(function(n){if(!indexedDB){n();return}var a=indexedDB.open(i);a.onupgradeneeded=function(t){t.target.transaction.abort();var r=t.target.result;g.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] "," onupgradeneeded - closing db"])),i),r==null||r.close(),n()},a.onsuccess=function(e){var a=e.target.result;if(a==null){n();return}try{var i=a.transaction("appMeta","readonly");i.onerror=function(e){var t;g.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Transaction error: ",""])),(t=e.target.error)==null?void 0:t.message),a.close(),n()};var l=i.objectStore("appMeta"),m=l.get(o("MAWDbAppMeta").AppMetaKeysEnum.dbMigrationVersion);m.onerror=function(e){var t;g.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Request error: ",""])),(t=e.target.error)==null?void 0:t.message),a.close(),n()},m.onsuccess=function(e){a.close();var i=e.target.result;if(i!=null)try{var l=o("MAWDbObjEncryption").decryptDbObj(babelHelpers.extends({},i),"appMeta",t),s=l.value.dbMigrationVersion;s!=null&&(o("MAWDBMigrationUtils").mawDbMigrationVersion.version=s)}catch(e){var u=r("getErrorSafe")(e);g.catching(u).MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Failed to decrypt appMeta row"]))),(_||(_=r("ExecutionEnvironment"))).isInWorker&&o("MAWBridge").getBridge().fireAndForget("event","unrecoverableDbError",{error:new(o("MAWUnrecoverableDbErrors")).EarRuntimeError})}n()}}catch(e){var p=r("getErrorSafe")(e);g.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] Error accessing appMeta: ",""])),p.message),a.close(),n()}},a.onerror=function(e){var t;g.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] "," error ",""])),i,e==null||(t=e.target)==null||(t=t.error)==null?void 0:t.message),n()},a.onblocked=function(e){var t=e.target.result;g.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[MAWLoadDbMigrationVersion] "," blocked"])),i),t==null||t.close()}})}l.default=h}),98);
__d("MAWLLAMigrationUtils",["Random","gkx","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("652"),s=Math.max(e,10),u=s*10,c=new Map([["FTS",u]]);function d(e){if(r("gkx")("9340"))return 1;var t=c.get(e);return t!=null?t:s}function m(e,t){t===void 0&&(t={});var n=d(e);return e==="debug"||e==="test"?[]:r("gkx")("23956")&&o("Random").coinflip(n)?[r("qpl")._(1056839327,"560"),babelHelpers.extends({double:{sampleRate:1/n},string:{transactor:e}},t)]:[]}l.getTransactorQPLParam=m}),98);
__d("MAWTransactor",["MAWDexie","MAWDexieTable","MAWErrorObject","MAWIndexedDb","MAWIndexedDbUI","MAWLLAMigrationUtils","MAWQplProxy","MAWTransactionMode","MWFBLogger","WAExceededStorageQuota","WALogger","gkx","performance"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=["MWPTransactor"],d=o("MWFBLogger").MWLogger();function m(t,n,a,i,l,s){return i!=null&&r("MAWDexie").currentTransaction!=null&&i.endFail("invoked_in_nested_transaction",{string:{current_transaction_mode:r("MAWDexie").currentTransaction.mode},string_array:{current_transaction_store_names:r("MAWDexie").currentTransaction.storeNames}}),r("MAWDexie").currentTransaction!=null&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["makeMsgrTransactor "," should not be called inside another transaction. The transaction will be forced to execute on top-level"])),l),t.transact(n,a,s)}function p(e){var t=o("MAWLLAMigrationUtils").getTransactorQPLParam(e),n=t.length===2?t:[null,void 0],r=n[0],a=n[1];return r!=null?o("MAWQplProxy").startQplUserFlow(r,a,{sendThroughBridge:!1}):null}function _(e,t,n,r){return C(e,t,function(e){return o("MAWIndexedDb").getDB(e)},n,r)}function f(e,t,n){return C(e,t,o("MAWIndexedDbUI").getDB,n)}function g(e,t,n){return C(e,t,o("MAWIndexedDbUI").getDB,n)}var h=0,y=new Map;function C(e,t,n,a,i){var l=Object.keys(e),_=l.some(function(t){return e[t]===o("MAWTransactionMode").READWRITE})?o("MAWTransactionMode").READWRITE:o("MAWTransactionMode").READONLY;return function(){for(var e=arguments.length,f=new Array(e),g=0;g<e;g++)f[g]=arguments[g];var C=p(t),S=null,R=function(){return self.clearInterval(S)};if(C!=null&&(C.addAnnotations({string:{mode:_===o("MAWTransactionMode").READWRITE?"readwrite":"readonly"},string_array:{stores:l}}),r("gkx")("1006")&&t==="bulkCreateThreadByJid")){var L=1e3,E=Date.now();S=self.setInterval(function(){C.addAnnotations({int:{heartbeatLatestAliveSinceStartMs:Date.now()-E}})},L),self.setTimeout(R,o("MAWQplProxy").DEFAULT_WORKER_QPL_TIMEOUT_MS)}var k=(u||(u=r("performance"))).now()+u.timeOrigin;return n(t).then(function(e){var n=Array.from(y.values());C==null||C.addPoint("lock_wait_start",{string_array:{maybeLockedOn:n}});var p=(u||(u=r("performance"))).now();return i==null||i.onTxnRequestedCb==null||i.onTxnRequestedCb.apply(i,f),m(e,_,l,C,t,function(){o("MAWDexieTable").setDexiePSDItem("transactionRequested",k),o("MAWDexieTable").setDexiePSDItem("transactorName",t),C==null||C.addPoint("dexie_transaction_start"),h+=1;var m=h;y.set(m,t);var _=C!=null?e.stores[l[0]].get("").then(function(){C==null||C.addPoint("lock_wait_end"),C==null||C.addPoint("transaction_opened"),C==null||C.addPoint("transactor_execution_start")}):o("MAWDexieTable").dexieResolve();return _.then(function(){return a(e.stores).apply(void 0,f)}).then(function(e){if(r("gkx")("6795")&&(i==null?void 0:i.explicitlyCloseTxn)===!0){var a;(a=r("MAWDexie").currentTransaction)==null||(a=a.idbtrans)==null||a.commit==null||a.commit()}y.delete(m),C==null||C.addPoint("transactor_execution_end"),C==null||C.endSuccess(),R();var l=(u||(u=r("performance"))).now()-p;return l>5e3&&(o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[Slow maw transaction] "," took ","ms to complete. Potentially waiting for locks on ",""])),t,l,n.join(", ")),d.mustfix("[Slow maw transaction] %s took long to complete. Potentially waiting for locks on $s",t,n.join(", "))),e}).catch(function(e){y.delete(m),o("WAExceededStorageQuota").checkQuotaExceededError(e);var n=e.name==="AbortError"?e==null?void 0:e.inner:null,r=b(n);if(C==null||C.markError("transaction_error",null,e),e instanceof Error){var a=e,i=typeof(a==null?void 0:a.stack)=="string"?a.stack:typeof(a==null?void 0:a.stack),l=typeof(a==null?void 0:a.message)=="string"?a.message:typeof(a==null?void 0:a.message);C==null||C.addAnnotations({string:{errMessage:l,errStack:i,innerError:r}})}C==null||C.endFail("transaction_fail"),R();var s=o("MAWErrorObject").getErrorObject(e);throw v(s).mustfixThrow("[%s] Error performing %s transaction. Inner error: %s",c.join("|"),t!=null?t:"",r!=null?r:"unknown")})})}).catch(function(e){o("WAExceededStorageQuota").checkQuotaExceededError(e),C==null||C.endFail("transaction_fail"),R();var n=o("MAWErrorObject").getErrorObject(e);throw v(n).mustfixThrow("[%s] Error performing %s transaction",c.join("|"),t!=null?t:"")})}}function b(e){if(typeof e=="string")return e;if(e instanceof Error)return e.name+": "+e.message;if(typeof e=="object")try{return JSON.stringify(e)}catch(e){}return null}function v(e){return e?d.catching(e):d}l.makeMsgrTransactor=_,l.makeMsgrUITransactor_IMPORT_FROM_MAWIndexedDbUI_INSTEAD=f,l.makeMsgrUIWritableTransactor=g}),98);
__d("MAWThreadUpdateType",[],(function(t,n,r,o,a,i){"use strict";var e=0,l=1,s=2,u=3,c=Object.freeze({BUMP_THREAD:s,MARK_THREAD_AS_UNREAD:u,NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:e,SNIPPET_ONLY:l});i.THREAD_UPDATE_TYPE=c}),66);
__d("MAWGetThreadUpdateTypeForAdminMsg",["FBLogger","MAWAdminMsgTypesGrouped","MAWLocalizationType","MAWThreadUpdateType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e;return t==null?(r("FBLogger")("messenger_web").mustfix("nullAdminType"),o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE):s(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:u(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:c(t)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:(d(t)||r("FBLogger")("messenger_web").mustfix("unsupportedAdminMsgType"),o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE)}function s(e){return o("MAWAdminMsgTypesGrouped").otherUserAddRemoveParticipant.includes(e)||o("MAWAdminMsgTypesGrouped").chatCustomizedByOtherUser.includes(e)||o("MAWAdminMsgTypesGrouped").callActionToNotifyAbout.includes(e)||o("MAWAdminMsgTypesGrouped").twoUsersConnected.includes(e)||o("MAWAdminMsgTypesGrouped").fallbackMsgFromOtherUser.includes(e)||o("MAWAdminMsgTypesGrouped").otherUserBumpsMessage.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeMarkedAsUnread.includes(e)||e===o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR}function u(e){return o("MAWAdminMsgTypesGrouped").currentUserAddRemoveParticipant.includes(e)||o("MAWAdminMsgTypesGrouped").chatCustomizedByCurrentUser.includes(e)||o("MAWAdminMsgTypesGrouped").callActionNotToNotifyAbout.includes(e)||o("MAWAdminMsgTypesGrouped").fallbackMsgFromCurrentUser.includes(e)||o("MAWAdminMsgTypesGrouped").currentUserBumpsMessage.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToBeBumped.includes(e)||o("MAWAdminMsgTypesGrouped").limitSharingUpdate.includes(e)}function c(e){return e===o("MAWLocalizationType").LOCALIZATION_TYPE.CUTOVER_ROLLBACK_ADMIN_MESSAGE||o("MAWAdminMsgTypesGrouped").dualThreadCutoverAdminMsgs.includes(e)||o("MAWAdminMsgTypesGrouped").ephemeralSettingChanges.includes(e)||o("MAWAdminMsgTypesGrouped").groupPermissionsChanged.includes(e)||o("MAWAdminMsgTypesGrouped").participantLeftGroup.includes(e)||o("MAWAdminMsgTypesGrouped").pinnedMessageUpdate.includes(e)}function d(e){return o("MAWAdminMsgTypesGrouped").cutoverAdminMsgs.includes(e)||o("MAWAdminMsgTypesGrouped").deviceChanges.includes(e)||o("MAWAdminMsgTypesGrouped").icdcAlerts.includes(e)||o("MAWAdminMsgTypesGrouped").otherNonAdminMsgToNotTriggerUpdate.includes(e)||e===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION||e===o("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET||e===o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG||e===o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_UK_OSA_ADMIN_MESSAGE}l.getThreadUpdateTypeForAdminMsg=e}),98);
__d("MAWGetThreadUpdateType",["FBLogger","MAWDbMsgOrReaction","MAWGetThreadUpdateTypeForAdminMsg","MAWThreadSnippetUtils","MAWThreadUpdateType","MAWUserJidWrapper","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.reaction==null;return u(e,t)}function s(e){return c(e.reactToAuthor)&&!c(e.author)}function u(e,t){return s(e)&&!t?e.senderTimestampMs==null?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE}function c(e){return e===o("WAJids").AUTHOR_ME||e===o("MAWUserJidWrapper").getMyUserJid()}function d(e){var t=e.adminType,n=e.author,a=e.msgType,i=e.xmaMessageType,l=function(t){var e=t.me,r=t.other;return o("WAJids").isAuthorMe(n)?e:r};switch(a){case"Text":case"ReceiverFetch":case"Sticker":case"Unavailable":case"Video":case"Futureproof":case"DocumentFile":case"EphemeralScreenshotAction":case"Gif":case"Image":case"Ptt":case"RavenAction":case"Raven":case"GroupPollCreate":case"GroupPollUpdate":case"BumpExistingMessage":return l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD});case"XMA":return o("MAWThreadSnippetUtils").shouldIgnoreXMAMsgForSnippet(i)?o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD});case"Revoked":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;case"DeleteForMe":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE;case"EditAction":return l({me:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY,other:o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE});case"GroupInvite":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"Admin":{if(a==="Admin")return o("MAWGetThreadUpdateTypeForAdminMsg").getThreadUpdateTypeForAdminMsg(t);throw r("FBLogger")("messenger_web").mustfixThrow("Non-admin msg passed in "+(a!=null?a:"UNKNOWN"))}case"SenderKeyDistribution":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE;case"AlertICDC":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"Ciphertext":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD;case"EphemeralSettingAdmin":case"EphemeralSettingChangeFromCurrentDevice":case"EphemeralSyncResponse":return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWGetThreadUpdateType] Unexpected message type: %s",a!=null?a:"UNKNOWN")}}function m(t){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstoredNullish(t,{forMessage:function(t){var e;return d({adminType:(e=t.msgContent)==null?void 0:e.adminType,author:t.author,msgType:t.type,xmaMessageType:t.xmaMessageType})},forNull:function(){return o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE},forReaction:function(n){return e(n)}})}function p(e){var t=m(e);switch(t){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:return!1;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return!0;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate][snippet] Unhandled threadUpdateType: "+t)}}function _(e){var t=m(e);switch(t){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:return!1;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return!0;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate][bump] Unhandled threadUpdateType: "+t)}}l.getThreadUpdateTypeForReaction=e,l.canReactionAffectBump=s,l.getReactionThreadUpdateType=u,l.getThreadUpdateTypeForMsg=d,l.getThreadUpdateTypeForMsgOrReaction=m,l.isThreadUpdateTypeEligibleForSnippet=p,l.isThreadUpdateTypeEligibleForBump=_}),98);
__d("MAWCacheServiceMiddleware",["FBLogger","MAWIndexedDb","MAWMpsGating","MAWWorkerCacheServices","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["messages","reactions"],s=["messages","reactions"];function u(e,t,n){var r,o,a=n.trans,i=(r=(o=a._transactorMeta)==null?void 0:o.mawCacheServiceAccumulatedRequests)!=null?r:[];if(n.type==="delete"&&s.includes(t.name))return p(e,t.name,n).then(function(e){var r=babelHelpers.extends({},n,{deletedValues:e});return i.push([t.name,r]),a._transactorMeta=babelHelpers.extends({},a._transactorMeta,{mawCacheServiceAccumulatedRequests:i}),t.mutate(n)});var l=babelHelpers.extends({},n,{decryptedValues:n.values?n.values:void 0});return i.push([t.name,l]),a._transactorMeta=babelHelpers.extends({},a._transactorMeta,{mawCacheServiceAccumulatedRequests:i}),t.mutate(n)}function c(e){var t,n=e.trans;((t=n._transactorMeta)==null?void 0:t.mawCacheServiceAfterTransactionScheduled)!==!0&&(o("MAWIndexedDb").afterTransactionEffect(function(){var e,t,r=(e=(t=n._transactorMeta)==null?void 0:t.mawCacheServiceAccumulatedRequests)!=null?e:[];r.length!==0&&o("MAWWorkerCacheServices").getMAWWorkerCacheServices().calculateDelta(r)}),n._transactorMeta=babelHelpers.extends({},n._transactorMeta,{mawCacheServiceAfterTransactionScheduled:!0}))}function d(t,n){var r=t.table(n);return!e.includes(n)||o("MAWMpsGating").isMpsSnippetsCacheServiceEnabled()?r:babelHelpers.extends({},r,{mutate:function(n){return c(n),u(t,r,n)}})}function m(){return{create:function(t){try{return babelHelpers.extends({},t,{table:function(n){return d(t,n)}})}catch(n){var e=r("getErrorSafe")(n);return r("FBLogger")("MAWCacheService").catching(e).mustfix("Error applying MAW Cache Service Middleware"),t}},name:"MAWCacheServiceMiddleware",stack:"dbcore"}}function p(e,t,n){var r=n.keys,o=n.trans;return e.table(t).getMany({keys:r,trans:o}).then(function(e){return e.filter(Boolean)})}l.default=m}),98);
__d("MAWVaultDb",["FBLogger","MAWQplProxy","MAWVault","getErrorSafe","gkx","isObject","isPlainObject","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=.001,s=new WeakMap;function u(e,t){return t[e]!=null}var c=r("gkx")("23909");function d(t,n,a){if(!r("isPlainObject")(t)||!c||!u(n,a)||t==null)return t;var i=s.get(t);if(i!=null)return i;var l=Math.random()<e?o("MAWQplProxy").startQplUserFlow(r("qpl")._(25301509,"119")):null;try{var d=a[n],m=p(t,d,o("MAWVault").vault);return l==null||l.endSuccess(),s.set(t,m),m}catch(e){l==null||l.endFail("vault_fail");var _=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").mustfixThrow("%s - Failed to vault an entity in the table: %s",_.message,n)}}function m(t,n,a){if(!r("isPlainObject")(t)||!c||!u(n,a)||t==null)return t;var i=Math.random()<e?o("MAWQplProxy").startQplUserFlow(r("qpl")._(741087294,"2028")):null;try{var l=p(t,a[n],o("MAWVault").unvault);return i==null||i.endSuccess(),l}catch(e){i==null||i.endFail("unvault_fail");var s=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").mustfixThrow("%s - Unvaulting failed for an entity in the table: %s",s.message,n)}}function p(e,t,n){if(e==null)return e;var o=Object.entries(t).filter(function(t){var n=t[0];return e[n]!=null});return o.length===0?e:o.reduce(function(e,t){var o=t[0],a=t[1];return typeof a!="boolean"&&r("isObject")(a)?e[o]=p(e[o],a,n):a===!0&&(e[o]=n(e[o])),e},babelHelpers.extends({},e))}l.vaultDbRow=d,l.unvaultDbRow=m,l.setInPath=p}),98);
__d("MAWVaultDefinitions",[],(function(t,n,r,o,a,i){"use strict";var e={editMsgHistory:{msgContent:{content:!0}},messages:{msgContent:{content:!0},quote:{content:{msgContent:{content:!0}}}},unrenderedMessages:{msgContent:!0}},l={edit_message_history:{messageContent:!0},messages:{replyMessageText:!0,text:!0},threads:{snippet:!0}};i.ARMADILLO_IDB_VAULT_DEFINITIONS=e,i.PERSISTED_DB_VAULT_DEFINITIONS=l}),66);
__d("isEncryptionAtRestEnabled",["isInstamadillo","qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("qex")._("507")===!0?!0:r("isInstamadillo")()}l.default=e}),98);
__d("MAWDbMiddlewareMutations",["MAWDbObjEncryption","MAWVaultDb","MAWVaultDefinitions","gkx","isEncryptionAtRestEnabled"],(function(t,n,r,o,a,i,l){"use strict";var e=r("gkx")("23909");function s(t,n,a){if(!e&&!(r("isEncryptionAtRestEnabled")()||r("gkx")("23910")))return t;var i=babelHelpers.extends({},t);return i=o("MAWVaultDb").unvaultDbRow(i,n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS),i=o("MAWDbObjEncryption").encryptDbObj(i,n,a),i}function u(t,n){return e?o("MAWVaultDb").unvaultDbRow(babelHelpers.extends({},t),n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS):t}function c(t,n,r){var a=o("MAWDbObjEncryption").decryptDbObj(babelHelpers.extends({},t),n,r);return e?o("MAWVaultDb").vaultDbRow(a,n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS):a}function d(t,n){if(t!=null)return e?o("MAWVaultDb").vaultDbRow(t,n,o("MAWVaultDefinitions").ARMADILLO_IDB_VAULT_DEFINITIONS):t}l.mutateValue=s,l.mutateVaultedValue=u,l.getValue=c,l.getVaultedValue=d}),98);
__d("MAWDbProtocolMsgIdMiddleware",["FBLogger","MAWDBMigrationUtils","MAWJidUtils","MAWODSProxy","Random","WAOdsEnums","getErrorSafe","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("3300");function s(t){return babelHelpers.extends({},t,{get:function(n){return t.get(n).then(function(e){return d(e,"get"),e})},getMany:function(n){return t.getMany(n).then(function(e){return e==null?void 0:e.map(function(e){return d(e,"getMany"),e})})},mutate:function(r){return r.type==="add"?r.values.map(function(e){return u(e)}):r.type==="put"&&r.values.map(function(t){t.protocolMsgId==null&&(o("MAWDBMigrationUtils").mawDbMigrationVersion.version>=o("MAWDBMigrationUtils").MAWDB_DEDUPE_MSGS_MIGRATION_VERSION?(o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.put_operation_after_migration_complete.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version}),u(t)):t.rowId<o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.cursorValue?(o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.put_operation_below_migration_cursor.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version}),u(t)):o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.isRunning&&t.rowId<o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.cursorValue+o("MAWDBMigrationUtils").mawDbDedupeMsgsMigrationStatus.batchSize&&(o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.put_operation_in_current_migration_batch.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version}),u(t)))}),t.mutate(r)},query:function(n){return t.query(n).then(function(e){var t;return e==null||(t=e.result)==null||t.map(function(e){d(e,"query")}),e})}})}function u(e){e.protocolMsgId=o("MAWJidUtils").toProtocolMsgIdStringForMAWStorage(e)}function c(e){return(e==null?void 0:e.rowId)==null&&(e==null?void 0:e.externalId)==null}function d(t,n){try{if(c(t)){n!=="get"&&o("Random").coinflip(e)&&r("FBLogger")("messenger_web").warn("Corrupted message row returned from DB, msg is null:%s, queryType: %s",t==null,n);return}(t==null?void 0:t.protocolMsgId)==null&&o("Random").coinflip(e)&&(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"null_protocol_msg_id.migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version+".append_protocol_msg_id_for_put_operation_jk_"+String(!0)}),o("MAWDBMigrationUtils").mawDbMigrationVersion.version>=o("MAWDBMigrationUtils").MAWDB_DEDUPE_MSGS_MIGRATION_VERSION&&r("FBLogger")("maw_db_migration").warn("Message with null protocolMsgId after the msg dedupe migration. type: %s, rowId: %s, externalId: %s",t==null?void 0:t.type,t==null?void 0:t.rowId,t==null?void 0:t.externalId)),t!=null&&t.protocolMsgId!=null&&t.protocolMsgId!==o("MAWJidUtils").toProtocolMsgIdStringForMAWStorage(t)&&o("Random").coinflip(e)&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_PROTOCOL_MSG_ID_INDEX,key:"inconsistent_protocol_msg_id."+(t==null?void 0:t.type)+".migration_version_"+o("MAWDBMigrationUtils").mawDbMigrationVersion.version+".append_protocol_msg_id_for_put_operation_jk_"+String(!0)})}catch(e){var a=r("getErrorSafe")(e);r("FBLogger")("messenger_web").catching(a).mustfix("Error while checking protocol msg id")}}function m(){return{create:function(t){try{return babelHelpers.extends({},t,{table:function(n){return n!=="messages"?t.table(n):s(t.table(n))}})}catch(n){var e=r("getErrorSafe")(n);return r("FBLogger")("messenger_web").catching(e).mustfix("Error applying Protocol MsgId Middleware"),t}},name:"MAWDbProtocolMsgIdMiddleware",stack:"dbcore"}}l.appendProtocolMsgId=u,l.isCorruptedMsgRow=c,l.MAWDbProtocolMsgIdMiddleware=m}),98);
__d("MAWLSDataSyncMiddleware",["FBLogger","MAWBridge","MAWLSEditMsgHistoryAddedDataSyncHandler","MAWLSMsgsDataSync","MAWLSReactionsDataSyncHandler","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(){var t=new Set;t.add(o("MAWLSReactionsDataSyncHandler").mawLSReactionsDataSyncHandler),t.add(o("MAWLSEditMsgHistoryAddedDataSyncHandler").mawLSEditHistoryDataSyncHandler),t.add(o("MAWLSMsgsDataSync").mawLSMsgsDataSyncHandler),t.forEach(function(t){e.set(t.tableName,t)})}function u(t){return babelHelpers.extends({},t,{mutate:function(r){var n=e.get(t.name);return n!=null?n.performAndSyncMutation(r,t):t.mutate(r)}})}function c(){return s(),{create:function(n){try{return babelHelpers.extends({},n,{table:function(r){return e.has(r)?u(n.table(r)):n.table(r)}})}catch(e){var t=r("getErrorSafe")(e);return r("FBLogger")("maw_db").catching(t).mustfix("Error applying MAW to LS data sync middleware"),n}},name:"MAWLSDataSyncMiddleware",stack:"dbcore"}}function d(e){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[e]})}l.getMAWLSDataSyncMiddleware=c,l.syncToLS=d}),98);
__d("MAWLSEditMsgHistoryAddedDataSyncHandler",["MAWIndexedDb","MAWLSDataSyncMiddleware"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.map(function(e){return babelHelpers.extends({},e)});o("MAWLSDataSyncMiddleware").syncToLS({tag:"EditMsgHistoryAdded",value:t})}var s={performAndSyncMutation:function(n,r){switch(n.type){case"put":case"add":{var t=[].concat(n.values);o("MAWIndexedDb").afterTransactionEffect(function(){return e(t)})}break}return r.mutate(n)},tableName:"editMsgHistory"};l.mawLSEditHistoryDataSyncHandler=s}),98);
__d("MAWBridgeTypesCreators",["FBLogger","MAWAudioUtils","MAWDbMsg","MAWImageUtils","MAWMsgType","MAWUserJidWrapper","WAJids","WAMediaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{threadJid:e}}function s(e){var t,n=e.ts;switch(e.type){case o("MAWMsgType").MSG_TYPE.REVOKED:n=(t=e.originalTs)!=null?t:e.ts;break;default:n=o("MAWDbMsg").getCanonicalTsFromMsg(e)}return{msgId:e.msgId,ts:n}}function u(e,t){var n=t.map(s);return{messages:n,threadJid:e}}function c(e){return{ravenMsgId:e.msgId,threadJid:e.threadJid}}function d(e,t){return e.filter(function(e){return t===e.threadJid}).map(function(e){return e.msgId})}function m(e){var t,n,a,i,l,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R=e.chatJid,L=e.filteredMsgIds,E=e.hasMediaForUI,k=e.hdTypes,I=e.media,T=e.offlineAttachmentId,D=e.ravenSettings,x=e.sortOrderMs,$=e.transportKey;switch(I.mediaType){case"Image":return{duration:null,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,hasMedia:E,hasPreviewMedia:((t=I.validatedImageInfo)==null?void 0:t.jpegThumbnail)!=null,hdTypes:k,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(n=I.validatedImageInfo)==null?void 0:n.jpegThumbnailHeight,previewHeightLarge:(a=I.validatedImageInfo)==null?void 0:a.height,previewWidth:(i=I.validatedImageInfo)==null?void 0:i.jpegThumbnailWidth,previewWidthLarge:(l=I.validatedImageInfo)==null?void 0:l.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Video":return{duration:((s=I.validatedVideoInfo)==null?void 0:s.duration)!=null?((u=I.validatedVideoInfo)==null?void 0:u.duration)*1e3:0,ephemeralMediaState:D==null?void 0:D.ephemeralMediaState,ephemeralMediaViewMode:D==null?void 0:D.ephemeralMediaViewMode,filesize:I.size,gifPlayback:((c=I.validatedVideoInfo)==null?void 0:c.gifPlayback)===!0||I.isVideoGif===!0,hasMedia:E,hasPreviewMedia:((d=I.validatedVideoInfo)==null?void 0:d.jpegThumbnail)!=null,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(m=I.validatedVideoInfo)==null?void 0:m.jpegThumbnailHeight,previewHeightLarge:(p=I.validatedVideoInfo)==null?void 0:p.height,previewWidth:(_=I.validatedVideoInfo)==null?void 0:_.jpegThumbnailWidth,previewWidthLarge:(f=I.validatedVideoInfo)==null?void 0:f.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Ptt":return{duration:(g=I.validatedAudioInfo)!=null&&g.duration?I.validatedAudioInfo.duration*1e3:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts),waveformData:((h=I.validatedAudioInfo)==null?void 0:h.waveform)!=null?o("MAWAudioUtils").serializeWaveform(I.validatedAudioInfo.waveform):void 0};case"Gif":return{accessibilitySummaryText:(y=I.accessibilitySummaryText)!=null?y:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:(C=I.validatedImageInfo)==null?void 0:C.jpegThumbnailHeight,previewHeightLarge:(b=I.validatedImageInfo)==null?void 0:b.height,previewWidth:(v=I.validatedImageInfo)==null?void 0:v.jpegThumbnailWidth,previewWidthLarge:(S=I.validatedImageInfo)==null?void 0:S.width,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)};case"Sticker":{var P,N,M,w=o("MAWImageUtils").boundHeightWidth((P=I.validatedImageInfo)==null?void 0:P.jpegThumbnailHeight,(N=I.validatedImageInfo)==null?void 0:N.jpegThumbnailWidth,o("MAWImageUtils").STICKER_THUMBNAIL_MAX_SIZE),A=w.height,F=w.width;return{accessibilitySummaryText:(M=I.accessibilitySummaryText)!=null?M:void 0,duration:null,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:I.msgIds,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:A,previewHeightLarge:A,previewWidth:F,previewWidthLarge:F,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}case"DocumentFile":{var O,B={};for(var W of I.mediaEntries){var q=W[0],U=W[1],V=o("WAMediaUtils").mediaEntryDataToRawData(I.plaintextHash,U),H=V.filename;H!=null&&(B[q]=H)}return{defaultFilename:(O=I.validatedDocumentFileInfo)==null?void 0:O.filename,duration:null,filenames:B,filesize:I.size,hasMedia:E,mediaId:I.mediaId,mediaType:I.mediaType,msgIds:L,offlineAttachmentId:T,plaintextHash:I.plaintextHash,previewHeight:null,previewHeightLarge:null,previewWidth:null,previewWidthLarge:null,sortOrderMs:o("WATimeUtils").castToMillisTime(x!=null?x:I.ts*1e3),threadJid:R,transportKey:$,ts:o("WATimeUtils").castToUnixTime(x!=null?x/1e3:I.ts)}}default:throw I.mediaType,r("FBLogger")("messenger_web").mustfixThrow("[createBridgeMedia] Unsupported media type: "+I.mediaType)}}function p(e,t,n){return{chatJid:e,deliveredWatermarkTs:n!=null?n:o("WATimeUtils").castToUnixTime(0),fbid:t,lastReadActionTs:o("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0)}}function _(e){var t=e.cannotReplyReason,n=e.folder,r=e.snippetParams,o=e.snippetSenderContactId,a=e.snippetType,i=e.threadJid;return{cannotReplyReason:t,folder:n,snippetContactIDs:r==null?void 0:r.contactIDs,snippetMentionJIDs:r==null?void 0:r.mentionJIDs,snippetParams:r==null?void 0:r.strings,snippetSenderContactId:o,snippetType:a,threadJid:i}}function f(e){return{chatJid:e.groupJid,memberAddMode:e.memberAddMode,threadName:e.name}}var g={snippetContactIDs:[],snippetMentionJIDs:[],snippetParams:[],snippetSenderContactId:null,snippetType:null};function h(e){var t,n=e.bumpTimestampMs,r=e.description,o=e.isMessageAuthorMe,a=e.isUnbump,i=e.skipBumpTimestampValidation,l=e.skipServerThreadBump,s=e.snippetData,u=e.threadJid,c=s==null?g:{snippetContactIDs:s.params.contactIDs,snippetMentionJIDs:(t=s.params.mentionJIDs)!=null?t:[],snippetParams:s.params.strings,snippetSenderContactId:s.senderContactId,snippetType:s.type};return babelHelpers.extends({},c,{bumpTimestampMs:n,description:r,isMessageAuthorMe:o,isUnbump:a,skipBumpTimestampValidation:i!=null?i:!1,skipServerThreadBump:l!=null?l:!1,threadJid:u})}function y(e){var t=e.author,n=e.chatJid,r=e.reaction,a=e.reactToMsgId,i=e.ts;return{actorId:o("WAJids").authorToUserId(t,o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid())),chatJid:n,messageId:a,reaction:r,ts:i}}function C(e){var t=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),n=e.author,r=e.chatJid,a=e.reactToMsgId;return{actorId:o("WAJids").authorToUserId(n,t),chatJid:r,messageId:a}}function b(e){return{creationTs:e.creationTs,creator:e.creator,groupJid:e.groupJid,msgExpiration:e.msgExpiration,name:e.name,nameOwner:e.nameOwner,nameTs:e.nameTs,participantVersion:e.participantVersion}}function v(e){var t=e.threadJid,n=e.inviteeJid;return{caption:e.caption,inviteCode:e.inviteCode,inviteeId:n,inviteExpireTs:e.inviteExpirationTs,inviterId:o("WAJids").extractUserId(e.inviterJid),threadJid:t}}function S(e){return{threadJid:e}}function R(e,t,n){return{senderId:o("WAJids").extractUserId(t),state:n,threadJid:e}}l.createBridgeUpdateE2EEMetadataParticipants=e,l.createBridgeDeletedMessage=s,l.createBridgeDeleteMessages=u,l.createBridgeRavenAction=c,l.getMsgIdsFilteredByJid=d,l.createBridgeMedia=m,l.createBridgeReceivedReceipt=p,l.createBridgeUpdatedThread=_,l.createBridgeUpdatedGroupInfo=f,l.createBridgeBumpedThreadV2=h,l.createBridgeUpsertReaction=y,l.createBridgeDeleteReaction=C,l.createBridgeGroupInfo=b,l.createBridgeGroupInvite=v,l.createBridgeDeleteGroupInvite=S,l.createBridgeReceivedChatState=R}),98);
__d("MAWLSMsgsDataSync",["MAWBridgeTypesCreators","MAWIndexedDb","MAWLSDataSyncMiddleware"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=t.keys,r=t.trans;return e.getMany({keys:n,trans:r}).then(function(e){return e.filter(Boolean)})}function s(e){var t=e.reduce(function(e,t){var n,r=o("MAWBridgeTypesCreators").createBridgeDeletedMessage(t);return e.has(t.threadJid)||e.set(t.threadJid,[]),(n=e.get(t.threadJid))==null||n.push(r),e},new Map);t.entries().forEach(function(e){var t=e[0],n=e[1],r={messages:n,threadJid:t};o("MAWLSDataSyncMiddleware").syncToLS({tag:"DeleteMessages",value:r})})}var u={performAndSyncMutation:function(n,r){switch(n.type){case"delete":return e(r,n).then(function(e){return o("MAWIndexedDb").afterTransactionEffect(function(){return s(e)}),r.mutate(n)});default:return r.mutate(n)}},tableName:"messages"};l.mawLSMsgsDataSyncHandler=u}),98);
__d("MAWLSReactionsDataSyncHandler",["MAWBridgeTypesCreators","MAWIndexedDb","MAWLSDataSyncMiddleware"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.reaction,r=e.reactToMsgId,a=e.threadJid,i=e.ts;r!=null&&o("MAWLSDataSyncMiddleware").syncToLS({tag:"UpsertReaction",value:o("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:t,chatJid:a,reaction:n||"",reactToMsgId:r,ts:i})})}function s(e){var t=e.author,n=e.reactToMsgId,r=e.threadJid;n!=null&&o("MAWLSDataSyncMiddleware").syncToLS({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:r,reactToMsgId:n})})}function u(t){t.forEach(function(t){t.reaction==null?s(t):e(t)})}var c={performAndSyncMutation:function(t,n){switch(t.type){case"put":case"add":{var e=[].concat(t.values);o("MAWIndexedDb").afterTransactionEffect(function(){return u(e)})}break}return n.mutate(t)},tableName:"reactions"};l.mawLSReactionsDataSyncHandler=c}),98);
__d("MAWDbReaction",["FBLogger","I64","MAWAckLevel","MAWGetBumpTimestampMs","MAWUserJidWrapper","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){var t=e.author,n=e.reaction,r=e.reactToAuthor,a=o("MAWUserJidWrapper").getMyUserJid();return!(n==null||n===""||r!=="@me"&&r!==a||t==="@me"||t==="@system"||t===a)}function u(e){var t=o("MAWUserJidWrapper").getMyUserJid();if(e.reactToAuthor!=="@me"&&e.reactToAuthor!==t||e.reaction==null)return null;var n=e.author==="@me"||e.author==="@system"?null:e.author;return n==null?null:babelHelpers.extends({},e,{author:n,reaction:e.reaction,reactToAuthor:"@me"})}function c(e){var t=u(e);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot cast reaction to incomingDbReaction");return t}function d(e,t,n){var r=o("MAWUserJidWrapper").getMyUserJid();return e.find(function(e){return e.threadJid===t&&o("WAJids").authorToUserId(e.author,r)===o("WAJids").authorToUserId(n,r)})}function m(e){return e}function p(e,t,n,r,a,i,l,s,u,c,d,m,p){m===void 0&&(m=o("MAWAckLevel").ACK.clock);var _={ack:m,author:c,externalId:t,groupingKey:i,reaction:a,reactionId:n,reactToAuthor:l,reactToExternalId:r,reactToMsgId:s,senderTimestampMs:p,threadJid:e,ts:u};return d!=null?babelHelpers.extends({},_,{rowId:d}):_}function _(t){var n=o("MAWGetBumpTimestampMs").getBumpTimestampMs(t);return o("WATimeUtils").castToMillisTime((e||(e=o("I64"))).to_float(n))}l.isIncomingReaction=s,l.maybeCastToIncomingDbReaction=u,l.castToIncomingDbReaction=c,l.findMatchingReaction=d,l.reactionIdToMsgId=m,l.formatReactionForDb=p,l.getReactionTimeMs=_}),98);
__d("MAWThreadNewestMsgOrReactionUtils",["FBLogger","MAWDbMsg","MAWDbMsgTxns","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWGetThreadUpdateType","MAWODSProxy","MAWThreadUpdateType","WALogger","WAMsg","WAOdsEnums","WATimeUtils","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return _(e,t,u)}function u(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate] Unhandled threadUpdateType to create filter function : "+e)}}function c(e,t){return _(e,t,m)}function d(e){var t=e.db,n=e.jid,r=e.limit;return o("MAWDbMsgTxns").fetchMessagesFromDbWithSortOrderMs(t,n,null,!0,r,function(e){var t;return p(o("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg({adminType:(t=e.msgContent)==null?void 0:t.adminType,author:e.author,msgType:e.type,xmaMessageType:e.xmaMessageType}),e.ephemeralMsgDisappeared===!0)},"before")}function m(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCentralizedThreadUpdate] Unhandled threadUpdateType to create filter function : %s",e)}}function p(e,t){switch(e){case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.MARK_THREAD_AS_UNREAD:return t!==!0;case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.SNIPPET_ONLY:case o("MAWThreadUpdateType").THREAD_UPDATE_TYPE.BUMP_THREAD:return!1;default:throw r("FBLogger")("messenger_web").mustfixThrow("[MAWCacheService] Unhandled threadUpdateType to create filter function : %s",e)}}function _(t,n,r){var a=function(a){return a==null?o("MAWDexieTable").dexieResolve(null):g(t,n,r,a)};return f(t,n,r).then(function(t){return a(t).then(function(r){if(t==null&&r==null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[CentralizedThreadUpdate] No Reaction or Message in "," is eligible for snippet"])),n),null;if(r==null)return t;if(t==null)return r;var a=o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(t)),i=o("MAWDbReaction").getReactionTimeMs(r);return a>=i?t:r})})}function f(e,t,n){return o("MAWDbMsgTxns").fetchMessagesFromDbWithSortOrderMs(e,t,null,!0,1,function(e){var t;return n(o("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg({adminType:(t=e.msgContent)==null?void 0:t.adminType,author:e.author,msgType:e.type,xmaMessageType:e.xmaMessageType}),e.ephemeralMsgDisappeared===!0)},"before").then(r("first"))}function g(e,t,n,a){var i=o("MAWDbMsg").getSortOrderWithFallback(a),l=function(a,l){return o("MAWDbReactionsTxns").fetchReactionsFromDbWithTimestamp(e,t,o("WATimeUtils").castToMillisTime(i),l,l==null,a,function(e){return n(o("MAWGetThreadUpdateType").getThreadUpdateTypeForReaction(e),!1)&&o("MAWDbReaction").getReactionTimeMs(e)>i})},s=[1,10],u=100,c=new Set,d=function(n,a){var t;return l((t=s[n])!=null?t:u,a).then(function(t){var a=t.filter(function(e){return!c.has(C(e))});return a.length===0?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_THREAD_GET_NEWEST_REACTION_BATCH_NUM,key:"new."+n}),null):h(e,a).then(function(e){var a=e.newestReaction,i=e.nullMsgIds;return a!=null?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_THREAD_GET_NEWEST_REACTION_BATCH_NUM,key:"new."+n}),a):(i.forEach(function(e){return c.add(e)}),d(n+1,r("last")(t)))})})};return d(0,null)}function h(e,t){return o("MAWDbMsgTxns").getUniqueMsgsByProtocolMsgIds(e,t.map(y)).then(function(e){var n=new Set(e.map(b)),r=new Set,o=null;return t.forEach(function(e){var t=C(e);n.has(t)?o=v(o,e):r.add(t)}),{newestReaction:o,nullMsgIds:r}})}function y(e){return{author:e.reactToAuthor,chat:e.threadJid,externalId:e.reactToExternalId}}function C(e){return o("WAMsg").craftWAMsgIdString(y(e))}function b(e){return o("WAMsg").craftWAMsgIdString({author:e.author,chat:e.threadJid,externalId:e.externalId})}function v(e,t){return e==null?t:t==null||o("MAWDbReaction").getReactionTimeMs(e)>o("MAWDbReaction").getReactionTimeMs(t)?e:t}l.getNewestMsgOrReactionForBump=s,l.filterForBump=u,l.getNewestMsgOrReactionForSnippet=c,l.getNewestIncomingMsgsForSnippet=d,l.filterForSnippet=m,l.filterForSnippetNewestIncomingMessages=p,l.getNewestReactionToNonNullMsg=h}),98);
__d("MAWLocalizationUtils",["MAWAckLevel","MAWLocalizationType","MAWMsgType","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new Set([(e=o("MAWLocalizationType")).LOCALIZATION_TYPE.CURRENT_USER_CREATED_POLL,e.LOCALIZATION_TYPE.PARTICIPANT_CREATED_POLL,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,e.LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,e.LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,e.LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,e.LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,e.LOCALIZATION_TYPE.POLL_UNSENT_UPDATE]);function u(e,t,n,r,a,i){return{ack:o("MAWAckLevel").ACK.sent,altIndex:a!=null?a:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:n,msgContent:e,sortOrderMs:i,threadJid:t,ts:r!=null?r:o("WATimeUtils").unixTime(),type:o("MAWMsgType").MSG_TYPE.ADMIN}}function c(e){if(s.has(e))return!0;switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_NAMED_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SELF_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PROMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_DEMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_PROMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_GOT_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_PROMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_GOT_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PROMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SELF_DEMOTED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_DEMOTED_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_HOTLIKE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_THEME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CUSTOMIZE_PHOTO:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_PINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNPINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_HOTLIKE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_THEME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PHOTO:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_PINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNPINNED_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CUSTOMIZE_CURRENT_USER_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CLEAR_PARTICIPANT_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_OWN_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CLEAR_CURRENT_USER_NICKNAME:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_MINUTES:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_MINUTES:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_HOURS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_HOURS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_DAYS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_DAYS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_OFF:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_TURNED_ON_SECONDS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_SETTING_CHANGE_SECONDS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_TAKE_SCREENSHOT:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_EPHEMERAL_RECORD_SCREEN:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ADMIN_ONLY:case o("MAWLocalizationType").LOCALIZATION_TYPE.SERVER_SET_ADD_MODE_ALL_MEMBERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_UK_OSA_ADMIN_MESSAGE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_LIMIT_SHARING_DISABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_LIMIT_SHARING_ENABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LIMIT_SHARING_DISABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LIMIT_SHARING_ENABLED:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_OTHER_USER_NAME_UNKNOWN:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_SELF_THREAD:case o("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE_WITH_OTHER_USER_NAME:return!0}return!1}function d(e){switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE:return!0}return!1}function m(e){switch(e){case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_YOU_AND_MORE_THAN_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_ONE_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_REMOVED_MORE_THAN_TWO_USER:case o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_LEFT_GROUP:return!0}return!1}l.POLL_ADMIN_MSG_TYPES=s,l.buildUnstoredDbAdminMsg=u,l.isAdminMsgNormalized=c,l.isDeviceChangeAdminMsg=d,l.isParticipantChangeAdminMsg=m}),98);
__d("MAWThreadSnippetForAdminOrEphemeralMsg",["FBLogger","MAWAdminMsgNormalized","MAWLocalizationType","MAWLocalizationUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.adminMsgContent,n=e.adminType,a=e.snippetSenderContactId,i=n;if(i==null||t==null)return r("FBLogger")("GroupPollsE2EE").mustfix("MAWThreadSnippetForAdminOrEphemeralMsg: snippetType or adminMsgContent is null"),{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:a,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET};var l=o("MAWLocalizationUtils").isAdminMsgNormalized(i)?o("MAWAdminMsgNormalized").deconstructContactIdsFromAdminContent(i,t):{contactIds:[],contents:t},s=l.contactIds,u=l.contents;return{snippetParams:{contactIDs:[].concat(s.map(function(e){return e==="Facebook User"?"0":e})),strings:[].concat(u)},snippetSenderContactId:a,snippetType:i}}l.default=e}),98);
__d("MAWThreadSnippetForBumpExistingMessageMsg",["MAWLocalizationType","WAGlobals","WAJids","WALogger","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n){return{snippetParams:{contactIDs:n!=null?n:[],strings:[]},snippetSenderContactId:e,snippetType:t}}var m=function(t){return d(t,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)};function p(t){var n=t.author,r=t.replyAuthor,a=t.replyType,i=t.snippetSenderContactId;if(o("WAJids").isAuthorSystem(n))return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Bumped message can not have AUTHOR_SYSTEM"]))),m(i);var l=a;if(l===o("WAMsgType").UNAVAILABLE)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Bump message has unavailable content type"]))),m(i);var p=r;return p==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Bump message has no quoted author"]))),m(i)):o("WAJids").isAuthorMe(n)||n===o("WAGlobals").getMyUserJid()?o("WAJids").isAuthorMe(p)||p===o("WAGlobals").getMyUserJid()?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_OWN_MESSAGE):d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE,[o("WAJids").userIdFromJid(p)]):i==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Bump message sender is null"]))),m(i)):o("WAJids").isAuthorMe(p)||p===o("WAGlobals").getMyUserJid()?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_CURRENT_USER_MESSAGE,[i]):p===n?d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_OWN_MESSAGE,[i]):d(i,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE,[i,o("WAJids").userIdFromJid(p)])}l.default=p}),98);
__d("MAWThreadSnippetForCiphertextMsg",["MAWLocalizationType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:e,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.USER_SEND_ENCRYPTED_MESSAGE_FALLBACK}}l.default=e}),98);
__d("MAWThreadSnippetForDocumentFileMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Document file message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForFallbackMessageMsg",["MAWLocalizationType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return{snippetParams:{contactIDs:n!=null?n:[],strings:[]},snippetSenderContactId:e,snippetType:t}}function s(t){var n=t.author,r=t.snippetSenderContactId,a=t.unsupportedType;if(o("WAJids").isAuthorMe(n))switch(a){case"liveLocationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LIVE_LOCATION_FALLBACK);case"locationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION_FALLBACK);case"contactShareMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE_FALLBACK);case"storyMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION_FALLBACK);case"postMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POST_MENTION_FALLBACK);case"pollCreationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POLL_CREATION_FALLBACK);case"bumpMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_BUMPED_MESSAGE);case"stickerReceiverFetchMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER_RECEIVER_FETCH_MESSAGE_FALLBACK);case"messengerMemory":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.MESSENGER_MEMORY_ENCRYPTED_MESSAGE_FALLBACK);default:return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}else switch(a){case"liveLocationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LIVE_LOCATION_FALLBACK);case"locationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION_FALLBACK);case"contactShareMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE_FALLBACK);case"storyMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION_FALLBACK);case"postMentionMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POST_MENTION_FALLBACK);case"pollCreationMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POLL_CREATION_FALLBACK);case"bumpMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_BUMPED_PARTICIPANT_MESSAGE);case"metaAiMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.META_AI_SEND_MESSAGE_FALLBACK);case"stickerReceiverFetchMessage":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER_RECEIVER_FETCH_MESSAGE_FALLBACK);case"messengerMemory":return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.MESSENGER_MEMORY_ENCRYPTED_MESSAGE_FALLBACK);default:return e(r,o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET)}}l.default=s}),98);
__d("MAWThreadSnippetForGifMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForImageMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Image message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForPttMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_AUDIO:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Ptt message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_AUDIO,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForRavenMsg",["MAWLocalizationType","MAWMsg","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.ravenMediaType,i=t.snippetSenderContactId,l=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,s={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?l=a===o("MAWMsg").MAWRavenMsgMediaType.IMAGE?o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_IMAGE:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:o("WAJids").isAuthorSystem(n)||i==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Animated message can not have AUTHOR_SYSTEM"]))):(l=a===o("MAWMsg").MAWRavenMsgMediaType.IMAGE?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_IMAGE:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,s.contactIDs.push(i)),{snippetParams:s,snippetSenderContactId:i,snippetType:l}}l.default=s}),98);
__d("MAWThreadSnippetForMsgUtils",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,i={contactIDs:[],mentionJIDs:n!=null?n:[],strings:[]};return o("WAJids").isAuthorMe(t)?a=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STICKER:o("WAJids").isAuthorSystem(t)||r==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Sticker message can not have AUTHOR_SYSTEM"]))):(a=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STICKER,i.contactIDs.push(r)),{snippetParams:i,snippetSenderContactId:r,snippetType:a}}l.getMAWThreadSnippetForStickerMsg=s}),98);
__d("MAWThreadSnippetForReceiverFetchMsg",["MAWThreadSnippetForMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.mentionedJids,r=e.snippetSenderContactId;return o("MAWThreadSnippetForMsgUtils").getMAWThreadSnippetForStickerMsg(t,n,r)}l.default=e}),98);
__d("MAWThreadSnippetForRevokedMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.mentionedJids,a=t.snippetSenderContactId,i=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,l={contactIDs:[],mentionJIDs:r,strings:[]};return o("WAJids").isAuthorMe(n)?i=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UNSENT_MESSAGE:o("WAJids").isAuthorSystem(n)||a==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Revoked message can not have AUTHOR_SYSTEM"]))):(i=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UNSENT_MESSAGE,l.contactIDs.push(a)),{snippetParams:l,snippetSenderContactId:a,snippetType:i}}l.default=s}),98);
__d("MAWThreadSnippetForStickerMsg",["MAWThreadSnippetForMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.author,n=e.mentionedJids,r=e.snippetSenderContactId;return o("MAWThreadSnippetForMsgUtils").getMAWThreadSnippetForStickerMsg(t,n,r)}l.default=e}),98);
__d("MAWThreadSnippetForTextMsg",["MAWLocalizationType","MAWVault","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.content,a=t.isGroup,i=t.mentionedJids,l=t.snippetSenderContactId,s=t.specialTextSize,u=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,c={contactIDs:[],mentionJIDs:i,strings:[]};if(o("WAJids").isAuthorMe(n)?u=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_TEXT:o("WAJids").isAuthorSystem(n)||l==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Text message can not have AUTHOR_SYSTEM"]))):(u=a?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT_IN_GROUP:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_TEXT,c.contactIDs.push(l)),r!=null)if(s===1||s===2||s===3){var d=o("MAWVault").unvault(r);c.strings.push(d==="\uD83D\uDC4D"?"(Y)":r)}else c.strings.push(r);return{snippetParams:c,snippetSenderContactId:l,snippetType:u}}l.default=s}),98);
__d("MAWThreadSnippetForVideoMsg",["MAWLocalizationType","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=t.author,r=t.gifPlayback,a=t.mentionedJids,i=t.snippetSenderContactId,l=r===!0,s=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,u={contactIDs:[],mentionJIDs:a,strings:[]};return o("WAJids").isAuthorMe(n)?s=l?o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_GIF:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_VIDEO:o("WAJids").isAuthorSystem(n)||i==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Video message can not have AUTHOR_SYSTEM"]))):(s=l?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_GIF:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_VIDEO,u.contactIDs.push(i)),{snippetParams:u,snippetSenderContactId:i,snippetType:s}}l.default=s}),98);
__d("MAWThreadSnippetForXMAMsg",["MAWLocalizationType","WAArmadilloXMA.pb","WAJids","WALogger","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N;function M(t){var n=t.author,a=t.chatJid,i=t.content,l=t.mentionedJids,M=t.snippetSenderContactId,A=t.xmaMessageType,F=o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET,O={contactIDs:[],mentionJIDs:l,strings:[]};switch(A==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["XMA message does not have xmaMessageType"]))),A){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.GEN_AI_RICH_RESPONSE:if(!r("gkx")("12661")){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet: ",""])),A);break}case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:if(o("WAJids").isAuthorMe(n))if(i!=null){var B=i;F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT,B!=null&&O.strings.push(B)}else F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_ATTACHMENT;else if(o("WAJids").isAuthorSystem(n)||M==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"])));else{F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_ATTACHMENT,O.contactIDs.push(M);var W=i;W!=null&&O.strings.push(W)}break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_POST_MENTION:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_POST_MENTION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_POST_MENTION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_MEMORIES_SHARE:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_MEMORIES_SHARE;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_STORY_MENTION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_STORY_MENTION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_LOCATION:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_LOCATION;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_CONTACT:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_AI_CONTACT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SEND_CONTACT_SHARE:F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SEND_CONTACT_SHARE;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_REEL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_REEL;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_PRIVATE_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_HIGHLIGHTS_TAB_FRIEND_UPDATES_REPLY:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_POST:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_POST;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_STORY_HIGHLIGHT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_STORY_HIGHLIGHT;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MENTIONED_STORY_IG;var q;if(a!=null&&(q=o("WAJids").interpretAsUserJid(a)),q!=null){var U=o("WAJids").userIdFromJid(q);O.contactIDs.push(U)}else o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["XMA story mentions must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)?o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_RECEIVED_STORY_MENTION_IG;break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_AUDIO_CALLED;var V=w(a);V!=null?O.contactIDs.push(V):o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_AUDIO_CALLED,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:if(o("WAJids").isAuthorMe(n)&&M!=null){F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_VIDEO_CALLED;var H=w(a);H!=null?O.contactIDs.push(H):o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_VIDEO_CALLED,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_AUDIO_CALL;var G=w(a);G!=null?O.contactIDs.push(G):o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_AUDIO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:if(o("WAJids").isAuthorMe(n)){F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MISSED_VIDEO_CALL;var z=w(a);z!=null?O.contactIDs.push(z):o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["RTC XMA must have a target Jid"])))}else o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MISSED_VIDEO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:o("WAJids").isAuthorMe(n)&&M!=null?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_AUDIO_CALL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_AUDIO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:o("WAJids").isAuthorMe(n)&&M!=null?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_STARTED_GROUP_VIDEO_CALL:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR($||($=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_STARTED_GROUP_VIDEO_CALL,O.contactIDs.push(M));break;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:o("WAJids").isAuthorMe(n)?F=o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_SENT_EVENT:o("WAJids").isAuthorSystem(n)||M==null?o("WALogger").ERROR(P||(P=babelHelpers.taggedTemplateLiteralLoose(["XMA message can not have AUTHOR_SYSTEM"]))):(F=o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_SENT_EVENT,O.contactIDs.push(M));break;default:o("WALogger").ERROR(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Encountered unexpected XMAMessageType when building a thread snippet: ",""])),A)}return{snippetParams:O,snippetSenderContactId:M,snippetType:F}}function w(e){var t=e!=null?o("WAJids").interpretAsUserJid(e):null;return t!=null?o("WAJids").userIdFromJid(t):null}l.default=M}),98);
__d("MAWThreadSnippet",["FBLogger","MAWLocalizationType","MAWMsgType","MAWThreadSnippetForAdminOrEphemeralMsg","MAWThreadSnippetForBumpExistingMessageMsg","MAWThreadSnippetForCiphertextMsg","MAWThreadSnippetForDocumentFileMsg","MAWThreadSnippetForFallbackMessageMsg","MAWThreadSnippetForGifMsg","MAWThreadSnippetForImageMsg","MAWThreadSnippetForPttMsg","MAWThreadSnippetForRavenMsg","MAWThreadSnippetForReceiverFetchMsg","MAWThreadSnippetForRevokedMsg","MAWThreadSnippetForStickerMsg","MAWThreadSnippetForTextMsg","MAWThreadSnippetForVideoMsg","MAWThreadSnippetForXMAMsg","MAWUserJidWrapper","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return/^\d+$/.test(e)}function s(t){if(!o("WAJids").isAuthorSystem(t)){var n=o("WAJids").isAuthorMe(t)?o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid()):o("WAJids").userIdFromJid(t);if(!e(n)){r("FBLogger")("messenger_web").mustfix("[MAWThreadSnippetBuildTxns] Snippet sender contact id is invalid");return}return n}}function u(e){var t=e.adminMsgContent,n=e.adminType,a=e.author,i=e.chatJid,l=e.content,u=e.gifPlayback,c=e.mentionedJids,d=e.msgType,m=e.ravenMediaType,p=e.replyAuthor,_=e.replyType,f=e.specialTextSize,g=e.unsupportedType,h=e.xmaMessageType,y=o("WAJids").switchOnMsgrChatJidType(i,{group:function(t){return!0},user:function(t){return!1}}),C=s(a);switch(d){case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return r("MAWThreadSnippetForCiphertextMsg")(C);case o("MAWMsgType").MSG_TYPE.TEXT:return r("MAWThreadSnippetForTextMsg")({author:a,content:l,isGroup:y,mentionedJids:c,snippetSenderContactId:C,specialTextSize:f});case o("MAWMsgType").MSG_TYPE.IMAGE:return r("MAWThreadSnippetForImageMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.VIDEO:return r("MAWThreadSnippetForVideoMsg")({author:a,gifPlayback:u,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.PTT:return r("MAWThreadSnippetForPttMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return r("MAWThreadSnippetForAdminOrEphemeralMsg")({adminMsgContent:t,adminType:n,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.GIF:return r("MAWThreadSnippetForGifMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.STICKER:return r("MAWThreadSnippetForStickerMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return r("MAWThreadSnippetForDocumentFileMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.REVOKED:return r("MAWThreadSnippetForRevokedMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.XMA:return r("MAWThreadSnippetForXMAMsg")({author:a,chatJid:i,content:l,mentionedJids:c,snippetSenderContactId:C,xmaMessageType:h});case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return r("MAWThreadSnippetForBumpExistingMessageMsg")({author:a,replyAuthor:p,replyType:_,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return r("MAWThreadSnippetForFallbackMessageMsg")({author:a,snippetSenderContactId:C,unsupportedType:g});case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return r("MAWThreadSnippetForReceiverFetchMsg")({author:a,mentionedJids:c,snippetSenderContactId:C});case o("MAWMsgType").MSG_TYPE.RAVEN:return r("MAWThreadSnippetForRavenMsg")({author:a,mentionedJids:c,ravenMediaType:m,snippetSenderContactId:C});default:return{snippetParams:{contactIDs:[],strings:[]},snippetSenderContactId:C,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.UNAVAILABLE_SNIPPET}}}l.getSnippetContactId=s,l.buildThreadSnippet=u}),98);
__d("WAProtocolMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.externalId===t.externalId&&e.author===t.author&&e.chat===t.chat}i.equals=e}),66);
__d("MAWThreadSnippetBuildTxns",["FBLogger","MAWDbMsg","MAWDbMsgOrReaction","MAWDbReaction","MAWDexieTable","MAWJidUtils","MAWLocalizationType","MAWThreadSnippet","MAWThreadSnippetUtils","MAWUserJidWrapper","WAJids","WAProtocolMsgId","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("WAJids").switchOnMsgrChatJidType(n,{group:function(r){return u(e,t,!0)},user:function(r){return u(e,t,!1)}})}function s(t,n){return o("MAWDbMsgOrReaction").switchOnMsgOrReactionMaybeUnstored(n,{forMessage:function(n){var e,r,a,i,l,s,u;return o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(e=n.msgContent)==null?void 0:e.adminMsgContent,adminType:(r=n.msgContent)==null?void 0:r.adminType,author:n.author,chatJid:t,content:(a=n.msgContent)==null?void 0:a.content,mentionedJids:(i=n.msgContent)==null?void 0:i.mentionedJids,msgType:n.type,ravenMediaType:n.ravenMediaType,replyAuthor:(l=n.quote)==null?void 0:l.content.author,replyType:(s=n.quote)==null?void 0:s.content.type,specialTextSize:n.specialTextSize,unsupportedType:(u=n.msgContent)==null?void 0:u.subtype,xmaMessageType:n.xmaMessageType})},forReaction:function(n){var t=o("MAWDbReaction").castToIncomingDbReaction(n);return e(t.author,t.reaction,t.threadJid)}})}function u(e,t,n){var a;o("WAJids").isAuthorMe(e)?(r("FBLogger")("messenger_web").warn("[MAWThreadSnippetBuildTxns] Reaction snippet author should not be @me"),a=o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid())):a=o("WAJids").userIdFromJid(e);var i={contactIDs:[],strings:[]},l=n?o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE_IN_GROUP:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REACT_MESSAGE;return i.contactIDs.push(a),i.strings.push(t),{snippetParams:i,snippetSenderContactId:a,snippetType:l}}function c(e,t,n,r){var a,i=n.newestReaction,l=n.reactionsToClear;if(i!=null&&o("WATimeUtils").castUnixTimeToMillisTime(i.ts)>((a=t.snippetMsgTs)!=null?a:0))return o("MAWDexieTable").dexieResolve({newestReaction:i,thread:d(t,i,r)});var s=l!=null&&l.length>0;return s&&t.snippetMsg!=null?e.reactions.get({reactionId:t.snippetMsg}).then(function(n){var r=!1;if(n==null)r=!0;else{var a=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.reactToExternalId);a!=null&&(r=l.some(function(e){var t=o("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.reactToExternalId);return t!=null&&o("WAProtocolMsgId").equals(t,a)}))}return r?m(e,t).then(function(e){return{newestReaction:null,thread:e}}):o("MAWDexieTable").dexieResolve({newestReaction:null,thread:t})}):o("MAWDexieTable").dexieResolve({newestReaction:null,thread:t})}function d(e,t,n){return babelHelpers.extends({},e,{snippetMsg:t.reactionId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(t.ts)})}function m(e,t){return o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,t).then(function(e){if(e==null)return r("FBLogger")("messenger_web").mustfix("[Occamadillo] ThreadUpdated handler called for clear snippet when centralized thread bump is enabled"),babelHelpers.extends({},t,{snippetMsg:void 0,snippetMsgTs:void 0});var n=o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e));return babelHelpers.extends({},t,{snippetMsg:e.msgId,snippetMsgTs:n})})}function p(e,t){return m(e,t).then(function(t){return e.threads.put(t).then(r("emptyFunction"))})}l.buildReactionThreadSnippet=e,l.buildThreadSnippetForMsgOrIncomingReaction=s,l.getReactionSnippetParams=u,l.getThreadChangesetForReactionChanges=c,l.getThreadChangesetForNewReaction=d,l.refreshThreadSnippet=p}),98);
__d("MAWEphemeralMsgUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return function(t){return!e.has(t.msgId)&&t.ephemeralMsgDisappeared!==!0}}i.filterNonExpiredMsg=e}),66);
__d("MAWThreadSnippetUtils",["MAWDbReaction","MAWEphemeralMsgUtils","MAWJidUtils","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWThreadNewestMsgOrReactionUtils","MAWThreadSnippet","MAWThreadSnippetBuildTxns","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;if(d(e.xmaMessageType))return!0;var n=((t=e.msgContent)==null?void 0:t.adminType)!=null?o("MAWLocalizationUtils").isDeviceChangeAdminMsg(e.msgContent.adminType):!1;if(e.type!==o("MAWMsgType").MSG_TYPE.ADMIN)return!1;var r=e.msgContent.adminType;return r===o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG?!0:n}function s(t,n,r){return t.messages.where("[threadJid+sortOrderMs]").between([n.jid,Number.MIN_SAFE_INTEGER],[n.jid,Number.MAX_SAFE_INTEGER],!1,!1).filter(function(t){return(r==null||o("MAWEphemeralMsgUtils").filterNonExpiredMsg(r)(t))&&!e(t)}).reverse().first()}var u={snippetParams:{contactIDs:[],mentionJIDs:[],strings:[]},snippetSenderContactId:null,snippetType:o("MAWLocalizationType").LOCALIZATION_TYPE.EMPTY_SNIPPET};function c(e,t,n,r){return r==null||r.addPoint("fetching_from_db_from_scratch_"+(n!=null?n:0)+"_start"),o("MAWThreadNewestMsgOrReactionUtils").getNewestMsgOrReactionForSnippet(e,t).then(function(e){return r==null||r.addPoint("fetching_from_db_from_scratch_"+(n!=null?n:0)+"_end"),e==null?{snippet:u}:m(t,e)})}function d(e){return o("MAWXMAUtils").isXMAStoryReply(e)||o("MAWXMAUtils").isXMAMsgHighlightsTabFriendUpdatesReply(e)}function m(e,t){var n,r,a,i,l,s,c;if(t.reactionId!=null){var d=o("MAWDbReaction").maybeCastToIncomingDbReaction(t);return d==null?{snippet:u}:{snippet:o("MAWThreadSnippetBuildTxns").buildReactionThreadSnippet(d.author,d.reaction,e),snippetMsgOrReaction:t}}switch(t.type){case o("MAWMsgType").MSG_TYPE.XMA:{var m,p,_,f,g,h,y,C=o("MAWJidUtils").toProtocolMsgId(t);return C==null?{snippet:u}:{snippet:o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(m=t.msgContent)==null?void 0:m.adminMsgContent,adminType:(p=t.msgContent)==null?void 0:p.adminType,author:t.author,chatJid:t.threadJid,content:(_=t.msgContent)==null?void 0:_.content,mentionedJids:(f=t.msgContent)==null?void 0:f.mentionedJids,msgType:t.type,ravenMediaType:t.ravenMediaType,replyAuthor:(g=t.quote)==null?void 0:g.content.author,replyType:(h=t.quote)==null?void 0:h.content.type,specialTextSize:t.specialTextSize,unsupportedType:(y=t.msgContent)==null?void 0:y.subtype,xmaMessageType:t.xmaMessageType}),snippetMsgOrReaction:t}}default:return{snippet:o("MAWThreadSnippet").buildThreadSnippet({adminMsgContent:(n=t.msgContent)==null?void 0:n.adminMsgContent,adminType:(r=t.msgContent)==null?void 0:r.adminType,author:t.author,chatJid:t.threadJid,content:(a=t.msgContent)==null?void 0:a.content,mentionedJids:(i=t.msgContent)==null?void 0:i.mentionedJids,msgType:t.type,ravenMediaType:t.ravenMediaType,replyAuthor:(l=t.quote)==null?void 0:l.content.author,replyType:(s=t.quote)==null?void 0:s.content.type,specialTextSize:t.specialTextSize,unsupportedType:(c=t.msgContent)==null?void 0:c.subtype,xmaMessageType:t.xmaMessageType}),snippetMsgOrReaction:t}}}l.isDbMsgDisabledForThreadSnippet=e,l.recalculateSnippetFromScratch_EXPENSIVE=s,l.EMPTY_SNIPPET_DATA=u,l.getThreadSnippetFromScratch=c,l.shouldIgnoreXMAMsgForSnippet=d}),98);
__d("MAWDBMigrationUtils",["MAWDbAppMeta","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e={batchSize:0,cursorValue:0,isRunning:!1},s={version:0},u=o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY},"getMigrationVersion",function(e){return function(){return e.appMeta.get(o("MAWDbAppMeta").AppMetaKeysEnum.dbMigrationVersion).then(function(e){var t,n=(t=e==null?void 0:e.value.dbMigrationVersion)!=null?t:0;return s.version=n,n})}}),c=6;l.mawDbDedupeMsgsMigrationStatus=e,l.mawDbMigrationVersion=s,l.getMigrationVersion=u,l.MAWDB_DEDUPE_MSGS_MIGRATION_VERSION=c}),98);
__d("MAWBridgeReceiverFetchInfo",["WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r,o){var a=o.accessibilitySummaryText,i=o.mimetype,l=o.previewHeight,s=o.previewUrl,u=o.previewUrlExpirationTimestampMs,m=o.previewWidth,p=o.receiverFetchId,_=o.type;return{accessibilitySummaryText:a,mimetype:i,msgId:t,previewHeight:l,previewUrl:s,previewUrlExpirationTimestampMs:d(u),previewWidth:m,receiverFetchId:p,sortOrderMs:c(n,r),threadJid:e,type:_}}function u(e,t,n,r,o){var a=o.mimetype,i=o.previewHeight,l=o.previewWidth,s=o.receiverFetchId,u=o.type;return{mimetype:a,msgId:t,previewHeight:i,previewWidth:l,receiverFetchId:s,sortOrderMs:c(n,r),threadJid:e,type:u}}function c(e,t){return o("WATimeUtils").castToMillisTime(e!=null?e:t*1e3)}function d(t){if(t!=null)try{return o("WATimeUtils").castLongIntToMillisTime(t)}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast previewUrlExpirationTimestampMs to millis time: ",""])),t);return}}l.createBridgeReceiverFetchInfoPayloadFromDbInfo=s,l.createBridgeReceiverFetchInfoPayloadFromUnstoredInfo=u}),98);
__d("MAWLoadReplyMediaTxns",["MAWBridgeReceiverFetchInfo","MAWDbMedia","MAWDbMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWMediaUtils","MAWMsgType","MAWUserJidWrapper","MAWXMAUtils","MWPBumpEntityKey","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAResultOrError","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){if(r("gkx")("2419")&&n!=null){var a=o("MAWMediaUtils").genHMACPlaintextHash(n);return e.media.where("hashedPlaintextHash").equals(a).first()}else return e.media.get(t)}var g=new Set([(_=o("MAWDbMedia")).MEDIA_TYPE.IMAGE,_.MEDIA_TYPE.GIF,_.MEDIA_TYPE.PTT,_.MEDIA_TYPE.STICKER,_.MEDIA_TYPE.VIDEO,_.MEDIA_TYPE.DOCUMENT_FILE]);function h(e){var t;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.STICKER:t=e.validatedImageInfo;break;case o("MAWDbMedia").MEDIA_TYPE.VIDEO:t=e.validatedVideoInfo;break}var n=t||{},r=n.height,a=n.jpegThumbnailHeight,i=n.jpegThumbnailWidth,l=n.width;return{replyMediaPreviewHeight:a!=null?a:r,replyMediaPreviewWidth:i!=null?i:l}}function y(e){switch(e.type){case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return!0;case o("MAWMsgType").MSG_TYPE.XMA:return r("gkx")("9921")?!0:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(e.xmaMessageType)||o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType);case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("WAMsgType").NOTE_REPLY:case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case o("MAWMsgType").MSG_TYPE.RAVEN:return!1;default:return r("WAAssertUnreachable")(e.type)}}function C(t,n,r){if(n==null)return o("MAWDexieTable").dexieResolve();var a=f(t,n,r).then(function(e){if(e==null)return o("WAResultOrError").makeError("reply_media_not_found");if(!g.has(e.mediaType))return o("WAResultOrError").makeError("reply_media_type_unknown");var t=h(e),r=t.replyMediaPreviewHeight,a=t.replyMediaPreviewWidth;return n!=null&&e.plaintextHash==null&&o("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","load_reply_media_txns_for_reply_type_'unknown'}"),o("WAResultOrError").makeResult({replyMediaId:n,replyMediaPreviewHeight:r,replyMediaPreviewWidth:a,replyPlaintextHash:e.plaintextHash})});return a.then(function(t){if(t.success!==!0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media with id ",": ",""])),n,t.error);return}return t.value})}function b(e,t){var n=t.defaultPreviewMediaId;if(n==null)return o("MAWDexieTable").dexieResolve({replyXMAId:t.xmaId});var r=f(e,n).then(function(e){if(e==null)return o("WAResultOrError").makeError("reply_xma_media_not_found - "+t.targetType);if(!g.has(e.mediaType))return o("WAResultOrError").makeError("reply_xma_media_type_unknown");var n=h(e),r=n.replyMediaPreviewHeight,a=n.replyMediaPreviewWidth;return o("WAResultOrError").makeResult({replyMediaPreviewHeight:r,replyMediaPreviewWidth:a,replyPlaintextHash:e.plaintextHash,replyXMAId:t.xmaId})});return r.then(function(e){if(e.success!==!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unable to fetch reply media XMA with id ",": ",""])),t.xmaId,e.error);return}return e.value})}function v(e,t,n){var a,i,l;n===void 0&&(n=!1);var s=((a=t.quote)==null?void 0:a.content)||{},u=s.author,c=s.externalId,d=s.mediaId,m=s.msgId,p=s.plaintextHash,_=s.type,f=s.xmaMessageType;if(((i=t.quote)==null?void 0:i.content)==null||!y((l=t.quote)==null?void 0:l.content))return o("MAWDexieTable").dexieResolve();var g=t.threadJid,h=u===o("MAWUserJidWrapper").getMyUserJid(),b=h?o("WAJids").AUTHOR_ME:u;return(r("gkx")("9921")?_===o("MAWMsgType").MSG_TYPE.XMA:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(f))?S(e,o("MAWJidUtils").maybeToProtocolMsgId(b,g,c)):_===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?E(e,m):C(e,d,n?null:p)}function S(e,t){return t==null?o("MAWDexieTable").dexieResolve():o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(e,t).then(function(t){if(!(t==null||o("MAWXMAUtils").isXMAExpired(t.isTombstoned,t.targetExpiringAtSec)))return b(e,t)})}function R(e,t){var n=t.author,a=t.externalId,i=t.mediaId,l=t.plaintextHash,s=t.threadJid,u=t.type,c=t.xmaMessageType,d=r("gkx")("9921")?u===o("MAWMsgType").MSG_TYPE.XMA:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(c),m=u===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH;return!o("MAWDbMsg").isMediaMsg(t)&&!d&&!m?o("MAWDexieTable").dexieResolve():d?S(e,o("MAWJidUtils").maybeToProtocolMsgId(n,s,a)):m?L(e,t.receiverFetchId):C(e,i,l)}function L(e,t,n){return t==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing receiverFetchId for getReplyMediaForReceiverFetchWithReceiverFetchId"]))),o("MAWDexieTable").dexieResolve()):e.receiverFetchInfo.get({receiverFetchId:t}).then(function(e){if(e==null){o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing receiverFetchInfo for getReplyMediaForReceiverFetchWithReceiverFetchId"])));return}try{var t=o("MAWDbMedia").convertNumberToMediaId(parseInt(e.receiverFetchId,10));return n!=null&&o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(n.threadJid,n.msgId,n.sortOrderMs,n.ts,e)}),{replyMediaId:t,replyMediaPreviewHeight:e.previewHeight,replyMediaPreviewWidth:e.previewWidth}}catch(e){o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unable to convert receiver fetch id to media id: ",""])),e);return}})}function E(e,t){return t==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Missing msgId for getReplyMediaForReceiverFetch"]))),o("MAWDexieTable").dexieResolve()):e.messages.get({msgId:t}).then(function(t){if(t==null||t.type!==o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH||t.receiverFetchId==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Invalid msg for getReplyMediaForReceiverFetch with type: ",""])),t==null?void 0:t.type);return}return L(e,t.receiverFetchId,t)})}l.getMedia=f,l.MSG_MEDIA_TYPE=g,l.getImageAttributes=h,l.isMediaReplyContent=y,l.getReplyMediaForMsgQuote=v,l.getReplyMediaForMsg=R}),98);
__d("MAWDbChunkTxns",["MAWDexieTable","MAWMediaUtils","MAWODSProxy","MWFBLogger","WAErrorMessage","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbChunkTxns"]),m=function(t,n,r,a,i,l){l===void 0&&(l=0);var e=o("MAWMediaUtils").genHMACPlaintextHash(n);return p(t,n,e,r,a,i,l)},p=function(n,r,a,i,l,m,_){return _===void 0&&(_=0),n.chunk.where("hashedPlaintextHash").equals(a).first().then(function(t){var f={blobData:i,hashedPlaintextHash:a,isProgressivePreview:m!=null?m:void 0,mimetype:l,plaintextHash:r};if(t){_>0&&d.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Chunk found after retry for hashedPlaintextHash: ",""])),a);var g=m!==!0&&t.isProgressivePreview===!0;if(g){var h=babelHelpers.extends({},f,{chunkId:t.chunkId});return n.chunk.put(h).then(function(){return h})}else return t}return n.chunk.add(f).then(function(e){return babelHelpers.extends({},f,{chunkId:e})}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);if(_>0)throw d.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk for hashedPlaintextHash: ",". Error: ",""])),a,t),d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk after retry. Error: ",""])),t),e;return d.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to add chunk. Possible duplicate? Will attempt a retry. For hashedPlaintextHash: ",". Error: ",""])),a,t),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_CHUNK,key:"retry"}),p(n,r,a,i,l,m,_+1)})})},_=function(t,n){return t.chunk.where("hashedPlaintextHash").equals(n)},f=function(t,n){return _(t,n).count().then(function(e){return e>0})},g=function(t,n){return o("MAWDexieTable").dexieAll(n.map(function(e){return f(t,e).then(function(t){return[e,t]})})).then(function(e){return new Map(e)})},h=function(t,n){return _(t,n).first()},y=function(t,n){return t.chunk.where("hashedPlaintextHash").anyOf(n).toArray().then(function(e){return new Map(e.map(function(e){return[e.hashedPlaintextHash,e]}))})},C=function(t,n){var e=n.map(o("MAWMediaUtils").genHMACPlaintextHash);return t.chunk.where("hashedPlaintextHash").anyOf(e).toArray().then(function(e){return new Map(e.map(function(e){return[e.plaintextHash,e]}))})};function b(e,t){return e.chunk.bulkGet(t)}var v=function(t,n){var e=o("MAWMediaUtils").genHMACPlaintextHash(n);return t.chunk.get({hashedPlaintextHash:e})};l.getOrCreateMediaChunkWithPlaintextHash=m,l.getOrCreateMediaChunkWithHashedPlaintextHash=p,l.hasMediaChunk=f,l.hasMediaChunks=g,l.maybeGetChunkFromHash=h,l.maybeBulkGetChunksFromHash=y,l.maybeBulkGetChunksFromPlaintextHash=C,l.bulkGetChunks=b,l.maybeGetChunkByPlaintextHash=v}),98);
__d("MAWDbMediaTxns",["MAWDbMsg","MAWDexieTable","MAWMediaUtils","MAWMsgType","MAWODSProxy","WAHashUtils","WALogger","WAOdsEnums","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.media.get({mediaId:t})}function m(e,t){return t.length===0?o("MAWDexieTable").dexieResolve(new Map):e.media.bulkGet(t).then(function(e){return new Map(e.filter(Boolean).map(function(e){return[e.mediaId,e]}))})}function p(e,t){return e.media.where("hashedPlaintextHash").equals(t).first()}function _(e,t){var n=o("MAWMediaUtils").genHMACPlaintextHash(t);return p(e,n)}function f(e,t){var n=t.map(function(e){return o("MAWMediaUtils").genHMACPlaintextHash(e)});return g(e,n)}function g(e,t){return e.media.where("hashedPlaintextHash").anyOf(t).toArray()}function h(e,t){return t==null?o("MAWDexieTable").dexieResolve():y(e,t).then(function(n){var r=n==null?void 0:n.mediaId;return r!=null?e.media.get({mediaId:r}):e.media.get({objectId:t})})}function y(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.mediaBackup.get({objectId:t})}function C(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=e.mediaBackup.where("msgId").equals(t).toArray();return n}function b(t,n){var a=n.filter(o("MAWDbMsg").isMediaMsg);if(a.length===0)return o("MAWDexieTable").dexieResolve([]);o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[getMsgMediaPairFromMsgs] msgs: ",""])),a.map(function(e){return""+e.msgId}));var i=a.reduce(function(e,t){return t.mediaId==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: "," and msg type ",""])),t.msgId,t.type),e):e.set(t.mediaId,t)},new Map),l=Array.from(i.keys());return R(t,l).then(function(e){var t=[];return e.forEach(function(e){if(e==null)throw r("err")("Error missing media");var n=i.get(e.mediaId);if(n==null)throw r("err")("Error missing media");var a=o("MAWMediaUtils").genHMACPlaintextHash(e.plaintextHash);a!==e.hashedPlaintextHash&&(o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getMsgMediaPairFromMsgs] encountered mismatched hashedPlaintextHash for media. PlaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(e.plaintextHash)),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MEDIA_MISMATCH_HASHED_PLAINTEXT_HASH,key:"mismatch."+n.type})),t.push([n,e])}),t})}function v(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.filter(o("MAWDbMsg").isMediaMsg).map(function(e){var t=e.mediaId;if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["mediaId is null for media msg with msgId: ",""])),e.msgId),r("err")("mediaId is missing");return t});return R(e,n).then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function S(e,t){if(t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME||o("MAWDbMsg").isMediaMsg(t)){var n=t.mediaId;return n==null?t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult()):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing")):e.media.get(n).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}else return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult())}function R(e,t){return e.media.bulkGet(t)}function L(e,t){var n=t.previewMediaIds!=null?R(e,t.previewMediaIds):o("MAWDexieTable").dexieResolve(),r=t.headerMediaId!=null?e.media.get(t.headerMediaId):o("MAWDexieTable").dexieResolve(),a=t.faviconMediaId!=null?e.media.get(t.faviconMediaId):o("MAWDexieTable").dexieResolve(),i=t.defaultPreviewMediaId!=null?e.media.get(t.defaultPreviewMediaId):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([n,r,a,i]).then(function(e){var n=e[0],r=e[1],a=e[2],i=e[3];if(t.headerMediaId!=null&&r==null||t.faviconMediaId!=null&&a==null||n==null)return o("WAResultOrError").makeError("missing");var l=[];for(var s of n){if(s==null)return o("WAResultOrError").makeError("missing");l.push(s)}return o("WAResultOrError").makeResult({defaultPreview:i,favicon:a,header:r,previews:l})})}function E(e,t,n){var r=babelHelpers.extends({},t,n);return e.media.put(r)}l.maybeGetMediaFromMediaId=d,l.maybeBulkGetMediaFromMediaId=m,l.maybeGetMediaFromHashedPlaintextHash=p,l.maybeGetMediaFromPlaintextHash=_,l.maybeBulkGetMediaFromPlaintextHash=f,l.maybeBulkGetMediaFromHashedPlaintextHash=g,l.maybeGetMediaFromObjectId=h,l.maybeGetMediaBackupRowFromObjectId=y,l.maybeGetMediaBackupRowFromMsgId=C,l.getMsgMediaPairFromMsgs=b,l.getMediaFromMsgs=v,l.getAndCheckMediaFromMsg=S,l.bulkGetMedias=R,l.getMediaForXMA=L,l.updateMedia=E}),98);
__d("WAMsgMap",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e){var t=this;this.$1=new Map,e==null||e.forEach(function(e){var n=e[0],r=e[1];t.set(n,r)})}var t=e.prototype;return t.clear=function(){this.$1.clear()},t.delete=function(t){var e;(e=this.$1.get(t.externalId))==null||(e=e.get(t.author))==null||e.delete(t.chat)},t.get=function(t){var e;return(e=this.$1.get(t.externalId))==null||(e=e.get(t.author))==null?void 0:e.get(t.chat)},t.has=function(t){var e,n;return(e=(n=this.$1.get(t.externalId))==null||(n=n.get(t.author))==null?void 0:n.has(t.chat))!=null?e:!1},t.set=function(t,n){var e,r,o=(e=this.$1.get(t.externalId))!=null?e:new Map;this.$1.has(t.externalId)||this.$1.set(t.externalId,o);var a=(r=o.get(t.author))!=null?r:new Map;return o.has(t.author)||o.set(t.author,a),a.set(t.chat,n),this},t.keys=function(){var e=[],t=this.$1;for(var n of t.keys()){var r,o=(r=t.get(n))!=null?r:new Map;for(var a of o.keys()){var i,l=(i=o.get(a))!=null?i:new Map;for(var s of l.keys())e.push({externalId:n,author:a,chat:s})}}return e},t.entries=function(){var e=[],t=this.$1;for(var n of t.keys()){var r,o=(r=t.get(n))!=null?r:new Map;for(var a of o.keys()){var i,l=(i=o.get(a))!=null?i:new Map;for(var s of l.keys()){var u=l.get(s);u!=null&&e.push([{externalId:n,author:a,chat:s},u])}}}return e},t.values=function(){return this.entries().map(function(e){return e[1]})},e})();i.MsgMap=e}),66);
__d("MAWDbMsgUtil",["WAJids","WALogger","WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return t.reduce(function(t,n){var r=n.threadJid;return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Missing jid prevents adding message to array map"]))),t):n.author==="@system"?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Invalid author when converting msg array to map"]))),t):(t.set({author:n.author,chat:r,externalId:n.externalId},n),t)},new(o("WAMsgMap")).MsgMap)}function c(e){return o("WAJids").isAuthorSystem(e.author)||e.threadJid==null?null:{author:e.author,chat:e.threadJid,externalId:e.externalId}}l.convertMsgArrayToMap=u,l.getProtocolMsgIdFromDbMsg=c}),98);
__d("MAWDbUnrenderedMsgTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgUtil","MAWDexieTable","WAJids","WALogger","WAMsgMap","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=t.author,r=t.chat,a=t.externalId;return e.threads.get({jid:r}).then(function(t){return t==null?o("WAResultOrError").makeError("missing_thread_unrendered_msg"):m(e,a,r,n).then(function(e){return e==null?o("WAResultOrError").makeError("missing_unrendered_msg"):o("WAResultOrError").makeResult(e)})})}function d(e,t){var n=t.map(function(e){var t=e.externalId;return t});return e.unrenderedMessages.where("externalId").anyOf(n).toArray().then(function(e){var n=o("MAWDbMsgUtil").convertMsgArrayToMap(e),r=new(o("WAMsgMap")).MsgMap;return t.forEach(function(e){var t=n.get(e);t!=null&&r.set(e,t)}),r})}function m(e,t,n,r){return e.unrenderedMessages.where("externalId").equals(t).filter(function(e){return e.author===r&&e.threadJid===n}).first()}function p(e,t){return e+"_"+t}function _(e,t){var n=t.map(function(e){var t=e.externalId;return t}),r=Array.from(new Set(t.map(function(e){return e.chat})));return o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(r).toArray(),e.unrenderedMessages.where("externalId").anyOf(n).toArray()]).then(function(e){var n=e[0],r=e[1];if(r.length===0||n.length===0)return[];var o=new Map;return t.forEach(function(e){var t=e.author,n=e.chat,r=e.externalId,a=o.get(r)||new Set;a.add(p(t,n)),o.set(r,a)}),r.filter(function(e){var t=e.author,n=e.externalId,r=e.threadJid,a=o.get(n);return a!=null&&r!=null&&a.has(p(t,r))})})}function f(t,n,r){return g(t,[{ack:r,msgId:n}]).then(function(t){var n=t[0];return n==null?(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAckForUnrenderedMsg on non existing message"]))),null):n})}function g(e,t){var n=t.map(function(e){return e.msgId}),r=new Map;return t.forEach(function(e){return r.set(e.msgId,{ack:e.ack})}),e.unrenderedMessages.where("msgId").anyOf(n).toArray().then(function(t){if(t.length===0)return t;var n=[],a=[];return t.forEach(function(e){var t;if(e.author!==o("WAJids").AUTHOR_ME){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on incoming message"]))),n.push(e);return}if(e.ack>o("MAWAckLevel").ACK.clock){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck on sent message"]))),n.push(e);return}var i=(t=r.get(e.msgId))==null?void 0:t.ack;if(i==null)return null;var l=babelHelpers.extends({},e,{ack:i});i===o("MAWAckLevel").ACK.sent&&delete l.resendCount,a.push(l)}),e.unrenderedMessages.bulkPut(a).then(function(){return[].concat(a,n)})})}function h(e,t){var n=t.map(function(t){return e.unrenderedMessages.get({msgId:t})});return o("MAWDexieTable").dexieAll(n)}function y(e,t){return e.unrenderedMessages.where("msgId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.msgId);return t+1})}l.maybeGetUnrenderedMsgByProtocolMsgId=c,l.getUnrenderedMsgMapByProtocolMsgId=d,l.maybeGetUnrenderedMsgByExternalId=m,l.getUnrenderedMsgsByProtocolMsgId=_,l.updateSystemAckForUnrenderedMsg=f,l.bulkUpdateSystemAckForUnrenderedMsgs=g,l.getUnrenderedMsgsByMsgIds=h,l.getNextUnrenderedMsgIdNumberForThread=y}),98);
__d("MAWMessageSortOrderUtils",["I64","MAWDbMsg","MAWExtractMsFromExternalId","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(t){var n=t.revokedExternalId!=null?t.revokedExternalId:t.externalId;n==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["generateAuthoritativeMessageSortOrder called without ID"])));var r=(d||(d=o("I64"))).of_string_opt(n);if(t.serverTs==null){var a;if(t.sortOrderMs!=null)return t.sortOrderMs;r==null&&o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] ExternalId is not present"])));var i=r==null?null:o("MAWExtractMsFromExternalId").extractMsFromExternalId(r);return Math.floor((a=t.originalTs)!=null?a:o("MAWDbMsg").getCanonicalTsFromMsg(t))*1e3+(i!=null?i:0)}if(r!=null){var l=o("MAWExtractMsFromExternalId").extractMsFromExternalId(r);if(l!=null){var m=t.originalTs!=null?t.originalTs:t.serverTs;return Number(m)*1e3+l}else o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Timestamp bits in externalId not valid"])))}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] externalId is not a valid int64"])));return o("MAWDbMsg").getSortOrderWithFallback(t)}l.generateAuthoritativeMessageSortOrder=m}),98);
__d("WAArrayGroupBy",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){for(var n=new Map,r=0;r<e.length;r++){var o=t(e[r]),a=n.get(o);a==null?n.set(o,[e[r]]):a.push(e[r])}return Array.from(n.entries())}i.groupBy=e}),66);
__d("MAWDbMsgTxns",["EncryptedBackupsUtils","FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbMsg","MAWDbMsgUtil","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWMessageSortOrderUtils","MAWMsgType","MAWODSProxy","MAWTransactionMode","MAWTransactor","Random","WAArrayGroupBy","WAJids","WALogger","WAMsg","WAMsgMap","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction","gkx","justknobx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g;function h(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.messages.get({msgId:t})}function y(e,t){return e.messages.where("threadJid").equals(t).count().then(function(e){return e===0})}function C(e,t,n){return e.messages.where("threadJid").equals(t).filter(n).first().then(function(e){return e!=null})}function b(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).between([t,Number.MIN_SAFE_INTEGER],[t,Number.MAX_SAFE_INTEGER],n,r)}function v(e,t){return b(e,t,!1,!1).last()}function S(e,t){return v(e,t).then(function(e){return e==null?void 0:e.msgId})}function R(e,t){return v(e,t).then(function(e){return(e==null?void 0:e.sortOrderMs)==null?null:o("WATimeUtils").castToMillisTime(e.sortOrderMs)})}function L(e,t,n){return r("vulture")("ST6o7qk-BKGl46ZXS71LYr_2y6I="),b(e,t,!1,!1).reverse().limit(n).toArray()}function E(e,t){return b(e,t,!1,!1).first()}function k(e,t){return E(e,t).then(function(e){return e==null?void 0:e.msgId})}function I(e,t){return e.messages.where("externalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(D)}function T(e,t){var n=new Set(t.map(function(e){var t=e.author,n=e.chat,r=e.externalId;return o("WAMsg").craftWAMsgIdString({author:t,chat:n,externalId:r})}));return e.messages.where("externalId").anyOf(t.map(function(e){var t=e.externalId;return t})).filter(function(e){var t=e.author,r=e.externalId,a=e.threadJid;return n.has(o("WAMsg").craftWAMsgIdString({author:t,chat:a,externalId:r}))}).toArray().then(function(e){return o("WAArrayGroupBy").groupBy(e,function(e){return o("WAMsg").craftWAMsgIdString({author:e.author,chat:e.threadJid,externalId:e.externalId})}).map(function(e){var t=e[0],n=e[1];return D(n)}).filter(Boolean)})}function D(t){if(t.length>1){var n=t.map(function(e){var t,n;return e.type+":"+((t=e.serverTs)!=null?t:0).toString()+":"+((n=e.ts)!=null?n:0).toString()}),a=new Set(n).size===1;a?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Suspected multiple instances of same message!"]))):o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[maybeGetMsgByProtocolMsgId] Can't have "," messages with the same protocolMsgId!"])),t.length),(r("gkx")("5039")||o("Random").coinflip(r("justknobx")._("3594")))&&x(t)}return t[0]}function x(e){var t=e.length;if(!(t<=1)){var n=t-1,a=e[n],i={editCount:0,mediaId:0,revokedStatus:0,serverTs:0,sortOrderMs:0,ts:0,type:0};e.slice(0,n).forEach(function(e){var t=[];if((e==null?void 0:e.editCount)!==(a==null?void 0:a.editCount)){var n,l;i.editCount++,t.push("editCount, reference: "+((n=a==null?void 0:a.editCount)!=null?n:"")+", duplicate: "+((l=e==null?void 0:e.editCount)!=null?l:"")+". ")}if((e==null?void 0:e.mediaId)!==(a==null?void 0:a.mediaId)&&(i.mediaId++,t.push("mediaId, reference: "+((a==null?void 0:a.mediaId)!=null?String(a.mediaId):"")+", duplicate: "+((e==null?void 0:e.mediaId)!=null?String(e.mediaId):"")+". ")),e.sortOrderMs!==a.sortOrderMs&&(i.sortOrderMs++,t.push("sortOrderMs, reference: "+String(a.sortOrderMs)+", duplicate: "+String(e.sortOrderMs)+". ")),e.serverTs!==a.serverTs&&(i.serverTs++,t.push("serverTs, reference: "+String(a.serverTs)+", duplicate: "+String(e.serverTs)+". ")),e.ts!==a.ts&&(i.ts++,t.push("ts, reference: "+String(a.ts)+", duplicate: "+String(e.ts)+". ")),e.type!==a.type){var s,u;(e.type===o("MAWMsgType").MSG_TYPE.REVOKED||a.type===o("MAWMsgType").MSG_TYPE.REVOKED)&&(i.revokedStatus++,r("FBLogger")("MAWDuplicateMessageComparison").info("Revoked duplicate msg conflict, duplicate message, %s, has type: %s, externalId: %s, revokedExternalId: %s, sortOrderMs: %s, serverTs: %s, ts: %s, rowId: %s, reference msg, %s, has type: %s, externalId: %s, revokedExternalId: %s, sortOrderMs: %s, serverTs: %s, ts: %s, rowId: %s",e.msgId,e.type,e.externalId,e.revokedExternalId,e.sortOrderMs,e.serverTs,e.ts,e.rowId,a.msgId,a.type,a.externalId,a.revokedExternalId,e.sortOrderMs,e.serverTs,e.ts,e.rowId)),i.type++,t.push("type, reference: "+((s=a.type)!=null?s:"")+", duplicate: "+((u=e.type)!=null?u:"")+". ")}var c=t.join("");c.length>0?r("FBLogger")("MAWDuplicateMessageComparison").info("Duplicate msg, %s, has conflicting field values to reference msg, %s: %s",e.msgId,a.msgId,c):r("FBLogger")("MAWDuplicateMessageComparison").info("Duplicate msg, %s, has no conflicting field values to reference msg, %s",e.msgId,a.msgId)}),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"sets_of_duplicate_msgs"}),Object.keys(i).forEach(function(e){var t=i[e];t>0&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"sets_of_duplicate_msgs_with_"+e+"_field_differences"})}),o("MAWODSProxy").odsBumpEntityKey({amount:t-1,entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"number_of_duplicate_msgs"}),Object.keys(i).forEach(function(e){var t=i[e];t>0&&o("MAWODSProxy").odsBumpEntityKey({amount:t,entity:o("WAOdsEnums").Entity.MAW_DUPLICATE_MSGS,key:"number_of_duplicate_msgs_with_"+e+"_field_differences"})})}}function $(e,t,n,r){var o={author:r,chat:n,externalId:t};return I(e,o)}function P(e,t){return e.messages.where("msgId").equals(t).toArray()}function N(e,t){return A(e,t).then(function(e){return e.success,e})}function M(e,t){var n=t.map(function(e){var t=e.externalId;return t});return e.messages.where("externalId").anyOf(n).toArray().then(function(e){var n=o("MAWDbMsgUtil").convertMsgArrayToMap(e),r=new(o("WAMsgMap")).MsgMap;return t.forEach(function(e){var t=n.get(e);t!=null&&r.set(e,t)}),r})}function w(e,t){return e.messages.where("msgId").equals(t).first().then(function(e){return e==null?void 0:e.sortOrderMs})}function A(e,t){var n=t.author,r=t.chat,a=t.externalId;return e.threads.get({jid:r}).then(function(t){return t==null?o("WAResultOrError").makeError("missing_thread_msg"):$(e,a,t.jid,n).then(function(e){return e==null?o("WAResultOrError").makeError("missing_msg"):o("WAResultOrError").makeResult(e)})})}function F(e,t){var n=t.author,r=t.chat,o=t.externalId;return e.threads.get({jid:r}).then(function(t){if(t!=null)return e.messages.where("revokedExternalId").equals(o).filter(function(e){return e.author===n&&e.threadJid===t.jid&&e.type==="Revoked"}).first()})}function O(e,t,n,r){var a=e.messages.where("revokedExternalId").equals(t).filter(function(e){return e.author===r&&e.threadJid===n&&e.type===o("MAWMsgType").MSG_TYPE.REVOKED}).first(),i=o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByExternalId(e,t,n,r).then(function(e){if((e==null?void 0:e.type)===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return e});return o("MAWDexieTable").dexieAll([a,i]).then(function(e){var t=e[0],n=e[1];return t!=null||n!=null})}function B(e,t){var n=new Array(t.length),r=new Set;return t.forEach(function(e){n.push(e.externalId),r.add(o("EncryptedBackupsUtils").convertWAMsgIdToStringId(e))}),e.messages.where("externalId").anyOf(n).filter(function(e){return r.has(o("EncryptedBackupsUtils").convertWAMsgIdToStringId({author:e.author,chat:e.threadJid,externalId:e.externalId}))}).toArray()}function W(e,t,n,r,a,i){return q(e,[{ack:n,applicationErrorCode:i,msgId:t,reportingMeta:a,serverTs:r}]).then(function(e){var n=e.find(function(e){return e.msgId===t});return n==null?(o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updateSystemAck on non existing message"]))),null):n})}function q(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var a=new Map;t.forEach(function(e){a.set(e.msgId,{ack:e.ack,applicationErrorCode:e.applicationErrorCode,reportingMeta:e.reportingMeta,serverTs:e.serverTs});var t=r.get(e.msgId);t!=null&&a.set(t,{ack:e.ack,applicationErrorCode:e.applicationErrorCode,reportingMeta:e.reportingMeta,serverTs:e.serverTs})});var i=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(i).toArray().then(function(t){if(t.length===0)return t;var n=[],r=[];return t.forEach(function(e){var t,i,l;if(e.author!==o("WAJids").AUTHOR_ME||e.ack>o("MAWAckLevel").ACK.clock){n.push(e);return}var s=(t=a.get(e.msgId))==null?void 0:t.ack,u=(i=a.get(e.msgId))==null?void 0:i.serverTs;if(s==null)return null;var c=babelHelpers.extends({},e,{ack:s});U(c,u);var d=(l=a.get(e.msgId))==null?void 0:l.reportingMeta;d!=null&&(c.reportingMeta=d),s===o("MAWAckLevel").ACK.sent&&delete c.resendCount,r.push(c)}),n.length>0&&o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateSystemAck: not updating ",""])),n.map(function(e){return e.msgId}).toString()),e.messages.bulkPut(r).then(function(){return o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)}))}).then(function(e){return r.forEach(function(t,n){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e[n])})}),[].concat(r,n)})})})}function U(e,t){if(t!=null){e.serverTs=t;var n=e.sortOrderMs;e.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&(e.sortOrderMs=o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(e),o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Message was acked by server (serverTs = ","), override sortOrderMs: "," -> ",""])),t,n,e.sortOrderMs))}}function V(e,t,n,a){return o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(!(!t.success||a==null)){var i=t.value,l=[e.messages.where(["threadJid","sortOrderMs"]).above([i.jid,a]).first(),e.messages.where(["threadJid","sortOrderMs"]).below([i.jid,a]).last()];return o("MAWDexieTable").dexieAll(l).then(function(t){var a=t[0],l=t[1];return o("MAWDbThreadTxns").updateThread(e,babelHelpers.extends({},i,{newestMsgTs:(l==null?void 0:l.ts)==null?i.newestMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(l.ts),oldestMsg:i.oldestMsg===n?a==null?void 0:a.msgId:i.oldestMsg})).then(r("emptyFunction"))})}})}function H(e){return e.messages.where("altIndex").equals(o("MAWDbMsg").FUTUREPROOF_ALT_INDEX).toArray().then(function(e){var t=[];return e.forEach(function(e){if(e.type!==o("MAWMsgType").MSG_TYPE.FUTUREPROOF){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["getFutureproofMsg gets a message "," with unsupported type ",""])),e.msgId,e.type);return}t.push(e)}),t})}function G(e){return e.toString()}function z(e,t,n,a){var i=t.mediaId;if(i===n)return o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""])),t.msgId,n),o("MAWDexieTable").dexieResolve();var l=i!=null?e.media.get(i):o("MAWDexieTable").dexieResolve();return l.then(function(i){i&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Replacing mediaId for message with pre-existing media. type=",""])),t.type);var l=a!=null?a:void 0,s=babelHelpers.extends({},t,{mediaId:n,plaintextHash:l});return e.messages.put(s).then(r("emptyFunction"))})}function j(e,t){var n=Array.from(t.keys());return e.messages.where("msgId").anyOf(n).toArray().then(function(n){var a=[];return n.map(function(e){var n=t.get(e.msgId),i=e.mediaId;if(i!=null&&i!==n){if(n!=null)throw r("FBLogger")("messenger_web").mustfixThrow("mediaId "+G(i)+" in message "+e.msgId+" is different with the "+G(n)+" in bulkUpdateMediaId");o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["updateMediaId on message "," that already has this mediaId ",""])),e.msgId,n);return}var l=babelHelpers.extends({},e,{mediaId:n,plaintextHash:e.plaintextHash});a.push(l)}),e.messages.bulkPut(a).then(r("emptyFunction"))})}function K(e,t){return Q(e,[t]).then(r("emptyFunction"))}function Q(e,t){return e.messages.where("msgId").anyOf(t).toArray().then(function(t){var n=t.map(function(e){return babelHelpers.extends({},e,{isExpiredXmaMsg:!0})});return e.messages.bulkPut(n).then(function(){return n})})}function X(e,t,n,r){if(r!=null&&r<=0)return o("MAWDexieTable").dexieResolve([]);var a=e.messages.where("altIndex").equals(o("MAWDbMsg").craftToBeReadAltIndex(t)).filter(function(e){return o("MAWDbMsg").getSortOrderWithFallback(e)<=n});return r!=null&&(a=a.limit(r)),a.toArray()}function Y(e,t,n){return X(e,t,n).then(function(t){var n=t.map(function(e){return babelHelpers.extends({altIndex:null},e)});return e.messages.bulkPut(n).then(function(){return n})})}function J(e,t){return e.messages.delete(t)}function Z(e,t){return e.messages.bulkDelete(t)}function ee(e,t,n){var r=t.map(function(e){return e.rowId}),a=n!=null?t.map(function(e){var t=o("MAWJidUtils").toProtocolMsgId(e);if(t)return babelHelpers.extends({},t,{reason:n})}).filter(Boolean):[];return o("MAWDexieTable").dexieAll([e.deletedMessages.bulkAdd(a),e.messages.bulkDelete(r)]).then(function(e){var t=e[0],n=e[1];o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Successfull deleted "," messages"])),n)})}function te(e,t){return e.messages.where("msgId").anyOf(t).toArray()}function ne(e){return e.messages.where("altIndex").anyOf([o("MAWDbMsg").SPAM_ALT_INDEX,o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX]).toArray()}function re(e,t,n,r,a,i,l,s){l===void 0&&(l="before"),s===void 0&&(s=null);var u=n==null?null:o("MAWDbMsg").getSortOrderWithFallback(n);return l==="before"?e.messages.where(["threadJid","sortOrderMs"]).between([t,s!=null?s:Number.MIN_SAFE_INTEGER],[t,u!=null?u:Number.MAX_SAFE_INTEGER],!0,r).reverse().filter(i).limit(a).toArray():e.messages.where(["threadJid","sortOrderMs"]).between([t,u!=null?u:Number.MIN_SAFE_INTEGER],[t,s!=null?s:Number.MAX_SAFE_INTEGER],r,!0).filter(i).limit(a).toArray().then(function(e){return e.sort(function(e,t){return t.ts-e.ts})})}function oe(e,t,n,r){var o=n.msgId;if(r==null){var a;return{oldestMsg:(a=e==null?void 0:e.msgId)!=null?a:o}}var i=[e,t,n].filter(Boolean);return{oldestMsg:i.reduce(function(e,t){return ae(e,o,r)<ae(t,o,r)?e:t}).msgId}}function ae(e,t,n){return e.msgId===t?n:o("MAWDbMsg").getSortOrderWithFallback(e)}function ie(e,t){return e.messages.where("msgId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.msgId);return t+1})}function le(e){return o("MAWTransactor").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"checkMessagesExistenceByProtocolMsgIds",function(t){return function(){return o("MAWDexieTable").dexieAll(e.map(function(e){return t.messages.get({protocolMsgId:e.chat+"."+e.externalId})}))}})()}function se(e,t){return e.messages.where("externalId").anyOf(t).toArray()}l.maybeGetMsg=h,l.getIsThreadEmpty=y,l.doesThreadHaveMsgsMatchCriteria=C,l.getThreadMessagesBySortOrder=b,l.getThreadNewestMessageBySortOrder=v,l.getThreadNewestMessageId=S,l.getThreadNewestMessageMs=R,l.getThreadNewestNumMessagesBySortOrder=L,l.getThreadOldestMessageBySortOrder=E,l.getThreadOldestMessageId=k,l.maybeGetMsgByProtocolMsgId=I,l.getUniqueMsgsByProtocolMsgIds=T,l.maybeGetMsgByExternalId=$,l.maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING=P,l.maybeGetMsgResultByProtocolMsgId=N,l.getMsgMapByProtocolMsgId=M,l.getSortOrderFromMsgId=w,l.maybeGetRevokedMsgByProtocolMsgId=F,l.checkIfMsgIsDeletedForMeOrRevoked=O,l.getMsgsByProtocolMsgId=B,l.updateSystemAck=W,l.bulkUpdateSystemAck=q,l.maybeUpdateThreadMsgsForDeleteForMe=V,l.getFutureProofMsgs=H,l.updateMediaId=z,l.bulkUpdateMediaId=j,l.updateDbMsgXMAExpiration=K,l.bulkUpdateDbMsgXMAExpired=Q,l.getMsgsNeedingRetroactiveReadReceiptsUpTo=X,l.clearRetroactiveReadReceiptStatusFromMsgsUpTo=Y,l.deleteDbMsg=J,l.bulkDeleteDbMsg=Z,l.deleteMessages=ee,l.getMsgsByMsgIds=te,l.getSpamMsgs=ne,l.fetchMessagesFromDbWithSortOrderMs=re,l.calculateOldestMsg=oe,l.getNextMsgIdNumberForThread=ie,l.checkMessagesExistenceByProtocolMsgIds=le,l.UNSAFE_getMultipleMsgsByExternalId=se}),98);
__d("MAWDbMsgTypeVersionTxns",["MAWDbAppMeta","MAWDexieTable","MAWTransactionMode","MAWTransactor","MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion}).then(function(e){return e==null?void 0:e.value.msgTypeVersion})}function u(e,t){return e.appMeta.add({key:o("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion,value:{msgTypeVersion:t}})}function c(e,t){return e.appMeta.put({key:o("MAWDbAppMeta").AppMetaKeysEnum.msgTypeVersion,value:{msgTypeVersion:t}})}function d(e,t){return e.appMeta.add({key:o("MAWDbAppMeta").AppMetaKeysEnum.hmacKey,value:{hmacKey:t}})}function m(e){return e.appMeta.get({key:o("MAWDbAppMeta").AppMetaKeysEnum.hmacKey}).then(function(e){return e==null?void 0:e.value.hmacKey})}function p(e,t){return e.appMeta.get({key:t})}function _(e,t){return o("MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor").setCachedShouldSaveSecurityAlert(t),e.appMeta.put({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert,value:{allowSecurityAlert:t}}).then(r("emptyFunction"))}function f(e,t){return e.appMeta.put({key:o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf,value:{allowSecurityAlertForSelf:t}}).then(r("emptyFunction"))}function g(){return o("MAWTransactor").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY},"handleInstructions",function(e){return function(){return h(e)}})()}function h(e){return p(e,o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlert)!=null?t:!1})}function y(e){return p(e,o("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf).then(function(e){var t;return(t=e==null?void 0:e.value.allowSecurityAlertForSelf)!=null?t:!0})}function C(e,t){return e.appMeta.add({key:o("MAWDbAppMeta").AppMetaKeysEnum.hotlikeSticker,value:{hotlikeSticker:t}})}function b(e){return o("MAWDexieTable").dexieAll([y(e),h(e)]).then(function(e){var t=e[0],n=e[1];return{allowSecurityAlertForContact:n,allowSecurityAlertForSelf:t}})}l.MSG_TYPE_VERSION=(e=o("MAWDbAppMeta")).AppMetaKeysEnum.msgTypeVersion,l.ALLOW_SECURITY_ALERT_FOR_CONTACT=e.AppMetaKeysEnum.allowSecurityAlert,l.ALLOW_SECURITY_ALERT_FOR_SELF=e.AppMetaKeysEnum.allowSecurityAlertForSelf,l.HOT_LIKE=e.AppMetaKeysEnum.hotlikeSticker,l.getMsgTypeVersion=s,l.addMsgTypeVersion=u,l.updateMsgTypeVersion=c,l.addHMACKey=d,l.getHMACKey=m,l.getAppMetaValue=p,l.updateSecurityAlertValueForContact=_,l.updateSecurityAlertValueForSelf=f,l.getSecuritySettingForContactTxn=g,l.getSecuritySettingForContact=h,l.getSecuritySettingForSelf=y,l.addHotLike=C,l.maybeBulkGetSecuritySetting=b}),98);
__d("MAWDbReactionsTxns",["FBLogger","MAWAuthor","MAWBridgeTypesCreators","MAWDbMsg","MAWDexieTable","MAWIndexedDb","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t};function d(e,t){return e.reactions.put(c(t))}function m(t,n){return t.reactions.delete(n.rowId).then(function(){var t=n.author,r=n.reactionId,a=n.reactToMsgId,i=n.threadJid;a!=null&&(o("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:i,reactToMsgId:a})}),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted reaction with id : ","."])),r))})}function p(e,t){var n=o("MAWAuthor").getAuthorUserJid(t.author);return e.reactions.where("reactToExternalId").equals(t.externalId).filter(function(e){return(e.reactToAuthor===n||e.reactToAuthor===t.author)&&e.threadJid===t.chat}).toArray()}function _(e,t){var n=t.reduce(function(e,t){return e.set(t.msgId,t),e},new Map);return e.reactions.where("reactToMsgId").anyOf(t.map(function(e){return e.msgId})).toArray().then(function(e){var t=e.filter(function(e){var t,r=e.reactToExternalId,o=e.reactToMsgId;return o!=null&&r===((t=n.get(o))==null?void 0:t.externalId)});return t.length<e.length&&r("FBLogger")("messenger_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId"),t})}function f(e,t){return e.reactions.where("reactToMsgId").equals(t.msgId).toArray().then(function(e){var n=e.filter(function(e){var n=e.reactToExternalId;return n===t.externalId});return n.length<e.length&&r("FBLogger")("messenger_web").mustfix("Reactions query by reactToMsgId returns reactions with mismatching externalId"),n})}function g(e,t){return _(e,[t])}function h(e,t){var n=t.author,r=t.chat,o=t.externalId;return e.reactions.where("externalId").equals(o).filter(function(e){return e.author===n&&e.threadJid===r}).first()}function y(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.author,r=t.externalId,a=o("MAWAuthor").getAuthorUserJid(n);return e.reactions.where("reactToExternalId").equals(r).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===a}).toArray()})).then(function(t){var n=t.flat();if(n.forEach(function(e){var t=e.author,n=e.reactToMsgId,r=e.threadJid;n!=null&&o("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:r,reactToMsgId:n})})}),n.length!==0)return o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."])),n.length),e.reactions.bulkDelete(n.map(function(e){return e.rowId}))})}function C(e,t){return e.reactions.where("reactToMsgId").anyOf(t.map(function(e){return e.msgId})).delete().then(function(e){o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Deleted "," reactions"])),e)})}function b(e,t){return e.reactions.where("reactionId").between(o("MAWDbMsg").msgIdsInChatLowerBound(t.chatId),o("MAWDbMsg").msgIdsInChatUpperBound(t.chatId)).last().then(function(e){var t=e==null?0:o("MAWDbMsg").getInChatMsgIdFromMsgId(e.reactionId);return t+1})}function v(e,t,n,r,a,i,l){var s,u,c=(s=r==null?void 0:r.ts)!=null?s:o("WATimeUtils").unixTime();return e.reactions.where(["threadJid","ts"]).between([t,(u=o("WATimeUtils").castMillisTimeToUnixTime(n))!=null?u:o("WATimeUtils").castToUnixTime(0)],[t,c],!0,a).reverse().filter(l).limit(i).toArray()}l.coerceToReaction=c,l.putReaction=d,l.deleteReaction=m,l.getReactionForEcho=p,l.getReactionsFromMessages=_,l.getReactionsForMessage=f,l.getReactionsFromMessage=g,l.maybeGetReactionByProtocolMsgId=h,l.deleteReactionsByUniqueMsgIdentifiers=y,l.deleteAllReactionsForMessages=C,l.getNextReactionIdNumberForThread=b,l.fetchReactionsFromDbWithTimestamp=v}),98);
__d("MAWAuthoritativeThreadsCache",[],(function(t,n,r,o,a,i){"use strict";var e=new Set;i.AuthoritativeThreadsCache=e}),66);
__d("MaybeCreateOrUpdateThreadResultCache",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t){e.delete(t)}i.cache__I_KNOW_WHAT_I_AM_DOING=e,i.deleteCachedThreadResult=l}),66);
__d("MAWDbThreadTxns",["MAWAuthoritativeThreadsCache","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MaybeCreateOrUpdateThreadResultCache","WAArrayZip","WALogger","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return e.threads.get({deduplicationKey:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function d(e,t){return e.threads.get({jid:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function m(e,t){return e.threads.where("jid").anyOf(t).toArray()}function p(e,t){return e.threads.where("jid").startsWith(t+"@").first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function _(e){o("MaybeCreateOrUpdateThreadResultCache").deleteCachedThreadResult(e),o("MAWAuthoritativeThreadsCache").AuthoritativeThreadsCache.delete(e)}function f(e,t){return e.threads.where("jid").equals(t).delete().then(function(){return _(t)})}function g(e,t){return e.participants.where("userJid").equals(t).toArray().then(function(t){var n=t.map(function(e){return e.threadJid});return m(e,n)})}function h(e,t){return e.participants.where("userJid").anyOf(t).toArray().then(function(t){var n=new Map,r=new Set;return t.forEach(function(e){var t,o=e.userJid,a=(t=n.get(o))!=null?t:[];a.push(e.threadJid),n.set(o,a),r.add(e.threadJid)}),m(e,Array.from(r)).then(function(e){var t=e.reduce(function(e,t){return e.set(t.jid,t),e},new Map);return new Map(Array.from(n.entries()).map(function(e){var n=e[0],r=e[1];return[n,r.map(function(e){return t.get(e)}).filter(Boolean)]}))})})}function y(e,t,n){return(t==null?void 0:t.lastReadMsgReceiptSent)==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbMsgTxns").getSortOrderFromMsgId(e,t.lastReadMsgReceiptSent).then(function(e){return n.sortOrderMs==null||e==null?!1:n.sortOrderMs<=e})}function C(e,t){return e.threads.get({jid:t.threadJid}).then(function(n){return y(e,n,t)})}function b(e,t){return e.threads.where("jid").anyOf(t.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(o("WAArrayZip").zip(t,n).map(function(t){var n=t[0],r=t[1];return y(e,r,n)}))})}function v(e,t,n){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var r=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{archived:!0,cannotReplyReason:n?"viewer_not_subscribed":e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.ARCHIVED})});return e.threads.bulkPut(r).then(function(){r.forEach(function(e){n&&o("WALogger").LOG(["[Occamadillo] Leaving a group thread\n          "+e.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.ARCHIVED,threadJid:e.jid})})})})})}function S(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{cannotReplyReason:null})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){var t={cannotReplyReason:null,threadJid:e.jid};o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(t)})})})})}function R(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{archived:!1,cannotReplyReason:e.cannotReplyReason==="viewer_not_subscribed"?e.cannotReplyReason:null,folder:o("MAWFolderTypes").FOLDER_ID.INBOX})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e.cannotReplyReason,folder:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:e.jid})})})})})}function L(e,t){return e.threads.where("jid").anyOf(t).toArray().then(function(t){var n=t.filter(Boolean).map(function(e){return babelHelpers.extends({},e,{cannotReplyReason:"viewer_not_subscribed"})});return e.threads.bulkPut(n).then(function(){n.forEach(function(e){var t={cannotReplyReason:"viewer_not_subscribed",threadJid:e.jid};o("WALogger").LOG(["[Occamadillo] User is unsubscribed from thread\n          "+e.jid.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(t)})})})})}function E(t,n){return d(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed to get the thread"])));return}var a=n.value;if(a.isMigratedLocally===!0){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markThreadAsMigratedLocally failed because thread is already migrated"])));return}var i=babelHelpers.extends({},a,{isMigratedLocally:!0});return t.threads.put(i).then(r("emptyFunction"))})}function k(e,t){if(t.isMigratedLocally===!1)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["markCutoverThreadAsNotMigratedLocally failed because thread is already unmigrated"]))),o("MAWDexieTable").dexieResolve(t);var n=babelHelpers.extends({},t,{isMigratedLocally:!1});return e.threads.put(n).then(function(){return n})}function I(e,t){return e.threads.put(t).then(r("emptyFunction"))}function T(e,t,n,r,a){return I(e,babelHelpers.extends({},t,{newestMsgTs:(a==null?void 0:a.ts)==null?t.newestMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(a.ts),oldestMsg:r==null?void 0:r.msgId}))}l.getThreadByDeduplicationKey=c,l.getThread=d,l.getThreads=m,l.getThreadPrimaryId=p,l.deleteThread=f,l.getAllThreadsForUser=g,l.getAllThreadsForUsers=h,l.needsRetroactiveReadReceiptInThread=C,l.bulkNeedsRetroactiveReadReceiptInThread=b,l.archiveThreads=v,l.subscribeToThreads=S,l.unarchiveThreads=R,l.unsubscribeFromThreads=L,l.markCutoverThreadAsMigratedLocally=E,l.markCutoverThreadAsNotMigratedLocally=k,l.updateThread=I,l.updateThreadMsgsForUndefinedOldestOrNewestMsgs=T}),98);
__d("MAWDbXMATxns",["MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWJidUtils","MAWXMAUtils","WAResultOrError","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.xma.bulkGet(t)}function s(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.get({xmaId:t})}function u(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.where("associatedMessageId").equals(t).first()}function c(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.xma.where("externalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).first()}function d(e,t){return c(e,t).then(function(t){return t==null?o("WAResultOrError").makeError("missing"):o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").getMediaForXMA(e,t),o("MAWDbMsgTxns").maybeGetMsg(e,t.associatedMessageId)]).then(function(e){var n=e[0],r=e[1];if(!n.success)return o("WAResultOrError").makeError("missing");var a=n.value,i=a.defaultPreview,l=a.favicon,s=a.header,u=a.previews;return o("WAResultOrError").makeResult({associatedMessage:r,defaultPreview:i,favicon:l,header:s,previews:u,xma:t})})})}function m(e,t){return u(e,t).then(function(t){if(t!=null)return o("MAWDbMsgTxns").maybeGetMsg(e,t.msgId)})}function p(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.filter(o("MAWDbMsg").isXMAMsg).map(function(e){return o("MAWJidUtils").maybeToProtocolMsgId(e.author,e.threadJid,e.externalId)}).filter(Boolean),r=n.map(function(t){return c(e,t)});return o("MAWDexieTable").dexieAll(r).then(function(e){return e.filter(Boolean)})}function _(e,t){return e.xma.where("associatedMessageId").anyOf(t).toArray().then(function(e){var t=e.filter(function(e){return e.msgId!=null&&r("gkx")("9841")?e.targetType!=null:o("MAWXMAUtils").isXMAShare_DO_NOT_USE(e.targetType)});return t.reduce(function(e,t){return t.associatedMessageId!=null&&t.msgId!=null?e.set(t.associatedMessageId,t.msgId):e},new Map)})}function f(e,t){return e.xma.where("associatedMessageId").equals(t).first()}function g(e,t){return e.xma.where("associatedMessageId").equals(t).first().then(function(t){if(t!=null){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.externalId);if(n!=null)return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,n)}})}function h(e,t){return f(e,t).then(function(t){return t==null?o("WAResultOrError").makeResult():o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").getMediaForXMA(e,t),o("MAWDbMsgTxns").maybeGetMsg(e,t.associatedMessageId)]).then(function(e){var n=e[0],r=e[1];if(!n.success)return o("WAResultOrError").makeError("missing");var a=n.value,i=a.defaultPreview,l=a.favicon,s=a.header,u=a.previews;return o("WAResultOrError").makeResult({associatedMessage:r,defaultPreview:i,favicon:l,header:s,previews:u,xma:t})})})}function y(e,t,n){return o("MAWDbThreadTxns").getThread(e,n).then(function(n){if(n.success){var r=n.value;if(t==null)return o("MAWDexieTable").dexieResolve();var a={author:t.author,chat:r.jid,externalId:t.externalId};return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,a)}})}function C(e,t){return c(e,t).then(function(t){if(t==null)return o("MAWDexieTable").dexieResolve();if(!o("MAWXMAUtils").isXMAStoryReply(t.targetType))return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.defaultPreviewMediaId).then(function(n){return n==null?{hasMedia:!1,xma:t}:o("MAWDexieTable").dexieAll([n,o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash)]).then(function(e){var n=e[0],r=e[1];return{hasMedia:r,previewMedia:n,xma:t}})})})}function b(e,t){return e.xma.where("externalId").anyOf(t).toArray()}l.bulkGetXMAs=e,l.maybeGetXMAFromXMAId=s,l.maybeGetXMAFromAssociatedMsgId=u,l.maybeGetXMAFromProtocolMsgId=c,l.maybeGetXMAPayloadFromProtocolMsgId=d,l.getDbXMAMsgFromAssociatedMsgId=m,l.getXMAFromMsgs=p,l.getXMAMsgIdsFromAssociatedMsgIds=_,l.maybeGetDbXMAMsgByAssociatedMsgId=g,l.maybeGetXMAPayloadFromAssociatedMsgId=h,l.maybeGetAssociatedXMAMsg=y,l.maybeGetXMAAndDefaultPreviewMediaFromProtocolMsg=C,l.getMultipleXMAByExternalId=b}),98);
__d("MAWDbMutationMiddleware",["FBLogger","MAWDbMiddlewareMutations","getErrorSafe","vulture"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{create:function(n){return babelHelpers.extends({},n,{table:function(a){var t=n.table(a);try{return babelHelpers.extends({},t,{get:function(r){return t.get(r).then(function(t){if(t!=null)return o("MAWDbMiddlewareMutations").getValue(t,a,e)})},getMany:function(r){return t.getMany(r).then(function(t){return t.map(function(t){if(t!=null)return o("MAWDbMiddlewareMutations").getValue(t,a,e)})})},mutate:function(r){var n=null;switch(r.type){case"add":case"put":n=r.values.map(function(t){return o("MAWDbMiddlewareMutations").mutateValue(t,a,e)});break;case"delete":break;case"deleteRange":break}return r.type==="delete"||r.type==="deleteRange"||n==null?t.mutate(r):(r.values=n,t.mutate(r).then(function(e){return e}))},openCursor:function(r){return t.openCursor(r).then(function(t){return t==null||t.value==null?t:u(t,a,e)})},query:function(r){return t.query(r).then(function(t){if(t.result.length===0||typeof t.result[0]!="object")return t;var n=t.result.map(function(t){return o("MAWDbMiddlewareMutations").getValue(t,a,e)});return t.result=n,t})}})}catch(e){var i=r("getErrorSafe")(e);return r("FBLogger")("messenger_web").catching(i).mustfix("Error applying MAWDbMiddleware"),t}}})},name:"MAWDbMutationMiddleware",stack:"dbcore"}}function s(){return{create:function(t){return babelHelpers.extends({},t,{table:function(n){var e=t.table(n);try{return babelHelpers.extends({},e,{get:function(r){return e.get(r).then(function(e){return o("MAWDbMiddlewareMutations").getVaultedValue(e,n)})},getMany:function(a){return e.getMany(a).then(function(e){return r("vulture")("SMxI1wxhqOhNsUbqaKEGeOiO21w="),e.map(function(e){return o("MAWDbMiddlewareMutations").getVaultedValue(e,n)})})},mutate:function(r){return r.type==="delete"||r.type==="deleteRange"||(r.values=r.values.map(function(e){return o("MAWDbMiddlewareMutations").mutateVaultedValue(e,n)})),e.mutate(r)},openCursor:function(r){return e.openCursor(r).then(function(e){return e==null||e.value==null?e:c(e,n)})},query:function(r){return e.query(r).then(function(e){return e.result.length===0||typeof e.result[0]!="object"?e:babelHelpers.extends({},e,{result:e.result.map(function(e){return o("MAWDbMiddlewareMutations").getVaultedValue(e,n)})})})}})}catch(t){var a=r("getErrorSafe")(t);return r("FBLogger")("messenger_web").catching(a).mustfix("Error applying MAWDbMiddleware"),e}}})},name:"getMAWVaultMiddleware",stack:"dbcore"}}function u(e,t,n){var r;return Object.create(e,{continue:{get:function(){return e.continue}},continuePrimaryKey:{get:function(){return e.continuePrimaryKey}},key:{get:function(){return e.key}},primaryKey:{get:function(){return e.primaryKey}},start:{value:function(i){return e.start(function(){r=o("MAWDbMiddlewareMutations").getValue(e.value,t,n);try{e.value=r}catch(e){}i()})}},value:{get:function(){return r}}})}function c(e,t){var n;return Object.create(e,{continue:{get:function(){return e.continue}},continuePrimaryKey:{get:function(){return e.continuePrimaryKey}},key:{get:function(){return e.key}},primaryKey:{get:function(){return e.primaryKey}},start:{value:function(a){return e.start(function(){n=o("MAWDbMiddlewareMutations").getVaultedValue(e.value,t);try{e.value=n}catch(e){}a()})}},value:{get:function(){return n}}})}l.getMAWDbMutationMiddleware=e,l.getMAWVaultMiddleware=s}),98);
__d("MAWDbEncryptObjContent",["MAWKeychainNaClCrypto"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("MAWKeychainNaClCrypto").encryptTweetNaClArrayBuffer(e,t,n)}l.encryptContent=e}),98);
__d("MAWArmadilloAppDataTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={},b={},v={},S={},R={},L={};s.name="ProtocolMsgId",s.internalSpec={externalId:[1,(e=o("WAProtoConst")).TYPES.STRING],author:[2,e.TYPES.STRING],chat:[3,e.TYPES.STRING]},u.name="MetaSyncMessageKeyProto",u.internalSpec={fromMe:[1,e.TYPES.BOOL],id:[2,e.TYPES.STRING]},c.name="MetaSyncMessageProto",c.internalSpec={key:[1,e.TYPES.MESSAGE,u],ts:[2,e.TYPES.INT64]},d.name="MetaSyncMessageRangeProto",d.internalSpec={lastMessageTimestamp:[1,e.TYPES.INT64],lastSystemMessageTimestamp:[2,e.TYPES.INT64],messages:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,c]},m.name="MetaSyncChatActionProto",m.internalSpec={type:[1,e.TYPES.STRING],chatJid:[2,e.TYPES.STRING],archived:[3,e.TYPES.BOOL],ts:[4,e.TYPES.INT64],messageRange:[5,e.TYPES.MESSAGE,d],read:[6,e.TYPES.BOOL]},p.name="MetaSyncMessageActionProto",p.internalSpec={type:[1,e.TYPES.STRING],protocolMsgId:[2,e.TYPES.MESSAGE,s]},_.name="MetaSyncActionProto",_.internalSpec={chatAction:[1,e.TYPES.MESSAGE,m],messageAction:[2,e.TYPES.MESSAGE,p],__oneofs__:{action:["chatAction","messageAction"]}},f.name="MetaSyncAppDataProto",f.internalSpec={actions:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_]},g.name="EncryptedBackupsSecretsEpochProto",g.internalSpec={id:[1,e.TYPES.UINT64],anonId:[2,e.TYPES.BYTES],rootKey:[3,e.TYPES.BYTES],status:[4,e.TYPES.INT32]},h.name="EncryptedBackupsSecretsProto",h.internalSpec={backupId:[1,e.TYPES.UINT64],serverDataId:[2,e.TYPES.UINT64],epoch:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,g],tempOcmfClientState:[4,e.TYPES.BYTES],mailboxRootKey:[5,e.TYPES.BYTES],obliviousValidationToken:[6,e.TYPES.BYTES]},y.name="FingerprintProto",y.internalSpec={currentIndex:[1,e.TYPES.UINT32],deviceIndexes:[2,e.FLAGS.REPEATED|e.TYPES.UINT32],rawId:[3,e.TYPES.UINT32]},C.name="SyncKeyDataProto",C.internalSpec={keyId:[1,e.TYPES.BYTES],keyData:[2,e.TYPES.BYTES],keyEpoch:[3,e.TYPES.UINT32],timestamp:[4,e.TYPES.INT64],fingerprint:[5,e.TYPES.MESSAGE,y]},b.name="SyncKeyShareProto",b.internalSpec={keys:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,C],orphanKeys:[2,e.FLAGS.REPEATED|e.TYPES.BYTES]},v.name="SyncKeyRequestProto",v.internalSpec={keyIds:[1,e.FLAGS.REPEATED|e.TYPES.BYTES]},S.name="AppDataProto",S.internalSpec={type:[1,e.TYPES.STRING],actions:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_],encryptedBackupsSecrets:[3,e.TYPES.MESSAGE,h],syncKeyShare:[4,e.TYPES.MESSAGE,b],syncKeyRequest:[5,e.TYPES.MESSAGE,v]},R.name="IdentitiesPerDeviceProto",R.internalSpec={deviceJid:[1,e.TYPES.STRING],serializedPubKey:[2,e.TYPES.BYTES],baseKey:[3,e.TYPES.BYTES]},L.name="AppDataTableSchemaProto",L.internalSpec={externalId:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64],contents:[3,e.TYPES.MESSAGE,S],permittedIdentitiesPerDevice:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,R],ack:[5,e.TYPES.INT32],appDataId:[6,e.TYPES.INT32],recipientDevices:[7,e.FLAGS.REPEATED|e.TYPES.STRING],sendPartial:[8,e.TYPES.BOOL]},l.ProtocolMsgIdSpec=s,l.MetaSyncMessageKeyProtoSpec=u,l.MetaSyncMessageProtoSpec=c,l.MetaSyncMessageRangeProtoSpec=d,l.MetaSyncChatActionProtoSpec=m,l.MetaSyncMessageActionProtoSpec=p,l.MetaSyncActionProtoSpec=_,l.MetaSyncAppDataProtoSpec=f,l.EncryptedBackupsSecretsEpochProtoSpec=g,l.EncryptedBackupsSecretsProtoSpec=h,l.FingerprintProtoSpec=y,l.SyncKeyDataProtoSpec=C,l.SyncKeyShareProtoSpec=b,l.SyncKeyRequestProtoSpec=v,l.AppDataProtoSpec=S,l.IdentitiesPerDeviceProtoSpec=R,l.AppDataTableSchemaProtoSpec=L}),98);
__d("MAWArmadilloAppMetaTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="DbAppMetaValuesProto",s.internalSpec={msgTypeVersion:[1,(e=o("WAProtoConst")).TYPES.INT32],hmacKey:[2,e.TYPES.BYTES],allowSecurityAlert:[3,e.TYPES.BOOL],hotlikeSticker:[4,e.TYPES.BYTES],isBackfilledForOccamadillo:[5,e.TYPES.BOOL],allowSecurityAlertForSelf:[11,e.TYPES.BOOL],hasMigratedFromDexie:[12,e.TYPES.BOOL],restoreMigrationAttempts:[13,e.TYPES.INT32],deviceJid:[14,e.TYPES.STRING],restoreToDexieMigrationComplete:[15,e.TYPES.BOOL],dbMigrationVersion:[16,e.TYPES.INT32]},u.name="AppMetaTableSchemaProto",u.internalSpec={key:[1,e.TYPES.STRING],value:[2,e.TYPES.MESSAGE,s]},l.DbAppMetaValuesProtoSpec=s,l.AppMetaTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloCollectionVersionsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="CollectionVersionsTableSchemaProto",s.internalSpec={collection:[1,(e=o("WAProtoConst")).TYPES.STRING],version:[2,e.TYPES.INT32],state:[3,e.TYPES.STRING],finiteFailureStartTime:[4,e.TYPES.INT64],ltHash:[5,e.TYPES.BYTES],isCollectionInMacMismatchFatal:[6,e.TYPES.BOOL],isCollectionLthashInconsistent:[7,e.TYPES.BOOL]},l.CollectionVersionsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloDeletedMessagesTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="DeletedMessagesTableSchemaProto",s.internalSpec={author:[1,(e=o("WAProtoConst")).TYPES.STRING],chat:[2,e.TYPES.STRING],externalId:[3,e.TYPES.STRING],reason:[4,e.TYPES.STRING]},l.DeletedMessagesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloDeviceChangeAlertsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="DeviceChangeAlertsTableSchemaProto",s.internalSpec={action:[1,(e=o("WAProtoConst")).TYPES.STRING],isArchived:[2,e.TYPES.BOOL],deviceChangeAlertsId:[3,e.TYPES.INT64],location:[4,e.TYPES.STRING],model:[5,e.TYPES.STRING],ts:[6,e.TYPES.INT64],loggedOut:[7,e.TYPES.BOOL],deviceJid:[8,e.TYPES.STRING],identity:[9,e.TYPES.BYTES],platform:[10,e.TYPES.STRING],latitude:[11,e.TYPES.STRING],longitude:[12,e.TYPES.STRING],isConfirmed:[13,e.TYPES.BOOL],isNotified:[14,e.TYPES.BOOL]},l.DeviceChangeAlertsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloDyiBatchTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={BACKUP_RESTORE:0,E2E_DYI:1},u={};u.name="DyiBatchTableSchemaProto",u.internalSpec={batchId:[1,(e=o("WAProtoConst")).TYPES.INT32],numMessages:[2,e.TYPES.INT32],oldestTs:[3,e.TYPES.INT64],threadId:[4,e.TYPES.STRING],isThread:[5,e.TYPES.BOOL],numMessagesRestored:[6,e.TYPES.INT32],qplInstanceKeyForThread:[7,e.TYPES.INT64],qplFlowDescriptor:[8,e.TYPES.ENUM,s],qplInstanceKeyE2E:[9,e.TYPES.INT64],numThreadsRestored:[10,e.TYPES.INT64]},l.DYI_BATCH_TABLE_SCHEMA_PROTO_QPL_FLOW_DESCRIPTOR=s,l.DyiBatchTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloEBMsgRangesTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="EBMsgRangesTableSchemaProto",s.internalSpec={rangeId:[1,(e=o("WAProtoConst")).TYPES.UINT32],threadJid:[2,e.TYPES.STRING],minMsgExternalId:[3,e.TYPES.STRING],maxMsgExternalId:[4,e.TYPES.STRING],minMsgSortOrderMs:[5,e.TYPES.UINT64],maxMsgSortOrderMs:[6,e.TYPES.UINT64],creationTime:[7,e.TYPES.INT64]},l.EBMsgRangesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloContactsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="EphemeralSettingProto",s.internalSpec={ephemeralExpirationInSec:[1,(e=o("WAProtoConst")).TYPES.UINT32],ephemeralLastUpdatedOrSetTimestamp:[2,e.TYPES.INT64]},u.name="EphemeralSyncResponseBackoffInfo",u.internalSpec={syncResponseRetries:[1,e.TYPES.INT32],syncResponseSentTs:[2,e.TYPES.INT64]},l.EphemeralSettingProtoSpec=s,l.EphemeralSyncResponseBackoffInfoSpec=u}),98);
__d("MAWArmadilloMessagesTableSchema.pb",["MAWArmadilloContactsTableSchema.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={},f={},g={},h={},y={};s.name="MsgContentProto",s.internalSpec={content:[1,(e=o("WAProtoConst")).TYPES.STRING],adminMsgContent:[2,e.FLAGS.REPEATED|e.TYPES.STRING],adminType:[3,e.TYPES.STRING],obsoleteExpiration:[4,e.TYPES.INT32],obsoleteTs:[5,e.TYPES.INT64],subtype:[6,e.TYPES.STRING],protobuf:[7,e.TYPES.BYTES],screenshotActionType:[8,e.TYPES.INT32],authorName:[9,e.TYPES.STRING],version:[10,e.TYPES.INT32],mentionedJids:[11,e.FLAGS.REPEATED|e.TYPES.STRING],commands:[12,e.FLAGS.REPEATED|e.TYPES.MESSAGE,u]},u.name="MsgContentCommandProto",u.internalSpec={commandType:[1,e.TYPES.INT32],offset:[2,e.TYPES.INT32],length:[3,e.TYPES.INT32],validationToken:[4,e.TYPES.STRING]},c.name="ReportingMetaProto",c.internalSpec={frankingTag:[1,e.TYPES.BYTES],frankingVersion:[2,e.TYPES.INT32],reportingContent:[3,e.TYPES.BYTES],reportingTag:[4,e.TYPES.BYTES],frankingKey:[5,e.TYPES.BYTES]},d.name="DbQuotedMsgProto",d.internalSpec={remoteJid:[1,e.TYPES.STRING],content:[2,e.TYPES.MESSAGE,h]},m.name="VideoMsgContentProto",m.internalSpec={duration:[1,e.TYPES.INT32],width:[2,e.TYPES.INT32],height:[3,e.TYPES.INT32],mimetype:[4,e.TYPES.STRING],jpegThumbnail:[5,e.TYPES.BYTES],jpegThumbnailHeight:[6,e.TYPES.INT32],jpegThumbnailWidth:[7,e.TYPES.INT32]},p.name="ImageMsgContentProto",p.internalSpec={width:[1,e.TYPES.UINT32],height:[2,e.TYPES.UINT32],jpegThumbnail:[3,e.TYPES.BYTES],jpegThumbnailHeight:[4,e.TYPES.INT32],jpegThumbnailWidth:[5,e.TYPES.INT32]},_.name="AudioMsgContentProto",_.internalSpec={duration:[1,e.TYPES.INT32],mimetype:[2,e.TYPES.STRING],played:[3,e.TYPES.BOOL],waveform:[4,e.TYPES.BYTES]},f.name="DocumentFileMsgContentProto",f.internalSpec={filename:[1,e.TYPES.STRING],mimetype:[2,e.TYPES.STRING]},g.name="QuotedDbMediaProto",g.internalSpec={mediaType:[1,e.TYPES.STRING],plaintextHash:[2,e.TYPES.STRING],size:[3,e.TYPES.INT32],ts:[4,e.TYPES.INT64],mediaEntry:[5,e.TYPES.BYTES],validatedVideoInfo:[6,e.TYPES.MESSAGE,m],validatedImageInfo:[7,e.TYPES.MESSAGE,p],validatedAudioInfo:[8,e.TYPES.MESSAGE,_],validatedDocumentFileInfo:[9,e.TYPES.MESSAGE,f]},h.name="DbQuotedMsgContentProto",h.internalSpec={type:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64],externalId:[3,e.TYPES.STRING],author:[4,e.TYPES.STRING],msgContent:[5,e.TYPES.MESSAGE,s],obsoleteMedia:[6,e.TYPES.MESSAGE,g],msgId:[7,e.TYPES.STRING],mediaId:[8,e.TYPES.INT32],sourceId:[9,e.TYPES.STRING],xmaMessageType:[10,e.TYPES.INT32],specialTextSize:[11,e.TYPES.INT32],plaintextHash:[12,e.TYPES.STRING],expirationTs:[13,e.TYPES.INT64]},y.name="MessagesTableSchemaProto",y.internalSpec={type:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64],externalId:[3,e.TYPES.STRING],msgId:[4,e.TYPES.STRING],author:[5,e.TYPES.STRING],ack:[6,e.TYPES.INT32],resendCount:[7,e.TYPES.INT32],msgContent:[8,e.TYPES.MESSAGE,s],altIndex:[9,e.TYPES.STRING],forwardingScore:[10,e.TYPES.INT32],quote:[11,e.TYPES.MESSAGE,d],messageExpirationTs:[12,e.TYPES.INT64],ephemeralSetting:[13,e.TYPES.MESSAGE,o("MAWArmadilloContactsTableSchema.pb").EphemeralSettingProtoSpec],revokedExternalId:[14,e.TYPES.STRING],isForwarded:[15,e.TYPES.BOOL],originalTs:[17,e.TYPES.INT64],sortOrderMs:[18,e.TYPES.INT64],reportingMeta:[19,e.TYPES.MESSAGE,c],messageDeleteTs:[20,e.TYPES.INT64],ephemeralCounterStarted:[21,e.TYPES.BOOL],quoteExternalId:[22,e.TYPES.STRING],unsendMsgContentDeleteTs:[23,e.TYPES.INT64],rowId:[24,e.TYPES.INT32],thread:[25,e.TYPES.INT32],mediaId:[26,e.TYPES.INT32],ephemeralMsgDisappeared:[27,e.TYPES.BOOL],threadJid:[28,e.TYPES.STRING],xmaId:[29,e.TYPES.INT32],specialTextSize:[30,e.TYPES.INT32],xmaMessageType:[31,e.TYPES.INT32],isExpiredXmaMsg:[32,e.TYPES.BOOL],ravenEphemeralType:[33,e.TYPES.INT32],ravenEphemeralMediaState:[34,e.TYPES.INT32],editCount:[35,e.TYPES.INT32],groupId:[36,e.TYPES.STRING],groupIndex:[37,e.TYPES.INT64],groupSize:[38,e.TYPES.INT64],receiverFetchId:[39,e.TYPES.STRING],source:[40,e.TYPES.STRING],quoteExpirationTs:[41,e.TYPES.INT64],applicationErrorCode:[42,e.TYPES.INT32],hdType:[43,e.TYPES.INT32],pollStanzaId:[44,e.TYPES.STRING],collapsibleId:[45,e.TYPES.STRING],isCollapsed:[46,e.TYPES.BOOL]},l.MsgContentProtoSpec=s,l.MsgContentCommandProtoSpec=u,l.ReportingMetaProtoSpec=c,l.DbQuotedMsgProtoSpec=d,l.VideoMsgContentProtoSpec=m,l.ImageMsgContentProtoSpec=p,l.AudioMsgContentProtoSpec=_,l.DocumentFileMsgContentProtoSpec=f,l.QuotedDbMediaProtoSpec=g,l.DbQuotedMsgContentProtoSpec=h,l.MessagesTableSchemaProtoSpec=y}),98);
__d("MAWArmadilloEditMsgHistoryTableSchema.pb",["MAWArmadilloMessagesTableSchema.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="EditMsgHistoryTableSchemaProto",s.internalSpec={author:[1,(e=o("WAProtoConst")).TYPES.STRING],editMsgHistoryId:[2,e.TYPES.INT32],editTs:[3,e.TYPES.INT64],msgContent:[4,e.TYPES.MESSAGE,o("MAWArmadilloMessagesTableSchema.pb").MsgContentProtoSpec],originalMsgExternalId:[5,e.TYPES.STRING],specialTextSize:[6,e.TYPES.INT32],threadJid:[7,e.TYPES.STRING],editExternalId:[8,e.TYPES.STRING],sendStatus:[9,e.TYPES.INT32]},l.EditMsgHistoryTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloGroupInfoTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="GroupInfoSchemaProto",s.internalSpec={groupJid:[1,(e=o("WAProtoConst")).TYPES.STRING],threadId:[2,e.TYPES.INT32],creator:[3,e.TYPES.STRING],creationTs:[4,e.TYPES.INT64],name:[5,e.TYPES.STRING],nameOwner:[6,e.TYPES.STRING],nameTs:[7,e.TYPES.INT64],msgExpiration:[8,e.TYPES.INT32],participantVersion:[9,e.TYPES.STRING],inviter:[10,e.TYPES.STRING],memberAddMode:[11,e.TYPES.STRING]},l.GroupInfoSchemaProtoSpec=s}),98);
__d("MAWArmadilloGroupInvitesTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="GroupInvitesTableSchemaProto",s.internalSpec={inviterJid:[1,(e=o("WAProtoConst")).TYPES.STRING],invitedParticipantId:[2,e.TYPES.STRING],inviteCode:[3,e.TYPES.STRING],inviteExpirationTs:[4,e.TYPES.INT64],caption:[5,e.TYPES.STRING]},l.GroupInvitesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloMediaTablesSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={NONE:0,LQ_4K:1,HQ_4K:2},u={},c={},d={},m={},p={},_={},f={},g={},h={};u.name="ChunkTableSchemaProto",u.internalSpec={plaintextHash:[1,(e=o("WAProtoConst")).TYPES.STRING],blobData:[2,e.TYPES.BYTES],mimetype:[3,e.TYPES.STRING],hashedPlaintextHash:[4,e.TYPES.STRING],chunkId:[5,e.TYPES.INT32]},c.name="MediaBackupSchemaProto",c.internalSpec={mediaBackupId:[1,e.TYPES.INT32],mediaId:[2,e.TYPES.INT32],objectId:[3,e.TYPES.STRING],msgId:[4,e.TYPES.STRING],fbid:[5,e.TYPES.STRING]},d.name="MediaEntriesProto",d.internalSpec={msgId:[1,e.TYPES.STRING],mediaEntryData:[2,e.TYPES.BYTES]},m.name="VideoMsgContentProto",m.internalSpec={duration:[1,e.TYPES.UINT32],width:[2,e.TYPES.UINT32],height:[3,e.TYPES.UINT32],mimetype:[4,e.TYPES.STRING],jpegThumbnail:[5,e.TYPES.BYTES],jpegThumbnailHeight:[6,e.TYPES.UINT32],jpegThumbnailWidth:[7,e.TYPES.UINT32],thumbnailPlaintextHash:[8,e.TYPES.STRING],gifPlayback:[9,e.TYPES.BOOL]},p.name="ImageMsgContentProto",p.internalSpec={width:[1,e.TYPES.UINT32],height:[2,e.TYPES.UINT32],jpegThumbnail:[3,e.TYPES.BYTES],jpegThumbnailHeight:[4,e.TYPES.UINT32],jpegThumbnailWidth:[5,e.TYPES.UINT32],thumbnailPlaintextHash:[6,e.TYPES.STRING],hdType:[7,e.TYPES.ENUM,s]},_.name="AudioMsgContentProto",_.internalSpec={duration:[1,e.TYPES.UINT32],mimetype:[2,e.TYPES.STRING],played:[3,e.TYPES.BOOL],waveform:[4,e.TYPES.BYTES]},f.name="DocumentFileMsgContentProto",f.internalSpec={filename:[1,e.TYPES.STRING],mimetype:[2,e.TYPES.STRING]},g.name="ValidatedResult",g.internalSpec={validatedMimeType:[1,e.TYPES.STRING],videoStreamType:[2,e.TYPES.STRING],videoCalculatedFps:[3,e.TYPES.UINT32],videoNominalFps:[4,e.TYPES.UINT32],videoWidth:[5,e.TYPES.UINT32],videoHeight:[6,e.TYPES.UINT32],videoDuration:[7,e.TYPES.UINT32],videoAvgBitsPerSecond:[8,e.TYPES.UINT32],audioStreamType:[9,e.TYPES.STRING],audioSamplingRate:[10,e.TYPES.UINT32],audioNumberOfChannels:[11,e.TYPES.UINT32],audioAvgBitsPerSecond:[12,e.TYPES.UINT32]},h.name="MediaTableSchemaProto",h.internalSpec={mediaType:[1,e.TYPES.STRING],plaintextHash:[2,e.TYPES.STRING],size:[3,e.TYPES.UINT64],mediaEntries:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],ts:[5,e.TYPES.INT64],validatedVideoInfo:[6,e.TYPES.MESSAGE,m],validatedImageInfo:[7,e.TYPES.MESSAGE,p],validatedAudioInfo:[8,e.TYPES.MESSAGE,_],hashedPlaintextHash:[9,e.TYPES.STRING],mediaId:[10,e.TYPES.INT32],msgIds:[11,e.FLAGS.REPEATED|e.TYPES.STRING],objectId:[12,e.TYPES.STRING],fbid:[13,e.TYPES.STRING],validatedDocumentFileInfo:[14,e.TYPES.MESSAGE,f],validatedResult:[15,e.TYPES.MESSAGE,g],accessibilitySummaryText:[16,e.TYPES.STRING],isVideoGif:[17,e.TYPES.BOOL]},l.HD_TYPE=s,l.ChunkTableSchemaProtoSpec=u,l.MediaBackupSchemaProtoSpec=c,l.MediaEntriesProtoSpec=d,l.VideoMsgContentProtoSpec=m,l.ImageMsgContentProtoSpec=p,l.AudioMsgContentProtoSpec=_,l.DocumentFileMsgContentProtoSpec=f,l.ValidatedResultSpec=g,l.MediaTableSchemaProtoSpec=h}),98);
__d("MAWArmadilloMissingKeysTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="DeviceResponse",s.internalSpec={deviceId:[1,(e=o("WAProtoConst")).TYPES.INT32],deviceResponse:[2,e.TYPES.BOOL]},u.name="MissingKeysTableSchemaProto",u.internalSpec={keyHex:[1,e.TYPES.STRING],keyId:[2,e.TYPES.BYTES],timestamp:[3,e.TYPES.INT64],deviceResponses:[4,e.FLAGS.REPEATED|e.TYPES.MESSAGE,s]},l.DeviceResponseSpec=s,l.MissingKeysTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloParticipantsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ParticipantsTableSchemaProto",s.internalSpec={id:[1,(e=o("WAProtoConst")).TYPES.STRING],userJid:[2,e.TYPES.STRING],deliveredWatermarkTs:[3,e.TYPES.INT64],lastReadWatermarkTs:[4,e.TYPES.INT64],type:[5,e.TYPES.STRING],addressable:[6,e.TYPES.BOOL],lastReadActionTs:[7,e.TYPES.INT64],threadId:[9,e.TYPES.INT32],threadJid:[10,e.TYPES.STRING]},l.ParticipantsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloPendingMutationsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={SET:0,REMOVE:1},u={};u.name="PendingMutationsTableSchemaProto",u.internalSpec={id:[1,(e=o("WAProtoConst")).TYPES.INT32],collection:[2,e.TYPES.STRING],index:[3,e.TYPES.STRING],binarySyncAction:[4,e.TYPES.BYTES],version:[5,e.TYPES.INT32],operation:[6,e.TYPES.ENUM,s],timestamp:[7,e.TYPES.INT64],action:[8,e.TYPES.STRING]},l.SYNCD_MUTATION_SYNCD_OPERATION=s,l.PendingMutationsTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloPersonalSenderKeyStatusTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="PersonalSenderKeyStatusTableSchemaProto",s.internalSpec={groupJid:[1,(e=o("WAProtoConst")).TYPES.STRING],senderKeyId:[2,e.TYPES.INT32],rotateSenderKey:[4,e.TYPES.BOOL],senderKeyTs:[5,e.TYPES.INT64],hasSenderKey:[6,e.FLAGS.REPEATED|e.TYPES.STRING]},l.PersonalSenderKeyStatusTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloPollTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={OPEN:0,FROZEN:1},u={},c={},d={},m={};u.name="PollOptionProto",u.internalSpec={optionText:[1,(e=o("WAProtoConst")).TYPES.STRING],voteAuthors:[2,e.FLAGS.REPEATED|e.TYPES.STRING]},c.name="PollOptionsProto",c.internalSpec={pollOptionHash:[1,e.TYPES.STRING],pollOption:[2,e.TYPES.MESSAGE,u]},d.name="LatestSenderTimestampsMsProto",d.internalSpec={author:[1,e.TYPES.STRING],latestSenderTimestampMs:[2,e.TYPES.INT64]},m.name="PollTableSchemaProto",m.internalSpec={chatJid:[1,e.TYPES.STRING],encKey:[2,e.TYPES.BYTES],pollAuthor:[3,e.TYPES.STRING],pollStanzaId:[4,e.TYPES.STRING],pollOptions:[5,e.FLAGS.REPEATED|e.TYPES.MESSAGE,c],pollParticipantCount:[6,e.TYPES.UINT32],pollState:[7,e.TYPES.ENUM,s],selectableOptionsCount:[8,e.TYPES.UINT32],title:[9,e.TYPES.STRING],latestSenderTimestampsMs:[10,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d]},l.POLL_STATE=s,l.PollOptionProtoSpec=u,l.PollOptionsProtoSpec=c,l.LatestSenderTimestampsMsProtoSpec=d,l.PollTableSchemaProtoSpec=m}),98);
__d("MAWArmadilloReactionsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ReactionsTableSchemaProto",s.internalSpec={ack:[1,(e=o("WAProtoConst")).TYPES.INT32],author:[2,e.TYPES.STRING],externalId:[3,e.TYPES.STRING],reactionId:[4,e.TYPES.STRING],reactToExternalId:[5,e.TYPES.STRING],reactToAuthor:[6,e.TYPES.STRING],reactToMsgId:[7,e.TYPES.STRING],threadJid:[8,e.TYPES.STRING],reaction:[9,e.TYPES.STRING],groupingKey:[10,e.TYPES.STRING],ts:[11,e.TYPES.INT64],rowId:[12,e.TYPES.INT32],senderTimestampMs:[13,e.TYPES.INT64]},l.ReactionsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloReceiptTablesSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={},c={},d={},m={},p={},_={};s.name="DbUserStatusTsProto",s.internalSpec={deliveredTs:[1,(e=o("WAProtoConst")).TYPES.INT64],readTs:[2,e.TYPES.INT64]},u.name="StatusTsPerUserProto",u.internalSpec={userJid:[1,e.TYPES.STRING],dbUserStatusTs:[2,e.TYPES.MESSAGE,s]},c.name="IdentitiesPerDeviceProto",c.internalSpec={deviceJid:[1,e.TYPES.STRING],serializedPubKey:[2,e.TYPES.BYTES],baseKey:[3,e.TYPES.BYTES]},d.name="RetryCountPerDeviceProto",d.internalSpec={deviceJid:[1,e.TYPES.STRING],count:[2,e.TYPES.INT32]},m.name="ReceiptsTableSchemaProto",m.internalSpec={msgId:[1,e.TYPES.STRING],statusTsPerUser:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,u],permittedIdentitiesPerDevice:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,c],recipientDevices:[4,e.FLAGS.REPEATED|e.TYPES.STRING],retryCountsPerDevice:[5,e.FLAGS.REPEATED|e.TYPES.MESSAGE,d],waMsgId:[6,e.TYPES.STRING]},p.name="Receipts",p.internalSpec={device:[1,e.TYPES.STRING],ts:[2,e.TYPES.INT64]},_.name="PendingReceiptsTableSchemaProto",_.internalSpec={pendingReceiptId:[1,e.TYPES.STRING],thread:[2,e.TYPES.STRING],externalId:[3,e.TYPES.STRING],author:[4,e.TYPES.STRING],deliveryReceipts:[5,e.FLAGS.REPEATED|e.TYPES.MESSAGE,p],readReceipts:[6,e.FLAGS.REPEATED|e.TYPES.MESSAGE,p]},l.DbUserStatusTsProtoSpec=s,l.StatusTsPerUserProtoSpec=u,l.IdentitiesPerDeviceProtoSpec=c,l.RetryCountPerDeviceProtoSpec=d,l.ReceiptsTableSchemaProtoSpec=m,l.ReceiptsSpec=p,l.PendingReceiptsTableSchemaProtoSpec=_}),98);
__d("MAWArmadilloReceiverFetchInfoTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ReceiverFetchInfoTableSchemaProto",s.internalSpec={mimetype:[1,(e=o("WAProtoConst")).TYPES.STRING],previewHeight:[2,e.TYPES.UINT32],previewWidth:[3,e.TYPES.UINT32],receiverFetchId:[4,e.TYPES.STRING],type:[5,e.TYPES.STRING],previewUrl:[6,e.TYPES.STRING],previewUrlExpirationTimestampMs:[7,e.TYPES.UINT64],accessibilitySummaryText:[8,e.TYPES.STRING]},l.ReceiverFetchInfoTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloSyncActionsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="SyncActionsTableSchemaProto",s.internalSpec={index:[1,(e=o("WAProtoConst")).TYPES.STRING],binarySyncData:[2,e.TYPES.BYTES],actionState:[3,e.TYPES.STRING],version:[4,e.TYPES.INT32],keyId:[5,e.TYPES.BYTES],modelId:[6,e.TYPES.STRING],modelType:[7,e.TYPES.STRING],indexMac:[8,e.TYPES.BYTES],valueMac:[9,e.TYPES.BYTES],collection:[10,e.TYPES.STRING],timestamp:[11,e.TYPES.INT64],action:[12,e.TYPES.STRING]},l.SyncActionsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloSyncKeysTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="SyncKeyFingerprint",s.internalSpec={currentIndex:[1,(e=o("WAProtoConst")).TYPES.INT32],deviceIndexes:[2,e.FLAGS.REPEATED|e.TYPES.INT32],rawId:[3,e.TYPES.INT64]},u.name="SyncKeysTableSchemaProto",u.internalSpec={id:[1,e.TYPES.BYTES],keyId:[2,e.TYPES.BYTES],keyData:[3,e.TYPES.BYTES],keyEpoch:[4,e.TYPES.INT64],timestamp:[5,e.TYPES.INT64],fingerprint:[6,e.TYPES.MESSAGE,s]},l.SyncKeyFingerprintSpec=s,l.SyncKeysTableSchemaProtoSpec=u}),98);
__d("MAWArmadilloTasksTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e={};e.name="TasksTableSchemaProto",e.internalSpec={taskName:[1,o("WAProtoConst").TYPES.STRING],scheduledTime:[2,o("WAProtoConst").TYPES.INT64]},l.TasksTableSchemaProtoSpec=e}),98);
__d("MAWArmadilloThreadsTableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="ThreadsTableSchemaProto",s.internalSpec={jid:[1,(e=o("WAProtoConst")).TYPES.STRING],threadOrder:[2,e.TYPES.STRING],folder:[4,e.TYPES.INT32],newestMsg:[5,e.TYPES.STRING],oldestMsg:[6,e.TYPES.STRING],lastReadMsg:[7,e.TYPES.STRING],lastReadMsgReceiptSent:[8,e.TYPES.STRING],lastReadMsgTs:[9,e.TYPES.INT64],newestMsgTs:[10,e.TYPES.INT64],muteExpireTimeMs:[11,e.TYPES.INT64],muteCallsExpireTimeMs:[12,e.TYPES.INT64],archived:[13,e.TYPES.BOOL],cannotReplyReason:[14,e.TYPES.STRING],chatId:[15,e.TYPES.INT32],optimisticThreadKey:[16,e.TYPES.STRING],isMigratedLocally:[17,e.TYPES.BOOL],snippetMsg:[18,e.TYPES.STRING],deduplicationKey:[19,e.TYPES.STRING],authoritativeThreadKey:[20,e.TYPES.STRING],snippetMsgTs:[21,e.TYPES.INT64],didInsertDualThreadCutoverAdminMsg:[22,e.TYPES.BOOL],unbumpFromTs:[23,e.TYPES.INT64],unbumpToTs:[24,e.TYPES.INT64]},l.ThreadsTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloUnrenderedMessagesTableSchema.pb",["MAWArmadilloContactsTableSchema.pb","MAWArmadilloMessagesTableSchema.pb","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={};s.name="UnrenderedMessagesTableSchemaProto",s.internalSpec={type:[1,(e=o("WAProtoConst")).TYPES.STRING],ts:[2,e.TYPES.INT64],externalId:[3,e.TYPES.STRING],msgId:[4,e.TYPES.STRING],author:[5,e.TYPES.STRING],ack:[6,e.TYPES.INT32],resendCount:[7,e.TYPES.INT32],ephemeralSetting:[8,e.TYPES.MESSAGE,o("MAWArmadilloContactsTableSchema.pb").EphemeralSettingProtoSpec],messageDeleteForMeTs:[9,e.TYPES.INT64],rowId:[10,e.TYPES.INT32],thread:[11,e.TYPES.INT32],mediaId:[12,e.TYPES.INT32],msgContent:[13,e.TYPES.STRING],threadJid:[14,e.TYPES.STRING],reportingMeta:[15,e.TYPES.MESSAGE,o("MAWArmadilloMessagesTableSchema.pb").ReportingMetaProtoSpec],invitedParticipantUserJid:[16,e.TYPES.STRING],groupName:[17,e.TYPES.STRING],quote:[18,e.TYPES.MESSAGE,o("MAWArmadilloMessagesTableSchema.pb").DbQuotedMsgProtoSpec],xmaMessageType:[19,e.TYPES.INT32],sortOrderMs:[20,e.TYPES.INT64]},l.UnrenderedMessagesTableSchemaProtoSpec=s}),98);
__d("MAWArmadilloXMATableSchema.pb",["WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s={},u={};s.name="XMATableSchemaProto",s.internalSpec={associatedMessageId:[1,(e=o("WAProtoConst")).TYPES.STRING],author:[2,e.TYPES.STRING],ctas:[3,e.FLAGS.REPEATED|e.TYPES.MESSAGE,u],defaultCTA:[4,e.TYPES.MESSAGE,u],defaultPreviewMediaId:[5,e.TYPES.INT32],externalId:[6,e.TYPES.STRING],faviconMediaId:[7,e.TYPES.INT32],headerMediaId:[8,e.TYPES.INT32],headerTitle:[9,e.TYPES.STRING],isTombstoned:[10,e.TYPES.BOOL],maxSubtitleNumOfLines:[11,e.TYPES.INT32],maxTitleNumOfLines:[12,e.TYPES.INT32],msgId:[13,e.TYPES.STRING],overlayDescription:[14,e.TYPES.STRING],overlayIconGlyph:[15,e.TYPES.INT32],overlayTitle:[16,e.TYPES.STRING],previewMediaIds:[17,e.FLAGS.REPEATED|e.TYPES.INT32],subtitleText:[18,e.TYPES.STRING],targetExpiringAtSec:[19,e.TYPES.INT64],targetId:[20,e.TYPES.STRING],targetType:[21,e.TYPES.INT32],targetUsername:[22,e.TYPES.STRING],threadJid:[23,e.TYPES.STRING],titleText:[24,e.TYPES.STRING],xmaId:[25,e.TYPES.INT32],xmaLayoutType:[26,e.TYPES.INT32],defaultPreviewMediaPlaintextHash:[27,e.TYPES.STRING],faviconPlaintextHash:[28,e.TYPES.STRING],headerMediaPlaintextHash:[29,e.TYPES.STRING]},u.name="CTAProto",u.internalSpec={buttonType:[1,e.TYPES.INT32],title:[2,e.TYPES.STRING],actionUrl:[3,e.TYPES.STRING],nativeUrl:[4,e.TYPES.STRING],ctaType:[5,e.TYPES.STRING]},l.XMATableSchemaProtoSpec=s,l.CTAProtoSpec=u}),98);
__d("MAWXMACTAUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.actionUrl,n=e.buttonType,r=e.ctaType,o=e.nativeUrl,a=e.title;return{actionUrl:t,buttonType:n,ctaType:r,nativeUrl:o,title:a}}function l(e){var t=e.actionUrl,n=e.buttonType,r=e.ctaType,o=e.nativeUrl,a=e.title;return{actionUrl:t,buttonType:n,ctaType:r,nativeUrl:o,title:a}}i.toMAWCTAEncode=e,i.fromMAWCTAEncode=l}),66);
__d("WAServerSync.pb",["$InternalEnum","WAProtoConst"],(function(t,n,r,o,a,i,l){var e,s=n("$InternalEnum")({SET:0,REMOVE:1}),u={},c={},d={},m={},p={},_={},f={},g={},h={},y={},C={};u.name="SyncdVersion",u.internalSpec={version:[1,(e=o("WAProtoConst")).TYPES.UINT64]},c.name="ExitCode",c.internalSpec={code:[1,e.TYPES.UINT64],text:[2,e.TYPES.STRING]},d.name="SyncdIndex",d.internalSpec={blob:[1,e.TYPES.BYTES]},m.name="SyncdValue",m.internalSpec={blob:[1,e.TYPES.BYTES]},p.name="KeyId",p.internalSpec={id:[1,e.TYPES.BYTES]},_.name="SyncdRecord",_.internalSpec={index:[1,e.TYPES.MESSAGE,d],value:[2,e.TYPES.MESSAGE,m],keyId:[3,e.TYPES.MESSAGE,p]},f.name="ExternalBlobReference",f.internalSpec={mediaKey:[1,e.TYPES.BYTES],directPath:[2,e.TYPES.STRING],handle:[3,e.TYPES.STRING],fileSizeBytes:[4,e.TYPES.UINT64],fileSha256:[5,e.TYPES.BYTES],fileEncSha256:[6,e.TYPES.BYTES]},g.name="SyncdSnapshot",g.internalSpec={version:[1,e.TYPES.MESSAGE,u],records:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,_],mac:[3,e.TYPES.BYTES],keyId:[4,e.TYPES.MESSAGE,p]},h.name="SyncdMutations",h.internalSpec={mutations:[1,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y]},y.name="SyncdMutation",y.internalSpec={operation:[1,e.TYPES.ENUM,s],record:[2,e.TYPES.MESSAGE,_]},C.name="SyncdPatch",C.internalSpec={version:[1,e.TYPES.MESSAGE,u],mutations:[2,e.FLAGS.REPEATED|e.TYPES.MESSAGE,y],externalMutations:[3,e.TYPES.MESSAGE,f],snapshotMac:[4,e.TYPES.BYTES],patchMac:[5,e.TYPES.BYTES],keyId:[6,e.TYPES.MESSAGE,p],exitCode:[7,e.TYPES.MESSAGE,c],deviceIndex:[8,e.TYPES.UINT32],clientDebugData:[9,e.TYPES.BYTES]},l.SyncdMutation$SyncdOperation=s,l.SyncdVersionSpec=u,l.ExitCodeSpec=c,l.SyncdIndexSpec=d,l.SyncdValueSpec=m,l.KeyIdSpec=p,l.SyncdRecordSpec=_,l.ExternalBlobReferenceSpec=f,l.SyncdSnapshotSpec=g,l.SyncdMutationsSpec=h,l.SyncdMutationSpec=y,l.SyncdPatchSpec=C}),98);
__d("MAWDbObjDecode",["FBLogger","MAWArmadilloAppDataTableSchema.pb","MAWArmadilloAppMetaTableSchema.pb","MAWArmadilloCollectionVersionsTableSchema.pb","MAWArmadilloDeletedMessagesTableSchema.pb","MAWArmadilloDeviceChangeAlertsTableSchema.pb","MAWArmadilloDyiBatchTableSchema.pb","MAWArmadilloEBMsgRangesTableSchema.pb","MAWArmadilloEditMsgHistoryTableSchema.pb","MAWArmadilloGroupInfoTableSchema.pb","MAWArmadilloGroupInvitesTableSchema.pb","MAWArmadilloMediaTablesSchema.pb","MAWArmadilloMessagesTableSchema.pb","MAWArmadilloMissingKeysTableSchema.pb","MAWArmadilloParticipantsTableSchema.pb","MAWArmadilloPendingMutationsTableSchema.pb","MAWArmadilloPersonalSenderKeyStatusTableSchema.pb","MAWArmadilloPollTableSchema.pb","MAWArmadilloReactionsTableSchema.pb","MAWArmadilloReceiptTablesSchema.pb","MAWArmadilloReceiverFetchInfoTableSchema.pb","MAWArmadilloSyncActionsTableSchema.pb","MAWArmadilloSyncKeysTableSchema.pb","MAWArmadilloTasksTableSchema.pb","MAWArmadilloThreadsTableSchema.pb","MAWArmadilloUnrenderedMessagesTableSchema.pb","MAWArmadilloXMATableSchema.pb","MAWMsgType","MAWODSProxy","MAWXMACTAUtil","WAOdsEnums","WAServerSync.pb","decodeProtobuf"],(function(t,n,r,o,a,i,l){var e={appData:function(t){return I(t)},appMeta:function(t){return T(t)},chunk:function(t){return D(t)},collectionVersions:function(t){return O(t)},deletedMessages:function(t){return _(t)},deviceChangeAlerts:function(t){return u(t)},dualSendMedia:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},dyiBatch:function(t){return N(t)},ebMessageRestoreTasks:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ebMsgRanges:function(t){return M(t)},ebRestoreQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ebUploadQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},editMsgHistory:function(t){return q(t)},encryptionMetaV3:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ephemeralSettings:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},existingUsers:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsBackloggedMessages:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsEncryptionMeta:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsIndexV3:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsPurgeBacklog:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},ftsPurgeThreadBacklog:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},groupInfo:function(t){return h(t)},groupInvites:function(t){return L(t)},historySyncQRCodeData:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},historySyncQRCodeSecretKey:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},igMessageAuxiliaryInfo:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},isDualSend:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},media:function(t){return $(t)},mediaBackup:function(t){return x(t)},mediaKeys:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},messages:function(t){return p(t)},missingKeys:function(t){return A(t)},participants:function(t){return R(t)},pendingMessageStanzaQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},pendingMutations:function(t){return F(t)},pendingReceipts:function(t){return v(t)},pendingStanzas:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},personalSenderKeyStatuses:function(t){return k(t)},poll:function(t){return V(t)},reactions:function(t){return P(t)},receipts:function(t){return b(t)},receiverFetchInfo:function(t){return U(t)},sentBytesCache:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},staleQueue:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for decryption")},syncActions:function(t){return w(t)},syncKeys:function(t){return B(t)},tasks:function(t){return E(t)},threads:function(t){return S(t)},unrenderedMessages:function(t){return f(t)},xma:function(t){return W(t)}};function s(t,n){var o=null;if(Object.prototype.hasOwnProperty.call(e,n))o=e[n](t);else throw r("FBLogger")("messenger_web").mustfixThrow("not a valid table name");return o}function u(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloDeviceChangeAlertsTableSchema.pb").DeviceChangeAlertsTableSchemaProtoSpec,e);return{action:t.action,deviceJid:t.deviceJid,identity:t.identity,isArchived:t.isArchived,latitude:t.latitude,location:t.location,loggedOut:t.loggedOut,longitude:t.longitude,model:t.model,platform:t.platform,ts:t.ts}}function c(e){var t=e.quote,n;if(t!=null){if(t.content==null)throw r("FBLogger")("messenger_web").mustfixThrow("QuotedMsgContent missing upon decoding");var o=t.content,a=o.author,i=o.expirationTs,l=o.externalId,s=o.mediaId,u=o.msgContent,c=o.msgId,d=o.plaintextHash,m=o.sourceId,p=o.specialTextSize,_=o.ts,f=o.type,g=o.xmaMessageType;n={content:babelHelpers.extends({},t.content,{author:a,expirationTs:i,externalId:l,mediaId:s,msgContent:u,msgId:c,plaintextHash:d,sourceId:m,specialTextSize:p,ts:_,type:f,xmaMessageType:g}),remoteJid:t.remoteJid}}return n}function d(e){return e==null?e:new Uint8Array(e)}function m(e){return e==null||e.length===0?new Set:new Set(e)}function p(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMessagesTableSchema.pb").MessagesTableSchemaProtoSpec,e),n=t.msgContent;if(t.type===o("MAWMsgType").MSG_TYPE.FUTUREPROOF){if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("MsgContent missing upon decoding futureproof message");n.subtype=n.subtype}var a=c(t),i=g(t.reportingMeta);return babelHelpers.extends({},t,{msgContent:n,quote:a,reportingMeta:i})}function _(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloDeletedMessagesTableSchema.pb").DeletedMessagesTableSchemaProtoSpec,e);return babelHelpers.extends({},t)}function f(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloUnrenderedMessagesTableSchema.pb").UnrenderedMessagesTableSchemaProtoSpec,e),n=c(t),r=g(t.reportingMeta);return babelHelpers.extends({},t,{quote:n,reportingMeta:r})}function g(e){if(e!=null)return{frankingKey:e.frankingKey!=null?new Uint8Array(e.frankingKey):e.frankingKey,frankingTag:e.frankingTag!=null?new Uint8Array(e.frankingTag):e.frankingTag,frankingVersion:e.frankingVersion,reportingContent:e.reportingContent,reportingTag:e.reportingTag!=null?new Uint8Array(e.reportingTag):e.reportingTag}}function h(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloGroupInfoTableSchema.pb").GroupInfoSchemaProtoSpec,e);return{creationTs:t.creationTs,creator:t.creator,inviter:t.inviter,memberAddMode:t.memberAddMode,msgExpiration:t.msgExpiration,name:t.name,nameOwner:t.nameOwner,nameTs:t.nameTs,participantVersion:t.participantVersion}}function y(e){return e.length===0?null:new Map(e.map(function(e){var t=e.deviceJid;if(t==null||e.serializedPubKey==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected deviceJid or serializedPubKey are missing ");var n=new Uint8Array(e.serializedPubKey),o=d(e.baseKey),a={baseKey:o,pubKey:n};return[t,a]}))}function C(e){return e==null?null:new Map(e.map(function(e){var t;if(e.deviceJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected deviceJID is missing ");return[e.deviceJid,(t=e.count)!=null?t:0]}))}function b(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").ReceiptsTableSchemaProtoSpec,e),n=t.recipientDevices,r=m(n);return{permittedIdentitiesPerDevice:y(t.permittedIdentitiesPerDevice),recipientDevices:r,retryCountsPerDevice:C(t.retryCountsPerDevice)}}function v(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").PendingReceiptsTableSchemaProtoSpec,e)}function S(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloThreadsTableSchema.pb").ThreadsTableSchemaProtoSpec,e);return{archived:t.archived,cannotReplyReason:t.cannotReplyReason,didInsertDualThreadCutoverAdminMsg:t.didInsertDualThreadCutoverAdminMsg,folder:t.folder,isMigratedLocally:t.isMigratedLocally,lastReadMsg:t.lastReadMsg,lastReadMsgReceiptSent:t.lastReadMsgReceiptSent,muteCallsExpireTimeMs:t.muteCallsExpireTimeMs,muteExpireTimeMs:t.muteExpireTimeMs,newestMsg:t.newestMsg,newestMsgTs:t.newestMsgTs,oldestMsg:t.oldestMsg,optimisticThreadKey:t.optimisticThreadKey,snippetMsg:t.snippetMsg,snippetMsgTs:t.snippetMsgTs}}function R(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloParticipantsTableSchema.pb").ParticipantsTableSchemaProtoSpec,e)}function L(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloGroupInvitesTableSchema.pb").GroupInvitesTableSchemaProtoSpec,e)}function E(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloTasksTableSchema.pb").TasksTableSchemaProtoSpec,e)}function k(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloPersonalSenderKeyStatusTableSchema.pb").PersonalSenderKeyStatusTableSchemaProtoSpec,e),n=t.hasSenderKey,r=m(n);return{hasSenderKey:r,rotateSenderKey:t.rotateSenderKey,senderKeyId:t.senderKeyId,senderKeyTs:t.senderKeyTs}}function I(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloAppDataTableSchema.pb").AppDataTableSchemaProtoSpec,e);return{ack:t.ack,contents:t.contents,permittedIdentitiesPerDevice:y(t.permittedIdentitiesPerDevice),recipientDevices:new Set(t.recipientDevices),sendPartial:t.sendPartial,ts:t.ts}}function T(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloAppMetaTableSchema.pb").AppMetaTableSchemaProtoSpec,e)}function D(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").ChunkTableSchemaProtoSpec,e)}function x(e){return o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaBackupSchemaProtoSpec,e)}function $(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaTableSchemaProtoSpec,e),n,a=t.mediaEntries;return a==null?n=new Map:n=new Map(a.map(function(e){if(e.msgId==null||e.mediaEntryData==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected msgId or mediaEntryData are missing ");return[e.msgId,new Uint8Array(e.mediaEntryData)]})),{accessibilitySummaryText:t.accessibilitySummaryText,isVideoGif:t.isVideoGif,mediaEntries:n,mediaType:t.mediaType,plaintextHash:t.plaintextHash,size:t.size,ts:t.ts,validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedResult:t.validatedResult,validatedVideoInfo:t.validatedVideoInfo}}function P(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReactionsTableSchema.pb").ReactionsTableSchemaProtoSpec,e);return t.ts!=null&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MIGRATE_REACTION_TS_AS_INDEX,key:"reaction_ts_encrypted"}),babelHelpers.extends({ack:t.ack,author:t.author,groupingKey:t.groupingKey,reaction:t.reaction,reactToAuthor:t.reactToAuthor,senderTimestampMs:t.senderTimestampMs},t.ts!=null?{ts:t.ts}:{})}function N(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloDyiBatchTableSchema.pb").DyiBatchTableSchemaProtoSpec,e);return{isThread:t.isThread,numMessages:t.numMessages,numMessagesRestored:t.numMessagesRestored,numThreadsRestored:t.numThreadsRestored,oldestTs:t.oldestTs,qplFlowDescriptor:t.qplFlowDescriptor,qplInstanceKeyE2E:t.qplInstanceKeyE2E,qplInstanceKeyForThread:t.qplInstanceKeyForThread,threadId:t.threadId}}function M(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloEBMsgRangesTableSchema.pb").EBMsgRangesTableSchemaProtoSpec,e);return{creationTime:t.creationTime,maxMsgExternalId:t.maxMsgExternalId,maxMsgSortOrderMs:t.maxMsgSortOrderMs,minMsgExternalId:t.minMsgExternalId,minMsgSortOrderMs:t.minMsgSortOrderMs}}function w(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloSyncActionsTableSchema.pb").SyncActionsTableSchemaProtoSpec,e);return{binarySyncData:t.binarySyncData,keyId:t.keyId,timestamp:t.timestamp,valueMac:t.valueMac,version:t.version}}function A(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloMissingKeysTableSchema.pb").MissingKeysTableSchemaProtoSpec,e),n;return t.deviceResponses==null?n=new Map:n=new Map(t.deviceResponses.map(function(e){if(e.deviceId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected deviceId is missing");return[e.deviceId,e.deviceResponse]})),{deviceResponses:n,keyId:t.keyId,timestamp:t.timestamp}}function F(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloPendingMutationsTableSchema.pb").PendingMutationsTableSchemaProtoSpec,e),n;switch(t.operation){case o("MAWArmadilloPendingMutationsTableSchema.pb").SYNCD_MUTATION_SYNCD_OPERATION.SET:n=o("WAServerSync.pb").SyncdMutation$SyncdOperation.SET;break;case o("MAWArmadilloPendingMutationsTableSchema.pb").SYNCD_MUTATION_SYNCD_OPERATION.REMOVE:n=o("WAServerSync.pb").SyncdMutation$SyncdOperation.REMOVE;break;default:throw r("FBLogger")("messenger_web").mustfixThrow("operation missing when decoding PendingMutation")}return{binarySyncAction:t.binarySyncAction,operation:n,timestamp:t.timestamp,version:t.version}}function O(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloCollectionVersionsTableSchema.pb").CollectionVersionsTableSchemaProtoSpec,e);return{finiteFailureStartTime:t.finiteFailureStartTime,isCollectionInMacMismatchFatal:t.isCollectionInMacMismatchFatal,isCollectionLthashInconsistent:t.isCollectionLthashInconsistent,ltHash:t.ltHash,state:t.state,version:t.version}}function B(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloSyncKeysTableSchema.pb").SyncKeysTableSchemaProtoSpec,e);return{fingerprint:t.fingerprint,keyData:t.keyData,timestamp:t.timestamp}}function W(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloXMATableSchema.pb").XMATableSchemaProtoSpec,e);return{author:t.author,ctas:t.ctas.map(function(e){return o("MAWXMACTAUtil").fromMAWCTAEncode(e)}),defaultCTA:t.defaultCTA==null?t.defaultCTA:o("MAWXMACTAUtil").fromMAWCTAEncode(t.defaultCTA),defaultPreviewMediaPlaintextHash:t.defaultPreviewMediaPlaintextHash,faviconPlaintextHash:t.faviconPlaintextHash,headerMediaPlaintextHash:t.headerMediaPlaintextHash,headerTitle:t.headerTitle,isTombstoned:t.isTombstoned,maxSubtitleNumOfLines:t.maxSubtitleNumOfLines,maxTitleNumOfLines:t.maxTitleNumOfLines,msgId:t.msgId,overlayDescription:t.overlayDescription,overlayIconGlyph:t.overlayIconGlyph,overlayTitle:t.overlayTitle,previewMediaIds:t.previewMediaIds,subtitleText:t.subtitleText,targetId:t.targetId,targetType:t.targetType,targetUsername:t.targetUsername,threadJid:t.threadJid,titleText:t.titleText,xmaLayoutType:t.xmaLayoutType}}function q(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloEditMsgHistoryTableSchema.pb").EditMsgHistoryTableSchemaProtoSpec,e);return{author:t.author,editExternalId:t.editExternalId,editTs:t.editTs,msgContent:t.msgContent,sendStatus:t.sendStatus,specialTextSize:t.specialTextSize}}function U(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloReceiverFetchInfoTableSchema.pb").ReceiverFetchInfoTableSchemaProtoSpec,e);return{accessibilitySummaryText:t.accessibilitySummaryText,mimetype:t.mimetype,previewHeight:t.previewHeight,previewUrl:t.previewUrl,previewUrlExpirationTimestampMs:t.previewUrlExpirationTimestampMs,previewWidth:t.previewWidth,type:t.type}}function V(e){var t=o("decodeProtobuf").decodeProtobuf(o("MAWArmadilloPollTableSchema.pb").PollTableSchemaProtoSpec,e),n=new Map(t.pollOptions.map(function(e){var t=e.pollOptionHash;if(t==null||e.pollOption==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected pollOptionHash or pollOption is missing");return[t,{optionText:e.pollOption.optionText,voteAuthors:new Set(e.pollOption.voteAuthors)}]}).filter(Boolean)),a=new Map(t.latestSenderTimestampsMs.map(function(e){if(e.author==null||e.latestSenderTimestampMs==null)throw r("FBLogger")("messenger_web").mustfixThrow("Expected author or latestSenderTimestampMs are missing");return[e.author,e.latestSenderTimestampMs]}));return{encKey:t.encKey,latestSenderTimestampsMs:a,pollAuthor:t.pollAuthor,pollOptions:n,pollParticipantCount:t.pollParticipantCount,pollState:t.pollState,selectableOptionsCount:t.selectableOptionsCount,title:t.title}}l.decodeDbObj=s}),98);
__d("WASyncdKeyTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}function l(e){return e}function s(e){return e}function u(e){return e}i.toSyncKeyId=e,i.fromSyncKeyId=l,i.toSyncKeyData=s,i.fromSyncKeyData=u}),66);
__d("MAWDbObjEncode",["FBLogger","MAWArmadilloAppDataTableSchema.pb","MAWArmadilloAppMetaTableSchema.pb","MAWArmadilloDeletedMessagesTableSchema.pb","MAWArmadilloDeviceChangeAlertsTableSchema.pb","MAWArmadilloDyiBatchTableSchema.pb","MAWArmadilloEBMsgRangesTableSchema.pb","MAWArmadilloEditMsgHistoryTableSchema.pb","MAWArmadilloGroupInfoTableSchema.pb","MAWArmadilloGroupInvitesTableSchema.pb","MAWArmadilloMediaTablesSchema.pb","MAWArmadilloMessagesTableSchema.pb","MAWArmadilloParticipantsTableSchema.pb","MAWArmadilloPersonalSenderKeyStatusTableSchema.pb","MAWArmadilloPollTableSchema.pb","MAWArmadilloReactionsTableSchema.pb","MAWArmadilloReceiptTablesSchema.pb","MAWArmadilloReceiverFetchInfoTableSchema.pb","MAWArmadilloTasksTableSchema.pb","MAWArmadilloThreadsTableSchema.pb","MAWArmadilloUnrenderedMessagesTableSchema.pb","MAWArmadilloXMATableSchema.pb","MAWMsgType","MAWXMACTAUtil","WASyncdKeyTypes","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=["ack","altIndex","collapsibleId","externalId","messageDeleteTs","messageExpirationTs","msgId","pollStanzaId","protocolMsgId","quoteExpirationTs","quoteExternalId","revokedExternalId","rowId","serverTs","sortOrderMs","threadJid","unsendMsgContentDeleteTs"],s=["author","chat","externalId","rowId"],u={appData:k,appMeta:I,chunk:T,deletedMessages:_,deviceChangeAlerts:c,dualSendMedia:d,dyiBatch:P,ebMessageRestoreTasks:d,ebMsgRanges:N,ebRestoreQueue:d,ebUploadQueue:d,editMsgHistory:w,encryptionMetaV3:d,ephemeralSettings:d,existingUsers:d,ftsBackloggedMessages:d,ftsEncryptionMeta:d,ftsIndexV3:d,ftsPurgeBacklog:d,ftsPurgeThreadBacklog:d,groupInfo:g,groupInvites:R,historySyncQRCodeData:d,historySyncQRCodeSecretKey:d,igMessageAuxiliaryInfo:d,isDualSend:d,media:x,mediaBackup:D,mediaKeys:d,messages:p,participants:S,pendingMessageStanzaQueue:d,pendingReceipts:b,pendingStanzas:d,personalSenderKeyStatuses:E,poll:F,reactions:$,receipts:C,receiverFetchInfo:A,sentBytesCache:d,staleQueue:d,tasks:L,threads:v,unrenderedMessages:f,xma:M};function c(e){var t={action:e.action,deviceJid:e.deviceJid,identity:e.identity,isArchived:e.isArchived,latitude:e.latitude,location:e.location,loggedOut:e.loggedOut,longitude:e.longitude,model:e.model,platform:e.platform,ts:e.ts};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloDeviceChangeAlertsTableSchema.pb").DeviceChangeAlertsTableSchemaProtoSpec,t).readByteArrayView()}}function d(e){throw r("FBLogger")("messenger_web").mustfixThrow("unexpected table for encryption")}function m(e,t){var n=null;if(Object.prototype.hasOwnProperty.call(u,t))n=u[t](e);else throw r("FBLogger")("messenger_web").mustfixThrow("not a valid table name");return n}function p(t){var n=t.ack,r=t.altIndex,a=t.collapsibleId,i=t.externalId,l=t.messageDeleteTs,s=t.messageExpirationTs,u=t.msgId,c=t.pollStanzaId,d=t.protocolMsgId,m=t.quoteExpirationTs,p=t.quoteExternalId,_=t.revokedExternalId,f=t.rowId,g=t.serverTs,h=t.sortOrderMs,y=t.threadJid,C=t.unsendMsgContentDeleteTs,b=babelHelpers.objectWithoutPropertiesLoose(t,e),v=b,S;if(v.quote==null)S=v.quote;else{var R,L={author:v.quote.content.author,expirationTs:v.quote.content.expirationTs,externalId:(R=v.quote)==null?void 0:R.content.externalId,mediaId:v.quote.content.mediaId,msgContent:v.quote.content.msgContent,msgId:v.quote.content.msgId,plaintextHash:v.quote.content.plaintextHash,sourceId:v.quote.content.sourceId,specialTextSize:v.quote.content.specialTextSize,ts:v.quote.content.ts,type:v.quote.content.type,xmaMessageType:v.quote.content.xmaMessageType},E={content:L,remoteJid:v.quote.remoteJid};S=E}var k=v.msgContent;v.type===o("MAWMsgType").MSG_TYPE.FUTUREPROOF&&(k={protobuf:v.msgContent.protobuf,subtype:v.msgContent.subtype});var I=v.ravenEphemeralType,T=v.ravenEphemeralMediaState,D=I!=null?I:null,x=T!=null?T:null,$={applicationErrorCode:v.applicationErrorCode,author:v.author,editCount:v.editCount,ephemeralCounterStarted:v.ephemeralCounterStarted,ephemeralMsgDisappeared:v.ephemeralMsgDisappeared,ephemeralSetting:v.ephemeralSetting,forwardingScore:v.forwardingScore,groupId:v.groupId,groupIndex:v.groupIndex,groupSize:v.groupSize,hdType:v.hdType,isCollapsed:v.isCollapsed,isExpiredXmaMsg:v.isExpiredXmaMsg,isForwarded:v.isForwarded,mediaId:v.mediaId,msgContent:k,originalTs:v.originalTs,quote:S,ravenEphemeralMediaState:x,ravenEphemeralType:D,receiverFetchId:v.receiverFetchId,reportingMeta:v.reportingMeta,resendCount:v.resendCount,source:v.source,specialTextSize:v.specialTextSize,ts:v.ts,type:v.type,xmaMessageType:v.xmaMessageType};return{encodedFields:$,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMessagesTableSchema.pb").MessagesTableSchemaProtoSpec,$).readByteArrayView()}}function _(e){var t=e.author,n=e.chat,r=e.externalId,a=e.rowId,i=babelHelpers.objectWithoutPropertiesLoose(e,s),l={reason:String(i.reason)};return{encodedFields:l,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloDeletedMessagesTableSchema.pb").DeletedMessagesTableSchemaProtoSpec,l).readByteArrayView()}}function f(e){var t;if(e.quote==null)t=e.quote;else{var n,r={author:e.quote.content.author,expirationTs:e.quote.content.expirationTs,externalId:(n=e.quote)==null?void 0:n.content.externalId,mediaId:e.quote.content.mediaId,msgContent:e.quote.content.msgContent,msgId:e.quote.content.msgId,plaintextHash:e.quote.content.plaintextHash,sourceId:e.quote.content.sourceId,ts:e.quote.content.ts,type:e.quote.content.type,xmaMessageType:e.quote.content.xmaMessageType},a={content:r,remoteJid:e.quote.remoteJid};t=a}var i={ack:e.ack,author:e.author,ephemeralSetting:e.ephemeralSetting,groupName:e.groupName,invitedParticipantUserJid:e.invitedParticipantUserJid,mediaId:e.mediaId,msgContent:e.msgContent,quote:t,reportingMeta:e.reportingMeta,resendCount:e.resendCount,ts:e.ts,type:e.type,xmaMessageType:e.xmaMessageType};return{encodedFields:i,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloUnrenderedMessagesTableSchema.pb").UnrenderedMessagesTableSchemaProtoSpec,i).readByteArrayView()}}function g(e){var t={creationTs:e.creationTs,creator:e.creator,inviter:e.inviter,memberAddMode:e.memberAddMode,msgExpiration:e.msgExpiration,name:e.name,nameOwner:e.nameOwner,nameTs:e.nameTs,participantVersion:e.participantVersion};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloGroupInfoTableSchema.pb").GroupInfoSchemaProtoSpec,t).readByteArrayView()}}function h(e){return e==null?e:Array.from(e,function(e){var t=e[0],n=e[1];return{baseKey:n.baseKey,deviceJid:t,serializedPubKey:n.pubKey}})}function y(e){return e==null?null:Array.from(e,function(e){var t=e[0],n=e[1];return{count:n,deviceJid:t}})}function C(e){var t=Array.from(e.recipientDevices),n={permittedIdentitiesPerDevice:h(e.permittedIdentitiesPerDevice),recipientDevices:t,retryCountsPerDevice:y(e.retryCountsPerDevice)};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").ReceiptsTableSchemaProtoSpec,n).readByteArrayView()}}function b(e){var t={author:e.author,deliveryReceipts:e.deliveryReceipts,externalId:e.externalId,readReceipts:e.readReceipts,thread:e.thread};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReceiptTablesSchema.pb").PendingReceiptsTableSchemaProtoSpec,t).readByteArrayView()}}function v(e){var t={archived:e.archived,cannotReplyReason:e.cannotReplyReason,didInsertDualThreadCutoverAdminMsg:e.didInsertDualThreadCutoverAdminMsg,folder:e.folder,isMigratedLocally:e.isMigratedLocally,lastReadMsg:e.lastReadMsg,lastReadMsgReceiptSent:e.lastReadMsgReceiptSent,newestMsgTs:e.newestMsgTs,oldestMsg:e.oldestMsg,optimisticThreadKey:e.optimisticThreadKey,snippetMsg:e.snippetMsg,snippetMsgTs:e.snippetMsgTs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloThreadsTableSchema.pb").ThreadsTableSchemaProtoSpec,t).readByteArrayView()}}function S(e){var t={addressable:e.addressable,deliveredWatermarkTs:e.deliveredWatermarkTs,lastReadActionTs:e.lastReadActionTs,lastReadWatermarkTs:e.lastReadWatermarkTs,type:e.type};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloParticipantsTableSchema.pb").ParticipantsTableSchemaProtoSpec,t).readByteArrayView()}}function R(e){var t={caption:e.caption,inviteCode:e.inviteCode,inviteExpirationTs:e.inviteExpirationTs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloGroupInvitesTableSchema.pb").GroupInvitesTableSchemaProtoSpec,t).readByteArrayView()}}function L(e){var t={scheduledTime:e.scheduledTime};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloTasksTableSchema.pb").TasksTableSchemaProtoSpec,t).readByteArrayView()}}function E(e){var t=Array.from(e.hasSenderKey),n={hasSenderKey:t,rotateSenderKey:e.rotateSenderKey,senderKeyId:e.senderKeyId,senderKeyTs:e.senderKeyTs};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloPersonalSenderKeyStatusTableSchema.pb").PersonalSenderKeyStatusTableSchemaProtoSpec,n).readByteArrayView()}}function k(e){var t;switch(e.contents.type){case"meta_sync":{var n=[];for(var a of e.contents.actions)a.chatAction?n.push({chatAction:a.chatAction}):a.messageAction&&n.push({messageAction:a.messageAction});t={actions:n,type:"meta_sync"};break}case"backups_secrets":{t={encryptedBackupsSecrets:e.contents.encryptedBackupsSecrets,type:"backups_secrets"};break}case"sync_key_share":{var i;t={syncKeyShare:{keys:e.contents.syncKeyShare.keys,orphanKeys:(i=e.contents.syncKeyShare)==null||(i=i.orphanKeys)==null?void 0:i.map(o("WASyncdKeyTypes").fromSyncKeyId)},type:"sync_key_share"};break}case"sync_key_request":{t={syncKeyRequest:{keyIds:e.contents.syncKeyRequest.keyIds.map(o("WASyncdKeyTypes").fromSyncKeyId)},type:"sync_key_request"};break}default:throw e.contents.type,r("FBLogger")("messenger_web").mustfixThrow("Unknown appdata type: "+e.contents.type)}var l={ack:e.ack,contents:t,permittedIdentitiesPerDevice:h(e.permittedIdentitiesPerDevice),recipientDevices:Array.from(e.recipientDevices),sendPartial:e.sendPartial,ts:e.ts};return{encodedFields:l,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloAppDataTableSchema.pb").AppDataTableSchemaProtoSpec,l).readByteArrayView()}}function I(e){var t={value:e.value};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloAppMetaTableSchema.pb").AppMetaTableSchemaProtoSpec,t).readByteArrayView()}}function T(e){var t={blobData:e.blobData,mimetype:e.mimetype,plaintextHash:e.plaintextHash};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").ChunkTableSchemaProtoSpec,t).readByteArrayView()}}function D(e){var t={fbid:e.fbid};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaBackupSchemaProtoSpec,t).readByteArrayView()}}function x(e){var t=Array.from(e.mediaEntries,function(e){var t=e[0],n=e[1];return{mediaEntryData:n,msgId:t}}),n={accessibilitySummaryText:e.accessibilitySummaryText,isVideoGif:e.isVideoGif,mediaEntries:t,mediaType:e.mediaType,plaintextHash:e.plaintextHash,size:e.size,ts:e.ts,validatedAudioInfo:e.validatedAudioInfo,validatedDocumentFileInfo:e.validatedDocumentFileInfo,validatedImageInfo:e.validatedImageInfo,validatedResult:e.validatedResult,validatedVideoInfo:e.validatedVideoInfo};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloMediaTablesSchema.pb").MediaTableSchemaProtoSpec,n).readByteArrayView()}}function $(e){var t={ack:e.ack,author:e.author,groupingKey:e.groupingKey,reaction:e.reaction,reactToAuthor:e.reactToAuthor,senderTimestampMs:e.senderTimestampMs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReactionsTableSchema.pb").ReactionsTableSchemaProtoSpec,t).readByteArrayView()}}function P(e){var t={isThread:e.isThread,numMessages:e.numMessages,numMessagesRestored:e.numMessagesRestored,numThreadsRestored:e.numThreadsRestored,oldestTs:e.oldestTs,qplFlowDescriptor:e.qplFlowDescriptor,qplInstanceKeyE2E:e.qplInstanceKeyE2E,qplInstanceKeyForThread:e.qplInstanceKeyForThread,threadId:e.threadId};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloDyiBatchTableSchema.pb").DyiBatchTableSchemaProtoSpec,t).readByteArrayView()}}function N(e){var t={creationTime:e.creationTime,maxMsgExternalId:e.maxMsgExternalId,maxMsgSortOrderMs:e.maxMsgSortOrderMs,minMsgExternalId:e.minMsgExternalId,minMsgSortOrderMs:e.minMsgSortOrderMs};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloEBMsgRangesTableSchema.pb").EBMsgRangesTableSchemaProtoSpec,t).readByteArrayView()}}function M(e){var t=e.ctas==null?[]:e.ctas.map(function(e){return o("MAWXMACTAUtil").toMAWCTAEncode(e)}),n={author:e.author,ctas:t,defaultCTA:e.defaultCTA==null?e.defaultCTA:o("MAWXMACTAUtil").toMAWCTAEncode(e.defaultCTA),defaultPreviewMediaPlaintextHash:e.defaultPreviewMediaPlaintextHash,faviconPlaintextHash:e.faviconPlaintextHash,headerMediaPlaintextHash:e.headerMediaPlaintextHash,headerTitle:e.headerTitle,isTombstoned:e.isTombstoned,maxSubtitleNumOfLines:e.maxSubtitleNumOfLines,maxTitleNumOfLines:e.maxTitleNumOfLines,msgId:e.msgId,overlayDescription:e.overlayDescription,overlayIconGlyph:e.overlayIconGlyph,overlayTitle:e.overlayTitle,previewMediaIds:e.previewMediaIds,subtitleText:e.subtitleText,targetId:e.targetId,targetType:e.targetType,targetUsername:e.targetUsername,threadJid:e.threadJid,titleText:e.titleText,xmaLayoutType:e.xmaLayoutType};return{encodedFields:n,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloXMATableSchema.pb").XMATableSchemaProtoSpec,n).readByteArrayView()}}function w(e){var t={author:e.author,editExternalId:e.editExternalId,editTs:e.editTs,msgContent:e.msgContent,sendStatus:e.sendStatus,specialTextSize:e.specialTextSize};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloEditMsgHistoryTableSchema.pb").EditMsgHistoryTableSchemaProtoSpec,t).readByteArrayView()}}function A(e){var t={accessibilitySummaryText:e.accessibilitySummaryText,mimetype:e.mimetype,previewHeight:e.previewHeight,previewUrl:e.previewUrl,previewUrlExpirationTimestampMs:e.previewUrlExpirationTimestampMs,previewWidth:e.previewWidth,type:e.type};return{encodedFields:t,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloReceiverFetchInfoTableSchema.pb").ReceiverFetchInfoTableSchemaProtoSpec,t).readByteArrayView()}}function F(e){var t=Array.from(e.pollOptions,function(e){var t=e[0],n=e[1];return{pollOption:{optionText:n.optionText,voteAuthors:Array.from(n.voteAuthors)},pollOptionHash:t}}),n=Array.from(e.latestSenderTimestampsMs,function(e){var t=e[0],n=e[1];return{author:t,latestSenderTimestampMs:n}}),r={encKey:e.encKey,latestSenderTimestampsMs:n,pollAuthor:e.pollAuthor,pollOptions:t,pollParticipantCount:e.pollParticipantCount,pollState:e.pollState,selectableOptionsCount:e.selectableOptionsCount,title:e.title};return{encodedFields:r,proto:o("encodeProtobuf").encodeProtobuf(o("MAWArmadilloPollTableSchema.pb").PollTableSchemaProtoSpec,r).readByteArrayView()}}l.encodeDbObj=m,l.encodeDbPollForEncryption=F}),98);
__d("MAWMpsMigrationRunningState",[],(function(t,n,r,o,a,i){"use strict";var e=!1;function l(){return e}function s(t){e=t}i.isMawMpsMigrationRunning=l,i.setIsMawMpsMigrationRunning=s}),66);
__d("MAWDbObjEncryption",["ExecutionEnvironment","FBLogger","MAWBridge","MAWCryptoConsts","MAWDbEncryptObjContent","MAWDbObjDecode","MAWDbObjEncode","MAWDexieTable","MAWIndexedDb","MAWKeychainCrypto","MAWKeychainNaClCrypto","MAWKeychainUtil","MAWMpsMigrationRunningState","MAWQplProxy","MAWUnrecoverableDbErrors","MWEARKeychainV3","MWEARKeychainV3Errors","ODS","WABase64","WATimeUtils","getErrorSafe","gkx","isEncryptionAtRestEnabled","pageID","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u="_encryptedContent",c=new Set(["threads","messages","participants"]);function d(e,t,n){if(!(r("isEncryptionAtRestEnabled")()||r("gkx")("23910")===!0)||!o("MAWIndexedDb").TABLES_TO_ENCRYPT.includes(t))return e;var a=o("MAWQplProxy").startQplUserFlow(r("qpl")._(25300256,"115"),{bool:{isWorker:(s||(s=r("ExecutionEnvironment"))).isInWorker,useMawEar:o("MWEARKeychainV3").isKeychainSettled("maw_ear")},string:{pageID:r("pageID"),tableName:t}});try{var i=babelHelpers.extends({},e),l=n(o("MWEARKeychainV3").isKeychainSettled("maw_ear")?"maw_ear":"global_ear"),d=l.keys,m=d[0],p=l.version,_=l.randomisedVersion;o("MWEARKeychainV3").isKeychainSettled("maw_ear")===!1&&r("FBLogger")("messenger_web").mustfix("[EAR] Encrypting %s data with global ear. Transactor: %s",t,o("MAWDexieTable").getDexiePSDItem("transactorName")),a.addAnnotations({int:{keyVersion:p,randomisedVersion:_}});var f=o("MAWKeychainUtil").makeAAD(p,o("MAWCryptoConsts").CIPHER_ID),g=o("MAWDbObjEncode").encodeDbObj(e,t),h=g.encodedFields,y=g.proto;Object.keys(h).forEach(function(t){Object.prototype.hasOwnProperty.call(e,t)&&delete i[t]});var C=o("MAWDbEncryptObjContent").encryptContent(m,y,f);return i[u]=C,c.has(t)&&(i.updatedAt_S456130=Date.now(),i.randomisedVersion_S456130=_,i.encryptedWith_S456130=o("MWEARKeychainV3").isKeychainSettled("maw_ear")?"maw_ear":"global_ear",i.keyVersion_S456130=p),a==null||a.endSuccess(),i}catch(e){var b=r("getErrorSafe")(e);throw a==null||a.endFail("ear_encrypt_fail"),r("FBLogger")("messenger_web").catching(b).mustfixThrow("[%s] %s - Encrypted dexie was unable to encrypt an entity for table %s",b.name,b.message,t)}}function m(t,n,a){if(!o("MAWIndexedDb").TABLES_TO_ENCRYPT.includes(n)||!Object.prototype.hasOwnProperty.call(t,u))return t;var i=(s||(s=r("ExecutionEnvironment"))).isInMainThread?null:o("MAWQplProxy").startQplUserFlow(r("qpl")._(25313004,"118"));i==null||i.addAnnotations({bool:{isWorker:(s||(s=r("ExecutionEnvironment"))).isInWorker,useMawEar:o("MWEARKeychainV3").isKeychainSettled("maw_ear")},string:{pageID:r("pageID"),tableName:n}});var l;try{var d=t[u],m=babelHelpers.extends({},t);(e||(e=o("ODS"))).bumpEntityKey(3185,"maw_db_ear_decryption","encrypted_content_type."+n+"."+(d instanceof ArrayBuffer?"ArrayBuffer":"string"));var f=d instanceof ArrayBuffer?d:o("WABase64").decodeB64(d),g=o("MAWKeychainCrypto").getKeyVersionFromCipherDataString(f),h=g.aadLengthInBytes,y=g.keyVersion,C=a(o("MWEARKeychainV3").isKeychainSettled("maw_ear")?"maw_ear":"global_ear",y);l=C;var b=C.dbEntry,v=C.keys,S=C.randomisedVersion;i==null||i.addAnnotations({int:{contentVersion:t==null?void 0:t.keyVersion_S456130,keyVersion:y,randomisedVersion:S},string:{encryptedWith:t==null?void 0:t.encryptedWith_S456130,randomisedVersionEncryption:t==null?void 0:t.randomisedVersion_S456130}});var R={},L,E;for(var k of v)try{L=o("MAWKeychainNaClCrypto").decryptArrayBuffer(k,f,y,b.formatVersion,h);break}catch(e){E=e}if(L==null)throw r("getErrorSafe")(E);var I=o("MAWDbObjDecode").decodeDbObj(L,n);Object.keys(I).forEach(function(e){R[e]=I[e]}),delete m[u];var T=babelHelpers.extends({},m,R);return i==null||i.endSuccess(),T}catch(e){var D,x,$;if(c.has(n)){var P;i==null||i.addAnnotations({int:{updatedAt:(P=t==null?void 0:t.updatedAt_S456130)!=null?P:-1}})}if((e instanceof o("MAWKeychainNaClCrypto").EARDecryptionError||e instanceof o("MWEARKeychainV3Errors").EARKeychainNotFoundError)&&o("MAWMpsMigrationRunningState").isMawMpsMigrationRunning()){i==null||i.addAnnotations({bool:{earDecryptionErrorSuppressed:!0}}),r("FBLogger")("messenger_web").mustfix("[EAR] Ignoring EAR decryption error during MAW->MPS migration. Table: %s.",n);return}(s||(s=r("ExecutionEnvironment"))).isInWorker&&(e instanceof o("MAWKeychainNaClCrypto").EARDecryptionError||e instanceof o("MWEARKeychainV3Errors").EARKeychainNotFoundError)&&(r("FBLogger")("messenger_web").mustfix("[EAR] Encountered EAR Error - submitting unrecoverableDbError. Table: %s.",n),i==null||i.addAnnotations({bool:{unrecoverableDbError:!0}}),o("MAWBridge").getBridge().fireAndForget("event","unrecoverableDbError",{error:new(o("MAWUnrecoverableDbErrors")).EarRuntimeError}));var N=r("getErrorSafe")(e);throw i==null||i.markError("ear_decrypt_exception",null,N),i==null||i.endFail("ear_decrypt_fail"),r("FBLogger")("messenger_web").catching(N).mustfixThrow("[%s] %s - (v2) Encrypted dexie was unable to decrypt an entity for table %s. UpdatedAt: %s. KeyStatus: %s. Signature matches: %s. Key source: %s. Using MAW EAR: %s. Worker: %s. Encrypted With: %s. PageID: %s. Source: %s",N.name,N.message,n,p(t==null?void 0:t.updatedAt_S456130),_(t,l),(t==null?void 0:t.randomisedVersion_S456130)!=null&&((D=l)==null?void 0:D.randomisedVersion)!=null?t.randomisedVersion_S456130===l.randomisedVersion:null,(x=($=l)==null?void 0:$.dbEntry.source)!=null?x:"-1",o("MWEARKeychainV3").isKeychainSettled("maw_ear"),(s||(s=r("ExecutionEnvironment"))).isInWorker,t==null?void 0:t.encryptedWith_S456130,r("pageID"),o("MAWDexieTable").getDexiePSDItem("transactorName"))}}function p(e){if(e==null)return"unknown";var t=Date.now()-e,n=Math.floor(t/(1e3*60*60*24));return n<1?"0-1 days":n<7?"1-7 days":n<14?"7-14 days":n<30?"14-30 days":"30+ days"}function _(e,t){if((e==null?void 0:e.updatedAt_S456130)==null||t==null)return null;var n=o("WATimeUtils").castToUnixTime(e.updatedAt_S456130/1e3),r=t.dbEntry.expiration-o("MAWCryptoConsts").ENC_KEY_TTL;return n===r?"same":n>r?"key_older":"key_newer"}l.ENCRYPTED_COLUMN_NAME=u,l.encryptDbObj=d,l.decryptDbObj=m}),98);
__d("MAWHMACKey",["MAWCryptoConsts","MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWKeychainUtil","MAWSubtleCrypto","MAWTransactionMode","WABase64","tweetnacl-auth"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e=o("MAWKeychainUtil").getBufferWithRandomValuesFromLength(o("MAWCryptoConsts").HKDF_SEED_LENGTH_IN_BYTES);return c(e).then(function(e){return o("MAWSubtleCrypto").MAWSubtleCrypto.exportKey("raw",e)})}function s(e,t){var n=new TextEncoder().encode(e),a=new Uint8Array(t),i=r("tweetnacl-auth")(n,a);return o("WABase64").encodeB64UrlSafe(i)}function u(){return e().then(function(e){return o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READWRITE},"generateAndInsertHMACKey",function(t){return function(){return o("MAWDbMsgTypeVersionTxns").getHMACKey(t).then(function(n){return n!=null?n:o("MAWDbMsgTypeVersionTxns").addHMACKey(t,e).then(function(){return e})})}})()})}function c(e){return o("MAWSubtleCrypto").MAWSubtleCrypto.importKey("raw",e,{hash:"SHA-256",name:"HMAC"},!0,["sign"])}l.genHMACKey=e,l.hmacTweetNaCl=s,l.generateAndInsertHMACKey=u}),98);
__d("MAWMediaUtils",["FBLogger","MAWDbMedia","MAWDexieTable","MAWHMACKey","MAWImageUtils","MAWMsgType","WAAsConsumerApplication","WABlobToArrayBuffer","WAGlobals","WAHashUtils","WAMsgType","WATimeUtils","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){switch(t===void 0&&(t="media"),e){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return t==="xma-media"?"xma-image":"image";case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return"video";case o("MAWDbMedia").MEDIA_TYPE.PTT:return"ptt";case o("MAWDbMedia").MEDIA_TYPE.GIF:return"gif";case o("MAWDbMedia").MEDIA_TYPE.STICKER:return"sticker";case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return"document";default:throw r("FBLogger")("messenger_web").mustfixThrow("get a wrong media file with type %s",e)}}function s(e){try{return o("WABlobToArrayBuffer").blobToArrayBuffer(e).then(u)}catch(e){var t=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").mustfixThrow("Got %s when convert the blob to Uint8Array",t.message)}}function u(e){return self.crypto.subtle.digest("SHA-256",e).then(function(e){return new Uint8Array(e)})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield s(e),n=o("WAHashUtils").toPlaintextHash(t),r=_(n);return[n,r]}),d.apply(this,arguments)}function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield u(e),n=o("WAHashUtils").toPlaintextHash(t);return n}),p.apply(this,arguments)}function _(e){var t=o("WAGlobals").getHMACKey();return o("WAHashUtils").toHashedPlaintextHash(o("MAWHMACKey").hmacTweetNaCl(e,t))}function f(e){if(e==null)return null;var t="preview-"+o("WATimeUtils").unixTime().toString()+".jpeg";return g(e,t,"image/jpeg")}function g(e,t,n){return new File([new Blob([new Uint8Array(e)],{type:n})],t,{type:n})}function h(e,t,n){var r=function(){return n!=null?o("MAWDexieTable").dexieResolve(n.filter(function(e){return e.type!==o("WAMsgType").REVOKED&&t.msgIds.includes(e.msgId)})):e.messages.where("msgId").anyOf(t.msgIds).filter(function(e){return e.type!==o("WAMsgType").REVOKED}).toArray()};return r().then(function(e){return C(t,e)})}function y(e){return e.reduce(function(e,t){var n=t.hdType;return n!=null&&(e[t.msgId]=n),e},{})}function C(e,t){var n=t.filter(function(t){return t.type!==o("WAMsgType").REVOKED&&e.msgIds.includes(t.msgId)}),a=n.map(function(e){return e.msgId}),i=babelHelpers.extends({},e,{msgIds:a}),l=n.reduce(function(e,t){return e[t.msgId]=o("WATimeUtils").castToMillisTime(t.sortOrderMs!=null?t.sortOrderMs:t.ts*1e3),e},{});if(i=babelHelpers.extends({},i,{messagesSortOrderMs:l}),n.every(function(e){return e.type===o("WAMsgType").STICKER})){var s=o("MAWImageUtils").boundHeightWidth(i.previewHeight,i.previewWidth,o("MAWImageUtils").STICKER_THUMBNAIL_MAX_SIZE),u=s.height,c=s.width;i=babelHelpers.extends({},i,{mediaType:o("MAWDbMedia").MEDIA_TYPE.STICKER,previewHeight:u,previewHeightLarge:u,previewWidth:c,previewWidthLarge:c})}var d=new Set(n.map(function(e){return e.type}));return d.forEach(function(t){t!==o("MAWMsgType").MSG_TYPE.RAVEN&&e.mediaType!==b(t)&&r("FBLogger")("messenger_web").mustfix("Message and media type mismatch: message with type %s is associated with media with type %s",t,e.mediaType)}),i}function b(e){switch(e){case o("MAWMsgType").MSG_TYPE.IMAGE:return o("MAWDbMedia").MEDIA_TYPE.IMAGE;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("MAWDbMedia").MEDIA_TYPE.VIDEO;case o("MAWMsgType").MSG_TYPE.PTT:return o("MAWDbMedia").MEDIA_TYPE.PTT;case o("MAWMsgType").MSG_TYPE.GIF:return o("MAWDbMedia").MEDIA_TYPE.GIF;case o("MAWMsgType").MSG_TYPE.STICKER:return o("MAWDbMedia").MEDIA_TYPE.STICKER;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE}}function v(e){var t,n,r=((t=e.ancillary)==null?void 0:t.gifPlayback)===!0,a=((n=e.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.mimetype)===o("WAAsConsumerApplication").GIF_MIME_TYPE;return r&&a}l.getServerMediaTypeFromMediaType=e,l.hashBlob=s,l.hashArrayBuffer=u,l.genBlobHashes=c,l.genHashFromArrayBuffer=m,l.genHMACPlaintextHash=_,l.convertJpegThumbnailArrayBufferToFile=f,l.getBridgeMediaAnnotatedForDisplay=h,l.createHdTypesForBridgeMedia=y,l.annotateBridgeMediaForDisplay=C,l.getMediaTypeFromMsgType=b,l.isTransportLegacyGif=v}),98);
__d("mergeMaps",[],(function(t,n,r,o,a,i){"use strict";function e(){for(var e=new Map,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var o=0;o<n.length;o++)for(var a=n[o].keys(),i=void 0;!(i=a.next()).done;)e.set(i.value,n[o].get(i.value));return e}i.default=e}),66);
__d("MpsPreprocessor",["Promise","getSafeQplErrorMessage","mergeMaps"],(function(t,n,r,o,a,i,l){"use strict";var e=["errors"],s;function u(t,a){return function(r){var o=r.payloadList.map(function(e){return e.message.messageId});r.ctx.messageToQpl.all(o).addPoint(a+"_start");var l=r.errors,u=babelHelpers.objectWithoutPropertiesLoose(r,e),c=t(u);return c instanceof(s||(s=n("Promise")))?c.then(function(e){return i(e,l!=null?l:new Map)}):i(c,l!=null?l:new Map)};function i(e,t){var n=e.payloadList.map(function(e){return e.message.messageId});return e.ctx.messageToQpl.all(n).addPoint(a+"_end"),e.errors.entries().forEach(function(t){var n=t[0],r=t[1];e.ctx.messageToQpl.endFail(n,a.toLowerCase()+"-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),babelHelpers.extends({},e,{errors:r("mergeMaps")(t,e.errors)})}}l.preprocessor=u}),98);
__d("MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor",["MAWDbMsgTypeVersionTxns","MAWProtobufDeserializers","MpsPreprocessor","WAGlobals","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){e=t}var u=o("MpsPreprocessor").preprocessor((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.ctx,r=t.payloadList,a=new Map,i=[];for(var l of r){var s,u,c=l.directive,d=l.insertionSource,m=l.message,p=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(m.payload),_=(s=p.payload().proto)==null||(s=s.event)==null?void 0:s.deviceChange;if(_==null){i.push({directive:c,insertionSource:d,message:m});continue}if(((u=p.proto.metadata)==null?void 0:u.senderId)===o("WAGlobals").getMyUserJid()){n.messageToQpl.addPoint(m.messageId,"drop_security_alert_my_device"),n.messageToQpl.endSuccess(m.messageId);continue}e===null&&(e=yield o("MAWDbMsgTypeVersionTxns").getSecuritySettingForContactTxn()),e===!0?i.push({directive:c,insertionSource:d,message:m}):(n.messageToQpl.addPoint(m.messageId,"drop_security_alert_disabled"),n.messageToQpl.endSuccess(m.messageId))}return{ctx:n,errors:a,payloadList:i}});return function(e){return t.apply(this,arguments)}})(),"maybe_drop_security_alerts");l.setCachedShouldSaveSecurityAlert=s,l.MawMpsDropDeviceNotificationsForTurnedOffSecurityAlertsPreprocessor=u}),98);
__d("MAWEBCombinedSwitch",["MAWEBEnabledStateManager","MAWEBLSInWorkerSwitch","MAWEBSwitch","MAWODSProxy","WAOdsEnums"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(e){function t(t,n){var r;return r=e.call(this)||this,r.$MAWCombinedStateManager$p_1=t,r.$MAWCombinedStateManager$p_2=n,r.$MAWCombinedStateManager$p_3=null,r.$MAWCombinedStateManager$p_4=!1,r.$MAWCombinedStateManager$p_1.onSet(function(){r.$MAWCombinedStateManager$p_5()}),r.$MAWCombinedStateManager$p_2.onSet(function(){r.$MAWCombinedStateManager$p_5()}),r.$MAWCombinedStateManager$p_5(),r}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.isEnabled=function(){var t=e.prototype.isEnabled.call(this);return this.$MAWCombinedStateManager$p_6(),t},n.$MAWCombinedStateManager$p_6=function(){var e=this.$MAWCombinedStateManager$p_1.isEnabled(),t=this.$MAWCombinedStateManager$p_2.isEnabled(),n=e!==t,r=e?"enabled":"disabled",a=t?"enabled":"disabled",i=n?"mismatch":"match";if(n&&!this.$MAWCombinedStateManager$p_4)this.$MAWCombinedStateManager$p_3=Date.now(),this.$MAWCombinedStateManager$p_4=!0;else if(this.$MAWCombinedStateManager$p_4&&this.$MAWCombinedStateManager$p_3!=null){var l=this.$MAWCombinedStateManager$p_3,s=Date.now()-l;this.$MAWCombinedStateManager$p_4=n,this.$MAWCombinedStateManager$p_3=n?Date.now():null;var u=this.$MAWCombinedStateManager$p_7(s);o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"eb_switch.sync.duration_bucket."+u});var c=n?"failed":"success";o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"eb_switch.sync.result."+c})}o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_SWITCH_STATE,key:"eb_switch."+i+"."+r+"."+a})},n.$MAWCombinedStateManager$p_7=function(t){return t<100?"under_100ms":t<500?"100_to_500ms":t<1e3?"500ms_to_1s":t<5e3?"1s_to_5s":t<1e4?"5s_to_10s":"over_10s"},n.$MAWCombinedStateManager$p_5=function(){this.set(this.$MAWCombinedStateManager$p_1.isEnabled()&&this.$MAWCombinedStateManager$p_2.isEnabled()),this.$MAWCombinedStateManager$p_6()},t})(o("MAWEBEnabledStateManager").MAWEBEnabledStateManager),s=new e(r("MAWEBSwitch"),r("MAWEBLSInWorkerSwitch"));l.MAWCombinedStateManager=e,l.MAWEBCombinedSwitch=s}),98);
__d("LFUCache",["Cache","ExecutionEnvironment"],(function(t,n,r,o,a,i,l){"use strict";var e,s=15,u=1,c=6e4,d=(function(t){function n(n,o){var a;return a=t.call(this)||this,a.$LFUCache2=n&&n>0?n:s,a.$LFUCache3=o&&o>0?o:u,((e||(e=r("ExecutionEnvironment"))).canUseDOM||(e||(e=r("ExecutionEnvironment"))).isInWorker)&&a.$LFUCache4(),a}babelHelpers.inheritsLoose(n,t);var o=n.prototype;return o.$LFUCache4=function(){clearTimeout(this.$LFUCache1),this.$LFUCache1=setTimeout(this.purge.bind(this),this.$LFUCache2*c)},o.destroy=function(){clearTimeout(this.$LFUCache1)},o.get=function(n,r){return this.has(n)&&this.$LFUCache5(n),t.prototype.get.call(this,n,r)},o.set=function(n,r,o,a){var e=this.has(n),i=t.prototype.set.call(this,n,r,o,a);return i&&(e?this.$LFUCache5(n):this.$LFUCache6(n,this.$LFUCache3)),i},o.purge=function(){var e=this,t=Array.from(this.__keys());t.forEach(function(t){e.$LFUCache7(t)<e.$LFUCache3?e.delete(t):e.$LFUCache6(t,0)}),this.$LFUCache4()},o.$LFUCache5=function(t){var e=this.$LFUCache7(t)+1;return this.$LFUCache6(t,e),e},o.$LFUCache7=function(t){var e=this.__getRaw(t);return e&&e.$LFUCache8?e.$LFUCache8:0},o.$LFUCache6=function(t,n){var e=this.__getRaw(t);return e||(e=this.__getNewRawObject()),e.$LFUCache8=n,this.__setRaw(t,e),!0},n})(r("Cache"));l.default=d}),98);
__d("memoizeWithArgsLFUCache",["LFUCache"],(function(t,n,r,o,a,i,l){function e(e,t,n,o){var a;function i(){return a||(a=new(r("LFUCache"))(n)),a}function l(e){if(e===void 0)a=null;else{var t;(t=a)==null||t.delete(e)}}o&&o(l);var s=function(){var n=i(),r=t.apply(void 0,arguments);n.has(r)||n.set(r,e.apply(void 0,arguments));var o=n.get(r);return o};return s}l.default=e}),98);
__d("MAWMpsXMAValidationPreprocessor",["ACTSanitizerApiLazyLoader","ACTSanitizerApiTypes","FBLogger","MAWParseXMAFBConfig","MAWParseXMAProtocol","MAWProtobufDeserializers","MpsPreprocessor","Promise","WAResultOrError","asyncToGeneratorRuntime","err","getErrorSafe","getMediaTypeFromConsumerMessage"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){if(e.payload!=null){var t=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(e.payload),n=t.subProtocol();if((n==null?void 0:n.kind)==="consumerApplication")return n.proto}}function u(){var e=null;return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{if(e==null){var n=yield o("ACTSanitizerApiLazyLoader").loadACTSanitizerApi();e=n.isXMAValid}var a=e,i=a(t);if(i!==o("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - extendedContentMessage does not have valid XMA content");var l=t.associatedMessage,u=t.sentWithMessageId,c=t.targetType,d=t.xmaDataclass;if(c==null||!o("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:c,xmaDataclass:d}))return r("FBLogger")("mps").warn("XMA Validation - found futureproof message"),o("WAResultOrError").makeResult();if(l!=null&&u==null)throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associatedMessage cannot be received without sentWithMessageId field");if(l!=null){var m=s(l);if(o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(m)!=null&&!o("MAWParseXMAProtocol").SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES.has(c))throw r("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associated msg has unsupported media type")}return o("WAResultOrError").makeResult()}catch(e){var p=r("getErrorSafe")(e);return r("FBLogger")("mps").catching(r("getErrorSafe")(p)).mustfix("XMA Validation failed for message"),o("WAResultOrError").DEPRECATED_makeError("runtime-error",p)}});return function(e){return t.apply(this,arguments)}})()}var c=o("MpsPreprocessor").preprocessor((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.ctx,i=t.payloadList,l=new Map,s=new Array(i.length),c=u(),d=i.map(function(e,t){var n,a=(n=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e.message.payload).encryptedTransportMessage())==null||(n=n.armadillo())==null||(n=n.payload)==null||(n=n.content)==null?void 0:n.extendedContentMessage;if(a==null){s[t]=e;return}return c(a).then(function(n){if(n.success)s[t]=e;else{var o;l.set(e.message.messageId,(o=n.payload)!=null?o:r("err")("XMA validation failed for message - runtime error"))}})}).filter(Boolean);return d.length>0&&(yield(e||(e=n("Promise"))).all(d)),{ctx:a,errors:l,payloadList:s.filter(Boolean)}});return function(e){return t.apply(this,arguments)}})(),"xma_validator");l.xmaValidator=u,l.MAWMpsXMAValidationPreprocessor=c}),98);
__d("XFBLSRestoreOperationType.facebook",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum").Mirrored(["DELTA_GENERIC_MESSAGE_SYNC","INITIAL_RESTORE","MESSAGE_QUERY_RESTORE","POINT_QUERY_RESTORE","RANGE_QUERY_RESTORE","SNAPSHOT_RESTORE","SURROUNDING_RESTORE","THREAD_POINT_QUERY_RESTORE","UNKNOWN"]),l=e;i.default=l}),66);
__d("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},t={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},n={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},r={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},o={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},a={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},C=[t,n];return{argumentDefinitions:[{defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"}],kind:"Fragment",metadata:null,name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages",selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},e,t,n,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[r,e,t,n,o,a],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[r,e,t,n,o,a,i,l],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},o],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[s,u,c,d,m,p,_,f,g,h,y],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[s,u,m,c,d,i,l,p,_,f,g,h,y],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null},{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[d,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},t,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],type:"XFBEncryptedBackupMessages",abstractKey:null}})();a.exports=e}),null);
__d("handleRestoreMessagesGraphQLResponse",["EBMinosInterfaceTypes","I64","MEBEncryptionVersion","QPLUserFlow","WALogger","handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(e){if(e==null)return r("MEBEncryptionVersion").UNKNOWN;switch(e){case"ENCRYPTION_KDF_WITH_NULL_SALT":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT;case"ENCRYPTION_KDF_WITH_VERSION":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION;case"ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY;case"TEST_VERSION":return r("MEBEncryptionVersion").TEST_VERSION;default:return r("MEBEncryptionVersion").UNKNOWN}}function p(e,t,n,a){var i,l=((i=e==null?void 0:e.map(function(e){var n,r,a,i,l,c,p,f,g;if(e==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message is null in the GraphQL range restore response"]))),null;var h=e.otid;if(h==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] otid is null for a message in the GraphQL range restore response"]))),null;var y=(n=e.echo_document)==null?void 0:n.echo_document_string,C=(r=e.echo_document)==null?void 0:r.epoch_anon_id,b=(a=e.echo_document)==null?void 0:a.epoch_fingerprint,v=e.protobuf_stanzas,S=v==null||(i=v.top_level_protobuf)==null?void 0:i.encrypted_protobuf_stanza,R=v==null||(l=v.top_level_protobuf)==null?void 0:l.epoch_anon_id,L=v==null||(c=v.top_level_protobuf)==null?void 0:c.epoch_id,E=v==null||(p=v.top_level_protobuf)==null?void 0:p.protobuf_timestamp_ms,k=v==null?void 0:v.supplemental_protobufs,I=v==null?void 0:v.message_tags,T=(f=e.protobuf_stanzas)==null?void 0:f.top_level_protobuf_v2,D=(g=e.protobuf_stanzas)==null?void 0:g.top_level_protobuf_unencrypted;if(D!=null&&D.unencrypted_protobuf!=null&&D.protobuf_timestamp_ms!=null){var x=D.unencrypted_protobuf,$=D.protobuf_timestamp_ms;return{message:{isUnencrypted:!0,messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:x,encryption_version:void 0,epoch_anon_id:new ArrayBuffer(0),epoch_id:void 0,otid:h,protobufTimestampMs:$,value:void 0}},type:"protobuf"}}if(S==null||R==null||L==null||E==null){var P,N;if(y==null||C==null||y.length===0)return T==null&&_(S,R,L,E),null;var M=m((P=e.echo_document)==null?void 0:P.encryption_version);return{message:{backup_id:t,encryption_version:M,epoch_anon_id:new TextEncoder().encode(C).buffer,epoch_fingerprint:b!=null?new TextEncoder().encode(b).buffer:void 0,epoch_id:((N=e.echo_document)==null?void 0:N.epoch_id)!=null?(d||(d=o("I64"))).of_string(e.echo_document.epoch_id):void 0,otid:h,value:y},type:"echo"}}if(v!=null){var w,A=m(v==null||(w=v.top_level_protobuf)==null?void 0:w.encryption_version),F={messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:S,encryption_version:A,epoch_anon_id:new TextEncoder().encode(R).buffer,epoch_id:(d||(d=o("I64"))).of_string(L),otid:h,protobufTimestampMs:E,value:void 0}};return k==null||k.forEach(function(e){var n=e==null?void 0:e.supplemental_key,r=e==null?void 0:e.encrypted_protobuf_stanza,a=e.epoch_anon_id,i=e==null?void 0:e.epoch_id,l=e==null?void 0:e.protobuf_timestamp_ms;if(!(r==null||a==null||i==null||l==null||n==null)){var s=m(e==null?void 0:e.encryption_version);F.supplementalProtobufs.push({backup_id:t,encryptedProtobufContent:r,encryption_version:s,epoch_anon_id:new TextEncoder().encode(a).buffer,epoch_id:(d||(d=o("I64"))).of_string(i),protobufTimestampMs:l,skCipherText:e==null?void 0:e.sk_ciphertext,supplementalKey:n,value:void 0})}}),{message:F,type:"protobuf"}}return null}))!=null?i:[]).filter(Boolean),c=l.filter(function(e){return e.type==="echo"}).map(function(e){return e.message}),p=l.filter(function(e){return e.type==="protobuf"}).map(function(e){return e.message});return a!=null&&n!=null&&r("QPLUserFlow").addPoint(n,"processing_encrypted_messages_complete",{instanceKey:a}),{encryptedNonLSEchoMessages:c,encryptedNonLSProtobufs:p}}function _(e,t,n,r){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message with no echo document and no protobuf data, more details: encrypted_protobuf_content: ",", protobuf_epoch_anon_id: ",", protobuf_epoch_id: ",", protobuf_timestamp_ms: ",""])),e==null?"null/empty":"not empty",t==null?"null/empty":"not empty",n==null?"null/empty":"not empty",r==null?"null/empty":"not empty")}e!==void 0||(e=n("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql")),l.processMessageArray=p}),98);
__d("EBMessagePointQuery",["Base64Utils","EBAPIConvertNativeToLS","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedTypes","EBAPIWorkerCheck","EBDedupeEncryptedLabyrinthMessages","EBDedupeLabyrinthMessages","EBDeriveAndStoreEpochs","EBGetClientState","EBLS","EBMessagePointQuery.graphql","EBMinosCheckWasmFeatureSupport","EBMinosDecryptAndValidateMessages","EBMinosInterfaceTypes","EBgenerateMPSMessageQuery","FBLogger","I64","LSVec","MAWCurrentUser","MAWEncryptedBackupUtils","MAWHandleEBRestoreWithHIM","MAWJobDefinitions","MAWMpsXMAValidationPreprocessor","MpsTypes","Promise","QPLFlow","WAJids","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=e!==void 0?e:e=n("EBMessagePointQuery.graphql");function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.chatJid,a=e.messageIds,i=e.source,l=yield o("EBMinosCheckWasmFeatureSupport").checkWasmFeatureSupportAndGK(),d=o("QPLFlow").startQPLFlow(r("qpl")._(521474469,"2612"),{annotations:{bool:{is_wasm_serializer_on:r("gkx")("18428"),minos_rollout_enabled:l,occam_only_mailbox_users:r("gkx")("16674")},string:{source:i!=null?i:"unknown"}}});try{var m,_,f,g,h;if(!o("EBAPIWorkerCheck").runningInWorker())return d.endFail(o("EBAPIQPLPoints").EBAPIQPLCommonErrorPoints.UNSUPPORTED_CONTEXT),o("WAResultOrError").makeError("unsupported-context");var y=(yield o("EBLS").init()).db;d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.LSDB_SINGLETON_RETRIEVED);var C=yield o("EBGetClientState").getClientState(y);if(d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CLIENT_STATE_RETRIEVED,{string:{device_id:(m=C==null?void 0:C.deviceId)!=null?m:(u||(u=o("I64"))).to_string((u||(u=o("I64"))).zero)}}),C==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}}),o("WAResultOrError").makeError("no-client-state");var b=o("WAJids").threadIdForChatJid(t),v=C.backupId,S=C.deviceId,R=C.locally_available_epochs,L=C.mailboxRootKey,E=C.ocmfClientStateBlob;if(v==null||S==null||L==null||E==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}}),o("WAResultOrError").makeError("invalid-client-state");var k=""+((_=o("MAWCurrentUser").getAppID())!=null?_:0),I={restore_context:{act_thread_id:b,site:"www",tam_thread_subtype:0},success:{device_context:{device_id:S,locally_available_epochs:R,raw_tokens:{mailbox_root_key:o("Base64Utils").fromArrayBuffer(L),ocmf_client_state_blob:o("Base64Utils").fromArrayBuffer(E)}},mps_message_query:o("EBgenerateMPSMessageQuery").generateMPSMessageQueryForGraphQLQuery(b,[].concat(a))}},T={app_id:k,minos_gk_enabled:l,restore_payload_string:JSON.stringify(I),restore_type:"MESSAGE_QUERY_RESTORE"};d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_START),yield o("WorkerRelayNetwork").createWorkerNetworkExecute(),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_END),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);var D=yield o("WorkerRelay").createWorkerQuery(c,T);d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END);var x=D==null||(f=D.viewer)==null||(f=f.encrypted_backup)==null||(f=f.mailbox)==null?void 0:f.messages_point_restore;if(x==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var $=x;if(($==null?void 0:$.encrypted_messages)==null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var P=$.backup_id,N=$.encrypted_messages,M=$.epoch_derivation_set,w=$.exception_string,A=$.minos_decryption_keys,F=p(N,d);if(d.addAnnotations({int:{encrypted_messages_with_content_count:F}}),w!=null)return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:w}}),o("WAResultOrError").makeError("server-side-exception");P==null&&d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);var O=M;d.addAnnotations({bool:{hasEpochs:O!=null&&O.epoch_edges.length>0}}),yield o("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(y,O),d.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END),d.addPoint("decryption_start");var B=N,W=l?o("EBMinosInterfaceTypes").processMinosMessages(B):[],q=l?yield o("EBMinosDecryptAndValidateMessages").minosDecryptAndValidateMessages({encryptedMinosMessages:W,entryPoint:"point_query",minosDecryptionKeys:A,qplFlow:d,source:i!=null?i:"unknown",threadId:o("MpsTypes").toThreadId(t),validator:r("gkx")("5782")?o("MAWMpsXMAValidationPreprocessor").xmaValidator():function(){return(s||(s=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}):o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]}),U=q.success===!0&&q.value.decryptionResult.size>0?q.value.decryptionResult:null,V=q.success===!0?q.value.errorMessages:[(g=q.error)!=null?g:"unknown-error"];d.addAnnotations({bool:{minos_decrypt_success:V.length===0},int:{minos_decrypted_messages_count:(h=U==null?void 0:U.size)!=null?h:0},string_array:{minos_decrypt_errors:V}});var H=U!=null&&l?o("EBDedupeEncryptedLabyrinthMessages").dedupeEncryptedLabyrinthMessages(B,U,d):B;d.addAnnotations({int:{deduped_encrypted_messages:p(H)}});var G=o("handleRestoreMessagesGraphQLResponse").processMessageArray(H,P!=null?o("EBMinosInterfaceTypes").unsafeCastToBackupFbid(P):v),z=G.encryptedNonLSEchoMessages,j=G.encryptedNonLSProtobufs;d.addPoint("native_decryption_start");var K=yield o("EBAPIDecryptionModule").decryptUsingNativeJS(y,b,j,z,i,"point_query");if(!K.success){var Q,X=K.error,Y=X.message,J=o("EBAPISharedTypes").EBAPIRestoreErrorValues.find(function(e){return e===Y});return d.endFail("decrypt_labyrinth10_messages_failure",{string:{error_description:X.message,errorStackTrace:(Q=X.stack)!=null?Q:""}}),J!=null?o("WAResultOrError").makeError(J):o("WAResultOrError").makeError("native-decryption-error")}d.addAnnotations({bool:{labyrinth_10_toplevel_decrypt_success:K.value.decryptedEchoMessages.length===z.length&&K.value.decryptedProtobufs.length===j.length}}),d.addPoint("native_decryption_end");var Z=K.value.decryptedEchoMessages,ee=K.value.decryptedProtobufs,te=l?o("EBDedupeLabyrinthMessages").dedupeLabyrinthMessages(ee,U):ee,ne=Z.length+te.length;d.addAnnotations({bool:{decrypted_count_equals_encrypted_count:F===ne},int:{decrypted_echo_count:Z.length,decrypted_messages_count:te.length+Z.length,decrypted_protobuf_count:te.length}}),d.addPoint("convert_native_to_decrypted_type_start");var re=o("EBAPIConvertNativeToLS").convertNativeDecryptionResponseToDecryptedMessageType(Z,te);d.addPoint("convert_native_to_decrypted_type_end");var oe=r("LSVec").toArray(re.echo),ae=re.protobuf,ie=oe.map(function(e){return o("MAWJobDefinitions").toEncodedEchoMessage(e)}),le=o("MAWHandleEBRestoreWithHIM").convertEchoMessagesToEBProtobufs(ie,t).concat(o("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(ae)),se=new Map(le.map(function(e){return[e.otid,e]})),ue=Array.from(se.values()),ce=a.reduce(function(e,t){return e+(se.get(t)==null?1:0)},0);return d.addAnnotations({int:{decrypted_message_result_count:ue.length,missing_message_count:ce}}),d.addPoint("decryption_end"),d.endSuccess(),o("WAResultOrError").makeResult(ue)}catch(e){var de,me=r("getErrorSafe")(e);return d.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:me.message,errorStackTrace:(de=me.stack)!=null?de:""}}),r("FBLogger")("wmi_eb").catching(me).mustfix("Runtime error performing messagePointQuery: %s",me.message),o("WAResultOrError").makeError("runtime-error")}}),m.apply(this,arguments)}function p(e,t){var n=0,r=!1,o=!1,a=!1,i=!1;for(var l of e){var s,u=l.protobuf_stanzas,c=(u==null?void 0:u.top_level_protobuf)!=null,d=(u==null?void 0:u.top_level_protobuf_unencrypted)!=null,m=(u==null?void 0:u.top_level_protobuf_v2)!=null,p=((s=l.echo_document)==null?void 0:s.echo_document_string)!=null;r=r||c,o=o||m,a=a||p,i=i||d,(c||d||m||p)&&(n+=1)}return t!=null&&t.addAnnotations({bool:{has_echo_document:a,has_lab1_messages:r,has_lab11_messages:o,has_unencrypted_protobuf:i}}),n}l.messagePointQuery=d}),98);
__d("EBProbe",["FBLogger","MAWODSProxy","Promise","WAOdsEnums","WAShiftTimer","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e,t,n){this.$5=!1,this.$1=e,this.$2=t,this.$3=n}var a=t.prototype;return a.sample=function(t){var e=this.$1.sample(t);return e&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"sampled"}),e},a.start=function(){var e=this;this.$4==null&&(this.$4=new(o("WAShiftTimer")).ShiftTimer(function(){e.$6()}),this.$4.onOrBefore(this.$3.validationIntervalMs,void 0))},a.stop=function(){this.$4!=null&&(this.$4.cancel(),this.$4=null)},a.hasStarted=function(){return this.$4!=null},a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield this.$7(),this.$4!=null&&this.$4.onOrBefore(this.$3.validationIntervalMs,void 0)});function t(){return e.apply(this,arguments)}return t})(),a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!this.$5){this.$5=!0;try{var t=o("WATimeUtils").castToMillisTime(Date.now()-this.$3.sampleAgeThresholdMs),n=this.$2.fetchOlderThan({consume:!0,cutOffTimestamp:t});if(n.length>0)try{o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"validated"}),yield this.validateSamples(n)}catch(t){var a=t instanceof Error?t:r("err")(String(t));r("FBLogger")("wmi_eb").catching(a).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Exception in validateSamples()"])))}}finally{this.$5=!1}}});function a(){return t.apply(this,arguments)}return a})(),a.addMarkerToItem=function(t,n,r){return!1},a.updateSample=function(t,n){var e=this.getSamplingDB();if(e==null)return!1;var r=e.getItemByPrimaryKey(t);return r==null?!1:(n(r),!0)},a.getConfig=function(){return this.$3},a.getSamplingDB=function(){return this.$2},a.validateSamples=function(t){return(s||(s=n("Promise"))).reject(r("err")("validateSamples() must be implemented by concrete probe classes"))},t})();l.EBProbe=u}),98);
__d("EBSampler",["Random"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n,r){this.$1=e,this.$2=t,this.$3=n,this.$4=r}var t=e.prototype;return t.sample=function(t){var e,n=this.$3(t),r=((e=this.$2.get(n))!=null?e:0)*this.$1,a=o("Random").random(),i=a<r;return i&&this.$4.append(t),i},t.setSamplingMultipler=function(t,n){this.$2.set(t,n)},t.setSamplingRate=function(t){this.$1=t},e})();l.EBSampler=e}),98);
__d("EBMinosDisableLabyrinth10Uploads",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("16675")}l.disableLabyrinth10Uploads=e}),98);
__d("MWEBODSUtils",["CurrentMessengerUser","MWEBODSCategory","ODS"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,a){var i=o("CurrentMessengerUser").getAppID(),l=i!=null?i.toString():"unknown",s=t+"."+l;(e||(e=o("ODS"))).bumpEntityKey(r("MWEBODSCategory"),s,n,a!=null?a:1),e.bumpEntityKey(r("MWEBODSCategory"),t,n,a!=null?a:1)}l.markODSForEB=s}),98);
__d("EncryptedBackupsUploadQueue",["EBMinosDisableLabyrinth10Uploads","EncryptedBackupsUploadEntity","MWEBODSEntityName.enum","MWEBODSUtils","PersistedQueueApi","Promise","QPLUserFlow","WAPersistedQueue","WATagsLogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["EbUploadQueue"]),d=null;function m(){return d==null?p():d}function p(){d!=null&&c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebUploadQueue",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){if(e.length===0||o("EBMinosDisableLabyrinth10Uploads").disableLabyrinth10Uploads())return(u||(u=n("Promise"))).resolve();o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.put",e.length);var t=m();return t.addAndCommit(e.map(o("EncryptedBackupsUploadEntity").asEBUploadEntity)).then(function(){e.forEach(function(e){(e==null?void 0:e.instanceKey)!=null&&r("QPLUserFlow").endSuccess(r("qpl")._(521477113,"2698"),{instanceKey:e.instanceKey})})}).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)})}l.logger=c,l.ebUploadQueue=m,l.initEbUploadQueue=p,l.putMsgsToEbUpload=_}),98);
__d("InMemorySamplingDB",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.$1=[],this.$4=new Map,this.$2=e,this.$3=t}var t=e.prototype;return t.append=function(t){var e=this.$3(t);this.$1.push([this.$2(t),t]),this.$4.set(e,t)},t.fetchOlderThan=function(t){var e=t.consume,n=e===void 0?!1:e,r=t.cutOffTimestamp,o=t.limit,a=o===void 0?50:o,i=[];if(a<=0)return i;var l=0,s=[];for(var u of this.$1){var c=u[0],d=u[1];if(c<=r&&(i.push(d),n===!0&&(l++,s.push(d))),i.length>=a)break}if(n===!0&&l>0){this.$1.splice(0,l);for(var m of s){var p=this.$3(m);this.$4.delete(p)}}return i},t.getItemByPrimaryKey=function(t){var e;return(e=this.$4.get(t))!=null?e:null},t.size=function(){return this.$1.length},t.pruneOlderThan=function(t){var e=[];this.$1=this.$1.filter(function(n){var r=n[0],o=n[1];return r<=t?(e.push(o),!1):!0});for(var n of e){var r=this.$3(n);this.$4.delete(r)}},t.purgeAll=function(){this.$1=[],this.$4.clear()},e})();i.InMemorySamplingDB=e}),66);
__d("EBMessageProbe",["EBDeps","EBGetClientState","EBMessagePointQuery","EBProbe","EBSampler","EncryptedBackupsUploadQueue","EncryptedBackupsUploadQueueProcessor","EncryptedBackupsUploadQueueV3Scheduler","FBLogger","I64","InMemorySamplingDB","MAWEBLSInWorkerSwitch","MAWODSProxy","MpsTypes","Promise","QPLFlow","WAOdsEnums","WAResultOrError","WATimeUtils","WebMps","asyncToGeneratorRuntime","getErrorSafe","gkx","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t){var n={};for(var r of e){var o=t(r);n[o]==null&&(n[o]=[]),n[o].push(r)}return n}var m={qplEvent:r("qpl")._(521475573,"3232"),sampleAgeThresholdMs:(c=r("justknobx"))._("3485"),validationIntervalMs:c._("3949")},p=c._("3573")/1e4,_=new Map([["text",c._("3952")],["image",c._("3957")],["video",c._("3969")],["audio",c._("3970")],["document",c._("3973")],["sticker",c._("3977")],["gif",c._("3981")],["xma",c._("1505")]]),f=function(t){return t.timestampMs},g=function(t){return t.messageType},h=function(){return new(o("InMemorySamplingDB")).InMemorySamplingDB(f,function(e){return e.messageId})},y=function(t){return new(o("EBSampler")).EBSampler(p,_,g,t)},C=(function(t){function a(e,n,r){return r===void 0&&(r=m),t.call(this,e,n,r)||this}babelHelpers.inheritsLoose(a,t),a.getInstance=function(){if(!a.$EBMessageProbe$p_1){var e=h(),t=y(e);a.$EBMessageProbe$p_1=new a(t,e,m)}return a.$EBMessageProbe$p_1},a.reset=function(){a.$EBMessageProbe$p_1=null};var i=a.prototype;return i.addMarkerToItem=function(t,n,r){return this.addMarker(t,n,r)},i.addMarker=function(t,n,r){var e=this.getSamplingDB();if(e==null)return!1;var a=e.getItemByPrimaryKey(t);if(a==null)return!1;var i={event:n,metadata:r,timestampMs:o("WATimeUtils").castToMillisTime(Date.now())};return a.markers.push(i),!0},i.getMarkersForMessage=function(t){var e=this.getSamplingDB();if(e==null)return null;var n=e.getItemByPrimaryKey(t);return n==null?null:[].concat(n.markers)},i.getMessageSample=function(t){var e=this.getSamplingDB();return e==null?null:e.getItemByPrimaryKey(t)},i.$EBMessageProbe$p_2=function(t){return t.length===0?"":t.map(function(e){return e.event}).join(",")},i.$EBMessageProbe$p_3=function(t){var e={bool:{},int:{},string:{}};for(var n of t){var r=n.metadata;if(r!=null)for(var o of Object.entries(r)){var a=o[0],i=o[1];typeof i=="string"?e.string!=null&&(e.string[a]=i):typeof i=="number"?e.int!=null&&(e.int[a]=i):typeof i=="boolean"&&e.bool!=null&&(e.bool[a]=i)}}return e},i.$EBMessageProbe$p_4=function(t){if(t===0)return"0";if(t>=1e3)return"1000+";var e=Math.floor(t/50)*50,n=e+50;return e+"-"+n},i.$EBMessageProbe$p_5=function(t){if(t<0)return"never";var e=t/(1e3*60);return e<1?"<1min":e>=1&&e<5?"1-5min":e>=5&&e<10?"5-10min":e>=10&&e<20?"10-20min":e>=20&&e<60?"20-60min":">60min"},i.validateSamples=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(t.length!==0){var a=o("EncryptedBackupsUploadQueue").ebUploadQueue(),i=-1,l="unknown";try{i=yield a.count(),l=this.$EBMessageProbe$p_4(i),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"upload_queue_count_bucket_"+l})}catch(e){r("FBLogger")("wmi").catching(r("getErrorSafe")(e)).warn("Failed to get upload queue count for probe annotation")}var c=r("gkx")("10326"),m=c?o("EncryptedBackupsUploadQueueV3Scheduler").isUploadTaskScheduled():o("EncryptedBackupsUploadQueueProcessor").isEbUploadTaskScheduled(),p=c?o("EncryptedBackupsUploadQueueV3Scheduler").getLastSuccessfulAckTimestampMs():o("EncryptedBackupsUploadQueueProcessor").getLastSuccessfulAckTimestampMs(),_=p!=null?Date.now()-p:-1,f=this.$EBMessageProbe$p_5(_),g=new Set,h=[];for(var y of t){var C,b,v=y.chatJid+"_"+y.messageId;if(!g.has(v)){g.add(v);var S=Date.now()-y.timestampMs,R=S/(1e3*60),L=function(t){return t<5?"<5min":t>=5&&t<10?"5-10min":">10min"},E=void 0,k=void 0;if(y.queueId!=null){var I,T=yield a.get(y.queueId);if(E=T!=null,(T==null||(I=T.msgId)==null?void 0:I.externalId)!=null){var D;k=o("MpsTypes").toMessageId(T==null||(D=T.msgId)==null?void 0:D.externalId)===y.messageId}}var x=o("QPLFlow").startQPLFlow(this.getConfig().qplEvent,{annotations:babelHelpers.extends({},this.$EBMessageProbe$p_3(y.markers),{bool:{eb_state:r("MAWEBLSInWorkerSwitch").isEnabled(),ebUploadTaskScheduled:m,isProtobufOnlyUpload:r("gkx")("10326"),queueItemExists:E,queueItemMessageIdMatches:k},int:{markerCount:y.markers.length,queueCount:i,queueId:(C=y.queueId)!=null?C:-1,sampleSize:t.length,sampleTimestampMs:y.timestampMs,validationIntervalMs:S,validationTimestampMs:Date.now()},string:{bucketizedQueueCount:l,bucketizedTimeSinceLastAck:f,chatJid:y.chatJid,insertionSource:(b=y.insertionSource)!=null?b:"unknown",markerEvents:this.$EBMessageProbe$p_2(y.markers),messageId:y.messageId,messageType:y.messageType,validationIntervalBucket:L(R),version:"v1"}})});h.push({qplFlow:x,sample:y})}}try{var $=r("justknobx")._("4947"),P=d(h,function(e){return e.sample.chatJid}),N=Object.entries(P).map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e[0],n=e[1],r=n.map(function(e){return e.sample.messageId}),a=n[0].sample.chatJid,i={chatJid:a,messageIds:r,source:"message_probe"};n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_start")});var l=yield o("EBMessagePointQuery").messagePointQuery(i),s=$?yield o("WebMps").mps().batchLoadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"eb-message-probe"},messageIds:r,threadId:o("MpsTypes").toThreadId(a)}):o("WAResultOrError").makeResult([]);return n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_end")}),{chatJid:a,mpsLocalResult:s,result:l,samplesWithQplFlow:n}});return function(t){return e.apply(this,arguments)}})()),M=yield o("EBDeps").getDeps().getLSDB(),w=yield o("EBGetClientState").getClientState(M),A=w==null?void 0:w.encryptionVersion,F=A!=null?(u||(u=o("I64"))).to_string(A):"unknown",O=yield(s||(s=n("Promise"))).all(N);for(var B of O){var W,q=B.mpsLocalResult,U=B.result,V=B.samplesWithQplFlow,H=new Set((W=q.value)==null?void 0:W.map(function(e){var t;return e==null||(t=e.toplevelProtobuf)==null?void 0:t.messageId}));if(U.success){var G=new Set(U.value.map(function(e){return e.otid}));for(var z of V){var j=z.qplFlow;G.has(z.sample.messageId)?j.endSuccess({bool:{messageFound:!0,mpsLocalMessageFound:$?H.has(z.sample.messageId):void 0}}):j.endFail("message_not_found",{bool:{messageFound:!1,mpsLocalMessageFound:$?H.has(z.sample.messageId):void 0},string:{encryption_version:F,error:"message-not-found"}})}}else for(var K of V){var Q=K.qplFlow;if(Q!=null){var X;Q.endFail("query_failed",{bool:{messageFound:!1,mpsLocalMessageFound:$?H.has(K.sample.messageId):void 0},string:{encryption_version:F,error:(X=U.error)!=null?X:"unknown-query-failure"}})}}}}catch(t){var Y=r("getErrorSafe")(t);r("FBLogger")("wmi").catching(Y).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to validate samples"])));for(var J of h){var Z;J.qplFlow.endFail("validation_exception",{bool:{messageFound:!1},string:{error:(Z=Y.message)!=null?Z:"unknown-validation-exception"}})}}}});function a(e){return t.apply(this,arguments)}return a})(),a})(o("EBProbe").EBProbe),b=C.getInstance,v=C.reset;l.EBMessageProbe=C,l.getEBMessageProbeInstance=b,l.resetEBMessageProbeInstance=v}),98);
__d("EBUploadMessagesFromWorkerMutationDeferred",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBUploadMessagesFromWorkerMutation").__setRef("EBUploadMessagesFromWorkerMutationDeferred");function s(t,n){return e.load().then(function(e){return e.uploadMessagesFromWorker(t,n)})}l.uploadMessagesFromWorker=s}),98);
__d("LSEBPayloadSerializerError",[],(function(t,n,r,o,a,i){var e=Object.freeze({INVALID_BACKUP_OPERATION:-7,INVALID_CONTENT_TYPE:-6,INVALID_PAYLOAD_FORMAT:-5,CQL_DB_ERROR:-4,REQUIRED_COLUMN_NOT_PRESENT_ON_CLIENT:-3,DEPRECATED_SPROC:-2,UNKNOWN_ERROR:-1,NOT_AN_ERROR:0,BACKUP_NOT_FOUND:1,REQUIRED_TABLE_NOT_FOUND:2,NATIVE_OP_NOT_FOUND:3,BACKUP_UPLOAD_KILLSWITCHED:4,TASK_ID_NOT_FOUND:5,NOT_IMPLEMENTED:6,NOT_SUPPORTED_ON_WEB:7,DUPLICATE_TASK:8,CLIENT_STATE_NOT_LOADED:9,RECOVERY_CODE_NOT_FOUND:10,EPOCH_KEYS_NOT_FOUND:11,DEVICE_PAYLOAD_NOT_CREATED:12,NULL_DEVICE_PAYLOAD:13,EPOCH_PAYLOAD_NOT_CREATED:14,NULL_EPOCH_PAYLOAD:15,VIRTUAL_DEVICE_PAYLOAD_NOT_CREATED:16,NULL_VIRTUAL_DEVICE_PAYLOAD:17,DEVICE_METADATA_NOT_FOUND:18,NO_MATCHING_DEVICE_PUBLIC_KEY:19,NULL_MAILBOX_ROOT_KEY:20,NULL_ENCRYPTION_VERSION:21,NULL_OCMF_KEY:22,NULL_EPOCH_KEYS:23,NULL_DEVICE_ID:24,OPE_KEY_DERIVATION_FAILED:25,MESSAGE_KEY_DERIVATION_FAILED:26,NULL_MAILBOX_ROOT_KEY_V2:27,ECHO_DOCUMENT_ENCODING_FAILED:30,ECHO_PAYLOAD_CREATION_DISABLED:31,ECHO_DOCUMENT_ENCODING_SKIPPED:32,MESSAGE_PAYLOAD_ENCRYPTION_FAILED:40,SERVER_THREAD_ID_NOT_FOUND_FOR_JID:52,UNKNOWN_PROTOBUF_TYPE:60,SUPPLEMENTARY_DATA_KEY_UNEXPECTED:61,PROTOBUF_ENCRYPTION_FAILED:62,PROTOBUF_NOT_FOUND_IN_TOPLEVEL_TABLE:63,PROTOBUF_NOT_FOUND_IN_SUPPLEMENTAL_TABLE:64,SUPPLEMENTAL_KEY_NOT_SET_IN_CONTEXT_TABLE:65,SUPPLEMENTAL_ENCRYPTION_FAILED:66,PROTOBUF_CONTEXT_ROW_NOT_FOUND:67,PROTOBUF_FORMATTING_FAILED:68,SUPPLEMENTAL_FORMATTING_FAILED:69,PROTOBUF_ALREADY_DELETED:70,PROTOBUF_NOT_FOUND_IN_DELETED_MESSAGES_TABLE:71,DELETION_PROTOBUF_IS_NULL:72,PROTOBUF_PAYLOAD_IN_CONTEXT_ROW_IS_NOT_FOUND:73,PROTOBUF_ENCRYPTION_FAILED_RETRYABLE:74,VALUE_SECRET_REF_INVALID:75,MINOS_ENCRYPTION_RESULT_NULL:76,SUPPLEMENTAL_OTID_NOT_SET_IN_CONTEXT_TABLE:77,SNAPSHOT_NOT_FOUND_FAILURE:78,THREAD_PK_NOT_FOUND_FOR_JID:100,MESSAGE_DECRYPTION_FAILED:101,EPOCH_KEY_FETCH_FAILED:102,TOO_MANY_OPEN_EPOCHS:103,MESSAGE_RANGE_PREPARE_FAILURE:104,ECHO_DOCUMENT_RESTORE_FAILED:105,MISMATCH_POINT_QUERY_MESSAGE_AND_RANGE_LENGTH:106,INITIAL_THREADS_FETCH_FOR_RESTORE_FAILED:107,MISSING_SUPPLEMENTAL_KEY_CIPHERTEXT:108,SUPPLEMENTAL_KEY_DECRYPTION_FAILURE:109,DEVICE_ID_MISMATCH:110,RESTORE_TO_TAM_INFO:111,MISSING_SERVER_THREAD_KEY:112,EB_ADD_DEVICE_FOUND_NO_LOCAL_THREADS:113,EB_MORE_THREADS_IN_MAPPING_TABLE:114,RESTORE_INTEGRITY_CHECK_FAILED:115,RESTORE_TOP_LEVEL_PROTOBUF_NULL:116,DECRYPT_MINOS_PROTOBUF_FAILURE:117,MESSAGE_PK_NOT_FOUND_IN_CLIENT_MESSAGES:200,OTID_NOT_FOUND_IN_ACT_MESSAGES:201,THREAD_ID_NOT_FOUND_IN_ACT_THREADS:202,THREAD_PK_NOT_FOUND_IN_CLIENT_THREADS:203,FAILED_TO_GET_THREAD_SORT_KEY:204,MEDIA_INFO_INVALID:205,REVERB_DB_NOT_ENABLED_FOR_INSTAMADILLO:206,SKIPPED_EB_DISABLED:300,SKIPPED_THREAD_NOT_ELIGIBLE:301,SKIPPED_MESSAGE_NOT_ELIGIBLE:302,NO_EPOCHS_FOUND:400,LATEST_EPOCH_QUERY_BY_ID_FAILED:401,FOUND_EPOCH_WITH_NULL_ROOT_KEY:402,FOUND_EPOCH_WITH_NULL_ANON_ID:403,NO_RECOVERY_CODE:501,NO_ERROR:601,ERROR_GENERAL:602,UNKNOWN:603,ONBOARDING_MATERIAL_DERIVATION_FAILURE:604,NULL_DEVICE_HMAC:605,MISSING_LATEST_EPOCH_AT_ONBOARDING:606,EPOCH_REPAIR_UNREACHABLE_EPOCH:607,NO_THREADS_TO_COMPARE:701,START_SORT_KEY_FAILURE:702,END_SORT_KEY_FAILURE:703,LOOPING_UPLOAD_PAYLOAD_NOT_FOUND:704,NULL_ECHO_IDENTIFIERS:705,ECHO_TIMESTAMP_CONVERSION_FAILED:706,ECHO_PROTOBUF_THREAD_ID_MISMATCH:707,ECHO_PROTOBUF_TIMESTAMP_MISMATCH:708,ECHO_PROTOBUF_OTID_MISMATCH:709,NULL_ECHO_DOCUMENT:710,INVALID_PROTOBUF_BACKUP_ACTION:711,EMPTY_ENCODED_ECHO_DOCUMENT:712,LOOPING_UPLOAD_TASK_QUEUE_FULL:713,ECHO_DOCUMENT_ENCODING_UNKNOWN_ENCODING_ERROR:750,ECHO_DOCUMENT_ENCODING_MESSAGE_PK_NOT_FOUND_ERROR:751,ECHO_DOCUMENT_ENCODING_DISK_WRITE_CHECK_FAILED:752,ECHO_DOCUMENT_ENCODING_THREAD_TRANSPORT_ID_FETCH_FAILED:753,ECHO_DOCUMENT_ENCODING_FILE_WRITE_FAILED:754,ECHO_DOCUMENT_ENCODING_DISK_WRITE_DISABLED:755,ECHO_DOCUMENT_ENCODING_SHOULD_NOT_PERSIST:756,MISSING_SUPPLEMENTAL_DATA:757,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REPLY_PROXY_ERROR:758,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_QUERY_ERROR:759,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_ERROR:760,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_RECEIPTS_ERROR:761,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REACTIONS_ERROR:762,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_VISUAL_MESSAGE_ACTIONS_ERROR:763,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_POLLS_ERROR:764,READ_CLIENT_STATE_FROM_MAIN_DB_ERROR:801,NOT_SUPPORTED_ON_MAIN_DB:802,SKIP_MPS_WRITE_DUE_TO_HIGHER_TIMESTAMP_AVAILABILITY:851,MESSAGE_ALREADY_DELETED:852});i.default=e}),66);
__d("WAGetHashFromProtocolMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e.externalId+"_"+e.author+"_"+e.chat}i.getHashFromProtocolMsgId=e}),66);
__d("MAWEBUploadTrackingUtils",["MAWAckLevel","MAWEBSwitch","MAWExternalId","MAWMsgType","MWEBODSEntityKey.enum","MWEBODSEntityName.enum","MWEBODSUtils","ODS","QPLUserFlow","QuickPerformanceLogger","WACommsConnectionState","WAExceededStorageQuota","WAGetHashFromProtocolMsgId","WAGlobals","WAHashStringToNumber","gkx","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u={ERROR_FETCHING_DB_MESSAGE:"error_fetching_db_message",FAILED_TO_ACK_MESSAGE:"failed_to_ack_message",FAILED_TO_CONSTRUCT_ECHO_MESSAGE:"failed_to_construct_echo_message",MESSAGE_UPLOAD_TIMEOUT:"message_upload_timeout",RUNTIME_ERROR:"runtime_error"};function c(e,t,n,a,i,l,u,c,d,m){var _;if(l===void 0&&(l=!1),u===void 0&&(u=!1),d===void 0&&(d="unknown"),m===void 0&&(m=0),!!r("MAWEBSwitch").isEnabled()){r("QPLUserFlow").start(r("qpl")._(521481602,"829"),{annotations:{bool:{eb_switch:r("MAWEBSwitch").isEnabled(),eb_upload_queue:!0,fromUploadQueue:l,is_retroactive_upload:u,is_unified_attachment_upload:!0,is_wasm_serializer_on:r("gkx")("18428"),middleware_init:!1},int:{attachmentsSize:(_=c==null?void 0:c.attachmentInfos.length)!=null?_:0,instanceKey:i,retryCount:m},string:{comms_status:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected",externalId:e,msgType:n,payloadType:d,threadId:t,triggerType:a,userJid:o("WAGlobals").getMyUserJid()},string_array:{attachment_trace_ids:c==null?void 0:c.attachmentInfos.map(function(e){var t;return(t=e.attachmentTraceId)!=null?t:"null"}),media_types:c==null?void 0:c.attachmentInfos.map(function(e){return e.mediaType})}},instanceKey:i,timeoutInMs:r("justknobx")._("1405")}),p(i,"upload_tracking_started"),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").START),o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+(n!=null?n:"unknown"));var f=o("MAWMsgType").isMAWSupportedMediaType(n!=null?n:"Text")?"media":"non-media";o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload."+f)}}function d(e){return e==null?{string:{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected"}}:babelHelpers.extends({},e,{string:babelHelpers.extends({},e.string,{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected"})})}function m(e,t,n,r){switch(e){case"success":h(t,n,r);break;case"fail":g(t,n,r);break;case"point":p(t,n,r);break}}function p(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521481602,"829"),t,{instanceKey:e})}function _(e,t){r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),t,{instanceKey:e})}function f(e,t){var n;r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),d(t),{instanceKey:e}),r("QPLUserFlow").endCancel(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:t==null||(n=t.string)==null?void 0:n.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").CANCEL)}function g(e,t,n){var a;r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),d(n),{instanceKey:e}),r("QPLUserFlow").endFailure(r("qpl")._(521481602,"829"),t,{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:n==null||(a=n.string)==null?void 0:a.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").FAIL)}function h(e,t,n){p(e,t),y(e,n)}function y(e,t){t&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),t,{instanceKey:e}),r("QPLUserFlow").endSuccess(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").SUCCESS)}function C(e,t,n){var a;p(e,t),n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521481602,"829"),n,{instanceKey:e}),r("QPLUserFlow").endTimeout(r("qpl")._(521481602,"829"),{annotations:{bool:{exceededStorageQuota:o("WAExceededStorageQuota").getExceededStorageQuota(),isRelaxedDurability:!0},string:{threadID:n==null||(a=n.string)==null?void 0:a.jid}},instanceKey:e}),(s||(s=o("ODS"))).bumpEntityKey(7319,r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_TRACKING,r("MWEBODSEntityKey.enum").TIMEOUT)}function b(t,n,o){var a=r("qpl")._(521481602,"829");p(t,n),o&&(e||(e=r("QuickPerformanceLogger"))).markerAnnotate(a,o,{instanceKey:t}),(e||(e=r("QuickPerformanceLogger"))).markerEnd(a,52,t,e.currentTimestamp())}function v(){return o("WAHashStringToNumber").hashStringToNumber(o("MAWExternalId").generateExternalId())}function S(e,t){return t===void 0&&(t=0),o("WAHashStringToNumber").hashStringToNumber(o("WAGetHashFromProtocolMsgId").getHashFromProtocolMsgId(e)+"_"+o("WAGlobals").getMyDeviceJid()+"_"+t)}function R(e){return r("MAWEBSwitch").isEnabled()&&o("MAWMsgType").isEBSupportedMsgType(e.type)&&e.ack>=o("MAWAckLevel").ACK.sent&&e.serverTs!=null&&!(e.ephemeralSetting!=null&&e.ephemeralSetting.ephemeralExpirationInSec>0)}function L(e){return{addAnnotations:function(n){_(e,n)},addPoint:function(n,r){p(e,n,r)},endCancel:function(n,r){f(e,r)},endFail:function(n,r){g(e,n,r)},endSuccess:function(n){y(e,n)},getQPLAttrs:function(){return{instanceKey:e}},isActive:function(){return!0},start:function(){}}}function E(e,t){return e.get(t)}function k(e,t,n,r,o){var a=E(t,n);if(a!=null)switch(e){case"success":h(a,r,o);break;case"fail":g(a,r,o);break;case"point":p(a,r,o);break}}l.EBUploadTrackingWorkerFailurePoints=u,l.startUploadTracking=c,l.handleBridgeEbUploadTrackingQPL=m,l.addPointWorkerOnly=p,l.addAnnotationsWorkerOnly=_,l.endCancelWorkerOnly=f,l.endFailWorkerOnly=g,l.endSuccessWorkerOnly=h,l.endTimeoutWorkerOnly=C,l.endRetryWorkerOnly=b,l.genInstanceKeyOnly=v,l.genInstanceKeyForUploadQueue=S,l.isUploadSupported=R,l.makeEBWorkerQplFlowFromInstanceKey=L,l.getUploadTrackingInstanceKey=E,l.addUploadTrackingByType=k}),98);
__d("EncryptedBackupsConstructEchoMessages",["$InternalEnum","EBLogger","EBUploadMessagesFromWorkerMutationDeferred","EchoMessage","EncryptedBackupsUploadQueueProcessor","LSEBPayloadSerializerError","MAWBridgeUpload","MAWDbMsgUtil","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWIndexedDb","MAWMediaUtils","MAWMessageSortOrderUtils","MAWMsgType","MAWTransactionMode","MAWUploadMessageTxns","Promise","WALogger","WAProtocolMsgId","asyncToGeneratorRuntime","getErrorSafe","gkx","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y=r("requireDeferred")("EchoSerializationFailureFalcoEvent").__setRef("EncryptedBackupsConstructEchoMessages"),C=r("requireDeferred")("EchoSerializationSuccessFalcoEvent").__setRef("EncryptedBackupsConstructEchoMessages"),b=r("gkx")("12236"),v=n("$InternalEnum").Mirrored(["FATAL","WARN"]);function S(e,t){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){e.forEach(function(e){var t=e.uploadTrackingInstanceKey;t!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t,"fire_ebls_upload")});var r=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(e,t);r.success||o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyryth_web] uploadMessagesFromWorker failed with error: ",""])),r.error),yield(h||(h=n("Promise"))).all(e.map(function(e){var t=e.uploadTrackingInstanceKey;return t==null?(h||(h=n("Promise"))).resolve():o("EncryptedBackupsUploadQueueProcessor").ackWithInstanceKeyWorkerOnly(t,r.success)}))}),R.apply(this,arguments)}function L(t,n,r,a,i,l,u){var c=n==null?void 0:n.externalId;if(c==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] extId is null, source: ",""])),u),null;if(n!=null&&r!=null){var d=window.performance.now(),m=o("EchoMessage").encodeEchoMessage(t),p=window.performance.now(),_=l==null?void 0:l.get(c);return _==null&&o("MAWMediaUtils").getMediaTypeFromMsgType(n.type)!=null&&u==="upload_queue"&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] attachmentContextArray is null, type: ",""])),n.type),o("MAWEBUploadTrackingUtils").addUploadTrackingByType("point",i,n.externalId,"construct_echo_success"),o("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,attachmentContextArray:_,authTs:n.serverTs,echoDocument:m,echoEncodingLatencyNs:(p-d)*1e6,errorCode:null,errorMessage:null,messageId:c,messageType:n.type,productType:"msgr",protoMsg:a,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(n),threadId:t.threadId,traceId:r,uploadTrackingInstanceKey:o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(i,n.externalId)})}return null}function E(e,t){e!=null&&y.load().then(function(n){return n.log(function(){return{message_id:e,trace_id:t}})})}function k(e,t){e!=null&&C.load().then(function(n){return n.log(function(){return{message_id:e,trace_id:t}})})}function I(e,t){return e==null||t==null?null:e.find(function(e){var n=e.originalMsgProtocolId;if(e.backupActionType===2&&n!=null){var r=n.author,a=n.chat,i=n.externalId;if(r!=null&&a!=null&&i!=null)return o("WAProtocolMsgId").equals({author:r,chat:a,externalId:i},t)}return o("WAProtocolMsgId").equals(e.msgId,t)})}function T(e,t,n,a,i,l,s){var p,_,f=e.echoMessage;if(e.maybeErrorDetail!=null){var g,h,y,C,S=e.maybeErrorDetail,R=S.errorCode,I=S.errorMsg,T=S.uploadErrorType;switch(E((g=a==null||(h=a.msgId)==null?void 0:h.externalId)!=null?g:t.externalId,n),T){case v.WARN:R===r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID?o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["media info invalid thrown from constructEchoMessage, error msg: ",""])),I!=null?I:""):o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["possible error when constructing echo message: ",""])),I!=null?I:"");break;case v.FATAL:o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["fatal error in the upload message flow, error msg: ",""])),I!=null?I:"");break}if(T===v.WARN||R===r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID){var D=T===v.WARN?"possible error when constructing echo message: "+(I!=null?I:""):"media info invalid thrown from constructEchoMessage, error msg: "+(I!=null?I:"");return o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ",""])),D),o("MAWEBUploadTrackingUtils").addUploadTrackingByType("success",i,t.externalId,"construct_echo_success_media/xma_warn/error",{string:{msg:D}}),null}var x=o("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:t.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:R,errorMessage:I,messageId:(y=f==null?void 0:f.xOfflineThreadingId)!=null?y:"0",messageType:t.type,protoMsg:a!=null?a:void 0,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t),threadId:(C=f==null?void 0:f.threadId)!=null?C:"0",traceId:n,uploadTrackingInstanceKey:o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(i,t.externalId)});return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("fail",i,t.externalId,"construct_echo_failed",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_CONSTRUCT_ECHO_MESSAGE,errorMsg:I!=null?I:"null error msg, msg type: "+t.type}}),x}if((f==null?void 0:f.xOfflineThreadingId)==null){var $,P,N,M=o("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:t.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:r("LSEBPayloadSerializerError").OTID_NOT_FOUND_IN_ACT_MESSAGES,errorMessage:null,messageId:"0",messageType:t.type,protoMsg:a!=null?a:void 0,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t),threadId:($=f==null?void 0:f.threadId)!=null?$:"0",traceId:n,uploadTrackingInstanceKey:o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(i,t.externalId)});return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("fail",i,t.externalId,"construct_echo_failed",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_CONSTRUCT_ECHO_MESSAGE,errorMsg:"oitd not found"}}),k((P=a==null||(N=a.msgId)==null?void 0:N.externalId)!=null?P:t.externalId,n),M}var w=L(f,t,n,a!=null?a:void 0,i,l,s);if(w==null)return null;var A=w;return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("point",i,t.externalId,"issue_message_upload_ui_event",{bool:{echo_deprecation_user:b,echo_document_missing:!b&&!f}}),k((p=a==null||(_=a.msgId)==null?void 0:_.externalId)!=null?p:t.externalId,n),A}function D(e,t,n,r,o){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a){var i=new Map;e.forEach(function(e){return i.set(e.dbMsg.externalId,e)});var l=yield N(e);return l.map(function(e){var l=i.get(e.externalId);if(l==null)return null;var s=l.dbMsg,u=l.traceId,c=I(t,o("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(s));return T(e,s,u,c,n,r,a)}).filter(Boolean)}),x.apply(this,arguments)}function $(e,t,n,r){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a){if(!r("MAWEBSwitch").isEnabled()){o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot proceed with encodeAndSendEchoMessage: Encrypted Backups are not enabled"]))),t.forEach(function(e,t){o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_tracking_cancelled_eb_turned_off_upload",{string:{externalId:t,from:"uploadMessageFromUploadQueue"}})});return}try{var i=yield D(e.filter(function(e){var n=o("MAWEBUploadTrackingUtils").isUploadSupported(e.dbMsg)&&e.dbMsg.type!==o("MAWMsgType").MSG_TYPE.RAVEN;return n||o("MAWEBUploadTrackingUtils").addUploadTrackingByType("success",t,e.dbMsg.externalId,"upload_not_supported",{string:{msgType:e.dbMsg.type}}),n}),n,t,a,"upload_queue");return S(i,"EncryptedBackupsConstructEchoMessages:uploadMessageFromUploadQueue")}catch(e){var l="[labyrinth_web] Error while encode and upload message to backup: "+String(e),s=r("getErrorSafe")(e);throw o("EBLogger").EBLogger().catching(s).MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Exception in echo upload: ",""])),l),e}}),P.apply(this,arguments)}var N=o("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:(g=o("MAWTransactionMode")).READONLY,media:g.READONLY,mediaBackup:g.READONLY,messages:g.READONLY,reactions:g.READONLY,receiverFetchInfo:g.READONLY,threads:g.READONLY,xma:g.READONLY},"constructEchoMessage",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return o("MAWUploadMessageTxns").constructEchoMessage.apply(void 0,[e].concat(n))})});l.UploadErrorType=v,l.uploadMessageFromUploadQueue=$}),98);
__d("EBWorkerEBDBApiDeferred",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBWorkerEBDBApi").__setRef("EBWorkerEBDBApiDeferred");function s(){return e.load().then(function(e){return e.startListeningEBDeviceRegistrations()})}function u(t){return e.load().then(function(e){return e.addNewDevice(t)})}function c(t){return e.load().then(function(e){return e.trackConsistency(t)})}function d(t){return e.load().then(function(e){return e.trackOverprompting(t)})}l.startListeningEBDeviceRegistrations=s,l.addNewDevice=u,l.trackConsistency=c,l.trackOverprompting=d}),98);
__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","WAGetAgeBucketForMediaKeyTimestamp","WAGetPlatformFromStanzaId","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.isRetroactiveUpload,n=e.mediaType,a=e.msgType,i=e.objectId,l=e.probeDelayMs,s=e.restoreMethod,u=e.sampleRate,c=e.stanzaId,d=e.timestamp,m=e.triggerSource,p=e.version,_=e.xmaType;return o("MAWQplProxy").startQplUserFlow(r("qpl")._(521473213,"27"),{bool:{isRetroactiveUpload:t,isUnifiedAttachmentUpload:!0},int:{probeDelayMs:l,sampleRate:u},string:{e2eePlatform:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(c),mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(d),mediaType:n,msgType:a,objectId:i,restoreMethod:s,triggerSource:m,version:p,xmaType:_==null?"<null>":_}},{providedTimeoutInMs:r("justknobx")._("3047")})}l.startMediaRestoreProbeQPLFlow=e}),98);
__d("MAWCastToMsgType",["MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"image":return o("MAWMsgType").MSG_TYPE.IMAGE;case"video":return o("MAWMsgType").MSG_TYPE.VIDEO;case"gif":return o("MAWMsgType").MSG_TYPE.GIF;case"sticker":return o("MAWMsgType").MSG_TYPE.STICKER;case"file":return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;case"audio":return o("MAWMsgType").MSG_TYPE.PTT;case"xma":return o("MAWMsgType").MSG_TYPE.XMA}}l.castMsgrServerMediaTypeToMsgType=e}),98);
__d("MAWCastToServerMediaType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"document":case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return e;default:return null}}function l(e){switch(e){case"image":case"video":case"gif":case"sticker":case"preview":return e;case"audio":return"ptt";case"xma":return"xma-image";case"file":return"document"}}i.castToServerMediaType=e,i.castMsgrServerMediaTypeToServerMediaType=l}),66);
__d("EncryptedBackupsMediaRestoreProbeV2",["$InternalEnum","EncryptedBackupsMediaRestoreProbeQpl","MAWCastToMsgType","MAWCastToServerMediaType","Promise","Random","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=n("$InternalEnum")({DEFAULT_PREVIEW:"defaultPreview",FAVICON:"favicon",HEADER:"header",PREVIEWS:"previews"}),g=r("justknobx")._("2045"),h=o("WATagsLogger").TAGS(["MediaRestoreProbeV2"]);function y(e){switch(e){case"video":return 13;case"sticker":return 10;case"audio":return 8;case"gif":return 40;case"file":return 40;case"xma":return 2;case"image":case"preview":return 1}}function C(){return r("gkx")("2067")?100:r("justknobx")._("2722")}function b(e){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.backupMessage,i=t.chatJid,l=t.sortOrderMs,f=t.stanzaId,b=t.triggerSource;if(n("cr:10071")==null)return o("WAResultOrError").makeResult("not-in-gk");var v=S(a);if(v.success===!1)return v;var R=h.TAGS([f]),L=v.value;if(L==="no-attachment-with-msg")return R.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult(L);var E=L.map(function(e){return e.serverMediaType}).filter(function(e){return e!=="preview"}).find(Boolean);if(E==null)return R.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult("no-attachment-with-msg");var k=C(),I=y(E),T=o("Random").coinflip(100/(k*I));if(!T)return(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult("not-sampled"));R.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sampling before delay from source: "," "])),b),yield o("WAPromiseDelays").delayMs(r("gkx")("2067")?5e3:g);var D=yield(_||(_=n("Promise"))).all(L.map(function(e){var t=o("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:!1,mediaType:o("MAWCastToServerMediaType").castMsgrServerMediaTypeToServerMediaType(e.serverMediaType),msgType:o("MAWCastToMsgType").castMsgrServerMediaTypeToMsgType(E),objectId:e.objectId,probeDelayMs:g,restoreMethod:"gql",sampleRate:k,stanzaId:f,timestamp:e.timestamp,triggerSource:b,version:"protobuf",xmaType:e.xmaType});return R.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["start probing. triggerSource: ",", serverMediaType: ",", xmaType: ",", objectId: "," "])),b,e.serverMediaType,e.xmaType,e.objectId),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:i,deliveryObjectId:e.objectId,externalId:f,mediaDownloadFlow:{addAnnotations:function(n){t.addAnnotations(babelHelpers.extends({},n))},addPoint:function(n,r){t.addPoint(n,babelHelpers.extends({},r))}},mediaKey:e.mediaKey,mediaType:e.serverMediaType,sortOrderMs:l}).then(function(n){return n.success?(R.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Probe success"]))),{error:null,qpl:t,v2Payload:e}):(R.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.error),{error:n.error,qpl:t,v2Payload:e})}).catch(function(n){return R.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.toString()),{error:"runtime-error",qpl:t,v2Payload:e}})}));for(var x of D)x.error!=null?x.qpl.endFail(x.error,{string:{failReason:x.error}}):x.qpl.endSuccess();return o("WAResultOrError").makeResult("restore-media-success")}),v.apply(this,arguments)}function S(e){var t,n=e.encryptedTransportMessage();if(n==null)return o("WAResultOrError").makeError("missing-transport");var r=n.consumerMessage();if(r!=null){var a=r.imageMessage();if(a!=null)return E(a,"image");var i=r.videoMessage();if(i!=null){var l,s,u=((l=i.payload.ancillary)==null?void 0:l.gifPlayback)===!0||((s=i.payload.ancillary)==null?void 0:s.gifAttribution)!=null;return E(i,u?"gif":"video")}var c=r.audioMessage();if(c!=null){var d=L(c,"audio");return d.success===!1?d:o("WAResultOrError").makeResult([d.value])}var m=r.stickerMessage();if(m!=null){var p=L(m,"sticker");return p.success===!1?p:o("WAResultOrError").makeResult([p.value])}var _=r.documentMessage();if(_!=null){var g=L(_,"file");return g.success===!1?g:o("WAResultOrError").makeResult([g.value])}}var h=(t=n.armadillo())==null?void 0:t.extendedContentMessage();if(h!=null){var y=h.previews();return o("WAResultOrError").makeResult([R({transport:h.favicon(),xmaType:f.FAVICON}),R({transport:h.headerImage(),xmaType:f.FAVICON}),y.length>0?R({transport:y[0],xmaType:f.DEFAULT_PREVIEW}):null].concat(y.map(function(e){return R({transport:e,xmaType:f.PREVIEWS})})).filter(Boolean))}return o("WAResultOrError").makeResult("no-attachment-with-msg")}function R(e){var t,n,r,a=e.transport,i=e.xmaType,l=a==null||(t=a.integral)==null||(t=t.transport)==null||(t=t.ancillary)==null?void 0:t.objectId;if(l==null)return null;var s=a==null||(n=a.integral)==null||(n=n.transport)==null||(n=n.integral)==null?void 0:n.mediaKeyTimestamp,u=a==null||(r=a.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKey;return u==null?null:{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"xma",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null,xmaType:i}}function L(e,t){var n,r,a,i=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId,l=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,s=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return s==null?o("WAResultOrError").makeError("missing-media-key"):i!=null?o("WAResultOrError").makeResult({mediaKey:o("WAMediaUtils").castToMediaKey(s),objectId:o("WAMediaUtils").stringToDeliveryObjectId(i),serverMediaType:t,timestamp:l!=null?o("WATimeUtils").castLongIntToUnixTime(l):null}):o("WAResultOrError").makeError("missing-object-id")}function E(e,t){var n,r,a,i=L(e,t);if(i.success===!1)return i;var l=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null||(n=n.thumbnail)==null||(n=n.downloadableThumbnail)==null?void 0:n.objectId,s=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,u=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return u==null?o("WAResultOrError").makeError("missing-media-key"):l!=null?o("WAResultOrError").makeResult([i.value,{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"preview",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null}]):o("WAResultOrError").makeResult([i.value])}l.ProbeXmaType=f,l.sampleProbeMediaRestoreV2=b}),98);
__d("EncryptedBackupsWorkerScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("eb",{concurrency:1,maxTaskLimit:1,maxThrottleMs:1e3,timeoutMs:6e4})),e}l.ebScheduler=s}),98);
__d("MAWGetMsgByProtocolIdApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"getMsgsByProtocolMsgIdsTxn",function(e){return(function(t){return o("MAWDbMsgTxns").getMsgsByProtocolMsgId(e,t)})});l.getMsgsByProtocolMsgIdsTxn=e}),98);
__d("MAWTraceUtils",["LSDataTraceTag","LSRequestId","MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e="backup_upload",s="media_backup",u="vesta_registration",c="vesta_login";function d(){return r("LSRequestId").generate()}function m(e){return e}function p(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("LSDataTraceTag").messageTypeText;case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return o("LSDataTraceTag").messageTypeFutureproof;case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return o("LSDataTraceTag").messageTypeCiphertext;case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:return o("LSDataTraceTag").messageTypeUnavailable;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("LSDataTraceTag").messageTypeImage;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("LSDataTraceTag").messageTypeVideo;case o("MAWMsgType").MSG_TYPE.PTT:return o("LSDataTraceTag").messageTypePtt;case o("MAWMsgType").MSG_TYPE.ADMIN:return o("LSDataTraceTag").messageTypeAdmin;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("LSDataTraceTag").messageTypeRevoked;case o("MAWMsgType").MSG_TYPE.GIF:return o("LSDataTraceTag").messageTypeGif;case o("MAWMsgType").MSG_TYPE.STICKER:return o("LSDataTraceTag").messageTypeSticker;case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:return o("LSDataTraceTag").messageTypeExpiredEphemeral;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("LSDataTraceTag").messageTypeEphemeralSettingAdmin;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("LSDataTraceTag").messageTypeEphemeralSyncResponse;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("LSDataTraceTag").messageTypeEphemeralScreenshotAction;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("LSDataTraceTag").messageTypeDeleteForMe;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:return o("LSDataTraceTag").messageTypeEphemeralSettingChangeFromCurrentDevice;case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("LSDataTraceTag").messageTypeAlertICDC;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("LSDataTraceTag").messageTypeGroupInvite;case o("MAWMsgType").MSG_TYPE.XMA:return o("LSDataTraceTag").messageTypeXMA;case o("MAWMsgType").MSG_TYPE.REACTION:return o("LSDataTraceTag").messageTypeReaction;case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return o("LSDataTraceTag").messageTypeSenderKeyDistribution;default:return o("LSDataTraceTag").messageTypeNone}}l.CONTEXT_BACKUP_UPLOAD=e,l.CONTEXT_MEDIA_BACKUP=s,l.CONTEXT_VESTA_REGISTRATION=u,l.CONTEXT_VESTA_LOGIN=c,l.createTraceId=d,l.stringToTraceId=m,l.getTagForMsgType=p}),98);
__d("MAWIsQuotaExceededError",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){return t.name==="QuotaExceededError"||t.inner!=null&&t.inner.name==="QuotaExceededError"};i.isQuotaExceededError=e}),66);
__d("MAWDbHistorySyncQRCodeData",[],(function(t,n,r,o,a,i){"use strict";var e="qrCodeRowId";i.qrCodeRowId=e}),66);
__d("MAWHandleEncryptedBackupsSecretsApi",["MAWDbHistorySyncQRCodeData","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({historySyncQRCodeData:o("MAWTransactionMode").READWRITE},"handleEncryptedBackupsSecret",function(e){return(function(t){var n=t.backupId,a=t.epoch,i=t.mailboxRootKey,l=t.obliviousValidationToken,u=t.serverDataId,c=t.tempOcmfClientState;return e.historySyncQRCodeData.get(o("MAWDbHistorySyncQRCodeData").qrCodeRowId).then(function(t){if(!(t!=null&&t.isQRScanned))return e.historySyncQRCodeData.put({isQRScanned:!0,rowId:o("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"CallFinishAddDevice",value:{backupId:n.toString(),epoch:s(a),mailboxRootKey:i,obliviousValidationToken:l,serverDataId:u.toString(),tempOcmfClientState:c}})}).catch(function(t){return e.historySyncQRCodeData.put({isQRScanned:!1,rowId:o("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(r("emptyFunction"))})})})});function s(e){return e.map(function(e){var t=e.anonId,n=e.id,r=e.rootKey,o=e.status;return{epoch_anon_id:t,epoch_id:n.toString(),epoch_root_key:r,epoch_status:o.toString()}})}l.handleEncryptedBackupsSecret=e}),98);
__d("MAWDbGroupInfoTxns",["MAWBridgeTypesCreators","MAWIndexedDb","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return s(e,t.jid).then(function(n){var r=t.participantVersion;n.success&&n.value.participantVersion!=null&&t.participantVersion==null&&(r=n.value.participantVersion);var o=t.subject.content;o!=null&&o.length===0&&(o=void 0);var a={creationTs:t.creationTs,creator:t.creator,groupJid:t.jid,inviter:t.inviter,memberAddMode:t.memberAddMode,name:o,nameOwner:t.subject.user,nameTs:t.subject.ts,participantVersion:r};return u(e,a).then(function(){return a})})}function s(e,t){return e.groupInfo.get({groupJid:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function u(e,t){return e.groupInfo.put(t).then(function(){o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(t)})})}function c(e,t){return e.groupInfo.bulkPut(t).then(function(){t.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(e)})})})}function d(e,t){return e.groupInfo.bulkGet(t)}function m(e,t){return e.groupInfo.delete(t)}l.putGroupInfo=e,l.getGroupInfo=s,l.updateGroupInfo=u,l.bulkUpdateGroupInfo=c,l.getGroupInfos=d,l.deleteGroupInfo=m}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.groupInvites.put(t).then(function(){return t})}function s(e,t,n){return e.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[t,n]]).delete()}function u(e,t,n){return e.groupInvites.where(["threadJid","inviteeJid"]).equals([t,n]).first()}function c(e,t,n){return e.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[t,n]]).toArray()}function d(e,t){return t.type===o("MAWMsgType").MSG_TYPE.GROUP_INVITE?t.invitedParticipantUserJid==null?o("MAWDexieTable").dexieResolve():u(e,t.threadJid,t.invitedParticipantUserJid):o("MAWDexieTable").dexieResolve()}l.putGroupInvite=e,l.deleteGroupInvitesByThreadAndInvitedParticipant=s,l.maybeGetGroupInvite=u,l.getGroupInvitesByThreadAndInvitedParticipant=c,l.getAndCheckGroupInviteFromMsg=d}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","MAWUserJidWrapper"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=!1;return o("MAWDbParticipantTxns").getInvitedParticipantsInThread(e,t).then(function(r){if(r.length===0){n=!0;var a=o("MAWUserJidWrapper").getMyUserJid();return o("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(e,t,a).then(function(){return n})}else{var i=[];return r.forEach(function(n){i.push(o("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(e,t,n.userJid))}),o("MAWDexieTable").dexieAll(i).then(function(){return n})}})}l.deleteGroupInvitesByThread=e}),98);
__d("MAWLoadOneToOneMessageRequestCapabilitiesTxn",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.map(o("WAJids").interpretAsUserJid).forEach(function(e){return e!=null&&o("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:o("WAJids").extractUserId(e),threadJid:e}})}),o("MAWDexieTable").dexieResolve()}l.loadOneToOneMessageRequestCapabilities=e}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWQplProxy","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a){var i=t.authoritativeThreadKey,l=t.createTs,s=t.description,u=t.folder,c=t.lastActivityTimestamp,d=t.lastReadWatermarkTimestamp,m=t.offlineThreadingId,p=t.skipVerifyThread,f=t.userJid;return o("MAWGetOrCreateThreadTxns").getOrCreateThread(e,{authoritativeThreadKey:i,clientThreadKey:m,createTs:l,description:s,folder:u,instanceKey:a,jid:f,lastActivityTimestamp:c,lastReadWatermarkTimestamp:d,skipVerifyThread:p},n).then(function(t){var i=t.created,l=t.thread;n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"process-setup-thread-start",{instanceKey:n}),a!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"process_setup_thread_start",{instanceKey:a});var s=_(e,f,i,l);return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"process-setup-thread-end",{instanceKey:n}),a!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"process_setup_thread_end",{instanceKey:a}),s})}function u(e,t,n,r){return o("MAWDbGroupInfoTxns").getGroupInfo(e,t).then(function(t){if(!t.success)return null;var a=t.value;return o("MAWGetOrCreateThreadTxns").getOrCreateThread(e,{createTs:o("WATimeUtils").castUnixTimeToMillisTime(a.creationTs),description:"getOrRepairGroupThread",folder:n,jid:a.groupJid,skipVerifyThread:r}).then(function(e){var t=e.created,n=e.thread;return{created:t,groupInfo:a,thread:n}})})}function c(t,n){var r=[],a=[];return n.forEach(function(e){o("MAWDbMsg").isMediaMsg(e)&&e.mediaId!=null&&(r.push(e.mediaId),a.push(e.msgId))}),t.media.bulkGet(r).then(function(n){var r=[],i=[];n.forEach(function(e,t){if(e!=null){var n=a[t];e.msgIds=o("WASortedLists").filter(e.msgIds,function(e){return e!==n}),e.mediaEntries.delete(n),e.msgIds.length===0&&e.mediaEntries.size===0&&(e.plaintextHash!=null&&r.push(e.hashedPlaintextHash),i.push(e.mediaId))}});var l=t.media.bulkDelete(i),s=t.chunk.where("hashedPlaintextHash").anyOf(r).delete();return o("MAWDexieTable").dexieAll([l,s]).then(function(){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"])),i.length,r.length)})})}function d(e,t){return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,t.jid).then(function(n){return e.messages.where("threadJid").equals(t.jid).toArray().then(function(r){return p(e,t,n,r,!0)})})}function m(e,t,n,r){var a=n==null?void 0:n.lastMessageTimestamp;if(n==null)return d(e,t);var i=e.messages.where("threadJid").equals(t.jid).toArray(),l=o("MAWDbMsgTxns").getThreadNewestMessageMs(e,t.jid);return o("MAWDexieTable").dexieAll([i,l]).then(function(i){var l=i[0],s=i[1],u=[],c=new Set;if(a!=null&&l.forEach(function(e){var t,n=(t=e.originalTs)!=null?t:e.ts;n<=a+1&&(c.add(e.msgId),u.push(e))}),(n==null?void 0:n.messages.length)!==0){var d=new Set;n.messages.forEach(function(e){var t;d.add((t=e.key)==null?void 0:t.id)}),l.forEach(function(e){d.has(e.externalId)&&!c.has(e.msgId)&&(c.add(e.msgId),u.push(e))})}if(u.length!==l.length){for(var m of l)if(!c.has(m.msgId)&&m.type!==o("WAMsgType").ADMIN)return p(e,t,s,u,!1,r)}return p(e,t,s,l,!0,r)})}function p(e,t,n,r,a,i){var l=o("WAJids").interpretAsGroupJid(t.jid),s=a?o("MAWDbThreadTxns").deleteThread(e,t.jid):o("MAWDexieTable").dexieResolve(),u=a?o("MAWDbParticipantTxns").deleteAllParticipantsForThread(e,t.jid):o("MAWDexieTable").dexieResolve(),d=o("MAWDexieTable").dexieResolve(!1),m=o("MAWDexieTable").dexieResolve();return l!=null&&a&&(d=o("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(e,l),m=o("MAWDbGroupInfoTxns").deleteGroupInfo(e,l)),o("MAWDexieTable").dexieAll([c(e,r),o("MAWDbReactionsTxns").deleteAllReactionsForMessages(e,r),o("MAWDbMsgTxns").deleteMessages(e,r,i),s,u,m,d]).then(function(e){var i=e[0],s=e[1],u=e[2],c=e[3],d=e[4],m=e[5],p=e[6];return a&&(o("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(t,n),l!=null&&p&&o("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:o("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(t.jid)}),o("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:t.jid})),{deletedMessages:r.map(function(e){return o("MAWDbMsg").getWAMsgId(e)})}})}function _(e,t,n,r){var a=o("MAWDbParticipantTxns").bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(e)})});return o("MAWDexieTable").dexieAll([o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities([r.jid]),a]).then(function(){return{created:n,thread:r}})}l.getOrSetupOneToOneThread=s,l.getGroupThread=u,l.deleteAllThreadData=d,l.metaSyncChatDeleteThread=m}),98);
__d("MAWWriteMetaSyncsTxns",["MAWDbDeletedMessages","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDbThreadTxns","MAWDexieTable","MAWFTSTxns","MAWThreadManagementTxns","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=30*o("WATimeUtils").DAY_SECONDS;function c(t,n){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received chatDelete: ",""])),n);var r=n.messageRange,a=r!=null?o("MAWDbPendingStanzaTxns").putPendingStanza(t,{content:{metaSyncMessageRange:r},type:o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD},u,n.chatJid,o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(t,n.chatJid),a,o("MAWFTSTxns").maybePutThreadToPurgeBacklog(t,n.chatJid)]).then(function(e){var r=e[0];return r.success?o("MAWThreadManagementTxns").metaSyncChatDeleteThread(t,r.value,n.messageRange,o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.cast(n.type)):(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[MAWWriteMetaSyncsTxns] Thread delete stanza was processed before thread insertion ",""])),n.chatJid),{deletedMessages:[]})})}l.PENDING_DELETE_THREAD_EXPIRATION_IN_SEC=u,l.handleChatDelete=c}),98);
__d("WADeleteReceiptsApi",["MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.receipts.where("waMsgId").anyOf(t).delete().then(function(){})}var s=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"deleteReceipts",function(t){return function(n){return e(t,n)}});l.deleteAllReceiptsForWAMsgIds=e,l.deleteReceipts=s}),98);
__d("MAWHandleMetaSyncAction",["MAWIndexedDb","MAWTransactionMode","MAWWriteDeleteMessageTxns","MAWWriteMetaSyncsTxns","Promise","WAAssertUnreachable","WADeleteReceiptsApi","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){for(var t of e.actions)t.chatAction?yield m(t.chatAction):t.messageAction&&(yield f(t.messageAction))}),d.apply(this,arguments)}function m(t){switch(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received action: ",""])),t),t.type){case"chat_archive":return p(t);case"chat_delete":return g(t).then(function(e){var t=e.deletedMessages;return o("WADeleteReceiptsApi").deleteReceipts(t)});default:return t.type,_(t)}}function p(e){return(u||(u=n("Promise"))).resolve()}function _(e){return(u||(u=n("Promise"))).resolve()}function f(e){switch(e.type){case"delete_for_me":return h(e).then(r("emptyFunction"));default:return r("WAAssertUnreachable")(e.type)}}var g=o("MAWIndexedDb").makeMsgrTransactor({chunk:(s=o("MAWTransactionMode")).READWRITE,deletedMessages:s.READWRITE,editMsgHistory:s.READWRITE,ftsPurgeThreadBacklog:s.READWRITE,groupInfo:s.READWRITE,groupInvites:s.READWRITE,media:s.READWRITE,messages:s.READWRITE,participants:s.READWRITE,pendingStanzas:s.READWRITE,reactions:s.READWRITE,threads:s.READWRITE,unrenderedMessages:s.READWRITE,xma:s.READWRITE},"handleChatDeleteTxn",function(e){return function(t){return o("MAWWriteMetaSyncsTxns").handleChatDelete(e,t)}}),h=o("MAWIndexedDb").makeMsgrTransactor({chunk:s.READWRITE,editMsgHistory:s.READWRITE,ftsPurgeBacklog:s.READWRITE,groupInfo:s.READWRITE,groupInvites:s.READWRITE,media:s.READWRITE,messages:s.READWRITE,pendingStanzas:s.READWRITE,reactions:s.READWRITE,threads:s.READWRITE,unrenderedMessages:s.READWRITE,xma:s.READWRITE},"handleDeleteForMeTxn",function(e){return function(t){return o("MAWWriteDeleteMessageTxns").handleDeleteForMe(e,t)}});l.handleMetaSyncActions=c}),98);
__d("MAWSharedCOPLogger",["MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MWFBLogger").MWLogger().tags(["COP"]);l.default=e}),98);
__d("MAWProtocolQueueAppdata",["MAWHandleEncryptedBackupsSecretsApi","MAWHandleMetaSyncAction","MAWSharedCOPLogger","Promise","WAConvertAppData","WAMsgApplication.pb","WAParseMessageApplication","WAProtocolQueue","WAResultOrError","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e){var t=e.map(function(e){return f(e.appdata)});return(p||(p=n("Promise"))).all(t.map(function(e){var t=g(e);return t})).then(function(t){var n=[];return t.map(function(t,r){t.success===!0&&n.push(e[r].stanzaQueueId)}),{followUpParams:void 0,toAck:n}})}function f(t){r("MAWSharedCOPLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Parse Appdata application protocol"])));var n=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgApplication.pb").MessageApplicationSpec,o("WAProtocolQueue").extractSubProtocolFromAppdataProtocol(t).payload),a=o("WAParseMessageApplication").parseMessageApplication(n);if(a.type==="error"){r("MAWSharedCOPLogger").MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Appdata contains unparseable message application."])));return}return o("WAConvertAppData").parseAppData(a)}function g(e){if(r("MAWSharedCOPLogger").DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata"]))),e==null)return(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult());switch(e.type){case"meta_sync":return r("MAWSharedCOPLogger").DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: meta sync"]))),o("MAWHandleMetaSyncAction").handleMetaSyncActions(e).then(function(){return o("WAResultOrError").makeResult()});case"backups_secrets":return r("MAWSharedCOPLogger").DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: backup secret"]))),o("MAWHandleEncryptedBackupsSecretsApi").handleEncryptedBackupsSecret(e.encryptedBackupsSecrets).then(function(){return o("WAResultOrError").makeResult()});case"sync_key_share":return(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult());case"sync_key_request":return(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult());default:return e.type,r("MAWSharedCOPLogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e.type),(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}l.handleAppdataStanzas=_}),98);
__d("MAWCOPAppdataHandler",["MAWIsQuotaExceededError","MAWProtocolQueueAppdata","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Appdata consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueAppdata").handleAppdataStanzas(e);return t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing appdata batch, see transactor error reports."]))),t.toAck}),d.apply(this,arguments)}l.copIncomingAppdataHandler=u}),98);
__d("MAWDbGetAlertsWithDeviceJidTxn",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.deviceChangeAlerts.filter(function(e){return e.deviceJid===t&&!e.loggedOut}).toArray().then(function(e){return e.length>1&&r("err")("Invalid result, more than one active devices with the same deviceJid: "+t),e[0]})}l.getAlertsWithDeviceJidTxn=e}),98);
__d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn",["MAWIndexedDb"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.deviceChangeAlerts.filter(function(e){return e.isArchived===!1}).toArray().then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"UnArchivedSelfDeviceChangeAlerts",value:e.length})})}l.getUnArchivedDeviceChangeAlertsCountTxn=e}),98);
__d("MAWDbUpdateDeviceChangeAlertsTxn",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.deviceChangeAlerts.put(t)}i.updateDeviceChangeAlertsTxn=e}),66);
__d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn",["MAWDbGetAlertsWithDeviceJidTxn","MAWDbUpdateDeviceChangeAlertsTxn"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(e,t).then(function(t){return o("MAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn(e,babelHelpers.extends({},t,{loggedOut:!0}))})}l.updateDeviceChangeAlertsLogInStatusTxn=e}),98);
__d("WAUpdateDevicesForUserApi",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.allowSecurityAlertForContact,n=e.isMe;return!n&&t}i.getShouldShowAdminMessages=e}),66);
__d("WAUpdateRotateSenderKeyToTrue",["WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=yield e.stores.personalSenderKeyStatuses.bulkGet(t),r=n.filter(function(e){return e!=null}).map(function(e){return babelHelpers.extends({},e,{rotateSenderKey:!0})});return yield e.stores.personalSenderKeyStatuses.bulkPut(r),r});return function(t){return e.apply(this,arguments)}})(),o("WASignalDB").signalOp("updateRotateSenderKeyToTrue"))};l.updateRotateSenderKeyToTrue=e}),98);
__d("MAWProtocolQueueInstructions",["FBLogger","MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWDbGetAlertsWithDeviceJidTxn","MAWDbGetUnArchivedDeviceChangeAlertsCountTxn","MAWDbMsgTypeVersionTxns","MAWDbThreadTxns","MAWDbUpdateDeviceChangeAlertsLogInStatusTxn","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWTransactionMode","Promise","WAArmadilloTransportEvent.pb","WAAssertUnreachable","WADbContact","WAGlobals","WAJids","WALogger","WAOdsEnums","WAUpdateDevicesForUserApi","WAUpdateRotateSenderKeyToTrue","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=new Set(t.map(function(e){return e.jid}));return o("MAWDexieTable").dexieAll([o("MAWDbMsgTypeVersionTxns").maybeBulkGetSecuritySetting(e),o("MAWDbThreadTxns").getAllThreadsForUsers(e,Array.from(n))])}function d(e){var t=o("WAGlobals").getMyUserJid(),a=e.filter(function(e){return e.jid===t&&e.deviceChangeType!==o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.NONE});return a.length===0?(u||(u=n("Promise"))).resolve():o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY,deviceChangeAlerts:o("MAWTransactionMode").READWRITE},"recordDeviceChangeHistory",function(e){return function(){return o("MAWDbMsgTypeVersionTxns").getSecuritySettingForSelf(e).then(function(t){if(t)return o("MAWDexieTable").dexieAll(a.map(function(n){switch(n.deviceChangeType){case o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.ADDED:return n.identity!=null&&n.model!=null&&n.platform!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:n.device,identity:n.identity,isArchived:!t,model:n.model,platform:n.platform,ts:n.ts}):o("MAWDexieTable").dexieResolve();case o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REMOVED:return o("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(e,n.device);case o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED:return n.identity!=null&&n.model!=null&&n.platform!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:n.device,identity:n.identity,isArchived:!1,model:n.model,platform:n.platform,ts:n.ts}):o("MAWDexieTable").dexieResolve();default:return r("FBLogger")("wmi").mustfix("Unknown device change type"),o("MAWDexieTable").dexieResolve()}})).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)})})}})()}function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:Array.from(new Set(e.map(function(e){return e.jid})))}),n=yield _(e,t),r=n.followUpParams,a=n.toAck,i=r.groupsToUpdateForIdentityRemoved.flat();return yield o("WAUpdateRotateSenderKeyToTrue").updateRotateSenderKeyToTrue(i),{followUpParams:void 0,toAck:a}}),p.apply(this,arguments)}var _=o("MAWIndexedDb").makeMsgrTransactor({appMeta:(s=o("MAWTransactionMode")).READONLY,deviceChangeAlerts:s.READWRITE,ftsBackloggedMessages:s.READWRITE,groupInfo:s.READONLY,messages:s.READWRITE,participants:s.READONLY,threads:s.READWRITE},"handleInstructions",function(e){return(function(t,n){return c(e,t).then(function(r){var a=r[0],i=a.allowSecurityAlertForContact,l=a.allowSecurityAlertForSelf,s=r[1];return o("MAWDexieTable").dexieSequentialAll(t.map(function(t){var r,a=t.jid,u=a===o("WAGlobals").getMyUserJid(),c=o("WAUpdateDevicesForUserApi").getShouldShowAdminMessages({allowSecurityAlertForContact:i,isMe:u})&&n.get(a)===o("WADbContact").TWO_WAY_CONTACT,d={allowSecurityAlertForSelf:l,isMe:u,shouldShowAdminMessages:c,threads:(r=s.get(a))!=null?r:[],user:a};return function(){return f(e,t,d)}})).then(function(){var e=t.filter(function(e){return e.instruction==="identityRemoved"}).map(function(e){var t,n=(t=s.get(e.jid))!=null?t:[],r=n.map(function(e){return o("WAJids").interpretAsGroupJid(e.jid)}).filter(Boolean);return r});return{followUpParams:{groupsToUpdateForIdentityRemoved:e},toAck:t.map(function(e){return e.stanzaQueueId})}})})})});function f(e,t,n){switch(t.instruction){case"identityChanged":return g(e,t,n);case"identityAdded":return h(e,t,n);case"identityRemoved":return y(e,t,n);case"icdcError":return C(e,t,n);default:throw r("WAAssertUnreachable")(t)}}function g(e,t,n){var r=n.allowSecurityAlertForSelf,a=n.isMe,i=n.shouldShowAdminMessages,l=n.threads,s=a&&t.model!=null&&t.platform!=null&&t.notificationTs!=null;return o("MAWDexieTable").dexieAll([s&&t.model!=null&&t.platform!=null&&t.notificationTs!=null&&t.identity!=null&&t.device!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:t.device,identity:t.identity,isArchived:!r,model:t.model,platform:t.platform,ts:t.notificationTs}).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)}):o("MAWDexieTable").dexieResolve()].concat(i?l.map(function(n){return o("WAJids").interpretAsGroupJid(n.jid)==null&&o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,t.jid,n,o("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.update,t.notificationTs)}):[])).then(function(){(s||i)&&o("MAWODSProxy").odsBumpEntityKey({entity:a?o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:o("MAWDbDeviceChangeAlerts").KEY_CHANGE})})}function h(e,t,n){var r=n.allowSecurityAlertForSelf,a=n.isMe,i=n.shouldShowAdminMessages,l=n.threads,s=n.user,u=a&&t.model!=null&&t.platform!=null&&t.notificationTs!=null;return o("MAWDexieTable").dexieAll([u&&t.model!=null&&t.platform!=null&&t.notificationTs!=null&&t.identity!=null&&t.device!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").ADD,deviceJid:t.device,identity:t.identity,isArchived:!r,model:t.model,platform:t.platform,ts:t.notificationTs}).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)}):o("MAWDexieTable").dexieResolve()].concat(i?l.map(function(n){return o("WAJids").interpretAsGroupJid(n.jid)==null&&o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,s,n,o("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.add,t.notificationTs)}):[])).then(function(){(u||i)&&o("MAWODSProxy").odsBumpEntityKey({entity:a?o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:o("MAWDbDeviceChangeAlerts").ADD})})}function y(e,t,n){var r=n.isMe,a=n.shouldShowAdminMessages,i=n.threads,l=n.user;return o("MAWDexieTable").dexieAll([r&&t.device!=null?o("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(e,t.device).then(function(){return o("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(e,t.device)}).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)}):o("MAWDexieTable").dexieResolve()].concat(a?i.map(function(n){return o("WAJids").interpretAsGroupJid(n.jid)==null&&o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,l,n,o("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.remove,t.notificationTs)}):[])).then(function(){(r||a)&&o("MAWODSProxy").odsBumpEntityKey({entity:r?o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:o("MAWDbDeviceChangeAlerts").REMOVE})})}function C(t,n,r){var a=r.threads;if(!o("WAGlobals").getConfig().isICDCErrorEnabled())return o("MAWDexieTable").dexieResolve();var i=a.find(function(e){return e.jid===n.jid});return i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ICDC error instruction for thread "," not found"])),n.jid),o("MAWDexieTable").dexieResolve()):o("MAWAdminWriteUserDeviceMsgTxn").writeICDCAlert(t,n.jid,i,n.notificationTs)}l.recordDeviceChangeHistory=d,l.handleInstructions=m}),98);
__d("MAWCOPInstructionsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueInstructions","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Instruction consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueInstructions").handleInstructions(e);return t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing instructions batch, see transactor error reports."]))),t.toAck}),d.apply(this,arguments)}l.copIncomingInstructionsHandler=u}),98);
__d("MAWCommonScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("msgr-common",{concurrency:1,maxTaskLimit:10,maxThrottleMs:5e3})),e}l.mawCommonScheduler=s}),98);
__d("MAWDebugMsg",["MAWBridge","MAWBridgeMsg","MAWExternalId","MAWJidUtils","MAWLocalizationType","MAWLocalizationUtils","OfflineThreadingId","WAStanzaUtils","WATimeUtils","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){if(r("gkx")("23915")){var a=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(e,o("WAStanzaUtils").toStanzaId(o("OfflineThreadingId").createOfflineThreadingID())),i=(n==null?void 0:n.decryptionError)==="errDuplicateMsg"?", existing message":"",l=o("WATimeUtils").unixTimeMs(),u=s(e,a,t+i,l),c=[u];o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:c})}}function s(e,t,n,r){var a=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:["[fb-only][DEBUG]: "+n],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG,version:0},e,o("MAWExternalId").generateExternalId());return{tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(babelHelpers.extends({},a,{msgId:t,sortOrderMs:r}))}}l.writeDebugMsg=e}),98);
__d("WAParseV3Protocol",["WAAckLevel","WAAssertUnreachable","WAHex","WAMsgType","WAParseConsumerMessageProtocol","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return function(t,n,a,i,l,s){var u,c,d={id:{chat:n,author:i,externalId:a},ts:l,serverTs:l,ack:o("WAAckLevel").ACK.RECEIVED,forwardingScore:t.type!=="futureProof"&&(u=t==null||(c=t.metadata)==null?void 0:c.forwardingScore)!=null?u:0};if(t.type==="futureProof")return{unstoredMsg:{type:o("WAMsgType").FUTUREPROOF,msgContent:{subtype:null,protobuf:o("WAHex").bytesToBuffer(t.protobuf)},id:d.id,ts:d.ts,sentTs:d.sentTs,serverTs:d.serverTs,ack:d.ack,reportingMeta:d.reportingMeta},unstoredMedia:null,unstoredQuotedMedia:null};if(t.type==="subprotocol"){var m=e==null?void 0:e.get(t.subprotocolType);if(m!=null)return m(n,t.subprotocol,d,t.protobuf,t.metadata,s);switch(t.subprotocolType){case"consumerMessage":return o("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(n,t.subprotocol,d,t.protobuf,t.metadata,s);case"businessMessage":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);case"paymentMessage":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);case"multiDevice":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);case"voip":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);default:throw r("err")("Subprotocol parser for: "+t.subprotocolType+" was not found")}}else return r("WAAssertUnreachable")(t.type)}}l.createV3ProtocolParser=e}),98);
__d("MAWIncomingMsgUtils",["FBLogger","MAWCurrentUser","MAWEphemeralUtil","MAWLocalizationUtils","MAWParseArmadilloProtocol","MAWSharedCOPLogger","MAWUnstoredContentToUnstoredDbContentUtils","MpsAdminMsgToBridge","WAJids","WAParseV3Protocol","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["threadJid"],s=null;function u(){if(s==null){var e=function(t,n,r,a,i,l){return o("MAWParseArmadilloProtocol").parseArmadilloProtocol(t,n,r,a,i,l)};s=o("WAParseV3Protocol").createV3ProtocolParser(new Map([["armadillo",e]]))}return s}function c(e){var t=e.author,n=e.chat,a=e.ebTimestampMs,i=e.externalId,l=e.msg,s=e.reportingMeta,c=e.serverTs;if(l.version==="v2")throw r("FBLogger")("messenger_web").mustfixThrow("Armadillo does not support protobuf v2");if(l.type==="ephemeral"){var m=o("MAWEphemeralUtil").buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder(c);return s!=null&&m.unstoredDbMsg!=null&&(m.unstoredDbMsg.reportingMeta=s),m}if(l.type==="admin"){var p=t==="@me"?o("MAWCurrentUser").getID():o("WAJids").extractUserId(t);return d(p,n,i,l,c,a)}var _=babelHelpers.extends({unstoredXMA:null},u()(l,n,i,t,c,a));return s!=null&&_.unstoredMsg!=null&&(_.unstoredMsg.reportingMeta=s),o("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(_)}function d(t,n,a,i,l,s){var u;try{u=o("MpsAdminMsgToBridge").getMessageContent(t,i.content)}catch(e){r("MAWSharedCOPLogger").catching(r("getErrorSafe")(e)).mustfix("Failed to get admin message content")}if(u==null)return{unstoredDbMedia:null,unstoredDbMsg:null,unstoredDbReaction:null};var c=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:u.adminMsgContent,adminType:u.adminType,version:1},n,a,l,void 0,s!=null?s:l*1e3),d=c.threadJid,m=babelHelpers.objectWithoutPropertiesLoose(c,e);return{unstoredDbMedia:null,unstoredDbMsg:m,unstoredDbReaction:null}}l.getDbMsg=c,l.getMiTransportAdminDbMsg=d}),98);
__d("MAWProtocolQueueDecodeProto",["MAWIncomingMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){switch(e.type){case"IncomingMsg":{var n=e.folder,r=e.id,a=e.msg,i=e.reportingMeta,l=e.ts,s=r.author,u=r.chat,c=r.externalId;return o("MAWIncomingMsgUtils").getDbMsg({author:s,chat:u,ebTimestampMs:t,externalId:c,folder:n,msg:a,reportingMeta:i,serverTs:l})}case"InvisibleMsg":case"IncomingCiphertextMsg":default:return}}l.decodeMsg=e}),98);
__d("MAWHIMLogger",["MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MWFBLogger").MWLogger().tags(["HandleIncomingMessage"]);l.default=e}),98);
__d("MAWDbRavenActionTxns",["FBLogger","MAWBridgeTypesCreators","MAWDbMsg","MAWIndexedDb","MAWMsg","MAWRavenUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return e.messages.where("externalId").equals(t.ravenActionToMsgExternalId).filter(function(e){return e.threadJid===n.jid}).first().then(function(a){var i=a==null?void 0:a.msgId;if(i==null){r("FBLogger")("maw_incoming_handlers").warn("[MAWDbRavenActionTxns] Cannot Write Raven Action without ID of Raven Message.");return}return s(e,a).then(function(r){var o=babelHelpers.extends({msgId:i,threadJid:n.jid},t);return e.unrenderedMessages.add(o).then(function(e){return babelHelpers.extends({rowId:e},o)})}).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"RavenActionUpdate",value:o("MAWBridgeTypesCreators").createBridgeRavenAction(e)})})})}function s(e,t){if((t==null?void 0:t.type)!=="Raven")throw r("FBLogger")("messenger_web").mustfixThrow("Cannot Modify Message because Message is not Raven Message");var n=[o("MAWMsg").MAWRavenMsgEphemeralMediaState.cast(Number(t.ravenEphemeralMediaState)),o("MAWMsg").MAWRavenMsgEphemeralType.cast(Number(t.ravenEphemeralType))],a=n[0],i=n[1];if(a==null||i==null)throw r("FBLogger")("messenger_web").mustfixThrow("ravenEphemeralMediaStateEnum or ravenEphemeralTypeEnum is null");var l=o("MAWRavenUtils").getNextRavenMessageEphemeralState(a,i);return e.messages.put(babelHelpers.extends({},t,{ravenEphemeralMediaState:l}))}function u(e,t,n){var r=o("MAWDbMsg").isRavenActionMsgType(n)&&(t==null?void 0:t.externalId)!=null?[t.externalId]:[];return e.messages.where("externalId").anyOf(r).filter(function(e){return e.author===(t==null?void 0:t.author)&&e.threadJid===(t==null?void 0:t.chat)}).first()}l.writeRavenActionMsg=e,l.modifyRavenMsgWithActionMsg=s,l.maybeGetRavenMsgQueryByProtocolMsgId=u}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWIndexedDb","MAWMsgType","MAWODSProxy","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAOdsEnums","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a,i,l,s,u){if(n<0)throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected ephemeral time setting");var c=o("MAWEphemeralUtils").getEphemeralSettingChangeData(t,n,l,s),d={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:t!=null?t:o("WAJids").AUTHOR_SYSTEM,msgContent:c,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN},m=t!=null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,u,i.jid,t):o("MAWDexieTable").dexieResolve();return m.then(function(t){if(t==null){var n=babelHelpers.extends({},d,{externalId:u,sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(a),threadJid:i.jid,ts:a});return o("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(e,n,i,o("WATimeUtils").castUnixTimeToMillisTime(a)).then(function(e){return babelHelpers.extends({},n,{msgId:e.msgId,protocolMsgId:e.protocolMsgId,rowId:e.rowId})})}else if(t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_setting_admin_msg_ciphertext_replacement"});var r=babelHelpers.extends({},t,d);return e.messages.put(r).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(r)}),r})}else return null})}function s(e,t,n,r,a,i,l){var s=t===o("MAWUserJidWrapper").getMyUserJid(),u=o("MAWEphemeralUtils").getEphemeralScreenshotActionData(a,t,s),c=u.ephemeralScreenshotActionContent,d=u.ephemeralScreenshotActionType;if(l==null){var m={ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s?o("WAJids").AUTHOR_ME:t,externalId:i,msgContent:{adminMsgContent:c,adminType:d,screenshotActionType:a,version:1},sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(r),threadJid:n.jid,ts:r,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return o("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(e,m,n,o("WATimeUtils").castUnixTimeToMillisTime(r)).then(function(e){return babelHelpers.extends({},m,{msgId:e.msgId,protocolMsgId:e.protocolMsgId,rowId:e.rowId})})}else if(l.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_screenshot_action_msg_ciphertext_replacement"});var p=babelHelpers.extends({},l,{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s?o("WAJids").AUTHOR_ME:t,msgContent:{adminMsgContent:c,adminType:d,screenshotActionType:a,version:1},type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return e.messages.put(p).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(p)}),p})}else return o("MAWDexieTable").dexieResolve(null)}l.writeEphemeralSettingAdminMsg=e,l.writeEphemeralScreenshotActionMsg=s}),98);
__d("MAWMsgActionType",[],(function(t,n,r,o,a,i){"use strict";var e={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};i.MSG_ACTION=e}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return u([{deliveryReceipts:t==="delivered"?n:[],msgId:e,readReceipts:t==="read"?n:[],senderReceipts:t==="sender"?n:[]}]).then(function(e){return e[0]||{type:"missing"}})}function u(t){var n=t.map(function(e){return e.msgId}),r=new Map;t.forEach(function(e){r.set(e.msgId,e)});var a=n.map(function(t){var n=r.get(t);if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"]))),null;var a=new Set,i=new Map,l=n.deliveryReceipts,s=n.readReceipts,u=n.senderReceipts;return[{receiptType:"delivered",receivers:l},{receiptType:"read",receivers:s},{receiptType:"sender",receivers:u}].forEach(function(e){var t=e.receiptType,n=e.receivers;n.forEach(function(e){var n=e.device,r=e.ts,l=o("WAJids").extractUserJid(n),s=!1;if(t!=="sender"){var u=i.get(l),m=c(u,t,r);i.set(l,m),s=d(u,m)}s&&a.add(l)})}),{affectedUserJids:a,receipt:{msgId:t,statusTsPerUser:i}}}).filter(Boolean);return o("MAWDexieTable").dexieResolve(a.map(function(e){return{affectedUserJids:e.affectedUserJids,receipt:e.receipt}}))}function c(e,t,n){var r,o=(r=e==null?void 0:e.deliveredTs)!=null?r:n,a=e==null?void 0:e.readTs;return t==="read"&&a==null&&(a=n),{deliveredTs:o,readTs:a}}function d(e,t){return((t==null?void 0:t.deliveredTs)||0)>((e==null?void 0:e.deliveredTs)||0)||((t==null?void 0:t.readTs)||0)>((e==null?void 0:e.readTs)||0)}function m(e){if(!(e==null||e.size===0))return e}function p(e,t){return e.receipts.bulkDelete(t)}l.writeReceiptsForDevices=s,l.bulkWriteReceiptsForDevices=u,l.bulkDeleteAllReceiptsForMessages=p}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e===o("MAWFolderTypes").FOLDER_ID.PENDING||e===o("MAWFolderTypes").FOLDER_ID.OTHER;return t}function s(e,t){return(e===null||e===o("MAWFolderTypes").FOLDER_ID.INBOX)&&(t===o("WADbContact").REVERSED_ONE_WAY_CONTACT||t===o("WADbContact").NON_CONTACT)}l.isMessageRequestOrSpamThread=e,l.isInboxRequest=s}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWDbMsgTxns","MAWDexieTable","MAWMessageRequestUtils","MAWTimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,o,a){a===void 0&&(a=!1);var i=new Map;return i.set(t,{msgId:n,sortOrderMs:o}),s(e,i,a).then(function(e){var n=e.get(t);if(n==null)throw r("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return n})}function s(e,t,n){return n===void 0&&(n=!1),c(e,t).then(function(t){var n=t.threadJidToReadReceiptInfo,r=t.updatedThreads;return e.threads.bulkPut(r).then(function(){return r.forEach(function(e){var t,r;n.set(e.jid,{isReadReceiptExpectedToBeSent:(t=(r=n.get(e.jid))==null?void 0:r.isReadReceiptExpectedToBeSent)!=null?t:!1,type:"success"})}),n})})}function u(e,t,n){return o("MAWDbMsgTxns").getThreadOldestMessageId(e,t.jid).then(function(e){if(e==null)return null;var r=o("MAWTimeUtils").ensureValidMillisTime(t.newestMsgTs);return babelHelpers.extends({},t,{lastReadMsg:n.msgId,newestMsgTs:r})})}function c(e,t){var n=new Map,a=Array.from(t.keys()),i=[];return e.threads.where("jid").anyOf(a).toArray().then(function(l){var s=new Map;l.forEach(function(e){return s.set(e.jid,e)}),a.forEach(function(e){s.has(e)||s.set(e,null)});var c=Array.from(s).map(function(o){var a=o[0],l=o[1];if(l==null){n.set(a,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}var s=d(l.folder);n.set(l.jid,{isReadReceiptExpectedToBeSent:s,type:"success"});var c=t.get(l.jid);if(c==null)throw r("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return u(e,l,c).then(function(e){e!=null&&i.push(e)})});return o("MAWDexieTable").dexieAll(c).then(function(){return{threadJidToReadReceiptInfo:n,updatedThreads:i}})})}function d(e){return!o("MAWMessageRequestUtils").isMessageRequestOrSpamThread(e)}l.markThreadAsReadUpToMsgSortOrderMs=e,l.bulkMarkThreadAsReadUpToMsgSortOrderMs=s,l.isReadReceiptExpectedToBeSentFor=d}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("WAMsg").craftWAMsgIdString({author:r.author,chat:n,externalId:r.externalId});return t.pendingReceipts.get(a).then(function(n){if(n!=null)if(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""])),r.externalId,r.author),n.author===o("WAJids").AUTHOR_ME){var i=o("MAWDexieTable").dexieResolve();return n.deliveryReceipts.length>0&&(i=i.then(function(){return o("MAWDbReceiptTxns").writeReceiptsForDevices(r.msgId,"delivered",n.deliveryReceipts)})),n.readReceipts.length>0&&(i=i.then(function(){return o("MAWDbReceiptTxns").writeReceiptsForDevices(r.msgId,"read",n.readReceipts)})),i.then(function(e){var n=[];return e!=null&&e.type!=="missing"&&e.receipt.statusTsPerUser.forEach(function(e,a){var i,l=e.deliveredTs!=null?r.ts:o("WATimeUtils").castToUnixTime(0),s=e.readTs!=null?r.ts:o("WATimeUtils").castToUnixTime(0),u=(i=e.readTs)!=null?i:o("WATimeUtils").castToUnixTime(0);n.push(o("MAWDbParticipantTxns").updateParticipantTimestamps(t,[r.threadJid,a],l,s,u))}),o("MAWDexieTable").dexieAll(n).then(function(){t.pendingReceipts.delete(a)})})}else return o("MAWDexieTable").dexieAll([o("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(t,r.threadJid,r.msgId,o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(r)))]).then(function(){return t.pendingReceipts.delete(a)})})}l.processPendingReceipts=s}),98);
__d("MAWUpdateIsCollapsedMsgTxns",["MAWBridgeMsg","MAWDexieTable","MAWIndexedDb","MWXMAV2IsDataclassLiveLocationXMA"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){var a=t.collapsibleId;return a==null?o("MAWDexieTable").dexieResolve(t):e.messages.where(["threadJid","collapsibleId","sortOrderMs"]).between([r,a,Number.MIN_SAFE_INTEGER],[r,a,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first().then(function(r){if(r!=null)if(t.serverTs!=null&&t.serverTs>r.serverTs){var a=babelHelpers.extends({},r,{isCollapsed:!0});return e.messages.put(a).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(a)})}).then(function(){return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},t,{isCollapsed:!1}))})}else return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},t,{isCollapsed:!0}));else return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},t,{isCollapsed:o("MWXMAV2IsDataclassLiveLocationXMA").isExpiredLiveLocationStarted(n,t.serverTs)}))})}l.maybeUpdatePreviousCollapsibleMsgs=e}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAMsgType","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=t.args,a=t.externalId,i=n.editMsgContent,l=n.originalProtocolMsgId,u=l.chat,c=l.externalId;return o("MAWDexieTable").dexieAll([e.threads.get({jid:u}),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,l)]).then(function(n){var l=n[0],d=n[1];if(l==null)return o("WAResultOrError").makeError("missing_thread");if(d==null)return o("WAResultOrError").makeError("missing_msg");if(d.type!==o("WAMsgType").MSG_TYPE.TEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",d.type);return o("MAWDexieTable").dexieAll([e.messages.where("quoteExternalId").equals(c).toArray(),e.editMsgHistory.where("originalMsgExternalId").equals(c).toArray()]).then(function(n){var l=n[0],m=n[1],p=m.find(function(e){return e.author===o("WAJids").AUTHOR_ME&&e.threadJid===u&&e.editExternalId===a});if((p==null?void 0:p.sendStatus)!=null&&p.sendStatus>o("MAWAckLevel").ACK.clock)return o("WAResultOrError").makeError("already_sent");var _=[];_.push(s(t,u,c));var f=m.find(function(e){return e.author===o("WAJids").AUTHOR_ME&&e.threadJid===u&&e.editExternalId===c});return f==null&&(d.editCount==null||d.editCount===0)&&_.push(s(d,u,c)),o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,_).then(function(){var t,n=babelHelpers.extends({},d,{ack:o("MAWAckLevel").ACK.clock,editCount:((t=d.editCount)!=null?t:0)+1,msgContent:i}),s=[],m=o("MAWUserJidWrapper").getMyUserJid();return l.filter(function(e){var t,n;return(((t=e.quote)==null?void 0:t.content.author)===o("WAJids").AUTHOR_ME||((n=e.quote)==null?void 0:n.content.author)===m)&&e.threadJid===u}).forEach(function(e){if(e!=null){var t=e.quote,o=e.quoteExternalId;if(t==null)r("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",o);else{var a=babelHelpers.extends({},e,{quote:babelHelpers.extends({},t,{content:babelHelpers.extends({},t.content,{msgContent:babelHelpers.extends({},n.msgContent)})})});s.push(a)}}}),e.messages.bulkPut([n].concat(s)).then(function(){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,d)}).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(n,e)})}).then(function(){return s.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})}),o("WAResultOrError").makeResult({originalMsgExternalId:c,originalMsgId:d.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:u,externalId:a}})})})})})}function s(e,t,n){var r,a,i;return{author:o("WAJids").AUTHOR_ME,editExternalId:e.externalId,editTs:(r=e.serverTs)!=null?r:e.ts,msgContent:(a=(i=e.args)==null?void 0:i.editMsgContent)!=null?a:o("MAWUnsafeCoerce").unsafeCoerce(e.msgContent),originalMsgExternalId:n,sendStatus:o("MAWAckLevel").ACK.clock,specialTextSize:e.specialTextSize,threadJid:t}}function u(e,t,n,r,a,i){if(t.type!==o("WAMsgType").MSG_TYPE.TEXT||!r||r.length===0)return o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t,n,a,i);var l=r.sort(function(e,t){return t.editTs-e.editTs})[0].msgContent,s=r.length;return o("MAWWriteMsgTxns").writeNewIncomingMsg(e,babelHelpers.extends({},t,{editCount:s,msgContent:l}),n,a,i).then(function(n){return(n.type===o("WAMsgType").MSG_TYPE.TEXT?o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,[o("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers.extends({},n,{msgContent:t.msgContent}),n.threadJid)]):o("MAWDexieTable").dexieResolve()).then(function(){return n})})}l.writeEdit=e,l.writeNewIncomingMsgAndEditHistory=u}),98);
__d("WAGroupInviteUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.toInviteCode=e}),66);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","MAWUserJidWrapper","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("MAWDbThreadTxns").getThread(e,n).then(function(n){return n.success?o("MAWDbGroupInviteTxns").maybeGetGroupInvite(e,t.threadJid,t.inviteeJid).then(function(n){return n&&!o("WATimeUtils").isInFuture(n.inviteExpirationTs)?o("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:o("MAWDbGroupInviteTxns").putGroupInvite(e,t)}):o("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP})}function s(e,t,n,r){var a=t.caption,i=t.groupJid,l=t.inviteCode,s=t.inviteExpiration,u=o("WAJids").interpretAsUserJid(n);if(i==null||s==null||l==null||u==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"invalid_args"}));var c=[o("WATimeUtils").castLongIntToUnixTime(s),o("WAJids").toGroupJid(i),o("WAGroupInviteUtils").toInviteCode(l)],d=c[0],m=c[1],p=c[2],_={folder:r,groupJid:m,inviteCode:p,inviteExpireTs:d,inviterJid:u,type:"group_invite"};return o("MAWThreadManagementTxns").getGroupThread(e,m,r,!0).then(function(t){return t==null?o("WAResultOrError").makeError(_):o("MAWDbParticipantTxns").getParticipant(e,t.thread.jid,u)}).then(function(t){if(!t.success)return o("WAResultOrError").makeError(_);var n=o("MAWUserJidWrapper").getMyUserJid(),r=o("MAWDbParticipant").craftParticipantId(t.value.threadJid,n);return o("MAWDbGroupInviteTxns").putGroupInvite(e,{caption:a==null?void 0:a.text,inviteCode:p,invitedParticipantId:r,inviteeJid:n,inviteExpirationTs:d,inviterJid:u,threadJid:t.value.threadJid}).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:o("MAWBridgeTypesCreators").createBridgeGroupInvite(e)}),o("WAResultOrError").makeResult()})})}l.writeGroupInvite=e,l.writeIncomingGroupInviteMsg=s}),98);
__d("MAWWriteGroupPollCreateTxns",["I64","MAWArmadilloPollTableSchema.pb","MAWCurrentUser","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWWriteMsgTxns","WAResultOrError","WATimeUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){var a=n.optionsHashed;if(a==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"invalid_args_poll_option_hashes"}));var i=t.author,l=t.externalId,s=t.ts,d=r.jid;return o("MAWDexieTable").dexieAll([u(e,d,n,i,l),o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t,r)]).then(function(e){var t=e[0],n=e[1];c(t,n.msgId,o("WATimeUtils").castUnixTimeToMillisTime(s))}).then(function(){return o("WAResultOrError").makeResult()})}function u(e,t,n,a,i){var l=n.encKey,s=n.latestSenderTimestampsMs,u=n.name,c=n.optionsHashed,d=n.selectableOptionsCount;return o("MAWDbParticipantTxns").getParticipantsInThread(e,t).then(function(n){var m={chatJid:t,encKey:l,latestSenderTimestampsMs:s,pollAuthor:a,pollOptions:r("nullthrows")(c),pollParticipantCount:n.length,pollStanzaId:i,pollState:o("MAWArmadilloPollTableSchema.pb").POLL_STATE.OPEN,selectableOptionsCount:d,title:u};return e.poll.put(m).then(function(){return m})})}function c(t,n,r){o("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(e||(e=o("I64"))).of_string(o("MAWCurrentUser").getID()),dbPoll:t,latestUpdateMsgId:n,latestUpdateTimestampMs:r}})}l.handleIncomingGroupPollCreate=s,l.savePollToDb=u,l.sendPollToUI=c}),98);
__d("MAWDbPollTxns",["MAWIndexedDb","MAWTransactionMode","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({poll:o("MAWTransactionMode").READONLY},"handleIncomingMessagesStanzas",function(e){return function(t,n){return e.poll.get([t,o("WAStanzaUtils").toStanzaId(n)])}});function s(e,t){return e.poll.put(t).then(function(){return t})}function u(e,t,n){return e.poll.get([t,o("WAStanzaUtils").toStanzaId(n)])}function c(e,t,n){return e.messages.where(["threadJid","pollStanzaId","sortOrderMs"]).between([n,t,Number.MIN_SAFE_INTEGER],[n,t,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first()}l.getDbPoll=e,l.updatePoll=s,l.getPoll=u,l.maybeGetLatestPollUpdateMsg=c}),98);
__d("MAWDbPollUtils",["FBLogger","MAWLocalizationType","WAJids","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,o){var a=e.pollAuthor,i=new Map(e.pollOptions.entries().map(function(e){var n=e[0],o=e[1];return o.optionText==null||!o.voteAuthors.has(t)?null:[n.toString(),r("nullthrows")(o.optionText)]}).filter(Boolean)),l=new Map(o.map(function(e){return[e.hashedOptionName,e.optionName]})),s=o.filter(function(e){return!i.has(e.hashedOptionName)}).map(function(e){return e.optionName}),d=Array.from(i.entries().map(function(e){var t=e[0],n=e[1];return l.has(t)?null:n}).filter(Boolean));if(n.length>0)return s.length>0||d.length>0?u(e,a):c(e,t,n);if(s.length>0)return d.length===0?p(e,t,s):s.length===d.length?g(e,t,s):u(e,a);if(d.length>0)return C(e,t,d);throw r("FBLogger")("messenger_web").mustfixThrow("Not a valid update for poll")}function s(e){if(e===o("WAJids").AUTHOR_SYSTEM||e===o("WAJids").AUTHOR_ME)throw r("FBLogger")("messenger_web").mustfixThrow("Not a valid author for poll vote");return o("WAJids").userIdFromJid(e)}function u(e,t){var n=t===o("WAJids").AUTHOR_ME;return n?{adminMsgContent:[e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,version:1}:{adminMsgContent:[s(t),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,version:1}}function c(e,t,n){return n.length===1?d(e,t,n[0]):m(e,t,n[0],n.length)}function d(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,version:1}}function m(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,version:1}}function p(e,t,n){return n.length===1?_(e,t,n[0]):f(e,t,n[0],n.length)}function _(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,version:1}}function f(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,version:1}}function g(e,t,n){return n.length===1?h(e,t,n[0]):y(e,t,n[0],n.length)}function h(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,version:1}}function y(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,version:1}}function C(e,t,n){return n.length===1?b(e,t,n[0]):v(e,t,n[0],n.length)}function b(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,version:1}}function v(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,version:1}}l.getAdminMessageForUpdate=e}),98);
__d("MAWWriteGroupPollMessageTxns",["FBLogger","I64","MAWCurrentUser","MAWDbPoll","MAWDbPollTxns","MAWDbPollUtils","MAWDexieTable","MAWGroupPollsDualEncryptionUtils","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","WALongInt","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r,a){var i,l=r.decrypted,s=r.encryptedMessage,d=n.author,m=(i=s.pollCreationMessageKey)==null?void 0:i.id;return m==null||d==null||l==null?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"invalid_args_poll_update_message"})):o("MAWDbPollTxns").getPoll(t,a.jid,m).then(function(r){if(r==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"missing_poll_for_update"}));var i=u(r,l),s=i.optionsToAdd,p=i.selectedOptions,_=o("MAWDbPollUtils").getAdminMessageForUpdate(r,d,s,p),f=o("WAStanzaUtils").toStanzaId(m),g=babelHelpers.extends({},n,{msgContent:_,pollStanzaId:f,type:o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE});return o("MAWDexieTable").dexieAll([c(t,r,d,l),o("MAWWriteMsgTxns").writeNewIncomingMsg(t,g,a)]).then(function(n){var r=n[0],i=n[1];return o("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(t,f,a.jid).then(function(t){var n,a;return o("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(e||(e=o("I64"))).of_string(o("MAWCurrentUser").getID()),dbPoll:r,latestUpdateMsgId:(n=t==null?void 0:t.msgId)!=null?n:i.msgId,latestUpdateTimestampMs:o("WATimeUtils").castUnixTimeToMillisTime((a=t==null?void 0:t.ts)!=null?a:i.ts)}}),o("WAResultOrError").makeResult()})})})}function u(e,t){var n,r=t.optionsToAdd,a=t.vote,i=e.pollOptions,l=((n=a==null?void 0:a.selectedOptions)!=null?n:[]).map(function(e){var t,n=o("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(e),r=(t=i.get(n))==null?void 0:t.optionText;return r==null?null:{hashedOptionName:o("MAWDbPoll").convertOptionHashToString(n),optionName:r}}).filter(Boolean);return{optionsToAdd:(r!=null?r:[]).map(function(e){return e.optionName}),selectedOptions:l}}function c(e,t,n,a){var i,l,s=a.optionsToAdd,u=a.vote,c=t.pollOptions,p=s;d(p,c);var _=o("WALongInt").maybeNumber((i=u==null?void 0:u.senderTimestampMs)!=null?i:0);if(_!=null&&_>((l=t.latestSenderTimestampsMs.get(n))!=null?l:0)){t.latestSenderTimestampsMs.set(n,o("WATimeUtils").castToMillisTime(_));var f=u;m(f,c,n)}else _===0?r("FBLogger")("GroupPollsE2EE").warn("Poll vote message doesn't have a timestamp"):_==null?r("FBLogger")("GroupPollsE2EE").warn("Poll vote message timestamp is not a valid number"):_===0?r("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message doesn't have a timestamp"):_==null?r("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message timestamp is not a valid number"):r("FBLogger")("GroupPollsE2EE").info("Dropping poll vote message since we already have a newer vote message from this author %s",n);var g=babelHelpers.extends({},t,{pollOptions:c});return o("MAWDbPollTxns").updatePoll(e,g).then(function(){return t})}function d(e,t){e==null||e.forEach(function(e){var n=e.hashedOptionName,r={optionText:e.optionName,voteAuthors:new Set},o=t.get(n);o==null?t.set(n,r):o.optionText===void 0&&t.set(n,{optionText:e.optionName,voteAuthors:o.voteAuthors})})}function m(e,t,n){t.values().forEach(function(e){e.voteAuthors.delete(n)}),e==null||e.selectedOptions.forEach(function(e){var r,a=o("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(e);if(!t.has(a)){var i={optionText:void 0,voteAuthors:new Set};t.set(a,i)}(r=t.get(a))==null||r.voteAuthors.add(n)})}l.handleGroupPollUpdate=s,l.writeIncomingGroupPollUpdateMsg=c}),98);
__d("MAWDbReceiverFetchTxns",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.receiverFetchInfo.get({receiverFetchId:t})}i.maybeGetReceiverFetchInfoFromReceiverFetchId=e}),66);
__d("MAWWriteReceiverFetchTxns",["FBLogger","MAWBridgeReceiverFetchInfo","MAWDbReceiverFetchTxns","MAWDexieTable","MAWIndexedDb","WALogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a,i,l){return o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(e,l.receiverFetchId).then(function(s){if(s==null)return e.receiverFetchInfo.add(l).then(function(){o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromUnstoredInfo(t,n,a,i,l)})}).catch(function(e){r("FBLogger")("messenger_web_media").mustfix("Failed to add receiver fetch info to db, error: %s",e.message)});var u=babelHelpers.extends({},s,l);return e.receiverFetchInfo.update(l.receiverFetchId,u).then(function(){o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(t,n,a,i,u)})}).catch(function(e){r("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",e.message)})})}function u(t,n,a,i,l,s,u,c,d){return o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(t,i).then(function(m){var p=m;if(p==null){if(d==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Receiver fetch info not found for receiver fetch id: ",""])),i),o("MAWDexieTable").dexieResolve();p={mimetype:s,previewHeight:u,previewWidth:c,receiverFetchId:i,type:d}}var _=babelHelpers.extends({},p,{accessibilitySummaryText:l!=null?l:void 0,previewUrl:n,previewUrlExpirationTimestampMs:a});return t.receiverFetchInfo.put(_).then(r("emptyFunction")).catch(function(e){r("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",e.message)})})}l.handleUnstoredReceiverFetchInfo=s,l.updateReceiverFetchInfoWithPreviewUrl=u}),98);
__d("MAWExpiredXMACleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.XMA))}function d(t){if(u==null){var n="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startExpiredXMACleaner=c,l.addNewExpiredXMACleanerTimestamp=d,l.getExpiredXMACleaner_FOR_TESTING_ONLY=m,l.resetExpiredXMACleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWXMAManagementTxns",["FBLogger","MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i){var l=t.unstoredDbXMA,u=t.unstoredFavicon,c=t.unstoredHeaderMedia,d=t.unstoredPreviews;a===void 0&&(a=!1),i===void 0&&(i="wa-incoming");var m=new Map,p=function(r){return r!=null?o("MAWMediaManagementTxns").handleUnstoredDbMedia(e,r,n,i,!0).then(function(e){return[r.plaintextHash,e]}):o("MAWDexieTable").dexieResolve([void 0,void 0])};a||(m.set(u==null?void 0:u.plaintextHash,p(u)).set(c==null?void 0:c.plaintextHash,p(c)),d==null||d.forEach(function(e){m.set(e==null?void 0:e.plaintextHash,p(e))}));var _=Array.from(m.values());return o("MAWDexieTable").dexieAll(_).then(function(t){var i=new Map(t),m=(d!=null?d:[]).map(function(e){return i.get(e.plaintextHash)}).filter(Boolean);return s(e,a?o("MAWXMAUtils").buildUnstoredTombstonedXMA(l):l,i.get(u==null?void 0:u.plaintextHash),i.get(c==null?void 0:c.plaintextHash),m,n,r).then(function(e){return{dbMedias:t.map(function(e){var t=e[0],n=e[1];return n}).filter(Boolean),dbXMA:e,firstPreview:m[0]}})})}function s(e,t,n,o,a,i,l){var s,u,c=babelHelpers.extends({},t,{associatedMessageId:l!=null?l:void 0,defaultPreviewMediaId:(s=a[0])==null?void 0:s.mediaId,defaultPreviewMediaPlaintextHash:(u=a[0])==null?void 0:u.plaintextHash,faviconMediaId:n==null?void 0:n.mediaId,faviconPlaintextHash:n==null?void 0:n.plaintextHash,headerMediaId:o==null?void 0:o.mediaId,headerMediaPlaintextHash:o==null?void 0:o.plaintextHash,msgId:i.msgId,previewMediaIds:a.map(function(e){return e.mediaId})});return e.xma.add(c).then(function(t){return e.xma.get(t)}).then(function(e){if(e==null)throw r("FBLogger")("messenger_web").mustfixThrow("Failed to write XMA to db");return e})}function u(e,t,n,r,a,i,l,s,u,c,d,m,p){var _=o("MAWXMAUtils").isXMAExpired(!1,u.targetExpiringAtSec),f=babelHelpers.extends({},u,{associatedMessageId:l!=null?l:void 0,author:s.author,externalId:s.externalId,isTombstoned:_,msgId:i,offlineAttachmentId:c,targetType:a,threadJid:s.chat}),g=_?f:babelHelpers.extends({},f,{defaultPreviewMediaId:t!=null?t:void 0,defaultPreviewMediaPlaintextHash:d!=null?d:void 0,faviconMediaId:r!=null?r:void 0,faviconPlaintextHash:p!=null?p:void 0,headerMediaId:n!=null?n:void 0,headerMediaPlaintextHash:m!=null?m:void 0,previewMediaIds:t!=null?[t]:[]});return e.xma.add(g).then(function(e){return babelHelpers.extends({},g,{xmaId:e})})}l.handleUnstoredXMAContent=e,l.saveXMA=u}),98);
__d("MAWWriteXMAMessageTxns",["FBLogger","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","MWPBumpEntityKey","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS,s=new Set([o("MAWMsgType").MSG_TYPE.TEXT,o("MAWMsgType").MSG_TYPE.GIF,o("MAWMsgType").MSG_TYPE.STICKER]);function u(e,t,n,r){var a=n.unstoredAssociatedMedia,i=n.unstoredAssociatedMsg,l=n.unstoredDbXMA;return o("MAWDbXMATxns").maybeGetAssociatedXMAMsg(e,i,r.jid).then(function(n){var s=t;if(n!=null&&n.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT){var u=n.serverTs,c=n.sortOrderMs,d=n.ts;s=babelHelpers.extends({},t,{serverTs:u,sortOrderMs:c!=null?c-1:c,ts:d})}var m=[l.targetExpiringAtSec,l.targetType],p=m[0],_=m[1];o("MAWXMAUtils").isXMAStoryReaction(_)&&(i==null?void 0:i.msgContent)!=null&&(s=babelHelpers.extends({},t,{msgContent:i.msgContent}));var f=o("MAWXMAUtils").isXMAExpired(l.isTombstoned,p);s.isExpiredXmaMsg=f;var g=!o("MAWXMAUtils").isXMAStoryReaction(_)&&i!=null?o("MAWWriteMsgTxns").prepareMsgWriteData(e,i,r):o("MAWDexieTable").dexieResolve(null);return o("MAWDexieTable").dexieAll([o("MAWWriteMsgTxns").prepareMsgWriteData(e,s,r),g]).then(function(e){var t=e[0],n=e[1];return{associatedData:n,associatedMedia:a,associatedMsg:i,xmaData:t,xmaMsg:s}})})}function c(e,t,n,r,a){var i=n.unstoredDbXMA,l=[i.targetExpiringAtSec,i.targetType],s=l[0],u=l[1];return t==null||t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null}):(t.isExpiredXmaMsg!==!0&&s!=null&&o("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(s),o("MAWXMAUtils").isXMAStoryReaction(u)&&o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t)}),o("MAWXMAManagementTxns").handleUnstoredXMAContent(e,babelHelpers.extends({},n,{unstoredDbXMA:i}),t,a,t.isExpiredXmaMsg===!0,r).then(function(n){var r=n.dbMedias,a=n.dbXMA,i=n.firstPreview,l=o("MAWDexieTable").dexieResolve();return a!=null&&!o("MAWXMAUtils").isXMAStoryReply(a.targetType)&&t.isExpiredXmaMsg!==!0&&(l=o("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,a,i)),l.then(function(){return{dbMedias:r,dbXMA:a}})}))}function d(e,t,n,a,i,l,u,c){var d,m,p,_,f,g;if(!s.has(i.type))throw r("FBLogger")("messenger_web").mustfixThrow("flow check, this message type is not supported for XMA replies: "+i.type);var h=t.author;if(h==="@system")throw r("FBLogger")("messenger_web").mustfixThrow("wrong author of story reply");var y=o("WAJids").interpretAsUserJid(a);if(y==null)throw r("FBLogger")("messenger_web").mustfixThrow("this is a flow check, participant jid can not be null");var C=(d=c==null||(m=c[0])==null?void 0:m.plaintextHash)!=null?d:i.plaintextHash;(l||n==null?void 0:n.defaultPreviewMediaId)!=null&&C==null&&o("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","write_xma_message_txns_handle_xma_reply_msg");var b={author:h===o("WAJids").AUTHOR_ME?y:o("WAJids").AUTHOR_ME,expirationTs:n.targetExpiringAtSec,externalId:n.externalId,mediaId:l||n==null?void 0:n.defaultPreviewMediaId,plaintextHash:l?void 0:C,sourceId:(p=(_=n.defaultCTA)==null?void 0:_.nativeUrl)!=null?p:(f=n.defaultCTA)==null?void 0:f.actionUrl,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:n.targetType},v=babelHelpers.extends({},i,{mediaId:(g=u==null?void 0:u.mediaId)!=null?g:i.mediaId,quote:{content:b,remoteJid:a}});return e.messages.put(v).then(function(){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:l?o("MAWBridgeMsg").createBridgeMsg(v):o("MAWBridgeMsg").createBridgeMsg(v,{replyPlaintextHash:C})})})}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.XMA_REPLY_MSG_SUPPORTED_TYPES=s,l.prepareXMAWriteData=u,l.handleIncomingXMA=c,l.handleXMAReplyMsg=d}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWPendingReceiptProcessingTxns","MAWUpdateIsCollapsedMsgTxns","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteGroupPollCreateTxns","MAWWriteGroupPollMessageTxns","MAWWriteMsgTxns","MAWWriteReceiverFetchTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","MWXMAV2IsCollapsibleXMA","MWXMAV2XmaDataClass","WAGetPlatformFromStanzaId","WAJids","WAOdsEnums","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult(void 0));function d(e,t,n){var a,i;t.receiveFlow.addPoint("him_write_message_start");var l=((a=t==null||(i=t.msg)==null||(i=i.ephemeralSetting)==null?void 0:i.ephemeralExpirationInSec)!=null?a:0)>0;return m(e,t,n).then(function(e){var n,a,i,s;if(t.receiveFlow.addPoint("him_write_message_end",{bool:{isEphemeralMsg:l,outOfSync:(e==null||(n=e.value)==null?void 0:n.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(a=e==null||(i=e.value)==null?void 0:i.msgType)!=null?a:"unknown"}}),l&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"ephemeralMsgs"}),(t.action===o("MAWMsgActionType").MSG_ACTION.WRITE||o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED)&&(e==null||(s=e.value)==null?void 0:s.msgType)==null){var u,c;r("MAWHIMLogger").warn("write action didn't produce result in DB. msg type: "+((u=t==null||(c=t.msg)==null?void 0:c.type)!=null?u:"unknown"))}return e}).catch(function(e){var n;if(e.name==="ConstraintError")return t.type!==o("MAWMsgType").MSG_TYPE.XMA&&r("MAWHIMLogger").mustfix("encounted a ConstraintError for type %s",t.type),o("WAResultOrError").makeError({type:"constraint_error"});throw e.message="[handleIncomingMsg] ["+((n=t.type)!=null?n:"")+"/"+t.action+"] "+e.message,e})}function m(t,n,a){var i;if(n.action===o("MAWMsgActionType").MSG_ACTION.NO_ACTION)return c;var l=function(r,a,i){return o("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(t,r,a,n.thread,i)};switch(n.type){case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:return o("MAWWriteMsgTxns").writeNewIncomingMsg(t,n.msg,n.thread,a,n.stanzaSource).then(function(){return o("WAResultOrError").makeResult(null)});case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return o("MAWDbRavenActionTxns").writeRavenActionMsg(t,n.msg,n.thread).then(function(){return o("WAResultOrError").makeResult(null)});case o("MAWMsgType").MSG_TYPE.REACTION:return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({reactToExternalId:n.msg.reactToExternalId}));case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("WAJids").isAuthorMe(n.id.author)?c:o("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(t,n.msg,n.thread.jid,n.folder);case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case o("MAWMsgType").MSG_TYPE.ADMIN:return n.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME?o("MAWWriteMsgTxns").handleDeleteForMeMessage(t,n.msg,n.thread,n.pendingDeleteForMeStanza).then(function(e){return _(e)}):y(t,n.msg,n.thread.jid).then(function(e){if(e)return c;var r=n.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?o("MAWWriteMsgTxns").writeCiphertextUpdate(t,n.msg,n.existingMsg,n.thread,n.existingEditMsgHistory,n.stanzaSource):n.action===o("MAWMsgActionType").MSG_ACTION.REVOKE?o("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(t,n.msg,n.thread,n.pendingRevokedStanza,n.pendingRevokedStanza!=null):o("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(t,n.msg,n.thread,n.editMsgHistories,a,n.stanzaSource),i=function(r,a){return o("MAWDexieTable").dexieAll([f(t,n.id,r,r.type!==o("MAWMsgType").MSG_TYPE.FUTUREPROOF),l(r,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(e){var t=e[0],n=e[1];return _(r,n,a==null?null:[a])}).then(function(e){var a={author:r.author,chat:r.threadJid,externalId:r.externalId};return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,a).then(function(e){if(e!=null)return o("MAWUpdateQuotedMsgTxns").associateAllReplies(t,e,n.thread.jid)}).then(function(){return e})})};if(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()){var s=n.thread.jid,u=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(s,n.msg.externalId),d=n.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?o("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(t,s,u,n.msg.sortOrderMs,n.msg.ts,n.receiverFetchInfo):o("MAWDexieTable").dexieResolve(),m=n.media!=null?o("MAWMediaManagementTxns").handleUnstoredDbMediaCreation(t,n.media,u,n.msg.type,void 0):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([r,d,m]).then(function(e){var r=e[0],i=e[1],l=e[2];return o("MAWDexieTable").dexieAll([r,l!=null&&n.media!=null?o("MAWMediaManagementTxns").handleUnstoredDbMediaLinking(t,n.media,r,l,void 0,void 0,a):o("MAWDexieTable").dexieResolve()])}).then(function(e){var t=e[0],r=e[1];return t.quote!=null&&n.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:t.quote.content.type}}),i(t,r)})}return r.then(function(e){var r=n.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?o("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(t,e.threadJid,e.msgId,e.sortOrderMs,e.ts,n.receiverFetchInfo):o("MAWDexieTable").dexieResolve(),l=n.media!=null?o("MAWMediaManagementTxns").handleUnstoredDbMedia(t,n.media,e,n.stanzaSource,void 0,void 0,void 0,a):o("MAWDexieTable").dexieResolve();return e.quote!=null&&n.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:e.quote.content.type}}),o("MAWDexieTable").dexieAll([r,l]).then(function(t){var n=t[0],r=t[1];return i(e,r)})})});case o("MAWMsgType").MSG_TYPE.REVOKED:return o("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(t,n.msg,n.thread,n.originalMsg,n.previousRevokeMsg,n.ebTimestampMs).then(function(e){return o("MAWDexieTable").dexieAll([f(t,n.id,e),l(e,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(t){var n=t[0],r=t[1];return _(e,r)})});case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(t,o("MAWJidUtils").getAuthorJid(n.id.author),n.msg.ephemeralExpirationInSec,n.msg.ephemeralLastUpdatedOrSetTimestamp,n.msg.isEphemeralSettingReset,n.thread,n.ts,n.id.externalId,!0).then(function(e){return _(null,e==null?void 0:e.outOfSyncEphemeralSetting)});case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(t,o("MAWJidUtils").getAuthorJid(n.id.author),n.thread,n.ts,n.screenshotActionType,n.id.externalId,n.existingMsg).then(function(e){return o("MAWDexieTable").dexieAll([f(t,n.id,e),l(e,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(t){var n=t[0],r=t[1];return _(e,r)})});case o("MAWMsgType").MSG_TYPE.XMA:{var s;if(n.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return o("MAWWriteMsgTxns").handleDeleteForMeMessage(t,n.msg,n.thread,n.pendingDeleteForMeStanza).then(function(e){return _(e)});var u=o("MWXMAV2XmaDataClass").parseXmaDataClass((s=n.xma)==null?void 0:s.unstoredDbXMA.xmaDataclass),d=n.xma!=null&&o("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(u)?o("MAWUpdateIsCollapsedMsgTxns").maybeUpdatePreviousCollapsibleMsgs(t,n.msg,u,n.thread.jid):o("MAWDexieTable").dexieResolve(n.msg),m=n.action===o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||n.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?g(t,n,a):n.action===o("MAWMsgActionType").MSG_ACTION.REVOKE?p(t,n,a):d.then(function(e){return p(t,babelHelpers.extends({},n,{msg:e}),a).then(function(e){return o("MAWWriteXMAMessageTxns").handleIncomingXMA(t,e,n.xma,n.stanzaSource,null).then(function(t){return babelHelpers.extends({},t,{dbMsg:e})})})});return m.then(function(a){var i=a.dbAssociatedMsg,s=a.dbMedias,u=a.dbMsg;return r("MAWHIMLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming xma, has associated data = ",""])),n.action===o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||n.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED),o("MAWDexieTable").dexieAll([f(t,n.id,u,!0,i),l(u,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(e){var r=e[0],a=e[1];return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n.id).then(function(e){if(e!=null)return o("MAWUpdateQuotedMsgTxns").associateAllReplies(t,e,n.thread.jid)}).then(function(){return a})}).then(function(e){return _(u,e,s)})})}case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:return o("MAWWriteGroupPollCreateTxns").handleIncomingGroupPollCreate(t,n.msg,n.pollInfo,n.thread);case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return o("MAWWriteGroupPollMessageTxns").handleGroupPollUpdate(t,n.msg,n.pollInfo,n.thread);default:throw r("MAWHIMLogger").mustfixThrow("We do not support handleIncomingMsgInternal with type: "+((i=n.type)!=null?i:""))}}function p(e,t,n){return t.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||t.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?o("MAWWriteMsgTxns").writeCiphertextUpdate(e,t.msg,t.existingMsg,t.thread,null,t.stanzaSource):t.action===o("MAWMsgActionType").MSG_ACTION.REVOKE?o("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(e,t.msg,t.thread,t.pendingRevokedStanza,t.pendingRevokedStanza!=null):o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t.msg,t.thread,n,t.stanzaSource)}function _(e,t,n){return o("WAResultOrError").makeResult({msgType:e==null?void 0:e.type,outOfSyncEphemeralSetting:t!=null?t:void 0,plaintextHashs:n==null?void 0:n.map(function(e){return e.plaintextHash})})}function f(e,t,n,a,i){var l=t.author,u=t.chat;if(a===void 0&&(a=!1),n==null||n==null)return o("MAWDexieTable").dexieResolve();var c=o("MAWPendingReceiptProcessingTxns").processPendingReceipts(e,u,n),d=l===o("WAJids").AUTHOR_ME&&i!=null&&i.type!==o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWPendingReceiptProcessingTxns").processPendingReceipts(e,u,i):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([c,d]).then(function(){r("MAWHIMLogger").DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"])))})}function g(e,t,n){n===void 0&&(n=!0),t.associatedMsg.externalId===t.msg.externalId&&r("MAWHIMLogger").tags(["XMA"]).mustfix("associatedMsg and msg have the same externalId, platform %s",o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(t.msg.externalId));var a=t.existingAssociatedMsg,i;return a!=null?a.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?i=o("MAWWriteMsgTxns").writeCiphertextUpdate(e,t.associatedMsg,a,t.thread,null,t.stanzaSource):i=o("MAWDexieTable").dexieResolve(a):i=o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t.associatedMsg,t.thread,n,t.stanzaSource),i.then(function(r){return r.type===o("MAWMsgType").MSG_TYPE.REVOKED?o("MAWDexieTable").dexieResolve({dbAssociatedMsg:null,dbMedias:null,dbMsg:null}):p(e,t,n).then(function(n){return t.associatedMedia!=null?o("MAWMediaManagementTxns").handleUnstoredDbMedia(e,t.associatedMedia,r,t.stanzaSource).then(function(o){return h(e,n,r,t.xma,t.msg,t.associatedMsg,t.thread.jid,t.stanzaSource,o)}):h(e,n,r,t.xma,t.msg,t.associatedMsg,t.thread.jid,t.stanzaSource)})})}function h(e,t,n,a,i,l,s,c,d){return o("MAWWriteXMAMessageTxns").handleIncomingXMA(e,t,a,c,n.msgId).then(function(a){var c=a.dbMedias,m=a.dbXMA;return n==null&&r("MAWHIMLogger").MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""])),l.externalId),(n!=null&&m!=null&&o("MAWXMAUtils").isXMAStoryReply(m.targetType)?o("MAWWriteXMAMessageTxns").handleXMAReplyMsg(e,i,m,s,n,i.isExpiredXmaMsg===!0,d,c):o("MAWDexieTable").dexieResolve()).then(function(){return d!=null?{dbAssociatedMsg:n,dbMedias:c!=null?[].concat(c,[d]):[d],dbMsg:t}:{dbAssociatedMsg:n,dbMedias:c,dbMsg:t}})})}function y(e,t,n){var r,a;if(t.type!==o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return o("MAWDexieTable").dexieResolve(!1);var i=(r=t.quote)==null||(r=r.content)==null?void 0:r.externalId,l=(a=t.quote)==null?void 0:a.content.author;if(i==null||l==null)return o("MAWDexieTable").dexieResolve(!1);var s=o("MAWJidUtils").maybeToProtocolMsgId(l,n,i);return o("MAWDexieTable").dexieAll([e.deletedMessages.get(babelHelpers.extends({},s)),e.unrenderedMessages.get({externalId:i}),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,i,l,n),o("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(e,i,l,n)]).then(function(e){var t=e[0],r=e[1],o=e[2],a=e[3],i=r!=null&&r.author===l&&r.threadJid===n;return t!=null||i||o!=null||a!=null})}l.handleIncomingMsg=d,l.processReceipts=f}),98);
__d("MAWLinkReactionsToMsgsTxns",["MAWDbMsgTxns","WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.reduce(function(e,t){var n,r={author:t.reactToAuthor,chat:t.threadJid,externalId:t.reactToExternalId},o=(n=e.get(r))!=null?n:[];return o.push(t),e.set(r,o)},new(o("WAMsgMap")).MsgMap)}function s(t,n){return t.reactions.where("reactToExternalId").anyOf(n).toArray().then(function(t){return e(t.filter(function(e){return e.reactToMsgId==null}))})}function u(e,t){return s(e,t).then(function(t){return o("MAWDbMsgTxns").getMsgsByProtocolMsgId(e,t.keys()).then(function(e){return e.flatMap(function(e){var n,r={author:e.author,chat:e.threadJid,externalId:e.externalId},o=(n=t.get(r))!=null?n:[];return o.map(function(t){return t.reactToMsgId=e.msgId,t})})})})}function c(e,t){return e.reactions.bulkPut(t).then(function(){})}l.getReactionLinkUpdatesForExternalIds=u,l.updateReactionLinks=c}),98);
__d("MAWOfflineThreadTxns",["I64","MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWThreadMappingQPL","MAWUserJidWrapper","MAWWriteBulkWriteIncomingAdminMsgTxns","MWFBLogger","WAArrayZip","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new Set;function c(t,n,r){var a=[],i=new Set(n),l=new Map,s=new Map;return r.forEach(function(e){s.set(e.jid,"exists"),l.set(e.jid,e),i.delete(e.jid),a.push(e)}),i.forEach(function(t){u.has(t)&&o("MWFBLogger").MWLogger().tags(["occamadillo","incoming_processing"]).DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""])),t)}),f(t,i).then(function(e){return e.oneToOneThreadsCreationData.forEach(function(e){u.add(e.thread.jid)}),e.groupThreadsCreationData.forEach(function(e,t){u.add(t),e.groupInfo==null&&s.set(t,"missing")}),t.threads.bulkAdd(g(e),{allKeys:!0}).then(function(){return o("MAWDbThreadTxns").getThreads(t,Array.from(i.values())).then(function(e){e.forEach(function(e){return l.set(e.jid,e)}),a.push.apply(a,e),p(a);var n=h(e);return o("MAWDexieTable").dexieAll([d(t,n),o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(t,e)])}).then(function(){return{threadCreationResult:s,threads:l}})})})}function d(e,t){return o("MAWDexieTable").dexieAll([m(e,t),o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(Array.from(t.values()).map(function(e){return e.jid}))])}function m(e,t){var n=[],a=o("MAWUserJidWrapper").getMyUserJid();return t.forEach(function(e,t){n.push({chatJid:t,type:"participant",userJid:t}),a!==t&&n.push({chatJid:t,type:"participant",userJid:a})}),o("MAWDbParticipantTxns").bulkAddParticipantsInThreads(e,n).then(r("emptyFunction"))}function p(e){e.forEach(function(e){var t=o("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(e.jid);o("MAWThreadMappingQPL").startInWorker({instanceKey:t,jid:e.jid,threadKey:e.optimisticThreadKey==null?void 0:(s||(s=o("I64"))).of_string(e.optimisticThreadKey),trigger:"createAllThreadsForOfflineMsgs"}),o("MAWThreadMappingQPL").addPoint("verify_optimistic_maw_thread",t),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(e,e.optimisticThreadKey,e.authoritativeThreadKey,"createAllThreadsForOfflineMsgs",t)})})}function _(e,t){return{folder:null,jid:e,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsgTs:t!=null?o("WATimeUtils").castUnixTimeToMillisTime(t):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:o("MAWDbThread").craftThreadOrder(o("WATimeUtils").millisTime(),e)}}function f(e,t){var n=[],r=[];return t.forEach(function(e){o("WAJids").switchOnMsgrChatJidType(e,{group:function(t){return n.push(t)},user:function(t){return r.push(t)}})}),o("MAWDbGroupInfoTxns").getGroupInfos(e,n).then(function(e){var t=new Map(o("WAArrayZip").zip(n,e)),a=new Map(n.map(function(e){var n=t.get(e);return[e,{groupInfo:n,thread:_(e,n==null?void 0:n.creationTs)}]})),i=new Map(r.map(function(e){return[e,{thread:_(e,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:i}})}function g(e){var t=e.groupThreadsCreationData,n=e.oneToOneThreadsCreationData;return Array.from(t.values()).map(function(e){var t=e.thread;return t}).concat(Array.from(n.values()).map(function(e){var t=e.thread;return t}))}function h(e){var t=new Map;return e.forEach(function(e){o("WAJids").switchOnMsgrChatJidType(e.jid,{group:r("emptyFunction"),user:function(r){return t.set(r,e)}})}),t}l.createAllThreadsForOfflineMsgs=c}),98);
__d("MAWPreprocessMsgs",["LSMEBTaskCreationSource","MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaGalleryEBTaggingUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=r("MAWHIMLogger").tags(["MAWPreprocessMsgs"]);function p(t){var n=[],r=[];return t.forEach(function(t){var o=t.msgData,a=t.unstoredContent;switch(o.type){case"IncomingMsg":{if(a==null){m.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"])));return}var i=a.unstoredDbEditActionMsg,l=a.unstoredDbReaction;if(l!=null){var s={chatJid:o.id.chat,unstoredReaction:l};n.push(s)}i!=null&&r.push({chatJid:o.id.chat,msg:i});break}case"IncomingCiphertextMsg":default:break}}),{editActionMsgs:r,reactionMsgs:n}}function _(e,t,n,r){return t.receiveFlow.addPoint("him_get_preprocessing_data_start"),f(e,t,n,r).then(function(e){var n;return t.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:e.action,type:(n=e.type)!=null?n:""}}),e})}function f(e,t,n,a){var i=t.msgData,l=t.receiveFlow,p=t.stanzaSource,_=t.unstoredContent,f=i.folder,h=i.id,y=i.ts,C={id:h,receiveFlow:l,stanzaSource:p,thread:n,ts:y},b=o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(i.type){case"IncomingMsg":{if(_==null)return b;var v=_.unstoredDbGroupPollCreateInfo,S=_.unstoredDbGroupPollUpdateInfo,R=_.unstoredDbMsg,L=_.unstoredDbRavenActionMsg,E=_.unstoredDbReaction,k=_.unstoredDbReceiverFetchInfo,I=_.unstoredIncomingDbGroupInvite;if(L!=null)return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:L,type:o("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));if(E!=null)return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:E,type:o("MAWMsgType").MSG_TYPE.REACTION}));if(I!=null)return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,folder:f,msg:I,type:o("MAWMsgType").MSG_TYPE.GROUP_INVITE}));if(R==null)return b;if(R.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){var T=i.msg;return T.version==="v3"&&T.type==="ephemeral"?o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:T,type:R.type})):(m.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"]))),b)}else{if(R.type===o("MAWMsgType").MSG_TYPE.TEXT||R.type===o("MAWMsgType").MSG_TYPE.FUTUREPROOF||R.type===o("MAWMsgType").MSG_TYPE.ADMIN)return o("MAWWriteMsgTxns").prepareTextMsgWriteData(e,R,n).then(function(e){var t=e.editMsgHistories,n=e.existingEditMsgHistory,r=e.existingMsg,a=e.isDeletedWithThread,i=e.isDeleteForMeOrRevoked,l=e.pendingDeleteForMeStanza,s=e.pendingRevokedStanza,u=g(r,R,n);return i||a||r!=null&&u!==!0?b:u&&r!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingEditMsgHistory:n,existingMsg:r,msg:R,type:R.type}):l!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:R,pendingDeleteForMeStanza:l,type:R.type}):s!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.REVOKE,msg:R,pendingRevokedStanza:s,type:R.type}):babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,editMsgHistories:t,msg:p==="ebrestore"?babelHelpers.extends({},R,{source:"eb_restore"}):R,type:R.type})});if(R.type===o("MAWMsgType").MSG_TYPE.IMAGE||R.type===o("MAWMsgType").MSG_TYPE.VIDEO||R.type===o("MAWMsgType").MSG_TYPE.PTT||R.type===o("MAWMsgType").MSG_TYPE.GIF||R.type===o("MAWMsgType").MSG_TYPE.STICKER||R.type===o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||R.type===o("MAWMsgType").MSG_TYPE.RAVEN){var D,x;return R.type===o("MAWMsgType").MSG_TYPE.IMAGE&&((D=i.msg.metadata)==null?void 0:D.groupId)!=null&&(R.groupId=i.msg.metadata.groupId,R.groupIndex=i.msg.metadata.groupIndex,R.groupSize=i.msg.metadata.groupSize),R.type===o("MAWMsgType").MSG_TYPE.IMAGE&&(_==null||(x=_.unstoredDbMedia)==null||(x=x.validatedImageInfo)==null?void 0:x.hdType)!=null&&(R.hdType=_==null?void 0:_.unstoredDbMedia.validatedImageInfo.hdType),m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""])),R.externalId),o("MAWMediaManagementTxns").prepareMediaWriteData(e,R,_==null?void 0:_.unstoredDbMedia,n).then(function(e){var t=e.existingMsg,n=e.isDeletedWithThread,i=e.isDeleteForMeOrRevoked,l=e.pendingDeleteForMeStanza,s=e.pendingRevokedStanza,u=e.shouldDropDocument,d=[_==null?void 0:_.unstoredDbMedia,g(t,R)],f=d[0],h=d[1];if(f==null&&m.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""])),R.externalId),p==="ebrestore"&&t!=null&&f!=null&&t.source==="media_restore"&&(!o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()||a!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)){var y=!o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore";return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:t,media:f,msg:babelHelpers.extends({},R,{source:y}),type:R.type})}return u===!0||i||n||f==null||t!=null&&!h?b:h&&t!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:t,media:f,msg:R,type:R.type}):l!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:R,pendingDeleteForMeStanza:l,type:R.type}):s!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.REVOKE,msg:R,pendingRevokedStanza:s,type:R.type}):babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,media:f,msg:p==="ebrestore"?babelHelpers.extends({},R,{source:a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore"}):R,type:R.type})})}else if(R.type===o("MAWMsgType").MSG_TYPE.XMA){var $=_==null?void 0:_.unstoredXMA;return $==null?b:o("MAWWriteXMAMessageTxns").prepareXMAWriteData(e,R,$,n).then(function(e){var t=e.xmaData.existingMsg,n=g(t,R),r=p==="ebrestore"?babelHelpers.extends({},e.xmaMsg,{source:"eb_restore"}):e.xmaMsg;if(e.associatedMsg!=null&&e.associatedData!=null&&!e.associatedData.isDeletedWithThread&&!e.associatedData.isDeleteForMeOrRevoked){var a,i=e.associatedMsg,l=e.associatedData.existingMsg;if(n&&t!=null)return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:i,existingAssociatedMsg:l,existingMsg:t,msg:r,type:R.type,xma:$});if(t!=null&&e.associatedData.existingMsg!=null)return b;if([t,(a=e.associatedData)==null?void 0:a.existingMsg].filter(function(e){return e==null}).length===1){var s,u,c,d,_,f,h,y;m.mustfix("[duplicate msgs] XMA and associated inconsistency: existing message not found for %s, xmaMessageType: %s, authorMe: %s, xma data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s, associated data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s",t==null?"XMA":"Associated",r==null?void 0:r.xmaMessageType,o("WAJids").isAuthorMe(r==null?void 0:r.author),t==null?void 0:t.type,(s=e.xmaData)==null?void 0:s.isDeletedWithThread,(u=e.xmaData)==null?void 0:u.isDeleteForMeOrRevoked,((c=e.xmaData)==null?void 0:c.pendingDeleteForMeStanza)!=null,((d=e.xmaData)==null?void 0:d.pendingRevokedStanza)!=null,l==null?void 0:l.type,(_=e.associatedData)==null?void 0:_.isDeletedWithThread,(f=e.associatedData)==null?void 0:f.isDeleteForMeOrRevoked,((h=e.associatedData)==null?void 0:h.pendingDeleteForMeStanza)!=null,((y=e.associatedData)==null?void 0:y.pendingRevokedStanza)!=null)}return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:e.associatedMedia,associatedMsg:i,existingAssociatedMsg:l,msg:r,type:R.type,xma:$})}if(n&&t!=null)return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:t,msg:r,type:R.type,xma:$});var v=e.xmaData,S=v.isDeletedWithThread,L=v.isDeleteForMeOrRevoked,E=v.pendingDeleteForMeStanza,k=v.pendingRevokedStanza;return S||L||t!=null?b:E!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:e.xmaMsg,pendingDeleteForMeStanza:E,type:R.type}):k!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.REVOKE,msg:e.xmaMsg,pendingRevokedStanza:k,type:R.type}):babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:r,type:R.type,xma:$})})}else{if(R.type===o("MAWMsgType").MSG_TYPE.REVOKED)return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,R.revokedExternalId,n.jid,h.author),o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,R.externalId,n.jid,h.author)]).then(function(e){var t=e[0],n=e[1];return n!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,ebTimestampMs:R.ebTimestampMs,msg:R,originalMsg:t,previousRevokeMsg:n,type:R.type})});if(R.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){var P=o("WAJids").isAuthorMe(h.author)?o("WAGlobals").getMyUserJid():h.author;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,P)]).then(function(e){var t=e[0];return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,existingMsg:t,screenshotActionType:R.msgContent.screenshotActionType,type:R.type})})}else return R.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,h.author).then(function(e){return e!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,type:R.type})}):R.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&k!=null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,h.author).then(function(e){return e!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,receiverFetchInfo:k,type:R.type})}):R.type===o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,h.author).then(function(e){return e!=null||v==null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,pollInfo:v,type:R.type})}):R.type===o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE?S==null||S.decrypted===void 0?b:o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,pollInfo:S,type:R.type})):(m.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""])),R.type),b)}}}case"IncomingCiphertextMsg":{var N;if(!((N=i==null?void 0:i.createPlaceholder)!=null&&N))return b;var M=o("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(h,y);return o("MAWWriteMsgTxns").prepareMsgWriteData(e,M,n).then(function(e){var t=e.existingMsg,n=e.isDeletedWithThread,r=e.isDeleteForMeOrRevoked;return r||n||t!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:M,type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT})})}case"UnavailableMsg":case"FrankingInvalidMsg":{var w=o("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(h,y);return o("MAWWriteMsgTxns").prepareMsgWriteData(e,w,n).then(function(e){var t=e.existingMsg,n=e.isDeletedWithThread,r=e.isDeleteForMeOrRevoked;return r||n||t!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}}function g(e,t,n){return e==null&&n==null||t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(e==null?void 0:e.type)===o("MAWMsgType").MSG_TYPE.CIPHERTEXT||(n==null?void 0:n.msgContent.content)===""}l.classifyIncomingMsgs=p,l.getMessageDataByType=_,l.isCiphertextUpdate=g}),98);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","MWFBLogger","WAOfflineUtils","WAThrottle","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=333.3333333333333,m=o("MWFBLogger").MWLogger().tags(["ProtocolQueue","MAWConsumer"]),p=(function(){function t(){var e=this;this.$1={},this.$2={},this.$3=0,this.$4="wa",this.$5=!1,this.$6=0,this.$7=0,this.$8=0,this.$9=0,this.$10=null,this.$16=o("WAThrottle").throttle(function(){e.$5||e.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},d),this.$12=o("WAThrottle").throttle(function(){e.$4==="wa"&&e.$5===!1&&e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},d)}var n=t.prototype;return n.subscribeToWAEvents=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"offline-start":{e.$10=o("MAWQplProxy").performanceAbsoluteNow(),e.$6=t.offlineStats.count,e.$8=t.offlineStats.message,e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,e.$10),e.$5=!1,e.$4="wa";break}case"offline-processed":break;case"offline-entity":{e.$7++,e.$12();break}case"offline-end":{e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Complete),e.$4="maw";break}case"connection-lost":{e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break}default:}})},n.subscribeToMawEvents=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"maw-infra-start":{e.$10==null&&(e.$10=o("MAWQplProxy").performanceAbsoluteNow()),e.$13();break}case"maw-infra-end":{t.success?e.notifyUICurrentProcessingSucceeded():e.$14(),e.$10=null;break}}})},n.subscribeToMessageEvents=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"new-message":{if(t.commonMessageBase.offline==null)return;e.addWAMessage();break}}})},n.addWAMessage=function(){this.$9++,this.$12()},n.$13=function(){this.$3=0,this.$5=!1,this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)},n.setThreadMetadata=function(n){var t=n.reduce(function(e,t){return e[t.from]=t.t,e},{}),r=n.reduce(function(e,t){var n=t.from;return e[n]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing},e},{});m.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""])),JSON.stringify(t),JSON.stringify(r)),this.$1=t,this.$2=r},n.notifyUIChatReady=function(t){this.$2[t]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},n.updateChatState=function(t){var e=this;Object.entries(t).forEach(function(t){var n=t[0],r=t[1];if(e.$1[n]!=null){var a=e.$1[n];r>=a&&(e.$2[n]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}}),this.$16()},n.addMAWEntity=function(t){this.$3+=t,this.$16()},n.notifyUICurrentProcessingSucceeded=function(){var e=this;Object.keys(this.$2).forEach(function(t){e.$2[t]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}}),this.$5=!0,this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete),this.$1={},this.$2={}},n.$14=function(){var e=this;Object.keys(this.$2).forEach(function(t){e.$2[t]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}}),this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed),this.$1={},this.$2={}},n.maybeNotifyUI=function(){this.$16()},n.$11=function(t,n){o("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:t,timestamp:n!=null?n:o("MAWQplProxy").performanceAbsoluteNow()})},n.$15=function(t){var e=o("MAWQplProxy").performanceAbsoluteNow(),n={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:t,timestamp:e,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""])),JSON.stringify(n)),t===o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?r("promiseDone")(o("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",n),function(){m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent'])))},function(e){m.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""])),e)}):o("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",n)},t})(),_=new p;l.ConsumerUINotifier=p,l.offlineResumeUINotifier=_}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","MAWUserJidWrapper","WAJids","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],a=o("MAWUserJidWrapper").getMyUserJid();return t.forEach(function(t){return o("WAJids").switchOnMsgrChatJidType(t.jid,{group:function(){n.push(o("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(e,t.jid,a))},user:r("emptyFunction")})}),o("MAWDexieTable").dexieAll(n).then(function(e){e.forEach(function(e,t){e.forEach(function(e,t){o("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:o("MAWBridgeTypesCreators").createBridgeGroupInvite(e)})})})})}l.loadGroupInvites=e}),98);
__d("MAWLoadMessagesRequest",["FBLogger","MAWMessagesCompare","MAWMessagesDirection","MessagesRangesV2ExternalIds","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e={admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1};function s(e,t,n){var a,i;if(e.length===0)return[];var l=o("MAWMessagesCompare").getSortComparisonFunctionForDirection(o("MAWMessagesDirection").translateMawDirectionToMwpDirection(n)),s=[].concat(e).sort(l);if(t.lowerBoundExternalId!=null&&((a=t.lowerBoundExternalId)==null?void 0:a.toString())!==o("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&((i=t.lowerBoundExternalId)==null?void 0:i.toString())!==o("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){var u=s.findIndex(function(e){return e.externalId===t.lowerBoundExternalId});u!==-1?s=s.slice(u):r("FBLogger")("messenger_web").mustfix("Get messages for range: no external id in source msgs list")}return s=c(s,t),s.slice(0,t.numMsgs)}function u(e,t,n,r){var a=e.filter(function(e){var n,r;return((n=e.sortOrderMs)!=null?n:Number.MAX_SAFE_INTEGER)>=t.gte[0]&&((r=e.sortOrderMs)!=null?r:Number.MIN_SAFE_INTEGER)<=t.lte[0]}),i=o("MAWMessagesDirection").switchOnMAWMessagesDirection(n,{after:[t.gte,t.lte],before:[t.lte,t.gte]}),l=i[0],u=l[0],c=l[1],d=i[1],m=d[0],p=d[1],_=s(a,{includeLowerBoundMsg:!0,lowerBoundExternalId:o("WAStanzaUtils").toStanzaId(c),lowerBoundSortOrderMs:u,numMsgs:r},n);if(p!==o("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&p!==o("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){var f=_.findIndex(function(e){return e.externalId===p});if(f!==-1)return _.slice(0,f)}return _}function c(e,t){return t.includeLowerBoundMsg||e.length===0?e:e[0].externalId===t.lowerBoundExternalId||e[0].sortOrderMs===t.lowerBoundSortOrderMs?e.slice(1):e}l.loadMsgsConfigForCheckingOnly=e,l.getMsgsForRange=s,l.getMsgsForBounds=u}),98);
__d("MAWLoadMsgsDedupper",["MAWDbMsgUtil","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e=new Set;return function(t){var n=o("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(t);if(n==null)return!0;var r=o("WAMsg").craftWAMsgIdString(n);if(r!=null){if(e.has(r))return!1;e.add(r)}return!0}}l.default=e}),98);
__d("MAWLoadMsgsUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){var r=0,o=0,a=!1,i=null;return function(l){return o++,i!=null&&i===l.sortOrderMs?!1:o>t&&l.sortOrderMs!==e||(l.msgId===n&&(a=!0),a&&r++,r>t)?!0:(i=l.sortOrderMs,!1)}}function l(e){var t=!0,n=0,r=null;return function(o){if(r===null)n++;else{if(r===o.sortOrderMs)return n+=t?0:1,!1;n++,t=!1}return n>e?!0:(r=o.sortOrderMs,!1)}}i.makeUntilWithRangeExtension=e,i.makeUntilWithRangeExtensionBothDirections=l}),66);
__d("MAWLoadMsgsTxnsV2",["I64","MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeReceiverFetchInfo","MAWBridgeTypesCreators","MAWBridgeXMA","MAWCurrentUser","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbPollTxns","MAWDbReactionsTxns","MAWDbReceiverFetchTxns","MAWDbXMATxns","MAWDexieTable","MAWLoadMessagesRequest","MAWLoadMsgsDedupper","MAWLoadMsgsUtil","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaUtils","MAWMessagesDirection","MAWODSProxy","MAWRavenUtils","MAWXMAUtils","MWFBLogger","MsgrWebGating","WAMsgType","WAOdsEnums","WATimeUtils","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e,t,n,o,a,i){switch(n){case"before":return l();case"after":return s().then(function(e){return e.reverse()})}function l(){var n=r("MAWLoadMsgsDedupper")();return e.messages.where(["threadJid","sortOrderMs"]).between([t,0],[t,o],!0,!0).reverse().filter(a).filter(n).filter(function(e){return r("justknobx")._("3227")?e.source!=="media_restore":e!=null}).until(i,!0).toArray()}function s(){var n=r("MAWLoadMsgsDedupper")();return e.messages.where(["threadJid","sortOrderMs"]).between([t,o],[t,Number.MAX_SAFE_INTEGER],!0,!0).filter(a).filter(n).filter(function(e){return r("justknobx")._("3227")?e.source!=="media_restore":e!=null}).until(i,!0).toArray()}}function _(e,t){return o("MAWDbReactionsTxns").getReactionsFromMessages(e,t).then(function(e){return e.map(function(e){var t=e.author,n=e.reaction,r=e.reactToMsgId,a=e.threadJid,i=e.ts;if(r!=null)return n==null?{reaction:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:a,reactToMsgId:r}),type:"delete"}:{reaction:o("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:t,chatJid:a,reaction:n||"",reactToMsgId:r,ts:i}),type:"upsert"}}).filter(Boolean)})}function f(e,t){return o("MAWDbMediaTxns").getMsgMediaPairFromMsgs(e,t).then(function(t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t[0],r=t[1];return o("MAWDbChunkTxns").hasMediaChunk(e,r.hashedPlaintextHash).then(function(t){return g(e,n.threadJid,r).then(function(a){var i=a.map(function(e){return e.msgId}),l=o("MAWMediaUtils").createHdTypesForBridgeMedia(a),s=n.ravenEphemeralType!=null&&n.ravenEphemeralMediaState!=null?o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.threadJid,filteredMsgIds:i,hasMediaForUI:t,hdTypes:l,media:r,ravenSettings:o("MAWRavenUtils").deriveRavenSettings(n.ravenEphemeralType,n.ravenEphemeralMediaState),sortOrderMs:n.sortOrderMs}):o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.threadJid,filteredMsgIds:i,hasMediaForUI:t,hdTypes:l,media:r,sortOrderMs:n.sortOrderMs});return o("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(e,s,a)})})}))})}function g(e,t,n){return e.messages.where("msgId").anyOf(n.msgIds).toArray().then(function(e){return e.filter(function(e){return e.threadJid===t})})}function h(e,t){return o("MAWDbXMATxns").getXMAFromMsgs(e,t).then(function(t){return o("MAWDexieTable").dexieAll(t.map(function(t){return o("MAWXMAUtils").isXMAStoryReply(t.targetType)?o("MAWDexieTable").dexieResolve(null):o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.defaultPreviewMediaId).then(function(n){return n==null?o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1}):o("MAWDexieTable").dexieAll([n,o("MAWDbChunkTxns").hasMediaChunk(e,n==null?void 0:n.hashedPlaintextHash)]).then(function(e){var n=e[0],r=e[1];return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:r,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})})}))}).then(function(e){return e.filter(Boolean)})}function y(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){return t.receiverFetchId==null?o("MAWDexieTable").dexieResolve(null):o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(e,t.receiverFetchId).then(function(e){return e==null?o("MAWDexieTable").dexieResolve(null):o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(t.threadJid,t.msgId,t.sortOrderMs,t.ts,e)})})).then(function(e){return e.filter(Boolean)})}function C(e,t){var n=new Map;return o("MAWDexieTable").dexieAll(t.map(function(t){if(t.type!==o("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE&&t.type!==o("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE)return null;var r=t.type===o("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE?t.externalId:t.pollStanzaId;if(r==null)return o("MWFBLogger").MWMediaLogger().tags(["GroupPollsE2EE"]).mustfix("pollStanzaId is null for poll msg in MLV2"),null;var a=n.get(r);if(a!=null){if(a.externalId===t.externalId){var i;return b(e,t.threadJid,r,a.msgId,o("WATimeUtils").castToMillisTime((i=a==null?void 0:a.sortOrderMs)!=null?i:0))}return null}return o("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(e,r,t.threadJid).then(function(a){if(a==null){var i;return b(e,t.threadJid,r,t.msgId,o("WATimeUtils").castToMillisTime((i=t.sortOrderMs)!=null?i:0))}if(n.set(r,a),a.externalId===t.externalId){var l;return b(e,t.threadJid,r,a.msgId,o("WATimeUtils").castToMillisTime((l=a==null?void 0:a.sortOrderMs)!=null?l:0))}else return null})})).then(function(e){return e.filter(Boolean)}).finally(function(){n.clear()})}function b(e,t,n,r,a){return e.poll.get([t,n]).then(function(e){return e==null?(o("MWFBLogger").MWMediaLogger().tags(["GroupPollsE2EE"]).mustfix("Poll is null in MLV2"),null):{contactIdForCurrentUser:(m||(m=o("I64"))).of_string(o("MAWCurrentUser").getID()),dbPoll:e,latestUpdateMsgId:r,latestUpdateTimestampMs:a}})}function v(e,t,n){if(!o("MsgrWebGating").isQuotedMessagesInLsEnabled())return o("MAWDexieTable").dexieResolve([n,[]]);var r=n.map(function(n){var r;return n.quote==null?null:o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,n.quote.content.externalId,t,(r=n.quote)==null?void 0:r.content.author)}).filter(Boolean);return r.length<=0?o("MAWDexieTable").dexieResolve([n,[]]):o("MAWDexieTable").dexieAll(r).then(function(e){return[n,e.filter(Boolean)]})}function S(e,t,n,r,a,i,l){l===void 0&&(l=function(){return!0});var s=o("WATimeUtils").unixTime(),u=function(t){return t.messageExpirationTs==null||t.messageExpirationTs>s},c=o("MAWLoadMsgsUtil").makeUntilWithRangeExtension(a,n,i);return p(e,t,r,a,function(e){return l(e)&&u(e)},c).then(function(n){return v(e,t,n)}).then(function(t){var n=t[0],r=t[1];return o("MAWDexieTable").dexieAll([].concat(n,r).map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)})).then(function(e){return{msgs:n,quoteMsgs:r,replyMediaInfo:e}})})}function R(e,t){return e.messages.where("externalId").equals(t).toArray()}function L(e,t){return R(e,t).then(function(n){return n.length>1&&o("MWFBLogger").MWLogger().tags(["Pinned"]).warn("duplicate MAW msg returned for externalId",t),o("MAWDexieTable").dexieAll(n.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)})).then(function(e){return{msgs:n,replyMediaInfo:e}})})}function E(t){var n=t.filter(function(e){return e.ephemeralCounterStarted});return n.length>0?(o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.Countdown,o("MAWLoggerUtils").Tag.OnLoad]).DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""])),String(n.map(function(e){return e.msgId}))),o("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(n).msgs):[]}function k(e,t){return e!=null?e:o("MAWMessagesDirection").switchOnMAWMessagesDirection(t,{after:Number.MIN_SAFE_INTEGER,before:Number.MAX_SAFE_INTEGER})}function I(e){var t=e.chatJid,n=e.config,r=e.db,a=e.direction,i=e.range,l=o("WATimeUtils").unixTime(),u=function(t){var e=t.messageExpirationTs!=null&&t.messageExpirationTs<l,r=t.type===o("WAMsgType").MSG_TYPE.ADMIN&&!n.admin,a=t.isCollapsed===!0;return!e&&!r&&!a},c=i.includeLowerBoundMsg?i.numMsgs:i.numMsgs+1,d=o("MAWLoadMsgsUtil").makeUntilWithRangeExtensionBothDirections(c),m=k(i.lowerBoundSortOrderMs,a);return p(r,t,a,m,u,d).then(function(e){return v(r,t,e)}).then(function(e){var t=e[0],n=e[1],l=o("MAWLoadMessagesRequest").getMsgsForRange(t,i,a);return o("MAWDexieTable").dexieAll([].concat(l,n).map(function(e){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(r,e)})).then(function(e){return{msgsForRange:l,quotedMsgs:n,replyMediaInfo:e}})}).then(function(e){var l=e.msgsForRange,u=e.quotedMsgs,c=e.replyMediaInfo;return o("MWFBLogger").MWLogger().tags(["MAWSecureLocalDBDataSource"]).DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", range: ",".}"])),t,String(i)),D(r,l,u,c,a,i.numMsgs,n,t)})}function T(e,t,n,r,a,i,l,s){var c=k(a,r);return S(e,t,n,r,c,l,function(e){var t=e.isCollapsed===!0,n=!s.admin&&e.type===o("WAMsgType").MSG_TYPE.ADMIN;return!(t||n)}).then(function(a){var d=a.msgs,m=a.quoteMsgs,p=a.replyMediaInfo,_=d;return i||(_=_.filter(function(e){return e.msgId!==l}),_.length===d.length&&d.length!==0&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.LOAD_MORE_NO_ORIGINAL_MSG_IN_MAW,key:"mismatch"})),o("MWFBLogger").MWLogger().tags(["MAWSecureLocalDBDataSource"]).DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs: From:"," orignalMsgId:",", chatJid: ",""])),c,l,t),D(e,_,m,p,r,n,s,t)})}function D(e,t,n,a,i,l,s,u){var d=t.length;if(d===0)return o("MAWDexieTable").dexieResolve({editMsgHistory:[],expiringCountdown:[],hasMoreAfter:$(d,l,i),hasMoreBefore:x(d,l,i),medias:[],msgs:[],noteReplyCountdown:[],polls:[],quotedMsgs:[],reactions:[],receiverFetchInfoPayloads:[],xmaCountdown:[],xmas:[]});var m=t.map(function(e,t){if(!o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType))return o("MAWBridgeMsg").createBridgeMsg(e,(a||[])[t])}).filter(Boolean),p=E(t);return o("MWFBLogger").MWLogger().tags(["MAWSecureLocalDBDataSource"]).DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", result: ",""])),u,String(m.map(function(e){return e.msgId+":"+e.sortOrderMs}))),o("MAWDexieTable").dexieAll([s.reactions?_(e,t):o("MAWDexieTable").dexieResolve([]),s.media?f(e,r("gkx")("17154")?[].concat(t,n):t):o("MAWDexieTable").dexieResolve([]),s.xma?h(e,t):o("MAWDexieTable").dexieResolve([]),s.editMsgHistory?o("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(e,t):o("MAWDexieTable").dexieResolve([]),s.receiverFetch?y(e,t):o("MAWDexieTable").dexieResolve([]),s.polls?C(e,t):o("MAWDexieTable").dexieResolve([])]).then(function(e){var t=e[0],r=e[1],a=e[2],s=e[3],u=e[4],c=e[5];return{editMsgHistory:s,expiringCountdown:p,hasMoreAfter:$(d,l,i),hasMoreBefore:x(d,l,i),medias:r,msgs:m,noteReplyCountdown:[],polls:c,quotedMsgs:n.map(function(e){return o("MAWBridgeMsg").createBridgeMsg(e,null,!0)}),reactions:t,receiverFetchInfoPayloads:u,xmaCountdown:[],xmas:a}})}function x(e,t,n){switch(n){case"before":return e>=t;default:return!0}}function $(e,t,n){switch(n){case"after":return e>=t;default:return!0}}function P(e,t,n){return L(e,t).then(function(r){var a=r.msgs,i=r.replyMediaInfo;if(a.length===0)return{editMsgHistory:[],medias:[],msgs:[],polls:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]};var l=a.map(function(e,t){if(!o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType))return o("MAWBridgeMsg").createBridgeMsg(e,(i||[])[t])}).filter(Boolean);return o("MWFBLogger").MWLogger().tags(["MAWFetchMessageByPinnedExternalId"]).DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["LoadMsgsByExternalId: From: externalId:",". ",""])),t,String(l.map(function(e){return""+e.msgId}))),o("MAWDexieTable").dexieAll([n.reactions?_(e,a):o("MAWDexieTable").dexieResolve([]),n.media?f(e,a):o("MAWDexieTable").dexieResolve([]),n.xma?h(e,a):o("MAWDexieTable").dexieResolve([]),n.editMsgHistory?o("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(e,a):o("MAWDexieTable").dexieResolve([]),n.receiverFetch?y(e,a):o("MAWDexieTable").dexieResolve([]),n.polls?C(e,a):o("MAWDexieTable").dexieResolve([])]).then(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],a=e[4],i=e[5];return{editMsgHistory:o,medias:n,msgs:l,polls:i,reactions:t,receiverFetchInfoPayloads:a,xmas:r}})})}l.loadMoreMsgsAndMediaForRange=I,l.loadMoreMsgsAndMediaFromTs=T,l.loadMsgsAndMediaByExternalId=P}),98);
__d("MAWLoadMsgsTxns",["MAWIndexedDb","MAWLoadMsgsTxnsV2"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){return r===void 0&&(r=!1),a===void 0&&(a="before"),o("MAWLoadMsgsTxnsV2").loadMoreMsgsAndMediaFromTs(e,t,n,a,null,r,null,{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0}).then(function(e){var t=e.expiringCountdown,n=e.hasMoreAfter,r=e.hasMoreBefore,a=e.medias,i=e.msgs,l=e.quotedMsgs,s=e.receiverFetchInfoPayloads,u=e.xmas;return l!=null&&l.length>0&&o("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:l}}),i.length>0&&o("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:i}}),t.length>0&&o("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:{msgs:t}}),u.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})}),a.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e})}),s.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:e})}),{hasMoreAfter:n,hasMoreBefore:r}})}l.loadMsgAndMedia_COMPAT=e}),98);
__d("MAWLoadThreadsTxns",["FBLogger","I64","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMsgsTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWMpsGating","MAWThreadMappingQPL","MAWTransactionMode","MAWUserJidWrapper","WAJids","WALogger","emptyFunction","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r,a,i){return i===void 0&&(i="unknown"),n.forEach(function(t){var n=o("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(t.jid);o("MAWThreadMappingQPL").startInWorker({instanceKey:n,jid:t.jid,threadKey:t.optimisticThreadKey==null?void 0:(e||(e=o("I64"))).of_string(t.optimisticThreadKey),trigger:"loadContentsForThreads_"+i}),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(t,a==null?void 0:a.get(t.jid),void 0,"loadContentsForThreads_"+i,n)})}),o("MAWMpsGating").isFullMpsEnabled()?o("MAWDexieTable").dexieResolve(n):o("MAWDexieTable").dexieAll([].concat(n.map(function(e){return o("MAWMpsGating").isMpsMessageRendering()?o("MAWDexieTable").dexieResolve():o("MAWLoadMsgsTxns").loadMsgAndMedia_COMPAT(t,e.jid,r,!0)}),[u(t,n),o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(n.map(function(e){return e.jid})),o("MAWLoadGroupInvitesTxns").loadGroupInvites(t,n)])).then(function(){return n})}function u(e,t){var n=[];return t.forEach(function(e){return o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(t){return n.push(t)},user:r("emptyFunction")})}),e.groupInfo.bulkGet(n).then(function(e){e.forEach(function(e){e!=null&&o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(e)})})})}var c=function(t){var e=t.threadJid;return d(e)},d=o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return m.apply(void 0,[e].concat(n))})});function m(e,t,n,a,i,l){n===void 0&&(n=!0),a===void 0&&(a=!0);var s=o("MAWUserJidWrapper").getMyUserJid();return o("MAWDbParticipantTxns").getParticipant(e,t,s).then(function(e){if(!e.success){var u=n?"group":"one_to_one";if(o("WALogger").LOG(["[Occamadillo] User is not a participant of "+u+" thread\n        "+t.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),i==null){var c;r("FBLogger")("maw_db","checkIfParticipant").catching((c=e.payload)!=null?c:r("err")(e.error)).warn("[Occamadillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",s,u,t.toString(),a,l)}r("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamadillo] User not a participant from checkIfParticipant");var d={cannotReplyReason:"viewer_not_subscribed",threadJid:t};o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(d)})}})}l.loadContentsForThreads=s,l.loadGroups=u,l.checkIfGroupParticipant=c}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWDexieTable","MAWLoadGroupInvitesTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return n===void 0&&(n="getOrCreateThread"),o("WAJids").switchOnMsgrChatJidType(t,{group:function(n){return o("MAWThreadManagementTxns").getGroupThread(e,n,void 0).then(function(e){return e==null?null:{created:e.created,thread:e.thread}})},user:function(r){return o("MAWThreadManagementTxns").getOrSetupOneToOneThread(e,{createTs:void 0,description:n,folder:void 0,userJid:r})}})}function s(e,t,n,r,a){return a===void 0&&(a="fetchAndEmitThread"),o("WAJids").switchOnMsgrChatJidType(t,{group:function(r){return o("MAWThreadManagementTxns").getGroupThread(e,r,n).then(function(e){return e==null?null:{created:e.created,thread:e.thread}})},user:function(i){return o("MAWThreadManagementTxns").getOrSetupOneToOneThread(e,{createTs:r==null?void 0:o("WATimeUtils").castUnixTimeToMillisTime(r),description:a,folder:n!=null?n:void 0,userJid:i})}}).then(function(t){return t==null||t.thread==null?null:o("MAWLoadThreadsTxns").loadContentsForThreads(e,[t.thread],1,null,a).then(function(){return t})})}function u(e,t){if(t.size===0)return o("MAWDexieTable").dexieResolve();var n=Array.from(t);return e.threads.where("jid").anyOf(n).toArray().then(function(t){var n=t.filter(Boolean);return o("MAWDexieTable").dexieAll([o("MAWLoadThreadsTxns").loadGroups(e,n),o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(n.map(function(e){return e.jid})),o("MAWLoadGroupInvitesTxns").loadGroupInvites(e,n)])}).then(r("emptyFunction"))}l.getOrCreateThread=e,l.fetchAndEmitThread=s,l.emitThreadContents=u}),98);
__d("MAWBulkHandleIncomingMsgApi",["LSMEBTaskCreationSource","MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWUseProtocolMsgIdForMsgId","WAMsgMap","WAOdsEnums","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(t,n){var a;return o("MAWIndexedDb").makeMsgrTransactor({chunk:(a=o("MAWTransactionMode")).READONLY,deletedMessages:a.READWRITE,deviceChangeAlerts:a.READWRITE,editMsgHistory:a.READWRITE,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,ftsPurgeBacklog:a.READWRITE,groupInfo:a.READWRITE,groupInvites:a.READWRITE,media:a.READWRITE,mediaBackup:a.READWRITE,messages:a.READWRITE,participants:a.READWRITE,pendingReceipts:a.READWRITE,pendingStanzas:a.READWRITE,poll:a.READWRITE,reactions:a.READWRITE,receiverFetchInfo:a.READWRITE,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READWRITE},"bulkHandleIncomingMsgs",function(a){return function(){var i=new(o("WAMsgMap")).MsgMap;o("MAWODSProxy").odsBumpEntityKey({amount:t.length,entity:o("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"}),o("MAWDexieTable").setDexiePSDItem("offlineQueueSize",t.length);var l=new Set(t.map(function(e){var t=e.msgData;return t.id.chat})),d=o("MAWPreprocessMsgs").classifyIncomingMsgs(t),m=d.editActionMsgs,p=d.reactionMsgs,_=function(n,a){var t=i.get(n);a.success?t==null?r("MAWHIMLogger").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""])),String(a)):t.success?i.set(n,o("WAResultOrError").makeResult(babelHelpers.extends({},t.value,a.value))):r("MAWHIMLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]))):i.set(n,a)},f=function(t,n){i.set(t,o("WAResultOrError").makeResult({protocolMsgId:t,unknownGroup:n==="missing"}))},g=function(i){var e=i.threadCreationResult,l=i.threads;return o("MAWDexieTable").dexieAll(t.map(function(t){var i,s=l.get(t.msgData.id.chat),d=(i=e.get(t.msgData.id.chat))!=null?i:"missing";if(s==null){r("MAWHIMLogger").MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."])),d),r("MAWHIMLogger").DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""])),d,t.msgData.id.externalId);return}return f(t.msgData.id,d),o("MAWPreprocessMsgs").getMessageDataByType(a,t,s,n)}).filter(Boolean)).catch(function(e){throw e.message="[getAllMessagesProcessingData] "+e.message,e})},C=n!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,S=function(t){var e=b(t),n=o("MAWDexieTable").dexieResolve();return e.forEach(function(e){n=n.then(function(){return o("MAWHandleIncomingMsgApi").handleIncomingMsg(a,e,C)}).then(function(t){_(e.id,t),y(e.id,e.ts)})}),n.catch(function(e){throw e.message="[writeIncomingMsgs] "+e.message,e}),n},R=function(){return m.length===0?o("MAWDexieTable").dexieResolve():o("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(a,m).then(function(e){return o("MAWBulkEditMsgsTxns").bulkEditMsgs(a,m,e)})};return h(a,l).then(function(e){return o("MAWDexieTable").dexieAll([g(e),o("MAWBulkWriteReactionsTxns").prepareReactionsData(a,p)]).then(function(e){var t=e[0],n=e[1];return o("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,n).then(function(){return S(t)}).then(function(){return R()}).then(function(){return o("MAWThreadFetchAndEmitTxns").emitThreadContents(a,l)}).then(function(){return v(a,i)}).then(function(){return{msgResults:i}})})})}})()}function h(e,t){var n=Array.from(t);return o("MAWDbThreadTxns").getThreads(e,n).then(function(t){return o("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(e,n,t)})}function y(e,t){var n,r=e.chat.toString();o("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((n={},n[r]=t,n)),o("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1)}var C=r("MAWHIMLogger").tags(["MergeActions"]);function b(e){C.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"])),e.length);var t=new(o("WAMsgMap")).MsgMap;for(var n of e){C.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",", action "," and type ",""])),n.id.externalId,n.action,n.type),n.receiveFlow.addPoint("him_merge_actions");var r=t.get(n.id);if(r==null){t.set(n.id,n);continue}if(r.action===n.action&&r.type===n.type){n.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(n.action){case o("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:{if(r.action===o("MAWMsgActionType").MSG_ACTION.REVOKE||r.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){C.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"])));continue}t.set(n.id,n);continue}case o("MAWMsgActionType").MSG_ACTION.WRITE:case o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:{if(r.action===o("MAWMsgActionType").MSG_ACTION.REVOKE||r.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){C.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"])));continue}switch(n.type){case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:{r.type===o("MAWMsgType").MSG_TYPE.UNAVAILABLE&&t.set(n.id,n);break}default:r.type!==o("MAWMsgType").MSG_TYPE.CIPHERTEXT&&C.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Unexpected overwrite on WRITE action. Current type: ",", next type: ",""])),r.type,n.type),t.set(n.id,n)}break}case o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case o("MAWMsgActionType").MSG_ACTION.REVOKE:{r.action!==o("MAWMsgActionType").MSG_ACTION.REVOKE&&t.set(n.id,n);break}}}var a=[];for(var i of e){var l,s,u=t.get(i.id);i.receiveFlow.addAnnotations({string:{final_action:(l=u==null?void 0:u.action)!=null?l:"undefined",final_msg_type:(s=u==null?void 0:u.type)!=null?s:"undefined",has_replaced_action:(i!==u).toString(),initial_action:i.action,initial_msg_type:i.type}}),!(u==null||u.action===o("MAWMsgActionType").MSG_ACTION.NO_ACTION)&&(a.push(u),t.delete(i.id))}return a}function v(e,t){if(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId())return o("MAWDexieTable").dexieResolve();var n=new Set;return t.values().forEach(function(e){if(e.success){var t=e.value,r=t.protocolMsgId,o=t.reactToExternalId;o!=null?n.add(o):r!=null&&n.add(r.externalId)}}),o("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(e,Array.from(n)).then(function(t){return o("MAWLinkReactionsToMsgsTxns").updateReactionLinks(e,t)})}l.bulkHandleIncomingMsgs=g,l.linkMsgsToReactions=v}),98);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWHIMLogger","MAWMsgType","MAWParseXMAUnsupportedMessageType","MAWXMALoggingUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a=new Set,i=t.map(function(e){var t,n,r,i,l,s,u,c=e.decodedMsg,d=e.receiveFlow,m=e.stanza,p=m.message.decrypted,_=o("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(c==null?void 0:c.xmaTargetTypeForLogging),f=c==null||(t=c.unstoredXMA)==null?void 0:t.unstoredDbXMA.xmaDataclass,g=c==null||(n=c.unstoredXMA)==null?void 0:n.unstoredDbXMA.targetType,h=o("MAWParseXMAUnsupportedMessageType").getXMAUnsupportedMessageType(g,f);return d.addAnnotations({bool:{furuteproof:(c==null||(r=c.unstoredDbMsg)==null?void 0:r.type)===o("MAWMsgType").MSG_TYPE.FUTUREPROOF},int:{xmaTargetType:(i=c==null?void 0:c.xmaTargetTypeForLogging)!=null?i:-1},string:{contentType:(l=c==null?void 0:c.contentTypeForLogging)!=null?l:"",subtype:(s=c==null||(u=c.unstoredDbMsg)==null||(u=u.msgContent)==null?void 0:u.subtype)!=null?s:h,xmaTargetTypeString:_}}),p.type==="InstamadilloMsg"?(d.endFail("instamadillo_not_supported"),a.add(m.stanzaQueueId),null):p.type==="InvisibleMsg"?(a.add(m.stanzaQueueId),null):{msgData:p,receiveFlow:d,stanzaSource:m.incomingType,unstoredContent:c}}).filter(Boolean);return r("MAWHIMLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"])),i.length),o("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(i,n).then(function(e){var n=e.msgResults;return r("MAWHIMLogger").DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"])),i.length),t.map(function(e){var t=e.stanza,o=n.get(t.message.decrypted.id);if(o==null){a.has(t.stanzaQueueId)||r("MAWHIMLogger").MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"])));return}o.success===!0&&a.add(t.stanzaQueueId)}),{followUpParams:{incomingMsgResults:n,incomingMsgs:t},toAck:Array.from(a)}}).catch(function(e){var n="Not an Error instance",r="N/A";throw typeof e.message=="string"&&(n=e.message),typeof e.stack=="string"&&(r=e.stack),t.forEach(function(e){e.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:n,errorStack:r}})}),e})}),d.apply(this,arguments)}l.handleIncomingMessagesStanzas=c}),98);
__d("isUseridAnnotationEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("24163")}l.default=e}),98);
__d("MAWUserHash",["MAWCurrentUser","WAGlobals","WAJids","isUseridAnnotationEnabled"],(function(t,n,r,o,a,i,l){"use strict";function e(){return o("MAWCurrentUser").isEmployee()&&r("isUseridAnnotationEnabled")()?o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()).slice(-5):null}l.getUserHash=e}),98);
__d("MAWIncomingMsg",["MAWUserHash","MWFBLogger","WAGetPlatformFromStanzaId","WAHashStringToNumber","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MWFBLogger").MWLogger().tags(["ServerRPC","HandleIncomingMsg"]),s=function(t){var e=t.encTypes,n=t.incomingType,r=t.msg,a=t.queueType,i=t.retryCount,l=t.taskSource,s=r.details,u=r.decrypted;return{int:{messageAge:o("WATimeUtils").unixTime()-s.ts,msgId:o("WAHashStringToNumber").hashStringToNumber(s.externalId.toString()),offlineDelivery:s.offline,retryCount:i,taskSource:l},string:{e2eePlatform:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(s.externalId),incomingType:n,jid:s.from.chat,msgDecryptedDataType:u.type,msgType:s.type,queueType:a,threadType:s.from.type,userHash:o("MAWUserHash").getUserHash()},string_array:{encTypes:e}}};l.logger=e,l.prepareAnnotationsForIncomingMessage=s}),98);
__d("MAWMessageReceiveReliabilityLogger",["QPLFlow","WAHashStringToNumber","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=r("qpl")._(1056840931,"814"),s=r("qpl")._(521477947,"2395"),u=60*1e3;function c(t){return o("QPLFlow").startQPLFlow(t.incomingType==="ebrestore"?s:e,{annotations:{int:{msgId:o("WAHashStringToNumber").hashStringToNumber(t.stanzaId)},string:{incomingType:t.incomingType,jid:t.jid,msgType:t.type}},instanceKey:o("WAHashStringToNumber").hashStringToNumber(t.stanzaId),timeoutInMs:u})}var d=300*1e3;l.logRRStartForMessage=c,l.RECEIVE_RELIABILITY_TIMEOUT=d}),98);
__d("MAWProtocolQueueUtils",["MAWIncomingMsg","MAWMessageReceiveReliabilityLogger","WAGetStorageQplAnnotations","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=o("MAWMessageReceiveReliabilityLogger").logRRStartForMessage(e);return n.addAnnotations(o("MAWIncomingMsg").prepareAnnotationsForIncomingMessage({incomingType:e.incomingType,msg:e.message,queueType:e.message.details.offline!=null?"offline":"online",retryCount:e.message.details.retryCount,taskSource:t})),n}function s(e,t){return r("promiseDone")(o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){t.addAnnotations(e)})),t.addPoint("consumer_handle_message_stanza_start"),babelHelpers.extends({},e,{receiveFlow:t})}l.startMetricForIncomingMsgV2=e,l.addAnnotationsToMessage=s}),98);
__d("MAWGetSyncResponseBackoffInfoByJidApi",["MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({ephemeralSettings:o("MAWTransactionMode").READONLY},"getSyncResponseBackoffInfoByJid",function(e){return function(t){return e.ephemeralSettings.get({userJid:t}).then(function(e){return e==null?null:e.ephemeralSyncResponseBackoffInfo})}});l.getSyncResponseBackoffInfoByJid=e}),98);
__d("MAWMarkMsgDroppedApi",["MAWAckLevel","MAWDbMsgTxns","MAWDbReactionsTxns","MAWDexieTable","MAWIndexedDb","MAWQplProxy","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWIndexedDb").makeMsgrTransactor({chunk:(e=o("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,reactions:e.READWRITE,receiverFetchInfo:e.READONLY,threads:e.READWRITE,xma:e.READONLY},"markMsgDropped",function(e){return(function(t,n,r){return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_start",{instanceKey:r.qplInstanceKey}),o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t),o("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(e,t)]).then(function(t){var a=t[0],i=t[1];if(r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_end",{instanceKey:r.qplInstanceKey}),a!=null){var l=(n==null?void 0:n.isRetriable)===!0?o("MAWAckLevel").ACK.failedRetryable:o("MAWAckLevel").ACK.expired;return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_system_ack_start",{annotations:{int:{ack:l}},instanceKey:r.qplInstanceKey}),o("MAWDbMsgTxns").updateSystemAck(e,a.msgId,l,void 0,void 0,void 0).then(function(e){return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_system_ack_end",{instanceKey:r.qplInstanceKey}),e==null?"missing":e.ack<=o("MAWAckLevel").ACK.clock?"dropped":"sent"})}return i!=null?(r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_delete_reaction_start",{instanceKey:r.qplInstanceKey}),o("MAWDbReactionsTxns").deleteReaction(e,i).then(function(){return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_delete_reaction_end",{instanceKey:r.qplInstanceKey}),"dropped"})):(r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_msg_and_reaction_missing",{instanceKey:r.qplInstanceKey}),"missing")})})});l.markMsgDropped=s}),98);
__d("MAWMessageSendScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e=24e4,s;function u(){return s==null&&(s=o("WorkerScheduler").makeScheduler("message-send",{concurrency:5,defaultSamplingRate:500,maxTaskLimit:5,maxThrottleMs:500,timeoutMs:e})),s}l.messageSendScheduler=u}),98);
__d("MAWMessageSendsCommon",["MAWMarkMsgDroppedApi","MAWMessageSendScheduler","MAWQplProxy","MWFBLogger","WAPromiseDelays","WAResultOrError","WATimeUtils","WAWaitForComms","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=1e3,c=o("MWFBLogger").MWLogger().tags(["MessageSend"]);function d(){var e=o("MAWMessageSendScheduler").messageSendScheduler().getDebugState();return{activeTasks:e.activeTasks.map(function(e){return"executionTimeMs"+e.executionTimeMs+" priority: "+e.priority+" name: "+e.task+" waitTimeMs:"+e.waitTimeMs}),pendingTasks:e.pendingTasksByPriority.map(function(e){return e.map(function(e){return"name: "+e.task+" waitTimeMs:"+e.waitTimeMs})}).flat()}}function m(e,t,n,r,o){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var p;o("MAWQplProxy").sendQplPointThroughBridge(t,"backend_reached",{annotations:{bool:{backendSetupReadyFromWorker:!o("WAWaitForComms").isStillWaitingForComms()}},instanceKey:n});var _;try{o("MAWQplProxy").sendQplPointThroughBridge(t,"wait_for_comms_start",{annotations:{},instanceKey:n}),yield o("WAWaitForComms").waitForComms(),o("MAWQplProxy").sendQplPointThroughBridge(t,"wait_for_comms_end",{annotations:{},instanceKey:n});var f=d(),g=f.activeTasks,h=f.pendingTasks;if(o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_start",{annotations:{string_array:{activeTasksBeforeSchedule:g,pendingTasksByPriorityBeforeSchedule:h}},instanceKey:n}),_=yield o("MAWMessageSendScheduler").messageSendScheduler().runTask({customFlags:{runtimeReliability:!0},fn:function(){return a(o("WATimeUtils").unixTime())},name:i,priority:o("WorkerScheduler").BLOCKING_PRIORITY}),_.success===!0)o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_end",{instanceKey:n});else{var y,C,b=d(),v=b.activeTasks,S=b.pendingTasks;o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_fail",{annotations:{string:{errorType:(y=(C=_.error)==null?void 0:C.type)!=null?y:"unknown-error"},string_array:{activeTasksBeforeSchedule:v,pendingTasksByPriorityBeforeSchedule:S}},instanceKey:n})}}catch(a){var R=r("getErrorSafe")(a),L=d(),E=L.activeTasks,k=L.pendingTasks;throw c.catching(R).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message send fail. Error: ",""])),o("getSafeQplErrorMessage").getSafeQPLErrorMessage(R)),o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_fail",{annotations:{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(R),errorType:"runtime-error",sendFailureError:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(R)},string_array:{activeTasksBeforeSchedule:E,pendingTasksByPriorityBeforeSchedule:k}},instanceKey:n}),l!=null&&(yield o("MAWMarkMsgDroppedApi").markMsgDropped(l,void 0,{qplEventType:t,qplInstanceKey:n})),R}if(!_){var I="null-response-from-message-send";return c.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Guard: should not happen, result is null"]))),o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_fail",{instanceKey:n}),o("WAResultOrError").makeError({applicationErrorCode:null,details:I,isRetriable:!0,type:"unexpected-message-codepath"})}if(_.success===!0)return _;if(_.success,l!=null&&(yield o("MAWMarkMsgDroppedApi").markMsgDropped(l,_.error,{qplEventType:t,qplInstanceKey:n})),((p=_.error)==null?void 0:p.type)==="retryable-error"){var T,D=(T=_.error.backoff)!=null?T:u;return yield o("WAPromiseDelays").delayMs(D),m(t,n,a,i,l)}else return _}),p.apply(this,arguments)}l.messageSendLogger=c,l.messageSendObserver=m}),98);
__d("MAWGetEditMsgForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:(d=o("MAWTransactionMode")).READONLY,messages:d.READONLY,reactions:d.READONLY,threads:d.READONLY},"getEditMsgForSending",function(e){return(function(t,n){return p(e,t,n).then(function(e){if(!e.success)return{type:e.error};var n=e.value.msg,a=o("MAWAsMessageApplication").asEditMessageApplication(n);if(o("WAJids").isAuthorSystem(n.author))throw r("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system edit");return{dbMsg:n,editOriginalExternalId:n.originalMsgExternalId,messageApplication:a,messageType:{isEdit:!0,isRevoked:!1,type:"text"},protocolMsgId:t,type:"unsent"}})})});function p(t,n,r){return o("MAWDbEditMsgHistoryTxns").getEditHistoryMsgByEditedProtocolMsgId(t,n,r).then(function(n){if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get edit history"]))),o("WAResultOrError").makeError("missing_history");if(n.sendStatus!=null&&n.sendStatus>o("MAWAckLevel").ACK.clock)return o("WAResultOrError").makeError("sent");var r=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.originalMsgExternalId);return r==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsgProtocolMsgId"]))),o("WAResultOrError").makeError("missing_msg")):o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(t,n.threadJid),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,r)]).then(function(e){var t=e[0],r=e[1];return t.success?r==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsg"]))),o("WAResultOrError").makeError("missing_msg")):r.ack>o("MAWAckLevel").ACK.clock?o("WAResultOrError").makeError("sent"):o("WAResultOrError").makeResult({msg:n,thread:t.value}):(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get thread (success:",")"])),t.success),o("WAResultOrError").makeError("missing_thread"))})})}l.getEditMsgForSending=m}),98);
__d("MAWSendMsgUtil",["MAWMediaType","WAArmadilloApplication.pb","WAConsumerApplication.pb","WAMsgType","decodeProtobuf","getMediaTypeFromConsumerMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("MAWMediaType").getMediaType(e),n=e===o("WAMsgType").MSG_TYPE.REVOKED;return t!=null?{mediaType:t,type:"media"}:e===o("WAMsgType").MSG_TYPE.SK_DISTRIBUTION?{isInvisible:!0,isRevoked:!1,type:"text"}:{isRevoked:n,type:"text"}}function s(t){var n=o("MAWMediaType").getMediaType(t);if(n!=null)return{mediaType:n,type:"media"};switch(t){case"XMA":case"Raven":case"RavenAction":case"EphemeralScreenshotAction":case"EditAction":case"BumpExistingMessage":return{isRevoked:!1,type:"text"};default:return e(t)}}function u(e){var t,n,r=(t=e.payload)==null||(t=t.subProtocol)==null?void 0:t.consumerMessage,a=(n=e.payload)==null||(n=n.subProtocol)==null?void 0:n.armadillo;if(r!=null){var i,l,s=o("decodeProtobuf").decodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,r.payload);if((s==null||(i=s.payload)==null||(i=i.content)==null?void 0:i.reactionMessage)!=null)return{type:"reaction"};if(s!=null&&(l=s.payload)!=null&&(l=l.applicationData)!=null&&l.revoke)return{isRevoked:!0,type:"text"};var u=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(s);if(u!=null)return{mediaType:u,type:"media"}}if(a!=null){var c=o("decodeProtobuf").decodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,a.payload),d=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(c);if(d!=null)return{mediaType:d,type:"media"}}return{isRevoked:!1,type:"text"}}l.waGetMessageTypeFromMsg=e,l.getMessageTypeFromMsg=s,l.getMessageTypeFromMessageApplication=u}),98);
__d("MAWGetMsgForSendingApi",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWSendMsgUtil","MAWTransactionMode","MAWXMAUtils","WAJids","WALogger","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("MAWIndexedDb").makeMsgrTransactor({groupInvites:(m=o("MAWTransactionMode")).READONLY,media:m.READONLY,messages:m.READONLY,reactions:m.READONLY,threads:m.READONLY,unrenderedMessages:m.READONLY,xma:m.READONLY},"getMsgForSending",function(t){return(function(n){return _(t,n).then(function(t){if(!t.success)return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Error: ",""])),n,t.error),{type:t.error};var a=t.value,i=a.groupInvite,l=a.isReplyMsg,c=a.media,d=a.msg,m=a.xmaPayload;if(!o("MAWDbMsg").NO_CONTENT_MESSAGE_TYPES_ALLOWLIST.includes(d.type)&&!o("MAWDbMsg").isContentMsg(d))throw o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Unrecognized type ",""])),n,d.type),r("FBLogger")("messenger_web").mustfixThrow("We do not support message sending with "+d.type+" type");var p=o("MAWAsMessageApplication").asMessageApplication(d,c,i,m,d.threadJid),_;if(d.type===o("MAWMsgType").MSG_TYPE.GROUP_INVITE&&i?_={invitedParticipantUserJid:i.inviteeJid,isRevoked:!1,type:"text"}:_=o("MAWSendMsgUtil").getMessageTypeFromMsg(d.type),o("WAJids").isAuthorSystem(d.author))throw r("FBLogger")("messenger_web").mustfixThrow("A system message cannot be sent");return o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Done"])),n),{dbMsg:d,isReplyMsg:l,isXMAMsg:m!=null,media:c,messageApplication:p,messageType:_,protocolMsgId:{author:d.author,chat:d.threadJid,externalId:m!=null&&m.associatedMessage!=null?m.associatedMessage.externalId:d.externalId},type:"unsent",xmaPayload:m}})})});function _(e,t){return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t),o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(e,t)]).then(function(n){var r=n[0],a=n[1],i=a.value,l=r||i;if(l==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"]))),o("WAResultOrError").makeError("missing_msg");if(l.ack>o("MAWAckLevel").ACK.clock)return o("WAResultOrError").makeError("sent");var s=o("MAWXMAUtils").maybeXMAMessage(r),u=l.quote!=null;return o("MAWDexieTable").dexieAll([r?o("MAWDbMediaTxns").getAndCheckMediaFromMsg(e,r):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult()),a.success?o("MAWDbGroupInviteTxns").getAndCheckGroupInviteFromMsg(e,a.value):o("MAWDexieTable").dexieResolve(),s?o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(e,t):null]).then(function(e){var t=e[0],n=e[1],r=e[2];if(!t.success)return t;if(r!=null&&!r.success)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get XMA: isXma: ",", type: "," "])),s,l.type),o("WAResultOrError").makeError("missing_xma");var a=t.value;return o("WAResultOrError").makeResult({groupInvite:n,isReplyMsg:u,media:a,msg:l,xmaPayload:r!=null?r.value:null})})})}l.getMsgForSending=p}),98);
__d("MAWGetNoteReplyMsgForSendingApi",["MAWAckLevel","MAWAsMessageApplication","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWSendMsgUtil","MAWTransactionMode","WAJids","WALogger","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n)]).then(function(t){var n=t[0],r=n;return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"]))),o("WAResultOrError").makeError("missing_msg")):r.ack>o("MAWAckLevel").ACK.clock?o("WAResultOrError").makeError("sent"):o("WAResultOrError").makeResult({msg:r})})}var c=o("MAWIndexedDb").makeMsgrTransactor({media:(s=o("MAWTransactionMode")).READONLY,messages:s.READONLY,threads:s.READONLY,unrenderedMessages:s.READONLY},"getNoteReplyForSending",function(e){return(function(t){return u(e,t).then(function(e){if(!e.success)return{type:e.error};var t=e.value.msg,n=o("MAWAsMessageApplication").asNoteReplyMessageApplication(t),a=o("MAWSendMsgUtil").getMessageTypeFromMsg(t.type);if(o("WAJids").isAuthorSystem(t.author))throw r("err")("A system message cannot be sent");return{dbMsg:t,messageApplication:n,messageType:a,protocolMsgId:{author:t.author,chat:t.threadJid,externalId:t.externalId},type:"unsent"}})})});l.getNoteReplyForSending=c}),98);
__d("MAWGetReactionForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbReactionsTxns","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WAJids","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(e,t).then(function(t){return t==null?o("WAResultOrError").makeError("missing"):t.ack>o("MAWAckLevel").ACK.clock?o("WAResultOrError").makeError("sent"):o("MAWDbThreadTxns").getThread(e,t.threadJid).then(function(e){return e.success?o("WAResultOrError").makeResult({msg:t}):o("WAResultOrError").makeError(e.error)})})}var s=o("MAWIndexedDb").makeMsgrTransactor({reactions:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"getReactionForSending",function(t){return(function(n){return e(t,n).then(function(e){if(!e.success)return{type:e.error};var t=e.value.msg,n=o("MAWAsMessageApplication").asReactionMessageApplication(t);if(o("WAJids").isAuthorSystem(t.author))throw r("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system reactions");return{chat:t.threadJid,dbMsg:t,externalId:t.externalId,messageApplication:n,messageType:{isInvisible:!0,type:"reaction"},protocolMsgId:{author:t.author,chat:t.threadJid,externalId:t.externalId},type:"unsent"}})})});l.getReactionForSending=s}),98);
__d("MAWLoadThreadParticipantsApi",["MAWDbParticipantTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"loadThreadParticipants",function(t){return(function(n){return t.threads.get({jid:n}).then(function(n){return n==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MAWLoadThreadParticipantsApi -- loadThreadParticipants -- there is no thread in db"]))),[]):o("MAWDbParticipantTxns").getParticipantsInThread(t,n.jid).then(function(e){return e.map(function(e){return e.userJid})})})})});l.loadThreadParticipants=s}),98);
__d("MAWMarkEditMsgDroppedApi",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:o("MAWTransactionMode").READWRITE,messages:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE},"markEditMsgDropped",function(t){return(function(n,a){var i=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.chat,a);return i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalProtocolMsgId is null"]))),o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing_original_protocol_msg_id"))):o("MAWDexieTable").dexieAll([t.threads.get({jid:n.chat}),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,i),o("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(t,i)]).then(function(e){var i=e[0],l=e[1],f=e[2],g=f.sort(function(e,t){return t.editTs-e.editTs}),h=f.find(function(e){return e.editExternalId===n.externalId}),y=g[1];return l==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is null"]))),o("WAResultOrError").makeError("missing_original_msg")):h==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is null"]))),o("WAResultOrError").makeError("missing_newest_edited_msg")):y==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] previousEditedMsg is null"]))),o("WAResultOrError").makeError("missing_previous_edited_msg")):h.editExternalId!==g[0].editExternalId?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is not the newest edit"]))),o("WAResultOrError").makeError("invalid_newest_edited_msg")):i==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] thread is null"]))),o("WAResultOrError").makeError("missing_thread")):l.type!==o("WAMsgType").MSG_TYPE.TEXT?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is not a text message"]))),o("WAResultOrError").makeError("invalid_original_msg")):t.messages.where("quoteExternalId").equals(a).toArray().then(function(e){var a,i=babelHelpers.extends({},l,{ack:o("MAWAckLevel").ACK.sent,editCount:((a=l.editCount)!=null?a:0)-1,msgContent:y.msgContent}),s=o("WAGlobals").getMyUserJid(),u=[],c=e.find(function(e){var t,r;return(((t=e.quote)==null?void 0:t.content.author)===o("WAJids").AUTHOR_ME||((r=e.quote)==null?void 0:r.content.author)===s)&&e.threadJid===n.chat});if(c!=null){var d=c.quote,m=c.quoteExternalId;if(d==null)r("FBLogger")("messenger_web").warn("[markEditMsgDropped] Failed to get the quoted content for a msg that has been quoted.",m);else{var p=babelHelpers.extends({},c,{quote:babelHelpers.extends({},d,{content:babelHelpers.extends({},d.content,{msgContent:babelHelpers.extends({},i.msgContent)})})});u.push(p)}}var g=[];return l.editCount===1&&f.length===2&&g.push(y.editMsgHistoryId),g.push(h.editMsgHistoryId),o("MAWDexieTable").dexieAll([t.messages.put(i),t.editMsgHistory.bulkDelete(g)]).then(function(){return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] editMsgHistory updated"]))),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(i)}),u.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})}),o("WAResultOrError").makeResult()})})})})});l.markEditMsgDropped=f}),98);
__d("MAWMarkEditMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MAWIndexedDb").makeMsgrTransactor({chunk:(_=o("MAWTransactionMode")).READONLY,editMsgHistory:_.READWRITE,ftsBackloggedMessages:_.READWRITE,media:_.READONLY,messages:_.READWRITE,receiverFetchInfo:_.READONLY,xma:_.READONLY},"markEditMsgSent",function(t){return(function(n,a,i,l){var _=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.chat,a);return _==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalProtocolMsgId is null"]))),o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing_original_protocol_msg_id"))):o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,_),o("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(t,_),o("MAWFTSTxns").maybePutMessageToBacklog(t,a)]).then(function(e){var _=e[0],f=e[1],g=f.find(function(e){return e.editExternalId===a}),h=f.find(function(e){return e.editExternalId===n.externalId});if(_==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsg is null"]))),o("WAResultOrError").makeError("missing_original_msg");if(g==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsgHistory is null"]))),o("WAResultOrError").makeError("missing_original_msg_edit_history");if((h==null?void 0:h.editExternalId)==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editedMsg?.editExternalId is null"]))),o("WAResultOrError").makeError("missing_edit_external_id");if(h.sendStatus!=null&&h.sendStatus>o("MAWAckLevel").ACK.clock&&_.ack>o("MAWAckLevel").ACK.clock)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory has already been sent"]))),o("WAResultOrError").makeError("already_sent");if(h.author!==o("WAJids").AUTHOR_ME)return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] on incoming message"]))),o("WAResultOrError").makeError("not_author");o("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:o("MAWBridgeTrace").createBridgeUpdateTraceData([h.editExternalId],r("MAWBridgeTraceEvent").ReceivedSent,o("ArmadilloDataTraceType").armadilloMessageSend)});var y=[];if(f.length===2&&_.editCount===1){var C=babelHelpers.extends({},g,{sendStatus:o("MAWAckLevel").ACK.sent});y.push(C)}var b=babelHelpers.extends({},h,{editTs:i,sendStatus:o("MAWAckLevel").ACK.sent});y.push(b);var v=babelHelpers.extends({},_,{ack:o("MAWAckLevel").ACK.sent});return l!=null&&(v.reportingMeta=l),o("MAWDexieTable").dexieAll([t.editMsgHistory.bulkPut(y),t.messages.put(v),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(t,v)]).then(function(e){var t=e[0],n=e[2];return o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory updated"]))),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(v,n)}),o("WAResultOrError").makeResult()})})})});l.markEditMsgSent=f}),98);
__d("MAWMarkMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbMsgTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWMsgType","MAWTransactionMode","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MAWIndexedDb").makeMsgrTransactor({chunk:(c=o("MAWTransactionMode")).READONLY,ephemeralSettings:c.READWRITE,groupInfo:c.READONLY,media:c.READONLY,messages:c.READWRITE,reactions:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READWRITE,unrenderedMessages:c.READWRITE,xma:c.READONLY},"markMsgSent",function(t){return(function(n,a,i){return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n),o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(t,n)]).then(function(l){var c=l[0],d=l[1];if(c==null&&!d.success){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Msg missing from DB"])));return}else if(c!=null){o("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:o("MAWBridgeTrace").createBridgeUpdateTraceData([c.externalId],r("MAWBridgeTraceEvent").ReceivedSent,o("ArmadilloDataTraceType").armadilloMessageSend)}),d.success&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Found both regular and unrendered message with the same protocol msg ID"])));var m=c.ack<o("MAWAckLevel").ACK.sent;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").updateSystemAck(t,c.msgId,o("MAWAckLevel").ACK.sent,a,i),o("MAWDbThreadTxns").getThread(t,c.threadJid)]).then(function(e){var n=e[0],r=e[1];if(!r.success){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Thread missing from DB"])));return}var i=r.value,l=o("WATimeUtils").castUnixTimeToMillisTime(a),s=babelHelpers.extends({},i,{lastReadMsgTs:l,newestMsgTs:l,threadOrder:o("MAWDbThread").craftThreadOrder(l,i.jid)}),c=m?o("MAWDbThreadTxns").updateThread(t,s):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([o("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(t,n),c]).then(function(){})})}else if(d.success){var p=d.value;return o("MAWDbUnrenderedMsgTxns").updateSystemAckForUnrenderedMsg(t,p.msgId,o("MAWAckLevel").ACK.sent).then(function(){if(p.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE)return o("MAWEphemeralSettingsTxns").updateContactWhenEphemeralSettingChangeMarkedSent(t,n.chat,a)})}})})});l.markMsgSent=d}),98);
__d("MAWSendWrittenMsg",["EBLogger","MAWBridge","MAWDebugMsg","MAWGetEditMsgForSending","MAWGetMsgForSendingApi","MAWGetNoteReplyMsgForSendingApi","MAWGetReactionForSending","MAWJids","MAWLoadThreadParticipantsApi","MAWMarkEditMsgDroppedApi","MAWMarkEditMsgSentApi","MAWMarkMsgDroppedApi","MAWMarkMsgSentApi","MAWMessageSendsCommon","MAWODSProxy","MAWSendMsgUtil","MpsTypes","WAAPI","WAAsMessageApplication","WABuildMpsPayload","WAFrankingTypes","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WebMps","asyncToGeneratorRuntime","encodeProtobuf","err","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){var i,l,d,m;o("MAWMessageSendsCommon").messageSendLogger.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg ",""])),String(t.protocolMsgId)),n.addPoint("get_msg_for_sending_start",{string:{type:t.type}});var p,_,f,g,h=null,y;if(a==null){var C,b;if(t.type==="message"||t.type==="revoke"||t.type==="bump")h=yield o("MAWGetMsgForSendingApi").getMsgForSending(t.protocolMsgId);else if(t.type==="reaction")h=yield o("MAWGetReactionForSending").getReactionForSending(t.protocolMsgId);else if(t.type==="edit")h=yield o("MAWGetEditMsgForSending").getEditMsgForSending(t.protocolMsgId,t.referencedOriginalExternalId);else if(t.type==="noteReply")h=yield o("MAWGetNoteReplyMsgForSendingApi").getNoteReplyForSending(t.protocolMsgId);else throw t.type,r("err")("This cannot happen because type has `message` as default argument but flow does not know that");if(h.type!=="unsent")return o("MAWMessageSendsCommon").messageSendLogger.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg not sending message: ",""])),h.type),o("WAResultOrError").makeError({details:h.type,isRetriable:!0,type:"wrong-message-state"});var v=h,S=v.dbMsg,R=v.isReplyMsg,L=v.isXMAMsg;y=h.protocolMsgId,p=h.messageApplication,f=h.messageType,_=S==null?void 0:S.type,g=h.editOriginalExternalId;var E=(S==null?void 0:S.ephemeralSetting)!=null&&((C=(b=S.ephemeralSetting)==null?void 0:b.ephemeralExpirationInSec)!=null?C:0)>0;n.addPoint("get_msg_for_sending_end",{bool:{isEditMsg:g!=null,isEphemeralMsg:E,isReplyMsg:R,isXMAMsg:L},string:{msgType:f.type}}),E&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_OLD_MESSAGE_SEND,key:"sendEphemeralMsg"})}else p=a.messageApplication,f=o("MAWSendMsgUtil").getMessageTypeFromMessageApplication(p),g=null,y=t.protocolMsgId;var k=o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,p).readBuffer(),I={bytes:o("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(k)),version:"v3"};n.addPoint("wa_send_msg_start");var T=yield r("WAAPI").sendChatMessage({loadThreadParticipants:o("MAWLoadThreadParticipantsApi").loadThreadParticipants,messagePayload:{backupDirective:null,frankingKey:(i=p.metadata)!=null&&i.frankingKey?o("WAFrankingTypes").castToFrankingKey(new Uint8Array((l=p.metadata)==null?void 0:l.frankingKey)):null,frankingVersion:(d=p.metadata)==null?void 0:d.frankingVersion,messageBytes:I,messageType:f,protocolMsgId:y}},n);if(T.success===!1){var D;switch(n.addPoint("wa_send_msg_fail",{string:{errorType:T.error.type,msgType:_}}),g!=null?yield o("MAWMarkEditMsgDroppedApi").markEditMsgDropped(y,g):yield o("MAWMarkMsgDroppedApi").markMsgDropped(y,T.error),o("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg END "," : ",""])),T.error.type,String((D=T.payload)!=null?D:"")),T.error.type){case"non-retryable-error":{if(T.error.applicationErrorCode!=null&&T.error.applicationErrorCode===10009)try{o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"RefreshContact",value:o("MAWJids").convertChatJidToIntJid(y.chat)}]})}catch(e){var x=r("getErrorSafe")(e);o("EBLogger").EBLogger().catching(x).mustfix("Failed to call bridge handler RefreshContact for JID %s and mediaType %s",y.chat,_)}return T}case"missing-receipt":case"wrong-message-state":case"unexpected-message-codepath":case"result-parsing-error":case"retryable-error":case"no-recipients":case"encryption-error":case"too-many-retries":return T;default:throw T.error.type,r("err")("Unreachable code")}}T.success,n.addPoint("wa_send_msg_end"),(m=T.value.meta)!=null&&m.pOrDhashMismatch&&(n.addPoint("dhash_phash_mismatch"),o("MAWDebugMsg").writeDebugMsg(y.chat,"Outgoing msg "+y.externalId+" got a phash mismatch")),h!=null&&(n.addPoint("mark_edit_msg_sent_start"),g!=null?yield o("MAWMarkEditMsgSentApi").markEditMsgSent(y,g,T.value.serverTs,T.value.reportingMeta):yield o("MAWMarkMsgSentApi").markMsgSent(y,T.value.serverTs,T.value.reportingMeta),n.addPoint("mark_edit_msg_sent_end"));try{var $,P;yield o("WebMps").mps().saveNewMessages([{directive:null,insertionSource:o("MpsTypes").InsertionSource.Send,message:o("WABuildMpsPayload").buildMpsMessage({encryptedTransportMessage:k},{externalId:y.externalId,frankingTag:($=T.value.reportingMeta)==null?void 0:$.frankingTag,reportingTag:(P=T.value.reportingMeta)==null?void 0:P.reportingTag,senderJid:o("WAGlobals").getMyUserJid(),serverTs:T.value.serverTs,threadId:y.chat})}],{source:"wa-message-sent"})}catch(e){o("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to save message to MPS: ",""])),o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e))}return T}),m.apply(this,arguments)}function p(e,t,n,r){return t.addAnnotations({bool:{is_secure:!0},string:{description:n,jid:e.protocolMsgId.chat}}),d(e,t,r)}l.sendWrittenMsgExternal=p}),98);
__d("MAWBuildNewMsgPayload",["FBLogger","MAWAdminMsgType","MAWAuthor","MAWDbMsg","MAWJids","MAWMsgType","WAArmadilloXMA.pb","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,a){var i;if(o("MAWDbMsg").isUnrenderedMsgType(e))throw r("FBLogger")("messenger_web").mustfixThrow("getNewMsg called for wrong message type "+e);var l,s;if(n.quote!=null&&(a==null?void 0:a.content)!=null){var u,c;s=a==null||(u=a.content)==null?void 0:u.externalId,l={content:a==null?void 0:a.content,remoteJid:(c=a==null?void 0:a.remoteJid)!=null?c:void 0}}if(n.noteContent!=null){var d=o("MAWJids").toUserJid(t.threadJid);l={content:{author:d,expirationTs:o("WATimeUtils").castToUnixTime(n.noteExpirationTs),externalId:t.externalId,msgContent:{content:n.noteContent},ts:t.ts,type:o("WAMsgType").NOTE_REPLY},remoteJid:void 0}}var m=babelHelpers.extends({},t,{quote:l,quoteExternalId:s}),p,_=n.mediaGroupMetadata;switch(e){case"Text":return babelHelpers.extends({},m,{msgContent:{commands:n.commands,content:n.content!=null?n.content:"",mentionedJids:n.mentionedJids},type:o("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers.extends({},m,{hdType:n.hdType,type:o("MAWMsgType").MSG_TYPE.IMAGE},_);case"Video":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(n.xmaMessageType==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA Message Missing xmaMessageType");return p=n.content!=null&&n.xmaMessageType===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE?n.content:"",babelHelpers.extends({},m,{msgContent:{commands:n.commands,content:p,mentionedJids:n.mentionedJids},type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:n.xmaMessageType});case"BumpExistingMessage":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE});case"ReceiverFetch":throw r("FBLogger")("messenger_web").mustfixThrow("ReceiverFetch is not supported yet");case"GroupPollCreate":return babelHelpers.extends({},t,{msgContent:{adminMsgContent:[(i=n.title)!=null?i:""],adminType:o("MAWAdminMsgType").CURRENT_USER_CREATED_POLL,version:1},type:o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE});case"GroupPollUpdate":throw r("FBLogger")("messenger_web").mustfixThrow("GroupPollUpdate is not supported yet");case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"Reaction":case"Raven":case"NoteReply":throw r("FBLogger")("messenger_web").mustfixThrow("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action, group invite messages");default:throw r("WAAssertUnreachable")(e)}}function c(e,t,n,a){if(!o("MAWDbMsg").isUnrenderedMsgType(e))throw r("FBLogger")("messenger_web").mustfixThrow("getNewUnrenderedMsg called for wrong message type "+e);switch(e){case"EphemeralSyncResponse":{if(n.ephemeralSetting==null)throw r("FBLogger")("messenger_web").mustfixThrow("Ephemeral Sync Response without ephemeral settings");return babelHelpers.extends({},t,{ephemeralSetting:n.ephemeralSetting,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE})}case"EphemeralSettingChangeFromCurrentDevice":{var i;if(n.ephemeralSetting==null)throw r("FBLogger")("messenger_web").mustfixThrow("Ephemeral Setting Change without ephemeral settings");return babelHelpers.extends({},t,{ephemeralSetting:n.ephemeralSetting,isEphemeralSettingReset:(i=n.isEphemeralSettingReset)!=null?i:!1,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE})}case"GroupInvite":{var l=o("WAJids").interpretAsGroupJid(t.threadJid);if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group Invite without valid group jid");if(n.invitedParticipantUserJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group Invite without invited user jid");return babelHelpers.extends({},t,{groupName:n.groupName==null?void 0:n.groupName,invitedParticipantUserJid:n.invitedParticipantUserJid,type:o("MAWMsgType").MSG_TYPE.GROUP_INVITE})}case"SenderKeyDistribution":return babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION});case"RavenAction":{if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("Raven Action without Raven Message External Id");if(n.actionType==null)throw r("FBLogger")("messenger_web").mustfixThrow("Raven Action without Action Type");return babelHelpers.extends({},t,{actionType:n.actionType,ravenActionToMsgExternalId:o("WAStanzaUtils").toStanzaId(a),type:o("MAWMsgType").MSG_TYPE.RAVEN_ACTION})}case"EditAction":throw r("FBLogger")("messenger_web").mustfixThrow("Edit action not implemented yet");default:throw r("WAAssertUnreachable")(e)}}function d(t){var n,a={author:o("MAWAuthor").getAuthorUserJid(t.author)||o("WAJids").AUTHOR_ME,externalId:t.externalId,mediaId:t.mediaId,msgId:t.msgId,plaintextHash:t.plaintextHash,specialTextSize:t.specialTextSize,ts:t.ts,xmaMessageType:t.xmaMessageType};switch(t.type){case o("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.IMAGE});case o("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.VIDEO});case o("MAWMsgType").MSG_TYPE.PTT:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.PTT});case o("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.TEXT});case o("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.STICKER});case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case o("MAWMsgType").MSG_TYPE.GIF:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.GIF});case o("MAWMsgType").MSG_TYPE.XMA:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:t.xmaMessageType});case o("MAWMsgType").MSG_TYPE.REVOKED:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE});case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return((n=t.quote)==null?void 0:n.content)==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["BumpExistingMessage does not have quote content when replying"]))),null):babelHelpers.extends({},t.quote.content,{author:o("MAWAuthor").getAuthorUserJid(t.quote.content.author)||o("WAJids").AUTHOR_ME});case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH});case o("MAWMsgType").MSG_TYPE.RAVEN:return babelHelpers.extends({},a,{ravenEphemeralMediaState:t.ravenEphemeralMediaState,ravenEphemeralType:t.ravenEphemeralType,ravenMediaType:t.ravenMediaType,type:o("MAWMsgType").MSG_TYPE.RAVEN});default:throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg: Unsupported message type ",""])),t.type),r("FBLogger")("messenger_web").mustfixThrow("Trying to reply to a message type that does not support replies")}}l.buildNewMsg=u,l.getNewUnrenderedMsg=c,l.msgToQuotedMsg=d}),98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel","MAWBuildNewMsgPayload","MAWDbMsg","MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(t,n,r,a){n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r,t,{annotations:a,instanceKey:n})},u=o("MAWIndexedDb").makeMsgrTransactor({chunk:(e=o("MAWTransactionMode")).READONLY,ephemeralSettings:e.READWRITE,ftsBackloggedMessages:e.READWRITE,groupInfo:e.READONLY,media:e.READONLY,messages:e.READWRITE,receiverFetchInfo:e.READONLY,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READONLY},"writeOutgoingMsg",function(e){return(function(t,n,r,o,a,i,l){return c(e,t,n,r,o,a,i,l)})});function c(e,t,n,r,a,i,l,u){return a.content!=null&&(a.content=o("MAWVault").vault(a.content)),s("write_outgoing_msg_start",u,l),o("MAWDexieTable").dexieAll([e.threads.get({jid:n}),e.messages.where("externalId").equals(t).toArray(),d(e,a.quote,n),o("MAWDbRavenActionTxns").maybeGetRavenMsgQueryByProtocolMsgId(e,a.ravenProtocolMsgId,i)]).then(function(n){var c=n[0],d=n[1],p=n[2],_=n[3];if(s("write_outgoing_msg_data_fetched",u,l,{bool:{isUnrenderedMsgType:o("MAWDbMsg").isUnrenderedMsgType(i)}}),c==null)return{type:"missing_thread"};var f=d.find(function(e){return e.threadJid===c.jid&&e.author===o("WAJids").AUTHOR_ME});if(f!=null)return f.ack>=o("MAWAckLevel").ACK.sent?{msgId:f.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:c.jid,externalId:f.externalId},type:"already_sent"}:{msgId:f.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:c.jid,externalId:f.externalId},type:"not_sent"};var g;if(o("MAWDbMsg").isUnrenderedMsgType(i)){var L={ack:o("MAWAckLevel").ACK.clock,author:o("WAJids").AUTHOR_ME,externalId:t,threadJid:c.jid,ts:r},E=o("MAWBuildNewMsgPayload").getNewUnrenderedMsg(i,L,a,_==null?void 0:_.externalId);g=o("MAWWriteMsgTxns").writeUnrenderedMsg(e,E,c)}else{var h={ack:o("MAWAckLevel").ACK.clock,altIndex:void 0,author:o("WAJids").AUTHOR_ME,ephemeralSetting:a.ephemeralSetting,externalId:t,isForwarded:a.isForwarded,specialTextSize:a.specialTextSize,threadJid:c.jid,ts:r},y=o("MAWBuildNewMsgPayload").buildNewMsg(i,h,a,p),C=a.isFirstMsg,b=a.openMessageOtid,v=a.openMessageParticipantCount,S=a.optimisticMsg,R=a.participantCount;g=o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,y).then(function(t){return o("MAWWriteMsgTxns").writeMsg(e,y,c,{isFirstMsg:C,isOutgoing:!0,openMessageOtid:b,openMessageParticipantCount:v,optimisticMsg:S,participantCount:R,quotedReplyAttachmentMeta:t})})}return g.then(function(n){return s("write_outgoing_msg_promise_resolved",u,l),m(e,i,c.jid,r).then(function(){return{msgId:n.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:c.jid,externalId:t},type:"not_sent"}})})})}function d(e,t,n){return t==null?o("MAWDexieTable").dexieResolve(null):o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(t){return t==null?null:e.threads.get({jid:t.threadJid}).then(function(e){var r=o("MAWBuildNewMsgPayload").msgToQuotedMsg(t);if(r==null)return null;if(t.messageExpirationTs!=null&&t.messageExpirationTs<o("WATimeUtils").unixTime()&&(r=babelHelpers.extends({},r,{mediaId:void 0,msgContent:void 0,type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0})),e==null||e.jid===n)return{content:r,remoteJid:null};var a=o("WAJids").interpretAndValidateJid(e.jid),i=a.jidType==="group"?a.groupJid:null;return{content:r,remoteJid:i}})})}function m(e,t,n,a){return t===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE?o("WAJids").switchOnMsgrChatJidType(n,{group:function(){return o("MAWDexieTable").dexieResolve()},user:function(n){return e.ephemeralSettings.get({userJid:n}).then(function(t){var n,r;return t==null?o("MAWDexieTable").dexieResolve():(t.ephemeralSyncResponseBackoffInfo={syncResponseRetries:((n=(r=t.ephemeralSyncResponseBackoffInfo)==null?void 0:r.syncResponseRetries)!=null?n:0)+1,syncResponseSentTs:a},e.ephemeralSettings.put(t))}).then(r("emptyFunction"))}}):t===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?o("WAJids").switchOnMsgrChatJidType(n,{group:function(){return o("MAWDexieTable").dexieResolve()},user:function(n){return e.ephemeralSettings.get({userJid:n}).then(function(t){return t==null||t.ephemeralSyncResponseBackoffInfo==null?o("MAWDexieTable").dexieResolve():(t.ephemeralSyncResponseBackoffInfo=void 0,e.ephemeralSettings.put(t).then(r("emptyFunction")))})}}):o("MAWDexieTable").dexieResolve()}l.writeOutgoingMsg=u,l.writeOutgoingMsgImpl=c,l.getQuoteInfo=d}),98);
__d("MAWSendEphemeralSettingMsg",["MAWGetSyncResponseBackoffInfoByJidApi","MAWLoggerUtils","MAWMessageSendsCommon","MAWMsgType","MAWQplProxy","MAWSendWrittenMsg","MAWWriteOutgoingMsgApi","MWFBLogger","WAAPI","WAJids","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.SettingSync]);function m(e,t,n,r,o,a){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l,m){if(t.isForSyncResponse){var p=yield o("WAJids").switchOnMsgrChatJidType(n,{group:function(){throw d.mustfixThrow("ChatJid is not supposed to be a group")},user:function(t){return o("MAWGetSyncResponseBackoffInfoByJidApi").getSyncResponseBackoffInfoByJid(t)}});if(f(i,p))return d.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ephemeral sync response backed off"]))),o("WAResultOrError").makeResult({description:"send not needed",messageType:"fixMe"})}var _=t.isForSyncResponse?o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE;yield r("WAAPI").getDevicesBeforeSend({chatJid:n,reason:"SendEphemeralSettings"});var g=yield o("MAWWriteOutgoingMsgApi").writeOutgoingMsg(a,n,i,t,_,l,m);if(d.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["send ephemeral setting message: chatJid ",", type ",", externalId ",""])),n,_,a),g.type==="already_sent")return d.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendMsg already sent message"]))),o("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"});if(g.type==="missing_thread")return d.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["sendMsg cannot send to a non-existent thread"]))),o("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"});var h=yield o("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:g.protocolMsgId,type:"message"},o("MAWQplProxy").continueQplAsCrossBridgeQplFlow(l,{instanceKey:m}),"MAWSendEphemeralSettingMsg");return h.success===!1?o("WAResultOrError").makeError(h.error):o("WAResultOrError").makeResult({chatJid:g.protocolMsgId.chat,content:t.content,ephemeralSetting:t.ephemeralSetting,externalId:g.protocolMsgId.externalId,initiatingSource:t.initiatingSource,messageType:"sendMsg",quote:t.quote,source:t.source,specialTextSize:t.specialTextSize,xmaMessageType:t.xmaMessageType})}),p.apply(this,arguments)}function _(e){var t=e.args,n=e.chatJid,r=e.externalId,a=e.qplEventType,i=e.qplInstanceKey;return o("MAWMessageSendsCommon").messageSendObserver(a,i,function(e){return m(t,n,r,e,a,i)},"ephemeral",{author:o("WAJids").AUTHOR_ME,chat:n,externalId:r})}function f(e,t){if(t==null)return!1;var n=t.syncResponseRetries,r=t.syncResponseSentTs;switch(n){case 1:return o("WATimeUtils").happenedWithinAt(e,r,180);case 2:return o("WATimeUtils").happenedWithinAt(e,r,900);default:return!0}}l.sendEphemeralSettingMsgFn=_}),98);
__d("WAGroupParserUtils",["WAGroupInviteUtils","WAJids","WALogger","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s={superadmin:"superadmin",admin:"admin",participant:"participant",nonparticipant:"nonparticipant"};function u(t){if(!t.hasAttr("error"))throw r("err")("Expected participant node to have error attr");var n=t.attrInt("error"),a=t.attrUserJid("jid");switch(n){case 401:return{errorCode:n,text:"not-authorized",user:a};case 403:{var i=t.child("add_request");return{errorCode:n,text:"request-code",code:o("WAGroupInviteUtils").toInviteCode(i.attrString("code")),expiration:i.attrTime("expiration"),user:a}}case 404:return{errorCode:n,text:"not-found",user:a};case 406:return{errorCode:n,text:"enterprise-not-allowed",user:a};case 408:return{errorCode:n,text:"temporarily-blocked",user:a};case 409:return{errorCode:n,text:"conflict",user:a};case 500:return{errorCode:n,text:"resource-constraint",user:a};default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["received unknown participant error code: ",""])),n),{errorCode:-1,text:"unknown",user:a}}}function c(e,t){e.assertTag("participant");var n="participant";switch(t){case"add":case"demote":n="participant";break;case"promote":n="admin";break;case"remove":n="nonparticipant";break}var r=e.attrUserJid("jid");if(e.hasAttr("error")){var a=u(e);return o("WAResultOrError").makeError(a)}else{var i,l=(i=e.maybeAttrEnum("type",s))!=null?i:n,c=e.maybeAttrString("addressable")!=="false";return o("WAResultOrError").makeResult({user:r,type:l,addressable:c})}}function d(e){var t;e.assertTag("group");var n=null,r=e.attrString("id");return r.includes("@")?n=e.attrGroupJid("id"):n=o("WAJids").toGroupJid(r),{jid:n,creator:e.maybeAttrUserJid("creator")||void 0,creationTs:e.attrTime("creation"),subject:{content:e.maybeAttrString("subject")||void 0,user:e.maybeAttrUserJid("s_o")||void 0,ts:(t=e.maybeAttrTime("s_t"))!=null?t:void 0},description:p(e)||void 0,participantVersion:e.maybeAttrString("p_v_id")||void 0,participants:e.mapChildrenWithTag("participant",function(e){return c(e)}),memberAddMode:m(e)||void 0}}function m(e){if(e.hasChild("member_add_mode")){var t=e.child("member_add_mode");if(t.hasContent()){var n=t.contentString();if(n==="admin_add"||n==="all_member_add")return n}}return null}function p(e){if(e.hasChild("description")){var t=e.child("description");if(t.hasChild("body")){var n=t.child("body");if(n.hasContent())return{id:t.attrString("id"),ts:t.attrTime("t"),content:n.contentString(),user:n.maybeAttrUserJid("participant")||void 0}}}return null}l.PARTICIPANT_TYPES=s,l.parseProtocolGroupParticipantNode=c,l.parseGroupNode=d}),98);
__d("WmiOds",["ODS"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){(e||(e=o("ODS"))).bumpEntityKey(9819,t,n,r)}l.wmiOdsBump=s}),98);
__d("WAQueryGroupOverChatD",["WADeprecatedSendIq","WADeprecatedWapParser","WAGroupParserUtils","WAResultOrError","WAWap","WmiOds","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("queryAllGroupsResponse",function(e){return e.assertTag("iq"),{groups:e.child("groups").mapChildren(o("WAGroupParserUtils").parseGroupNode)}});function s(){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t,n=(t=o("WAWap")).wap("iq",{id:t.generateId(),to:t.G_US,type:"get",xmlns:"w:g2"},t.wap("participating",null,t.wap("participants",null),t.wap("description",null))),r=yield o("WADeprecatedSendIq").deprecatedSendIq(n,e);return r.success?o("WAResultOrError").makeResult(r.result):o("WAResultOrError").makeError(r)}),u.apply(this,arguments)}var c=new(r("WADeprecatedWapParser"))("queryAllGroupsResponse",function(e){return e.assertTag("iq"),{group:o("WAGroupParserUtils").parseGroupNode(e.child("group"))}});function d(e){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.groupJid,r=yield o("WADeprecatedSendIq").deprecatedSendIq((t=o("WAWap")).wap("iq",{id:t.generateId(),to:t.GROUP_JID(n),type:"get",xmlns:"w:g2"},t.wap("query",null)),c);return r.success?(o("WmiOds").wmiOdsBump("wa_query_group","ok"),o("WAResultOrError").makeResult(r.result.group)):(o("WmiOds").wmiOdsBump("wa_query_group","fail-"+r.errorCode),o("WAResultOrError").makeError(r.errorText))}),m.apply(this,arguments)}l.queryAllGroups=s,l.parseQueryGroupResponse=c,l.queryGroupOverChatD=d}),98);
__d("WAQueryGroupInvite",["WADeprecatedSendIq","WAQueryGroupOverChatD","WAResultOrError","WAWap","WmiOds","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a,i=(a=o("WAWap")).wap("iq",{id:a.generateId(),to:a.GROUP_JID(e),type:"get",xmlns:"w:g2"},a.wap("query",null,a.wap("add_request",{admin:a.USER_JID(r),code:a.CUSTOM_STRING(t),expiration:a.CUSTOM_STRING(n.toString(10))}))),l=yield o("WADeprecatedSendIq").deprecatedSendIq(i,o("WAQueryGroupOverChatD").parseQueryGroupResponse);return l.success?(o("WmiOds").wmiOdsBump("wa_query_group","ok"),o("WAResultOrError").makeResult(l.result.group)):(o("WmiOds").wmiOdsBump("wa_query_group","query_group_for_invitee_fail"),o("WAResultOrError").makeError(l))}),s.apply(this,arguments)}l.queryGroupInvite=e}),98);
__d("WACryptoEd25519",["WACryptoPrimitives","err"],(function(t,n,r,o,a,i,l){"use strict";var e=null;function s(t){var n=e;e=[];try{return t()}finally{(e!=null?e:[]).forEach(function(e){return void e.fill(0)}),e=n}}function u(t,n){if(e==null)throw r("err")("allocate called outside of active scope");return new t(n)}function c(e,t,n){o("WACryptoPrimitives").lowlevel.crypto_hash(e,t,n)}function d(e,t){for(var n=0;n<64;++n)t[n]=e[n],e[n]=0;_(e,t),t.fill(0)}function m(e,t){var n=[p(),p(),p(),p()];o("WACryptoPrimitives").lowlevel.scalarbase(n,t),j(e,n)}function p(e){var t=u(Float64Array,16);if(e){if(e.length>16)throw r("err")("Incorrect initialiser array provided to the fieldElement");for(var n=0;n<e.length;n++)t[n]=e[n]}return t}function _(e,t){o("WACryptoPrimitives").lowlevel.modL(e,t)}var f=function(){return p([0])},g=function(){return p([1])},h=function(){return p([2])},y=function(){return p([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139])};function C(){return[p(),p(),p(),p()]}function b(){return[p(),p(),p(),p()]}function v(){return[p(),p(),p()]}function S(e,t){for(var n=0,r=t;r>0;){var o=r%65536;e[n]=o,r=(r-o)/65536,n++}}function R(e,t){return Q(e,t)?0:1}function L(e){var t=o("WACryptoPrimitives").lowlevel.pack25519,n=u(Uint8Array,32);return t(n,e),n[0]&1}function E(e,t){var n=o("WACryptoPrimitives").lowlevel.M,r=o("WACryptoPrimitives").lowlevel.S,a=h(),i=p();r(i,t),n(e,a,i)}function k(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.S,i=f(),l=g(),s=p(),u=p(),c=p(),d=p();S(i,486662),a(s,t),r(u,i,t),n(c,s,u),n(d,c,l),r(e,t,d)}function I(e,t,n){n===1&&e.set(t)}var T=new Uint8Array([176,160,14,74,39,27,238,196,120,228,47,173,6,24,67,47,167,215,251,61,153,0,77,43,11,223,193,79,128,36,131,43]);function D(e,t){var n,r=(n=o("WACryptoPrimitives")).lowlevel.M,a=n.lowlevel.S,i=n.lowlevel.pow2523,l=n.lowlevel.unpack25519,s=p();l(s,T);var u=p();i(u,t);var c=p();r(c,t,u);var d=p();a(d,c);var m=p();r(m,c,s),I(c,m,1^R(d,t)),e.set(c)}function x(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.Z,i=g(),l=p(),s=p(),u=p();a(l,t,i),n(s,t,i),K(u,s),r(e,l,u)}function $(e,t){var n=o("WACryptoPrimitives").lowlevel.Z,r=f();n(e,r,t)}function P(e,t){var n=o("WACryptoPrimitives").lowlevel.M;n(e[0],t[0],t[3]),n(e[1],t[1],t[2]),n(e[2],t[2],t[3])}function N(e,t){var n=o("WACryptoPrimitives").lowlevel.M;n(e[0],t[0],t[3]),n(e[1],t[1],t[2]),n(e[2],t[2],t[3]),n(e[3],t[0],t[1])}function M(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.S,a=o("WACryptoPrimitives").lowlevel.Z;r(e[0],t[0]),r(e[2],t[1]),E(e[3],t[2]),n(e[1],t[0],t[1]);var i=p();r(i,e[1]),n(e[1],e[2],e[0]),a(e[2],e[2],e[0]),a(e[0],i,e[1]),a(e[3],e[3],e[2])}var w=new Uint8Array([6,126,69,255,170,4,110,204,130,26,125,75,209,211,161,197,126,79,252,3,220,8,123,210,187,6,160,96,244,237,38,15]);function A(e,t,n){var r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.unpack25519,i=p();a(i,w);var l=p();x(l,t);var s=p();k(s,t);var u=p();D(u,s);var c=p();r(c,t,i);var d=p();K(d,u);var m=p();r(m,c,d);var _=p();$(_,m),I(m,_,L(m)^n),e[0].set(m),e[1].set(l),e[2].set(g()),r(e[3],e[0],e[1])}function F(e,t){e[0].set(t[0]),e[1].set(t[1]),e[2].set(t[2])}function O(e,t){var n=v();F(n,t),M(e,n)}function B(e,t){var n=b(),r=v();O(n,t),P(r,n),M(n,r),P(r,n),M(n,r),N(e,n)}function W(e){var t,n=(t=o("WACryptoPrimitives")).lowlevel.M,r=t.lowlevel.S,a=t.lowlevel.pack25519,i=t.lowlevel.pow2523,l=p(),s=p(),u=p(),c=p(),d=p();i(l,e),r(s,l),r(u,s),n(c,u,e),n(d,c,e);var m=new Uint8Array(32);return a(m,d),1&m[31]}function q(e,t){$(e[0],t[0]),e[1].set(t[1]),e[2].set(t[2]),$(e[3],t[3])}function U(e,t){var n=C(),r=X(n,t);return r!==0?-1:(q(e,n),0)}function V(e,t){var n=o("WACryptoPrimitives").lowlevel.A,r=o("WACryptoPrimitives").lowlevel.M,a=t,i=g(),l=f();S(l,486662);var s=p();E(s,a);var u=p();n(u,s,i);var c=p();K(c,u);var d=p();r(d,c,l);var m=p();$(m,d);var _=p();k(_,m);var h=W(_),y=p([0]);I(y,l,h);var C=p();n(C,m,y);var b=p();$(b,C),I(C,b,h),e.set(C)}function H(e){var t=o("WACryptoPrimitives").lowlevel.unpack25519,n=o("WACryptoPrimitives").hash(e),r=(n[31]&128)>>7;n[31]&=127;var a=p();t(a,n);var i=p();G(i,a);var l=C();A(l,i,r);var s=C();return B(s,l),s}function G(e,t){return s(function(){return V(e,t)})}function z(e){return s(function(){return H(e)})}function j(e,t){var n=p(),r=p(),a=p(),i=o("WACryptoPrimitives").lowlevel.M,l=o("WACryptoPrimitives").lowlevel.pack25519;K(a,t[2]),i(n,t[0],a),i(r,t[1],a),l(e,r);var s=new Uint8Array(32);l(s,n),e[31]^=(s[0]&1)<<7}function K(e,t){var n=p();n.set(t);for(var r=o("WACryptoPrimitives").lowlevel.M,a=o("WACryptoPrimitives").lowlevel.S,i=253;i>=0;--i)a(n,n),i!==2&&i!==4&&r(n,n,t);e.set(n)}function Q(e,t){var n=o("WACryptoPrimitives").lowlevel.crypto_verify_32,r=o("WACryptoPrimitives").lowlevel.pack25519,a=new Uint8Array(32),i=new Uint8Array(32);return r(a,e),r(i,t),n(a,0,i,0)}function X(e,t){var n,r=(n=o("WACryptoPrimitives")).lowlevel.A,a=n.lowlevel.D,i=n.lowlevel.M,l=n.lowlevel.S,s=n.lowlevel.Z,u=n.lowlevel.pow2523,c=n.lowlevel.set25519,d=n.lowlevel.unpack25519,m=p(),_=p(),h=p(),C=p(),b=p(),v=p(),S=p();return c(e[2],g()),d(e[1],t),l(h,e[1]),i(C,h,a),s(h,h,e[2]),r(C,e[2],C),l(b,C),l(v,b),i(S,v,b),i(m,S,h),i(m,m,C),u(m,m),i(m,m,h),i(m,m,C),i(m,m,C),i(e[0],m,C),l(_,e[0]),i(_,_,C),Q(_,h)&&i(e[0],e[0],y()),l(_,e[0]),i(_,_,C),Q(_,h)?-1:(Y(e[0])===t[31]>>7&&s(e[0],f(),e[0]),i(e[3],e[0],e[1]),0)}function Y(e){var t=o("WACryptoPrimitives").lowlevel.pack25519,n=new Uint8Array(32);return t(n,e),n[0]&1}l.runInAllocationScope=s,l.allocate=u,l.hashSha512=c,l.reduce=d,l.scalarmultBase=m,l.fieldElement=p,l.modL=_,l.p3Element=C,l.unpack=U,l.elligator=G,l.hashToPoint=z,l.pack=j,l.inv25519=K,l.unpackneg=X}),98);
__d("WASignalSignatures",["Promise","WACryptoDependencies","WACryptoEd25519","WACryptoPrimitives","WAHex","WALongInt","WASignalKeys","WASignalLocalStorageProtocol.pb","WASignalOther","decodeProtobuf","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("WACryptoEd25519").runInAllocationScope(function(){var r,a=t.length,i=e.privateKey,l=new Uint8Array(32);(r=o("WACryptoEd25519")).scalarmultBase(l,i);var s=l[31]&128,u=new Uint8Array(a+128);u[0]=254,u.fill(255,1,32),u.set(i,32),u.set(t,64),u.set(n,a+64);var c=r.allocate(Uint8Array,64);r.hashSha512(c,u,a+128),u.set(l,32);var d=r.allocate(Float64Array,64);r.reduce(c,d),r.scalarmultBase(u,c);var m=r.allocate(Uint8Array,64);r.hashSha512(m,u,a+64),r.reduce(m,d);var p,_;for(p=0;p<32;++p)d[p]=c[p];for(p=0;p<32;++p)for(_=0;_<32;++_)d[p+_]+=m[p]*i[_];return r.modL(u.subarray(32,64),d),{pubKeyNegative:s!==0,signedMsg:u}})}function u(t,r){return(e||(e=n("Promise"))).resolve().then(function(){var e=o("WASignalOther").makeBytes(64);return o("WACryptoDependencies").getCrypto().getRandomValues(e),d(t,r,e)})}function c(e,t,n){var r=n[63];return r&96?!1:o("WACryptoEd25519").runInAllocationScope(function(){var a,i,l=(a=o("WACryptoPrimitives")).lowlevel.A,s=a.lowlevel.M,u=a.lowlevel.Z,c=a.lowlevel.pack25519,d=a.lowlevel.unpack25519,m=(i=o("WACryptoEd25519")).allocate(Uint8Array,64);m.set(n),m[63]=r&127;var p=i.fieldElement(),_=i.fieldElement(),f=i.fieldElement(),g=i.fieldElement(),h=i.fieldElement(),y=i.allocate(Uint8Array,32),C=i.fieldElement();return C[0]=1,d(p,e.subarray(1)),u(_,p,C),l(f,p,C),i.inv25519(g,f),s(h,_,g),c(y,h),y[31]=y[31]&127|r&128,a.signDetachedVerify(t,m,y)})}function d(e,t,n){var r=s(e,t,n),a=o("WASignalOther").sliceBytes(r.signedMsg,0,64);return a[63]=a[63]&127|(r.pubKeyNegative?128:0),a}function m(e,t,n){var a=o("WASignalKeys").makeKeyPair(),i=o("WASignalOther").makeBytes(64);o("WACryptoDependencies").getCrypto().getRandomValues(i);var l=d(n,o("WASignalKeys").serializePubKey(a),i);if(!Number.isSafeInteger(t))throw r("err")("Expected timestamp to be a safe integer, given "+String(t));return{id:o("WASignalKeys").castToPreKeyId(e),ts:t,keyPair:a,signature:l}}function p(e,t){var n=o("WASignalOther").makeBytes(64);return o("WACryptoDependencies").getCrypto().getRandomValues(n),d(e,t,n)}function _(e){var t=e.id,n=e.keyPair;return o("WASignalOther").encodeSignalProto(o("WASignalLocalStorageProtocol.pb").SignedPreKeyRecordStructureSpec,{id:t,publicKey:o("WASignalKeys").serializePubKey(n),privateKey:n.privateKey,signature:e.signature,timestamp:e.ts})}function f(e){try{var t=o("decodeProtobuf").decodeProtobuf(o("WASignalLocalStorageProtocol.pb").SignedPreKeyRecordStructureSpec,e),n=t.id,r=t.privateKey,a=t.publicKey,i=t.signature,l=t.timestamp;return n==null||a==null||r==null||i==null||l==null?null:{id:o("WASignalKeys").castToSignedPreKeyId(n),ts:o("WALongInt").numberOrThrowIfTooLarge(l),keyPair:o("WASignalKeys").makeKeyPairFromSerialized(o("WASignalOther").toBytes(r,32),o("WASignalKeys").castToSerializedPubKey(new Uint8Array(a))),signature:o("WASignalOther").toBytes(i,64)}}catch(e){return null}}function g(e){return new Uint8Array(o("WAHex").parseHex(e))}function h(e){if(e.length===33)return o("WASignalKeys").castToSerializedPubKey(e);if(e.length===32)return o("WASignalKeys").serializeIdentity(e);throw r("err")("verifyCertificate publicKey incorrect length")}function y(t,r,o){return(e||(e=n("Promise"))).resolve().then(function(){var e=m(t,r,o),n=_(e);return{plainObject:e,record:n}})}l.signMsg=u,l.verifyMsgSignalVariant=c,l.makeSignature=d,l.makeSignedPreKey=m,l.signSenderKeyMessage=p,l.serializeSignedPreKeyForPrivateStorage=_,l.deserializeSignedPreKey=f,l.convertPublicKeyHexToUint8Array=g,l.convertPublicKeyToSerializedPubKey=h,l.generateSignedPreKey=y}),98);
__d("MAWCOPMessagesHandler",["FBLogger","LSMEBTaskCreationSource","LSMessagingThreadAttributionType","MAWBridge","MAWCommonScheduler","MAWDebugMsg","MAWExternalId","MAWIsQuotaExceededError","MAWJobDefinitions","MAWJobManager","MAWLoggerUtils","MAWMessageDropError","MAWMessageParseError","MAWMsgType","MAWODSProxy","MAWProtocolQueueDecodeProto","MAWProtocolQueueMsg","MAWProtocolQueueUtils","MAWQplProxy","MAWSendEphemeralSettingMsg","MAWSharedCOPLogger","MWSharedS2SBaseAnnotations","Promise","WACreateGroup","WAGlobals","WAHashUtils","WAJids","WAMsgMap","WAOdsEnums","WAProtocolQueue","WAQueryGroupInvite","WAQueryGroupsAndSync","WAResultOrError","WATimeUtils","WorkerScheduler","asyncToGeneratorRuntime","err","getErrorSafe","gkx","promiseDone","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(t,n){return n===void 0&&(n=r("LSMEBTaskCreationSource").UNKNOWN),h(t,n).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message consumer error"]))),[]})}function h(e,t){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if(e.length===0)return[];var n=new Set;R(e);var a=new(o("WAMsgMap")).MsgMap,i=new Map(e.map(function(i){var l=L(i),s=o("WAProtocolQueue").mapProcolQueueMessageV2toV1(l),u=s.incomingType==="ebrestore",c=o("MAWProtocolQueueUtils").startMetricForIncomingMsgV2(s,t);c.addAnnotations({int:{batchSize:e.length}});try{if(s.message.decrypted.type==="InstamadilloMsg"){if(r("gkx")("3577"))return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.IGDW_INSTAMADILLO_MESSAGE_ON_OLD_WORKER,key:"message"}),n.add(s.stanzaQueueId),c.endFail("instamadillo_msg_on_old_worker"),null;throw c.endFail("instamadillo_msg_not_supported_on_msgr"),r("FBLogger")("messenger_web").mustfixThrow("InstamadilloMsg is not supported in MSGR. Should never happen.}")}var m=o("MAWProtocolQueueDecodeProto").decodeMsg(s.message.decrypted,s.ebTimestampMs);return a.set(s.message.decrypted.id,s.incomingType),u&&(s.message.details.type=(m==null?void 0:m.unstoredDbReaction)!=null?"reaction":(m==null?void 0:m.unstoredXMA)!=null||(m==null?void 0:m.unstoredDbMedia)!=null?"media":"text"),[s.stanzaQueueId,o("MAWProtocolQueueUtils").addAnnotationsToMessage({decodedMsg:m!=null?m:void 0,stanza:babelHelpers.extends({},s)},c)]}catch(e){var p,_,f=e instanceof Error?e:r("err")("Unknown error");r("MAWSharedCOPLogger").catching(f).MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Decode error"])));var g=e instanceof o("MAWMessageParseError").MAWMessageParseError?e:null,h=e instanceof o("MAWMessageDropError").MAWMessageDropError;return h?(n.add(s.stanzaQueueId),c.addPoint("network_verification_msg_dropped"),c.endSuccess({string:{isDropped:"true"}}),null):(n.add(s.stanzaQueueId),c.endFail("decoding_error",{string:{errorDescription:(p=(_=g==null?void 0:g.message)!=null?_:f==null?void 0:f.message)!=null?p:"",isDropped:"true"}}),null)}}).filter(Boolean)),l=function(t,n){i.forEach(function(e){e.receiveFlow.addPoint(t,n)})};l("cop_him_start");var s=yield o("MAWProtocolQueueMsg").handleIncomingMessagesStanzas(Array.from(i.values()),t).catch(function(e){var t=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").catching(t).mustfix("COPMessagesHandler: Failed to handle batch"),i.forEach(function(e){e.receiveFlow.endFail("cop_him_fail",{string:{copHimError:t.message}})}),t});l("cop_him_end"),s.toAck.forEach(function(e){return n.add(e)});var u=e.map(function(e){var t=i.get(e.stanzaQueueId);if(t==null)return null;var r=t,o=s.followUpParams.incomingMsgResults.get(r.stanza.message.decrypted.id);return[r,n.has(e.stanzaQueueId),o]}).filter(Boolean);n.size!==e.length&&r("MAWSharedCOPLogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing messages batch, see transactor error reports."])));var c=new Map,f=new Set;return u.forEach(function(e){var n=e[0],i=e[1],l=e[2];if(n.receiveFlow.addPoint("consumer_handle_message_stanza_end",{bool:{dbSuccess:!!(l!=null&&l.success)}}),i){n.receiveFlow.addPoint("ack_received");var s=n.stanza.message.decrypted.type;s==="UnavailableMsg"||s==="IncomingCiphertextMsg"?n.receiveFlow.endFail(s):(n.stanza.message.details.type==="media"&&n.receiveFlow.addPoint("message_with_media"),n.receiveFlow.endSuccess())}if(!l&&!i){r("MAWSharedCOPLogger").MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Cannot find db result for message"]))),n.receiveFlow.endFail("db_result_not_found");return}if(l){if(l.success===!1){var u=l.error;switch(u.type){case"group_invite":{n.receiveFlow.endFail("end_with_db_error_group_invite"),c.set(u.groupJid,{folder:u.folder,inviteCode:u.inviteCode,inviteExpireTs:u.inviteExpireTs,inviterJid:u.inviterJid}),n.receiveFlow.endFail("need_group_invite");break}case"invalid_args":{n.receiveFlow.endFail("invlid_args");break}default:{n.receiveFlow.endFail(u.type);break}}return}if(l.success,l.value!=null){var d=l.value,m=d.msgType,g=d.outOfSyncEphemeralSetting,h=d.plaintextHashs,y=d.protocolMsgId,v=d.unknownGroup;if(v){var S=o("WAJids").interpretAsGroupJid(y.chat);S!=null&&f.add(S)}C(g,y);var R=n.stanza.message.details.from.author===o("WAGlobals").getMyDeviceJid(),L=t!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&(r("gkx")("20157")?!R:!0);L&&(h==null||h.forEach(function(e){var t;r("MAWSharedCOPLogger").DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Media: externalId="," - plaintextFollowUp - plaintextHash=",""])),n.stanza.message.details.externalId,o("WAHashUtils").sanitisePlaintextHash(e)),b({msgType:m,plaintextHash:e,protocolMsgId:y,source:(t=a.get(y))!=null?t:"wa-incoming"})}))}}}),v(f),S(c),Array.from(n)}),y.apply(this,arguments)}function C(e,t){e!=null&&(r("MAWSharedCOPLogger").tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.SettingSync]).DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleMsg: detected out-of-sync ephemeral setting for ",", sending EPHEMERAL_SYNC_RESPONSE"])),t==null?void 0:t.externalId),r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=o("MAWLoggerUtils").getInstanceKey(),n=o("MAWQplProxy").startQplUserFlow(r("qpl")._(25313175,"1551"),yield o("MWSharedS2SBaseAnnotations").getSendToSentBaseAnnotations(o("MWSharedS2SBaseAnnotations").getMessageTypeParams({isEphemeralSetting:!0}),r("LSMessagingThreadAttributionType").UNKNOWN),{providedInstanceKey:t});try{var a=yield o("MAWSendEphemeralSettingMsg").sendEphemeralSettingMsgFn({args:{ephemeralSetting:{ephemeralExpirationInSec:e.correctEphemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e.correctEphemeralLastUpdatedOrSetTimestamp},isEphemeralSettingReset:!1,isForSyncResponse:!0},chatJid:e.chatJid,externalId:o("MAWExternalId").generateExternalId(),qplEventType:r("qpl")._(25313175,"1551"),qplInstanceKey:t});if(a.success){if(n.endSuccess(),a.value!=null){var i=a.value;o("MAWBridge").getBridge().fireAndForget("event","handleMessageSendResult",{report:i,success:!0},!0)}}else n.endFail(a.error.type)}catch(e){var l,s=e instanceof Error?e:null;n==null||n.endFail("failed_to_send_empemeral_settings",{string:{errorDescription:(l=s==null?void 0:s.message)!=null?l:""}})}});function a(){return t.apply(this,arguments)}return a})(),name:"ephemeral_sync_response",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})))}function b(e){var t=e.msgType,n=e.plaintextHash,a=e.protocolMsgId,i=e.source;if(a!=null&&n!=null&&t!==o("MAWMsgType").MSG_TYPE.RAVEN){r("MAWSharedCOPLogger").tags(["downloadAndHandleMedia"]).DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Scheduling job for ",", plaintextHash: ",""])),String(a),o("WAHashUtils").sanitisePlaintextHash(n));var l=i==="ebrestore"?"EBRestore":"WAIncomingMsg";o("MAWJobManager").getJobManager().fireAndForget(o("MAWJobDefinitions").jobSerializers.downloadAndHandleMedia(a,n,l,t,"fullsizeAndPreview",null))}}function v(e){e.size!==0&&r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:Array.from(e)})}catch(e){throw r("MAWSharedCOPLogger").catching(r("getErrorSafe")(e)).MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]))),e}});function a(){return t.apply(this,arguments)}return a})(),name:"queryGroup",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}))}function S(e){if(e.size===0)return;r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return t()},name:"queryGroupInvite",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}));function t(){return a.apply(this,arguments)}function a(){return a=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield(f||(f=n("Promise"))).all(Array.from(e.entries()).map(function(e){var t=e[0],n=e[1],r=n.inviteCode,a=n.inviteExpireTs,i=n.inviterJid;return o("WAQueryGroupInvite").queryGroupInvite(t,r,a,i).catch(function(e){return o("WAResultOrError").makeError()})})),r=t.map(function(e){if(e.success===!0){var t={extras:null,folder:null,groupStatus:"added",groupToCreate:e.value,key:null,serverTs:o("WATimeUtils").unixTime()};return t}return null}).filter(Boolean);yield o("WACreateGroup").createGroups(r)}),a.apply(this,arguments)}}function R(e){if(r("gkx")("23915"))for(var t of e)t.subtype==="ciphertext"&&o("MAWDebugMsg").writeDebugMsg(t.jid,"Message "+t.stanzaId+" has decryption error: "+t.decryptionError+" from user "+t.from,{decryptionError:t.decryptionError,protocolMsgId:{author:o("WAGlobals").getMyDeviceJid()===t.from?"@me":o("WAJids").extractUserJid(t.from),chat:t.jid,externalId:t.stanzaId}})}function L(e){if(e.message==null||e.message.type!=="ephemeral")return e;var t=e.serverTs;return e.message.ephemeralLastUpdatedOrSetTimestamp=e.message.ephemeralLastUpdatedOrSetTimestamp===o("WATimeUtils").DEFAULT_UNIXTIME?t:e.message.ephemeralLastUpdatedOrSetTimestamp,e}l.copIncomingMsgsHandler=g}),98);
__d("MAWGroupInfoStore",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadThreadsTxns","MAWThreadManagementTxns","MAWTransactionMode","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){if(e!=null&&typeof e=="object"&&e.groupStatus!=null&&typeof e.groupStatus=="string")return e.groupStatus}function u(e){if(e!=null&&typeof e=="object"&&e.clientThreadKey!=null&&typeof e.clientThreadKey=="string")return e.clientThreadKey}function c(e){if(e!=null&&typeof e=="object"&&e.folder!=null&&typeof e.folder=="number")return e.folder}function d(e){if(e!=null&&typeof e=="object"&&e.updateParticipantMedatadata!=null&&typeof e.updateParticipantMedatadata=="boolean")return e.updateParticipantMedatadata}function m(e){return e===null?{}:e}var p=(function(){function e(e){var t=this;this.get=function(e,n){var r=c(n);return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWThreadManagementTxns").getGroupThread(t.db,e,r).then(function(e){return e!=null?e:null}).then(function(e){return e==null?o("WAResultOrError").makeError("missing_group"):o("MAWLoadThreadsTxns").loadContentsForThreads(t.db,[e.thread],1,null,"getGroupInfoStore").then(function(){return e.groupInfo}).then(function(e){return o("WAResultOrError").makeResult(_(e))})}))},this.create=function(e,n){var r=s(n)==="added"?o("WATimeUtils").millisTime():o("WATimeUtils").castUnixTimeToMillisTime(e.creationTs);return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWGetOrCreateThreadTxns").getOrCreateThread(t.db,{clientThreadKey:u(n),createTs:r,description:"MAWGroupInfoStore-create",folder:o("MAWFolderTypes").FOLDER_ID.INBOX,jid:e.jid}).then(function(n){var r=n.created,a=n.thread,i=f(e);return o("MAWDexieTable").dexieAll([t.db.groupInfo.put(i),o("MAWDbMsgTxns").getThreadNewestMessageId(t.db,a.jid)]).then(function(e){var t=e[0],n=e[1];o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(i)})}).then(function(){return a.archived===!0?o("MAWDbThreadTxns").unarchiveThreads(t.db,[a.jid]):o("MAWDexieTable").dexieResolve()}).then(function(){return r?o("WAResultOrError").makeResult(i.groupJid):o("WAResultOrError").makeError("existing")})}))},this.delete=function(e){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDexieTable").dexieAll([t.db.threads.get({jid:e}),t.db.groupInfo.delete(e)]).then(function(e){var n=e[0];return n==null?o("WAResultOrError").makeError("missing_group"):o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").deleteThread(t.db,n.jid),t.db.participants.where("threadJid").equals(n.jid).delete()]).then(function(){return o("WAResultOrError").makeResult()})}))},this.update=function(e,n,r){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(t.db.threads.get({jid:e}).then(function(a){return a==null?o("WAResultOrError").makeError("missing_group"):t.db.groupInfo.get(e).then(function(e){if(e==null)return o("WAResultOrError").makeError("missing_group");var i=_(e),l=n(i),s=f(l);return t.db.groupInfo.put(s).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(s)}),d(r)===!0&&o("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:o("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(a.jid)}),o("WAResultOrError").makeResult()})})}))},this.clear=function(){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(t.db.groupInfo.clear())},this.db=e}var t=e.prototype;return t.has=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.groupInfo.get(t).then(function(e){return e!=null}))},e})();p.tableLocks={chunk:(e=o("MAWTransactionMode")).READONLY,editMsgHistory:e.READONLY,groupInfo:e.READWRITE,groupInvites:e.READONLY,media:e.READONLY,messages:e.READWRITE,participants:e.READWRITE,poll:e.READONLY,reactions:e.READONLY,receiverFetchInfo:e.READONLY,threads:e.READWRITE,xma:e.READONLY};function _(e){return babelHelpers.extends({jid:e.groupJid},m(e.creator!=null?{creator:e.creator}:null),{creationTs:e.creationTs},m(e.participantVersion!=null?{participantVersion:e.participantVersion}:null),{inviter:e.inviter,memberAddMode:e.memberAddMode,subject:babelHelpers.extends({content:e.name},m(e.nameOwner!=null?{user:e.nameOwner}:null),m(e.nameTs!=null?{ts:e.nameTs}:null))})}function f(e){var t=e.subject.content;return t!=null&&t.length===0&&(t=void 0),{creationTs:e.creationTs,creator:e.creator,groupJid:e.jid,inviter:e.inviter,memberAddMode:e.memberAddMode,name:t,nameOwner:e.subject.user,nameTs:e.subject.ts,participantVersion:e.participantVersion}}l.MAWGroupInfoStore=p}),98);
__d("MAWMessageStore",["MAWAckLevel","MAWAuthor","MAWBridgeMsg","MAWDbMsgTxns","MAWDbThread","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWLocalizationUtils","MAWMsgType","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWWriteMsgTxns","WAJids","WALogger","WAResultOrError","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){if(e!=null&&typeof e=="object"&&e.optimisticMsg!=null){var t=e.optimisticMsg;if(typeof t.msgId=="string"&&typeof t.ts=="number")return{msgId:t.msgId,ts:t.ts}}}function c(e){if(e!=null&&typeof e=="object"&&e.openMessageOtid!=null&&typeof e.openMessageOtid=="string")return e.openMessageOtid}function d(e){if(e!=null&&typeof e=="object"&&e.folder!=null&&typeof e.folder=="number"){if(e.folder===o("MAWFolderTypes").FOLDER_ID.INBOX)return o("MAWFolderTypes").FOLDER_ID.INBOX;if(e.folder===o("MAWFolderTypes").FOLDER_ID.PENDING)return o("MAWFolderTypes").FOLDER_ID.PENDING;if(e.folder===o("MAWFolderTypes").FOLDER_ID.OTHER)return o("MAWFolderTypes").FOLDER_ID.OTHER;if(e.folder===o("MAWFolderTypes").FOLDER_ID.ARCHIVED)return o("MAWFolderTypes").FOLDER_ID.ARCHIVED}return null}var m=(function(){function t(e){this.db=e}var n=t.prototype;return n.create=function(t,n){var e=this,a=u(n),i=c(n),l=d(n);return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(this.db,t.id.chat,l,void 0,"MAWMessageStore_DEPRECATED-create").then(function(n){if(n==null)return o("WAResultOrError").makeError({type:"missing_thread"});var l=n.thread;if(t.type===o("MAWMsgType").MSG_TYPE.TEXT){var s,u=void 0;t.ephemeralSetting!=null&&(u={ephemeralExpirationInSec:t.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:t.ephemeralSetting.updatedTs});var c={ack:t.ack,altIndex:void 0,author:t.id.author,ephemeralSetting:u,externalId:t.id.externalId,forwardingScore:t.forwardingScore,isForwarded:t.forwardingScore>0,msgContent:{content:((s=t.msgContent)==null?void 0:s.content)||""},serverTs:t.serverTs,threadJid:l.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.TEXT};return o("MAWWriteMsgTxns").writeMsg(e.db,c,l,{openMessageOtid:i,optimisticMsg:a}).then(function(){return o("WAResultOrError").makeResult()})}else if(t.type===o("MAWMsgType").MSG_TYPE.ICDC_ALERT){var d={ack:t.ack,altIndex:void 0,author:t.id.author,externalId:t.id.externalId,msgContent:{adminType:t.msgContent.adminType,authorName:t.msgContent.authorName},serverTs:t.serverTs,threadJid:l.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.ICDC_ALERT};return o("MAWWriteMsgTxns").writeMsg(e.db,d,l,{openMessageOtid:i,optimisticMsg:a}).then(function(){return t.hasUnknownName&&!o("WAJids").isAuthorMe(t.id.author)&&!o("WAJids").isAuthorSystem(t.id.author)&&o("MAWIndexedDb").afterTransaction({tag:"SyncContacts",value:[o("WAJids").userIdFromJid(t.id.author)]}),o("WAResultOrError").makeResult()})}else if(t.type===o("MAWMsgType").MSG_TYPE.ADMIN){var m={ack:t.ack,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:t.id.externalId,msgContent:babelHelpers.extends({},t.msgContent,{version:o("MAWLocalizationUtils").isAdminMsgNormalized(t.msgContent.adminType)?1:0}),serverTs:t.serverTs,threadJid:l.jid,ts:t.ts,type:t.type};return o("MAWWriteMsgTxns").writeDedupedAdminMessage(e.db,m,l,o("WATimeUtils").castUnixTimeToMillisTime(t.ts)).then(function(){return o("WAResultOrError").makeResult()})}throw r("err")("non renderable store not implemented yet")}))},n.get=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDexieTable").dexieAll([this.db.threads.get({jid:t.chat}),this.db.messages.where("externalId").equals(t.externalId).toArray()]).then(function(e){var n,r=e[0],a=e[1];if(r==null)return o("MAWDexieTable").dexieResolve(null);var i=a.find(function(e){return e.threadJid===r.jid&&e.author===t.author});return i==null||i.type!=="Text"?o("MAWDexieTable").dexieResolve(null):o("MAWDexieTable").dexieResolve({ack:i.ack,forwardingScore:(n=i.forwardingScore)!=null?n:0,id:t,msgContent:{content:i.msgContent.content},ts:i.ts,type:i.type})}))},n.update=function(t){var e=this;return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDexieTable").dexieAll([this.db.threads.get({jid:t.id.chat}),this.db.messages.where("externalId").equals(t.id.externalId).toArray()]).then(function(n){var r=n[0],a=n[1];if(r==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing"));var i=a.find(function(e){return e.threadJid===r.jid&&e.author===t.id.author});if(i==null||i.type!=="Text")return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing"));var l=i.ack<o("MAWAckLevel").ACK.sent;i.ack=t.ack,i.ts=t.ts,i.serverTs=t.sentTs;var s=void 0;t.ephemeralSetting!=null&&(s={ephemeralExpirationInSec:t.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:t.ephemeralSetting.updatedTs}),i.ephemeralSetting=s;var u=t.sentTs,c=u==null?u:o("WATimeUtils").castUnixTimeToMillisTime(u),d=c!=null&&l?e.db.threads.put(babelHelpers.extends({},r,{newestMsgTs:c,threadOrder:o("MAWDbThread").craftThreadOrder(c,r.jid)})):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([e.db.messages.put(i),d]).then(function(){var e=null;return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(i,e)}),o("WAResultOrError").makeResult()})}))},n.deleteReactionsForMsg=function(t){var e=this;return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.reactions.where("reactToExternalId").equals(t.externalId).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===o("MAWAuthor").getAuthorUserJid(t.author)&&e.threadJid===t.chat}).toArray().then(function(t){return e.db.reactions.bulkDelete(t.map(function(e){return e.rowId}))}))},n.bulkDelete=function(n){var t=this,r=o("MAWDexieTable").dexieAll(n.map(function(e){var n=e.author,r=e.chat,a=e.externalId,i=o("MAWAuthor").getAuthorUserJid(n);return t.db.reactions.where("reactToExternalId").equals(a).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===i&&e.threadJid===r}).toArray()})).then(function(e){return e.flat()}).then(function(n){return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."])),n.length),t.db.reactions.bulkDelete(n.map(function(e){return e.rowId}))});return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,n).then(function(e){var n=e.map(function(e){return e.rowId});return o("MAWDexieTable").dexieAll([t.db.messages.bulkDelete(n),r]).then(function(){return n.length})}))},n.bulkGetInGroup=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.messages.where("threadJid").equals(t).toArray()).then(function(e){return e==null||e.length===0?[]:e.map(function(e){return{author:e.author,chat:t,externalId:e.externalId}})})},t})();m.tableLocks={chunk:(s=o("MAWTransactionMode")).READONLY,ftsBackloggedMessages:s.READWRITE,groupInfo:s.READWRITE,groupInvites:s.READONLY,media:s.READONLY,messages:s.READWRITE,participants:s.READWRITE,poll:s.READONLY,reactions:s.READWRITE,receiverFetchInfo:s.READONLY,threads:s.READWRITE,xma:s.READONLY},l.MAWMessageStore_DEPRECATED_DO_NOT_USE=m}),98);
__d("WAResultOrErrorUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[];return e.forEach(function(e){e.success&&t.push(e.value)}),t}function l(e){var t=[];return e.forEach(function(e){e.success||t.push(e.error)}),t}i.unpackValues=e,i.unpackErrors=l}),66);
__d("MAWParticipantsStore",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WAArrayGroupBy","WAArrayZip","WAGlobals","WAResultOrError","WAResultOrErrorUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){var e=this;this.bulkGetInGroup=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(e.db.threads.get({jid:t}).then(function(t){return t!=null?o("MAWDbParticipantTxns").getParticipantsInThread(e.db,t.jid).then(function(e){return o("WAResultOrError").makeResult(e.map(function(e){return s(e,t.jid)}))}):o("WAResultOrError").makeError("missing_group")}))},this.bulkPut=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d(e.db,t.map(function(e){var t=e.chatJid;return t})).then(function(e){return o("WAResultOrErrorUtils").unpackValues(t.map(function(t){return e.has(t.chatJid)?o("WAResultOrError").makeResult({participantId:o("MAWDbParticipant").craftParticipantId(t.chatJid,t.user),waParticipant:t}):o("WAResultOrError").makeError()}))}).then(function(t){return e.db.participants.bulkGet(t.map(function(e){var t=e.participantId;return t})).then(function(e){return o("WAArrayZip").zip(t,e).map(function(e){var t=e[0].waParticipant,n=e[1];return{chatJid:t.chatJid,dbParticipantToPut:babelHelpers.extends({deliveredWatermarkTs:o("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0)},n,u(t)),existed:n!=null,participant:t}})})}).then(function(t){var n=t.map(function(e){var t=e.dbParticipantToPut;return babelHelpers.extends({},t)});return n.forEach(function(e){return o("MAWDbParticipantTxns").logIfIllegalParticipant(e,"MAWParticipantsStore::bulkPut")}),e.db.participants.bulkPut(n).then(function(){return m(e.db,t)})}))},this.bulkDelete=function(t,n){var r=n||{},a=r.remover,i=o("WAArrayGroupBy").groupBy(t.map(function(e,t){return{index:t,key:e}}),function(e){var t=e.key;return t.groupJid}),l=i.map(function(e){var t=e[0];return t});return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d(e.db,l).then(function(e){return i.flatMap(function(t){var n=t[0],r=t[1];return r.map(function(t){var r=t.index,a=t.key;return e.has(n)?o("WAResultOrError").makeResult({groupJid:n,index:r,participantId:o("MAWDbParticipant").craftParticipantId(n,a.userJid),participantKey:[n,a.userJid],userJid:a.userJid}):o("WAResultOrError").makeError({index:r,message:"missing_group"})})})}).then(function(t){var n=o("WAResultOrErrorUtils").unpackValues(t),r=o("WAResultOrErrorUtils").unpackErrors(t).map(function(e){return o("WAResultOrError").makeError(e)}),a=n.map(function(e){var t=e.participantId;return t});return e.db.participants.bulkGet(a).then(function(e){return o("WAArrayZip").zip(n,e).map(function(e){var t=e[0],n=e[1];return n==null?o("WAResultOrError").makeError({index:t.index,message:"missing_participant"}):o("WAResultOrError").makeResult(t)}).concat(r)})}).then(function(t){var n=o("WAResultOrErrorUtils").unpackValues(t),r=n.map(function(e){var t=e.participantKey;return t}),i=n.map(function(e){var t=e.groupJid,n=e.userJid;return{groupJid:t,userJid:n}});return o("MAWDbParticipantTxns").bulkDeleteParticipants(e.db,r).then(function(){return p(e.db,i,a)}).then(function(){return t})}).then(function(e){return e.map(function(e){return e.success?{index:e.value.index,result:o("WAResultOrError").makeResult()}:{index:e.error.index,result:o("WAResultOrError").makeError(e.error.message)}}).sort(function(e,t){var n=e.index,r=t.index;return n-r}).map(function(e){var t=e.result;return t})}))},this.clear=function(){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(e.db.participants.clear())},this.db=t};e.tableLocks={participants:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE};function s(e,t){var n=e.addressable!=null?{addressable:e.addressable}:null;return babelHelpers.extends({chatJid:t,type:e.type,user:e.userJid},n)}function u(e){return{addressable:e.addressable,id:o("MAWDbParticipant").craftParticipantId(e.chatJid,e.user),threadJid:e.chatJid,type:e.type,userJid:e.user}}function c(e){return e.map(function(e){return e.user}).filter(function(e){return e===o("WAGlobals").getMyUserJid()||e==="@me"}).length>0}function d(e,t){var n=e.threads;return n.where("jid").anyOf(t).toArray().then(function(e){return new Set(e.map(function(e){var t=e.jid;return t}))})}function m(e,t){var n=t.filter(function(e){var t=e.existed;return!t}).map(function(e){var t=e.chatJid,n=e.participant;return{chatJid:t,participant:n}}),r=o("WAArrayGroupBy").groupBy(n,function(e){var t=e.chatJid;return t}).map(function(e){var t=e[0],n=e[1];return[t,n.map(function(e){var t=e.participant;return t})]});t.forEach(function(e){var t=e.dbParticipantToPut;o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:{participants:[o("MAWBridgeParticipants").createBridgeParticipant(t)]}})});var a=r.filter(function(e){var t=e[0],n=e[1];return c(n)}).map(function(e){var t=e[0];return t});return o("MAWDbThreadTxns").subscribeToThreads(e,a)}function p(e,t,n){var r=Array.from(t);r.forEach(function(e){var t=e.groupJid;return o("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:o("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(t)})});var a=new Set(r.filter(function(e){return e.userJid===o("WAGlobals").getMyUserJid()&&(n===o("WAGlobals").getMyUserJid()||n==="@me")}).map(function(e){return e.groupJid})),i=new Set(r.filter(function(e){var t=e.userJid;return t!==n&&(t===o("WAGlobals").getMyUserJid()||t==="@me")}).filter(function(e){var t=e.groupJid;return!a.has(t)}).map(function(e){var t=e.groupJid;return t}));return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").archiveThreads(e,Array.from(a),!0),o("MAWDbThreadTxns").unsubscribeFromThreads(e,Array.from(i))])}l.MAWParticipantsStore=e}),98);
__d("MAWRunInTransaction",["MAWDexie","MAWGroupInfoStore","MAWIndexedDb","MAWMessageStore","MAWParticipantsStore","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e={GroupInfoStore:o("MAWGroupInfoStore").MAWGroupInfoStore.tableLocks,MessagesStore:o("MAWMessageStore").MAWMessageStore_DEPRECATED_DO_NOT_USE.tableLocks,ParticipantsStore:o("MAWParticipantsStore").MAWParticipantsStore.tableLocks},s=function(n,a,i){var t=[];for(var l in n)n[l]===!0&&t.push(l);var s=t.flatMap(function(t){return Object.entries(e[t])}).reduce(function(e,t){var n,r=t[0],a=t[1];if(e[r]===o("MAWTransactionMode").READWRITE)return e;var i=r;return babelHelpers.extends({},e,(n={},n[""+i]=a,n))},{}),u=o("MAWIndexedDb").makeMsgrTransactor(s,i!=null?i:"runInTransaction",function(e){return function(){var t={CollectionVersionStore:null,GroupInfoStore:n.GroupInfoStore===!0?new(o("MAWGroupInfoStore")).MAWGroupInfoStore(e):null,MessagesStore:n.MessagesStore===!0?new(o("MAWMessageStore")).MAWMessageStore_DEPRECATED_DO_NOT_USE(e):null,MissingKeyStore:null,ParticipantsStore:n.ParticipantsStore===!0?new(o("MAWParticipantsStore")).MAWParticipantsStore(e):null,PendingMutationStore:null,SyncActionStore:null,SyncKeyStore:null};return new(r("MAWDexie")).Promise(function(e){e(a(t))})}});return u()};l.runInTransaction=s}),98);
__d("MAWAddGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"addGroupParticipants")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l,s){var u=e.GroupInfoStore,c=e.MessagesStore,d=e.ParticipantsStore,m=yield u.get(n);if(!m.success)return o("WAResultOrError").makeError("missing_group");var p=a.map(function(e){return{addressable:e.addressable,chatJid:n,type:e.type,user:e.user}});if(yield d.bulkPut(p),t!=null){var _=o("MAWAdminMsgHelpers").createParticipantAddAdminMessage(n,p.map(function(e){return e.user}),r,s);yield c.create(_),yield u.update(n,function(e){return babelHelpers.extends({},e,{participantVersion:t.current})},{updateParticipantMedatadata:i})}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l,s,u){return e.apply(this,arguments)}})();l.addGroupParticipants=e,l.addGroupParticipantsTransactor=s}),98);
__d("MAWChangeGroupMemberAddModeApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"changeGroupMemberAddMode")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i){var l=e.GroupInfoStore,s=e.MessagesStore,u=yield l.get(t);if(!u.success)return o("WAResultOrError").makeError("missing_group");if(yield l.update(t,function(e){return babelHelpers.extends({},e,{memberAddMode:r})}),i==="create_admin_message"){var c=o("MAWAdminMsgHelpers").createMemberAddModeChangeAdminMsg(t,r,n,a);c!=null&&(yield s.create(c))}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l){return e.apply(this,arguments)}})();l.changeGroupMemberAddMode=e,l.changeGroupMemberAddModeTransactor=s}),98);
__d("MAWChangeGroupParticipantAdminStatusApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"changeGroupParticipantAdminStatus")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var s=e.GroupInfoStore,u=e.MessagesStore,c=e.ParticipantsStore,d=yield s.get(n);if(!d.success)return o("WAResultOrError").makeError("missing_group");var m=a.map(function(e){return{addressable:e.addressable,chatJid:n,type:i,user:e.user}});if(yield c.bulkPut(m),t!=null){yield s.update(n,function(e){return babelHelpers.extends({},e,{participantVersion:t.current})});for(var p,_=0;_<m.length;_++)i==="admin"?p=o("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(n,m[_].user,r,l):p=o("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(n,m[_].user,r,l),yield u.create(p)}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l,s){return e.apply(this,arguments)}})();l.changeGroupParticipantAdminStatus=e,l.changeGroupParticipantAdminStatusTransactor=s}),98);
__d("MAWAdminWriteChangeParticipantsAdminMsgTxn",["FBLogger","MAWAdminAddParticipantMsg","MAWAdminRemoveParticipantMsg","MAWDbThreadTxns","MAWLocalizationUtils","MAWUserJidWrapper","MAWWriteMsgTxns","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return u(e,t,o("MAWAdminAddParticipantMsg").createAddParticipantsAdminMessage)}function s(e,t){return u(e,t,o("MAWAdminRemoveParticipantMsg").createRemoveParticipantsAdminMessage)}function u(e,t,n){var a=t.admin,i=t.chatJid,l=t.participants,s=t.serverTs;if(l.length===0)throw r("FBLogger")("messenger_web").mustfixThrow("invalid number of participants when writing participants change admin msg");return o("MAWDbThreadTxns").getThread(e,i).then(function(i){if(!i.success)throw r("FBLogger")("messenger_web").mustfixThrow("no thread when writing participants change admin msg");var u=i.value,c=o("MAWUserJidWrapper").getMyUserJid(),d=a==="@me"?c:a;if(d!=null){var m=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg(n(d,l),u.jid,t.externalId,s);return o("MAWWriteMsgTxns").writeMsg(e,m,u).then(r("emptyFunction"))}})}l.writeAddParticipantAdminMsg=e,l.writeRemoveParticipantAdminMsg=s}),98);
__d("MAWAdminWriteGroupNameChangeTxn",["MAWAdminWriteGroupNameChangeAdminMsgContent","MAWDexieTable","MAWExternalId","MAWLocalizationUtils","MAWWriteMsgTxns","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var a=t.name;if(a==null)return o("MAWDexieTable").dexieResolve();var i=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg(o("MAWAdminWriteGroupNameChangeAdminMsgContent").getAdminMsgContent(t.nameOwner,a),n.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castMillisTimeToUnixTime(o("WATimeUtils").millisTime()));return o("MAWWriteMsgTxns").writeMsg(e,i,n).then(r("emptyFunction"))}l.writeGroupNameChangeInfo=e}),98);
__d("MAWParticipantManagementTxns",["MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWUserJidWrapper"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("MAWDbParticipantTxns").getParticipantsInThread(e,t).then(function(r){if(n.length===0&&r.length===0)return{addedJids:[],participants:r,removedJids:[],typeUpdateJids:[]};var a=new Map;r.forEach(function(e){a.set(e.userJid,e)});var i=new Set(n.map(function(e){return e.userJid})),l=[],s=[],u=[],c=[];a.forEach(function(e,t){i.has(t)||(e.type!=="invitedParticipant"?l.push(t):(c.push({type:e.type,userJid:e.userJid}),u.push(babelHelpers.extends({},e))))}),n.forEach(function(e){var t=a.get(e.userJid);t==null?(s.push(e),e.type==="admin"&&c.push({type:e.type,userJid:e.userJid})):(t.type!==e.type&&c.push({type:e.type,userJid:e.userJid}),u.push(babelHelpers.extends({},t,e)))});var d=l.indexOf(o("MAWUserJidWrapper").getMyUserJid())>=0,m=function(){return[o("MAWDbParticipantTxns").bulkAddParticipants(e,t,s),o("MAWDbParticipantTxns").bulkUpdateParticipants(e,u),o("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(e,t,l),d?o("MAWDbThreadTxns").archiveThreads(e,[t],!0):o("MAWDexieTable").dexieResolve()]};return o("MAWDexieTable").dexieAll(m()).then(function(e){var t=e[0],n=e[1];return{addedJids:s.map(function(e){return e.userJid}),participants:[].concat(t,n),removedJids:l,typeUpdateJids:c}})})}l.syncParticipantList=e}),98);
__d("MAWGroupManagementTxns",["MAWAdminWriteChangeParticipantsAdminMsgTxn","MAWAdminWriteGroupNameChangeTxn","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWParticipantManagementTxns","MAWThreadManagementTxns","MAWUserJidWrapper","WATimeUtils","isGroupInvitesEnabled"],(function(t,n,r,o,a,i,l){"use strict";var e=["description","participants"];function s(e,t,n){return o("MAWDexieTable").dexieAll([o("MAWThreadManagementTxns").deleteAllThreadData(e,n),o("MAWDbGroupInfoTxns").deleteGroupInfo(e,t)]).then(function(e){var t=e[0];return t}).then(function(e){return e})}var u=function(n,a){var t=a.authoritativeThreadKey,i=a.deduplicationKey,l=a.extras,s=a.folder,u=a.groupStatus,c=a.groupToCreate,d=a.serverTs,m=u==="added"?o("WATimeUtils").unixTime():c.creationTs;return o("MAWGetOrCreateThreadTxns").getOrCreateThread(n,{authoritativeThreadKey:t,clientThreadKey:l==null?void 0:l.clientThreadKey,createTs:o("WATimeUtils").castUnixTimeToMillisTime(m),deduplicationKey:i,description:"createGroup",folder:s==null?o("MAWFolderTypes").FOLDER_ID.INBOX:s,jid:c.jid}).then(function(t){var a=t.created,i=t.thread,l=c.participants.map(function(e){return e.error?r("isGroupInvitesEnabled")()&&e.error.errorCode===403?{addressable:!0,type:"invitedParticipant",userJid:e.error.user}:null:{addressable:e.value.addressable,type:e.value.type,userJid:e.value.user}}).filter(Boolean),s=a?o("MAWDbParticipantTxns").bulkAddParticipants:o("MAWParticipantManagementTxns").syncParticipantList,m=s(n,i.jid,l),p=o("MAWUserJidWrapper").getMyUserJid(),_=u==="added"&&!a&&c.creator!==p?o("MAWAdminWriteChangeParticipantsAdminMsgTxn").writeAddParticipantAdminMsg(n,{admin:c.inviter,chatJid:i.jid,externalId:o("MAWExternalId").generateExternalId(),participants:[p],serverTs:d}):o("MAWDexieTable").dexieResolve(),f=c.description,g=c.participants,h=babelHelpers.objectWithoutPropertiesLoose(c,e);return o("MAWDexieTable").dexieAll([m,o("MAWDbGroupInfoTxns").putGroupInfo(n,h),_]).then(function(e){var t=e[0],r=e[1];return a&&u==="added"?o("MAWAdminWriteGroupNameChangeTxn").writeGroupNameChangeInfo(n,r,i):o("MAWDexieTable").dexieResolve()}).then(function(){return i.archived===!0?o("MAWDbThreadTxns").unarchiveThreads(n,[i.jid]):o("MAWDbThreadTxns").subscribeToThreads(n,[i.jid])}).then(function(e){return i.jid})})};l.deleteGroup=s,l.createGroupInternal=u}),98);
__d("MAWThreadTypes",["MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e,s={chunk:(e=o("MAWTransactionMode")).READWRITE,deletedMessages:e.READWRITE,editMsgHistory:e.READWRITE,groupInfo:e.READWRITE,groupInvites:e.READWRITE,media:e.READWRITE,messages:e.READWRITE,participants:e.READWRITE,pendingStanzas:e.READWRITE,reactions:e.READWRITE,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READWRITE};l.ThreadRelatedTablesPermissions=s}),98);
__d("MAWDeleteGroupsApi",["MAWDbThreadTxns","MAWDexieTable","MAWGroupManagementTxns","MAWIndexedDb","MAWThreadTypes","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor(o("MAWThreadTypes").ThreadRelatedTablesPermissions,"deleteGroups",function(e){return(function(t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.group;return o("MAWDbThreadTxns").getThread(e,n).then(function(t){return t.success?o("MAWGroupManagementTxns").deleteGroup(e,n,t.value).then(function(e){return o("WAResultOrError").makeResult({deletedGroupId:n,deletedMsgIds:e.deletedMessages})}):o("WAResultOrError").makeError("missing_thread")})})).then(function(e){return e})})});l.deleteGroupsFromMAW=e}),98);
__d("WADeleteGroupFollowUpLowLevelApi",["Promise","WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(r){return o("WASignalDB").getDb().runInTransaction(["senderKeySessions","personalSenderKeyStatuses"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){yield(e||(e=n("Promise"))).all([t.stores.senderKeySessions.readIndex("groupJid",[r]).then(function(e){return t.stores.senderKeySessions.bulkDelete(e.map(function(e){return e.id}))}),t.stores.personalSenderKeyStatuses.delete(r)])});return function(e){return t.apply(this,arguments)}})(),o("WASignalDB").signalOp("deleteGroupFollowUpLowLevel"))};l.deleteGroupFollowUpLowLevel=s}),98);
__d("MAWDeleteGroup",["MAWDeleteGroupsApi","Promise","WADeleteGroupFollowUpLowLevelApi","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){var i=yield o("MAWDeleteGroupsApi").deleteGroupsFromMAW(a.map(function(e){return{deleter:t,group:e}}));return(s||(s=n("Promise"))).all(i.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(!t.success)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["deleteGroups failed to delete group to a non-existent thread"])));else{var n=t.value,r=n.deletedGroupId,a=n.deletedMsgIds;yield o("WADeleteGroupFollowUpLowLevelApi").deleteGroupFollowUpLowLevel(r,a)}});return function(e){return t.apply(this,arguments)}})())).then(r("emptyFunction"))}),c.apply(this,arguments)}l.default=u}),98);
__d("MAWRemoveGroupInvitesApi",["MAWDbGroupInviteTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWIndexedDb").makeMsgrTransactor({groupInvites:o("MAWTransactionMode").READWRITE},"removeGroupInvites",function(t){return(function(n,r){return o("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(t,n,r).then(function(t){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["removeGroupInvites deleted "," record(s) from "," for ",""])),t,n,r),o("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:{threadJid:n}})}).then(function(){o("MAWIndexedDb").afterTransaction({tag:"GroupInviteLoaded",value:{actorId:r,threadJid:n}})})})});l.removeGroupInvites=s}),98);
__d("MAWRemoveGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAAPI","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"removeGroupParticipants").then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return e.success&&(yield r("WAAPI").setRotateSenderKeyToTrue([t[1]])),e});return function(t){return e.apply(this,arguments)}})())},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var s=e.GroupInfoStore,u=e.MessagesStore,c=e.ParticipantsStore,d=yield s.get(n);if(!d.success)return o("WAResultOrError").makeError("missing_group");var m=a.map(function(e){return e.user}),p=m.map(function(e){return{groupJid:n,userJid:e}});if(yield c.bulkDelete(p,{remover:r}),t!=null){var _=o("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(n,m,r,l);yield u.create(_),yield s.update(n,function(e){return babelHelpers.extends({},e,{participantVersion:t.current})},{updateParticipantMedatadata:i})}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l,s){return e.apply(this,arguments)}})();l.removeGroupParticipants=e,l.removeGroupParticipantsTransactor=s}),98);
__d("MAWUpdateGroupSubjectApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAJids","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"updateGroupSubject")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r,a=e.GroupInfoStore,i=e.MessagesStore,l=yield a.get(t);if(!l.success)return o("WAResultOrError").makeError("missing_group");var s=l.value;if(s.subject.ts!=null&&(n.ts==null||s.subject.ts>n.ts))return o("WAResultOrError").makeResult();yield a.update(t,function(e){return babelHelpers.extends({},e,{subject:n})});var u=yield a.get(s.jid);if(!u.success)return o("WAResultOrError").makeError("missing_group");var c=u.value,d=c.subject.user,m=o("MAWAdminMsgHelpers").createGroupNameChangeAdminMsg(t,c,d!=null?o("WAJids").userIdFromJid(d):void 0,(r=n.ts)!=null?r:o("WATimeUtils").unixTime());return m!=null&&(yield i.create(m)),o("WAResultOrError").makeResult()});return function(n,r,o){return e.apply(this,arguments)}})();l.updateGroupSubject=e,l.updateGroupSubjectTransactor=s}),98);
__d("MAWHandleGroupNotifications",["FBLogger","MAWAddGroupParticipantsApi","MAWChangeGroupMemberAddModeApi","MAWChangeGroupParticipantAdminStatusApi","MAWDeleteGroup","MAWRemoveGroupInvitesApi","MAWRemoveGroupParticipantsApi","MAWUpdateGroupSubjectApi","Promise","WAAPI","WACreateGroup","WAGlobals","WAResultOrError","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var a=t.notification;switch(a.type){case"join":return u(a).then(function(){return o("WAResultOrError").makeResult()});case"add":return d(a);case"remove":return m(a);case"promote":return _(a);case"demote":return p(a);case"delete":{var i=a.groupJid,l=a.participant;if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group delete notification without deleter JID: "+i);return r("MAWDeleteGroup")(l,[i]).then(function(){return o("WAResultOrError").makeResult()})}case"subject":return f(a).then(function(){return o("WAResultOrError").makeResult()});case"memberAddMode":return g(a);default:return a.type,(e||(e=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(!e.isE2EEMigration){var t=e.group,n=e.isNew,a=e.key,i=e.serverTs;yield o("WACreateGroup").createGroups([{extras:a!=null?{deduplicationKey:a,platform:"msgr"}:null,folder:null,groupStatus:n?"new":"added",groupToCreate:t,key:a,serverTs:i}]);var l=e.group.participants.map(function(e){return e.success?e.value.user:e.error.user}),s=o("WAGlobals").getMyUserJid();l.find(function(e){return e===s})&&(yield o("MAWRemoveGroupInvitesApi").removeGroupInvites(t.jid,s)),yield r("WAAPI").getDevices({ignoreDhash:!1,reason:"added-to-group",users:new Set(l)})}}),c.apply(this,arguments)}function d(e){var t=e.groupJid,n=e.participant,a=e.participants,i=e.previousVersionId,l=e.reason,s=e.serverTs,u=e.versionId;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group add participant notification without adder JID: "+t);return o("MAWAddGroupParticipantsApi").addGroupParticipants({current:u,previous:i},t,n,a,!1,l,s)}function m(e){var t=e.groupJid,n=e.participant,a=e.participants,i=e.previousVersionId,l=e.serverTs,s=e.versionId;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group remove participant notification without remover JID: "+t);var u=null;return s!=null&&(u={current:s,previous:i}),o("MAWRemoveGroupParticipantsApi").removeGroupParticipants(u,t,n,a,!1,l)}function p(e){var t=e.groupJid,n=e.participant,r=e.participants,a=e.previousVersionId,i=e.serverTs,l=e.versionId;return o("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:l,previous:a},t,n,r,"participant",i)}function _(e){var t=e.groupJid,n=e.participant,r=e.participants,a=e.previousVersionId,i=e.serverTs,l=e.versionId;return o("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:l,previous:a},t,n,r,"admin",i)}function f(e){var t=e.groupJid,n=e.participant,a=e.subject,i=e.ts;return o("MAWUpdateGroupSubjectApi").updateGroupSubject(t,{content:a,ts:i,user:n}).then(r("emptyFunction"))}function g(e){var t=e.groupJid,n=e.memberAddMode,r=e.participant,a=e.serverTs;return o("MAWChangeGroupMemberAddModeApi").changeGroupMemberAddMode(t,r,n,a,"create_admin_message")}l.persistGroupNotification=s}),98);
__d("MAWQueryGroupOverGraphQL",["E2EEMetadataMailboxFetchGroupInfoV3Mutation","FBLogger","WAJids","WAResultOrError","WATimeUtils","WmiOds","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{var t,n,a,i,l,s,u,c=yield o("E2EEMetadataMailboxFetchGroupInfoV3Mutation").fetchGroupInfoFromMIOverGraphQLV3({request_type:0,transport_thread_fbid:o("WAJids").groupIdFromJid(e)}),d=c==null?void 0:c.xfb_fetch_group_info_from_mi_v3;if(d==null||d.success!==!0)return o("WmiOds").wmiOdsBump("wa_query_group","fail"),o("WAResultOrError").makeError("QueryGroupInfoResponseServerError");var m=((t=d.participants)!=null?t:[]).map(function(e){var t,n;return{addressable:(t=e.is_addressable)!=null?t:!0,type:e.type==="E2EE_GROUP_PARTICIPANT_TYPE_ADMIN"?"admin":e.type==="E2EE_GROUP_PARTICIPANT_TYPE_SUPER_ADMIN"?"superadmin":"participant",user:o("WAJids").toMsgrUserJid((n=e.contact_id)!=null?n:"")}}),p={creationTs:o("WATimeUtils").castMilliSecondsToUnixTime(parseInt((n=d.creation_ts_ms)!=null?n:"0",10)),creator:d.creator_id!=null?o("WAJids").toMsgrUserJid(d.creator_id):void 0,jid:d.transport_thread_fbid!=null?o("WAJids").toGroupJid(d.transport_thread_fbid):e,memberAddMode:d.participant_update_mode==="OPEN"?"all_member_add":"admin_add",participants:m.map(function(e){return o("WAResultOrError").makeResult(e)}),participantVersion:d.participant_version_id!=null?String(d.participant_version_id):void 0,subject:{content:(a=(i=d.subject_change)==null?void 0:i.subject)!=null?a:"",ts:o("WATimeUtils").castMilliSecondsToUnixTime(parseInt((l=(s=d.subject_change)==null?void 0:s.subject_change_ts_ms)!=null?l:"0",10)),user:((u=d.subject_change)==null?void 0:u.subject_changer_id)!=null?o("WAJids").toMsgrUserJid(d.subject_change.subject_changer_id):void 0}};return o("WmiOds").wmiOdsBump("wa_query_group","ok"),o("WAResultOrError").makeResult(p)}catch(e){return o("WmiOds").wmiOdsBump("wa_query_group","fail"),r("FBLogger")("wmi").tags(["MiSOTGroupMetadataUpdate"]).catching(r("getErrorSafe")(e)).mustfix("Failed to query group info from MI"),o("WAResultOrError").makeError("QueryGroupInfoResponseServerError")}}),s.apply(this,arguments)}l.queryGroupOverGraphQL=e}),98);
__d("MAWQueryGroup",["MAWQueryGroupOverGraphQL","WAQueryGroupOverChatD","WAResultOrError","WmiOds","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.groupJid;return r("gkx")("7445")?o("MAWQueryGroupOverGraphQL").queryGroupOverGraphQL(t):s(t)}function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WAQueryGroupOverChatD").queryGroupOverChatD({groupJid:e});return t.success===!1?(o("WmiOds").wmiOdsBump("wa_query_group","fail"),o("WAResultOrError").makeError("QueryGroupInfoResponseServerError")):(o("WmiOds").wmiOdsBump("wa_query_group","ok"),o("WAResultOrError").makeResult(t.value))}),u.apply(this,arguments)}l.queryGroup=e}),98);
__d("WAParticipant",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"admin":case"superadmin":return!0;default:return!1}}i.isGroupAdminParticipantType=e}),66);
__d("WASyncParticipantsApi",["WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=e.ParticipantsStore,a=yield r.bulkGetInGroup(t);if(a.success!==!0)return o("WAResultOrError").makeError("missing_participants");if(n.length===0&&a.value.length===0)return o("WAResultOrError").makeResult({removedJids:[],addedJids:[],typeUpdateJids:[]});var i=new Map;a.value.forEach(function(e){i.set(e.user,e)});var l=new Set(n.map(function(e){return e.user})),s=[],u=[],c=[],d=[];return i.forEach(function(e,n){l.has(n)||(e.type!=="invitedParticipant"?s.push({userJid:n,groupJid:t}):(d.push({previousType:e.type,newType:e.type,userJid:e.user}),c.push(babelHelpers.extends({},e))))}),n.forEach(function(e){var t=i.get(e.user);t==null?(u.push(e),e.type==="admin"&&d.push({previousType:"nonparticipant",newType:e.type,userJid:e.user})):(t.type!==e.type&&d.push({previousType:t.type,newType:e.type,userJid:e.user}),c.push(babelHelpers.extends({},t,e)))}),yield r.bulkPut(u),yield r.bulkPut(c),yield r.bulkDelete(s),o("WAResultOrError").makeResult({removedJids:s.map(function(e){var t=e.userJid;return t}),addedJids:u.map(function(e){return e.user}),typeUpdateJids:d})});return function(n,r,o){return e.apply(this,arguments)}})();l.syncParticipantsTransactor=e}),98);
__d("MAWResetGroupParticipantInfoApi",["MAWAdminMsgHelpers","MAWRunInTransaction","Promise","WAAPI","WALogger","WAParticipant","WAResultOrError","WASyncParticipantsApi","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return c.apply(void 0,[e].concat(t))},"resetGroupParticipantInfo").then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return e.success&&(yield r("WAAPI").setRotateSenderKeyToTrue([t[0]])),e});return function(t){return e.apply(this,arguments)}})())},c=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a,i){var l=t.GroupInfoStore,u=t.MessagesStore,c=t.ParticipantsStore,d=a.map(function(e){return{addressable:e.addressable,chatJid:r,type:e.type,user:e.user}}),m=yield o("WASyncParticipantsApi").syncParticipantsTransactor({ParticipantsStore:c},r,d);if(i!=null){var p=yield l.update(r,function(e){return babelHelpers.extends({},e,{participantVersion:i})});if(!p.success)return p}if(m.success!==!0)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received an error when sync-ing participants"]))),m;var _=m.value,f=[];if(_.removedJids.length>0){var g=o("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(r,_.removedJids,null,o("WATimeUtils").unixTime());f.push(u.create(g))}if(_.addedJids.length>0){var h=o("MAWAdminMsgHelpers").createParticipantAddAdminMessage(r,_.addedJids,null,o("WATimeUtils").unixTime());f.push(u.create(h))}if(_.typeUpdateJids.length>0)for(var y=0;y<_.typeUpdateJids.length;y++){var C=_.typeUpdateJids[y].previousType,b=_.typeUpdateJids[y].newType,v=o("WAParticipant").isGroupAdminParticipantType(C),S=o("WAParticipant").isGroupAdminParticipantType(b),R=!v&&S,L=v&&!S;if(R){var E=o("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(r,_.typeUpdateJids[y].userJid,null,o("WATimeUtils").unixTime());f.push(u.create(E))}else if(L){var k=o("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(r,_.typeUpdateJids[y].userJid,null,o("WATimeUtils").unixTime());f.push(u.create(k))}}return(s||(s=n("Promise"))).all(f).then(function(){return o("WAResultOrError").makeResult()})});return function(n,r,o,a){return t.apply(this,arguments)}})();l.resetGroupParticipantInfo=u,l.resetGroupParticipantInfoTransactor=c}),98);
__d("MAWProtocolQueueGroupNotification",["FBLogger","MAWHandleGroupNotifications","MAWQueryGroup","MAWResetGroupParticipantInfoApi","Promise","WALogger","WAQueryGroupsAndSync","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e){var t=e.notification;return o("MAWHandleGroupNotifications").persistGroupNotification(e).then(function(e){return e.success?e:o("WAResultOrError").makeResult({errorResult:e,groupNotification:t})})}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=[];if(yield(m||(m=n("Promise"))).all(t.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{var n=yield o("MAWQueryGroup").queryGroup({groupJid:t});if(n.success===!1){var i;o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[ParticipantRecovery] Cannot get a group, as per ",""])),n.error),r("FBLogger")("messenger_web").mustfix("[ParticipantRecovery] Cannot get a group, as per %s",(i=n.error)!=null?i:"unknown");return}var l=n.value,c=l.participants.map(function(e){return e.error?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received a participant with an error"]))),null):e.value}).filter(Boolean),d=yield o("MAWResetGroupParticipantInfoApi").resetGroupParticipantInfo(t,c,l.participantVersion),m=d.error;!d.success&&m==="missing_group"&&a.push(t)}catch(e){o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to get group info"]))).devConsole(e)}});return function(e){return t.apply(this,arguments)}})())),a.length>0)try{yield o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:a})}catch(e){o("WALogger").DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]))).devConsole(e)}}),f.apply(this,arguments)}function g(e){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{yield o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:e})}catch(e){o("WALogger").DEV(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to recover missing group info"]))).devConsole(e)}}),h.apply(this,arguments)}l.handleProtocolQueueGroupNotification=p,l.doParticipantRecovery=_,l.doGroupRecovery=g}),98);
__d("MAWAdminWriteUsersConnectedMsgTxn",["MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","MessengerMSplitFlag","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n,a,i){var l=o("MAWUserJidWrapper").getMyUserJid();return n===l?(o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg is called for self thread"]))),o("MAWDexieTable").dexieResolve()):o("MAWDbThreadTxns").getThread(t,n).then(function(e){if(!e.success){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg failed to create or get 1:1 thread"])));return}var n=e.value,c=o("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(t,n.jid,function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN?!1:e.author===l||e.author===o("WAJids").AUTHOR_ME}),d=o("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(t,n.jid,function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN?!1:e.author!==l&&e.author!==o("WAJids").AUTHOR_ME});return o("MAWDexieTable").dexieAll([c,d]).then(function(e){var l=e[0],s=e[1];if(!l||!s){o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg found a thread without messages from both users, which we'll not append to."])));return}var c=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:r("MessengerMSplitFlag").is_msplit_account||a?o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT:o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED,version:1},n.jid,o("MAWExternalId").generateExternalId(),i);return o("MAWWriteMsgTxns").writeDedupedUsersConnectedAdminMessage(t,c,n).then(function(){var e=o("WAJids").interpretAsUserJid(n.jid);e!=null&&o("MAWIndexedDb").afterTransaction({tag:"UpdateContactAsConnected",value:{contactUserId:o("WAJids").extractUserId(e),threadJid:n.jid}})})})})}l.writeUsersConnectedAdminMsg=c}),98);
__d("MAWHandleConnectedAdminMsgApi",["MAWAdminWriteUsersConnectedMsgTxn","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MAWIndexedDb").makeMsgrTransactor({ftsBackloggedMessages:(s=o("MAWTransactionMode")).READWRITE,groupInfo:s.READONLY,messages:s.READWRITE,threads:s.READWRITE},"handleConnectedAdminMsg",function(t){return(function(n){var r=n.chatJid,a=n.isOtherContactMsplit,i=n.notificationTs;return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleConnectedAdminMsg: chat ",""])),r),o("MAWAdminWriteUsersConnectedMsgTxn").writeUsersConnectedAdminMsg(t,r,a,i)})});l.handleConnectedAdminMsg=u}),98);
__d("MAWUpdateThreadFolderApi",["MAWBridgeTypesCreators","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MAWIndexedDb").makeMsgrTransactor({threads:o("MAWTransactionMode").READWRITE},"updateThreadFolder",function(t){return(function(n,r){return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Update thread ",""])),n),o("MAWDbThreadTxns").getThread(t,n).then(function(e){if(e.success)return o("MAWDbThreadTxns").updateThread(t,babelHelpers.extends({},e.value,{folder:r})).then(function(t){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Update thread "," folder with folder id ",""])),e.value.jid,r),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:r,threadJid:e.value.jid})})})})})});l.updateThreadFolder=u}),98);
__d("MAWProtocolQueueNotification",["MAWBridge","MAWFolderTypes","MAWHandleConnectedAdminMsgApi","MAWODSProxy","MAWProtocolQueueGroupNotification","MAWUpdateThreadFolderApi","MWFBLogger","Promise","WAJids","WAOdsEnums","WAResultOrError","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MWFBLogger").MWLogger().tags(["ProtocolQueue"]);function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.stanzaId,a=e.notification,i=a.actions,l=a.chatJid,p=a.ts,_=o("WAJids").interpretAsUserJid(l),f=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersIsMsplit",{users:[_].filter(Boolean)});return(d||(d=n("Promise"))).all(i.map(function(e){switch(e.type){case"folder":{var r,a=(r=e.folderId)!=null?r:o("MAWFolderTypes").FOLDER_ID.INBOX;return m.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") with folder id ",", jid: ",""])),t,a,l),o("MAWUpdateThreadFolderApi").updateThreadFolder(l,a)}case"connected":{m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") connected, jid: ",""])),t,l);var i=_!=null&&f.get(_)===!0;return o("MAWHandleConnectedAdminMsgApi").handleConnectedAdminMsg({chatJid:l,isOtherContactMsplit:i,notificationTs:p})}default:return e.type,m.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") unknown thread action, jid: ",""])),t,l),(d||(d=n("Promise"))).reject("Handle thread notification: unknown thread action")}})).then(r("emptyFunction"))}),_.apply(this,arguments)}function f(e){return(d||(d=n("Promise"))).all(e.map(function(e){var t=e.notification,n=g(t);return n})).then(function(t){var n={groupRecoveries:[],participantRecoveries:[]},r=[];return t.map(function(t,o){if(t.success===!0&&(r.push(e[o].stanzaQueueId),t.value!=null)){var a=t.value;a.type==="group"&&n.groupRecoveries.push(a.data.groupNotification.groupJid)}}),{followUpParams:n,toAck:r}})}function g(t){switch(t.type){case"group":return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:t.type+"."+t.notification.type}),o("MAWProtocolQueueGroupNotification").handleProtocolQueueGroupNotification(t).then(function(e){return e.value?o("WAResultOrError").makeResult({data:e.value,type:"group"}):o("WAResultOrError").makeResult()});case"thread":return t.notification.actions.forEach(function(e){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:t.type+"."+e.type})}),p(t).then(function(){return o("WAResultOrError").makeResult()});default:return m.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received unsupported notification type: ",""])),t.type),(d||(d=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}l.handleIncomingNotificationStanzas=f}),98);
__d("MAWCOPNotificationsHandler",["MAWCommonScheduler","MAWIsQuotaExceededError","MAWProtocolQueueGroupNotification","MAWProtocolQueueNotification","MAWSharedCOPLogger","WorkerScheduler","asyncToGeneratorRuntime","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Notification consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueNotification").handleIncomingNotificationStanzas(e);t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing notifications batch, see transactor error reports."])));var a=t.followUpParams,i=a.groupRecoveries,l=a.participantRecoveries;return l.length>0&&r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return o("MAWProtocolQueueGroupNotification").doParticipantRecovery(l)},name:"ParticipantsRecovery",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})),i.length>0&&r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o("MAWProtocolQueueGroupNotification").doGroupRecovery(i)});function t(){return e.apply(this,arguments)}return t})(),name:"GroupsRecovery",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})),t.toAck}),d.apply(this,arguments)}l.copIncomingNotificationHandler=u}),98);
__d("MAWIncomingReceiptDataFormatTxns",["MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWMsgType","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e=["protocolMsgId"],s;function u(e){var t=e.author,n=e.chat,r=e.externalId;return n+"_"+r+"_"+t}function c(t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve();var r=new Map,a=new Set;n.forEach(function(e){var t=e.msgs;t.forEach(function(e){return a.add(babelHelpers.extends({},e))})});var i=o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").getMsgsByProtocolMsgId(t,Array.from(a)),o("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByProtocolMsgId(t,Array.from(a))]).then(function(e){var t=e[0],n=e[1],r=[];return t.forEach(function(e){return r.push({msg:e,renderType:"regular"})}),n.forEach(function(e){return r.push({msg:e,renderType:"unrendered"})}),{msgs:r}});return i.then(function(t){var a=t.msgs;n.forEach(function(e){var t=e.msgs,n=e.receivers,o=e.type;t.forEach(function(e){var t=u(e),a=r.get(t)||{deliveryReceipts:[],protocolMsgId:e,readReceipts:[],senderReceipts:[]};n.forEach(function(e){if(o==="read"||o==="read-self"){a.readReceipts.push(e);return}else if(o==="delivered"){a.deliveryReceipts.push(e);return}else if(o==="sender"){a.senderReceipts.push(e);return}else if(o==="inactive"){a.deliveryReceipts.push(e);return}}),r.set(t,a)})});var i=new Map,l=new Map,c=[];return a.forEach(function(t){var n=t.msg,a=n.author,c=n.externalId,d=n.msgId,m=n.threadJid,p=n.type;if(m==null){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to map the threadId of a message to its threadJid during receipt-writing"])));return}if(p!==o("MAWMsgType").MSG_TYPE.CIPHERTEXT){var _=u({author:a,chat:m,externalId:c}),f=r.get(_);if(f!=null){var g=f.protocolMsgId,h=babelHelpers.objectWithoutPropertiesLoose(f,e),y=babelHelpers.extends({msgId:d},h);l.set(d,y),r.delete(_)}}i.set(d,t)}),r.forEach(function(e){var t=e.deliveryReceipts,n=e.protocolMsgId,r=e.readReceipts;if(!(t.length===0&&r.length===0)){var o=n.author,a=n.chat,i=n.externalId;c.push({author:o,deliveryReceipts:t,externalId:i,readReceipts:r,thread:a})}}),{msgIdToDbMsgMap:i,pendingReceiptsToWrite:c,receiptsToWriteMap:l}})}l.prepareDataForReceiptsToWrite=c}),98);
__d("MAWIncomingReceiptUtils",["WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=new Map;return t.forEach(function(t){t.msgRenderType!=="unrendered"&&t.affectedUserJids.forEach(function(r){var a,i=t.receipt.statusTsPerUser.get(r);if(i==null){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["User "," is in affectedUserJids in receipt-writing results, but they have no corresponding read/delivery receipt entry in the DB"])),r);return}var l=[t.threadJid,r],s=n.get(JSON.stringify(l)),u=i.deliveredTs!=null,c=i.readTs!=null,d=u?t.msgTs:0,m=c?t.msgTs:0,p=(a=i.readTs)!=null?a:0;if(s!=null){var _=s.lastDeliveredMsgTs,f=s.lastReadMsgTs,g=s.lastReadActionTs;d=Math.max(d,_),m=Math.max(m,f),p=Math.max(p,g)}n.set(JSON.stringify(l),{lastDeliveredMsgTs:o("WATimeUtils").castToUnixTime(d),lastReadActionTs:o("WATimeUtils").castToUnixTime(p),lastReadMsgTs:o("WATimeUtils").castToUnixTime(m)})})}),new Map(Array.from(n).map(function(e){var t=e[0],n=e[1];return[JSON.parse(t),n]}))}l.getMaxTimestampsPerParticipant=s}),98);
__d("MAWAckAndTimestampUpdatesForReceiptsTxns",["MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIncomingReceiptUtils","MAWLoggerUtils","MWFBLogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.Countdown,o("MAWLoggerUtils").Tag.Incoming]);function u(t,n,a){var i=o("MAWIncomingReceiptUtils").getMaxTimestampsPerParticipant(n);s.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Updating timestamps for "," participants"])),i.size);var l=[];i.forEach(function(e,t){l.push({deliveredWatermarkTs:e.lastDeliveredMsgTs,lastReadActionTs:e.lastReadActionTs,lastReadWatermarkTs:e.lastReadMsgTs,participantKey:t})});var u=a.regular.length>0?o("MAWDbMsgTxns").bulkUpdateSystemAck(t,a.regular):o("MAWDexieTable").dexieResolve(),c=a.unrendered.length>0?o("MAWDbUnrenderedMsgTxns").bulkUpdateSystemAckForUnrenderedMsgs(t,a.unrendered):o("MAWDexieTable").dexieResolve(),d=o("MAWDexieTable").dexieAll([u,c]);return o("MAWDexieTable").dexieAll([d,l.length>0?o("MAWDbParticipantTxns").bulkUpdateParticipantTimestamps(t,l,s):o("MAWDexieTable").dexieResolve()]).then(r("emptyFunction"))}l.handleAckAndTimestampUpdatesForReceipts=u}),98);
__d("MAWDbPendingReceiptTxns",["WAJids","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=t.map(function(e){var t=e.author,n=e.externalId,r=e.thread;return o("WAMsg").craftWAMsgIdString({author:t,chat:r,externalId:n})});return e.pendingReceipts.where("id").anyOf(n).toArray().then(function(n){var r=new Map;n.forEach(function(e){r.set(e.id,e)});var a=t.map(function(e){var t=e.author,n=e.externalId,a=e.thread,i=o("WAMsg").craftWAMsgIdString({author:t,chat:a,externalId:n}),l=r.get(i),s=l!=null?l:{author:t,deliveryReceipts:[],externalId:n,id:i,readReceipts:[],thread:a};return t===o("WAJids").AUTHOR_ME?(e.deliveryReceipts.forEach(function(e){s.deliveryReceipts.push(e)}),e.readReceipts.forEach(function(e){s.readReceipts.push(e)})):(s.deliveryReceipts=[],e.readReceipts.forEach(function(e){s.readReceipts.push(e)})),s});return e.pendingReceipts.bulkPut(a).then(function(){return a})})}function s(e,t){return e.pendingReceipts.bulkGet(t)}l.bulkAddPendingReceipts=e,l.getPendingReceipts=s}),98);
__d("MAWIncomingReceiptDataFormatUtils",["MAWAckLevel","MAWDbMsg"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],r=[];return e.forEach(function(e){var a=null,i=e.receipt.msgId,l=e.receipt.statusTsPerUser,s=t.get(i);if(s!=null){var u=s.msg,c=s.renderType;e.affectedUserJids.forEach(function(e){var t,n,r=null;((t=l.get(e))==null?void 0:t.readTs)!=null?r=o("MAWAckLevel").ACK.read:((n=l.get(e))==null?void 0:n.deliveredTs)!=null&&(r=o("MAWAckLevel").ACK.received),a=a==null||r!=null&&r>a?r:a}),a!=null&&a>u.ack&&(c==="regular"?n.push({ack:a,msgId:i,reportingMeta:null}):r.push({ack:a,msgId:i}))}}),{regular:n,unrendered:r}}function s(e,t,n){return e.map(function(e){var r=t.get(e.receipt.msgId);if(r==null)return null;var a=r.msg,i=n.get(a.msgId);return i==null||i.deliveryReceipts.length===0&&i.readReceipts.length===0?null:babelHelpers.extends({},e,{externalId:a.externalId,msgRenderType:r.renderType,msgTs:o("MAWDbMsg").getCanonicalTsFromMsg(a),threadJid:a.threadJid})}).filter(Boolean)}l.createUpdateSystemAckParams=e,l.formatWriteReceiptResultsWithExtras=s}),98);
__d("MAWReceiptTrace",["ArmadilloDataTraceType","MAWBridgeTrace","MAWBridgeTraceEvent","MAWIndexedDb"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(e==="delivered"){var n=t.reduce(function(e,t){return t.externalId!=null?[].concat(e,[t.externalId]):e},[]);n.length>0&&o("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:o("MAWBridgeTrace").createBridgeUpdateTraceData(n,r("MAWBridgeTraceEvent").ReceivedReceipt,o("ArmadilloDataTraceType").armadilloMessageSend)})}}l.flushTrace=e}),98);
__d("MAWIncomingReceiptTxns",["MAWAckAndTimestampUpdatesForReceiptsTxns","MAWDbPendingReceiptTxns","MAWDbReceiptTxns","MAWDexieTable","MAWIncomingReceiptDataFormatUtils","MAWReceiptTrace"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=t.msgIdToDbMsgMap,r=t.pendingReceiptsToWrite,a=t.receiptsToWriteMap,i=Array.from(a.values());return o("MAWDexieTable").dexieAll([o("MAWDbReceiptTxns").bulkWriteReceiptsForDevices(i),o("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(e,r)]).then(function(t){var r=t[0],i=o("MAWIncomingReceiptDataFormatUtils").createUpdateSystemAckParams(r,n),l=o("MAWIncomingReceiptDataFormatUtils").formatWriteReceiptResultsWithExtras(r,n,a),s=l.filter(function(e){var t,n=((t=a.get(e.receipt.msgId))==null?void 0:t.deliveryReceipts)||[];return n.length>0});return s.length>0&&o("MAWReceiptTrace").flushTrace("delivered",s),o("MAWAckAndTimestampUpdatesForReceiptsTxns").handleAckAndTimestampUpdatesForReceipts(e,l,i)})}l.bulkHandleIncomingReceipts=e}),98);
__d("MAWWriteAppDataReceiptsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({appData:o("MAWTransactionMode").READWRITE},"writeAppDataReceipts",function(e){return(function(t){return s(e,t).then(function(t){return u(e,t)})})});function s(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve();var n=t.reduce(function(e,t){var n=e.appDataExternalIdSet,r=e.appDataReceiversSet,o=t.externalIds,a=t.receivers;return o.forEach(function(e){n.add(e)}),a.forEach(function(e){r.add(e)}),{appDataExternalIdSet:n,appDataReceiversSet:r}},{appDataExternalIdSet:new Set,appDataReceiversSet:new Set}),r=n.appDataExternalIdSet,a=n.appDataReceiversSet,i=Array.from(r),l=Array.from(a);return e.appData.where("externalId").anyOf(i).toArray().then(function(e){if(e.length!==0)return c(e,l)})}function u(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=t.toDelete,a=t.toUpdate;return o("MAWDexieTable").dexieAll([n.length>0?e.appData.bulkDelete(n):o("MAWDexieTable").dexieResolve(),a.length>0?e.appData.bulkPut(a):o("MAWDexieTable").dexieResolve()]).then(r("emptyFunction"))}function c(e,t){return e.reduce(function(e,n){if(n==null)return e;for(var r of t)n.permittedIdentitiesPerDevice.delete(r);return n.permittedIdentitiesPerDevice.size===0?(e.toDelete.push(n.appDataId),e):(e.toUpdate.push(n),e)},{toDelete:[],toUpdate:[]})}l.writeAppDataReceipts=e,l.prepareBulkAppDataReceipts=s,l.writeBulkAppDataReceipts=u}),98);
__d("MAWWritePeerMsgReceiptsApi",["MAWDbMsg","MAWDbMsgTxns","MAWDbPendingReceiptTxns","MAWDexieTable","MAWLoggerUtils","MAWMarkThreadAsReadTxns","MAWMsgType","MWFBLogger","WAGlobals","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(e){return e==null||e.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?{msg:t,readReceipt:n,type:"missing"}:{dbMsg:e,msg:t,readReceipt:n,type:"found"}})}function u(e){var t=e.map(function(e){return e.type==="missing"?null:e.dbMsg}).filter(Boolean);return t.reduce(function(e,t){var n=t.threadJid,r=o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(t)),a=e.get(n);return(a==null||r>a.msgSortOrderMs)&&e.set(n,{msgId:t.msgId,msgSortOrderMs:r}),e},new Map)}function c(t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve([]);var r=n.map(function(t){if(o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.PeerReceipt]).DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Processing "," receipt for messages not from me"])),t.type),t.type!=="delivered"){var n={device:void 0,ts:void 0};if(t.receivers.forEach(function(e){var t=e.device,r=e.ts,a=o("WAJids").extractUserJid(t);a===o("WAGlobals").getMyUserJid()&&(n.ts==null||r<n.ts)&&(n.device=t,n.ts=r)}),n.device!=null&&n.ts!=null)return babelHelpers.extends({},t,{receivers:{device:n.device,ts:n.ts}})}}).filter(Boolean),a=[];return r.forEach(function(e){e.msgs.forEach(function(t){a.push([t,e.receivers])})}),o("MAWDexieTable").dexieAll(a.map(function(e){var n=e[0],r=e[1];return s(t,n,r)}))}function d(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve();var n=[],a=[];t.map(function(e){e.type==="missing"?n.push({author:e.msg.author,deliveryReceipts:[],externalId:e.msg.externalId,readReceipts:[e.readReceipt],thread:e.msg.chat}):a.push({msgId:e.msg,ts:e.readReceipt.ts})});var i=u(t),l=t.reduce(function(e,t){var n=t.msg.chat,r=i.get(n);return r!=null&&e.set(n,{msgId:r.msgId,sortOrderMs:r.msgSortOrderMs}),e},new Map);return o("MAWDexieTable").dexieAll([o("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(e,n),o("MAWMarkThreadAsReadTxns").bulkMarkThreadAsReadUpToMsgSortOrderMs(e,l)]).then(r("emptyFunction"))}l.getResultByProtocolMsgId=s,l.prepareReceiptsForMeToWrite=c,l.bulkWritePeerReceiptsForMsgsNotFromMeInternal=d}),98);
__d("MAWBulkWriteReceiptsApi",["MAWDexieTable","MAWIncomingReceiptDataFormatTxns","MAWIncomingReceiptTxns","MAWIndexedDb","MAWTransactionMode","MAWWriteAppDataReceiptsApi","MAWWritePeerMsgReceiptsApi","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){var n=[],r=[],a=[];return t.forEach(function(e){switch(e.type){case"msg-receipt":n.push(e.params);break;case"not-from-me":r.push(e.params);break;default:a.push(e.params);break}}),o("MAWDexieTable").dexieAll([a.length>0?o("MAWWriteAppDataReceiptsApi").prepareBulkAppDataReceipts(e,a):o("MAWDexieTable").dexieResolve(),n.length>0?o("MAWIncomingReceiptDataFormatTxns").prepareDataForReceiptsToWrite(e,n):o("MAWDexieTable").dexieResolve(),r.length>0?o("MAWWritePeerMsgReceiptsApi").prepareReceiptsForMeToWrite(e,r):o("MAWDexieTable").dexieResolve([])]).then(function(e){var t=e[0],n=e[1],r=e[2];if(t==null)return{incomingReceiptData:n,processedPeerReceiptsNotForMeResults:r};var o=t.toDelete,a=t.toUpdate;return{appDataReceipts:{toDelete:o,toUpdate:a},incomingReceiptData:n,processedPeerReceiptsNotForMeResults:r}})}var u=o("MAWIndexedDb").makeMsgrTransactor({appData:(e=o("MAWTransactionMode")).READWRITE,chunk:e.READONLY,media:e.READONLY,messages:e.READWRITE,participants:e.READWRITE,pendingReceipts:e.READWRITE,receiverFetchInfo:e.READONLY,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READONLY},"bulkWriteReceipts",function(e){return(function(t){return t.length===0?o("MAWDexieTable").dexieResolve():s(e,t).then(function(t){var n=t.appDataReceipts,a=t.incomingReceiptData,i=t.processedPeerReceiptsNotForMeResults;return o("MAWDexieTable").dexieAll([n!=null&&(n==null?void 0:n.toDelete.length)>0&&(n==null?void 0:n.toUpdate.length)>0?o("MAWWriteAppDataReceiptsApi").writeBulkAppDataReceipts(e,n):o("MAWDexieTable").dexieResolve(),a!=null?o("MAWIncomingReceiptTxns").bulkHandleIncomingReceipts(e,a):o("MAWDexieTable").dexieResolve(),i.length>0?o("MAWWritePeerMsgReceiptsApi").bulkWritePeerReceiptsForMsgsNotFromMeInternal(e,i):o("MAWDexieTable").dexieResolve()]).then(r("emptyFunction"))})})});l.bulkWriteReceipts=u}),98);
__d("MAWSharedProtocolQueueReceipt",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";function e(e){if(e.receiptType==="appdata")return{params:{externalIds:e.externalIds,receivers:[e.from]},type:"appdata"};var t,n,r=e.chat;switch(e.receiptType){case"user":n=e.externalIds,t=[{device:e.from.author,ts:e.ts}];break;case"group":n=e.externalIds,t=[{device:e.from.author,ts:e.ts}];break;default:e.receiptType,n=[e.externalId],t=e.receivers;break}var o=e.messageAuthor,a=e.type;return o==="@me"||a==="sender"?{params:{msgs:n.map(function(e){return{author:"@me",chat:r,externalId:e}}),receivers:t,type:a},type:"msg-receipt"}:{params:{msgs:n.map(function(e){return{author:o,chat:r,externalId:e}}),receivers:t,type:a},type:"not-from-me"}}function l(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var r=t.map(function(t){var n=e(t.receipt);return n});return yield n(r),{followUpParams:void 0,toAck:t.map(function(e){return e.stanzaQueueId})}}),s.apply(this,arguments)}i.sharedHandleIncomingReceiptStanza=l}),66);
__d("WADbHandlePermitedIdentitiesApi",["MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"handlePermitedIdentitiesPerDevice",function(e){return(function(t){var n=Array.from(t.keys());return e.receipts.where("waMsgId").anyOf(n).toArray().then(function(e){return e.map(function(e){var n,r=(n=t.get(e.waMsgId))!=null?n:new Set;for(var o of r){var a;(a=e.permittedIdentitiesPerDevice)==null||a.delete(o)}return e})}).then(function(t){return e.receipts.bulkPut(t).then(function(){})})})});l.handlePermitedIdentitiesPerDevice=e}),98);
__d("WAPreKeysStanzaUtils",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;return(t=o("WAWap")).wap("key",null,t.wap("id",null,t.BIG_ENDIAN_CONTENT(e.id,3)),t.wap("value",null,e.keyPair.publicKey))}function s(e){var t;return(t=o("WAWap")).wap("skey",null,t.wap("id",null,t.BIG_ENDIAN_CONTENT(e.id,3)),t.wap("value",null,e.keyPair.publicKey),t.wap("signature",null,e.signature))}function u(e){var t=e.child("skey"),n=null;if(e.hasChild("key")){var r=e.child("key");n={id:r.child("id").contentUint(3),publicKey:r.child("value").contentSerializedPubKey()}}return{identity:e.child("identity").contentSerializedPubKey(),signedKey:{id:t.child("id").contentUint(3),publicKey:t.child("value").contentSerializedPubKey(),signature:t.child("signature").contentBytes(64)},oneTimeKey:n}}l.xmppPreKey=e,l.xmppSignedPreKey=s,l.readSessionInfo=u}),98);
__d("WASmaxInPreKeysIQErrorItemNotFoundMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","item-not-found");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",404);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorItemNotFoundMixin=e}),98);
__d("WASmaxInPreKeysRequestErrorsFetchDigest",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorItemNotFoundMixin","WASmaxInPreKeysIQErrorNotAcceptableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorNotAcceptableMixin").parseIQErrorNotAcceptableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorNotAcceptable",value:t.value});var n=o("WASmaxInPreKeysIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:n.value});var r=o("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(e);return r.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:r.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorNotAcceptable","IQErrorItemNotFound","IQErrorFallbackClient"],[t,n,r])}l.parseRequestErrorsFetchDigest=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrorsFetchDigest","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrorsFetchDigest").parseRequestErrorsFetchDigest(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrorsFetchDigest:i.value})):i}l.parseFetchDigestResponseRequestError=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseFetchDigestResponseServerError=e}),98);
__d("WASmaxInPreKeysKeysHashMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"hash");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(t.value,20,20);return n.success?o("WAResultOrError").makeResult({hashElementValue:n.value}):n}l.parseKeysHashMixin=e}),98);
__d("WASmaxInPreKeysPreKeyIDListMixin",["WAResultOrError","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"id");if(!t.success)return t;var n=o("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(e);return n.success,n}function s(t){var n=o("WASmaxParseUtils").flattenedChildWithTag(t,"list");if(!n.success)return n;var r=o("WASmaxParseUtils").mapChildrenWithTag(n.value,"id",0,2e4,e);return r.success?o("WAResultOrError").makeResult({listId:r.value}):r}l.parsePreKeyIDListListId=e,l.parsePreKeyIDListMixin=s}),98);
__d("WASmaxInPreKeysIdentityDigestBundleMixin",["WAResultOrError","WASmaxInPreKeysIdentityKeyMixin","WASmaxInPreKeysKeyTypeMixin","WASmaxInPreKeysKeysHashMixin","WASmaxInPreKeysPreKeyIDListMixin","WASmaxInPreKeysRegistrationIDMixin","WASmaxInPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysRegistrationIDMixin").parseRegistrationIDMixin(e);if(!t.success)return t;var n=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(e);if(!n.success)return n;var r=o("WASmaxInPreKeysPreKeyIDListMixin").parsePreKeyIDListMixin(e);if(!r.success)return r;var a=o("WASmaxInPreKeysSignedPreKeyMixin").parseSignedPreKeyMixin(e);if(!a.success)return a;var i=o("WASmaxInPreKeysKeyTypeMixin").parseKeyTypeMixin(e),l=o("WASmaxInPreKeysKeysHashMixin").parseKeysHashMixin(e);return l.success?o("WAResultOrError").makeResult(babelHelpers.extends({},t.value,n.value,r.value,a.value,{keyTypeMixin:i.success?i.value:null},l.value)):l}l.parseIdentityDigestBundleMixin=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseSuccess",["WAResultOrError","WASmaxInPreKeysIQResultResponseMixin","WASmaxInPreKeysIdentityDigestBundleMixin","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"digest");if(!r.success)return r;var a=o("WASmaxParseReference").optionalAttrStringFromReference(t,["digest","identity_type"]);if(!a.success)return a;var i=o("WASmaxParseUtils").optionalLiteral(o("WASmaxParseUtils").attrString,r.value,"identity_type",a.value);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityDigestBundleMixin").parseIdentityDigestBundleMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({hasDigestIdentityType:i.value!=null,digestIdentityDigestBundleMixin:l.value},s.value)):s}l.parseFetchDigestResponseSuccess=e}),98);
__d("WASmaxOutPreKeysFetchDigestRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"get"},o("WASmaxJsx").smax("digest",null)));return e}l.makeFetchDigestRequest=e}),98);
__d("WASmaxPreKeysFetchDigestRPC",["WAComms","WASmaxInPreKeysFetchDigestResponseRequestError","WASmaxInPreKeysFetchDigestResponseServerError","WASmaxInPreKeysFetchDigestResponseSuccess","WASmaxOutPreKeysFetchDigestRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WASmaxOutPreKeysFetchDigestRequest").makeFetchDigestRequest(),n=yield o("WAComms").sendSmaxStanza(t,e),r=o("WASmaxInPreKeysFetchDigestResponseSuccess").parseFetchDigestResponseSuccess(n,t);if(r.success)return{name:"FetchDigestResponseSuccess",value:r.value};var a=o("WASmaxInPreKeysFetchDigestResponseRequestError").parseFetchDigestResponseRequestError(n,t);if(a.success)return{name:"FetchDigestResponseRequestError",value:a.value};var i=o("WASmaxInPreKeysFetchDigestResponseServerError").parseFetchDigestResponseServerError(n,t);if(i.success)return{name:"FetchDigestResponseServerError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("FetchDigest",{Success:r,RequestError:a,ServerError:i}))}),s.apply(this,arguments)}l.sendFetchDigestRPC=e}),98);
__d("WARequestPreKeyDigestProtocol",["WABinary","WAConvertRegistrationIdMixin","WAConvertSignedPreKeyMixin","WACryptoDependencies","WACryptoUtils","WAParsableXmlNode","WAResultOrError","WASignalKeys","WASmaxPreKeysFetchDigestRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["requestPreKeyDigestProtocol"]);function c(t){return o("WASmaxPreKeysFetchDigestRPC").sendFetchDigestRPC({withoutRetry:!1}).then(function(n){switch(n.name){case"FetchDigestResponseServerError":{var r=n.value.errorServerErrors.name;return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,r),o("WAResultOrError").makeError({type:"server-error",payload:r})}case"FetchDigestResponseRequestError":{var a=n.value.errorRequestErrorsFetchDigest.name;return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,a),o("WAResultOrError").makeError({type:"request-error",payload:a})}default:{n.name;var i=d(n.value.digestIdentityDigestBundleMixin);return m(i,t).then(function(e){return e==="ok"?o("WAResultOrError").makeResult():o("WAResultOrError").makeError({type:"compare-error",payload:e})})}}})}function d(e){var t=o("WAConvertRegistrationIdMixin").registrationIdMixin(e),n=o("WAConvertSignedPreKeyMixin").convertSignedPreKeyMixin(e),r=e.listId.map(function(e){return o("WASignalKeys").castToPreKeyId(o("WAParsableXmlNode").convertBytesToUint(e.elementValue,3))}),a=e.hashElementValue;return{regId:t,skeyId:n.id,preKeyIds:r,hash:a}}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if(e.regId!==t.regInfo.regId)return"RegIdMismatch";if(e.skeyId!==t.signedPreKey.id)return"SignedPreKeyIdMismatch";var n=new Map;t.preKeys.forEach(function(e){return n.set(e.id,e)});var r=e.preKeyIds.some(function(e){return!n.has(e)});if(r)return"UnknownPreKey";var a=e.preKeyIds.map(function(e){return n.get(e)}).filter(Boolean),i=yield _(t,a);return o("WACryptoUtils").uint8ArraysEqual(i,e.hash)?"ok":"HashMismatch"}),p.apply(this,arguments)}function _(e,t){var n=new(o("WABinary")).Binary;return n.writeByteArray(e.regInfo.staticKeyPair.publicKey),n.writeByteArray(e.signedPreKey.keyPair.publicKey),n.writeByteArray(e.signedPreKey.signature),t.forEach(function(e){n.writeByteArray(e.keyPair.publicKey)}),o("WACryptoDependencies").getCrypto().subtle.digest("SHA-1",n.readByteArrayView()).then(function(e){return new Uint8Array(e)})}l.requestPreKeyDigestProtocol=c}),98);
__d("WARequestPreKeyDigest",["WABridge","WAGenerateAndUploadPreKeys","WAGetKeysForUpload","WAGlobals","WALogger","WAOdsEnums","WARequestPreKeyDigestProtocol","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t(function(e){var t=e.cryptoManager;return o("WAGetKeysForUpload").getKeysForUpload(t)}),a=yield o("WARequestPreKeyDigestProtocol").requestPreKeyDigestProtocol(n.value);if(a.success===!1){if(o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"fail"}),a.error.type==="compare-error"){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PreKey digest comparison failed: ",""])),a.error.payload),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys({reason:"prekey digest comparison failed"}).catch(function(e){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)});return}throw r("err")("Error while requesting key digest: "+a.error.type+" "+a.error.payload)}a.success,o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"success"})}),c.apply(this,arguments)}function d(){return u(function(e){return o("WAGlobals").getWaOneQueue().enqueue(e,{operationType:"request_prekey_digest",flush:!1})})}l.requestPreKeyDigestFn=u,l.requestPreKeyDigest=d}),98);
__d("WAReceiptUtils",["WACryptoManagerUtils","WADeprecatedSendIq","WAMapWithDefault","WAMsg","WAPreKeysStanzaUtils","WARequestPreKeyDigest","WAWap","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.retryCount,r=n+1;r>=3&&(yield o("WARequestPreKeyDigest").requestPreKeyDigestFn(function(e){return e(t)}));var a=null;r>=2&&(a=yield o("WACryptoManagerUtils").getSignalInfoForRetry(t.cryptoManager));var i=t.cryptoManager.regInfo.regId;return d(e,r,i,a)}),s.apply(this,arguments)}function u(e,t){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var r=t.externalId,a=t.from,i=t.participant,l;a.type==="group"?l=a.groupJid:(a.type,l=a.deviceJid),yield o("WADeprecatedSendIq").deprecatedSendStanzaAndWaitForAck(yield e(t,n),{id:r,class:"receipt",from:l,participant:i})}),c.apply(this,arguments)}function d(e,t,n,r){var a=null;if(r!=null){var i=r.keyType,l=r.preKey,s=r.publicKey,u=r.signedPreKey,c=e.deviceIdentity!=null?o("WAWap").wap("device-identity",null,e.deviceIdentity):null;a=o("WAWap").wap("keys",null,o("WAWap").wap("type",null,o("WAWap").BIG_ENDIAN_CONTENT(i,1)),o("WAWap").wap("identity",null,s),o("WAPreKeysStanzaUtils").xmppPreKey(l),o("WAPreKeysStanzaUtils").xmppSignedPreKey(u),c)}var d;return e.from.type==="group"?d=e.from.groupJid:(e.from.type,d=e.from.deviceJid),o("WAWap").wap("receipt",{category:e.category!=null?o("WAWap").CUSTOM_STRING(e.category):o("WAWap").DROP_ATTR,id:o("WAWap").CUSTOM_STRING(e.externalId),participant:e.participant?o("WAWap").DEVICE_JID(e.participant):o("WAWap").DROP_ATTR,recipient:e.recipient?o("WAWap").USER_JID(e.recipient):o("WAWap").DROP_ATTR,to:o("WAWap").JID(d),type:"retry"},o("WAWap").wap("retry",{count:o("WAWap").INT(t),id:o("WAWap").CUSTOM_STRING(e.externalId),t:o("WAWap").INT(e.ts),v:"1"}),o("WAWap").wap("registration",null,o("WAWap").BIG_ENDIAN_CONTENT(n)),a)}function m(e){var t=new(o("WAMapWithDefault")).MapWithDefault(function(e){return new Set});for(var n of e){var r=n.receipt;if(r.receiptType==="group"||r.receiptType==="user")for(var a of r.externalIds)t.get(o("WAMsg").craftWAMsgIdString({author:r.messageAuthor,chat:r.chat,externalId:a})).add(r.from.author);else if(r.receiptType==="group-server-agg")for(var i of r.receivers)t.get(o("WAMsg").craftWAMsgIdString({author:r.messageAuthor,chat:r.chat,externalId:r.externalId})).add(i.device)}return t.toMap()}l.makeRetryReceipt=e,l.sendRetryReceipt=u,l.calculateIdentitiesToDelete=m}),98);
__d("MAWProtocolQueueReceipt",["MAWBulkWriteReceiptsApi","MAWSharedProtocolQueueReceipt","WADbHandlePermitedIdentitiesApi","WAReceiptUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WADbHandlePermitedIdentitiesApi").handlePermitedIdentitiesPerDevice(o("WAReceiptUtils").calculateIdentitiesToDelete(e)).then(function(){return o("MAWSharedProtocolQueueReceipt").sharedHandleIncomingReceiptStanza(e,o("MAWBulkWriteReceiptsApi").bulkWriteReceipts)})}l.handleIncomingReceiptStanza=e}),98);
__d("MAWCOPReceiptsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueReceipt","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueReceipt").handleIncomingReceiptStanza(e);return t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing receipts batch, see transactor error reports."]))),t.toAck}),d.apply(this,arguments)}l.copIncomingReceiptsHandler=u}),98);
__d("MAWBulkGetAppDataForRetryApi",["MAWIndexedDb","MAWTransactionMode","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=30*o("WATimeUtils").DAY_SECONDS,s=o("MAWIndexedDb").makeMsgrTransactor({appData:o("MAWTransactionMode").READONLY},"bulkGetAppDataForRetry",function(t){return(function(n){var r=n.map(function(e){var t=e.externalId;return t});return t.appData.where("externalId").anyOf(r).toArray().then(function(t){var r=new Map(t.map(function(e){return[e.externalId,e]}));return n.map(function(t){var n=t.deviceJid,a=t.externalId,i=r.get(a);if(i==null)return{type:"missing"};var l=i.permittedIdentitiesPerDevice.get(n);return l==null||!o("WATimeUtils").happenedWithin(i.ts,e)?{type:"unauthorized"}:{appData:i.contents,deviceIdentity:l,permittedIdentitiesPerDevice:i.permittedIdentitiesPerDevice,type:"unacked"}})})})});l.bulkGetAppDataForRetry=s}),98);
__d("MAWWriteAppDataRetryApi",["MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({appData:o("MAWTransactionMode").READWRITE},"writeAppDataRetry",function(e){return(function(t,n,o){return e.appData.get({externalId:t}).then(function(t){if(t!=null){var a=t.permittedIdentitiesPerDevice,i=a.get(n);if(i!=null)return i.baseKey=o,a.set(n,i),e.appData.update(t.appDataId,{permittedIdentitiesPerDevice:a}).then(r("emptyFunction"))}})})});l.writeAppDataRetry=e}),98);
__d("WAMarkParticipantNeedsKeyApi",["WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,r){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=yield e.stores.personalSenderKeyStatuses.get(t);n==null||n.rotateSenderKey||(n.hasSenderKey.delete(r),yield e.stores.personalSenderKeyStatuses.bulkPut([n]))});return function(t){return e.apply(this,arguments)}})(),o("WASignalDB").signalOp("markParticipantNeedsKey"))};l.markParticipantNeedsKey=e}),98);
__d("WASendAppDataIndividualProtocol",["WAAsMessageApplication","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS(["sendAppDataIndividual"]);function _(t,n,r,a,i){return g(t,n,r,void 0,a,i).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return p.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to device with error: ",""])),n),o("WAResultOrError").makeError("runtime-error")})}function f(e,t,n,r,a,i){return g(e,t,n,r,a,i).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return p.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata retry to device with error: ",""])),t),o("WAResultOrError").makeError("runtime-error")})}function g(e,t,n,r,o,a){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i){p.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""])),t);var l=o("WAConvertAppData").convertAppData(e),s={bytes:o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,l).readByteArrayView()),version:"v3"},_=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WAEncUserMsg").encryptDeviceJidMessage(n,{messageBytes:s,type:"appdata"},{cryptoManager:t},void 0,i,a)},{operationType:"encrypt",flush:!0});if(_==null)return p.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["MAWSendAppData Failed to encrypt appdata"]))),o("WAResultOrError").makeError("encrypt-failure");var f;r!=null&&(f={appdataT:o("WATimeUtils").unixTime(),encRetryMixinArgs:{encCount:r}});var g={appdataTo:n,encVersionFutureproofMixinArgs:{encV:parseInt(_.v,10)},encTypeIndividualMixinArgs:{encType:_.type,encElementValue:_.ciphertext},retryMixinArgs:f},h={peerPeerSingle:g},y=void 0;if(_.type==="pkmsg"){var C=yield o("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo(),b=C==null?void 0:C.identityKey;if(b==null)return p.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"]))),o("WAResultOrError").makeError("no-public-identity");y={deviceIdentityElementValue:b}}var v={appdataId:t,peerMsgTypesArgs:h,deviceIdentityMixinArgs:y},S=yield o("WASmaxAppdataPublishPeerRPC").sendPeerRPC(v);switch(S.name){case"PeerResponseSuccess":return o("WAResultOrError").makeResult({baseKey:_.baseKey});default:return S.name,p.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""])),S.value.error),o("WAResultOrError").makeError("ack-failure")}}),h.apply(this,arguments)}l.sendAppDataToIndividualDeviceProtocol=_,l.sendAppDataRetryToIndividualDeviceProtocol=f}),98);
__d("WAWriteMsgRetryApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"writeMsgRetry",function(e){return(function(t,n,r){return s(e,o("WAMsg").craftWAMsgIdString({author:t.author,chat:t.chat,externalId:t.externalId}),n,r)})});function s(e,t,n,r){return e.receipts.get({waMsgId:t}).then(function(t){if(!(t==null||t.permittedIdentitiesPerDevice==null)){var o=t.permittedIdentitiesPerDevice,a=o.get(n);if(a!=null)return a.baseKey=r,o.set(n,a),e.receipts.put(babelHelpers.extends({},t,{permittedIdentitiesPerDevice:o})).then(function(){})}})}l.writeMsgRetry=e}),98);
__d("WAWriteMsgRetryCountApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"writeMsgRetryCount",function(e){return(function(t,n,r){return s(e,o("WAMsg").craftWAMsgIdString({author:t.author,chat:t.chat,externalId:t.externalId}),n,r)})});function s(e,t,n,r){return e.receipts.get({waMsgId:t}).then(function(t){var o;if(!(t==null||r==null)){var a=(o=t.retryCountsPerDevice)!=null?o:new Map;return a.set(n,r),e.receipts.put(babelHelpers.extends({},t,{retryCountsPerDevice:a})).then(function(){})}})}l.writeMsgRetryCount=e}),98);
__d("MAWSharedHandleRetryRequest",["MAWBulkGetAppDataForRetryApi","MAWConstants","MAWDebugMsg","MAWWriteAppDataRetryApi","Promise","QPLFlow","WACryptoManagerUtils","WACryptoUtils","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMarkParticipantNeedsKeyApi","WASendAppDataIndividualProtocol","WASendMsgInternal","WASentBytesCache","WAWap","WAWriteMsgRetryApi","WAWriteMsgRetryCountApi","asyncToGeneratorRuntime","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g;function h(){var e=0,t=0,n=new Map;return{getMetrics:function(){var r,o,a,i,l,s;return{appDataMissing:(r=n.get("appDatamissing"))!=null?r:0,appDataUnauthorized:(o=n.get("appDataunauthorized"))!=null?o:0,appDataUnsupported:(a=n.get("appDataunsupported"))!=null?a:0,msgMissing:(i=n.get("msgmissing"))!=null?i:0,msgUnauthorized:(l=n.get("msgunauthorized"))!=null?l:0,msgUnsupported:(s=n.get("msgunsupported"))!=null?s:0,receiptFailures:t,receiptSuccesses:e}},markError:function(){return t++},markSuccess:function(){return e++},setError:function(t){var e=n.get(t);e!=null?n.set(t,e+1):n.set(t,1)}}}function y(e,t){return t+"_"+e}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest called for ",""])),e.map(function(e){var t=e.externalId;return t}).join(","));var t=o("QPLFlow").startQPLFlow(r("qpl")._(25308942,"164"),{annotations:{bool:{bulk:!0},int:{receipts:e.length},string:{origin:self.location.origin}}}),a=new Set(e.filter(function(e){return e.category!=null&&!D(e)||x(e)}).map(function(e){return e.externalId})),i=e.filter(function(e){return!a.has(e.externalId)&&!D(e)}),l=e.filter(D),s=yield(g||(g=n("Promise"))).all([v(l),L(i)]),u=s[0],m=s[1];t.addPoint("get_msg_for_retry_complete");var p=[],_=h();for(var f of e){var C=u.get(f.externalId),b=m.get(y(f.from.author,f.externalId));a.has(f.externalId)?(t.addPoint("just_ack"),_.markError(),_.setError("just_ack"),$(f)):C!=null?(t.addPoint("app_data_for_retry"),yield P(f,C,t,!1,_),t.addPoint("app_data_for_retry_complete")):b!=null?(t.addPoint("msg_for_retry"),yield M(f,b,t,!1,_),t.addPoint("msg_for_retry_complete")):(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest unexpected receipt"]))),_.markError(),_.setError("unexpected_receipt")),p.push(T(f))}return t.endSuccess({int:babelHelpers.extends({},_.getMetrics())}),p}),b.apply(this,arguments)}function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return new Map;var t=e.map(function(e){var t=e.externalId,n=e.from;return{deviceJid:n.author,externalId:t}}),n=yield o("MAWBulkGetAppDataForRetryApi").bulkGetAppDataForRetry(t);return new Map(n.map(function(t,n){var r=e[n];return[r.externalId,t]}))}),S.apply(this,arguments)}function R(t){return t.map(function(t){var n=t.externalId,r=t.from,a=t.recipient,i=r.chat;if(r.type==="device"&&o("WAJids").extractUserJid(r.author)===o("WAJids").extractUserJid(o("WAGlobals").getMyDeviceJid())){if(a==null){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received retry request from peer without recipient set"])));return}i=a}var l={author:"@me",chat:i,externalId:n};return{deviceJid:r.author,protocolMsgId:l,retryCount:t.retryCount}})}function L(e){return E.apply(this,arguments)}function E(){return E=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return new Map;var t=R(e),n=e.filter(function(e,n){return t[n]!=null}),r=t.filter(Boolean),a=yield o("WASentBytesCache").sentBytesCache().getMsgsForRetry(r),i=new Map(a.map(function(e,t){return[y(r[t].deviceJid,n[t].externalId),{msgForRetry:e,retryRequest:r[t]}]}));return i}),E.apply(this,arguments)}function k(e,t){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=void 0,r=yield o("WAGlobals").getWaOneQueue().enqueue(function(t){var n=t.cryptoManager;return o("WACryptoManagerUtils").getParticipantInfo(e.from.author,n)},{flush:!1,operationType:"get_participant_info"});if(e.keys!=null){var a=e.keys,i=e.timestamp,l={baseKey:t.baseKey,keys:a,timestamp:i},s=A(e,r);s?n={session:l,type:"compareTSAndUseSession"}:n={session:l,type:"useSession"}}else{var u=r==null||e.regId!==r.regId;u&&(n={type:"requestNewSession"})}return n}),I.apply(this,arguments)}function T(e){var t,n=e.externalId,r=e.from;return(t=o("WAWap")).wap("ack",{class:"receipt",id:t.CUSTOM_STRING(n),participant:t.PARTICIPANT_JID(r),to:t.TO_JID(r),type:"retry"})}function D(e){var t=e.category;return t==="peer_appdata"||t==="peer"}function x(e){var t=e.retryCount;return t>=o("MAWConstants").MESSAGE_RETRY_COUNT_LIMIT}function $(e){if(x(e)){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied due to retry count"])));return}if(e.category!=null){o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Unknown receipt categories: ",""])),e.category);return}}function P(e,t,n,r,o){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a){r===void 0&&(r=!0);var i=e.externalId,l=e.from,s=e.retryCount;if(n.addPoint("get_app_data_for_retry"),t.type!=="unacked"){o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type "," id: ",""])),t.type,i),r?n.endFail(t.type):n.addPoint(t.type),a==null||a.markError(),a==null||a.setError("appData"+t.type);return}var u=t.appData,c=t.deviceIdentity,d=yield k(e,c);n.addPoint("get_session_info");var p=yield o("WASendAppDataIndividualProtocol").sendAppDataRetryToIndividualDeviceProtocol(u,i,l.author,s,c.pubKey,d);if(n.addPoint("send_app_data"),s>=2&&p.success===!0&&p.value.baseKey!=null){var _=p.value.baseKey;yield o("MAWWriteAppDataRetryApi").writeAppDataRetry(i,l.author,_)}return a==null||a.markSuccess(),p}),N.apply(this,arguments)}function M(e,t,n,r,o){return w.apply(this,arguments)}function w(){return w=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a,i){var l;a===void 0&&(a=!0);var s=t.msgForRetry,u=t.retryRequest,c=e.externalId,d=e.from,m=e.retryCount,g=u.protocolMsgId.chat;if(s.type!=="unacked"){a&&n.endFail(s.type),o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type ",""])),s.type),i==null||i.markError(),i==null||i.setError("msg"+s.type);return}if(s.retryCount!=null&&s.retryCount>0&&s.retryCount===m){a&&n.endFail("unauthorized"),o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because (messageId, deviceJID, retryCount) is already executed for retryCount ",""])),m),i==null||i.markError(),i==null||i.setError("msgunauthorized");return}d.type==="group"&&(yield o("WAMarkParticipantNeedsKeyApi").markParticipantNeedsKey(d.chat,d.author),n.addPoint("mark_participant_needs_key_complete"));var h=s.backupDirective,y=s.frankingKey,C=s.frankingVersion,b=s.isInstamadillo,v=s.messageBytes,S=s.messageType,R=s.protocolMsgId,L=s.serverTs,E=yield o("WALoadReceiptApi").loadReceipt({author:R.author,chat:R.chat,externalId:R.externalId}).then(function(e){return e.success?e.value:null}),I=E==null||(l=E.permittedIdentitiesPerDevice)==null?void 0:l.get(u.deviceJid);if(E==null||I==null){a&&n.endFail("unauthorized"),o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because receipt is null"]))),i==null||i.markError(),i==null||i.setError("msgunauthorized");return}var T=yield k(e,I);n.addPoint("get_session_info_complete"),r("gkx")("24021")&&o("MAWDebugMsg").writeDebugMsg(g,"Handling retry request for message: "+s.protocolMsgId.externalId.toString()+" to user "+d.author);var D=yield o("WAGenReportingMeta").genReportingMeta(v.bytes,y,C),x=L!=null?L*1e3:void 0,$=yield o("WASendMsgInternal").sendMessage({backupDirective:h,chat:g,count:m,deviceIdentity:null,externalId:c,identityKey:I.pubKey,messageBytes:v,messageType:S,originalMsgTimestampMs:x,protocolMsgId:R,reportingMeta:D,sessionInfo:T,to:d.author,type:"direct"},n,b);if(n.addPoint("send_message_complete"),m>=2&&$.success&&$.value.baseKey!=null){var P=$.value.baseKey;yield o("WAWriteMsgRetryApi").writeMsgRetry(u.protocolMsgId,d.author,P)}m>=1&&$.success&&(yield o("WAWriteMsgRetryCountApi").writeMsgRetryCount(u.protocolMsgId,d.author,m)),i==null||i.markSuccess()}),w.apply(this,arguments)}function A(e,t){if(e.offline==null)return!1;var n=t==null||e.regId!==t.regId,r=t!=null&&e.keys!=null&&!o("WACryptoUtils").uint8ArraysEqual(t.pubKey,e.keys.identity);return n||r}l.bulkHandleRetryRequest=C}),98);
__d("MAWCOPRetryHandler",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedHandleRetryRequest","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return u(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"]))),[]})}function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return e.length===0?[]:(yield o("MAWSharedHandleRetryRequest").bulkHandleRetryRequest(e.map(function(e){return e.retry})),e.map(function(e){return e.stanzaQueueId}))}),c.apply(this,arguments)}l.copIncomingRetryHandler=s}),98);
__d("MAWSplitProtocolEntityByType",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t={appdatas:[],instructions:[],messages:[],notifications:[],receipts:[],retries:[]};return e.forEach(function(e){switch(e.type){case"message":{t.messages.push(e);return}case"retryReceipt":{t.retries.push(e);return}case"appdata":{t.appdatas.push(e);return}case"notification":{t.notifications.push(e);return}case"receipt":{t.receipts.push(e);return}default:{t.instructions.push(e);return}}}),t}i.default=e}),66);
__d("WAParseMessageTransport",["WALogger","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return{version:"v3",type:"error",error:e}}function u(e,t){return e!=null&&(t.dsm==null||t.dsm.destinationJid==null||t.dsm.destinationJid!==e)}function c(t,n){var r=t.payload,a=t.protocol;if(r==null&&a==null)return s("There is no payload and protocol in the message transport");if(a==null)return s("There is no protocol part in the message transport");var i=a.integral;if(i==null)return s("There is no integral part in the message transport");if(i.padding==null)return s("There is no padding in the message transport");if(u(n,i))return s("The recipient does not match the device sent message recipient");if(o("decodeProtobuf").getUnknownFields(i)!=null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["There are unknown fields in the integral"]))),babelHelpers.extends({},s("There are unknown fields in the integral"),{futureProof:r==null?void 0:r.futureProof});if(r!=null){var l=r.applicationPayload;return l==null?s("There is no applicationPayload payload in the message transport"):{type:"applicationPayload",applicationPayload:l,skdm:m(a.ancillary),icdc:p(a.ancillary)}}var c=m(a.ancillary);return c!=null?{type:"skdm",skdm:c,icdc:p(a.ancillary)}:d(t)===!0?{type:"empty",version:"v3"}:{type:"unknown"}}function d(e){var t,n;if(e.payload!=null)return!1;if(e.protocol==null)return!0;var r=e.protocol,o=new Set(["$$unknownFieldCount","padding","backupDirective"]),a=Object.keys((t=r.integral)!=null?t:{}).filter(function(e){return!o.has(e)}),i=Object.keys((n=r.ancillary)!=null?n:{}).filter(function(e){return!o.has(e)});return i.length===0&&a.length===0}function m(e){return e==null?null:e.skdm}function p(e){return e==null?null:e.icdc}l.parseMessageTransport=c}),98);
__d("WADecodeIncomingMsg",["WALongInt","WAMsgApplication.pb","WAMsgTransport.pb","WAParseMessageApplication","WAParseMessageTransport","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return e.futureProof&&n!=null?{version:"v3",type:"futureProof",futureProof:e.futureProof,protobuf:t,applicationPayload:n,subtype:null}:{version:"v3",type:"error",error:e.error}}function s(t,n,r,a){if(n==="v2")return{version:"v2",encoded:t};if(n==="v3"){var i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgTransport.pb").MessageTransportSpec,t),l=o("WAParseMessageTransport").parseMessageTransport(i,r),s=m(i);if(l.type==="error")return e(l,t);if(l.type==="skdm")return u(l.skdm,l.icdc);if(l.type==="applicationPayload"){if(a===!0)return l.applicationPayload.payload==null?{version:"v3",type:"error",error:"instamadillo unhandled proto"}:{version:"v3",type:"instamadillo",applicationPayload:new Uint8Array(l.applicationPayload.payload),backupDirective:s};var d=c(l.applicationPayload,t,l.icdc,s);if(l.skdm!=null){var p=u(l.skdm,l.icdc);return{version:"v3",type:"msgWithSKDM",msg:d,skdm:p}}return d}else return l.type==="empty"?{version:"v3",type:"empty"}:(l.type,{version:"v3",type:"error",error:"unhandled proto with type "+l.type})}else return{type:"error",version:"v3",error:"decodeIncomingMsg called with unexpected encoding version: "+n}}function u(e,t){var n=e.axolotlSenderKeyDistributionMessage,r=e.groupId;return n==null?{type:"error",version:"v3",error:"parseSKDM called with null axolotlSenderKeyDistributionMessage"}:r==null?{type:"error",version:"v3",error:"parseSKDM called with null groupId"}:{version:"v3",type:"skdm",msg:{senderKey:n,groupId:r},icdc:t}}function c(t,n,r,a){var i,l=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgApplication.pb").MessageApplicationSpec,t.payload);if(l.payload==null)return d(l.metadata,t.payload);var s=o("WAParseMessageApplication").parseMessageApplication(l);return s.type==="error"?e(s,n):t.payload==null?e({error:"Empty application payload",type:"error",version:"v3"},n):{version:"v3",type:"subprotocol",metadata:(i=l.metadata)!=null?i:null,subprotocolType:s.subprotocolType,subprotocol:s.payload,applicationPayload:t.payload,protobuf:n,frankingContent:t.payload,backupDirective:a,icdc:r}}function d(e,t){var n=e==null?void 0:e.chatEphemeralSetting;if(n!=null){var r=n.ephemeralExpiration,a=n.ephemeralSettingTimestamp;if(r==null)return{version:"v3",type:"error",error:"Ephemeral setting without expiration"};if(t==null)return{error:"Empty application payload",type:"error",version:"v3"};try{var i,l=a!=null?o("WATimeUtils").castToUnixTime(o("WALongInt").numberOrThrowIfTooLarge(a)/1e3):o("WATimeUtils").DEFAULT_UNIXTIME;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:l,isEphemeralSettingReset:(i=n.isEphemeralSettingReset)!=null?i:!1,applicationPayload:t}}catch(e){var s;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").DEFAULT_UNIXTIME,isEphemeralSettingReset:(s=n.isEphemeralSettingReset)!=null?s:!1,applicationPayload:t}}}else return{version:"v3",type:"error",error:"MessageApplication has no payload and is not ephemeral"}}function m(e){var t,n=(t=e.protocol)==null||(t=t.ancillary)==null?void 0:t.backupDirective;if(n==null)return null;var r=n.actionType,a=n.messageId,i=n.supplementalKey;return a==null||r==null?null:{messageId:o("WAStanzaUtils").toStanzaId(a),actionType:r,supplementalKey:i}}l.decodeIncomingMsg=s,l.parseEphemeralSetting=d}),98);
__d("MawMpsPayloadToWaProtocolEntry",["FBLogger","MAWJids","MAWProtobufDeserializers","MAWUnsafeCoerce","MpsFutureProofKey","MpsTypes","WAArmadilloTransportEvent.pb","WADecodeIncomingMsg","WAFranking","WAFrankingTypes","WAJids","WAProtocolQueue","WAStanzaUtils","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return null}function s(e){return c(e.message.payload,e.message.messageId,e.message.threadId,e.message.senderId,e.message.timestampMs,e.insertionSource===o("MpsTypes").InsertionSource.Send?"wa-outgoing":"wa-incoming")}function u(e){var t=e.toplevelProtobuf,n=t.messageId,a=t.payload,i=t.senderId,l=t.threadId,s=t.timestampMs,u=c(a,n,l,i,s,"ebrestore"),d=e.supplementalProtobufs,m=Array.from(d.values()).map(function(e){var t,n=(t=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e.payload).proto.metadata)==null?void 0:t.senderId;if(n==null)return r("FBLogger")("mps").mustfix("Supplemental message has no senderId"),null;var a=c(e.payload,e.messageId,l,n,e.timestampMs,"ebrestore");return a});return[u].concat(m).filter(Boolean)}function c(t,n,r,a,i,l){var s=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),u=s.payload();switch(u.kind){case"messageApplication":{var c,d,m=u,p=m.subProtocol(),_;if(p==null){if(_=o("WADecodeIncomingMsg").parseEphemeralSetting(m.proto.metadata,u.bytes),_.type==="error")return null}else{var f,g;if(p.kind==="armadillo"&&((f=p.payload)==null?void 0:f.applicationData)!=null){var h=o("MAWUnsafeCoerce").unsafeCoerce(n);return{appdata:o("WAProtocolQueue").appdataApplicationProtocol({payload:m.bytes,version:3}),deviceJid:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),jid:o("MAWJids").threadIdToChatJid(r),priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaId:o("MpsTypes").messageIdToStanzaId(n),stanzaQueueId:h,type:"appdata"}}_={applicationPayload:m.bytes,backupDirective:null,frankingContent:m.bytes,icdc:null,metadata:(g=u.proto.metadata)!=null?g:null,protobuf:new Uint8Array(m.bytes),subprotocol:new Uint8Array(p.bytes),subprotocolType:p.kind==="armadillo"?"armadillo":"consumerMessage",type:"subprotocol",version:"v3"}}var y={contentType:e(m),fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),incomingType:l,jid:o("MAWJids").threadIdToChatJid(r),message:_,offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((c=s.proto.metadata)==null||(c=c.frankingMetadata)==null?void 0:c.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((d=s.proto.metadata)==null||(d=d.frankingMetadata)==null?void 0:d.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("MpsTypes").messageIdToStanzaId(n),subtype:"armadillo",type:"message"},C=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},y,{stanzaQueueId:C})}case"transportEvent":{var b=u;if(b.proto.event!=null){var v=b.proto.event;if(v.icdcAlert!=null){var S={instruction:"icdcError",jid:o("MAWJids").toUserJid(a),notificationTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,type:"instruction"},R=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},S,{stanzaQueueId:R})}if(v.deviceChange!=null)return}if(b.proto.placeholder!=null&&b.proto.placeholder.type!=null)switch(b.proto.placeholder.type){case o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE:{var L,E,k,I={contentType:null,decryptionError:"",fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),hideDecryptionFailure:((L=s.proto.metadata)==null?void 0:L.futureProofBehavior)===o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder,jid:o("MAWJids").threadIdToChatJid(r),offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((E=s.proto.metadata)==null||(E=E.frankingMetadata)==null?void 0:E.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((k=s.proto.metadata)==null||(k=k.frankingMetadata)==null?void 0:k.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("WAStanzaUtils").toStanzaId(n),subtype:"ciphertext",type:"message"},T=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},I,{stanzaQueueId:T})}case o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.UNAVAILABLE_MESSAGE:{var D,x,$={contentType:null,fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),jid:o("MAWJids").threadIdToChatJid(r),offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((D=s.proto.metadata)==null||(D=D.frankingMetadata)==null?void 0:D.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((x=s.proto.metadata)==null||(x=x.frankingMetadata)==null?void 0:x.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("WAStanzaUtils").toStanzaId(n),subtype:"unavailable",type:"message"},P=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},$,{stanzaQueueId:P})}}break}case"locallyTransformedMessage":break;case"adminMessage":{var N,M,w=u;if(w.proto.groupAdminChanged!=null||w.proto.groupMembershipAddModeChanged!=null||w.proto.groupParticipantChanged!=null)break;var A={content:w.proto,type:"admin"},F={contentType:null,fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),incomingType:l,jid:o("MAWJids").threadIdToChatJid(r),message:A,offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((N=s.proto.metadata)==null||(N=N.frankingMetadata)==null?void 0:N.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((M=s.proto.metadata)==null||(M=M.frankingMetadata)==null?void 0:M.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("MpsTypes").messageIdToStanzaId(n),subtype:"armadillo",type:"message"},O=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},F,{stanzaQueueId:O})}default:}}function d(e,t,n){var a=new Set(t);for(var i of e)!a.has(o("MAWUnsafeCoerce").unsafeCoerce(i.message.messageId))&&!n.has(i.message.messageId)&&n.set(i.message.messageId,r("err")("Ack not received"));return n}l.mpsIncomingPayloadToWAProtocolEntry=s,l.mpsFullMessageToMawPayload=u,l.mawAcksToMpsIncomingPayloadErrorMap=d}),98);
__d("MAWProtocolQueueProcess",["FBLogger","MAWCOPAppdataHandler","MAWCOPInstructionsHandler","MAWCOPMessagesHandler","MAWCOPNotificationsHandler","MAWCOPReceiptsHandler","MAWCOPRetryHandler","MAWDbMsgTxns","MAWSharedCOPLogger","MAWSplitProtocolEntityByType","MawMpsPayloadToWaProtocolEntry","MpsTypes","Promise","WAJids","WebMps","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=r("MAWSplitProtocolEntityByType")(t);r("MAWSharedCOPLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),a.messages.length,a.appdatas.length,a.notifications.length,a.receipts.length,a.retries.length,a.instructions.length);var i=(yield(m||(m=n("Promise"))).all([o("MAWCOPInstructionsHandler").copIncomingInstructionsHandler(a.instructions),o("MAWCOPReceiptsHandler").copIncomingReceiptsHandler(a.receipts),o("MAWCOPAppdataHandler").copIncomingAppdataHandler(a.appdatas),o("MAWCOPNotificationsHandler").copIncomingNotificationHandler(a.notifications),o("MAWCOPRetryHandler").copIncomingRetryHandler(a.retries)])).flat();return i}),_.apply(this,arguments)}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e,a=t.map(function(e){return{chat:o("WAJids").unsafeCoerceToChatJid(e.toplevelProtobuf.threadId),externalId:o("MpsTypes").messageIdToStanzaId(e.toplevelProtobuf.messageId)}}),i=yield o("MAWDbMsgTxns").checkMessagesExistenceByProtocolMsgIds(a);if(t=t.filter(function(e,t){return i[t]==null}),t.length===0){r("MAWSharedCOPLogger").DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MPS COP: All messages already exist in MAW DB, skipping"])));return}var l=t.map(function(e){try{return o("MawMpsPayloadToWaProtocolEntry").mpsFullMessageToMawPayload(e)}catch(n){var t=r("getErrorSafe")(n);return r("FBLogger")("COP").catching(t).mustfix("Failed to convert FullMessage %s to MAW payload",e.toplevelProtobuf.messageId),null}}).flat().filter(Boolean);r("MAWSharedCOPLogger").DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs"])),l.map(function(e){return e.stanzaId}).join(", "));var d=r("MAWSplitProtocolEntityByType")(l);r("MAWSharedCOPLogger").DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),d.messages.length,d.appdatas.length,d.notifications.length,d.receipts.length,d.retries.length,d.instructions.length),yield(m||(m=n("Promise"))).all([o("MAWCOPMessagesHandler").copIncomingMsgsHandler(d.messages),o("MAWCOPInstructionsHandler").copIncomingInstructionsHandler(d.instructions),o("MAWCOPAppdataHandler").copIncomingAppdataHandler(d.appdatas),o("MAWCOPNotificationsHandler").copIncomingNotificationHandler(d.notifications)])}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.filter(function(e){return e.directive!=null&&e.directive.isTransportErrorPlaceholder&&e.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel});if(t.length===0)return e;var a=(yield(m||(m=n("Promise"))).all(t.map(function(e){return o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"decryption-error-recovery-m3"},messageId:e.message.messageId,threadId:e.message.threadId}).then(function(e){return e.success===!0&&e.value!=null?e.value.toplevelProtobuf:null}).catch(function(e){return r("FBLogger")("mps").catching(e).mustfix("Failed to load message to recover decryption error"),null})}))).filter(Boolean);if(a.length===0)return e;var i=new Map;return a.forEach(function(e){var t=e.threadId,n=i.get(t);n==null&&(n=new Map,i.set(t,n)),n.set(e.messageId,e)}),e.map(function(e){var t,n=(t=i.get(e.message.threadId))==null?void 0:t.get(e.message.messageId);return n!=null?babelHelpers.extends({},e,{message:n}):e})}),y.apply(this,arguments)}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=new Map,a=yield h(e),i=a.map(function(e){try{return o("MawMpsPayloadToWaProtocolEntry").mpsIncomingPayloadToWAProtocolEntry(e)}catch(o){var n=r("getErrorSafe")(o);return r("FBLogger")("COP").catching(n).mustfix("Failed to convert incoming payload to MAW payload"),t.set(e.message.messageId,n),null}}).flat().filter(Boolean),l=r("MAWSplitProtocolEntityByType")(i);r("MAWSharedCOPLogger").DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),l.messages.length,l.appdatas.length,l.notifications.length,l.receipts.length,l.retries.length,l.instructions.length);var s=(yield(m||(m=n("Promise"))).all([o("MAWCOPMessagesHandler").copIncomingMsgsHandler(l.messages),o("MAWCOPInstructionsHandler").copIncomingInstructionsHandler(l.instructions),o("MAWCOPAppdataHandler").copIncomingAppdataHandler(l.appdatas),o("MAWCOPNotificationsHandler").copIncomingNotificationHandler(l.notifications)])).flat();return o("MawMpsPayloadToWaProtocolEntry").mawAcksToMpsIncomingPayloadErrorMap(a,s,t)}),b.apply(this,arguments)}l.processProtocolQueueEntries=p,l.processMPSFullMessageEntries=f,l.processMPSIncomingPayloadEntries=C}),98);
__d("MawCopScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("cop",{concurrency:1,maxTaskLimit:1,maxThrottleMs:1e5,timeoutMs:1e5})),e}l.copScheduler=s}),98);
__d("MAWSharedRestoreUnavailableMessages",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","WAGlobals","WAJids","setTimeout"],(function(t,n,r,o,a,i,l){"use strict";var e=1e4,s=new Map;function u(t){s.has(t.externalId)||(s.set(t.externalId,!0),r("setTimeout")(function(){var e=t.chat;o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(t.externalId,r("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,e)},e))}function c(e){e.forEach(function(e){if(e.type==="message"&&e.subtype!=null&&(e.subtype==="unavailable"||e.subtype==="ciphertext")){var t=o("WAJids").extractUserJid(e.from);u({author:o("WAGlobals").getMyUserJid()===t?"@me":t,chat:e.jid,externalId:e.stanzaId})}})}l.restoreUnavailableMessages=c}),98);
__d("MAWSharedCOPHandleBatch",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedRestoreUnavailableMessages","WALogger","WAProtocolQueue","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e,t,n){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){var i=yield a(t).then(function(e){return[e,null,!1]}).catch(function(t){return o("MAWIsQuotaExceededError").isQuotaExceededError(t)?(r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Quota exceeded while processing stanzas batch."]))),[[],null,!0]):(r("MAWSharedCOPLogger").catching(t).MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Runtime error while processing stanzas batch"]))),[[],t instanceof Error?t:r("err")(""+t),!1])}),l=i[0],m=i[1],p=i[2];if(p)return{entriesLeft:[],exhausted:!0,handled:0};if(yield o("WAProtocolQueue").protocolQueue().ack(l).catch(function(e){return r("MAWSharedCOPLogger").catching(e).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[ackProtocols] Cannot ack from MAWConsumer"])))}),l.length>=t.length)return{entriesLeft:[],exhausted:!1,handled:l.length};if(r("MAWSharedCOPLogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed processing "," items"])),t.length-l.length),n===1){if(t.length>1&&r("MAWSharedCOPLogger").MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Received more than 1 entry, despite having limit === 1"]))),t.length===0)return{entriesLeft:[],exhausted:!1,handled:0};var _=t[0];return yield o("WAProtocolQueue").protocolQueue().delete([_.stanzaQueueId]),{entriesLeft:[],exhausted:!1,handled:1}}var f=new Map(t.map(function(e){return[e.stanzaQueueId,e]}));return l.forEach(function(e){return f.delete(e)}),{entriesLeft:Array.from(f.values()),error:!0,exhausted:!1,handled:l.length}}),f.apply(this,arguments)}function g(e,t,n){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield e(t);if(t.order==="desc"&&(a=a.toReversed()),a.length===0)return{exhausted:!0,handled:0};r("MAWSharedCOPLogger").DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," stanzas. Config:",""])),a.length,String(t)),o("MAWSharedRestoreUnavailableMessages").restoreUnavailableMessages(a);var i=yield _(a,t.limit,n);if(i.error==null)return{exhausted:i.exhausted,handled:i.handled};o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Linear COP v2"])));var l=0;for(var s of i.entriesLeft){var u=yield _([s],1,n);if(l+=u.handled,u.exhausted)return{exhausted:!0,handled:l+i.handled}}return{exhausted:!1,handled:l+i.handled}}),h.apply(this,arguments)}l.copHandleBatch=g}),98);
__d("MawMpsCopProtocolQueueProcessor",["FBLogger","MAWProtocolQueueProcess","MAWSharedCOPHandleBatch","MawCopScheduler","Promise","WAProtocolQueue","WAWaitForUserUnblocked","WorkerScheduler","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function t(){this.$2=r("justknobx")._("2539"),this.$3=null,this.$1()}var a=t.prototype;return a.$4=function(){var t=this;this.$3==null&&(this.$3=o("MawCopScheduler").copScheduler().task({fn:function(){return o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?(e||(e=n("Promise"))).resolve({exhausted:!0,handled:0}):o("MAWSharedCOPHandleBatch").copHandleBatch(o("WAProtocolQueue").protocolQueue().index("priority").read,{limit:t.$2,order:"desc"},o("MAWProtocolQueueProcess").processProtocolQueueEntries)},name:"protocol-queue",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),this.$3.run().then(function(e){t.$3=null,e.exhausted===!1&&t.$4()}).catch(function(e){r("FBLogger")("cop").catching(e).mustfix("ProtocolQueueProcessor fails"),t.$3=null,t.$4()}))},a.startProcessing=function(){this.$4()},a.$1=function(){var e=this;o("WAProtocolQueue").protocolQueue().subscribe(function(t){switch(t.type){case"flush":{if(o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked())return;e.startProcessing();return}}})},t})();l.ProtocolQueueProcessor=s}),98);
__d("MessageChunksFromMediaEntry",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[{messageId:e.message.messageId,plaintextHash:e.plaintextHash,threadId:e.message.threadId}];return e.thumbnailHash!=null&&e.thumbnailHash!==e.plaintextHash&&t.push({messageId:e.message.messageId,plaintextHash:e.thumbnailHash,threadId:e.message.threadId}),t}function l(t){return t.flatMap(e)}i.getMessageChunksFromMediaEntry=e,i.getMessageChunksFromMediaEntries=l}),66);
__d("MpsMediaPostProcessor",["MAWMediaManager","MessageChunksFromMediaEntry","MpsMediaEntryCache","MpsTypes","Promise","WAMediaManager","WAStartMediaDownloadQplFlow","WmiMediaService","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){try{var a=o("MpsMediaEntryCache").hydrateCache(t.message),i=o("MessageChunksFromMediaEntry").getMessageChunksFromMediaEntries(a);o("WmiMediaService").mediaService().storeMessageChunks(i),t.insertionSource===o("MpsTypes").InsertionSource.Receive&&(e||(e=n("Promise"))).all(a.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"MpsSyncMedia",msgType:null,protocolMsgId:null,triggerUIView:null}),n=yield o("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSizeAndPreview({fullSizePlaintextHash:e.plaintextHash,mediaDownloadFlow:t,priority:o("WAMediaManager").MediaTaskPriority.MEDIUM}).fullsizePromise;n.success===!1?t.endFail(n.error):t.endSuccess()});return function(t){return e.apply(this,arguments)}})()))}catch(e){return r("getErrorSafe")(e)}}function u(e){var t=new Map;return e.forEach(function(e){var n=s(e);n!=null&&t.set(e.message.messageId,n)}),t}l.postProcessPayloads=u}),98);
__d("MpsToUIPostProcessor",["FBLogger","MpsMessageToBridge","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","MpsTypes","WAJids","WATimeUtils","WebMps","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return[{tag:"NewMsg",value:e}]}function s(e){return[{tag:"EditMsgHistoryAdded",value:[e]}]}function u(e){if(e.type==="upsert")return[{tag:"UpsertReaction",value:e.reaction}];if(e.type==="delete")return[{tag:"DeleteReaction",value:e.reaction}];throw e.type,r("FBLogger")("messenger_web").mustfixThrow("unreachable")}function c(e){return[{tag:"NewMedia",value:e}]}function d(e){return[{tag:"MsgsStartCountdown",value:e}]}function m(e){return[{tag:"StoryReplyStartCountdown",value:e}]}function p(e){return[{tag:"NoteReplyStartCountdown",value:e}]}function _(e){return[{tag:"NewReceiverFetchInfo",value:e}]}function f(e){return[{tag:"NewXMA",value:e}]}function g(e){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(t.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevel){var n=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(t.message),r=o("MpsToBridgeMessageId").mpsToBridgeMsgId(n.message.threadId,t.directive.targetMessageId);return[{tag:"DeleteMessages",value:{messages:[{msgId:r,ts:n.getUnixTs()}],threadJid:n.getChatJid()}}]}if(!(t.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel||t.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental||t.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder))return[];var a=t.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental?t.directive.targetMessageId:t.message.messageId,i=yield o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"UI-fetch"},messageId:a,threadId:t.message.threadId}),l=i.value;if(!l)return[];var g=o("MpsMessageToBridge").mpsFullMessagetoBridge(l);if(g==null)return[];var h=[g.topLevel].concat(g.supplementals).map(function(t){return(function(t){if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeMsg"&&"value"in t){var n=t.value;return e(n)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeEditHistoryMsg"&&"value"in t){var r=t.value;return s(r)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeReactionAction"&&"value"in t){var o=t.value;return u(o)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeMedia"&&"value"in t){var a=t.value;return c(a)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeXMAStartCountdown"&&"value"in t){var i=t.value;return m(i)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeNoteReplyStartCountdown"&&"value"in t){var l=t.value;return p(l)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeMsgsStartCountdown"&&"value"in t){var g=t.value;return d(g)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeReceiverFetchInfo"&&"value"in t){var h=t.value;return _(h)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeXMA"&&"value"in t){var y=t.value;return f(y)}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+t)})(t)}),y=h.flat(),C=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(l.toplevelProtobuf),b=[{tag:"VerifyThreadExists",value:{authoritativeThreadKey:null,cannotReplyReason:null,clientThreadKey:null,description:"mpsToUIPostProcessor",folder:null,instanceKey:null,isGroup:o("WAJids").switchOnMsgrChatJidType(C.getChatJid(),{group:function(){return!0},user:function(){return!1}}),jid:C.getChatJid(),lastReadTs:o("WATimeUtils").castToMillisTime(0)}}];return b.concat(y)}),h.apply(this,arguments)}l.mpsToUIEventPostProcessPayload=g}),98);
__d("WAPriorityQueue",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.$2=e,this.$1=[],this.$3(t)}var t=e.prototype;return t.size=function(){return this.$1.length},t.$3=function(t){var e=this;t!=null&&t.length&&t.forEach(function(t){e.push(t)})},t.$4=function(t,n){var e=this.$1[n];this.$1[n]=this.$1[t],this.$1[t]=e},t.$5=function(t){if(t===void 0&&(t=0),t!==0){var e=this.$6(t),n=e*2+1,r=e*2+2,o=this.$1.length;if(!(t>=o)){var a=this.$7(e),i=e;if(n<o){var l=this.$7(n);a>l&&(i=n,a=l)}if(r<o){var s=this.$7(r);a>s&&(i=r)}i!==e&&(this.$4(i,e),this.$5(e))}}},t.$8=function(t){t===void 0&&(t=0);var e=t*2+1,n=t*2+2,r=this.$1.length;if(!(t>=r)){var o=this.$7(t),a=t;if(e<r){var i=this.$7(e);o>i&&(a=e,o=i)}if(n<r){var l=this.$7(n);o>l&&(a=n)}a!==t&&this.$4(a,t),e<r&&this.$8(e),n<r&&this.$8(n)}},t.$7=function(t){return this.$2(this.$1[t])},t.$6=function(t){return t%2===0?(t-2)/2:(t-1)/2},t.push=function(t){this.$1.push(t);var e=this.$1.length-1;this.$5(e)},t.pull=function(){var e=this.$1.shift();return this.heapify(),e},t.heapify=function(){this.$8(0)},t.peek=function(){return this.$1[0]},e})();i.default=e}),66);
__d("MawMpsCop",["FBLogger","MAWBridge","MAWMpsGating","MAWProtocolQueueProcess","MawCopScheduler","MawMpsCopProtocolQueueProcessor","MpsMediaEntryCache","MpsMediaPostProcessor","MpsToUIPostProcessor","Promise","WAPriorityQueue","WAPubSub","WAWaitForUserUnblocked","WebMps","WebMpsScheduler","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=1,u=10,c=r("justknobx")._("4688");function d(){return o("MAWMpsGating").isFullMpsEnabled()?r("justknobx")._("4841"):s}var m=(function(){function t(){this.$1=o("WAPubSub").simplePubSub(),this.$3=new Map,this.$4=new Map,this.$2=new(o("MawMpsCopProtocolQueueProcessor")).ProtocolQueueProcessor}var a=t.prototype;return a.$5=function(t){return o("MAWMpsGating").isMpsMessageRendering()&&t.forEach(function(e){return o("MpsMediaEntryCache").hydrateCache(e.toplevelProtobuf)}),o("MAWProtocolQueueProcess").processMPSFullMessageEntries(t)},a.loadMsgIntoMaw=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WebMps").mps().loadMessage(e);if(t.success===!1)throw t.error;t.value!=null&&(yield this.$5([t.value]))});function t(t){return e.apply(this,arguments)}return t})(),a.loadBatchMsgsIntoMaw=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WebMps").mps().batchLoadMessages(babelHelpers.extends({},e,{config:babelHelpers.extends({shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"},e.config)}));if(t.success===!1)return t;var n=t.value.map(function(e){return e.messages}).flat();return n.length===0?t:this.$6(n).then(function(){return t})});function t(t){return e.apply(this,arguments)}return t})(),a.loadMoreMsgsIntoMaw=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WebMps").mps().loadMessages(babelHelpers.extends({},e,{config:{shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"}}));return t.success===!1?t:this.$5(t.value.messages).then(function(){return t})});function t(t){return e.apply(this,arguments)}return t})(),a.subscribe=function(t){return this.$1.subscribe(t)},a.$7=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=this;if(this.$3.size===0)return{exhausted:!0};var r=[];return this.$3.forEach(function(o,a){t!=null&&r.length>=t||(r.push.apply(r,o.splice(-e)),o.length===0&&n.$3.delete(a))}),o("MAWMpsGating").isFullMpsEnabled()?{exhausted:this.$3.size===0}:(yield this.$8(r),{exhausted:this.$3.size===0})});function t(t,n){return e.apply(this,arguments)}return t})(),a.$9=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=this;if(this.$4.size===0)return{exhausted:!0};var r=[];return this.$4.forEach(function(o,a){if(!(t!=null&&r.length>=t)){for(var i=1;i<=e;i++){var l=o.pull();l!=null&&r.push(l)}o.size()===0&&n.$4.delete(a)}}),yield this.$10({payloadList:r}),{exhausted:this.$4.size===0}});function t(t,n){return e.apply(this,arguments)}return t})(),a.$11=function(t){var e=this;t.forEach(function(t){var n,r=t.message.threadId,o=(n=e.$3.get(r))!=null?n:[];o.push(t),e.$3.set(r,o)})},a.$12=function(t){var e=this;t.payloadList.forEach(function(t){var n,o=t.message.threadId,a=(n=e.$4.get(o))!=null?n:new(r("WAPriorityQueue"))(function(e){return-e.message.timestampMs});a.push(t),e.$4.set(o,a)})},a.$10=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.ctx,i=t.payloadList;o("MpsMediaPostProcessor").postProcessPayloads(i);var l=new Map,s=[];yield(e||(e=n("Promise"))).all(i.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{var t=yield o("MpsToUIPostProcessor").mpsToUIEventPostProcessPayload(e);t.forEach(function(t){t.tag==="NewMsg"&&t.value.unsupportedType!=null&&(a==null||a.messageToQpl.addPoint(e.message.messageId,"unsupported_type",{string:{unsupported:t.value.unsupportedType}}))}),s.push.apply(s,t)}catch(t){l.set(e.message.messageId,r("getErrorSafe")(t))}});return function(t){return e.apply(this,arguments)}})())),o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:s}),i.forEach(function(e){var t=l.get(e.message.messageId);if(t){var n=t;a==null||a.messageToQpl.addPoint(e.message.messageId,"ui-fail",{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(n)}}),r("FBLogger")("mps").catching(n).mustfix("Failed to process payload for UI for thread id = %s , message Id = %s",e.message.threadId,e.message.messageId)}})});function a(e){return t.apply(this,arguments)}return a})(),a.$8=function(t){return o("MAWProtocolQueueProcess").processMPSIncomingPayloadEntries(t).then(function(e){e.forEach(function(e,t){r("FBLogger")("mps").catching(e).mustfix("Failed to process payload for MAW for message Id = %s",t)})}).catch(function(e){r("FBLogger")("mps").catching(r("getErrorSafe")(e)).mustfix("Failed to process payload for MAW")})},a.postProcessMessages=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=this;if(t.payloadList.length===0)return(e||(e=n("Promise"))).resolve();if(!(o("MAWMpsGating").isMpsMessageRendering()&&(o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?this.$12({ctx:t.ctx,payloadList:t.payloadList}):yield this.$10({ctx:t.ctx,payloadList:t.payloadList}),o("MAWMpsGating").isFullMpsEnabled())))return o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?(this.$11(t.payloadList),(e||(e=n("Promise"))).resolve()):(o("MawCopScheduler").copScheduler().runTask({fn:function(){return a.$8(t.payloadList)},name:"online-message",priority:o("MAWMpsGating").isMpsMessageRendering()&&r("justknobx")._("960")?o("WorkerScheduler").REGULAR_PRIORITY:o("WorkerScheduler").BLOCKING_PRIORITY}).catch(function(e){r("FBLogger")("cop").catching(r("getErrorSafe")(e)).mustfix("online message processing fails")}),(e||(e=n("Promise"))).resolve())});function a(e){return t.apply(this,arguments)}return a})(),a.subscribeToOfflineQueue=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"offline-start":{o("WAWaitForUserUnblocked").maybeResetWaitForUserUnblocked();break}case"offline-end":{e.$1.publish({type:"maw-infra-start"}),o("MAWMpsGating").isMpsMessageRendering()&&e.$9(d()).catch(function(e){r("FBLogger")("wmi").catching(r("getErrorSafe")(e)).mustfix("MPS offline-end cop fails")}).finally(function(){e.$13(function(){return e.$9(u,c)},o("WorkerScheduler").REGULAR_PRIORITY)}),o("MAWMpsGating").isMpsMessageRendering()&&r("justknobx")._("960")?o("MawCopScheduler").copScheduler().runTask({fn:function(){return e.$7(d())},name:"offline-queue",priority:o("WorkerScheduler").REGULAR_PRIORITY}).catch(function(e){r("FBLogger")("cop").catching(r("getErrorSafe")(e)).mustfix("offline-end cop fails")}).finally(function(){e.$14(function(){return e.$7(u,c)},o("WorkerScheduler").REGULAR_PRIORITY),e.$2.startProcessing()}):e.$7(d()).catch(function(e){r("FBLogger")("cop").catching(r("getErrorSafe")(e)).mustfix("offline-end cop fails")}).finally(function(){e.$14(function(){return e.$7(u,c)},o("WorkerScheduler").REGULAR_PRIORITY),e.$2.startProcessing()}),e.$1.publish({success:!0,type:"maw-infra-end"}),o("WAWaitForUserUnblocked").unblockUser();break}default:{t.type;break}}})},a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){for(var t=c,n=0;n<e.length;n+=t){var o=e.slice(n,n+t);yield this.$5(o).catch(function(e){return r("FBLogger")("mps").catching(r("getErrorSafe")(e)).mustfix("Failed to process batch")})}});function t(t){return e.apply(this,arguments)}return t})(),a.$14=function(t,n){var e=this;if(this.$15==null){var a=o("MawCopScheduler").copScheduler().task({fn:t,name:"background-iterator",priority:n});this.$15=a,a.run().then(function(r){e.$15=null,r.exhausted===!1&&e.$14(t,n)}).catch(function(o){r("FBLogger")("cop").catching(r("getErrorSafe")(o)).mustfix("Cop fails"),e.$15=null,e.$14(t,n)})}},a.$13=function(t,n){var e=this;if(this.$16==null){var a=o("WebMpsScheduler").mpsScheduler().task({fn:t,name:"mps-cop-iterator",priority:n});this.$16=a,a.run().then(function(r){e.$16=null,r.exhausted===!1&&e.$13(t,n)}).catch(function(o){r("FBLogger")("cop").catching(r("getErrorSafe")(o)).mustfix("mps-iterator fails"),e.$16=null,e.$13(t,n)})}},t})(),p;function _(){return p||(p=new m,p)}l.MpsCop=m,l.mpsCop=_}),98);
__d("EncryptedBackupsUploadQueueProcessor",["EBDBMetricsConsistencyOperationEnum","EBLogger","EBMessageProbe","EBUploadMessagesFromWorkerMutationDeferred","EBWorkerEBDBApiDeferred","EncryptedBackupsConstructEchoMessages","EncryptedBackupsMediaRestoreProbeV2","EncryptedBackupsUploadQueue","EncryptedBackupsUtils","EncryptedBackupsWorkerScheduler","FBLogger","MAWBridge","MAWBridgeUpload","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","MAWGetMsgByProtocolIdApi","MAWMpsGating","MAWODSProxy","MAWProtobufDeserializers","MAWTraceUtils","MWEBODSUtils","MawMpsCop","MpsTypes","Promise","WACommsConnectionState","WAGlobals","WAJids","WAOdsEnums","WAStanzaUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","err","getSafeQplErrorMessage","gkx","justknobx","performanceAbsoluteNow","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B=o("EBLogger").EBLogger().tags(["EbUploadQueue"]);function W(){return r("gkx")("1842")}function q(){return r("justknobx")._("2368")}var U=new Map;function V(){var e=(O||(O=r("performanceAbsoluteNow")))(),t=!1;for(var n of U.entries()){var a=n[0],i=n[1].addedAtMs;e-i>r("justknobx")._("3472")&&(t=!0,o("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"message_upload_timeout",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.MESSAGE_UPLOAD_TIMEOUT}}),U.delete(a))}return t}var H=null,G=null,z=null,j=null,K=null,Q=null;function X(){return K!=null}function Y(){return Q}function J(){return Z.apply(this,arguments)}function Z(){return Z=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),K==null&&(B.DEBUG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Running..."]))),j!=null&&(B.DEBUG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Cancelling scheduled retry as another process has triggered a run"]))),window.clearTimeout(j),j=null),K=o("EncryptedBackupsWorkerScheduler").ebScheduler().task({fn:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(W()&&o("WACommsConnectionState").WACommsConnectionState.isConnected()===!1&&(B.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Connection lost during scheduling, waiting for reconnection"]))),yield o("WACommsConnectionState").WACommsConnectionState.waitForConnection(),B.DEBUG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Connection restored, proceeding with upload"])))),o("EBWorkerEBDBApiDeferred").trackConsistency(o("EBDBMetricsConsistencyOperationEnum").EBConsistencyOperation.Upload).then(function(e){return o("MAWBridge").getBridge().fireAndForget("event","trackEbConsistency",{workerDeviceId:e})}),!r("MAWEBLSInWorkerSwitch").isEnabled())return!1;var e=yield ce(),t=e.isEmpty;return!t});function t(){return e.apply(this,arguments)}return t})(),name:"eb_upload",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),K.run().then(function(e){K=null,e&&J()}).catch(function(e){K=null,B.MUSTFIX(L||(L=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"])),e),U.forEach(function(t,n,r){o("MAWEBUploadTrackingUtils").endFailWorkerOnly(n,"upload_eb_msgs_error",{string:{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected",error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e),error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.RUNTIME_ERROR,reason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}),U.clear(),B.DEBUG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Waiting ","ms before scheduling next run due to an error"])),r("justknobx")._("2366")),j=globalThis.setTimeout(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){j=null,W()||o("WACommsConnectionState").WACommsConnectionState.isConnected()===!1&&(B.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Network is currently disconneted. Waiting for the network to reconnect before continuing eb upload."]))),yield o("WACommsConnectionState").WACommsConnectionState.waitForConnection(),B.DEBUG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Network has been re-established."])))),B.DEBUG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Finished waiting, scheduling next run"]))),J()}),r("justknobx")._("2366"))}))}),Z.apply(this,arguments)}function ee(){return te.apply(this,arguments)}function te(){return te=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(K==null)try{var e=o("EncryptedBackupsUploadQueue").ebUploadQueue(),t=yield e.read({limit:1,order:"desc"});t.length>0&&(B.DEBUG(D||(D=babelHelpers.taggedTemplateLiteralLoose(["[checkAndKickstartScheduler] Found "," items in queue, scheduler not running - kickstarting"])),t.length),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"restart_upload_scheduler"}),J())}catch(e){var n=o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e);B.WARN(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[checkAndKickstartScheduler] Error checking queue: ",""])),n)}}),te.apply(this,arguments)}function ne(){if(H==null&&(H=globalThis.setInterval(V,5e3)),G==null&&r("gkx")("18463")&&(B.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Setting up recurring upload trigger interval"]))),G=globalThis.setInterval(ee,r("justknobx")._("4405")||3e4)),W()){z==null&&(B.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Setting up WAComms connection subscription"]))),z=o("WACommsConnectionState").WACommsConnectionState.onSet(function(e){e?(B.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms connected, scheduling upload"]))),J()):B.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms disconnected, upload scheduling paused"])))}));var t=o("WACommsConnectionState").WACommsConnectionState.isConnected();if(t)B.DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms is connected, scheduling upload"]))),J();else{B.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms is disconnected, waiting for connection"]))),o("WACommsConnectionState").WACommsConnectionState.waitForConnection().then(function(){B.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms connection restored, scheduling upload"]))),J()}).catch(function(e){B.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Error waiting for WAComms connection: ",""])),e)});return}}else B.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Feature gate disabled, proceeding without network checks"]))),J()}function re(){r("MAWEBLSInWorkerSwitch").onSet(function(e){e===!0&&ne()}),ne();var e=o("EncryptedBackupsUploadQueue").ebUploadQueue();e.subscribe(function(e){e.type==="flush"&&ne()})}function oe(e){return ae.apply(this,arguments)}function ae(){return ae=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(e,"EncryptedBackupsUploadQueueProcessor:fireUploadEvent").then(function(t){return t.success||(B.MUSTFIX($||($=babelHelpers.taggedTemplateLiteralLoose(["uploadMessagesFromWorker failed with error: ",""])),t.error),e.forEach(function(e){var n=e.uploadTrackingInstanceKey;if(n!=null){var r;o("MAWEBUploadTrackingUtils").endFailWorkerOnly(n,"gql_upload_runtime_error",{string:{error_description:(r=t.error)!=null?r:"unknown gql upload error"}})}})),t});t.success&&(yield(F||(F=n("Promise"))).all(e.map(function(e){var r=e.uploadTrackingInstanceKey;return r==null?(F||(F=n("Promise"))).resolve():me(r,t.success)})),Q=Date.now())}),ae.apply(this,arguments)}function ie(e){return le.apply(this,arguments)}function le(){return le=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("EncryptedBackupsUploadQueue").ebUploadQueue(),n=[],r=yield t.read({filter:function(t){return t.sortOrderMs==null||o("EncryptedBackupsUtils").entryOlderThan30Days(t.sortOrderMs)?(n.push(t.queueId),!1):!U.has(o("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(t.msgId))},limit:e,order:"desc"});return yield t.delete(n),r}),le.apply(this,arguments)}function se(){return ue.apply(this,arguments)}function ue(){return ue=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){for(var e=q();e>0;)try{return yield ie(e)}catch(t){if(e===1)throw o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"queue_batch_throw"}),t;o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"queue_batch_halved."+e}),e=Math.floor(e/2)}throw r("err")("getNextBatchFromEBUploadQueueWithRetry: Code should not be reachable unless batch size is 0. Starting batch size was "+q())}),ue.apply(this,arguments)}function ce(){return de.apply(this,arguments)}function de(){return de=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield se().catch(function(e){throw B.catching(e).MUSTFIX(P||(P=babelHelpers.taggedTemplateLiteralLoose(["getNextBatchFromEBUploadQueue failed with error"]))),e});if(e.length===0)return{isEmpty:!0};B.DEBUG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"])),e.length);var t=e.map(function(e){var t,n,r,a,i,l,s,u=o("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(e.msgId),c=e.isRetroactiveUpload==null?!1:e.isRetroactiveUpload;o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(o("MpsTypes").toMessageId(e.msgId.externalId),"message_picked_from_queue",{is_retroactive:c,trigger_source:(t=e.triggerSource)!=null?t:"unknown"});var d={bridgeUploadMessage:o("MAWBridgeUpload").createBridgeUploadMessage({actionType:e.backupActionType===3?2:1,attachmentContextArray:e.attachmentContext,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:((n=e.backupDirective)==null?void 0:n.supplementalKey)!=null?(r=e.backupDirective)==null?void 0:r.originalMsgProtocolId.externalId:e.msgId.externalId,protoMsg:{backupActionType:e.backupActionType,msgId:e.msgId,originalMsgProtocolId:(a=e.backupDirective)==null?void 0:a.originalMsgProtocolId,protobuf:e.protobuf,senderId:e.senderId,serverTs:e.serverTs,sortOrderMs:e.sortOrderMs,supplementalKey:(i=e.supplementalKey)!=null?i:(l=e.backupDirective)==null?void 0:l.supplementalKey,tags:e.tags},sortOrderMs:e.sortOrderMs||0,threadId:o("WAJids").threadIdForChatJid(e.msgId.chat),traceId:u.toString(),uploadTrackingInstanceKey:u}),isRetroactiveUpload:c,legacyAttachmentContext:e.legacyAttachmentContext,messageType:e.dbMsgType,queueId:e.queueId,triggerSource:(s=e.triggerSource)!=null?s:"unknown"},m=/^\d+$/.test(d.bridgeUploadMessage.messageId);return o("MAWEBUploadTrackingUtils").addAnnotationsWorkerOnly(u,{bool:{message_id_valid:m}}),m||(B.MUSTFIX(M||(M=babelHelpers.taggedTemplateLiteralLoose(["Invalid message OTID: ",""])),d.bridgeUploadMessage.messageId),o("MWEBODSUtils").markODSForEB("upload",e.triggerSource+".invalid_otid")),d}),a=t.filter(function(e){return e.bridgeUploadMessage.actionType===2}),i=t.filter(function(e){return e.bridgeUploadMessage.actionType!==2});if(a.length>0){var l=a,s=l.length===t.length,u=(O||(O=r("performanceAbsoluteNow")))();for(var c of l){var d,m=c.bridgeUploadMessage,p=c.isRetroactiveUpload,_=c.messageType,f=c.queueId,g=c.triggerSource;m.uploadTrackingInstanceKey!=null&&U.set(m.uploadTrackingInstanceKey,{addedAtMs:u,queueId:f});var h=(d=m.protoMsg)==null?void 0:d.msgId;if(h!=null&&m.uploadTrackingInstanceKey!=null){var y=m.uploadTrackingInstanceKey;o("MAWEBUploadTrackingUtils").startUploadTracking(o("WAStanzaUtils").toStanzaId(m.messageId),o("WAJids").threadIdForChatJid(h.chat),_,g,y,!0,p,m.attachmentBackupContext,"protobuf_only")}}var C=l.map(function(e){var t=e.bridgeUploadMessage;return t.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t.uploadTrackingInstanceKey,"fire_protobuf_only_upload_bridge_event"),t});yield oe(C);for(var b of l){var v=b.bridgeUploadMessage;{var S,R=(S=v.protoMsg)==null?void 0:S.msgId;(R==null?void 0:R.externalId)!=null&&o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(o("MpsTypes").toMessageId(R.externalId),"message_uploaded_via_graphql",{action_type:v.actionType===2?"delete":"upsert",upload_type:"protobuf_only"})}}if(s)return{isEmpty:!1}}var L=new Map,E=[],k=[],I=[],T=new Map,D=new Map,x=(O||(O=r("performanceAbsoluteNow")))();for(var $ of e){var A;if($.backupActionType!==3){var W=fe($);if(W==null){r("promiseDone")(o("EncryptedBackupsUploadQueue").ebUploadQueue().ack([$.queueId]));continue}var q=o("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue($.msgId);U.set(q,{addedAtMs:x,queueId:$.queueId}),T.set(W.externalId,(A=$.attachmentContext)!=null?A:I);var V=$.msgId.externalId,H=$.originalMsgProtocolId.externalId;if(V!==H&&D.set(V,{currentExternalId:V,originalMsgExternalId:H}),!L.has(W.externalId)){var G;L.set(W.externalId,q);var z=o("MAWBridgeUpload").createBridgeUploadAttachmentBackupContext(null,"msgr",$.attachmentContext);o("MAWEBUploadTrackingUtils").startUploadTracking(W.externalId,o("WAJids").threadIdForChatJid(W.chat),$.dbMsgType,(G=$.triggerSource)!=null?G:"unknown",q,!0,$.isRetroactiveUpload,z,"dual_upload"),E.push(W),k.push({originalMsgId:W,uploadEntity:$})}}}if(!o("MAWMpsGating").isFullMpsEnabled()){var j=k.map(function(e){if(e.uploadEntity.sortOrderMs==null)return B.warn("Cannot fetch message from MPS, timestampMs field is missing"),null;var t=e.uploadEntity.sortOrderMs;return{direction:"desc",from:[o("MpsTypes").toTimestamp(t),o("MpsTypes").toMessageId(e.uploadEntity.msgId.externalId)],numMessages:1,threadId:o("MpsTypes").toThreadId(e.uploadEntity.msgId.chat)}}),K=yield o("MawMpsCop").mpsCop().loadBatchMsgsIntoMaw({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"eb_echo_upload"},ranges:j.filter(Boolean)});K.success||B.warn("Failed to fetch messages from MPS",K.error)}L.forEach(function(e,t){o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"queue_get_original_msg_ids_done")});var Q=yield o("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn(E).catch(function(e){var t=E.map(function(t){var r=(F||(F=n("Promise"))).reject(e);return r=o("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([t]).then(function(e){return e[0]}),r.catch(function(r){var a=L.get(t.externalId);if(a!=null?o("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"get_db_msgs_error",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.ERROR_FETCHING_DB_MESSAGE,reason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r)}}):B.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["Cannot get message from db: ",""])),e),r.name==="EARError"){var i=(F||(F=n("Promise"))).resolve();if(a!=null){var l,s=(l=U.get(a))!=null?l:{queueId:null},u=s.queueId;u!=null&&(i=o("EncryptedBackupsUploadQueue").ebUploadQueue().delete([u]))}return i}return(F||(F=n("Promise"))).reject(r)})});return(F||(F=n("Promise"))).all(t).then(function(e){return e.filter(Boolean)})}),X=Q.map(function(e){return e.externalId}),Y=k.filter(function(e){return!X.includes(e.originalMsgId.externalId)});Y.forEach(function(e){var t=L.get(e.originalMsgId.externalId);if(t!=null){var n;o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t,"missing_entity_in_maw_db",{string:{missing_msg_id:e.originalMsgId.externalId,msg_type:e.uploadEntity.dbMsgType,trigger_source:(n=e.uploadEntity.triggerSource)!=null?n:"unknown"}})}});var J=new Map;Q.forEach(function(e){var t,n=L.get(e.externalId);if(n!=null){o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"queue_get_msgs_done");var r=D.get(e.externalId);r!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"external_id_mismatch",{string:{currentExternalId:r.currentExternalId,differing_ids_type:e.type,originalMsgExternalId:r.originalMsgExternalId}}),J.set(e.externalId,(t=T.get(e.externalId))!=null?t:I)}}),ge(L,E,Q);var Z=Q.map(function(e){var t,n=((t=o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(L,e.externalId))!=null?t:o("MAWTraceUtils").createTraceId()).toString();return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("point",L,e.externalId,"construct_echo_start"),o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(o("MpsTypes").toMessageId(e.externalId),"message_dual_upload_started",{msg_type:e.type,upload_type:"dual_upload"}),{dbMsg:e,traceId:n}});return yield o("EncryptedBackupsConstructEchoMessages").uploadMessageFromUploadQueue(Z,L,i.map(function(e){return e.bridgeUploadMessage.protoMsg}).filter(Boolean),J),{isEmpty:!1}}),de.apply(this,arguments)}function me(e,t){return pe.apply(this,arguments)}function pe(){return pe=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n;if(t)o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_queue_ack_worker_success");else{o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"upload_queue_ack_worker_fail",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:"failure to ack upload queue"}}),ne();return}var a=(n=U.get(e))!=null?n:{queueId:null},i=a.queueId;if(i!=null){var l=o("EncryptedBackupsUploadQueue").ebUploadQueue();try{var s=yield l.get(i);s!=null?_e(s):B.MUSTFIX(A||(A=babelHelpers.taggedTemplateLiteralLoose(["upload queue - uploadEntity was null when attepmting to ack"])))}catch(e){r("FBLogger")("wmi").catching(e).mustfix("Failed to probe media restore")}yield l.ack([i]),U.delete(e),ne()}}),pe.apply(this,arguments)}function _e(e){var t,n,r;if(((t=e.backupDirective)==null?void 0:t.actionType)===1){var a=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e.protobuf);o("EncryptedBackupsMediaRestoreProbeV2").sampleProbeMediaRestoreV2({backupMessage:a,chatJid:e.msgId.chat,sortOrderMs:(n=e==null?void 0:e.sortOrderMs)!=null?n:0,stanzaId:e.msgId.externalId,triggerSource:(r=e.triggerSource)!=null?r:"unknown"}).catch(function(e){B.MUSTFIX(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestoreV2: ",""])),e)})}}function fe(e){var t=e.originalMsgProtocolId;return t.author==null||t.chat==null?null:{author:o("WAGlobals").getMyUserJid()===t.author?o("WAJids").AUTHOR_ME:t.author,chat:t.chat,externalId:e.backupActionType===4?e.msgId.externalId:e.originalMsgProtocolId.externalId}}function ge(e,t,r){if(t.length>r.length){var a=new Set(t.map(function(e){return e.externalId}));r.forEach(function(t){if(a.has(t.externalId)){a.delete(t.externalId);var n=e.get(t.externalId);n!=null?o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"msg_found",{string:{originalMsgType:t.type}}):B.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found"])))}}),a.forEach((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=e.get(t);if(n!=null){var r;o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(n,"upload_queue_msg_not_found");var a=(r=U.get(n))!=null?r:{queueId:null},i=a.queueId;if(U.delete(n),i==null)return;yield o("EncryptedBackupsUploadQueue").ebUploadQueue().delete([i])}else B.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg not found 1"])))});return function(e){return t.apply(this,arguments)}})())}else r.forEach(function(t){var n=e.get(t.externalId);n!=null?o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"msg_found",{string:{originalMsgType:t.type}}):B.WARN(C||(C=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found 2"])))})}l.isEbUploadTaskScheduled=X,l.getLastSuccessfulAckTimestampMs=Y,l.scheduleNextRun=ne,l.listenForEbUploadQueueFlush=re,l.uploadEBMsgs=ce,l.ackWithInstanceKeyWorkerOnly=me,l.buildProtocolMsgIdFromEntity=fe}),98);
__d("EncryptedBackupsCreateAttachmentContext",["EBLogger","EncryptedBackupsUploadEntity","MAWProtobufDeserializers","WAMediaTransport.pb","WAMediaUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["labyrinth_web","CreateAttachmentContext"]);function s(t){var n=new Map;try{var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),a=r.encryptedTransportMessage();if(a==null)return e.warn("transport message subprotocol is undefined"),[];var i=d(a);if(i!=null)if(i.type!==o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)c(i,n);else{var l=i.payload;u(l.favicon,n),u(l.headerImage,n),l.previews!=null&&l.previews.forEach(function(e){u(e,n)});var s=l.associatedMessage;if(s!=null&&s.payload!=null){var m=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(s.payload),p=d(m);p!=null&&c(p,n)}}}catch(t){e.warn("Unable to create attachment context for message")}return Array.from(n.entries()).map(function(e){var t=e[0],n=e[1];return{mediaObjectId:t,mediaType:n}})}function u(e,t){var n;if(e!=null){var r=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,e.payload),a=(n=r.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId;a!=null&&t.set(o("WAMediaUtils").stringToDeliveryObjectId(a),o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}}function c(t,n){var r,a,i,l=t.type,s=t.payload,u=s.integral;if((u==null||(r=u.transport)==null||(r=r.ancillary)==null?void 0:r.objectId)==null){e.warn("object id for attachment is null");return}var c=o("WAMediaUtils").stringToDeliveryObjectId(u==null||(a=u.transport)==null||(a=a.ancillary)==null?void 0:a.objectId);n.set(c,l);var d=u==null||(i=u.transport)==null||(i=i.ancillary)==null||(i=i.thumbnail)==null||(i=i.downloadableThumbnail)==null?void 0:i.objectId;if(d!=null&&d!==c){var m=o("WAMediaUtils").stringToDeliveryObjectId(d);n.set(m,o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}}function d(e){var t=e.consumerMessage(),n=e.armadillo();if(t!=null){var r,a,i,l,s,u=t.payload;if((u==null||(r=u.content)==null?void 0:r.imageMessage)!=null){var c;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,u==null||(c=u.content)==null||(c=c.imageMessage.image)==null?void 0:c.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE}}if((u==null||(a=u.content)==null?void 0:a.videoMessage)!=null){var d,m,p,_=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").VideoTransportSpec,u==null||(d=u.content)==null||(d=d.videoMessage.video)==null?void 0:d.payload);return{payload:_,type:(_==null||(m=_.ancillary)==null?void 0:m.gifPlayback)!==!0||(_==null||(p=_.ancillary)==null?void 0:p.gifAttribution)!=null?o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO}}if((u==null||(i=u.content)==null?void 0:i.stickerMessage)!=null){var f;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,u==null||(f=u.content)==null||(f=f.stickerMessage.sticker)==null?void 0:f.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER}}if((u==null||(l=u.content)==null?void 0:l.audioMessage)!=null){var g;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").AudioTransportSpec,u==null||(g=u.content)==null||(g=g.audioMessage.audio)==null?void 0:g.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT}}if((u==null||(s=u.content)==null?void 0:s.documentMessage)!=null){var h;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").DocumentTransportSpec,u==null||(h=u.content)==null||(h=h.documentMessage.document)==null?void 0:h.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT}}}if(n!=null){var y,C=n.payload;if((C==null||(y=C.content)==null?void 0:y.extendedContentMessage)!=null){var b;return{payload:C==null||(b=C.content)==null?void 0:b.extendedContentMessage,type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA}}}}l.createAttachmentContext=s}),98);
__d("MAWMPSCreateBackupDirective",["EBLogger","MpsMessageToBridgeWrapper","MpsTypes","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["mps"]);function s(t){switch(t){case o("MpsTypes").ActionType.UpsertTopLevel:return 1;case o("MpsTypes").ActionType.UpsertSupplemental:return 2;case o("MpsTypes").ActionType.DeleteTopLevel:return 3;case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return 4;case o("MpsTypes").ActionType.DeleteSupplemental:case o("MpsTypes").ActionType.Preprocess:case o("MpsTypes").ActionType.Noop:case o("MpsTypes").ActionType.DeleteThread:case o("MpsTypes").ActionType.Unknown:return e.warn("Action type %d not supported on EB upload",t),0}}function u(t,n){var r=s(t.actionType);if(r===0){e.warn("Unknown EB upload action type - cannot upload message");return}var o={actionType:r,originalMsgProtocolId:n};return t.supplementalKey!=null&&(o=babelHelpers.extends({},o,{supplementalKey:t.supplementalKey})),o}function c(e,t){var n=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(t);return{author:n.getAuthor(),chat:n.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(e.targetMessageId)}}l.createBackupDirectiveFromMPSMessage=u,l.getTargetProtocolMsgIdForMessage=c}),98);
__d("WormPersistedQueueSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e}var s={autoIncrement:!1,primaryKey:"queueId",secure:!0},u={ebUploadQueueV3:babelHelpers.extends({},s,{indexes:{"[attemptCount+addedAtMs]":{fields:["attemptCount","addedAtMs"],unique:!1}},nonEncryptedFields:["attemptCount","addedAtMs"]})};function c(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="worm_pqdb",c=new(o("WormEAR")).WormEAR(u,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,u,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.toWormPersistedQueueId=e,l.makePersistedQueueSchema=c}),98);
__d("WormPersistedQueueDb",["FBLogger","Promise","WAResolvable","WormEAR","WormPersistedQueueSchema","asyncToGeneratorRuntime","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new(o("WAResolvable")).Resolvable;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.blockingErrorThreshold,i=t.dbName,l=t.onBlockingError,c=t.qplEvent,d=t.strEncKey;try{var m=o("WormPersistedQueueSchema").makePersistedQueueSchema(i,d,a,l,function(t){if(t instanceof o("WormEAR").DecryptionError){var a,i,l=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",l.store),r("promiseDone")((a=(i=s)==null?void 0:i.runInTransaction([l.store],"readwrite",function(e){var t=e.stores[l.store];return l.maybeHashedPk!=null?t.delete(l.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?a:(e||(e=n("Promise"))).resolve())}},c);return s=m,yield m.init(),u.resolve(m),m}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing WORM PersistedQueue init"),e}}),d.apply(this,arguments)}function m(){if(s==null)throw r("err")("PersistedQueue is not initialized");return s}function p(){return u.promise}l.makePersistedQueueDb=c,l.getPersistedQueues=m,l.getDbPromise=p}),98);
__d("WormPersistedQueue",["FBLogger","WAPubSub","WormPersistedQueueDb","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return r("FBLogger")("wmi").tags(["worm-persisted-queue"])},u=36e5,c=(function(){function t(e){this.$1=o("WAPubSub").simplePubSub(),this.$4=0,this.$2=o("WormPersistedQueueDb").getPersistedQueues(),this.$3=e}var a=t.prototype;return a.$5=function(t){return"WormPersistedQueue:"+this.$3+":"+t},a.$6=function(){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.stores[e.$3],r=yield n.readAll({limit:1});r.length===0&&(yield n.clear())});return function(e){return t.apply(this,arguments)}})(),this.$5("clearIfEmpty"))},a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(Date.now()-this.$4>u)try{yield this.$6(),this.$4=Date.now()}catch(n){var t=r("getErrorSafe")(n);s().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during PersistedQueue cleanup: ",""])),t.message)}});function o(){return t.apply(this,arguments)}return o})(),a.subscribe=function(t){return this.$1.subscribe(t)},a.ack=function(t){return this.delete(t)},a.delete=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];yield r.bulkDelete(t),e.$7()});return function(e){return r.apply(this,arguments)}})(),this.$5("delete"))},a.read=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readonly",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];return yield r.readAll(t)});return function(e){return r.apply(this,arguments)}})(),this.$5("read"))},a.readFromIndex=function(t,r){var e=this;return this.$2.runInTransaction([this.$3],"readonly",(function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=n.stores[e.$3];return yield o.readIndex(t,void 0,r)});return function(e){return o.apply(this,arguments)}})(),this.$5("readIndex"))},a.add=function(t){return this.put(t)},a.put=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];yield r.bulkPut(t),e.$1.publish({type:"new_entities"})});return function(e){return r.apply(this,arguments)}})(),this.$5("put"))},t})();l.WormPersistedQueue=c}),98);
__d("EncryptedBackupsUploadQueueV3",["EncryptedBackupsMediaRestoreProbeV2","FBLogger","MAWEBSwitch","MAWMPSCreateBackupDirective","MAWProtobufDeserializers","MpsTypes","WAJids","WAStanzaUtils","WATimeUtils","WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t+"."+n.toString())}function u(e){var t=e.directive,n=e.insertionSource,a=e.message,i=o("WATimeUtils").millisTime(),l=o("MAWMPSCreateBackupDirective").getTargetProtocolMsgIdForMessage(t,a),u=o("MAWMPSCreateBackupDirective").createBackupDirectiveFromMPSMessage(t,l);if(u==null)throw r("FBLogger")("wmi").mustfixThrow("invalid-protobuf-no-backup-directive");var c=n===o("MpsTypes").InsertionSource.Send?"upload-sent-message":n===o("MpsTypes").InsertionSource.Receive?"upload-received-message":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n)})();return babelHelpers.extends({},a,{addedAtMs:i,attemptCount:0,backupDirective:u,debugInfo:{isRetroactive:!r("MAWEBSwitch").isEnabled(),triggerSource:c},queueId:s(a.messageId,a.threadId,i)})}var c=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3"])},d=null;function m(){return d==null&&(d=new(o("WormPersistedQueue")).WormPersistedQueue("ebUploadQueueV3")),d}function p(t){var n;if(t.backupDirective.actionType===1){var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t.payload);o("EncryptedBackupsMediaRestoreProbeV2").sampleProbeMediaRestoreV2({backupMessage:r,chatJid:o("WAJids").unsafeCoerceToChatJid(t.threadId),sortOrderMs:t.timestampMs,stanzaId:o("WAStanzaUtils").toStanzaId(t.messageId),triggerSource:(n=t.debugInfo.triggerSource)!=null?n:"unknown"}).catch(function(t){c().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestoreV2: ",""])),t)})}}l.uploadEntityFromIncomingPayload=u,l.getUploadQueue=m,l.queryMediaRestoreProbe=p}),98);
__d("EncryptedBackupsUploadQueueV3Scheduler",["EBGenerateMessageTags","EBMessageProbe","EBUploadMessagesFromWorkerMutationDeferred","EncryptedBackupsCreateAttachmentContext","EncryptedBackupsUploadEntity","EncryptedBackupsUploadQueueV3","FBLogger","I64","MAWBridgeUpload","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","MAWProtobufValidator","MWEBODSUtils","Promise","QPLFlow","WACommsConnectionState","WAGlobals","WAHashStringToNumber","WAJids","WAStanzaUtils","WATimeUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","justknobx","performanceAbsoluteNow","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3_scheduler"])},y=null;function C(){return y!==null}var b;function v(){return b}var S={concurrency:1,maxTaskLimit:1,maxThrottleMs:r("justknobx")._("1453"),timeoutMs:r("justknobx")._("1460")};function R(){r("MAWEBLSInWorkerSwitch").onSet(function(e){e===!0&&L()}),o("WACommsConnectionState").WACommsConnectionState.onSet(function(e){e===!0&&L()}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().subscribe(function(e){e.type==="new_entities"&&L()}),L()}function L(){return E.apply(this,arguments)}function E(){return E=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(y!=null){h().DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload is already running"])));return}yield o("WAWaitForUserUnblocked").waitForUserUnblocked();var t=o("QPLFlow").startQPLFlow(r("qpl")._(521475028,"909"));if(!r("MAWEBLSInWorkerSwitch").isEnabled()){h().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["EB is not enabled"]))),t.addPoint("eb_disabled"),t.endSuccess();return}if(!o("WACommsConnectionState").WACommsConnectionState.isConnected()){h().DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["WAComms connection is not established"]))),t.addPoint("wa_comms_not_connected"),t.endSuccess();return}y=o("WorkerScheduler").makeScheduler("EncryptedBackupsUploadQueueV3",S).task({fn:function(){return k(t)},name:"eb_upload_queue_v3",priority:o("WorkerScheduler").BACKGROUND_PRIORITY});try{var n=yield y.run();y=null,n&&L()}catch(e){y=null;var a=r("getErrorSafe")(e);h().FATAL(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Runtime error during EB upload run: ",""])),a.message),t.endFail("runtime_error"),L()}}),E.apply(this,arguments)}function k(e){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var a=[],i=0,l=0,s=yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().readFromIndex("[attemptCount+addedAtMs]",{filter:function(t){return Date.now()-t.timestampMs>o("WATimeUtils").DAY_MILLISECONDS*30?(a.push(t.queueId),i++,!1):r("justknobx")._("96")&&!o("MAWProtobufValidator").isProtobufValid(t.payload)?(a.push(t.queueId),l++,!1):t.attemptCount<r("justknobx")._("1596")},limit:r("justknobx")._("1676"),order:"asc"});if(e.addPoint("retrieved_entries",{int:{entriesCount:s.length}}),r("justknobx")._("5394")&&(yield new(g||(g=n("Promise")))(function(e){return t.setTimeout(e,r("justknobx")._("5395"))})),a.length>0&&(yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().delete(a),e.addPoint("deleted_invalid_entries",{int:{expiredEntryCount:i,invalidProtobufEntryCount:l}})),s.length===0)return e.endSuccess(),a.length>0;h().DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"])),s.length);var u=[],c=[];for(var _ of s){var y;o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(_.messageId,"message_picked_from_queue",{is_retroactive:_.debugInfo.isRetroactive||!1,trigger_source:"upload-message-from-mps"});var C=o("WAHashStringToNumber").hashStringToNumber(r("uuidv4")()),v=P(_,C);u.push(v),c.push(C),o("MAWEBUploadTrackingUtils").startUploadTracking(o("WAStanzaUtils").toStanzaId(_.messageId),o("WAJids").threadIdForChatJid(o("WAJids").unsafeCoerceToChatJid(_.threadId)),void 0,(y=_.debugInfo.triggerSource)!=null?y:"unknown",C,!0,_.debugInfo.isRetroactive||!1,v.attachmentBackupContext,"protobuf_only",_.attemptCount);var S=/^\d*$/.test(v.messageId);if(o("MAWEBUploadTrackingUtils").addAnnotationsWorkerOnly(C,{bool:{message_id_valid:S}}),!S){var R;h().MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Invalid message OTID: ",""])),v.messageId),o("MWEBODSUtils").markODSForEB("upload",((R=_.debugInfo.triggerSource)!=null?R:"unknown")+".invalid_otid")}}e.addPoint("generated_bridge_upload_messages"),c.forEach(function(e){return o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"fire_protobuf_only_upload_bridge_event")});try{var L=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(u,"EncryptedBackupsUploadQueueV3");if(e.addPoint("received_upload_response"),L.success){for(var E of s)o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(E.messageId,"message_uploaded_via_graphql",{action_type:E.backupDirective.actionType,upload_type:"protobuf_only"}),o("EncryptedBackupsUploadQueueV3").queryMediaRestoreProbe(E);yield T(s,c),b=(f||(f=r("performanceAbsoluteNow")))(),e.endSuccess()}else if(yield D(s,c,L.error,!0),e.endFail(L.error),L.error==="user_device_not_enrolled")return!1}catch(t){var k=r("getErrorSafe")(t);h().MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Runtime error when doing GraphQL upload, ",""])),k.message),yield D(s,c,k.message,!0),e.endFail("graphql_runtime_error")}return!0}),I.apply(this,arguments)}function T(e,t){return t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_queue_ack_worker_success")}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}function D(e,t,n,r){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){if(t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"upload_queue_ack_worker_"+(r?"retriable":"non_retriable")+"_error",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:n}})}),r){yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().put(e.map(function(e){return babelHelpers.extends({},e,{attemptCount:e.attemptCount+1})}));return}yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}),x.apply(this,arguments)}var $=o("WAJids").createJidUtils({platform:"msgr"});function P(e,t){var n=e.backupDirective.actionType===3?e.backupDirective.originalMsgProtocolId.externalId:o("WAStanzaUtils").toStanzaId(e.messageId),r=$.toUserJid(e.senderId),a=o("WAJids").unsafeCoerceToChatJid(e.threadId),i=r===o("WAGlobals").getMyUserJid()?o("WAJids").AUTHOR_ME:r,l={author:i,chat:a,externalId:n},s=o("EncryptedBackupsCreateAttachmentContext").createAttachmentContext(o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload)),u=o("MAWBridgeUpload").createBridgeUploadAttachmentBackupContext(void 0,"msgr",s),c=s.map(function(e){return o("EBGenerateMessageTags").generateEBMessageTags(e.mediaType)}).filter(Boolean);return{actionType:e.backupDirective.actionType===3?2:1,attachmentBackupContext:u,authTs:void 0,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:e.backupDirective.originalMsgProtocolId.externalId,messageType:void 0,protoMsg:{backupActionType:e.backupDirective.actionType,msgId:l,originalMsgProtocolId:e.backupDirective.originalMsgProtocolId,protobuf:o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload),senderId:(_||(_=o("I64"))).of_string(o("WAJids").userIdFromJid(r)),serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(e.timestampMs),sortOrderMs:o("WATimeUtils").castToMillisTime(e.timestampMs),supplementalKey:e.backupDirective.supplementalKey,tags:c},sortOrderMs:e.timestampMs,threadId:o("WAJids").threadIdForChatJid(a),traceId:t.toString(),uploadTrackingInstanceKey:t}}l.isUploadTaskScheduled=C,l.getLastSuccessfulAckTimestampMs=v,l.subscribeToUploadQueueUpdates=R}),98);
__d("MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO:return o("EchoMessageXMAFieldUtils").XMAGatingType.INFO;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF:return o("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF:return o("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING:return o("EchoMessageXMAFieldUtils").XMAGatingType.WARNING;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE:return o("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE:return o("EchoMessageXMAFieldUtils").XMAGatingType.NONE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentOverlayIconGlyph: ",""])),t),o("EchoMessageXMAFieldUtils").XMAGatingType.NONE}}l.convertExtendedContentOverlayIconGlyphToXMAGatingType=s}),98);
__d("MAWConvertExtendedContentTargetTypeToXMATargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_PROFILE_DIRECTORY_ITEM;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentTargetType: ",""])),t),o("EchoMessageXMAFieldUtils").XMAContentType.NONE}}l.convertExtendedContentTargetTypeToXMATargetType=s}),98);
__d("MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE:return o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT:return o("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL:return o("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA:return o("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA:return o("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID:return o("EchoMessageXMAFieldUtils").XMALayoutType.GRID;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentXMLLayoutType: ",""])),t),o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE}}l.convertExtendedContentXMLLayoutTypeToXMALayoutType=s}),98);
__d("MAWGetAttachmentTypeForServerMediaType",["EchoMessageMediaFieldUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case"image":return o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE;case"video":return o("EchoMessageMediaFieldUtils").AttachmentType.VIDEO;case"ptt":return o("EchoMessageMediaFieldUtils").AttachmentType.PTT;case"gif":return o("EchoMessageMediaFieldUtils").AttachmentType.GIF;case"sticker":return o("EchoMessageMediaFieldUtils").AttachmentType.STICKER;case"xma-image":return o("EchoMessageMediaFieldUtils").AttachmentType.XMA;case"document":return o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT;default:return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid AttachmentType: ",""])),t),null}}l.getAttachmentTypeForServerMediaType=s}),98);
__d("MAWGetMediaAttachmentTypeForServerMediaType",["EchoMessageMediaFieldUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case"image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE;case"video":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO;case"ptt":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.PTT;case"gif":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF;case"sticker":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER;case"audio":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO;case"document":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT;case"ppic":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.PROFILE_PICTURE;case"md-app-state":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.APP_STATE;case"md-msg-hist":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.HISTORY_SYNC;case"thumbnail-image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_IMAGE;case"thumbnail-video":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_VIDEO;case"thumbnail-gif":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_GIF;case"thumbnail-document":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_DOCUMENT;case"thumbnail-link":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_LINK;case"novi-video":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.NOVI_VIDEO;case"novi-image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.NOVI_IMAGE;case"xma-image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid EchoMessageActMediaAttachmentType: ",""])),t),null}}l.getMediaAttachmentTypeForServerMediaType=s}),98);
__d("MAWGetPreviewContentTypeForMediaType",["EchoMessageMediaFieldUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"image":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;case"gif":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF;case"sticker":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER;case"video":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4;case"ptt":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV;case"xma-image":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;default:return null}}l.getPreviewContentTypeForMediaType=e}),98);
__d("MAWUploadMessageTxns",["EBLogger","EchoCommonUtils","EchoEncodingUtils","EchoMessage","EchoMessageMediaFieldUtils","EchoMessageQuoteFieldUtils","EncryptedBackupsConstructEchoMessages","LSEBPayloadSerializerError","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType","MAWConvertExtendedContentTargetTypeToXMATargetType","MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbMsgUtil","MAWDbReactionsTxns","MAWDbReceiverFetchTxns","MAWDbXMATxns","MAWDexieTable","MAWGetAttachmentTypeForServerMediaType","MAWGetMediaAttachmentTypeForServerMediaType","MAWGetPreviewContentTypeForMediaType","MAWJidUtils","MAWJids","MAWMessageSortOrderUtils","MAWMsgType","MAWUserJidWrapper","MAWVault","MAWXMAUtils","WAArmadilloXMA.pb","WABase64","WAJids","WAMediaUtils","WATimeUtils","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m="You unsent a message";function p(e){switch(e.specialTextSize){case 1:return o("EchoMessage").MessageTextSize.SMALL;case 2:return o("EchoMessage").MessageTextSize.MEDIUM;case 3:return o("EchoMessage").MessageTextSize.LARGE;default:return o("EchoMessage").MessageTextSize.NONE}}function _(t,n){return o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(t,o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.externalId)).then(function(a){return a!=null?a.previewMediaIds!=null?o("MAWDexieTable").dexieAll(a.previewMediaIds.map(function(e){return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(t,e)})).then(function(e){for(var t of e)if(t==null)return o("MAWDexieTable").dexieResolve({maybeErrorDetail:{errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"constructEchoMessage: DbMedia is null for the XMA message",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},xmaData:void 0});return S(a)}):S(a):(o("EBLogger").EBLogger().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No XMA object found for msg with external id ",". Cannot upload XMA"])),n.externalId),o("MAWDexieTable").dexieResolve({maybeErrorDetail:{errorCode:r("LSEBPayloadSerializerError").UNKNOWN_ERROR,errorMsg:"constructEchoMessage: no xma object found for msg with external id "+n.externalId,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},xmaData:void 0}))})}function f(e,t){try{return o("MAWDbMsg").isMediaMsg(e)||e.type===o("MAWMsgType").MSG_TYPE.XMA||e.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}catch(e){var n=r("getErrorSafe")(e),a="[labyrinth_web] Invalid msg type for isMediaMsg check: "+String(e);return o("EBLogger").EBLogger().catching(n).MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),a),t.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:a,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},!1}}function g(e,t){return{echoMessage:null,externalId:e,maybeErrorDetail:{errorCode:r("LSEBPayloadSerializerError").NOT_IMPLEMENTED,errorMsg:t,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN}}}function h(e,t,n){var r=o("MAWDexieTable").dexieResolve(n.threadJid),a={mediaMetadata:null,previewMetadata:null},i=f(n,a),l=i?b(e,n):o("MAWDexieTable").dexieResolve(a),s=v(e,n),u=n.quote!=null?T(e,n.quote,r,t):o("MAWDexieTable").dexieResolve(),c=o("MAWDbMsg").isXMAMsg(n)?_(e,n):o("MAWDexieTable").dexieResolve(null),d=o("MAWDbEditMsgHistoryTxns").getEditHistoryAsEchoWithJidPromise(e,n.externalId,n.author,r);return{editHistoryPromise:d,mediaMetadataUploadPromise:l,quotedMsgPromise:u,reactionsPromise:s,threadJidPromise:r,xmaDataUploadRequestPromise:c}}function y(e,t,n,r,a,i,l,s){var c,d,_=o("WAJids").threadIdForChatJid(e),f=l.serverTs,g=(c=l.editCount)!=null?c:0;i.length>0&&i.length-1!==l.editCount&&(o("EBLogger").EBLogger().WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Edit history has length ",", but edit count on message is ",""])),i.length,l.editCount),g=i.length-1);var h={authoritativeTimestampMs:f!=null?f*1e3:void 0,contentSubtype:o("EchoMessage").EchoMessageContentSubtype.NONE,contentType:o("EchoMessage").EchoMessageContentType.TEXT,displayTimestampMs:l.ts*1e3,editCount:g,editHistory:i,from:o("EchoCommonUtils").craftEchoAddress(null,s,"AdvancedCrypto"),groupId:l.groupId,groupIndex:l.groupIndex,groupSize:l.groupSize,isForwarded:l.isForwarded,messageId:l.externalId,serializationOrigin:o("EchoMessage").EchoSerializationOriginType.WEB,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(l),textSize:p(l),threadId:_,version:o("EchoMessage").ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION,xContentType:o("EchoEncodingUtils").convertDbMsgTypeToXMessageContentType(l.type),xMessagePlaceholderType:o("EchoMessage").EchoMessagePlaceholderType.NO_PLACEHOLDER,xOfflineThreadingId:l.externalId,xThreadId:_};if(((d=l.msgContent)==null?void 0:d.content)!=null&&(h=babelHelpers.extends({},h,{text:o("MAWVault").unvault(l.msgContent.content)})),l.type===o("MAWMsgType").MSG_TYPE.REVOKED&&(h.contentType=o("EchoMessage").EchoMessageContentType.PLACEHOLDER,h.contentSubtype=o("EchoMessage").EchoMessageContentSubtype.UNSEND,h.revokeSentTimestampMs=l.originalTs,h.revokeUnsentTimestampMS=l.unsendMsgContentDeleteTs,h.text=m),r!=null){var y=I(r),C=o("MAWXMAUtils").isXMAStoryReply(r.xmaMessageType)?D(y.senderId,e):y.senderId,b=o("EchoCommonUtils").craftEchoAddress(null,C,"AdvancedCrypto");r.sortOrderMs!=null&&(h.quoteData={quoteMessageId:r.externalId,quoteMessageSender:b,quoteSortOrderInMs:r.sortOrderMs,replyType:l.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?o("EchoMessageQuoteFieldUtils").EchoMessageQuoteReplyType.BUMP:void 0,status:o("EchoMessageQuoteFieldUtils").EchoMessageQuoteStatus.VALID})}if(o("MAWMsgType").isMAWSupportedMediaType(l.type)){var v=t.mediaMetadata;if(v!=null){h=babelHelpers.extends({},h,{contentType:o("EchoMessage").EchoMessageContentType.MEDIA,mediaData:v});var S=t.previewMetadata;S!=null&&(h=babelHelpers.extends({},h,{previewMediaData:S}))}else if(l.type!==o("MAWMsgType").MSG_TYPE.XMA)return{echoMessage:h,externalId:l.externalId,maybeErrorDetail:t.maybeErrorDetail}}if(a!=null&&a.xmaData!=null&&l.type===o("MAWMsgType").MSG_TYPE.XMA){var R;if(h.xmaData=a.xmaData,h.contentType=o("EchoMessage").EchoMessageContentType.XMA,h.mediaData==null&&((R=a.xmaData)==null?void 0:R.xmaDefaultCTA)!=null&&h.text==null){var L;h.text=(L=a.xmaData)==null?void 0:L.xmaDefaultCTA}}else if(a!=null&&a.xmaData==null&&l.type===o("MAWMsgType").MSG_TYPE.XMA)return{echoMessage:h,externalId:l.externalId,maybeErrorDetail:a.maybeErrorDetail};return l.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&(h.receiverFetchId=l.receiverFetchId),{echoMessage:babelHelpers.extends({},h,n),externalId:l.externalId}}function C(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.dbMsg,r=t.quotedMsg;if(!o("MAWMsgType").isEBSupportedMsgType(n.type))return o("MAWDexieTable").dexieResolve(g(n.externalId,'constructEchoMessage: "'+String(n.type)+'" NYI'));if(n.serverTs==null)return o("MAWDexieTable").dexieResolve(g(n.externalId,'constructEchoMessage: "'+String(n.type)+'" Not authoritative msg. '));var a=o("WATimeUtils").castToUnixTime(0);if(n.serverTs===a||n.serverTs==null&&n.ts===a){var i="constructEchoMessage: Invalid timestamp - timestamp for message corresponds to 1/1/1970";return o("EBLogger").EBLogger().MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),i),o("MAWDexieTable").dexieResolve(g(n.externalId,i))}var l=I(n),s=l.senderId,u=h(e,r,n),d=u.editHistoryPromise,m=u.mediaMetadataUploadPromise,p=u.quotedMsgPromise,_=u.reactionsPromise,f=u.threadJidPromise,C=u.xmaDataUploadRequestPromise;return o("MAWDexieTable").dexieAll([f,m,_,p,C,d]).then(function(e){var t=e[0],r=e[1],o=e[2],a=e[3],i=e[4],l=e[5];return y(t,r,o,a,i,l,n,s)})}))}function b(e,t){var n={mediaMetadata:null,previewMetadata:null};if(t.type===o("MAWMsgType").MSG_TYPE.XMA)return o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(e,o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.externalId)).then(function(t){return t!=null?R(e,t):(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] Media meta data couldn't be created for XMA because DbXMA is not in IndexedDB. This probably means the XMA message was not sent properly by ChatX.",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n))});if(t.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH)return t.receiverFetchId==null?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No receiver fetch id found in a receiver fetch msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n)):o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(e,t.receiverFetchId).then(function(e){return e==null?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No corresponding receiver fetch info found for receiver fetch msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n)):o("MAWDexieTable").dexieResolve(x(e))});if(!o("MAWMsgType").isMAWSupportedMediaType(t.type))return n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").NOT_SUPPORTED_ON_WEB,errorMsg:"[labyrinth_web] Media type is not supported for msg, type: "+t.type,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},o("MAWDexieTable").dexieResolve(n);if(t.mediaId==null)return n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media id found in a media msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n);var a=o("WATimeUtils").DAY_SECONDS*28,i=t.serverTs;return i!=null&&o("WATimeUtils").unixTime()-i>a?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] Media is older than 28 days and is not being uploaded.",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},o("MAWDexieTable").dexieResolve(n)):o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.mediaId).then(function(e){return e?o("MAWDexieTable").dexieResolve(L(t.msgId,e,!1)):(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media db entry for media id",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n))})}function v(e,t){var n=o("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(t);return n==null?o("MAWDexieTable").dexieResolve():o("MAWDbReactionsTxns").getReactionForEcho(e,n).then(function(e){if(e!=null&&e.length>0){var t=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),n=e.map(function(e){var n=o("WAJids").authorToUserId(e.author,t);return o("EchoCommonUtils").craftEchoAddress(e.reaction,n,"AdvancedCrypto")}),r=e.map(function(e){var n=o("WAJids").authorToUserId(e.author,t);return o("EchoCommonUtils").craftEchoAddress((e.ts*1e3).toString(),n,"AdvancedCrypto")}),a=e.map(function(e){var n=o("WAJids").authorToUserId(e.author,t);return o("EchoCommonUtils").craftEchoAddress(e.externalId.toString(),n,"AdvancedCrypto")});return{reactionAuthoritativeTimestampMs:r,reactions:n,reactionXOfflineThreadingIds:a}}})}function S(e){var t={xmaData:null};if(e.isTombstoned==null)return t.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no isTombstoned to construct XMAData",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},t;var n={xmaContentRef:e.contentRef,xmaDataclass:e.xmaDataclass,xmaHeaderSubtitle:e.overlayTitle,xmaHeaderTitle:e.headerTitle,xmaIsTombstoned:e.isTombstoned,xmaMaxSubtitleNumLines:e.maxSubtitleNumOfLines,xmaMaxTitleNumLines:e.maxTitleNumOfLines,xmaSubtitleText:e.subtitleText,xmaTargetExpiry:e.targetExpiringAtSec,xmaTargetId:e.targetId,xmaTargetUsername:e.targetUsername,xmaTitleText:e.titleText},a=e.xmaLayoutType||o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;return n=babelHelpers.extends({},n,{xmaLayoutType:o("MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType").convertExtendedContentXMLLayoutTypeToXMALayoutType(a)}),e.targetType!=null&&(n=babelHelpers.extends({},n,{xmaTargetType:o("MAWConvertExtendedContentTargetTypeToXMATargetType").convertExtendedContentTargetTypeToXMATargetType(e.targetType)})),e.overlayIconGlyph!=null&&(n=babelHelpers.extends({},n,{xmaGatingType:o("MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType").convertExtendedContentOverlayIconGlyphToXMAGatingType(e.overlayIconGlyph)})),e.defaultCTA!=null&&e.defaultCTA.nativeUrl!=null&&(n=babelHelpers.extends({},n,{xmaDefaultCTA:e.defaultCTA.nativeUrl})),t.xmaData=n,t}function R(e,t){var n={mediaMetadata:null,previewMetadata:null};if(t.previewMediaIds!=null){var a=t.previewMediaIds[0];return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,a).then(function(e){if(!e)return n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media db entry for media id to be used for xma",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},o("MAWDexieTable").dexieResolve(n);var a=t.msgId;return a==null?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No message id found in a xma msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n)):o("MAWDexieTable").dexieResolve(L(a,e,!0))})}else return o("MAWDexieTable").dexieResolve(n)}function L(e,t,n,a){var i,l={mediaMetadata:null,previewMetadata:null},s=(i=t.mediaEntries)==null?void 0:i.get(e);if(s==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no media entry to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var u=o("WAMediaUtils").decodeMediaEntryData(s),c=(u==null?void 0:u.objectId)!=null?o("WAMediaUtils").stringToDeliveryObjectId(u.objectId):null;if(c==null)return o("EBLogger").EBLogger().MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["no objectId to construct mediaMetadata isXMA: ",""])),n),l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no objectId to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var m=o("MAWGetAttachmentTypeForServerMediaType").getAttachmentTypeForServerMediaType(u.serverMediaType);if(m==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no attachment type to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var p=u.mediaKey;if(p==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaKey to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var _=u.mediaKeyTimestamp;if(_==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaKeyTimestamp to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var f=u.directPath;if(f==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no directPath to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaContentType to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var g=n?"image/jpeg":o("WAMediaUtils").getMimeTypeFromServerMediaType(u.serverMediaType),h=o("MAWGetMediaAttachmentTypeForServerMediaType").getMediaAttachmentTypeForServerMediaType(u.serverMediaType);if(h==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no xAttachmentType to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType!=null&&u.serverMediaType in{gif:1,image:1,sticker:1}&&t.validatedImageInfo==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no imageinfo to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType==="video"&&t.validatedVideoInfo==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no videoinfo to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType==="ptt"&&t.validatedAudioInfo==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no audioinfo to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.fileSha256==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no WA fileSha256 found",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var y=o("WABase64").encodeB64UrlSafe(u.fileSha256);if(u.fileEncSha256==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no WA fileEncSha256 found",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var C=o("WABase64").encodeB64UrlSafe(u.fileEncSha256),b=null,v=null,S=null,R=null,L=null,I=void 0,T=o("MAWGetPreviewContentTypeForMediaType").getPreviewContentTypeForMediaType(u.serverMediaType);if(t.validatedImageInfo!=null){var D,x,$,P;b=(D=t.validatedImageInfo.width)!=null?D:0,v=(x=t.validatedImageInfo.height)!=null?x:0,R=($=t.validatedImageInfo.jpegThumbnailWidth)!=null?$:0,L=(P=t.validatedImageInfo.jpegThumbnailHeight)!=null?P:0}if(t.validatedVideoInfo!=null){var N,M,w,A,F;b=(N=t.validatedVideoInfo.width)!=null?N:0,v=(M=t.validatedVideoInfo.height)!=null?M:0,R=(w=t.validatedVideoInfo.jpegThumbnailWidth)!=null?w:0,L=(A=t.validatedVideoInfo.jpegThumbnailHeight)!=null?A:0,S=(F=t.validatedVideoInfo.duration)!=null?F:0}if(t.validatedAudioInfo!=null){var O;S=(O=t.validatedAudioInfo.duration)!=null?O:0}t.validatedDocumentFileInfo!=null&&(I=t.validatedDocumentFileInfo.filename);var B={attachmentObjectId:c,attachmentType:m,directPath:f,encryptedHash:C,mediaBackupStatus:"success",mediaContentType:g,mediaKey:o("EchoEncodingUtils").convertMediaKeyToString(p),mediaKeyTimestamp:_,plaintextHash:y,size:t.size,xAttachmentType:h,xContentType:"full"},W=null,q=u.downloadableThumbnail;if((q==null?void 0:q.objectId)!=null){W={attachmentObjectId:q.objectId,attachmentType:o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE,directPath:f,encryptedHash:C,mediaBackupStatus:"success",mediaContentType:"image/jpeg",mediaKey:o("EchoEncodingUtils").convertMediaKeyToString(p),mediaKeyTimestamp:_,plaintextHash:y,size:t.size,xAttachmentType:o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.MESSENGER_PREVIEW,xContentType:"preview"};var U=q.fileSha256!=null?o("WABase64").encodeB64UrlSafe(q.fileSha256):null,V=q.fileEncSha256!=null?o("WABase64").encodeB64UrlSafe(q.fileEncSha256):null,H=q.mediaKey!=null?o("EchoEncodingUtils").convertMediaKeyToString(p):null;W=k(W,q.directPath,V,U,H,q.mediaKeyTimestamp)}return B=E(B,null,T,b,v,S,R,L,I),{mediaMetadata:B,previewMetadata:W}}function E(e,t,n,r,o,a,i,l,s){var u=e;return t!=null&&(u=babelHelpers.extends({},u,{backupEntFbid:t})),n!=null&&(u=babelHelpers.extends({},u,{previewContentType:n})),r!=null&&(u=babelHelpers.extends({},u,{width:r})),o!=null&&(u=babelHelpers.extends({},u,{height:o})),a!=null&&(u=babelHelpers.extends({},u,{mediaPlayableDuration:a*1e3})),i!=null&&(u=babelHelpers.extends({},u,{previewContentWidth:i})),l!=null&&(u=babelHelpers.extends({},u,{previewContentHeight:l})),s!=null&&(u=babelHelpers.extends({},u,{filename:s})),u}function k(e,t,n,r,o,a){var i=e;return t!=null&&(i=babelHelpers.extends({},i,{directPath:t})),n!=null&&(i=babelHelpers.extends({},i,{encryptedHash:n})),r!=null&&(i=babelHelpers.extends({},i,{plaintextHash:r})),o!=null&&(i=babelHelpers.extends({},i,{mediaKey:o})),a!=null&&(i=babelHelpers.extends({},i,{mediaKeyTimestamp:a})),i}function I(e){var t=o("WAJids").authorToUserId(e.author,o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid())),n=o("MAWJids").toUserJid(t);return{senderId:t,senderJid:n}}function T(e,t,n,a){var i=t.content.msgId,l=t.content.externalId;return a!=null?o("MAWDexieTable").dexieResolve(a):o("MAWDbMsgTxns").maybeGetMsg(e,i).then(function(e){return e==null?n.then(function(e){return o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(l,r("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,e),null}):o("MAWDexieTable").dexieResolve(e)})}function D(e,t){var n=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),r=o("WAJids").interpretAsUserJid(t);if(r==null)throw o("EBLogger").EBLogger().mustfixThrow("this is a flow check, participant jid can not be null");return e===n?o("WAJids").extractUserId(r):n}function x(e){return{mediaMetadata:{attachmentObjectId:e.receiverFetchId,attachmentType:o("EchoMessageMediaFieldUtils").AttachmentType.STICKER,directPath:"",encryptedHash:null,height:e.previewHeight,mediaContentType:"image/webp",plaintextHash:e.receiverFetchId,previewContentHeight:e.previewHeight,previewContentType:o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER,previewContentWidth:e.previewWidth,width:e.previewWidth,xAttachmentType:o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER,xContentType:o("EchoMessage").EchoXMessageContentType.STICKER},previewMetadata:null}}l.constructEchoMessage=C,l.constructXMAData=S,l.constructMediaMetadata=L,l.setConditionalFields=E}),98);
__d("EBSenderUploadQueue",["EBMinosLogger","PersistedQueueApi","Promise","WAPersistedQueue","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t},d=null;function m(){return d==null?p():d}function p(){d!=null&&o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebSenderUploadQueueV3",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return(u||(u=n("Promise"))).resolve();try{var t=m();yield t.addAndCommit(e)}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebSenderUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)}}),f.apply(this,arguments)}l.toSendersQueueId=c,l.ebSenderUploadQueue=m,l.enqueueMessages=_}),98);
__d("EncryptedBackupTaskFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5725"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_failure",e),u=s;l.default=u}),98);
__d("EncryptedBackupTaskIssuedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5726"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_issued",e),u=s;l.default=u}),98);
__d("LSWriteSupplementalMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeSupplementalMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[5])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeSupplementalMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeSupplementalMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteSupplementalMessageStoredProcedure",e.__tables__=["local_message_persistence_store_supplemental"],a.exports=e}),null);
__d("LSWriteSupplementalMessageStoredProcedure",["LSSynchronousPromise","LSWriteSupplementalMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteSupplementalMessage"),a.messagePayload,a.threadId,a.toplevelOfflineThreadingId,a.supplementalKey,a.offlineThreadingId,a.messageTimestampMs);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSWriteTopLevelMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeTopLevelMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[3])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=!0)})},function(n){return r[14]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[16]=n[0],r[17]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[16]=t[0],r[17]=t[1],t}])},function(e){var t;return t=[r[16],r[17]],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[12]=!1:(t=o.item,r[12]=!0)})},function(n){return r[12]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[14]=n[0],r[15]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[14]=t[0],r[15]=t[1],t}])},function(e){var t;return t=[r[14],r[15]],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeTopLevelMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeTopLevelMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteTopLevelMessageStoredProcedure",e.__tables__=["local_message_persistence_store","local_message_persistence_store_deleted_messages"],a.exports=e}),null);
__d("LSWriteTopLevelMessageStoredProcedure",["LSSynchronousPromise","LSWriteTopLevelMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteTopLevelMessage"),a.messagePayload,a.threadId,a.offlineThreadingId,a.messageTimestampMs,a.isLocalOnlyMessage,a.extraData);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MessageBackupTagsDelimiter",[],(function(t,n,r,o,a,i){"use strict";var e=":";i.INSTAMADILLO_TAG_DELIMITER=e}),66);
__d("EncryptedBackupsWriteToMPSTables",["EncryptedBackupsUploadEntity","FBLogger","I64","IGDWEBUploadMessageUtils","LSFactory","LSWriteSupplementalMessageStoredProcedure","LSWriteTopLevelMessageStoredProcedure","MessageBackupTagsDelimiter","WAErrorMessage","WAResultOrError","asyncToGeneratorRuntime","getSafeQplErrorMessage","gkx","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("ReverbWriteFailureFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),u=r("requireDeferred")("ReverbWriteSuccessFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),c=r("gkx")("10326");function d(e,t,n,o,a,i){o?r("promiseDone")(u.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,labyrinth_version:0,message_id:e,thread_id:t}})}):r("promiseDone")(s.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,failure_reason:i,labyrinth_version:0,message_id:e,thread_id:t}})})}function m(e,t,n,r,o){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var s=n.backupActionType,u=n.instamadilloItemId,m=n.msgId,p=n.originalMsgProtocolId,_=n.protobuf,f=n.serverTs,g=n.sortOrderMs,h=n.supplementalKey;l==null||l.addPoint("mps_tables_write_start");var y=m.externalId,C=p==null?void 0:p.externalId,b=u!=null?u:g;if(b==null)return l==null||l.addPoint("mps_tables_write_missing_protobuf_ts"),o("WAResultOrError").makeError({errorCode:null,errorMsg:"protobufTimestampMs is null when writing to MPS tables"});var v=(e||(e=o("I64"))).of_float(b),S=!1,R=c?"protobuf_only":"dual_upload";i&&(R="open_eb_ttlc");var L=null;switch(s){case 1:{l==null||l.addPoint("mps_top_level_write_start");try{var E=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(_),messageTimestampMs:v,offlineThreadingId:y,threadId:a}),k=E[0],I=E[1];L=I,k&&(S=!0),d(y,a,"upsert_top_level",k,R),l==null||l.addPoint("mps_top_level_write",{bool:{mps_top_level_write_succesful:k}})}catch(e){d(y,a,"upsert_top_level",!1,R,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_top_level_write_error",{string:{mps_top_level_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 2:{if(l==null||l.addPoint("mps_supplemental_write_start"),C==null||h==null)d(y,a,"upsert_supplemental",!1,R),r("FBLogger")("wmi_eb").warn("Missing toplevelOfflineThreadingId or supplementalKey when writing to MPS tables");else try{var T=yield r("LSWriteSupplementalMessageStoredProcedure")(r("LSFactory")(t),{messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(_),messageTimestampMs:v,offlineThreadingId:y,supplementalKey:h,threadId:a,toplevelOfflineThreadingId:C}),D=T[0],x=T[1];L=x,D&&(S=!0),d(y,a,"upsert_supplemental",D,R),l==null||l.addPoint("mps_supplemental_write",{bool:{mps_supplemental_write_successful:D}})}catch(e){d(y,a,"upsert_supplemental",!1,R,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_supplemental_write_error",{string:{mps_supplemental_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 4:{if(l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_start"),C==null)break;try{var $=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(_),messageTimestampMs:(e||(e=o("I64"))).of_float(o("IGDWEBUploadMessageUtils").generateProtobufServerTs(C,f)),offlineThreadingId:y,threadId:a}),P=$[0],N=$[1];L=N,P&&(S=!0),d(C,a,"delete_top_level",P,R),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write",{bool:{mps_delete_top_level_with_placeholder_write_successful:P}})}catch(e){d(C,a,"delete_top_level_with_placeholder",!1,R,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_error",{string:{mps_delete_top_level_with_placeholder_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 3:S=!0,C!=null&&d(C,a,"delete_top_level",!1,R);break;default:l==null||l.addPoint("mps_write_unsupported_backup_action_type"),r("FBLogger")("wmi_eb").warn("Unsupported backupActionType when writing to MPS tables")}return S?(l==null||l.addPoint("mps_write_successful"),o("WAResultOrError").makeResult(S)):(l==null||l.addPoint("mps_write_unsuccessful"),o("WAResultOrError").makeError({errorCode:L,errorMsg:"Unsuccessful writing to MPS tables"}))}),p.apply(this,arguments)}function _(e,t,n){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r){var a=n.msgId,i=n.sortOrderMs,l=n.tags;l!=null&&l.length!==0&&i!=null&&(yield t.local_message_persistence_store_tag_index.put({localMessagePersistenceStoreKey:(e||(e=o("I64"))).of_string(a.externalId),messageTimestampMs:e.of_float(i),offlineThreadingId:a.externalId,tag:l.join(o("MessageBackupTagsDelimiter").INSTAMADILLO_TAG_DELIMITER),threadId:r}))}),f.apply(this,arguments)}l.writeToMPSTables=m,l.writeTagsToMPSTables=_}),98);
__d("WACryptoCurve25519Dependencies",["Promise","WACryptoPrimitives","WASignalKeys","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return(e||(e=n("Promise"))).resolve().then(function(){return o("WASignalKeys").makeKeyPair()})}function u(t,r){return(e||(e=n("Promise"))).resolve().then(function(){return o("WACryptoPrimitives").scalarMult(o("WASignalOther").ensureSize(r,32),o("WASignalOther").ensureSize(t,32)).buffer})}var c={generateIdentityKeyPair:s,calculateAgreement:u};l.calculateAgreement=u,l.CURVE25519_SIGNAL_DEPENDENCIES=c}),98);
__d("WASmaxInPreKeysRotateSignedResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrors").parseRequestErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrors:i.value})):i}l.parseRotateSignedResponseRequestError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseRotateSignedResponseServerError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseSuccess",["WASmaxInPreKeysIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseRotateSignedResponseSuccess=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseValidationError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysIdentityKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxParseUtils").attrString(r.value,"text");if(!a.success)return a;var i=o("WASmaxParseUtils").attrIntRange(r.value,"code",400,499);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({errorText:a.value,errorCode:i.value,errorIdentityKeyMixin:l.value},s.value)):s}l.parseRotateSignedResponseValidationError=e}),98);
__d("WASmaxOutPreKeysRotateSignedRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WASmaxOutPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.signedPreKeyMixinArgs,n=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"set"},o("WASmaxOutPreKeysSignedPreKeyMixin").mergeSignedPreKeyMixin(o("WASmaxJsx").smax("rotate",null),t)));return n}l.makeRotateSignedRequest=e}),98);
__d("WASmaxPreKeysRotateSignedRPC",["WAComms","WASmaxInPreKeysRotateSignedResponseRequestError","WASmaxInPreKeysRotateSignedResponseServerError","WASmaxInPreKeysRotateSignedResponseSuccess","WASmaxInPreKeysRotateSignedResponseValidationError","WASmaxOutPreKeysRotateSignedRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=o("WASmaxOutPreKeysRotateSignedRequest").makeRotateSignedRequest(e),r=yield o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInPreKeysRotateSignedResponseSuccess").parseRotateSignedResponseSuccess(r,n);if(a.success)return{name:"RotateSignedResponseSuccess",value:a.value};var i=o("WASmaxInPreKeysRotateSignedResponseValidationError").parseRotateSignedResponseValidationError(r,n);if(i.success)return{name:"RotateSignedResponseValidationError",value:i.value};var l=o("WASmaxInPreKeysRotateSignedResponseRequestError").parseRotateSignedResponseRequestError(r,n);if(l.success)return{name:"RotateSignedResponseRequestError",value:l.value};var s=o("WASmaxInPreKeysRotateSignedResponseServerError").parseRotateSignedResponseServerError(r,n);if(s.success)return{name:"RotateSignedResponseServerError",value:s.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("RotateSigned",{Success:a,ValidationError:i,RequestError:l,ServerError:s}))}),s.apply(this,arguments)}l.sendRotateSignedRPC=e}),98);
__d("WARotateSignedPreKeyProtocol",["WACryptoManager","WAErrorMessage","WAGlobals","WAHandleFailureUtils","WAMakeSignedPreKeyMixin","WAResultOrError","WASmaxPreKeysRotateSignedRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS(["rotateSignedPreKeyProtocol"]);function _(){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){p.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start generating skey..."])));try{var t=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WACryptoManager").generateSignedPreKey(t)},{operationType:"generate_signed_prekey",flush:!0,afterInit:!0});p.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["generated skey. Start rotating skey..."])));var n=yield o("WASmaxPreKeysRotateSignedRPC").sendRotateSignedRPC({signedPreKeyMixinArgs:o("WAMakeSignedPreKeyMixin").makeSignedPreKeyMixin(t)});switch(n.name){case"RotateSignedResponseValidationError":{var r=n.value,a=r.errorCode,i=r.errorIdentityKeyMixin,l=r.errorText;return p.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ValidationError: "," ",""])),a,l),o("WAResultOrError").makeError({type:"validation-error",identity:i.elementValue})}case"RotateSignedResponseRequestError":{var _=n.value.errorRequestErrors.value.code,f=n.value.errorRequestErrors.name;return p.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["RequestError: "," ",""])),_,f),o("WAResultOrError").makeError({type:"request-error"})}case"RotateSignedResponseServerError":{var g=n.value.errorServerErrors.value.code,h=n.value.errorServerErrors.name;return p.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["ServerError: "," ",""])),g,h),o("WAResultOrError").makeError({type:"server-error"})}default:return n.name,p.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["successfully rotated new skey"]))),o("WAResultOrError").makeResult()}}catch(e){var y=o("WAErrorMessage").maybeGetMessageFromError(e);if(y.includes("No lastSignedPrekeyId and registration"))return yield o("WAHandleFailureUtils").reregisterPhone(),o("WAResultOrError").makeError({type:"no-prekey-reregistered"});throw e}}),f.apply(this,arguments)}l.rotateSignedPreKeyProtocol=_}),98);
__d("WARotateSignedPreKey",["Promise","WAGenerateAndUploadPreKeys","WALoggerTag","WARotateSignedPreKeyProtocol","WATagsLogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS([r("WALoggerTag").SignedPrekeyRotation,r("WALoggerTag").SignedPrekey]);function m(){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield o("WARotateSignedPreKeyProtocol").rotateSignedPreKeyProtocol();if(!(t.success||t.error.type==="no-prekey-reregistered")){if(t.error.type==="validation-error")return d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Signed prekey failed server validation. need to upload all keys."]))),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys({reason:"signed prekey failed server validation"}).catch(function(e){d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)}),(c||(c=n("Promise"))).resolve();throw d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["rotateSignedPreKey failed."]))),r("err")("rotateSignedPreKey RPC failed: "+t.error.type)}}),p.apply(this,arguments)}l.rotateSignedPreKey=m}),98);